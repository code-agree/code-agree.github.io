[{"content":"ç›®å½• # ä¸ºä»€ä¹ˆéœ€è¦æ— é”é˜Ÿåˆ—ï¼Ÿ ç¡¬ä»¶åŸºç¡€ï¼šç†è§£ç°ä»£CPUçš„è¡Œä¸º å†…å­˜åºï¼šæ— é”ç¼–ç¨‹çš„æ ¸å¿ƒæ­¦å™¨ SPSCé˜Ÿåˆ—ï¼šæœ€ç®€å•çš„æ— é”å®ç° è¿›é˜¶ï¼šå¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…çš„æŒ‘æˆ˜ æ€§èƒ½åˆ†æä¸æœ€ä½³å®è·µ å®é™…åº”ç”¨åœºæ™¯ä¸é€‰æ‹©æŒ‡å— 1. ä¸ºä»€ä¹ˆéœ€è¦æ— é”é˜Ÿåˆ—ï¼Ÿ #ä¼ ç»Ÿé”æœºåˆ¶çš„ç—›ç‚¹ #æƒ³è±¡ä¸€ä¸ªé«˜é¢‘äº¤æ˜“ç³»ç»Ÿï¼Œæ¯ç§’éœ€è¦å¤„ç†æ•°ç™¾ä¸‡ç¬”è®¢å•ã€‚ä¼ ç»Ÿçš„åŸºäºé”çš„é˜Ÿåˆ—ä¼šå¸¦æ¥ä»€ä¹ˆé—®é¢˜ï¼Ÿ\n// ä¼ ç»Ÿé”æœºåˆ¶çš„é˜Ÿåˆ— class ThreadSafeQueue { std::mutex mtx; std::queue\u0026lt;Order\u0026gt; orders; public: void push(Order order) { std::lock_guard\u0026lt;std::mutex\u0026gt; lock(mtx); // å¯èƒ½é˜»å¡ï¼ orders.push(order); } Order pop() { std::lock_guard\u0026lt;std::mutex\u0026gt; lock(mtx); // å¯èƒ½é˜»å¡ï¼ // ... å–æ•°æ® } }; æ ¸å¿ƒé—®é¢˜ï¼š\nä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ï¼šçº¿ç¨‹é˜»å¡æ—¶éœ€è¦ä¿å­˜/æ¢å¤CPUçŠ¶æ€ é”ç«äº‰ï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®æ—¶ï¼Œåªæœ‰ä¸€ä¸ªèƒ½è·å¾—é” ä¼˜å…ˆçº§åè½¬ï¼šé«˜ä¼˜å…ˆçº§çº¿ç¨‹å¯èƒ½è¢«ä½ä¼˜å…ˆçº§çº¿ç¨‹é˜»å¡ ä¸å¯é¢„æµ‹çš„å»¶è¿Ÿï¼šå»¶è¿Ÿå–å†³äºé”çš„ç«äº‰æƒ…å†µ æ— é”ç¼–ç¨‹çš„æ‰¿è¯º #æ— é”ç¼–ç¨‹é€šè¿‡åŸå­æ“ä½œå’Œç²¾å¿ƒè®¾è®¡çš„ç®—æ³•ï¼Œè®©å¤šä¸ªçº¿ç¨‹èƒ½å¤Ÿæ— é˜»å¡åœ°åä½œï¼š\n// æ— é”é˜Ÿåˆ—çš„ç†æƒ³çŠ¶æ€ class LockFreeQueue { public: bool push(T item) { // åŸå­æ“ä½œï¼Œæ°¸ä¸é˜»å¡ // è¦ä¹ˆæˆåŠŸï¼Œè¦ä¹ˆå¤±è´¥ï¼Œä½†ä¸ä¼šç­‰å¾… } std::optional\u0026lt;T\u0026gt; pop() { // åŒæ ·æ˜¯åŸå­æ“ä½œ // è¦ä¹ˆè¿”å›æ•°æ®ï¼Œè¦ä¹ˆè¿”å›ç©ºï¼Œä½†ä¸ä¼šé˜»å¡ } }; å…³é”®ä¼˜åŠ¿ï¼š\nç¡®å®šæ€§å»¶è¿Ÿï¼šæ“ä½œåœ¨å›ºå®šæ­¥éª¤å†…å®Œæˆ é«˜å¹¶å‘æ€§èƒ½ï¼šå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶æ“ä½œ æ— æ­»é”é£é™©ï¼šæ²¡æœ‰é”å°±æ²¡æœ‰æ­»é” 2. ç¡¬ä»¶åŸºç¡€ï¼šç†è§£ç°ä»£CPUçš„è¡Œä¸º #2.1 CPUç¼“å­˜æ¶æ„ #ç°ä»£CPUçš„å†…å­˜å±‚æ¬¡ç»“æ„ï¼š\nCPU Core 1 CPU Core 2 | | L1 Cache L1 Cache | | L2 Cache L2 Cache | | L3 Cache (å…±äº«) | ä¸»å†…å­˜ (RAM) å…³é”®é—®é¢˜ï¼šå½“Core 1ä¿®æ”¹äº†æŸä¸ªå€¼ï¼ŒCore 2ä»€ä¹ˆæ—¶å€™èƒ½çœ‹åˆ°ï¼Ÿ\n2.2 ç¼“å­˜ä¸€è‡´æ€§åè®® (MESI) #CPUä½¿ç”¨MESIåè®®æ¥ç»´æŠ¤ç¼“å­˜ä¸€è‡´æ€§ï¼š\nçŠ¶æ€ å«ä¹‰ è¡Œä¸º Modified å·²ä¿®æ”¹ï¼Œç‹¬å  å¯è¯»å†™ï¼Œéœ€è¦å†™å›ä¸»å†…å­˜ Exclusive ç‹¬å ï¼Œæœªä¿®æ”¹ å¯è¯»å†™ï¼Œä¸ä¸»å†…å­˜ä¸€è‡´ Shared å…±äº« åªè¯»ï¼Œå¤šä¸ªæ ¸å¿ƒéƒ½æœ‰å‰¯æœ¬ Invalid æ— æ•ˆ ä¸å¯ç”¨ï¼Œéœ€è¦é‡æ–°åŠ è½½ å®é™…å½±å“ï¼š\n// çº¿ç¨‹1æ‰§è¡Œ data = 42; // å¯¼è‡´å…¶ä»–æ ¸å¿ƒçš„ç¼“å­˜å¤±æ•ˆ flag = true; // è§¦å‘ç¼“å­˜åŒæ­¥ // çº¿ç¨‹2æ‰§è¡Œ if (flag) { // å¯èƒ½çœ‹åˆ°flag=true use(data); // ä½†dataå¯èƒ½è¿˜æ˜¯æ—§å€¼ï¼ } 2.3 æŒ‡ä»¤é‡æ’åºï¼šå•çº¿ç¨‹ vs å¤šçº¿ç¨‹ #æŒ‡ä»¤é‡æ’åºçš„å½±å“åœ¨å•çº¿ç¨‹å’Œå¤šçº¿ç¨‹ç¯å¢ƒä¸­æˆªç„¶ä¸åŒï¼š\nå•çº¿ç¨‹ç¯å¢ƒä¸­çš„é‡æ’åº #åœ¨å•çº¿ç¨‹ä¸­ï¼Œç¼–è¯‘å™¨å’ŒCPUå¯ä»¥è‡ªç”±é‡æ’åºæŒ‡ä»¤ï¼Œä½†å¿…é¡»ä¿è¯ï¼š\nas-if-serialè¯­ä¹‰ï¼šé‡æ’åºåçš„æ‰§è¡Œç»“æœä¸ç¨‹åºé¡ºåºæ‰§è¡Œçš„ç»“æœå®Œå…¨ä¸€è‡´ æ•°æ®ä¾èµ–æ€§ï¼šæœ‰çœŸå®æ•°æ®ä¾èµ–çš„æŒ‡ä»¤ä¸èƒ½é‡æ’åº å¯¹ç¨‹åºå‘˜æ¥è¯´æ˜¯\u0026quot;é€æ˜\u0026quot;çš„ // å•çº¿ç¨‹ä¸­çš„é‡æ’åºç¤ºä¾‹ int a = 1; // â‘  int b = 2; // â‘¡ å¯èƒ½ä¸â‘ é‡æ’åºï¼Œå› ä¸ºæ— ä¾èµ–å…³ç³» int c = a + b; // â‘¢ ä¸èƒ½é‡æ’åˆ°â‘ â‘¡ä¹‹å‰ï¼Œå› ä¸ºæœ‰æ•°æ®ä¾èµ– // CPUå¯èƒ½çš„æ‰§è¡Œé¡ºåºï¼šâ‘¡â‘ â‘¢ æˆ– â‘ â‘¡â‘¢ï¼Œä½†ç»“æœéƒ½ç›¸åŒ å¤šçº¿ç¨‹ç¯å¢ƒä¸­çš„é‡æ’åºé—®é¢˜ #å¤šçº¿ç¨‹ä¸­ï¼Œé‡æ’åºä¼šç ´åçº¿ç¨‹é—´çš„åŒæ­¥ï¼Œå¯¼è‡´ä¸¥é‡é—®é¢˜ï¼š\n// å¤šçº¿ç¨‹ä¸­çš„ç»å…¸é—®é¢˜ // å…±äº«å˜é‡ int data = 0; bool ready = false; // çº¿ç¨‹1ï¼ˆç”Ÿäº§è€…ï¼‰ void producer() { data = 42; // â‘  ready = true; // â‘¡ // CPUå¯èƒ½é‡æ’åºä¸ºï¼šâ‘¡ â‘  } // çº¿ç¨‹2ï¼ˆæ¶ˆè´¹è€…ï¼‰ void consumer() { if (ready) { // â‘¢ çœ‹åˆ°ready=true use(data); // â‘£ ä½†å¯èƒ½è¯»åˆ°data=0ï¼ } } å…³é”®åŒºåˆ«ï¼š\nå•çº¿ç¨‹ï¼šé‡æ’åºä¸å½±å“ç¨‹åºæ­£ç¡®æ€§ï¼Œç¼–è¯‘å™¨/CPUå¯ä»¥è‡ªç”±ä¼˜åŒ– å¤šçº¿ç¨‹ï¼šé‡æ’åºç ´åçº¿ç¨‹é—´çš„happen-beforeå…³ç³»ï¼Œéœ€è¦æ˜¾å¼åŒæ­¥ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ— é”ç¼–ç¨‹éœ€è¦å†…å­˜åºï¼æˆ‘ä»¬éœ€è¦å·¥å…·æ¥æ§åˆ¶å¤šçº¿ç¨‹ç¯å¢ƒä¸­çš„æŒ‡ä»¤é‡æ’åºã€‚\n3. å†…å­˜åºï¼šæ— é”ç¼–ç¨‹çš„æ ¸å¿ƒæ­¦å™¨ #3.1 å†…å­˜åºçš„æœ¬è´¨ #å†…å­˜åºæ˜¯å¯¹ç¼–è¯‘å™¨å’ŒCPUçš„çº¦æŸæŒ‡ä»¤ï¼Œå‘Šè¯‰å®ƒä»¬å“ªäº›æ“ä½œä¸èƒ½é‡æ’åºã€‚\nenum memory_order { memory_order_relaxed, // æœ€å®½æ¾ï¼šåªä¿è¯åŸå­æ€§ memory_order_acquire, // è·å–ï¼šé˜²æ­¢åç»­æ“ä½œå‰ç§» memory_order_release, // é‡Šæ”¾ï¼šé˜²æ­¢ä¹‹å‰æ“ä½œåç§» memory_order_acq_rel, // è·å–-é‡Šæ”¾ï¼šä¸¤è€…ç»“åˆ memory_order_seq_cst // é¡ºåºä¸€è‡´ï¼šæœ€ä¸¥æ ¼ }; 3.2 Acquire-Releaseæ¨¡å‹è¯¦è§£ #è¿™æ˜¯æ— é”ç¼–ç¨‹ä¸­æœ€é‡è¦çš„æ¦‚å¿µï¼š\n// ç”Ÿäº§è€…çº¿ç¨‹ void producer() { data.store(42, memory_order_relaxed); // â‘  ready.store(true, memory_order_release); // â‘¡ release // releaseç¡®ä¿â‘ ä¸ä¼šé‡æ’åˆ°â‘¡ä¹‹å } // æ¶ˆè´¹è€…çº¿ç¨‹ void consumer() { if (ready.load(memory_order_acquire)) { // â‘¢ acquire int value = data.load(memory_order_relaxed); // â‘£ // acquireç¡®ä¿â‘£ä¸ä¼šé‡æ’åˆ°â‘¢ä¹‹å‰ assert(value == 42); // ä¿è¯æˆåŠŸï¼ } } åŒæ­¥ä¿è¯ï¼š\nReleaseæ“ä½œï¼šç¡®ä¿â‘ ä¸ä¼šé‡æ’åˆ°â‘¡ä¹‹å Acquireæ“ä½œï¼šç¡®ä¿â‘£ä¸ä¼šé‡æ’åˆ°â‘¢ä¹‹å‰ Happens-beforeå…³ç³»ï¼šå¦‚æœâ‘¢çœ‹åˆ°â‘¡çš„ç»“æœï¼Œé‚£ä¹ˆâ‘£ä¸€å®šèƒ½çœ‹åˆ°â‘ çš„ç»“æœ 3.3 å†…å­˜åºçš„æ€§èƒ½å½±å“ #ä¸åŒå†…å­˜åºçš„æ€§èƒ½å¼€é”€ï¼ˆå…¸å‹x86-64æ¶æ„ï¼‰ï¼š\n// æ€§èƒ½ä»é«˜åˆ°ä½ï¼š memory_order_relaxed // ~1 cycle memory_order_acquire // ~1-2 cycles memory_order_release // ~1-2 cycles memory_order_acq_rel // ~2-3 cycles memory_order_seq_cst // ~10-20 cyclesï¼ˆéœ€è¦å†…å­˜å±éšœï¼‰ å…³é”®åŸåˆ™ï¼šä½¿ç”¨èƒ½æ»¡è¶³éœ€æ±‚çš„æœ€å¼±å†…å­˜åºã€‚\n4. SPSCé˜Ÿåˆ—ï¼šæœ€ç®€å•çš„æ— é”å®ç° #4.1 è®¾è®¡æ€è·¯ #å•ç”Ÿäº§è€…å•æ¶ˆè´¹è€…(SPSC)é˜Ÿåˆ—æ˜¯æœ€ç®€å•çš„æ— é”é˜Ÿåˆ—ï¼š\ntemplate\u0026lt;typename T, size_t Capacity\u0026gt; class SPSCQueue { private: std::array\u0026lt;T, Capacity\u0026gt; buffer; // å…³é”®è®¾è®¡ï¼šheadåªè¢«æ¶ˆè´¹è€…ä¿®æ”¹ï¼Œtailåªè¢«ç”Ÿäº§è€…ä¿®æ”¹ alignas(64) std::atomic\u0026lt;size_t\u0026gt; head{0}; // æ¶ˆè´¹è€…ç´¢å¼• alignas(64) std::atomic\u0026lt;size_t\u0026gt; tail{0}; // ç”Ÿäº§è€…ç´¢å¼• public: // ç”Ÿäº§è€…è°ƒç”¨ bool push(T item); // æ¶ˆè´¹è€…è°ƒç”¨ std::optional\u0026lt;T\u0026gt; pop(); }; 4.2 Pushæ“ä½œçš„ç²¾å¦™è®¾è®¡ #bool push(T item) { const size_t current_tail = tail.load(std::memory_order_relaxed); // â‘  const size_t next_tail = (current_tail + 1) % Capacity; // æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦æ»¡ if (next_tail == head.load(std::memory_order_acquire)) { // â‘¡ return false; } buffer[current_tail] = std::move(item); // â‘¢ tail.store(next_tail, std::memory_order_release); // â‘£ return true; } å†…å­˜åºåˆ†æï¼š\nâ‘ : relaxed - è¯»å–è‡ªå·±çš„tailï¼Œæ— éœ€åŒæ­¥ â‘¡: acquire - ç¡®ä¿çœ‹åˆ°æ¶ˆè´¹è€…çš„æœ€æ–°headå€¼ â‘¢: æ•°æ®å†™å…¥ï¼Œå—releaseä¿æŠ¤ â‘£: release - ç¡®ä¿æ•°æ®å†™å…¥å®Œæˆåï¼Œæ‰è®©æ¶ˆè´¹è€…çœ‹åˆ°æ–°tail 4.3 Popæ“ä½œçš„å¯¹ç§°è®¾è®¡ #std::optional\u0026lt;T\u0026gt; pop() { const size_t current_head = head.load(std::memory_order_relaxed); // â‘  // æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦ç©º if (current_head == tail.load(std::memory_order_acquire)) { // â‘¡ return std::nullopt; } T item = std::move(buffer[current_head]); // â‘¢ head.store((current_head + 1) % Capacity, std::memory_order_release); // â‘£ return item; } å¯¹ç§°çš„å†…å­˜åºï¼š\nâ‘¡: acquire - ç¡®ä¿çœ‹åˆ°ç”Ÿäº§è€…çš„æœ€æ–°tailå€¼ â‘£: release - ç¡®ä¿æ•°æ®è¯»å–å®Œæˆåï¼Œæ‰è®©ç”Ÿäº§è€…çœ‹åˆ°æ–°head åŸºäºring bufferå®ç°çš„spsc #Ring Buffer çš„æ ¸å¿ƒç‰¹å¾ï¼š\nä½¿ç”¨å›ºå®šå¤§å°æ•°ç»„ä½œä¸ºç¼“å­˜åŒºï¼›\nå†™æŒ‡é’ˆï¼ˆtailï¼‰å’Œè¯»æŒ‡é’ˆï¼ˆheadï¼‰å¾ªç¯æ¨è¿›ï¼›\nå½“ tail == headï¼Œé˜Ÿåˆ—ä¸ºç©ºï¼›\nå½“ (tail + 1) % N == headï¼Œé˜Ÿåˆ—ä¸ºæ»¡ï¼›\næ‰€æœ‰æ“ä½œä¸æ¶‰åŠåŠ¨æ€å†…å­˜åˆ†é…ï¼›\nåˆ©ç”¨äº†æ•°ç»„\u0026quot;ç¯ç»•\u0026quot;ç‰¹æ€§ï¼šå†™æ»¡ä»å¤´å¼€å§‹ï¼Œè¯»å®Œä»å¤´å¼€å§‹ã€‚\nä¸ºä»€ä¹ˆç”¨ ring buffer åš SPSC queueï¼Ÿ å› ä¸ºï¼š\nå›ºå®šå¤§å°çš„å†…å­˜å¼€é”€ï¼Œå®Œå…¨åœ¨æ ˆæˆ–é¢„åˆ†é…å†…å­˜ä¸­ï¼Œé¿å…å †åˆ†é…ï¼ˆHFTç³»ç»Ÿå…³é”®ï¼‰ï¼›\næŒ‡é’ˆæ¨è¿›ä¸º O(1) æ“ä½œï¼›\næ— éœ€å†…å­˜ç®¡ç†ï¼Œç®€æ´å®‰å…¨ï¼›\næä½å»¶è¿Ÿï¼šå…¥é˜Ÿã€å‡ºé˜Ÿä»…ä»…æ˜¯ä¸€ä¸ªæ•°ç»„è®¿é—® + åŸå­å˜é‡æ“ä½œã€‚\n4.4 ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡æœ‰æ•ˆï¼Ÿ #å…³é”®æ´å¯Ÿï¼šæ¯ä¸ªæŒ‡é’ˆåªè¢«ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹ï¼\nç”Ÿäº§è€…ï¼šåªä¿®æ”¹tailï¼Œåªè¯»å–head æ¶ˆè´¹è€…ï¼šåªä¿®æ”¹headï¼Œåªè¯»å–tail è¿™æ ·é¿å…äº†å¤æ‚çš„CASæ“ä½œï¼Œé€šè¿‡acquire-releaseå»ºç«‹åŒæ­¥ç‚¹ã€‚\n5. è¿›é˜¶ï¼šå¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…çš„æŒ‘æˆ˜ #5.1 å¤šç”Ÿäº§è€…å•æ¶ˆè´¹è€… (MPSC) #å½“æœ‰å¤šä¸ªç”Ÿäº§è€…æ—¶ï¼Œä¸»è¦æŒ‘æˆ˜æ˜¯ç«äº‰tailæŒ‡é’ˆï¼š\ntemplate\u0026lt;typename T\u0026gt; class MPSCQueue { private: struct Node { std::atomic\u0026lt;T*\u0026gt; data{nullptr}; std::atomic\u0026lt;Node*\u0026gt; next{nullptr}; }; alignas(64) std::atomic\u0026lt;Node*\u0026gt; head; // æ¶ˆè´¹è€…è¯»å– alignas(64) std::atomic\u0026lt;Node*\u0026gt; tail; // ç”Ÿäº§è€…ç«äº‰ public: void push(T item) { Node* new_node = new Node; T* data_ptr = new T(std::move(item)); new_node-\u0026gt;data.store(data_ptr, std::memory_order_relaxed); // å…³é”®ï¼šåŸå­åœ°è·å–tailä½ç½® Node* prev_tail = tail.exchange(new_node, std::memory_order_acq_rel); // é“¾æ¥åˆ°é“¾è¡¨ prev_tail-\u0026gt;next.store(new_node, std::memory_order_release); } }; æ ¸å¿ƒæŠ€æœ¯ï¼š\nexchangeæ“ä½œï¼šåŸå­åœ°swapä¸¤ä¸ªå€¼ é“¾è¡¨ç»“æ„ï¼šé¿å…å›ºå®šå¤§å°é™åˆ¶ å»¶è¿Ÿé“¾æ¥ï¼šå…ˆè·å–ä½ç½®ï¼Œå†å»ºç«‹é“¾æ¥ 5.2 å¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€… (MPMC) #MPMCæ˜¯æœ€å¤æ‚çš„æƒ…å†µï¼Œéœ€è¦åºåˆ—å·æœºåˆ¶ï¼š\ntemplate\u0026lt;typename T, size_t Capacity\u0026gt; class MPMCQueue { private: struct Cell { std::atomic\u0026lt;T*\u0026gt; data{nullptr}; std::atomic\u0026lt;size_t\u0026gt; sequence{0}; // å…³é”®ï¼šåºåˆ—å· }; alignas(64) std::array\u0026lt;Cell, Capacity\u0026gt; buffer; alignas(64) std::atomic\u0026lt;size_t\u0026gt; enqueue_pos{0}; alignas(64) std::atomic\u0026lt;size_t\u0026gt; dequeue_pos{0}; public: bool push(T item) { Cell* cell; size_t pos = enqueue_pos.load(std::memory_order_relaxed); for (;;) { cell = \u0026amp;buffer[pos % Capacity]; size_t seq = cell-\u0026gt;sequence.load(std::memory_order_acquire); intptr_t diff = (intptr_t)seq - (intptr_t)pos; if (diff == 0) { // ä½ç½®å¯ç”¨ï¼Œå°è¯•CASå ç”¨ if (enqueue_pos.compare_exchange_weak(pos, pos + 1, std::memory_order_relaxed)) { break; } } else if (diff \u0026lt; 0) { return false; // é˜Ÿåˆ—æ»¡ } else { pos = enqueue_pos.load(std::memory_order_relaxed); } } // å­˜å‚¨æ•°æ®å¹¶æ›´æ–°åºåˆ—å· T* data_ptr = new T(std::move(item)); cell-\u0026gt;data.store(data_ptr, std::memory_order_relaxed); cell-\u0026gt;sequence.store(pos + 1, std::memory_order_release); return true; } }; åºåˆ—å·æœºåˆ¶çš„å¦™å¤„ï¼š\nçŠ¶æ€ç¼–ç ï¼šé€šè¿‡åºåˆ—å·å·®å€¼åˆ¤æ–­cellçŠ¶æ€ ABAé—®é¢˜è§£å†³ï¼šåºåˆ—å·å•è°ƒé€’å¢ï¼Œé¿å…ABA å…¬å¹³æ€§ï¼šæ‰€æœ‰çº¿ç¨‹éƒ½æœ‰æœºä¼šè·å–ä½ç½® 5.3 å¤æ‚åº¦å¯¹æ¯” # é˜Ÿåˆ—ç±»å‹ åŒæ­¥å¤æ‚åº¦ å†…å­˜å¼€é”€ é€‚ç”¨åœºæ™¯ SPSC æœ€ç®€å• æœ€å° å•çº¿ç¨‹ç”Ÿäº§æ¶ˆè´¹ MPSC ä¸­ç­‰ åŠ¨æ€å¢é•¿ å¤šæ•°æ®æºï¼Œå•å¤„ç†å™¨ MPMC æœ€å¤æ‚ å›ºå®šå¤§å° é€šç”¨å¤šçº¿ç¨‹åœºæ™¯ 6. æ€§èƒ½åˆ†æä¸æœ€ä½³å®è·µ #6.1 å®é™…æ€§èƒ½æ•°æ® #åŸºäºIntel Xeon E5-2680v4çš„æµ‹è¯•ç»“æœï¼š\né˜Ÿåˆ—ç±»å‹ å»¶è¿Ÿ(çº³ç§’) ååé‡(æ“ä½œ/ç§’) CPUç¼“å­˜å‘½ä¸­ç‡ SPSC 10-20 100,000,000 \u0026gt;95% MPSC 100-200 20,000,000 85-90% MPMC 200-500 5,000,000 70-80% äº’æ–¥é”é˜Ÿåˆ— 1000-5000 1,000,000 60-70% 6.2 å…³é”®ä¼˜åŒ–æŠ€å·§ #ç¼“å­˜è¡Œå¯¹é½ #// é¿å…ä¼ªå…±äº« alignas(std::hardware_destructive_interference_size) std::atomic\u0026lt;size_t\u0026gt; head{0}; alignas(std::hardware_destructive_interference_size) std::atomic\u0026lt;size_t\u0026gt; tail{0}; ä½è¿ç®—ä¼˜åŒ– #// å½“Capacityæ˜¯2çš„å¹‚æ—¶ size_t next_pos = (pos + 1) \u0026amp; (Capacity - 1); // æ¯”%å¿« æ‰¹é‡æ“ä½œ #// æ‰¹é‡pushå¯ä»¥æ‘Šè–„åŸå­æ“ä½œå¼€é”€ template\u0026lt;typename Iterator\u0026gt; size_t push_batch(Iterator begin, Iterator end) { size_t count = 0; for (auto it = begin; it != end; ++it) { if (push(*it)) ++count; else break; } return count; } 6.3 å†…å­˜ç®¡ç†è€ƒè™‘ #// ä½¿ç”¨å†…å­˜æ± é¿å…é¢‘ç¹åˆ†é… class MemoryPool { std::atomic\u0026lt;Node*\u0026gt; free_list{nullptr}; public: Node* allocate() { Node* node = free_list.load(std::memory_order_acquire); while (node \u0026amp;\u0026amp; !free_list.compare_exchange_weak( node, node-\u0026gt;next, std::memory_order_release)) { // é‡è¯• } return node ? node : new Node; } void deallocate(Node* node) { node-\u0026gt;next = free_list.load(std::memory_order_relaxed); while (!free_list.compare_exchange_weak( node-\u0026gt;next, node, std::memory_order_release)) { // é‡è¯• } } }; 7. å®é™…åº”ç”¨åœºæ™¯ä¸é€‰æ‹©æŒ‡å— #7.1 åº”ç”¨åœºæ™¯åˆ†æ #é«˜é¢‘äº¤æ˜“ç³»ç»Ÿ #// è®¢å•å¤„ç†ç®¡é“ class OrderProcessor { SPSCQueue\u0026lt;Order, 10000\u0026gt; incoming_orders; // ç½‘ç»œçº¿ç¨‹â†’å¤„ç†çº¿ç¨‹ SPSCQueue\u0026lt;Trade, 10000\u0026gt; outgoing_trades; // å¤„ç†çº¿ç¨‹â†’å‘é€çº¿ç¨‹ void process_orders() { while (auto order = incoming_orders.pop()) { Trade trade = execute_order(*order); outgoing_trades.push(std::move(trade)); } } }; ä¸ºä»€ä¹ˆé€‰æ‹©SPSCï¼š\nå»¶è¿Ÿè¦æ±‚æä½ï¼ˆå¾®ç§’çº§ï¼‰ æ¸…æ™°çš„æµæ°´çº¿æ¶æ„ ç¡®å®šæ€§æ€§èƒ½ æ—¥å¿—ç³»ç»Ÿ #// å¤šçº¿ç¨‹æ—¥å¿—æ”¶é›† class Logger { MPSCQueue\u0026lt;LogEntry\u0026gt; log_queue; void log_from_thread(std::string message) { LogEntry entry{std::this_thread::get_id(), std::move(message)}; log_queue.push(std::move(entry)); } void background_writer() { while (auto entry = log_queue.pop()) { write_to_file(*entry); } } }; ä¸ºä»€ä¹ˆé€‰æ‹©MPSCï¼š\nå¤šä¸ªçº¿ç¨‹äº§ç”Ÿæ—¥å¿— å•ä¸ªåå°çº¿ç¨‹å¤„ç† å…è®¸é€‚åº¦çš„å»¶è¿Ÿ ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿ #// é€šç”¨ä»»åŠ¡é˜Ÿåˆ— class TaskScheduler { MPMCQueue\u0026lt;Task, 1000\u0026gt; task_queue; std::vector\u0026lt;std::thread\u0026gt; workers; void schedule_task(Task task) { task_queue.push(std::move(task)); } void worker_thread() { while (auto task = task_queue.pop()) { task-\u0026gt;execute(); } } }; ä¸ºä»€ä¹ˆé€‰æ‹©MPMCï¼š\nå¤šä¸ªçº¿ç¨‹æäº¤ä»»åŠ¡ å¤šä¸ªå·¥ä½œçº¿ç¨‹å¤„ç† è´Ÿè½½å‡è¡¡éœ€æ±‚ 7.2 é€‰æ‹©å†³ç­–æ ‘ #å¼€å§‹ â”œâ”€â”€ åªæœ‰ä¸€ä¸ªç”Ÿäº§è€…ï¼Ÿ â”‚ â”œâ”€â”€ æ˜¯ï¼šåªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…ï¼Ÿ â”‚ â”‚ â”œâ”€â”€ æ˜¯ï¼šé€‰æ‹© SPSC âœ“ â”‚ â”‚ â””â”€â”€ å¦ï¼šé€‰æ‹© SPMC â”‚ â””â”€â”€ å¦ï¼šåªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…ï¼Ÿ â”‚ â”œâ”€â”€ æ˜¯ï¼šé€‰æ‹© MPSC âœ“ â”‚ â””â”€â”€ å¦ï¼šé€‰æ‹© MPMC âœ“ 7.3 å®æ–½å»ºè®® #åŸå‹éªŒè¯ #// å…ˆç”¨ç®€å•çš„SPSCéªŒè¯è®¾è®¡ SPSCQueue\u0026lt;Message, 1024\u0026gt; prototype_queue; // æµ‹è¯•åŸºæœ¬åŠŸèƒ½ assert(prototype_queue.push(Message{\u0026#34;test\u0026#34;})); auto msg = prototype_queue.pop(); assert(msg.has_value()); æ€§èƒ½æµ‹è¯• #// å»¶è¿Ÿæµ‹è¯• auto start = std::chrono::high_resolution_clock::now(); queue.push(item); auto item_opt = queue.pop(); auto end = std::chrono::high_resolution_clock::now(); auto latency = std::chrono::duration_cast\u0026lt;std::chrono::nanoseconds\u0026gt;(end - start); æ¸è¿›å¼ä¼˜åŒ– # å…ˆç¡®ä¿æ­£ç¡®æ€§ï¼šä½¿ç”¨è¾ƒå¼ºçš„å†…å­˜åº æµ‹é‡æ€§èƒ½ç“¶é¢ˆï¼šæ‰¾å‡ºçƒ­ç‚¹ä»£ç  é€æ­¥ä¼˜åŒ–ï¼šæ”¾æ¾ä¸å¿…è¦çš„å†…å­˜åºçº¦æŸ æŒç»­éªŒè¯ï¼šç¡®ä¿ä¼˜åŒ–ä¸å½±å“æ­£ç¡®æ€§ æ€»ç»“ #æ— é”é˜Ÿåˆ—æ˜¯ç°ä»£é«˜æ€§èƒ½ç³»ç»Ÿçš„å…³é”®ç»„ä»¶ï¼Œä½†é€‰æ‹©å’Œå®ç°éœ€è¦æ·±å…¥ç†è§£ï¼š\næ ¸å¿ƒè¦ç‚¹ # ç¡¬ä»¶åŸºç¡€ï¼šç†è§£CPUç¼“å­˜å’ŒæŒ‡ä»¤é‡æ’åºçš„å½±å“å·®å¼‚ å†…å­˜åºï¼šæŒæ¡acquire-releaseæ¨¡å‹ï¼Œè¯¦è§å†…å­˜åºä¸æ— é”é˜Ÿåˆ— è®¾è®¡æƒè¡¡ï¼šå¤æ‚åº¦vsæ€§èƒ½vsé€‚ç”¨æ€§ å®é™…åº”ç”¨ï¼šæ ¹æ®åœºæ™¯é€‰æ‹©åˆé€‚çš„å®ç° å…³é”®åŸåˆ™ # å•çº¿ç¨‹vså¤šçº¿ç¨‹ï¼šé‡æ’åºçš„å½±å“æˆªç„¶ä¸åŒ æœ€å°åŒ–åŒæ­¥ï¼šä½¿ç”¨æœ€å¼±çš„å†…å­˜åºæ»¡è¶³éœ€æ±‚ æ¸è¿›ä¼˜åŒ–ï¼šå…ˆä¿è¯æ­£ç¡®æ€§ï¼Œå†ä¼˜åŒ–æ€§èƒ½ å‚è€ƒæ–‡çŒ®: # C++ Memory Model Lock-free Algorithms: Queues moodycamel::ConcurrentQueue Fast Single-Producer Single-Consumer Ring Buffer Lock-Free Single-Producer Single-Consumer Circular Queue Folly UnboundedQueue An Introduction to Lock-Free Programming Concurrent UM Queues Lock-Free Single-Producer Single-Consumer Queue ","date":"11 June 2025","permalink":"/blog/2025-06-24-lock_free_queue_implementation/","section":"Blog","summary":"ç›®å½• # ä¸ºä»€ä¹ˆéœ€è¦æ— é”é˜Ÿåˆ—ï¼Ÿ ç¡¬ä»¶åŸºç¡€ï¼šç†è§£ç°ä»£CPUçš„è¡Œä¸º å†…å­˜åºï¼šæ— é”ç¼–ç¨‹çš„æ ¸å¿ƒæ­¦å™¨ SPSCé˜Ÿåˆ—ï¼šæœ€ç®€å•çš„æ— é”å®ç° è¿›é˜¶ï¼šå¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…çš„æŒ‘æˆ˜ æ€§èƒ½åˆ†æä¸æœ€ä½³å®è·µ å®é™…åº”ç”¨åœºæ™¯ä¸é€‰æ‹©æŒ‡å— 1. ä¸ºä»€ä¹ˆéœ€è¦æ— é”é˜Ÿåˆ—ï¼Ÿ #ä¼ ç»Ÿé”æœºåˆ¶çš„ç—›ç‚¹ #æƒ³è±¡ä¸€ä¸ªé«˜é¢‘äº¤æ˜“ç³»ç»Ÿï¼Œæ¯ç§’éœ€è¦å¤„ç†æ•°ç™¾ä¸‡ç¬”è®¢å•ã€‚ä¼ ç»Ÿçš„åŸºäºé”çš„é˜Ÿåˆ—ä¼šå¸¦æ¥ä»€ä¹ˆé—®é¢˜ï¼Ÿ\n// ä¼ ç»Ÿé”æœºåˆ¶çš„é˜Ÿåˆ— class ThreadSafeQueue { std::mutex mtx; std::queue\u0026lt;Order\u0026gt; orders; public: void push(Order order) { std::lock_guard\u0026lt;std::mutex\u0026gt; lock(mtx); // å¯èƒ½é˜»å¡ï¼ orders.push(order); } Order pop() { std::lock_guard\u0026lt;std::mutex\u0026gt; lock(mtx); // å¯èƒ½é˜»å¡ï¼ // ... å–æ•°æ® } }; æ ¸å¿ƒé—®é¢˜ï¼š\nä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ï¼šçº¿ç¨‹é˜»å¡æ—¶éœ€è¦ä¿å­˜/æ¢å¤CPUçŠ¶æ€ é”ç«äº‰ï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®æ—¶ï¼Œåªæœ‰ä¸€ä¸ªèƒ½è·å¾—é” ä¼˜å…ˆçº§åè½¬ï¼šé«˜ä¼˜å…ˆçº§çº¿ç¨‹å¯èƒ½è¢«ä½ä¼˜å…ˆçº§çº¿ç¨‹é˜»å¡ ä¸å¯é¢„æµ‹çš„å»¶è¿Ÿï¼šå»¶è¿Ÿå–å†³äºé”çš„ç«äº‰æƒ…å†µ æ— é”ç¼–ç¨‹çš„æ‰¿è¯º #æ— é”ç¼–ç¨‹é€šè¿‡åŸå­æ“ä½œå’Œç²¾å¿ƒè®¾è®¡çš„ç®—æ³•ï¼Œè®©å¤šä¸ªçº¿ç¨‹èƒ½å¤Ÿæ— é˜»å¡åœ°åä½œï¼š\n// æ— é”é˜Ÿåˆ—çš„ç†æƒ³çŠ¶æ€ class LockFreeQueue { public: bool push(T item) { // åŸå­æ“ä½œï¼Œæ°¸ä¸é˜»å¡ // è¦ä¹ˆæˆåŠŸï¼Œè¦ä¹ˆå¤±è´¥ï¼Œä½†ä¸ä¼šç­‰å¾… } std::optional\u0026lt;T\u0026gt; pop() { // åŒæ ·æ˜¯åŸå­æ“ä½œ // è¦ä¹ˆè¿”å›æ•°æ®ï¼Œè¦ä¹ˆè¿”å›ç©ºï¼Œä½†ä¸ä¼šé˜»å¡ } }; å…³é”®ä¼˜åŠ¿ï¼š","title":"æ·±å…¥ç†è§£æ— é”é˜Ÿåˆ—ï¼šä»åŸç†åˆ°å®è·µçš„å®Œæ•´æŒ‡å—"},{"content":"","date":null,"permalink":"/","section":"Yu's Space","summary":"","title":"Yu's Space"},{"content":"åœ¨ç°ä»£C++ç½‘ç»œç¼–ç¨‹ä¸­ï¼ŒBoost.Asioï¼ˆæˆ–standalone asioï¼‰æ˜¯ä½¿ç”¨æœ€å¹¿æ³›çš„å¼‚æ­¥I/Oåº“ä¹‹ä¸€ã€‚ç„¶è€Œï¼Œå…³äºAsioçš„I/Oæ¨¡å‹æœ¬è´¨ï¼Œç‰¹åˆ«æ˜¯åœ¨Linuxå¹³å°ä¸Šçš„å®ç°æœºåˆ¶ï¼Œå­˜åœ¨å¾ˆå¤šè¯¯è§£ã€‚æœ¬æ–‡å°†æ·±å…¥å‰–æAsioåœ¨Linuxå¹³å°çš„çœŸå®é¢ç›®ã€‚\næœ¬è´¨å®šä½ #Asioçš„çœŸå®èº«ä»½ #Asioåœ¨Linuxå¹³å°ä¸Šçš„æœ¬è´¨ï¼šåŒæ­¥éé˜»å¡I/O + I/Oå¤šè·¯å¤ç”¨ + å›è°ƒæœºåˆ¶çš„é«˜çº§å°è£…\nè¿™æ„å‘³ç€ï¼š\nâœ… ä¸æ˜¯ä¼ ç»Ÿçš„é˜»å¡I/Oï¼šæä¾›äº†å¼‚æ­¥ç¼–ç¨‹æ¥å£ âŒ ä¸æ˜¯çœŸæ­£çš„å¼‚æ­¥I/Oï¼šåº•å±‚ä»ä½¿ç”¨åŒæ­¥ç³»ç»Ÿè°ƒç”¨ âœ… æ˜¯å¼‚æ­¥ç¼–ç¨‹æ¡†æ¶ï¼šé€šè¿‡å›è°ƒæœºåˆ¶æ¨¡æ‹Ÿå¼‚æ­¥ç¼–ç¨‹ä½“éªŒ æ ¸å¿ƒç†è§£ #// Asioç»™ä½ çš„å°è±¡ï¼ˆå¼‚æ­¥é£æ ¼APIï¼‰ socket.async_read_some(buffer(data), [](error_code ec, size_t bytes) { // çœ‹èµ·æ¥åƒå¼‚æ­¥å›è°ƒ process_data(data, bytes); }); // ä½†Linuxä¸‹çš„å®é™…æ‰§è¡Œï¼ˆç®€åŒ–ï¼‰ epoll_wait(epfd, events, 128, -1); // åŒæ­¥ç­‰å¾…äº‹ä»¶ ssize_t n = read(fd, buffer, size); // åŒæ­¥è¯»å– callback(n); // è°ƒç”¨ç”¨æˆ·å›è°ƒ å…³é”®æ´å¯Ÿï¼šAsioæä¾›äº†å¼‚æ­¥çš„ç¼–ç¨‹ä½“éªŒï¼Œä½†ä¸æ˜¯å¼‚æ­¥çš„æ‰§è¡Œæœºåˆ¶ã€‚\nå·¥ä½œåŸç† #äº‹ä»¶é©±åŠ¨çš„æ‰§è¡Œæ¨¡å‹ #Asioåœ¨Linuxä¸Šå®ç°äº†Reactoræ¨¡å¼ï¼Œè€Œä¸æ˜¯Proactoræ¨¡å¼ï¼š\n// Reactoræ¨¡å¼çš„å…¸å‹æµç¨‹ class AsioReactor { public: void async_read(socket\u0026amp; s, buffer b, handler h) { // 1. æ³¨å†Œè¯»å–æ„å›¾ register_read_intent(s.fd(), b, h); // 2. æ·»åŠ åˆ°epollç›‘æ§ epoll_ctl(epfd_, EPOLL_CTL_ADD, s.fd(), \u0026amp;event); } void run() { while (true) { // 3. ç­‰å¾…I/Oäº‹ä»¶ int n = epoll_wait(epfd_, events_, max_events_, -1); // 4. å¤„ç†å°±ç»ªçš„äº‹ä»¶ for (int i = 0; i \u0026lt; n; i++) { handle_ready_event(events_[i]); } } } private: void handle_ready_event(const epoll_event\u0026amp; ev) { auto* op = get_operation(ev.data.ptr); // 5. æ‰§è¡Œå®é™…çš„åŒæ­¥I/O ssize_t result = read(op-\u0026gt;fd, op-\u0026gt;buffer, op-\u0026gt;size); // 6. è°ƒç”¨ç”¨æˆ·å›è°ƒ if (result \u0026gt; 0 || errno != EAGAIN) { op-\u0026gt;handler(result); } } }; å¼‚æ­¥APIçš„åˆ†è§£è¿‡ç¨‹ #å½“ä½ è°ƒç”¨async_read_someæ—¶ï¼ŒAsioå†…éƒ¨æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š\n// ç”¨æˆ·ä»£ç  socket_.async_read_some(boost::asio::buffer(data_), [this](boost::system::error_code ec, size_t length) { if (!ec) { process_data(data_, length); start_next_read(); } }); // Asioå†…éƒ¨åˆ†è§£ä¸ºï¼š void async_read_some_impl(int fd, char* buf, size_t size, handler_t h) { // Step 1: è®¾ç½®éé˜»å¡æ¨¡å¼ fcntl(fd, F_SETFL, O_NONBLOCK); // Step 2: å°è¯•ç«‹å³è¯»å– ssize_t immediate_result = read(fd, buf, size); if (immediate_result \u0026gt; 0) { // æ•°æ®å·²å°±ç»ªï¼Œç›´æ¥å›è°ƒ post_completion(h, immediate_result); return; } if (errno != EAGAIN) { // å‘ç”Ÿé”™è¯¯ post_completion(h, immediate_result); return; } // Step 3: æ•°æ®æœªå°±ç»ªï¼Œæ³¨å†Œåˆ°epoll auto* op = new read_operation{fd, buf, size, h}; epoll_event ev; ev.events = EPOLLIN; ev.data.ptr = op; epoll_ctl(epfd_, EPOLL_CTL_ADD, fd, \u0026amp;ev); } åº•å±‚å®ç°æœºåˆ¶ #ç³»ç»Ÿè°ƒç”¨å±‚é¢çš„çœŸç›¸ #ä½¿ç”¨straceè·Ÿè¸ªä¸€ä¸ªAsio TCPæœåŠ¡å™¨ï¼š\n# ç¼–è¯‘Asioç¨‹åº g++ -o asio_server server.cpp -lboost_system -pthread # è·Ÿè¸ªå…³é”®ç³»ç»Ÿè°ƒç”¨ strace -e epoll_create1,epoll_ctl,epoll_wait,read,write,accept4 ./asio_server è§‚å¯Ÿåˆ°çš„ç³»ç»Ÿè°ƒç”¨åºåˆ—ï¼š\nepoll_create1(EPOLL_CLOEXEC) = 3 bind(4, {sa_family=AF_INET, sin_port=htons(8080)}, 16) = 0 listen(4, 128) = 0 epoll_ctl(3, EPOLL_CTL_ADD, 4, {EPOLLIN, {u32=4, u64=4}}) = 0 # ç­‰å¾…è¿æ¥ epoll_wait(3, [{EPOLLIN, {u32=4, u64=4}}], 128, -1) = 1 accept4(4, {sa_family=AF_INET, sin_port=htons(52341)}, [16], SOCK_CLOEXEC) = 5 # ç­‰å¾…æ•°æ® epoll_ctl(3, EPOLL_CTL_ADD, 5, {EPOLLIN, {u32=5, u64=5}}) = 0 epoll_wait(3, [{EPOLLIN, {u32=5, u64=5}}], 128, -1) = 1 read(5, \u0026#34;Hello World\\n\u0026#34;, 1024) = 12 # åŒæ­¥readï¼ # å“åº”æ•°æ® epoll_ctl(3, EPOLL_CTL_MOD, 5, {EPOLLOUT, {u32=5, u64=5}}) = 0 epoll_wait(3, [{EPOLLOUT, {u32=5, u64=5}}], 128, -1) = 1 write(5, \u0026#34;Echo: Hello World\\n\u0026#34;, 18) = 18 # åŒæ­¥writeï¼ å…³é”®å‘ç°ï¼š\nä½¿ç”¨epoll_*ç³»åˆ—ç³»ç»Ÿè°ƒç”¨è¿›è¡Œäº‹ä»¶ç›‘æ§ ä»ç„¶æœ‰ä¼ ç»Ÿçš„read/writeç³»ç»Ÿè°ƒç”¨ æ²¡æœ‰å¼‚æ­¥I/Oç‰¹æœ‰çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆå¦‚io_uring_enterï¼‰ å†…æ ¸äº¤äº’æ¨¡å¼ #// Asioçš„å†…æ ¸äº¤äº’æ¨¡å¼ï¼ˆç®€åŒ–ï¼‰ class AsioLinuxService { int epfd_; std::queue\u0026lt;completion_handler\u0026gt; ready_handlers_; public: void run_one() { // 1. å¤„ç†å·²å®Œæˆçš„æ“ä½œ if (!ready_handlers_.empty()) { auto handler = ready_handlers_.front(); ready_handlers_.pop(); handler(); return; } // 2. ç­‰å¾…æ–°çš„I/Oäº‹ä»¶ epoll_event events[128]; int n = epoll_wait(epfd_, events, 128, 0); // éé˜»å¡æ£€æŸ¥ if (n == 0) { // æ²¡æœ‰å°±ç»ªäº‹ä»¶ï¼Œé˜»å¡ç­‰å¾… n = epoll_wait(epfd_, events, 128, -1); } // 3. å¤„ç†å°±ç»ªäº‹ä»¶ for (int i = 0; i \u0026lt; n; i++) { process_ready_operation(events[i]); } } private: void process_ready_operation(const epoll_event\u0026amp; ev) { auto* op = static_cast\u0026lt;async_operation*\u0026gt;(ev.data.ptr); // æ‰§è¡ŒåŒæ­¥I/Oæ“ä½œ op-\u0026gt;perform(); // å†…éƒ¨è°ƒç”¨read/writeç­‰åŒæ­¥ç³»ç»Ÿè°ƒç”¨ // å°†å®Œæˆçš„æ“ä½œåŠ å…¥å°±ç»ªé˜Ÿåˆ— ready_handlers_.push([op]() { op-\u0026gt;complete(); }); } }; Asioçš„è®¾è®¡å“²å­¦ #1. ç»Ÿä¸€çš„å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹ #Asioçš„æ ¸å¿ƒè®¾è®¡ç›®æ ‡æ˜¯æä¾›ç»Ÿä¸€çš„å¼‚æ­¥ç¼–ç¨‹æ¥å£ï¼Œéšè—åº•å±‚I/Oæ¨¡å‹çš„å·®å¼‚ï¼š\n// ç»Ÿä¸€çš„å¼‚æ­¥æ¥å£ï¼Œä¸åŒå¹³å°ä¸åŒå®ç° template\u0026lt;typename MutableBufferSequence, typename ReadHandler\u0026gt; void async_read_some( const MutableBufferSequence\u0026amp; buffers, ReadHandler\u0026amp;\u0026amp; handler) { #if defined(BOOST_ASIO_HAS_IOCP) // Windows: ä½¿ç”¨IOCPï¼ˆçœŸå¼‚æ­¥ï¼‰ win_iocp_socket_service::async_receive(buffers, handler); #elif defined(BOOST_ASIO_HAS_EPOLL) // Linux: ä½¿ç”¨epollï¼ˆåŒæ­¥éé˜»å¡ï¼‰ linux_epoll_reactor::async_read(buffers, handler); #elif defined(BOOST_ASIO_HAS_KQUEUE) // BSD: ä½¿ç”¨kqueue bsd_kqueue_reactor::async_read(buffers, handler); #endif } 2. Proactoræ¨¡å¼çš„æ¨¡æ‹Ÿ #Asioåœ¨Linuxä¸Šæ¨¡æ‹Ÿäº†Proactoræ¨¡å¼ï¼Œè®©ç”¨æˆ·æ„Ÿè§‰åƒåœ¨ä½¿ç”¨å¼‚æ­¥I/Oï¼š\n// ç”¨æˆ·çœ‹åˆ°çš„Proactoré£æ ¼API class Connection { public: void start() { do_read(); // å¯åŠ¨å¼‚æ­¥è¯»å–é“¾ } private: void do_read() { // æäº¤è¯»å–è¯·æ±‚ socket_.async_read_some(boost::asio::buffer(data_), [this](boost::system::error_code ec, size_t length) { if (!ec) { process_message(data_, length); do_read(); // ç»§ç»­è¯»å– } else { handle_error(ec); } }); } void do_write(const std::string\u0026amp; message) { // æäº¤å†™å…¥è¯·æ±‚ boost::asio::async_write(socket_, boost::asio::buffer(message), [this](boost::system::error_code ec, size_t length) { if (!ec) { // å†™å…¥å®Œæˆ } else { handle_error(ec); } }); } }; è®¾è®¡ä¼˜åŠ¿ï¼š\nç®€åŒ–ç¼–ç¨‹å¤æ‚åº¦ï¼šç”¨æˆ·æ— éœ€ç›´æ¥æ“ä½œepoll å›è°ƒé“¾ç®¡ç†ï¼šè‡ªåŠ¨ç®¡ç†å¼‚æ­¥æ“ä½œçš„ç”Ÿå‘½å‘¨æœŸ é”™è¯¯å¤„ç†ç»Ÿä¸€ï¼šç»Ÿä¸€çš„é”™è¯¯ç å’Œå¼‚å¸¸å¤„ç† 3. æ€§èƒ½ä¸æ˜“ç”¨æ€§çš„å¹³è¡¡ #// Asioçš„æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ class optimized_async_operation { public: void initiate() { // ä¼˜åŒ–1ï¼šç«‹å³å°è¯•æ‰§è¡Œ if (try_immediate_completion()) { return; // é¿å…ä¸å¿…è¦çš„epollæ“ä½œ } // ä¼˜åŒ–2ï¼šæ‰¹é‡æ“ä½œ if (should_batch()) { add_to_batch(); return; } // ä¼˜åŒ–3ï¼šæ³¨å†Œåˆ°ååº”å™¨ reactor_.register_operation(this); } private: bool try_immediate_completion() { // å°è¯•ç«‹å³å®Œæˆæ“ä½œï¼Œé¿å…epollå¼€é”€ ssize_t result = read(fd_, buffer_, size_); if (result \u0026gt; 0) { complete_immediately(result); return true; } return (errno != EAGAIN); } }; çœŸæ­£çš„å¼‚æ­¥I/Oå¯¹æ¯” #Linux io_uringï¼šçœŸæ­£çš„å¼‚æ­¥æ‰§è¡Œ #// çœŸæ­£çš„å¼‚æ­¥I/Oä½¿ç”¨io_uring class TrueAsyncIO { struct io_uring ring_; public: void async_read(int fd, char* buffer, size_t size, callback_t cb) { // 1. è·å–æäº¤é˜Ÿåˆ—é¡¹ struct io_uring_sqe *sqe = io_uring_get_sqe(\u0026amp;ring_); // 2. å‡†å¤‡è¯»å–æ“ä½œ io_uring_prep_read(sqe, fd, buffer, size, 0); sqe-\u0026gt;user_data = reinterpret_cast\u0026lt;uintptr_t\u0026gt;(cb); // 3. æäº¤åˆ°å†…æ ¸ï¼Œç«‹å³è¿”å› io_uring_submit(\u0026amp;ring_); // æ­¤æ—¶å†…æ ¸å¼€å§‹å¼‚æ­¥æ‰§è¡ŒI/Oæ“ä½œ // åº”ç”¨ç¨‹åºå¯ä»¥ç«‹å³åšå…¶ä»–äº‹æƒ… } void process_completions() { struct io_uring_cqe *cqe; // 4. æ£€æŸ¥å®Œæˆçš„æ“ä½œ while (io_uring_peek_cqe(\u0026amp;ring_, \u0026amp;cqe) == 0) { auto* callback = reinterpret_cast\u0026lt;callback_t*\u0026gt;(cqe-\u0026gt;user_data); // 5. è°ƒç”¨å®Œæˆå›è°ƒ (*callback)(cqe-\u0026gt;res); // cqe-\u0026gt;resæ˜¯å·²å®Œæˆçš„å­—èŠ‚æ•° io_uring_cqe_seen(\u0026amp;ring_, cqe); } } }; ç³»ç»Ÿè°ƒç”¨å¯¹æ¯” #Asio (epoll)çš„ç³»ç»Ÿè°ƒç”¨ï¼š\nepoll_wait(3, events, 128, -1) = 1 # ç­‰å¾…äº‹ä»¶ read(5, buffer, 1024) = 256 # åŒæ­¥è¯»å– epoll_ctl(3, EPOLL_CTL_MOD, 5, ...) # ä¿®æ”¹ç›‘æ§äº‹ä»¶ io_uringçš„ç³»ç»Ÿè°ƒç”¨ï¼š\nio_uring_enter(3, 1, 1, IORING_ENTER_GETEVENTS) = 1 # æäº¤å¹¶ç­‰å¾…å®Œæˆ # æ²¡æœ‰read/writeç³»ç»Ÿè°ƒç”¨ï¼æ•°æ®æ‹·è´ç”±å†…æ ¸å¼‚æ­¥å®Œæˆ æ€§èƒ½å½±å“åˆ†æ #Asioåœ¨Linuxä¸Šçš„æ€§èƒ½å¼€é”€ï¼š\nç³»ç»Ÿè°ƒç”¨å¼€é”€ï¼šæ¯æ¬¡I/Oä»éœ€è¦read/writeç³»ç»Ÿè°ƒç”¨ ç”¨æˆ·æ€/å†…æ ¸æ€åˆ‡æ¢ï¼šepoll_wait + read/write = å¤šæ¬¡åˆ‡æ¢ æ•°æ®æ‹·è´å¼€é”€ï¼šç”¨æˆ·æ€å‚ä¸æ•°æ®æ‹·è´è¿‡ç¨‹ å›è°ƒè°ƒåº¦å¼€é”€ï¼šé¢å¤–çš„å‡½æ•°è°ƒç”¨å’Œå¯¹è±¡ç®¡ç† io_uringçš„æ€§èƒ½ä¼˜åŠ¿ï¼š\næ‰¹é‡æ“ä½œï¼šä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨æäº¤å¤šä¸ªI/Oæ“ä½œ é›¶æ‹·è´ï¼šå†…æ ¸ç›´æ¥å®Œæˆæ•°æ®æ‹·è´ å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼šç”¨æˆ·æ€å’Œå†…æ ¸æ€äº¤äº’æ›´å°‘ çœŸæ­£å¹¶è¡Œï¼šå¤šä¸ªI/Oæ“ä½œå¯ä»¥çœŸæ­£å¹¶å‘æ‰§è¡Œ æ€§èƒ½åŸºå‡†æµ‹è¯• #ç®€å•çš„æ€§èƒ½å¯¹æ¯” #// æµ‹è¯•åœºæ™¯ï¼š1000ä¸ªå¹¶å‘è¿æ¥ï¼Œæ¯ä¸ªè¿æ¥è¯»å–1KBæ•°æ® // Asio (epoll) ç»“æœï¼š // QPS: ~50,000 // CPUä½¿ç”¨ç‡: 15% // ç³»ç»Ÿè°ƒç”¨æ¬¡æ•°: ~150,000/ç§’ // io_uring ç»“æœï¼š // QPS: ~80,000 // CPUä½¿ç”¨ç‡: 8% // ç³»ç»Ÿè°ƒç”¨æ¬¡æ•°: ~50,000/ç§’ é€‚ç”¨åœºæ™¯åˆ†æ #Asioé€‚ç”¨çš„åœºæ™¯ #æ¨èä½¿ç”¨Asioçš„æƒ…å†µï¼š\nè·¨å¹³å°éœ€æ±‚ï¼šéœ€è¦åœ¨Windows/Linux/macOSä¸Šè¿è¡Œ å¼€å‘æ•ˆç‡ä¼˜å…ˆï¼šå›¢é˜Ÿç†Ÿæ‚‰å›è°ƒå¼å¼‚æ­¥ç¼–ç¨‹ ä¸­ç­‰å¹¶å‘é‡ï¼šè¿æ¥æ•°åœ¨10Kä»¥ä¸‹ ä¸šåŠ¡é€»è¾‘å¤æ‚ï¼šéœ€è¦å¤æ‚çš„å¼‚æ­¥æ“ä½œç¼–æ’ è€ƒè™‘io_uringçš„åœºæ™¯ #æ¨èä½¿ç”¨io_uringçš„æƒ…å†µï¼š\næè‡´æ€§èƒ½è¦æ±‚ï¼šé«˜é¢‘äº¤æ˜“ã€å®æ—¶ç³»ç»Ÿ é«˜å¹¶å‘åœºæ™¯ï¼šè¿æ¥æ•°è¶…è¿‡50K æ–‡ä»¶I/Oå¯†é›†ï¼šå¤§é‡çš„ç£ç›˜è¯»å†™æ“ä½œ ç°ä»£Linuxç¯å¢ƒï¼šLinux 5.1+çš„ç¯å¢ƒ æ€»ç»“ #Asioçš„æœ¬è´¨è®¤çŸ¥ #åœ¨Linuxå¹³å°ä¸Šï¼ŒAsioæ˜¯ä¸€ä¸ªåŸºäºepollçš„é«˜çº§åŒæ­¥éé˜»å¡I/Oæ¡†æ¶ï¼š\nI/Oæ¨¡å‹ï¼šåŒæ­¥éé˜»å¡I/O + I/Oå¤šè·¯å¤ç”¨ ç¼–ç¨‹æ¨¡å‹ï¼šå¼‚æ­¥å›è°ƒé£æ ¼API æ‰§è¡Œæ¨¡å‹ï¼šäº‹ä»¶é©±åŠ¨çš„Reactoræ¨¡å¼ æ€§èƒ½ç‰¹å¾ï¼šä¼˜äºä¼ ç»Ÿé˜»å¡I/Oï¼Œä½†ä¸åŠçœŸæ­£çš„å¼‚æ­¥I/O æŠ€æœ¯é€‰å‹å»ºè®® # éœ€æ±‚åœºæ™¯ æ¨èæ–¹æ¡ˆ ç†ç”± è·¨å¹³å°ç½‘ç»œæœåŠ¡ Asio ç»Ÿä¸€APIï¼Œæˆç†Ÿç¨³å®š Linuxé«˜æ€§èƒ½æœåŠ¡ io_uring çœŸå¼‚æ­¥ï¼Œæ€§èƒ½æœ€ä¼˜ ç®€å•å®¢æˆ·ç«¯åº”ç”¨ åŒæ­¥I/O + çº¿ç¨‹æ±  å®ç°ç®€å•ï¼Œå¤Ÿç”¨ ç°ä»£C++é¡¹ç›® åç¨‹ + io_uring è¯­æ³•ç°ä»£ï¼Œæ€§èƒ½ä¼˜ç§€ å…³é”®è¦ç‚¹ # Asioä¸æ˜¯å¼‚æ­¥I/Oï¼Œè€Œæ˜¯å¼‚æ­¥ç¼–ç¨‹æ¡†æ¶ åº•å±‚ä»æ˜¯åŒæ­¥æ“ä½œï¼Œåªæ˜¯é€šè¿‡å›è°ƒæ¨¡æ‹Ÿå¼‚æ­¥ä½“éªŒ æ€§èƒ½ç“¶é¢ˆåœ¨äºç³»ç»Ÿè°ƒç”¨å¼€é”€å’Œç”¨æˆ·æ€å‚ä¸ é€‰æ‹©ä¾æ®åº”åŸºäºå…·ä½“éœ€æ±‚è€ŒéæŠ€æœ¯æ ‡ç­¾ ç†è§£è¿™äº›æœ¬è´¨å·®å¼‚ï¼Œæœ‰åŠ©äºæˆ‘ä»¬åœ¨å®é™…é¡¹ç›®ä¸­åšå‡ºæ›´æ˜æ™ºçš„æŠ€æœ¯é€‰æ‹©ï¼Œæ—¢ä¸ç›²ç›®è¿½æ±‚æ–°æŠ€æœ¯ï¼Œä¹Ÿä¸å›ºå®ˆè¿‡æ—¶æ–¹æ¡ˆã€‚æŠ€æœ¯çš„ä»·å€¼åœ¨äºè§£å†³å®é™…é—®é¢˜ï¼Œè€Œä¸æ˜¯ç‚«è€€å¤æ‚åº¦ã€‚\n","date":"9 July 2025","permalink":"/blog/2025-07-09-asio/","section":"Blog","summary":"åœ¨ç°ä»£C++ç½‘ç»œç¼–ç¨‹ä¸­ï¼ŒBoost.Asioï¼ˆæˆ–standalone asioï¼‰æ˜¯ä½¿ç”¨æœ€å¹¿æ³›çš„å¼‚æ­¥I/Oåº“ä¹‹ä¸€ã€‚ç„¶è€Œï¼Œå…³äºAsioçš„I/Oæ¨¡å‹æœ¬è´¨ï¼Œç‰¹åˆ«æ˜¯åœ¨Linuxå¹³å°ä¸Šçš„å®ç°æœºåˆ¶ï¼Œå­˜åœ¨å¾ˆå¤šè¯¯è§£ã€‚æœ¬æ–‡å°†æ·±å…¥å‰–æAsioåœ¨Linuxå¹³å°çš„çœŸå®é¢ç›®ã€‚\næœ¬è´¨å®šä½ #Asioçš„çœŸå®èº«ä»½ #Asioåœ¨Linuxå¹³å°ä¸Šçš„æœ¬è´¨ï¼šåŒæ­¥éé˜»å¡I/O + I/Oå¤šè·¯å¤ç”¨ + å›è°ƒæœºåˆ¶çš„é«˜çº§å°è£…\nè¿™æ„å‘³ç€ï¼š\nâœ… ä¸æ˜¯ä¼ ç»Ÿçš„é˜»å¡I/Oï¼šæä¾›äº†å¼‚æ­¥ç¼–ç¨‹æ¥å£ âŒ ä¸æ˜¯çœŸæ­£çš„å¼‚æ­¥I/Oï¼šåº•å±‚ä»ä½¿ç”¨åŒæ­¥ç³»ç»Ÿè°ƒç”¨ âœ… æ˜¯å¼‚æ­¥ç¼–ç¨‹æ¡†æ¶ï¼šé€šè¿‡å›è°ƒæœºåˆ¶æ¨¡æ‹Ÿå¼‚æ­¥ç¼–ç¨‹ä½“éªŒ æ ¸å¿ƒç†è§£ #// Asioç»™ä½ çš„å°è±¡ï¼ˆå¼‚æ­¥é£æ ¼APIï¼‰ socket.async_read_some(buffer(data), [](error_code ec, size_t bytes) { // çœ‹èµ·æ¥åƒå¼‚æ­¥å›è°ƒ process_data(data, bytes); }); // ä½†Linuxä¸‹çš„å®é™…æ‰§è¡Œï¼ˆç®€åŒ–ï¼‰ epoll_wait(epfd, events, 128, -1); // åŒæ­¥ç­‰å¾…äº‹ä»¶ ssize_t n = read(fd, buffer, size); // åŒæ­¥è¯»å– callback(n); // è°ƒç”¨ç”¨æˆ·å›è°ƒ å…³é”®æ´å¯Ÿï¼šAsioæä¾›äº†å¼‚æ­¥çš„ç¼–ç¨‹ä½“éªŒï¼Œä½†ä¸æ˜¯å¼‚æ­¥çš„æ‰§è¡Œæœºåˆ¶ã€‚\nå·¥ä½œåŸç† #äº‹ä»¶é©±åŠ¨çš„æ‰§è¡Œæ¨¡å‹ #Asioåœ¨Linuxä¸Šå®ç°äº†Reactoræ¨¡å¼ï¼Œè€Œä¸æ˜¯Proactoræ¨¡å¼ï¼š\n// Reactoræ¨¡å¼çš„å…¸å‹æµç¨‹ class AsioReactor { public: void async_read(socket\u0026amp; s, buffer b, handler h) { // 1. æ³¨å†Œè¯»å–æ„å›¾ register_read_intent(s.","title":"æ·±åº¦è§£æï¼šAsioåœ¨Linuxå¹³å°çš„I/Oæ¨¡å‹æœ¬è´¨"},{"content":"åœ¨é«˜æ€§èƒ½ç½‘ç»œç¼–ç¨‹ä¸­ï¼ŒI/Oæ¨¡å‹çš„é€‰æ‹©å¾€å¾€å†³å®šäº†ç³»ç»Ÿçš„å¹¶å‘èƒ½åŠ›å’Œæ€§èƒ½è¡¨ç°ã€‚ç„¶è€Œï¼Œå…³äºI/Oå¤šè·¯å¤ç”¨ã€åŒæ­¥I/Oã€å¼‚æ­¥I/Oç­‰æ¦‚å¿µï¼Œè®¸å¤šå¼€å‘è€…å­˜åœ¨ç†è§£ä¸Šçš„è¯¯åŒºã€‚æœ¬æ–‡å°†æ·±å…¥å‰–æè¿™äº›æ¦‚å¿µçš„æœ¬è´¨åŒºåˆ«ï¼Œæ¾„æ¸…å¸¸è§çš„æ··æ·†ç‚¹ã€‚\nå¸¸è§çš„æ¦‚å¿µæ··æ·† #è¯¯åŒºä¸€ï¼šI/Oå¤šè·¯å¤ç”¨å°±æ˜¯å¼‚æ­¥I/O #è¿™æ˜¯æœ€å¸¸è§çš„è¯¯è§£ã€‚å®é™…ä¸Šï¼ŒI/Oå¤šè·¯å¤ç”¨æœ¬è´¨ä¸Šä»ç„¶æ˜¯åŒæ­¥I/Oã€‚å‡†ç¡®åœ°è¯´ï¼Œå¤šè·¯å¤ç”¨çš„äº‹ä»¶æ£€æµ‹é˜¶æ®µæ˜¯é˜»å¡çš„ï¼ˆepoll_waitä¼šé˜»å¡ï¼‰ï¼Œè€Œå®é™…çš„I/Oè¯»å†™é˜¶æ®µä»æ˜¯åŒæ­¥æ“ä½œã€‚å®ƒåªæ˜¯æä¾›äº†\u0026quot;ç­‰å¾…å¤šä¸ªåŒæ­¥I/Oäº‹ä»¶ + æ˜¾å¼äº‹ä»¶é€šçŸ¥\u0026quot;çš„æœºåˆ¶ï¼Œè€Œä¸æ˜¯çœŸæ­£çš„å¼‚æ­¥æ‰§è¡Œã€‚\nè¯¯åŒºäºŒï¼šéé˜»å¡I/Oå°±æ˜¯å¼‚æ­¥I/O #éé˜»å¡I/Oï¼ˆNIOï¼‰è™½ç„¶ä¸ä¼šè®©çº¿ç¨‹é˜»å¡ç­‰å¾…ï¼Œä½†ä»ç„¶æ˜¯åŒæ­¥I/Oï¼Œå› ä¸ºåº”ç”¨ç¨‹åºéœ€è¦ä¸»åŠ¨è°ƒç”¨ç³»ç»Ÿè°ƒç”¨å¹¶ç«‹å³å¤„ç†è¿”å›ç»“æœï¼ˆåŒ…æ‹¬\u0026quot;æš‚æ—¶æ— æ•°æ®\u0026quot;çš„æƒ…å†µï¼‰ã€‚\nç³»ç»Ÿå±‚é¢çš„I/Oæ¨¡å‹åˆ†ç±» #1. åŒæ­¥é˜»å¡I/O (BIO) #ç‰¹ç‚¹ï¼šåº”ç”¨ç¨‹åºå‘èµ·I/Oè°ƒç”¨åï¼Œçº¿ç¨‹é˜»å¡ç­‰å¾…æ“ä½œå®Œæˆã€‚\nint sockfd = socket(AF_INET, SOCK_STREAM, 0); char buffer[1024]; // çº¿ç¨‹ä¼šé˜»å¡åœ¨è¿™é‡Œï¼Œç›´åˆ°æœ‰æ•°æ®åˆ°è¾¾ ssize_t n = read(sockfd, buffer, sizeof(buffer)); if (n \u0026gt; 0) { process_data(buffer, n); } åº”ç”¨åœºæ™¯ï¼š\nè¿æ¥æ•°è¾ƒå°‘çš„æœåŠ¡ å¯¹å®æ—¶æ€§è¦æ±‚ä¸é«˜çš„åº”ç”¨ é€šå¸¸é…åˆå¤šçº¿ç¨‹ä½¿ç”¨ 2. åŒæ­¥éé˜»å¡I/O (NIO) #ç‰¹ç‚¹ï¼šåº”ç”¨ç¨‹åºå‘èµ·I/Oè°ƒç”¨åç«‹å³è¿”å›ï¼Œéœ€è¦ä¸»åŠ¨æ£€æŸ¥æ“ä½œçŠ¶æ€ã€‚\nint sockfd = socket(AF_INET, SOCK_STREAM, 0); // è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼ int flags = fcntl(sockfd, F_GETFL, 0); fcntl(sockfd, F_SETFL, flags | O_NONBLOCK); char buffer[1024]; ssize_t n = read(sockfd, buffer, sizeof(buffer)); if (n \u0026gt; 0) { // æˆåŠŸè¯»å–æ•°æ® process_data(buffer, n); } else if (n == -1 \u0026amp;\u0026amp; errno == EAGAIN) { // æš‚æ—¶æ— æ•°æ®ï¼Œéœ€è¦ç¨åé‡è¯• // è¿™æ˜¯å…³é”®ï¼šåº”ç”¨ç¨‹åºéœ€è¦å¤„ç†\u0026#34;æœªå®Œæˆ\u0026#34;çŠ¶æ€ } else { // å‘ç”Ÿé”™è¯¯ handle_error(); } å…³é”®ç†è§£ï¼šread()è°ƒç”¨ç«‹å³è¿”å›ï¼Œä½†è¿”å›çš„å¯èƒ½æ˜¯\u0026quot;æ“ä½œçŠ¶æ€\u0026quot;è€Œä¸æ˜¯\u0026quot;å®Œæˆçš„æ•°æ®\u0026quot;ã€‚\n3. I/Oå¤šè·¯å¤ç”¨ #ç‰¹ç‚¹ï¼šä½¿ç”¨selectã€pollã€epollç­‰æœºåˆ¶ç›‘æ§å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå½“æŸä¸ªfdå¯è¯»/å¯å†™æ—¶é€šçŸ¥åº”ç”¨ç¨‹åºã€‚\nint epfd = epoll_create1(0); struct epoll_event events[MAX_EVENTS]; // ç›‘æ§å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ while (true) { // è¿™é‡Œä¼šé˜»å¡ç­‰å¾…äº‹ä»¶ int nfds = epoll_wait(epfd, events, MAX_EVENTS, -1); for (int i = 0; i \u0026lt; nfds; i++) { if (events[i].events \u0026amp; EPOLLIN) { char buffer[1024]; // å®é™…çš„I/Oæ“ä½œä»ç„¶æ˜¯åŒæ­¥çš„ ssize_t n = read(events[i].data.fd, buffer, sizeof(buffer)); if (n \u0026gt; 0) { process_data(buffer, n); } } } } æœ¬è´¨ï¼šI/Oå¤šè·¯å¤ç”¨ = äº‹ä»¶é€šçŸ¥æœºåˆ¶ + åŒæ­¥I/Oæ“ä½œ\n4. å¼‚æ­¥I/O (AIO) #ç‰¹ç‚¹ï¼šåº”ç”¨ç¨‹åºæäº¤I/Oè¯·æ±‚åç«‹å³è¿”å›ï¼Œå†…æ ¸å¼‚æ­¥å®Œæˆæ“ä½œå¹¶ä¸»åŠ¨é€šçŸ¥ç»“æœã€‚\n// Linux io_uring ç¤ºä¾‹ struct io_uring ring; io_uring_queue_init(256, \u0026amp;ring, 0); char buffer[1024]; struct io_uring_sqe *sqe = io_uring_get_sqe(\u0026amp;ring); io_uring_prep_read(sqe, sockfd, buffer, sizeof(buffer), 0); io_uring_submit(\u0026amp;ring); // æäº¤è¯·æ±‚ï¼Œç«‹å³è¿”å› // åº”ç”¨ç¨‹åºå¯ä»¥å»åšå…¶ä»–äº‹æƒ… do_other_work(); // ç¨åæ£€æŸ¥å®ŒæˆçŠ¶æ€ struct io_uring_cqe *cqe; io_uring_wait_cqe(\u0026amp;ring, \u0026amp;cqe); // åˆ°è¿™é‡Œï¼Œæ•°æ®ä¸€å®šå·²ç»è¯»å–å®Œæˆ if (cqe-\u0026gt;res \u0026gt; 0) { process_data(buffer, cqe-\u0026gt;res); } åŒæ­¥I/O vs å¼‚æ­¥I/Oï¼šæ ¸å¿ƒåŒºåˆ« #æ•°æ®å¯ç”¨æ€§ä¿è¯ #åŒæ­¥I/Oï¼ˆåŒ…æ‹¬éé˜»å¡ï¼‰ï¼š\nssize_t result = read(fd, buffer, size); // è¿”å›å€¼å¯èƒ½çš„å«ä¹‰ï¼š // \u0026gt; 0 : æˆåŠŸè¯»å–æ•°æ®ï¼ˆæ•°æ®ç«‹å³å¯ç”¨ï¼‰ // = 0 : EOF // \u0026lt; 0 : é”™è¯¯æˆ–EAGAINï¼ˆæ•°æ®ä¸å¯ç”¨ï¼Œéœ€è¦é‡è¯•ï¼‰ å¼‚æ­¥I/Oï¼š\nio_uring_wait_cqe(\u0026amp;ring, \u0026amp;cqe); int result = cqe-\u0026gt;res; // è¿”å›å€¼çš„å«ä¹‰ï¼š // \u0026gt; 0 : æ•°æ®å·²ç»è¯»å–å®Œæˆï¼ˆ100%å¯ç”¨ï¼‰ // = 0 : EOFï¼ˆæ“ä½œå®Œæˆï¼‰ // \u0026lt; 0 : æ“ä½œå®Œæˆä½†å‘ç”Ÿé”™è¯¯ // ç»å¯¹ä¸ä¼šæœ‰\u0026#34;æ•°æ®æœªå‡†å¤‡å¥½\u0026#34;çš„æƒ…å†µï¼ æ“ä½œæ—¶é—´çº¿å¯¹æ¯” #åŒæ­¥éé˜»å¡I/Oï¼š\nT1: åº”ç”¨ç¨‹åºè°ƒç”¨read() T2: å†…æ ¸æ£€æŸ¥æ•°æ®æ˜¯å¦å¯ç”¨ T3: å¦‚æœå¯ç”¨ â†’ æ‹·è´æ•°æ®ï¼Œè¿”å›æ•°æ® å¦‚æœä¸å¯ç”¨ â†’ ç«‹å³è¿”å›EAGAIN T4: åº”ç”¨ç¨‹åºå¤„ç†è¿”å›ç»“æœ å¦‚æœæ˜¯EAGAIN â†’ ç¨åé‡è¯• å¦‚æœæ˜¯æ•°æ® â†’ å¤„ç†æ•°æ® å¼‚æ­¥I/Oï¼š\nT1: åº”ç”¨ç¨‹åºæäº¤readè¯·æ±‚ T2: ç«‹å³è¿”å›ï¼Œåº”ç”¨ç¨‹åºå»åšå…¶ä»–äº‹ ... TN: å†…æ ¸åœ¨åå°ç­‰å¾…æ•°æ®ã€æ‹·è´æ•°æ® TN+1: å†…æ ¸é€šçŸ¥ï¼šæ“ä½œå®Œæˆ TN+2: åº”ç”¨ç¨‹åºå¤„ç†å®Œæˆçš„æ•°æ® ç”Ÿæ´»åŒ–ç±»æ¯” #åŒæ­¥éé˜»å¡I/O = æŸ¥çœ‹é‚®ç®±\nä½ ï¼šèµ°åˆ°é‚®ç®±å‰æŸ¥çœ‹ï¼ˆreadè°ƒç”¨ï¼‰ é‚®ç®±ï¼šè¦ä¹ˆæœ‰ä¿¡ï¼ˆè¿”å›æ•°æ®ï¼‰ï¼Œè¦ä¹ˆæ²¡ä¿¡ï¼ˆè¿”å›EAGAINï¼‰ ä½ ï¼šå¦‚æœæ²¡ä¿¡ï¼Œç¨åå†æ¥æŸ¥çœ‹ï¼ˆéœ€è¦é‡è¯•ï¼‰ å¼‚æ­¥I/O = é‚®ä»¶é€šçŸ¥æœåŠ¡\nä½ ï¼šå‘Šè¯‰é‚®å±€\u0026#34;æœ‰ä¿¡å°±é€šçŸ¥æˆ‘\u0026#34;ï¼ˆæäº¤asyncè¯·æ±‚ï¼‰ ä½ ï¼šå»åšå…¶ä»–äº‹æƒ… é‚®å±€ï¼šæœ‰ä¿¡æ—¶ä¸»åŠ¨é€šçŸ¥ä½ ï¼ˆcompletion notificationï¼‰ ä½ ï¼šæ”¶åˆ°é€šçŸ¥æ—¶ï¼Œä¿¡ä»¶å·²ç»åœ¨ä½ æ‰‹é‡Œäº† ä¸ºä»€ä¹ˆI/Oå¤šè·¯å¤ç”¨è¦é…åˆéé˜»å¡I/Oï¼Ÿ #I/Oå¤šè·¯å¤ç”¨åªèƒ½å‘Šè¯‰ä½ \u0026quot;å¯ä»¥è¿›è¡ŒI/Oæ“ä½œ\u0026quot;ï¼Œä½†ä¸èƒ½ä¿è¯æ“ä½œä¸€å®šä¸ä¼šé˜»å¡ã€‚\næ½œåœ¨çš„é˜»å¡é£é™© #// å±é™©çš„åšæ³•ï¼šå¤šè·¯å¤ç”¨ + é˜»å¡I/O int nfds = epoll_wait(epfd, events, MAX_EVENTS, -1); for (int i = 0; i \u0026lt; nfds; i++) { if (events[i].events \u0026amp; EPOLLIN) { // å³ä½¿epollè¯´å¯è¯»ï¼Œè¿™é‡Œä»å¯èƒ½é˜»å¡ï¼ ssize_t n = read(events[i].data.fd, buffer, sizeof(buffer)); } } å¯èƒ½å¯¼è‡´é˜»å¡çš„åœºæ™¯ï¼š\næ•°æ®è¢«å…¶ä»–è¿›ç¨‹è¯»å– TCPçª—å£å˜åŒ–å¯¼è‡´æ•°æ®æš‚æ—¶ä¸å¯è¯» ä¿¡å·ä¸­æ–­ç­‰å¼‚å¸¸æƒ…å†µ æ­£ç¡®çš„ç»„åˆæ–¹å¼ #// æ­£ç¡®çš„åšæ³•ï¼šå¤šè·¯å¤ç”¨ + éé˜»å¡I/O int sockfd = socket(AF_INET, SOCK_STREAM, 0); fcntl(sockfd, F_SETFL, O_NONBLOCK); // è®¾ç½®éé˜»å¡ int nfds = epoll_wait(epfd, events, MAX_EVENTS, -1); for (int i = 0; i \u0026lt; nfds; i++) { if (events[i].events \u0026amp; EPOLLIN) { char buffer[1024]; ssize_t n = read(events[i].data.fd, buffer, sizeof(buffer)); if (n \u0026gt; 0) { process_data(buffer, n); } else if (n == 0) { close_connection(events[i].data.fd); } else { if (errno == EAGAIN || errno == EWOULDBLOCK) { // æš‚æ—¶æ— æ•°æ®ï¼Œæ­£å¸¸æƒ…å†µ continue; } else { handle_error(); } } } } å®é™…åº”ç”¨åœºæ™¯é€‰æ‹© #é«˜å¹¶å‘ç½‘ç»œæœåŠ¡å™¨ #æ¨èï¼šI/Oå¤šè·¯å¤ç”¨ + éé˜»å¡I/O\nå•çº¿ç¨‹å¤„ç†å¤§é‡è¿æ¥ é¿å…çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ ä»£è¡¨ï¼šNginxã€Redis æ–‡ä»¶å¯†é›†å‹åº”ç”¨ #æ¨èï¼šå¼‚æ­¥I/O\nå¹¶å‘å¤„ç†å¤§é‡æ–‡ä»¶è¯»å†™ æœ€å¤§åŒ–ç£ç›˜I/Oååé‡ ä»£è¡¨ï¼šç°ä»£æ•°æ®åº“ç³»ç»Ÿ ç®€å•çš„å®¢æˆ·ç«¯åº”ç”¨ #å¯é€‰ï¼šåŒæ­¥é˜»å¡I/O + å¤šçº¿ç¨‹\nå®ç°ç®€å•ï¼Œé€»è¾‘æ¸…æ™° è¿æ¥æ•°ä¸å¤šçš„åœºæ™¯ æ€§èƒ½ç‰¹ç‚¹å¯¹æ¯” # I/Oæ¨¡å‹ å¹¶å‘èƒ½åŠ› å®ç°å¤æ‚åº¦ CPUåˆ©ç”¨ç‡ å†…å­˜å¼€é”€ é¿å…ç”¨æˆ·æ€é˜»å¡ é€‚ç”¨åœºæ™¯ BIO + å¤šçº¿ç¨‹ ä¸­ç­‰ ä½ ä¸­ç­‰ é«˜ å¦ è¿æ¥æ•°è¾ƒå°‘çš„æœåŠ¡ NIO + å¤šè·¯å¤ç”¨ é«˜ ä¸­ç­‰ ä½ ä½ æ˜¯ï¼ˆé…åˆéé˜»å¡ï¼‰ é«˜å¹¶å‘ç½‘ç»œæœåŠ¡ AIO (io_uring) æœ€é«˜ é«˜ æœ€ä¼˜ æœ€ä½ æ˜¯ æé«˜æ€§èƒ½ã€æ–‡ä»¶å¯†é›†å‹ è¯´æ˜ï¼š\né¿å…ç”¨æˆ·æ€é˜»å¡ï¼šæŒ‡æ˜¯å¦èƒ½ä¿è¯ç”¨æˆ·çº¿ç¨‹ä¸ä¼šåœ¨I/Oæ“ä½œä¸Šæ„å¤–é˜»å¡ CPUåˆ©ç”¨ç‡ï¼šä¸»è¦è€ƒè™‘ç³»ç»Ÿè°ƒç”¨å¼€é”€å’Œä¸Šä¸‹æ–‡åˆ‡æ¢æˆæœ¬ å†…å­˜å¼€é”€ï¼šä¸»è¦è€ƒè™‘çº¿ç¨‹æ ˆç©ºé—´å’Œå†…æ ¸æ•°æ®ç»“æ„å ç”¨ æ€»ç»“ # I/Oå¤šè·¯å¤ç”¨æ˜¯äº‹ä»¶é€šçŸ¥æœºåˆ¶ï¼Œä¸æ˜¯å¼‚æ­¥I/O éé˜»å¡I/Oä»ç„¶æ˜¯åŒæ­¥I/Oï¼Œåªæ˜¯ä¸ä¼šé˜»å¡çº¿ç¨‹ å¼‚æ­¥I/Oçš„æœ¬è´¨æ˜¯I/Oæ“ä½œï¼ˆå¦‚æ•°æ®æ‹·è´ï¼‰ç”±å†…æ ¸åœ¨åå°å®Œæˆï¼Œå¹¶é€šè¿‡äº‹ä»¶å›è°ƒæˆ–é˜Ÿåˆ—é€šçŸ¥ç”¨æˆ·ç¨‹åºç»“æœï¼Œæ— éœ€ç”¨æˆ·ä¸»åŠ¨è½®è¯¢ã€‚ åŒæ­¥ä¸å¼‚æ­¥çš„å…³é”®åŒºåˆ«åœ¨äºè°è´Ÿè´£æ•°æ®æ‹·è´å’Œå¦‚ä½•é€šçŸ¥å®Œæˆ ç°ä»£é«˜æ€§èƒ½æœåŠ¡å™¨å¤šé‡‡ç”¨**\u0026ldquo;éé˜»å¡I/O + I/Oå¤šè·¯å¤ç”¨\u0026rdquo;**çš„ç»„åˆ ç†è§£è¿™äº›æ¦‚å¿µçš„æœ¬è´¨åŒºåˆ«ï¼Œæœ‰åŠ©äºæˆ‘ä»¬åœ¨å®é™…é¡¹ç›®ä¸­é€‰æ‹©åˆé€‚çš„I/Oæ¨¡å‹ï¼Œæ„å»ºé«˜æ€§èƒ½çš„ç½‘ç»œåº”ç”¨ã€‚è®°ä½ï¼šæŠ€æœ¯é€‰æ‹©æ²¡æœ‰é“¶å¼¹ï¼Œåªæœ‰æœ€é€‚åˆçš„åœºæ™¯ã€‚\n","date":"9 July 2025","permalink":"/blog/2025-07-09-bio_nio/","section":"Blog","summary":"åœ¨é«˜æ€§èƒ½ç½‘ç»œç¼–ç¨‹ä¸­ï¼ŒI/Oæ¨¡å‹çš„é€‰æ‹©å¾€å¾€å†³å®šäº†ç³»ç»Ÿçš„å¹¶å‘èƒ½åŠ›å’Œæ€§èƒ½è¡¨ç°ã€‚ç„¶è€Œï¼Œå…³äºI/Oå¤šè·¯å¤ç”¨ã€åŒæ­¥I/Oã€å¼‚æ­¥I/Oç­‰æ¦‚å¿µï¼Œè®¸å¤šå¼€å‘è€…å­˜åœ¨ç†è§£ä¸Šçš„è¯¯åŒºã€‚æœ¬æ–‡å°†æ·±å…¥å‰–æè¿™äº›æ¦‚å¿µçš„æœ¬è´¨åŒºåˆ«ï¼Œæ¾„æ¸…å¸¸è§çš„æ··æ·†ç‚¹ã€‚\nå¸¸è§çš„æ¦‚å¿µæ··æ·† #è¯¯åŒºä¸€ï¼šI/Oå¤šè·¯å¤ç”¨å°±æ˜¯å¼‚æ­¥I/O #è¿™æ˜¯æœ€å¸¸è§çš„è¯¯è§£ã€‚å®é™…ä¸Šï¼ŒI/Oå¤šè·¯å¤ç”¨æœ¬è´¨ä¸Šä»ç„¶æ˜¯åŒæ­¥I/Oã€‚å‡†ç¡®åœ°è¯´ï¼Œå¤šè·¯å¤ç”¨çš„äº‹ä»¶æ£€æµ‹é˜¶æ®µæ˜¯é˜»å¡çš„ï¼ˆepoll_waitä¼šé˜»å¡ï¼‰ï¼Œè€Œå®é™…çš„I/Oè¯»å†™é˜¶æ®µä»æ˜¯åŒæ­¥æ“ä½œã€‚å®ƒåªæ˜¯æä¾›äº†\u0026quot;ç­‰å¾…å¤šä¸ªåŒæ­¥I/Oäº‹ä»¶ + æ˜¾å¼äº‹ä»¶é€šçŸ¥\u0026quot;çš„æœºåˆ¶ï¼Œè€Œä¸æ˜¯çœŸæ­£çš„å¼‚æ­¥æ‰§è¡Œã€‚\nè¯¯åŒºäºŒï¼šéé˜»å¡I/Oå°±æ˜¯å¼‚æ­¥I/O #éé˜»å¡I/Oï¼ˆNIOï¼‰è™½ç„¶ä¸ä¼šè®©çº¿ç¨‹é˜»å¡ç­‰å¾…ï¼Œä½†ä»ç„¶æ˜¯åŒæ­¥I/Oï¼Œå› ä¸ºåº”ç”¨ç¨‹åºéœ€è¦ä¸»åŠ¨è°ƒç”¨ç³»ç»Ÿè°ƒç”¨å¹¶ç«‹å³å¤„ç†è¿”å›ç»“æœï¼ˆåŒ…æ‹¬\u0026quot;æš‚æ—¶æ— æ•°æ®\u0026quot;çš„æƒ…å†µï¼‰ã€‚\nç³»ç»Ÿå±‚é¢çš„I/Oæ¨¡å‹åˆ†ç±» #1. åŒæ­¥é˜»å¡I/O (BIO) #ç‰¹ç‚¹ï¼šåº”ç”¨ç¨‹åºå‘èµ·I/Oè°ƒç”¨åï¼Œçº¿ç¨‹é˜»å¡ç­‰å¾…æ“ä½œå®Œæˆã€‚\nint sockfd = socket(AF_INET, SOCK_STREAM, 0); char buffer[1024]; // çº¿ç¨‹ä¼šé˜»å¡åœ¨è¿™é‡Œï¼Œç›´åˆ°æœ‰æ•°æ®åˆ°è¾¾ ssize_t n = read(sockfd, buffer, sizeof(buffer)); if (n \u0026gt; 0) { process_data(buffer, n); } åº”ç”¨åœºæ™¯ï¼š\nè¿æ¥æ•°è¾ƒå°‘çš„æœåŠ¡ å¯¹å®æ—¶æ€§è¦æ±‚ä¸é«˜çš„åº”ç”¨ é€šå¸¸é…åˆå¤šçº¿ç¨‹ä½¿ç”¨ 2. åŒæ­¥éé˜»å¡I/O (NIO) #ç‰¹ç‚¹ï¼šåº”ç”¨ç¨‹åºå‘èµ·I/Oè°ƒç”¨åç«‹å³è¿”å›ï¼Œéœ€è¦ä¸»åŠ¨æ£€æŸ¥æ“ä½œçŠ¶æ€ã€‚\nint sockfd = socket(AF_INET, SOCK_STREAM, 0); // è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼ int flags = fcntl(sockfd, F_GETFL, 0); fcntl(sockfd, F_SETFL, flags | O_NONBLOCK); char buffer[1024]; ssize_t n = read(sockfd, buffer, sizeof(buffer)); if (n \u0026gt; 0) { // æˆåŠŸè¯»å–æ•°æ® process_data(buffer, n); } else if (n == -1 \u0026amp;\u0026amp; errno == EAGAIN) { // æš‚æ—¶æ— æ•°æ®ï¼Œéœ€è¦ç¨åé‡è¯• // è¿™æ˜¯å…³é”®ï¼šåº”ç”¨ç¨‹åºéœ€è¦å¤„ç†\u0026#34;æœªå®Œæˆ\u0026#34;çŠ¶æ€ } else { // å‘ç”Ÿé”™è¯¯ handle_error(); } å…³é”®ç†è§£ï¼šread()è°ƒç”¨ç«‹å³è¿”å›ï¼Œä½†è¿”å›çš„å¯èƒ½æ˜¯\u0026quot;æ“ä½œçŠ¶æ€\u0026quot;è€Œä¸æ˜¯\u0026quot;å®Œæˆçš„æ•°æ®\u0026quot;ã€‚","title":"I/Oæ¨¡å‹æ·±åº¦è§£æï¼šå¤šè·¯å¤ç”¨ã€åŒæ­¥ä¸å¼‚æ­¥çš„æœ¬è´¨åŒºåˆ«"},{"content":"é—®é¢˜èƒŒæ™¯ #åœ¨å¼€å‘åŸºäºDPDKçš„é«˜æ€§èƒ½WebSocketå®¢æˆ·ç«¯æ—¶ï¼Œé‡åˆ°äº†å…¸å‹çš„å†…å­˜ç®¡ç†é—®é¢˜ã€‚è¯¥å®¢æˆ·ç«¯ä½¿ç”¨äº†QuickWSæ¡†æ¶ï¼Œé›†æˆF-Stackç½‘ç»œæ ˆå’ŒOpenSSLï¼Œåœ¨è¿æ¥Binance WebSocket APIè¿›è¡Œé«˜é¢‘æ•°æ®æ¥æ”¶æµ‹è¯•æ—¶å‡ºç°æ®µé”™è¯¯ã€‚\næŠ€æœ¯æ ˆæ¦‚è§ˆ # ç½‘ç»œæ ˆ: DPDK + F-Stack WebSocketåº“: QuickWS (è‡ªå®šä¹‰é«˜æ€§èƒ½æ¡†æ¶) SSL/TLS: OpenSSL 3.x å†…å­˜åˆ†é…å™¨: Flash Allocator (è‡ªå®šä¹‰åˆ†é…å™¨) ç¼“å†²åŒº: Ring Buffer with Flash Allocator ç›®æ ‡: é«˜ååé‡å®æ—¶æ•°æ®æ¥æ”¶æ€§èƒ½æµ‹è¯• æ•…éšœç°è±¡ #Connected to Binance WebSocket stream! fd: 1 Accepted protocols: , extensions: Thread 1 \u0026#34;binance_client\u0026#34; received signal SIGSEGV, Segmentation fault. å®šä½è¿‡ç¨‹ #ç¬¬ä¸€é˜¶æ®µï¼šç¯å¢ƒé—®é¢˜æ’æŸ¥ #åˆå§‹ç°è±¡: ç¨‹åºåœ¨DPDKåˆå§‹åŒ–é˜¶æ®µå°±å‡ºç°é—®é¢˜\nEAL: Auto-detected process type: SECONDARY EAL: Fail to recv reply for request /var/run/dpdk/rte/mp_socket:bus_vdev_mp è§£å†³æ–¹æ¡ˆ: æ¸…ç†DPDKæ®‹ç•™èµ„æº\nsudo rm -rf /var/run/dpdk/rte/mp_socket* sudo rm -rf /dev/hugepages/* å…³é”®å‘ç°: DPDKå¤šè¿›ç¨‹æ¨¡å¼çš„èµ„æºç«äº‰ä¼šå¯¼è‡´åˆå§‹åŒ–æŒ‚èµ·ã€‚\nç¬¬äºŒé˜¶æ®µï¼šSSLèµ„æºç®¡ç†é—®é¢˜ #æ•…éšœç°è±¡:\nfree(): invalid pointer BIO_free() -\u0026gt; qws::FLoop::~FLoop() æ·±åº¦åˆ†æ: ä½¿ç”¨GDBæ£€æŸ¥TLSå…±äº«æ•°æ®ç»“æ„ï¼š\n(gdb) print *tls_shared_data_ptr_ $5 = { cur_sock_ptr = 0x3872657375, // ğŸ‘ˆ å¼‚å¸¸æŒ‡é’ˆå€¼ï¼ buf = {data = 0x0, size = 0, start_pos = 545, capacity = 93824997653040}, shared_rbio = 0x555555a7da80, shared_wbio = 0x7ffff7e89a90, shared_bio_meth = 0x7ffff7e86000 } å…³é”®å‘ç°: cur_sock_ptr = 0x3872657375 è½¬æ¢ä¸ºASCIIæ˜¯ \u0026ldquo;8resu\u0026rdquo;ï¼Œè¯´æ˜å†…å­˜å·²è¢«è¦†å†™ï¼\næ ¹æœ¬åŸå› : FLoopå¯¹è±¡çš„é‡å¤æ„é€ å¯¼è‡´SSL BIOèµ„æºçŠ¶æ€å¼‚å¸¸\nBinanceContext ctx{}; // ç¬¬ä¸€æ¬¡æ„é€ FLoop ctx.loop = qws::FLoop{}; // ğŸ‘ˆ é—®é¢˜ï¼šé‡æ–°èµ‹å€¼è§¦å‘ææ„ è§£å†³æ–¹æ¡ˆ: åˆ é™¤é‡å¤èµ‹å€¼ï¼Œç›´æ¥ä½¿ç”¨é»˜è®¤æ„é€ çš„å¯¹è±¡\n// åˆ é™¤è¿™è¡Œ // ctx.loop = qws::FLoop{}; if (ctx.loop.Init\u0026lt;ENABLE_TLS\u0026gt;() \u0026lt; 0) { ... } ç¬¬ä¸‰é˜¶æ®µï¼šRing Bufferå†…å­˜æ“ä½œé—®é¢˜ #æœ€ç»ˆæ•…éšœç°è±¡:\n__memcpy_evex_unaligned_erms() -\u0026gt; frb::ByteRingBuffer::read_pop_front(this=0x555555aa2800, data=0x0, size=143) å…³é”®ä»£ç åˆ†æ:\nvoid process_complete_message(ClientCtx\u0026amp; client_ctx, frb::ByteRingBuffer\u0026lt;qws::FlashAllocator\u0026lt;uint8_t\u0026gt;\u0026gt;\u0026amp; temp_buf) { size_t data_size = temp_buf.size(); // ğŸ’¥ è‡´å‘½é”™è¯¯ï¼šå‘nullptræ‹·è´143å­—èŠ‚æ•°æ® temp_buf.read_pop_front(nullptr, data_size); // å¤šä½™çš„æ¸…ç†æ“ä½œ while (!temp_buf.empty()) { temp_buf.pop_front(); } } æ±‡ç¼–çº§åˆ«åˆ†æ: read_pop_front(nullptr, 143) æœ€ç»ˆè°ƒç”¨äº† memcpy(nullptr, src, 143)ï¼Œè§¦å‘æ®µé”™è¯¯ã€‚\næŠ€æœ¯æ·±åº¦åˆ†æ #1. DPDKèµ„æºç®¡ç†çš„å¤æ‚æ€§ #DPDKçš„å¤šè¿›ç¨‹æ¶æ„è¦æ±‚ä¸¥æ ¼çš„èµ„æºéš”ç¦»ï¼š\nPrimaryè¿›ç¨‹: è´Ÿè´£ç¡¬ä»¶èµ„æºåˆå§‹åŒ– Secondaryè¿›ç¨‹: å…±äº«å†…å­˜æ˜ å°„ï¼Œä½†ä¸èƒ½å†²çª æœ€ä½³å®è·µ:\nconst char* dpdk_args[] = { \u0026#34;app_name\u0026#34;, \u0026#34;--proc-type=primary\u0026#34;, \u0026#34;--file-prefix=unique_name\u0026#34; }; 2. C++å¯¹è±¡ç”Ÿå‘½å‘¨æœŸä¸RAIIé™·é˜± #åœ¨å¤æ‚çš„C++å¯¹è±¡ä¸­ï¼Œé‡æ–°èµ‹å€¼å¯èƒ½è§¦å‘æ„å¤–çš„ææ„åºåˆ—ï¼š\nstruct ComplexObject { SSLResource ssl_; ComplexObject() { ssl_.init(); } ~ComplexObject() { ssl_.cleanup(); } // ğŸ‘ˆ ææ„æ—¶æ¸…ç†èµ„æº }; ComplexObject obj; // æ„é€  obj = ComplexObject{}; // ğŸ‘ˆ å±é™©ï¼šå…ˆææ„å†æ„é€  å†…å­˜æŸåæ¨¡å¼:\nåŸå¯¹è±¡ææ„ â†’ SSLèµ„æºè¢«é‡Šæ”¾ æ–°å¯¹è±¡æ„é€  â†’ å¯èƒ½å¤ç”¨å·²é‡Šæ”¾çš„å†…å­˜åœ°å€ åç»­è®¿é—® â†’ è®¿é—®å·²è¢«å…¶ä»–ä»£ç è¦†å†™çš„å†…å­˜ 3. Ring Bufferçš„æ­£ç¡®ä½¿ç”¨æ¨¡å¼ #é”™è¯¯æ¨¡å¼:\n// é”™è¯¯ï¼šè¯•å›¾å°†æ•°æ®è¯»å–åˆ°ç©ºæŒ‡é’ˆ buffer.read_pop_front(nullptr, size); æ­£ç¡®æ¨¡å¼:\n// ä»…ä¸¢å¼ƒæ•°æ® while (!buffer.empty()) { buffer.pop_front(); } // æˆ–è€…è¯»å–åˆ°æœ‰æ•ˆç¼“å†²åŒº std::vector\u0026lt;uint8_t\u0026gt; temp(size); buffer.read_pop_front(temp.data(), size); 4. é«˜æ€§èƒ½åº”ç”¨ä¸­çš„å†…å­˜å®‰å…¨ç­–ç•¥ #åœ¨è¿½æ±‚æè‡´æ€§èƒ½æ—¶ï¼Œå¸¸è§çš„å†…å­˜å®‰å…¨è¯¯åŒºï¼š\nè¿‡åº¦ä¼˜åŒ–: ä¸ºäº†é›¶æ‹·è´è€Œè·³è¿‡è¾¹ç•Œæ£€æŸ¥ å…±äº«ç¼“å†²åŒº: å¤šçº¿ç¨‹å…±äº«å¯¼è‡´ç«æ€æ¡ä»¶ æ‰‹åŠ¨å†…å­˜ç®¡ç†: è‡ªå®šä¹‰åˆ†é…å™¨çš„å¤æ‚æ€§ å®‰å…¨ä¸æ€§èƒ½çš„å¹³è¡¡:\n// åœ¨debugæ¨¡å¼ä¸‹å¯ç”¨æ£€æŸ¥ #ifdef DEBUG if (data == nullptr || size == 0) { throw std::invalid_argument(\u0026#34;Invalid buffer parameters\u0026#34;); } #endif æ•…éšœå®šä½å·¥å…·é“¾ #1. æ ¸å¿ƒè°ƒè¯•å·¥å…·å¯¹æ¯” # å·¥å…· é€‚ç”¨åœºæ™¯ é™åˆ¶ Valgrind é€šç”¨å†…å­˜æ£€æŸ¥ ä¸æ”¯æŒDPDKçš„AVX-512æŒ‡ä»¤ GDB ç²¾ç¡®å´©æºƒå®šä½ éœ€è¦è°ƒè¯•ç¬¦å· AddressSanitizer è¿è¡Œæ—¶æ£€æµ‹ æ€§èƒ½å¼€é”€å¤§ 2. DPDKä¸“ç”¨è°ƒè¯•ç­–ç•¥ #// å†…å­˜å®Œæ•´æ€§æ£€æŸ¥ void validate_tls_data(TLSSharedData* ptr) { uintptr_t addr = reinterpret_cast\u0026lt;uintptr_t\u0026gt;(ptr-\u0026gt;cur_sock_ptr); if (addr \u0026lt; 0x1000 || addr \u0026gt; 0x7fffffffffff) { printf(\u0026#34;Memory corruption detected: %p\\n\u0026#34;, ptr-\u0026gt;cur_sock_ptr); abort(); } } 3. æ¸è¿›å¼è°ƒè¯•æ–¹æ³• # ç¯å¢ƒéš”ç¦»: é¦–å…ˆæ’é™¤DPDKç¯å¢ƒé—®é¢˜ å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ: æ£€æŸ¥C++å¯¹è±¡çš„æ„é€ /ææ„åºåˆ— APIä½¿ç”¨: éªŒè¯ç¬¬ä¸‰æ–¹åº“APIçš„æ­£ç¡®è°ƒç”¨ å†…å­˜æ¨¡å¼: åˆ†æå†…å­˜è®¿é—®æ¨¡å¼å’Œæ•°æ®æµ ç»éªŒæ€»ç»“ #å¼€å‘å»ºè®® # åˆ†å±‚è°ƒè¯•: ä»åº•å±‚(DPDK)åˆ°ä¸Šå±‚(åº”ç”¨é€»è¾‘)é€å±‚æ’æŸ¥ RAIIè°¨æ…: åœ¨å¤æ‚å¯¹è±¡ä¸­é¿å…ä¸å¿…è¦çš„é‡æ–°èµ‹å€¼ APIæ–‡æ¡£: ä»”ç»†é˜…è¯»ç¬¬ä¸‰æ–¹åº“çš„APIå¥‘çº¦ï¼Œç‰¹åˆ«æ˜¯æŒ‡é’ˆå‚æ•°è¦æ±‚ æ¸è¿›å¼€å‘: å…ˆå®ç°åŸºæœ¬åŠŸèƒ½ï¼Œå†è¿›è¡Œæ€§èƒ½ä¼˜åŒ– æ¶æ„è®¾è®¡ # æ¸…æ™°çš„æ‰€æœ‰æƒ: æ˜ç¡®æ¯ä¸ªèµ„æºçš„ç”Ÿå‘½å‘¨æœŸç®¡ç†è´£ä»» é˜²å¾¡å¼ç¼–ç¨‹: åœ¨æ€§èƒ½å…³é”®è·¯å¾„ä¹‹å¤–æ·»åŠ å‚æ•°éªŒè¯ æµ‹è¯•é©±åŠ¨: ä¸ºæ¯ä¸ªç»„ä»¶ç¼–å†™å•å…ƒæµ‹è¯•ï¼Œç‰¹åˆ«æ˜¯å†…å­˜ç®¡ç†éƒ¨åˆ† è¿™æ¬¡æ•…éšœå®šä½è¿‡ç¨‹å±•ç¤ºäº†ç°ä»£C++é«˜æ€§èƒ½åº”ç”¨å¼€å‘ä¸­çš„å…¸å‹é™·é˜±ï¼šåœ¨è¿½æ±‚æ€§èƒ½çš„åŒæ—¶ï¼Œå¿…é¡»ä¿æŒå¯¹å†…å­˜å®‰å…¨çš„ä¸¥æ ¼æ§åˆ¶ã€‚æ¯ä¸€ä¸ªçœ‹ä¼¼ç®€å•çš„APIè°ƒç”¨èƒŒåï¼Œéƒ½å¯èƒ½éšè—ç€å¤æ‚çš„å†…å­˜ç®¡ç†é€»è¾‘ã€‚\nPS: æŒ‡é’ˆæœ‰æ•ˆæ€§åˆ¤æ–­çš„æŠ€æœ¯ç»†èŠ‚ #åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬é‡åˆ°äº†å¦‚ä½•åŒºåˆ†æœ‰æ•ˆæŒ‡é’ˆå’Œæ— æ•ˆæŒ‡é’ˆçš„é—®é¢˜ã€‚è¿™æ˜¯ç³»ç»Ÿçº§ç¼–ç¨‹ä¸­çš„é‡è¦æŠ€èƒ½ã€‚\næŒ‡é’ˆåœ°å€åˆ†æå®ä¾‹ #æ— æ•ˆæŒ‡é’ˆç¤ºä¾‹: 0x3872657375\nASCIIè½¬æ¢: 0x38='8', 0x72='r', 0x65='e', 0x73='s', 0x75='u' â†’ \u0026ldquo;8resu\u0026rdquo; ç‰¹å¾: æ˜æ˜¾çš„å­—ç¬¦ä¸²æ•°æ®è¢«è¯¯å½“ä½œæŒ‡é’ˆä½¿ç”¨ æ•°å€¼åˆ†æ: çº¦150GBï¼Œåœ¨64ä½ç³»ç»Ÿä¸­è¿‡å° æœ‰æ•ˆæŒ‡é’ˆç¤ºä¾‹: 0x555555aa2800\nåœ°å€æ¨¡å¼: ç¬¦åˆLinux ASLRåçš„å †åœ°å€æ¨¡å¼ï¼ˆ0x5555å¼€å¤´ï¼‰ èŒƒå›´æ£€æŸ¥: åœ¨æ­£å¸¸ç”¨æˆ·ç©ºé—´èŒƒå›´å†… ä¸Šä¸‹æ–‡: ä½œä¸ºRing Bufferå¯¹è±¡çš„thisæŒ‡é’ˆåˆç† Linux x86_64å†…å­˜å¸ƒå±€å‚è€ƒ #0x7fffffffffff â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ æ ˆç©ºé—´ â”‚ â† æ ˆæŒ‡é’ˆé€šå¸¸ 0x7fff... 0x7fffff000000 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ å†…å­˜æ˜ å°„åŒº â”‚ â† åº“åœ°å€é€šå¸¸ 0x7f... 0x555555600000 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ å †ç©ºé—´ â”‚ â† å †æŒ‡é’ˆé€šå¸¸ 0x5555... 0x555555400000 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ ç¨‹åºä»£ç æ®µ â”‚ 0x400000 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ ä¿ç•™åŒºåŸŸ â”‚ 0x0 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ æŒ‡é’ˆæœ‰æ•ˆæ€§æ£€æŸ¥ç®—æ³• #bool is_likely_valid_pointer(void* ptr) { uintptr_t addr = reinterpret_cast\u0026lt;uintptr_t\u0026gt;(ptr); // åŸºæœ¬èŒƒå›´æ£€æŸ¥ if (addr \u0026lt; 0x1000 || addr \u0026gt; 0x7fffffffffff) { return false; } // æ£€æŸ¥ASCIIæ¨¡å¼ï¼ˆå¯èƒ½çš„å­—ç¬¦ä¸²æ•°æ®æ±¡æŸ“ï¼‰ int printable_bytes = 0; for (int i = 0; i \u0026lt; 8; i++) { uint8_t byte = (addr \u0026gt;\u0026gt; (i * 8)) \u0026amp; 0xFF; if (byte \u0026gt;= 0x20 \u0026amp;\u0026amp; byte \u0026lt;= 0x7E) { printable_bytes++; } } // å¦‚æœè¶…è¿‡ä¸€åŠå­—èŠ‚æ˜¯å¯æ‰“å°å­—ç¬¦ï¼Œå¯èƒ½æ˜¯æ•°æ®æ±¡æŸ“ return printable_bytes \u0026lt; 4; } GDBè°ƒè¯•éªŒè¯æ–¹æ³• ## æŸ¥çœ‹è¿›ç¨‹å†…å­˜æ˜ å°„ (gdb) info proc mappings # å°è¯•è®¿é—®å¯ç–‘åœ°å€ (gdb) x/1wx 0x3872657375 # æ— æ•ˆåœ°å€ä¼šæŠ¥é”™ (gdb) x/1wx 0x555555aa2800 # æœ‰æ•ˆåœ°å€èƒ½æ­£å¸¸è¯»å– # æ£€æŸ¥åœ°å€æ˜¯å¦åœ¨æœ‰æ•ˆæ˜ å°„èŒƒå›´å†… (gdb) info symbol 0x555555aa2800 è¿™ç§æŒ‡é’ˆåˆ†ææŠ€èƒ½åœ¨ç³»ç»Ÿçº§è°ƒè¯•ä¸­æå…¶é‡è¦ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†å†…å­˜æŸåã€ç¼“å†²åŒºæº¢å‡ºå’Œç±»å‹æ··æ·†æ”»å‡»æ—¶ã€‚ç†è§£æ“ä½œç³»ç»Ÿçš„å†…å­˜å¸ƒå±€å’ŒASLRæœºåˆ¶ï¼Œèƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬å¿«é€Ÿè¯†åˆ«å¼‚å¸¸çš„å†…å­˜è®¿é—®æ¨¡å¼ã€‚\n","date":"5 July 2025","permalink":"/blog/2025-07-05-dpdk_application/","section":"Blog","summary":"é—®é¢˜èƒŒæ™¯ #åœ¨å¼€å‘åŸºäºDPDKçš„é«˜æ€§èƒ½WebSocketå®¢æˆ·ç«¯æ—¶ï¼Œé‡åˆ°äº†å…¸å‹çš„å†…å­˜ç®¡ç†é—®é¢˜ã€‚è¯¥å®¢æˆ·ç«¯ä½¿ç”¨äº†QuickWSæ¡†æ¶ï¼Œé›†æˆF-Stackç½‘ç»œæ ˆå’ŒOpenSSLï¼Œåœ¨è¿æ¥Binance WebSocket APIè¿›è¡Œé«˜é¢‘æ•°æ®æ¥æ”¶æµ‹è¯•æ—¶å‡ºç°æ®µé”™è¯¯ã€‚\næŠ€æœ¯æ ˆæ¦‚è§ˆ # ç½‘ç»œæ ˆ: DPDK + F-Stack WebSocketåº“: QuickWS (è‡ªå®šä¹‰é«˜æ€§èƒ½æ¡†æ¶) SSL/TLS: OpenSSL 3.x å†…å­˜åˆ†é…å™¨: Flash Allocator (è‡ªå®šä¹‰åˆ†é…å™¨) ç¼“å†²åŒº: Ring Buffer with Flash Allocator ç›®æ ‡: é«˜ååé‡å®æ—¶æ•°æ®æ¥æ”¶æ€§èƒ½æµ‹è¯• æ•…éšœç°è±¡ #Connected to Binance WebSocket stream! fd: 1 Accepted protocols: , extensions: Thread 1 \u0026#34;binance_client\u0026#34; received signal SIGSEGV, Segmentation fault. å®šä½è¿‡ç¨‹ #ç¬¬ä¸€é˜¶æ®µï¼šç¯å¢ƒé—®é¢˜æ’æŸ¥ #åˆå§‹ç°è±¡: ç¨‹åºåœ¨DPDKåˆå§‹åŒ–é˜¶æ®µå°±å‡ºç°é—®é¢˜\nEAL: Auto-detected process type: SECONDARY EAL: Fail to recv reply for request /var/run/dpdk/rte/mp_socket:bus_vdev_mp è§£å†³æ–¹æ¡ˆ: æ¸…ç†DPDKæ®‹ç•™èµ„æº\nsudo rm -rf /var/run/dpdk/rte/mp_socket* sudo rm -rf /dev/hugepages/* å…³é”®å‘ç°: DPDKå¤šè¿›ç¨‹æ¨¡å¼çš„èµ„æºç«äº‰ä¼šå¯¼è‡´åˆå§‹åŒ–æŒ‚èµ·ã€‚","title":"DPDK + WebSocketå®¢æˆ·ç«¯å†…å­˜ç®¡ç†æ•…éšœæ·±åº¦å®šä½å®å½•"},{"content":"","date":null,"permalink":"/tags/tools/","section":"Tags","summary":"","title":" Tools "},{"content":"strace å®Œå…¨ä½¿ç”¨æŒ‡å— #ç›®å½• # strace ç®€ä»‹ åŸºç¡€è¯­æ³• æ ¸å¿ƒå‚æ•°è¯¦è§£ è¿‡æ»¤å’Œè·Ÿè¸ªé€‰é¡¹ è¾“å‡ºæ ¼å¼æ§åˆ¶ æ€§èƒ½åˆ†æå‚æ•° å®ç”¨åœºæ™¯ç¤ºä¾‹ è¾“å‡ºè§£è¯»æŒ‡å— æ€§èƒ½è°ƒä¼˜æŠ€å·§ æœ€ä½³å®è·µ 1. strace ç®€ä»‹ #1.1 ä»€ä¹ˆæ˜¯ strace #strace æ˜¯ Linux ç³»ç»Ÿä¸‹çš„ç³»ç»Ÿè°ƒç”¨è·Ÿè¸ªå·¥å…·ï¼Œå®ƒå¯ä»¥ï¼š\nç›‘æ§è¿›ç¨‹æ‰§è¡Œçš„æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨ æ˜¾ç¤ºç³»ç»Ÿè°ƒç”¨çš„å‚æ•°å’Œè¿”å›å€¼ ç»Ÿè®¡ç³»ç»Ÿè°ƒç”¨çš„æ‰§è¡Œæ—¶é—´å’Œé¢‘ç‡ è·Ÿè¸ªä¿¡å·ä¼ é€’è¿‡ç¨‹ åˆ†æç¨‹åºçš„ç³»ç»Ÿçº§è¡Œä¸º 1.2 ä¸»è¦ç”¨é€” #æ€§èƒ½åˆ†æ â†’ æ‰¾å‡ºç³»ç»Ÿè°ƒç”¨ç“¶é¢ˆ æ•…éšœæ’æŸ¥ â†’ å®šä½ç¨‹åºå¼‚å¸¸åŸå›  å®‰å…¨å®¡è®¡ â†’ ç›‘æ§ç¨‹åºç³»ç»Ÿè®¿é—® é€†å‘åˆ†æ â†’ ç†è§£ç¨‹åºè¿è¡Œæœºåˆ¶ ç³»ç»Ÿè°ƒä¼˜ â†’ ä¼˜åŒ–ç³»ç»Ÿè°ƒç”¨ä½¿ç”¨ 2. åŸºç¡€è¯­æ³• #2.1 å‘½ä»¤æ ¼å¼ ## åŸºç¡€è¯­æ³• strace [é€‰é¡¹] [å‘½ä»¤] strace [é€‰é¡¹] -p \u0026lt;è¿›ç¨‹ID\u0026gt; # ç¤ºä¾‹ strace ls /tmp # è·Ÿè¸ª ls å‘½ä»¤ strace -p 1234 # è·Ÿè¸ªè¿›ç¨‹IDä¸º1234çš„è¿›ç¨‹ strace -e trace=network curl baidu.com # åªè·Ÿè¸ªç½‘ç»œç›¸å…³ç³»ç»Ÿè°ƒç”¨ 2.2 ä¸¤ç§ä½¿ç”¨æ¨¡å¼ #æ¨¡å¼1ï¼šå¯åŠ¨æ–°è¿›ç¨‹å¹¶è·Ÿè¸ª\nstrace ./my_program strace -o trace.log ./my_program æ¨¡å¼2ï¼šé™„åŠ åˆ°å·²è¿è¡Œçš„è¿›ç¨‹\nstrace -p $(pgrep program_name) strace -p 1234 3. æ ¸å¿ƒå‚æ•°è¯¦è§£ #3.1 è¿›ç¨‹ç›¸å…³å‚æ•° # å‚æ•° å«ä¹‰ ç¤ºä¾‹ -p \u0026lt;pid\u0026gt; é™„åŠ åˆ°æŒ‡å®šè¿›ç¨‹ID strace -p 1234 -f è·Ÿè¸ªå­è¿›ç¨‹ strace -f ./parent_program -F è·Ÿè¸ªvforkåˆ›å»ºçš„å­è¿›ç¨‹ strace -F ./program -ff ä¸ºæ¯ä¸ªè¿›ç¨‹åˆ›å»ºå•ç‹¬çš„è¾“å‡ºæ–‡ä»¶ strace -ff -o trace ./program ä½¿ç”¨ç¤ºä¾‹ï¼š\n# è·Ÿè¸ªå¤šè¿›ç¨‹ç¨‹åº strace -f -o multi_process.trace ./nginx # ä¸ºæ¯ä¸ªè¿›ç¨‹å•ç‹¬è¾“å‡º strace -ff -o trace_ ./multi_thread_app # ç”Ÿæˆ: trace_1234, trace_1235, trace_1236... 3.2 è¾“å‡ºæ§åˆ¶å‚æ•° # å‚æ•° å«ä¹‰ ç¤ºä¾‹ -o \u0026lt;file\u0026gt; è¾“å‡ºåˆ°æ–‡ä»¶ strace -o output.log ./program -s \u0026lt;size\u0026gt; å­—ç¬¦ä¸²æ˜¾ç¤ºé•¿åº¦ strace -s 1024 ./program -v è¯¦ç»†æ¨¡å¼ strace -v ./program -x åå…­è¿›åˆ¶æ˜¾ç¤ºéASCIIå­—ç¬¦ strace -x ./program -xx æ‰€æœ‰å­—ç¬¦ä¸²éƒ½ç”¨åå…­è¿›åˆ¶ strace -xx ./program å­—ç¬¦ä¸²æ˜¾ç¤ºå¯¹æ¯”ï¼š\n# é»˜è®¤æ˜¾ç¤º (æˆªæ–­) read(3, \u0026#34;Hello World\u0026#34;..., 1024) = 11 # å¢åŠ æ˜¾ç¤ºé•¿åº¦ strace -s 1024 ./program read(3, \u0026#34;Hello World! This is a long string...\u0026#34;, 1024) = 38 # åå…­è¿›åˆ¶æ˜¾ç¤º strace -x ./program read(3, \u0026#34;Hello\\x20World\\x21\u0026#34;, 12) = 12 4. è¿‡æ»¤å’Œè·Ÿè¸ªé€‰é¡¹ #4.1 ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤ #4.1.1 åŸºæœ¬è¿‡æ»¤è¯­æ³• ## åªè·Ÿè¸ªæŒ‡å®šçš„ç³»ç»Ÿè°ƒç”¨ strace -e trace=\u0026lt;syscall_set\u0026gt; ./program # æ’é™¤æŒ‡å®šçš„ç³»ç»Ÿè°ƒç”¨ strace -e trace=!\u0026lt;syscall_set\u0026gt; ./program 4.1.2 ç³»ç»Ÿè°ƒç”¨åˆ†ç±» # åˆ†ç±» å«ä¹‰ åŒ…å«çš„ç³»ç»Ÿè°ƒç”¨ file æ–‡ä»¶æ“ä½œ open, read, write, close, stat process è¿›ç¨‹ç®¡ç† fork, exec, exit, wait network ç½‘ç»œæ“ä½œ socket, bind, listen, accept, send, recv signal ä¿¡å·å¤„ç† kill, signal, sigaction ipc è¿›ç¨‹é—´é€šä¿¡ pipe, msgget, semget, shmget desc æ–‡ä»¶æè¿°ç¬¦ select, poll, epoll memory å†…å­˜ç®¡ç† mmap, munmap, brk, mprotect ä½¿ç”¨ç¤ºä¾‹ï¼š\n# åªè·Ÿè¸ªç½‘ç»œç›¸å…³ç³»ç»Ÿè°ƒç”¨ strace -e trace=network ./network_app # è·Ÿè¸ªæ–‡ä»¶å’Œç½‘ç»œæ“ä½œ strace -e trace=file,network ./web_server # æ’é™¤å†…å­˜ç®¡ç†ç›¸å…³è°ƒç”¨ strace -e trace=!memory ./program # è·Ÿè¸ªç‰¹å®šçš„ç³»ç»Ÿè°ƒç”¨ strace -e trace=read,write,open,close ./file_processor 4.2 é«˜çº§è¿‡æ»¤é€‰é¡¹ #4.2.1 é”™è¯¯è¿‡æ»¤ ## åªæ˜¾ç¤ºå¤±è´¥çš„ç³»ç»Ÿè°ƒç”¨ strace -e trace=all -e fault=eperm ./program # åªæ˜¾ç¤ºè¿”å›é”™è¯¯çš„è°ƒç”¨ strace -Z ./program # è·Ÿè¸ªç‰¹å®šé”™è¯¯ç  strace -e trace=all -e abbrev=none -e verbose=all ./program 4.2.2 æ–‡ä»¶æè¿°ç¬¦è¿‡æ»¤ ## åªè·Ÿè¸ªç‰¹å®šæ–‡ä»¶æè¿°ç¬¦çš„æ“ä½œ strace -e write=1,2 ./program # åªè·Ÿè¸ªstdoutå’Œstderr strace -e read=0 ./program # åªè·Ÿè¸ªstdinè¯»å– 5. è¾“å‡ºæ ¼å¼æ§åˆ¶ #5.1 æ—¶é—´ç›¸å…³å‚æ•° # å‚æ•° å«ä¹‰ è¾“å‡ºæ ¼å¼ -t æ˜¾ç¤ºæ—¶é—´æˆ³ HH:MM:SS -tt æ˜¾ç¤ºå¾®ç§’çº§æ—¶é—´æˆ³ HH:MM:SS.microseconds -ttt æ˜¾ç¤ºUnixæ—¶é—´æˆ³ seconds.microseconds -T æ˜¾ç¤ºç³»ç»Ÿè°ƒç”¨è€—æ—¶ \u0026lt;0.000123\u0026gt; -r æ˜¾ç¤ºç›¸å¯¹æ—¶é—´ è‡ªä¸Šæ¬¡ç³»ç»Ÿè°ƒç”¨çš„æ—¶é—´é—´éš” æ—¶é—´è¾“å‡ºç¤ºä¾‹ï¼š\n# æ ‡å‡†æ—¶é—´æˆ³ strace -t ./program 14:30:25 open(\u0026#34;/etc/passwd\u0026#34;, O_RDONLY) = 3 # å¾®ç§’çº§ç²¾åº¦ strace -tt ./program 14:30:25.123456 open(\u0026#34;/etc/passwd\u0026#34;, O_RDONLY) = 3 # æ˜¾ç¤ºæ‰§è¡Œæ—¶é—´ strace -T ./program open(\u0026#34;/etc/passwd\u0026#34;, O_RDONLY) = 3 \u0026lt;0.000089\u0026gt; # ç›¸å¯¹æ—¶é—´ strace -r ./program 0.000000 open(\u0026#34;/etc/passwd\u0026#34;, O_RDONLY) = 3 0.000234 read(3, \u0026#34;rootâŒ0:0:root:/root:/bin/bash\\n\u0026#34;, 4096) = 32 5.2 è¾“å‡ºè¯¦ç»†ç¨‹åº¦ ## è¯¦ç»†æ¨¡å¼ - æ˜¾ç¤ºå®Œæ•´çš„ç»“æ„ä½“å†…å®¹ strace -v ./program # ç®€åŒ–æ¨¡å¼ - çœç•¥å¸¸è§ç»“æ„ä½“çš„è¯¦ç»†ä¿¡æ¯ strace -e abbrev=all ./program # è‡ªå®šä¹‰çœç•¥ strace -e abbrev=read,write ./program å¯¹æ¯”ç¤ºä¾‹ï¼š\n# é»˜è®¤è¾“å‡º stat(\u0026#34;/tmp\u0026#34;, {st_mode=S_IFDIR|0755, st_size=4096, ...}) = 0 # è¯¦ç»†è¾“å‡º strace -v ./program stat(\u0026#34;/tmp\u0026#34;, {st_dev=makedev(0, 24), st_ino=2, st_mode=S_IFDIR|0755, st_nlink=18, st_uid=0, st_gid=0, st_rdev=makedev(0, 0), st_size=4096, st_blksize=4096, st_blocks=8, ...}) = 0 6. æ€§èƒ½åˆ†æå‚æ•° #6.1 ç»Ÿè®¡åˆ†æ ## ç”Ÿæˆç³»ç»Ÿè°ƒç”¨ç»Ÿè®¡æŠ¥å‘Š strace -c ./program # æŒ‰æ—¶é—´æ’åº strace -c -S time ./program # æŒ‰è°ƒç”¨æ¬¡æ•°æ’åº strace -c -S calls ./program # æŒ‰è°ƒç”¨åç§°æ’åº strace -c -S name ./program ç»Ÿè®¡è¾“å‡ºç¤ºä¾‹ï¼š\n% time seconds usecs/call calls errors syscall ------ ----------- ----------- --------- --------- ---------------- 99.98 0.017711 17711 1 restart_syscall 0.02 0.000004 4 1 futex ------ ----------- ----------- --------- --------- ---------------- 100.00 0.017715 8857 2 total 6.2 æ€§èƒ½ç›‘æ§å‚æ•° # å‚æ•° å«ä¹‰ ç”¨é€” -c ç»Ÿè®¡æ¨¡å¼ ç”Ÿæˆè°ƒç”¨æ¬¡æ•°å’Œæ—¶é—´ç»Ÿè®¡ -C è®¡æ•°æ¨¡å¼ åªè®¡æ•°ï¼Œä¸æ˜¾ç¤ºè¯¦ç»†è°ƒç”¨ -S \u0026lt;sort\u0026gt; æ’åºæ–¹å¼ time/calls/name/nothing -w æ€»ç»“æŒ‚èµ·çš„ç³»ç»Ÿè°ƒç”¨ æ˜¾ç¤ºè¢«é˜»å¡çš„è°ƒç”¨ 7. å®ç”¨åœºæ™¯ç¤ºä¾‹ #7.1 ç½‘ç»œç¨‹åºåˆ†æ ## åˆ†æç½‘ç»œç¨‹åºçš„ç³»ç»Ÿè°ƒç”¨ strace -e trace=network -tt -T -o network.log ./web_server # åªå…³æ³¨socketæ“ä½œ strace -e trace=socket,bind,listen,accept,send,recv ./network_app # åˆ†æè¿æ¥å»ºç«‹è¿‡ç¨‹ strace -e trace=network -v ./client_program 7.2 æ–‡ä»¶I/Oåˆ†æ ## è·Ÿè¸ªæ–‡ä»¶æ“ä½œ strace -e trace=file -s 256 ./file_processor # æŸ¥çœ‹é…ç½®æ–‡ä»¶è¯»å– strace -e trace=openat,read -e file ./config_reader # åˆ†æå†™å…¥æ€§èƒ½ strace -e trace=write -T ./data_writer 7.3 æ€§èƒ½ç“¶é¢ˆå®šä½ ## æ‰¾å‡ºæœ€è€—æ—¶çš„ç³»ç»Ÿè°ƒç”¨ strace -c -S time ./slow_program # åˆ†æé«˜é¢‘ç³»ç»Ÿè°ƒç”¨ strace -c -S calls ./busy_program # ç›‘æ§é•¿æ—¶é—´è¿è¡Œçš„è¿›ç¨‹ strace -p $(pgrep long_running) -c -T 7.4 å¤šè¿›ç¨‹ç¨‹åºè°ƒè¯• ## è·Ÿè¸ªçˆ¶å­è¿›ç¨‹ strace -f -o family.log ./parent_process # ä¸ºæ¯ä¸ªè¿›ç¨‹å•ç‹¬è¾“å‡º strace -ff -o trace_ ./multi_process_app # è·Ÿè¸ªçº¿ç¨‹åˆ›å»º strace -f -e trace=clone ./threaded_app 7.5 SSL/TLSç¨‹åºåˆ†æ #åŸºäºæˆ‘ä»¬å‰é¢çš„å®é™…æ¡ˆä¾‹ï¼š\n# åˆ†æHTTPSè¿æ¥è¿‡ç¨‹ strace -e trace=network,file -s 1024 ./https_client # æŸ¥çœ‹è¯ä¹¦è¯»å–è¿‡ç¨‹ strace -e trace=openat,read -e file=/etc/ssl ./ssl_app # åˆ†æTLSæ¡æ‰‹ strace -e trace=sendto,recvfrom -x ./tls_client 8. è¾“å‡ºè§£è¯»æŒ‡å— #8.1 ç³»ç»Ÿè°ƒç”¨æ ¼å¼ #ç³»ç»Ÿè°ƒç”¨å(å‚æ•°1, å‚æ•°2, ...) = è¿”å›å€¼ \u0026lt;æ‰§è¡Œæ—¶é—´\u0026gt; ç¤ºä¾‹è§£æï¼š\n# æ–‡ä»¶æ‰“å¼€ openat(AT_FDCWD, \u0026#34;/etc/passwd\u0026#34;, O_RDONLY) = 3 # â†‘ â†‘ â†‘ â†‘ # è°ƒç”¨å å·¥ä½œç›®å½• æ–‡ä»¶è·¯å¾„ è¿”å›çš„æ–‡ä»¶æè¿°ç¬¦ # ç½‘ç»œå‘é€ sendto(16, \u0026#34;\\26\\3\\1\\2\\0\\1\\0\\1\\374...\u0026#34;, 517, MSG_NOSIGNAL, NULL, 0) = 517 # â†‘ â†‘ â†‘ â†‘ â†‘ â†‘ â†‘ â†‘ # è°ƒç”¨å fd æ•°æ®å†…å®¹ é•¿åº¦ æ ‡å¿— åœ°å€ é•¿åº¦ è¿”å›å€¼ # è½®è¯¢ç­‰å¾… poll([{fd=16, events=POLLIN}], 1, 167) = 1 ([{fd=16, revents=POLLIN}]) # â†‘ â†‘ â†‘ â†‘ â†‘ â†‘ â†‘ # è°ƒç”¨å æ–‡ä»¶æè¿°ç¬¦ å…³æ³¨äº‹ä»¶ æ•°é‡ è¶…æ—¶ è¿”å›æ•°é‡ å®é™…äº‹ä»¶ 8.2 å¸¸è§è¿”å›å€¼å«ä¹‰ # è¿”å›å€¼ å«ä¹‰ ç¤ºä¾‹ \u0026gt; 0 æˆåŠŸï¼Œè¿”å›å­—èŠ‚æ•°/æè¿°ç¬¦ç­‰ read() = 1024 0 æˆåŠŸï¼Œç‰¹æ®Šå«ä¹‰ read() = 0 (EOF) -1 å¤±è´¥ open() = -1 ENOENT ? è¿›ç¨‹é€€å‡º/ä¿¡å·ä¸­æ–­ read() = ? ERESTART 8.3 å¸¸è§é”™è¯¯ç  # é”™è¯¯ç  å«ä¹‰ å¸¸è§åŸå›  ENOENT æ–‡ä»¶ä¸å­˜åœ¨ è·¯å¾„é”™è¯¯ã€æ–‡ä»¶è¢«åˆ é™¤ EACCES æƒé™ä¸è¶³ æ–‡ä»¶æƒé™ã€SELinux EAGAIN èµ„æºæš‚æ—¶ä¸å¯ç”¨ éé˜»å¡I/Oã€èµ„æºå¿™ EINPROGRESS æ“ä½œæ­£åœ¨è¿›è¡Œ éé˜»å¡connect EINTR è¢«ä¿¡å·ä¸­æ–­ ä¿¡å·å¤„ç† EPIPE ç®¡é“ç ´è£‚ å¯¹ç«¯å…³é—­è¿æ¥ 9. æ€§èƒ½è°ƒä¼˜æŠ€å·§ #9.1 å‡å°‘straceå¼€é”€ ## åªè·Ÿè¸ªå¿…è¦çš„ç³»ç»Ÿè°ƒç”¨ strace -e trace=network ./program # ä½¿ç”¨ç»Ÿè®¡æ¨¡å¼å‡å°‘è¾“å‡º strace -c ./program # é™åˆ¶å­—ç¬¦ä¸²é•¿åº¦ strace -s 64 ./program # è¾“å‡ºåˆ°æ–‡ä»¶è€Œä¸æ˜¯ç»ˆç«¯ strace -o output.log ./program 9.2 å¤§é‡æ•°æ®å¤„ç† ## ä½¿ç”¨å‹ç¼©è¾“å‡º strace -o \u0026gt;(gzip \u0026gt; trace.gz) ./program # åˆ†ç¦»é”™è¯¯è¾“å‡º strace -o trace.out 2\u0026gt;trace.err ./program # å®æ—¶ç›‘æ§å…³é”®è°ƒç”¨ strace -e trace=network -f ./program | grep -E \u0026#34;(send|recv)\u0026#34; 9.3 é•¿æœŸç›‘æ§ ## å‘¨æœŸæ€§ç»Ÿè®¡ while true; do timeout 60 strace -c -p $(pgrep myapp) 2\u0026gt;\u0026amp;1 | \\ tee -a stats_$(date +%H%M).log sleep 300 done # ç›‘æ§ç‰¹å®šæ¡ä»¶ strace -e trace=all -p $(pgrep myapp) 2\u0026gt;\u0026amp;1 | \\ awk \u0026#39;/ENOENT/ {print strftime(\u0026#34;%Y-%m-%d %H:%M:%S\u0026#34;), $0}\u0026#39; 10. æœ€ä½³å®è·µ #10.1 è°ƒè¯•æœ€ä½³å®è·µ ## 1. ä»ç»Ÿè®¡å¼€å§‹ strace -c ./program # 2. å®šä½é—®é¢˜ç³»ç»Ÿè°ƒç”¨ strace -e trace=network -T ./program # 3. è¯¦ç»†åˆ†æç‰¹å®šè°ƒç”¨ strace -e trace=sendto,recvfrom -v -s 1024 ./program # 4. æ—¶é—´åºåˆ—åˆ†æ strace -tt -T -o detailed.log ./program 10.2 æ€§èƒ½åˆ†ææœ€ä½³å®è·µ ## å¯¹æ¯”åˆ†æ strace -c ./old_version \u0026gt; old_stats.txt strace -c ./new_version \u0026gt; new_stats.txt diff old_stats.txt new_stats.txt # ç“¶é¢ˆå®šä½ strace -c -S time ./program | head -10 # çƒ­ç‚¹åˆ†æ strace -c -S calls ./program | head -10 10.3 ç”Ÿäº§ç¯å¢ƒä½¿ç”¨æ³¨æ„äº‹é¡¹ #10.3.1 æ€§èƒ½å½±å“ ## straceä¼šæ˜¾è‘—å½±å“ç¨‹åºæ€§èƒ½ï¼Œç”Ÿäº§ç¯å¢ƒè°¨æ…ä½¿ç”¨ # å»ºè®®ï¼š # 1. çŸ­æ—¶é—´è·Ÿè¸ª timeout 30 strace -p $PID # 2. åªè·Ÿè¸ªå…³é”®è°ƒç”¨ strace -e trace=network -p $PID # 3. ä½¿ç”¨ç»Ÿè®¡æ¨¡å¼ strace -c -p $PID 10.3.2 å®‰å…¨è€ƒè™‘ ## é¿å…æ•æ„Ÿä¿¡æ¯æ³„éœ² strace -e trace=network -s 0 ./program # ä¸æ˜¾ç¤ºæ•°æ®å†…å®¹ strace -o /dev/null -c ./program # åªè¦ç»Ÿè®¡ï¼Œä¸è¦è¯¦ç»†æ—¥å¿— 10.4 å¸¸ç”¨ç»„åˆå‘½ä»¤ ## ç½‘ç»œç¨‹åºå®Œæ•´åˆ†æ strace -f -e trace=network -tt -T -s 256 -o network_trace.log ./network_app # æ–‡ä»¶I/Oæ€§èƒ½åˆ†æ strace -e trace=file -c -S time ./file_app # å¤šè¿›ç¨‹ç¨‹åºè°ƒè¯• strace -ff -o trace_ -e trace=process,network ./multi_process_app # å®æ—¶ç›‘æ§ç”Ÿäº§ç¨‹åº strace -p $(pgrep production_app) -e trace=network -c æ€»ç»“ #strace æ˜¯Linuxç³»ç»Ÿè°ƒè¯•å’Œæ€§èƒ½åˆ†æçš„å¼ºå¤§å·¥å…·ï¼ŒæŒæ¡å…¶ä½¿ç”¨æ–¹æ³•å¯¹äºï¼š\nå¼€å‘é˜¶æ®µ # ç†è§£ç¨‹åºç³»ç»Ÿè°ƒç”¨è¡Œä¸º ä¼˜åŒ–I/Oæ“ä½œ è°ƒè¯•ç¨‹åºå¼‚å¸¸ è¿ç»´é˜¶æ®µ # æ€§èƒ½ç“¶é¢ˆå®šä½ æ•…éšœåŸå› åˆ†æ ç³»ç»Ÿè¡Œä¸ºç›‘æ§ å­¦ä¹ é˜¶æ®µ # ç†è§£æ“ä½œç³»ç»ŸåŸç† å­¦ä¹ ç³»ç»Ÿç¼–ç¨‹ åˆ†æç¨‹åºè¿è¡Œæœºåˆ¶ é€šè¿‡åˆç†ä½¿ç”¨straceçš„å„ç§å‚æ•°å’Œé€‰é¡¹ï¼Œå¯ä»¥æ·±å…¥äº†è§£ç¨‹åºçš„ç³»ç»Ÿçº§è¡Œä¸ºï¼Œä¸ºæ€§èƒ½ä¼˜åŒ–å’Œé—®é¢˜æ’æŸ¥æä¾›é‡è¦ä¾æ®ã€‚\nå…³é”®è¦ç‚¹ï¼š\né€‰æ‹©åˆé€‚çš„è¿‡æ»¤æ¡ä»¶å‡å°‘å™ªéŸ³ ä½¿ç”¨ç»Ÿè®¡æ¨¡å¼è¿›è¡Œå®è§‚åˆ†æ ç»“åˆæ—¶é—´ä¿¡æ¯å®šä½æ€§èƒ½ç“¶é¢ˆ æ³¨æ„ç”Ÿäº§ç¯å¢ƒä½¿ç”¨çš„æ€§èƒ½å½±å“ å–„ç”¨ç»„åˆå‚æ•°æé«˜åˆ†ææ•ˆç‡ ","date":"3 July 2025","permalink":"/blog/2025-07-03-strace/","section":"Blog","summary":"strace å®Œå…¨ä½¿ç”¨æŒ‡å— #ç›®å½• # strace ç®€ä»‹ åŸºç¡€è¯­æ³• æ ¸å¿ƒå‚æ•°è¯¦è§£ è¿‡æ»¤å’Œè·Ÿè¸ªé€‰é¡¹ è¾“å‡ºæ ¼å¼æ§åˆ¶ æ€§èƒ½åˆ†æå‚æ•° å®ç”¨åœºæ™¯ç¤ºä¾‹ è¾“å‡ºè§£è¯»æŒ‡å— æ€§èƒ½è°ƒä¼˜æŠ€å·§ æœ€ä½³å®è·µ 1. strace ç®€ä»‹ #1.1 ä»€ä¹ˆæ˜¯ strace #strace æ˜¯ Linux ç³»ç»Ÿä¸‹çš„ç³»ç»Ÿè°ƒç”¨è·Ÿè¸ªå·¥å…·ï¼Œå®ƒå¯ä»¥ï¼š\nç›‘æ§è¿›ç¨‹æ‰§è¡Œçš„æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨ æ˜¾ç¤ºç³»ç»Ÿè°ƒç”¨çš„å‚æ•°å’Œè¿”å›å€¼ ç»Ÿè®¡ç³»ç»Ÿè°ƒç”¨çš„æ‰§è¡Œæ—¶é—´å’Œé¢‘ç‡ è·Ÿè¸ªä¿¡å·ä¼ é€’è¿‡ç¨‹ åˆ†æç¨‹åºçš„ç³»ç»Ÿçº§è¡Œä¸º 1.2 ä¸»è¦ç”¨é€” #æ€§èƒ½åˆ†æ â†’ æ‰¾å‡ºç³»ç»Ÿè°ƒç”¨ç“¶é¢ˆ æ•…éšœæ’æŸ¥ â†’ å®šä½ç¨‹åºå¼‚å¸¸åŸå›  å®‰å…¨å®¡è®¡ â†’ ç›‘æ§ç¨‹åºç³»ç»Ÿè®¿é—® é€†å‘åˆ†æ â†’ ç†è§£ç¨‹åºè¿è¡Œæœºåˆ¶ ç³»ç»Ÿè°ƒä¼˜ â†’ ä¼˜åŒ–ç³»ç»Ÿè°ƒç”¨ä½¿ç”¨ 2. åŸºç¡€è¯­æ³• #2.1 å‘½ä»¤æ ¼å¼ ## åŸºç¡€è¯­æ³• strace [é€‰é¡¹] [å‘½ä»¤] strace [é€‰é¡¹] -p \u0026lt;è¿›ç¨‹ID\u0026gt; # ç¤ºä¾‹ strace ls /tmp # è·Ÿè¸ª ls å‘½ä»¤ strace -p 1234 # è·Ÿè¸ªè¿›ç¨‹IDä¸º1234çš„è¿›ç¨‹ strace -e trace=network curl baidu.","title":"strace å®Œå…¨ä½¿ç”¨æŒ‡å—"},{"content":"","date":null,"permalink":"/tags/","section":"Tags","summary":"","title":"Tags"},{"content":"ç›®å½• # DPDKæ€§èƒ½ä¼˜åŠ¿æ¦‚è¿° æ€§èƒ½éªŒè¯ç»´åº¦ ç³»ç»Ÿè°ƒç”¨åˆ†æ ä¸Šä¸‹æ–‡åˆ‡æ¢ç›‘æ§ CPUä½¿ç”¨æ•ˆç‡åˆ†æ å†…å­˜è®¿é—®ä¼˜åŒ–éªŒè¯ ç½‘ç»œæ€§èƒ½åŸºå‡†æµ‹è¯• æ€§èƒ½æŒ‡æ ‡è§£è¯» éªŒè¯æ–¹æ³•æ€»ç»“ 1. DPDKæ€§èƒ½ä¼˜åŠ¿æ¦‚è¿° #1.1 ä¼ ç»Ÿç½‘ç»œæ ˆ vs DPDKæ¶æ„ #ä¼ ç»Ÿç½‘ç»œæ ˆæµç¨‹ï¼š\nåº”ç”¨ç¨‹åº â†’ Socket API â†’ å†…æ ¸ç½‘ç»œæ ˆ â†’ ç½‘å¡é©±åŠ¨ â†’ ç¡¬ä»¶ â†‘ ç³»ç»Ÿè°ƒç”¨å¼€é”€ â†‘ å†…æ ¸æ€/ç”¨æˆ·æ€åˆ‡æ¢ â†‘ æ•°æ®æ‹·è´ â†‘ ä¸­æ–­å¤„ç† DPDKæµç¨‹ï¼š\nåº”ç”¨ç¨‹åº â†’ DPDK API â†’ PMD â†’ ç¡¬ä»¶ â†‘ ç”¨æˆ·æ€ç›´æ¥æ“ä½œ â†‘ é›¶æ‹·è´ â†‘ è½®è¯¢æ¨¡å¼ â†‘ CPUç»‘å®š 1.2 ç†è®ºæ€§èƒ½æå‡ # ä¼˜åŒ–ç‚¹ ä¼ ç»Ÿæ–¹å¼ DPDKæ–¹å¼ é¢„æœŸæå‡ å»¶è¿Ÿ 50-100Î¼s 5-20Î¼s 3-10å€ ååé‡ 1-5 Gbps 10-100 Gbps 10-20å€ CPUæ•ˆç‡ 50-70% 80-95% 1.5-2å€ ç³»ç»Ÿè°ƒç”¨ æ•°ä¸‡æ¬¡/ç§’ è¿‘ä¹0 1000å€+ 2. æ€§èƒ½éªŒè¯ç»´åº¦ #2.1 æ ¸å¿ƒéªŒè¯æŒ‡æ ‡ #DPDKæ€§èƒ½éªŒè¯ â”œâ”€â”€ ç³»ç»Ÿè°ƒç”¨å‡å°‘ (straceåˆ†æ) â”œâ”€â”€ ä¸Šä¸‹æ–‡åˆ‡æ¢é™ä½ (perfç›‘æ§) â”œâ”€â”€ CPUä½¿ç”¨æ•ˆç‡ (CPUäº²å’Œæ€§) â”œâ”€â”€ å†…å­˜è®¿é—®ä¼˜åŒ– (å¤§é¡µå†…å­˜) â”œâ”€â”€ ç½‘ç»œå»¶è¿Ÿä¼˜åŒ– (RTTæµ‹é‡) â””â”€â”€ ååé‡æå‡ (å¸¦å®½æµ‹è¯•) 2.2 éªŒè¯å¯¹æ¯”æ–¹æ³• #åŸºæœ¬å¯¹æ¯”ç­–ç•¥ï¼š\nåŒæ ·çš„åº”ç”¨é€»è¾‘ï¼šä¼ ç»ŸSocketç‰ˆæœ¬ vs DPDKç‰ˆæœ¬ ç›¸åŒçš„ç¡¬ä»¶ç¯å¢ƒï¼šCPUã€å†…å­˜ã€ç½‘å¡é…ç½®ä¸€è‡´ ç›¸åŒçš„ç½‘ç»œæ¡ä»¶ï¼šå¸¦å®½ã€å»¶è¿Ÿã€ä¸¢åŒ…ç‡ ç›¸åŒçš„è´Ÿè½½æ¨¡å¼ï¼šè¯·æ±‚é¢‘ç‡ã€æ•°æ®å¤§å°ã€è¿æ¥æ•° 3. ç³»ç»Ÿè°ƒç”¨åˆ†æ #3.1 ä½¿ç”¨straceç›‘æ§ç³»ç»Ÿè°ƒç”¨ #åŸºç¡€ç›‘æ§å‘½ä»¤ï¼š\n# ç»Ÿè®¡ç³»ç»Ÿè°ƒç”¨ç±»å‹å’Œé¢‘ç‡ strace -c -p \u0026lt;pid\u0026gt; # è¯¦ç»†è·Ÿè¸ªç½‘ç»œç›¸å…³ç³»ç»Ÿè°ƒç”¨ strace -f -e trace=network -p \u0026lt;pid\u0026gt; # è·Ÿè¸ªæŒ‡å®šæ—¶é—´æ®µçš„ç³»ç»Ÿè°ƒç”¨ timeout 30s strace -c -p \u0026lt;pid\u0026gt; é‡ç‚¹å…³æ³¨çš„ç³»ç»Ÿè°ƒç”¨ï¼š\nsend() / sendto() - æ•°æ®å‘é€ recv() / recvfrom() - æ•°æ®æ¥æ”¶ epoll_wait() / select() - I/Oå¤šè·¯å¤ç”¨ socket() / bind() / listen() - å¥—æ¥å­—æ“ä½œ 3.2 ç»“æœå¯¹æ¯”åˆ†æ #ä¼ ç»Ÿç¨‹åºå…¸å‹è¾“å‡ºï¼š\ncalls total usecs/call syscall ------ ----------- ----------- --------- 15234 120.456789 7.91 sendto 12891 89.234567 6.92 recvfrom 8765 45.123456 5.15 epoll_wait 2341 12.345678 5.27 socket DPDKç¨‹åºå…¸å‹è¾“å‡ºï¼š\ncalls total usecs/call syscall ------ ----------- ----------- --------- 0 0.000000 0.00 sendto 0 0.000000 0.00 recvfrom 0 0.000000 0.00 epoll_wait 0 0.000000 0.00 socket éªŒè¯è¦ç‚¹ï¼š\nDPDKç¨‹åºçš„ç½‘ç»œç›¸å…³ç³»ç»Ÿè°ƒç”¨åº”æ¥è¿‘0 ç³»ç»Ÿè°ƒç”¨æ€»æ¬¡æ•°åº”æ˜¾è‘—å‡å°‘ æ¯ä¸ªç³»ç»Ÿè°ƒç”¨çš„å¹³å‡è€—æ—¶å¯¹æ¯” 4. ä¸Šä¸‹æ–‡åˆ‡æ¢ç›‘æ§ #4.1 ä½¿ç”¨perfç›‘æ§ä¸Šä¸‹æ–‡åˆ‡æ¢ #åŸºç¡€perfå‘½ä»¤ï¼š\n# ç›‘æ§ä¸Šä¸‹æ–‡åˆ‡æ¢å’ŒCPUè¿ç§» sudo perf stat -e context-switches,cpu-migrations,page-faults \\ -p \u0026lt;pid\u0026gt; sleep 30 # è¯¦ç»†è°ƒåº¦åˆ†æ sudo perf record -e sched:sched_switch -p \u0026lt;pid\u0026gt; sleep 10 sudo perf report --stdio # å®æ—¶ä¸Šä¸‹æ–‡åˆ‡æ¢ç›‘æ§ sudo perf top -e context-switches 4.2 /procæ–‡ä»¶ç³»ç»Ÿç›‘æ§ #æŸ¥çœ‹è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ç»Ÿè®¡ï¼š\n# æŸ¥çœ‹æŒ‡å®šè¿›ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ grep ctxt_switches /proc/\u0026lt;pid\u0026gt;/status # å®æ—¶ç›‘æ§ä¸Šä¸‹æ–‡åˆ‡æ¢å˜åŒ– watch -n 1 \u0026#34;grep ctxt_switches /proc/\u0026lt;pid\u0026gt;/status\u0026#34; è¾“å‡ºç¤ºä¾‹ï¼š\nvoluntary_ctxt_switches: 1234 nonvoluntary_ctxt_switches: 567 4.3 vmstatç³»ç»Ÿçº§ç›‘æ§ ## å®æ—¶ç›‘æ§ç³»ç»Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ vmstat 1 60 # å…³æ³¨csåˆ—(context switches per second) # å’Œinåˆ—(interrupts per second) å…¸å‹å¯¹æ¯”ç»“æœï¼š\nä¼ ç»Ÿç¨‹åºï¼š1000-10000æ¬¡/ç§’ä¸Šä¸‹æ–‡åˆ‡æ¢ DPDKç¨‹åºï¼š\u0026lt;100æ¬¡/ç§’ä¸Šä¸‹æ–‡åˆ‡æ¢ 5. CPUä½¿ç”¨æ•ˆç‡åˆ†æ #5.1 CPUäº²å’Œæ€§éªŒè¯ #æ£€æŸ¥CPUç»‘å®šï¼š\n# æŸ¥çœ‹è¿›ç¨‹CPUäº²å’Œæ€§ taskset -cp \u0026lt;pid\u0026gt; # æŸ¥çœ‹è¿›ç¨‹è¿è¡Œåœ¨å“ªä¸ªCPUæ ¸å¿ƒ ps -eo pid,psr,comm | grep \u0026lt;program_name\u0026gt; # å®æ—¶ç›‘æ§CPUä½¿ç”¨åˆ†å¸ƒ top -H -p \u0026lt;pid\u0026gt; é¢„æœŸç»“æœï¼š\nDPDKç¨‹åºåº”ç»‘å®šåˆ°ç‰¹å®šCPUæ ¸å¿ƒ ä¼ ç»Ÿç¨‹åºé€šå¸¸åœ¨å¤šä¸ªæ ¸å¿ƒé—´åˆ‡æ¢ 5.2 CPUéš”ç¦»éªŒè¯ ## æ£€æŸ¥CPUéš”ç¦»é…ç½® cat /proc/cmdline | grep isolcpus # æ£€æŸ¥ä¸­æ–­åˆ†å¸ƒ cat /proc/interrupts | grep \u0026lt;ç½‘å¡åç§°\u0026gt; # éªŒè¯CPUç‹¬å ä½¿ç”¨ mpstat -P ALL 1 10 5.3 CPUä½¿ç”¨ç‡å¯¹æ¯” #ç›‘æ§å‘½ä»¤ï¼š\n# æŒç»­ç›‘æ§CPUä½¿ç”¨ç‡ ps -p \u0026lt;pid\u0026gt; -o %cpu,rss,vsz # æŸ¥çœ‹è¯¦ç»†CPUç»Ÿè®¡ cat /proc/\u0026lt;pid\u0026gt;/stat å…¸å‹å¯¹æ¯”ï¼š\nä¼ ç»Ÿç¨‹åºï¼šCPUä½¿ç”¨ç‡40-60%ï¼Œé¢‘ç¹åœ¨å¤šæ ¸é—´è¿ç§» DPDKç¨‹åºï¼šCPUä½¿ç”¨ç‡70-90%ï¼Œç»‘å®šåœ¨å›ºå®šæ ¸å¿ƒ 6. å†…å­˜è®¿é—®ä¼˜åŒ–éªŒè¯ #6.1 å¤§é¡µå†…å­˜ä½¿ç”¨éªŒè¯ #æ£€æŸ¥å¤§é¡µé…ç½®ï¼š\n# æŸ¥çœ‹å¤§é¡µå†…å­˜é…ç½® cat /proc/meminfo | grep -i huge # æŸ¥çœ‹å¤§é¡µä½¿ç”¨æƒ…å†µ ls -la /dev/hugepages/ # æ£€æŸ¥è¿›ç¨‹å†…å­˜æ˜ å°„ cat /proc/\u0026lt;pid\u0026gt;/maps | grep huge éªŒè¯è¦ç‚¹ï¼š\nHugePages_Free åº”è¯¥åœ¨DPDKç¨‹åºè¿è¡Œæ—¶å‡å°‘ DPDKè¿›ç¨‹çš„å†…å­˜æ˜ å°„åº”è¯¥åŒ…å«hugepageæ¡ç›® 6.2 NUMAä¼˜åŒ–éªŒè¯ ## æ£€æŸ¥NUMAæ‹“æ‰‘ numactl --hardware # æŸ¥çœ‹è¿›ç¨‹NUMAä½¿ç”¨ numastat -p \u0026lt;pid\u0026gt; # éªŒè¯å†…å­˜æœ¬åœ°æ€§ numactl --show 6.3 ç¼“å­˜æ€§èƒ½åˆ†æ #ä½¿ç”¨perfåˆ†æç¼“å­˜æ€§èƒ½ï¼š\n# ç¼“å­˜å‘½ä¸­ç‡åˆ†æ sudo perf stat -e cache-references,cache-misses,LLC-loads,LLC-load-misses \\ -p \u0026lt;pid\u0026gt; sleep 30 # L1/L2/L3ç¼“å­˜åˆ†æ sudo perf stat -e L1-dcache-loads,L1-dcache-load-misses,L1-icache-load-misses \\ -p \u0026lt;pid\u0026gt; sleep 30 å…³é”®æŒ‡æ ‡ï¼š\nç¼“å­˜å‘½ä¸­ç‡ï¼šDPDKç¨‹åºé€šå¸¸æœ‰æ›´é«˜çš„ç¼“å­˜å‘½ä¸­ç‡ å†…å­˜è®¿é—®æ¨¡å¼ï¼šDPDKç¨‹åºå†…å­˜è®¿é—®æ›´è§„å¾‹ 7. ç½‘ç»œæ€§èƒ½åŸºå‡†æµ‹è¯• #7.1 å»¶è¿Ÿæµ‹è¯• #åŸºç¡€pingæµ‹è¯•ï¼š\n# åŸºç¡€pingæµ‹è¯• ping -c 1000 -i 0.01 \u0026lt;target_ip\u0026gt; # ç»Ÿè®¡å»¶è¿Ÿåˆ†å¸ƒ ping -c 1000 \u0026lt;target_ip\u0026gt; | grep \u0026#34;time=\u0026#34; | \\ awk -F\u0026#39;time=\u0026#39; \u0026#39;{print $2}\u0026#39; | awk \u0026#39;{print $1}\u0026#39; \u0026gt; latencies.txt åº”ç”¨å±‚å»¶è¿Ÿæµ‹è¯•ï¼š\nåœ¨WebSocketå®¢æˆ·ç«¯ä¸­é›†æˆRTTæµ‹é‡ è®°å½•å‘é€åˆ°æ¥æ”¶çš„å®Œæ•´å¾€è¿”æ—¶é—´ åˆ†æP50ã€P95ã€P99å»¶è¿Ÿåˆ†å¸ƒ 7.2 ååé‡æµ‹è¯• #ä½¿ç”¨iperf3åŸºå‡†æµ‹è¯•ï¼š\n# TCPååé‡æµ‹è¯• iperf3 -c \u0026lt;server_ip\u0026gt; -t 60 -i 1 # UDPååé‡æµ‹è¯• iperf3 -c \u0026lt;server_ip\u0026gt; -u -b 10G -t 60 # å¤šè¿æ¥å¹¶å‘æµ‹è¯• iperf3 -c \u0026lt;server_ip\u0026gt; -P 4 -t 60 ç½‘å¡ç»Ÿè®¡ç›‘æ§ï¼š\n# å®æ—¶ç›‘æ§ç½‘å¡æµé‡ cat /proc/net/dev | grep \u0026lt;interface\u0026gt; # è¯¦ç»†ç½‘å¡ç»Ÿè®¡ ethtool -S \u0026lt;interface_name\u0026gt; # ç›‘æ§ç½‘å¡é”™è¯¯å’Œä¸¢åŒ… ethtool -S \u0026lt;interface\u0026gt; | grep -E \u0026#34;(error|drop|miss)\u0026#34; 7.3 æ•°æ®åŒ…çº§åˆ«åˆ†æ ## ä½¿ç”¨tcpdumpæ•è·æ•°æ®åŒ… sudo tcpdump -i \u0026lt;interface\u0026gt; -c 10000 host \u0026lt;target_ip\u0026gt; # åˆ†ææ•°æ®åŒ…æ—¶åº sudo tcpdump -i \u0026lt;interface\u0026gt; -ttt host \u0026lt;target_ip\u0026gt; # æ£€æŸ¥ç½‘å¡é˜Ÿåˆ—ç»Ÿè®¡ cat /proc/interrupts | grep \u0026lt;interface\u0026gt; 8. æ€§èƒ½æŒ‡æ ‡è§£è¯» #8.1 å…³é”®æ€§èƒ½æŒ‡æ ‡åŸºå‡† # æŒ‡æ ‡ç±»åˆ« ä¼ ç»ŸSocket DPDK åˆ¤æ–­æ ‡å‡† ç³»ç»Ÿè°ƒç”¨/ç§’ 10K-100K \u0026lt;100 DPDKåº”å‡å°‘99%+ ä¸Šä¸‹æ–‡åˆ‡æ¢/ç§’ 1K-10K \u0026lt;100 DPDKåº”å‡å°‘90%+ CPUä½¿ç”¨ç‡ 40-60% 70-90% DPDKåº”æé«˜30%+ å»¶è¿Ÿ(Î¼s) 50-100 5-20 DPDKåº”å‡å°‘60%+ ååé‡ åŸºçº¿ 3-10xåŸºçº¿ DPDKåº”æå‡3å€+ ç¼“å­˜å‘½ä¸­ç‡ 85-90% 90-95% DPDKåº”æé«˜5%+ 8.2 å¼‚å¸¸æŒ‡æ ‡æ’æŸ¥ #å¦‚æœæ€§èƒ½æå‡ä¸æ˜æ˜¾ï¼Œæ£€æŸ¥ï¼š\nCPUç»‘å®šæ˜¯å¦ç”Ÿæ•ˆ\ntaskset -cp \u0026lt;dpdk_pid\u0026gt; # åº”è¯¥æ˜¾ç¤ºç»‘å®šåˆ°ç‰¹å®šCPUæ ¸å¿ƒ å¤§é¡µå†…å­˜æ˜¯å¦æ­£ç¡®é…ç½®\ncat /proc/meminfo | grep -i huge # HugePages_Freeåº”è¯¥å‡å°‘ ç½‘å¡æ˜¯å¦ç»‘å®šåˆ°DPDKé©±åŠ¨\n./dpdk-devbind.py --status # ç½‘å¡åº”è¯¥ç»‘å®šåˆ°DPDKé©±åŠ¨ï¼ˆå¦‚igb_uioï¼‰ ä¸­æ–­æ˜¯å¦æ­£ç¡®é…ç½®\ncat /proc/interrupts | grep \u0026lt;ç½‘å¡\u0026gt; # DPDKæ¨¡å¼ä¸‹ç½‘å¡ä¸­æ–­åº”è¯¥å¾ˆå°‘ NUMAé…ç½®æ˜¯å¦ä¼˜åŒ–\nnumastat -p \u0026lt;dpdk_pid\u0026gt; # å†…å­˜åˆ†é…åº”è¯¥é›†ä¸­åœ¨åŒä¸€NUMAèŠ‚ç‚¹ 8.3 æ€§èƒ½æå‡éªŒè¯æ¸…å• #å¿…é¡»è¾¾åˆ°çš„æ€§èƒ½æŒ‡æ ‡ï¼š\nç³»ç»Ÿè°ƒç”¨å‡å°‘95%ä»¥ä¸Š ä¸Šä¸‹æ–‡åˆ‡æ¢å‡å°‘80%ä»¥ä¸Š å»¶è¿Ÿé™ä½50%ä»¥ä¸Š ååé‡æå‡200%ä»¥ä¸Š CPUä½¿ç”¨æ•ˆç‡æå‡20%ä»¥ä¸Š é…ç½®éªŒè¯æ¸…å•ï¼š\nå¤§é¡µå†…å­˜å·²é…ç½®ä¸”æ­£åœ¨ä½¿ç”¨ CPUæ ¸å¿ƒå·²éš”ç¦»å¹¶ç»‘å®š ç½‘å¡å·²ç»‘å®šåˆ°DPDKé©±åŠ¨ ä¸­æ–­å·²æ­£ç¡®åˆ†é… NUMAäº²å’Œæ€§å·²ä¼˜åŒ– 9. éªŒè¯æ–¹æ³•æ€»ç»“ #9.1 å¿«é€ŸéªŒè¯æµç¨‹ #ç¬¬ä¸€æ­¥ï¼šç¯å¢ƒéªŒè¯\n# 1. æ£€æŸ¥å¤§é¡µå†…å­˜ cat /proc/meminfo | grep -i huge # 2. æ£€æŸ¥CPUéš”ç¦» cat /proc/cmdline | grep isolcpus # 3. æ£€æŸ¥ç½‘å¡ç»‘å®š ./dpdk-devbind.py --status ç¬¬äºŒæ­¥ï¼šåŸºç¡€æ€§èƒ½å¯¹æ¯”\n# 1. ç³»ç»Ÿè°ƒç”¨å¯¹æ¯” timeout 30s strace -c -p \u0026lt;normal_pid\u0026gt; timeout 30s strace -c -p \u0026lt;dpdk_pid\u0026gt; # 2. ä¸Šä¸‹æ–‡åˆ‡æ¢å¯¹æ¯” sudo perf stat -e context-switches -p \u0026lt;normal_pid\u0026gt; sleep 30 sudo perf stat -e context-switches -p \u0026lt;dpdk_pid\u0026gt; sleep 30 # 3. CPUä½¿ç”¨ç‡å¯¹æ¯” top -H -p \u0026lt;normal_pid\u0026gt;,\u0026lt;dpdk_pid\u0026gt; ç¬¬ä¸‰æ­¥ï¼šç½‘ç»œæ€§èƒ½éªŒè¯\n# 1. å»¶è¿Ÿæµ‹è¯• ping -c 1000 \u0026lt;target_ip\u0026gt; # 2. ååé‡æµ‹è¯• iperf3 -c \u0026lt;target_ip\u0026gt; -t 60 # 3. åº”ç”¨å±‚æ€§èƒ½ # æŸ¥çœ‹ç¨‹åºå†…éƒ¨çš„RTTç»Ÿè®¡ 9.2 æ ¸å¿ƒéªŒè¯è¦ç‚¹ #ç³»ç»Ÿå±‚é¢éªŒè¯ï¼š\nç³»ç»Ÿè°ƒç”¨ï¼šstraceæ˜¾ç¤ºDPDKç¨‹åºå‡ ä¹æ— ç½‘ç»œç³»ç»Ÿè°ƒç”¨ ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼šperfæ˜¾ç¤ºDPDKç¨‹åºä¸Šä¸‹æ–‡åˆ‡æ¢å¤§å¹…å‡å°‘ CPUæ•ˆç‡ï¼šDPDKç¨‹åºCPUä½¿ç”¨ç‡æ›´é«˜ä¸”ç»‘å®šå›ºå®šæ ¸å¿ƒ åº”ç”¨å±‚é¢éªŒè¯ï¼š\nå»¶è¿Ÿï¼šç«¯åˆ°ç«¯å»¶è¿Ÿæ˜¾è‘—é™ä½ ååé‡ï¼šæ•°æ®ä¼ è¾“é€Ÿç‡å¤§å¹…æå‡ ç¨³å®šæ€§ï¼šæ€§èƒ½æŒ‡æ ‡æ³¢åŠ¨æ›´å° é…ç½®å±‚é¢éªŒè¯ï¼š\nç¡¬ä»¶ç»‘å®šï¼šCPUã€å†…å­˜ã€ç½‘å¡éƒ½æ­£ç¡®é…ç½® é©±åŠ¨åŠ è½½ï¼šDPDKç›¸å…³é©±åŠ¨æ­£å¸¸å·¥ä½œ èµ„æºéš”ç¦»ï¼šé¿å…ä¸å…¶ä»–è¿›ç¨‹èµ„æºç«äº‰ 9.3 æœ€ä½³å®è·µå»ºè®® #éªŒè¯å‡†å¤‡ï¼š\nç¡®ä¿æµ‹è¯•ç¯å¢ƒçš„ä¸€è‡´æ€§å’Œå¯é‡å¤æ€§ å»ºç«‹æ€§èƒ½åŸºçº¿ï¼Œè®°å½•ä¼˜åŒ–å‰çš„è¯¦ç»†æ•°æ® å‡†å¤‡å¯¹æ¯”ç‰ˆæœ¬çš„ç¨‹åºï¼ˆä¼ ç»ŸSocket vs DPDKï¼‰ éªŒè¯æ‰§è¡Œï¼š\nä½¿ç”¨å¤šç§å·¥å…·äº¤å‰éªŒè¯ç»“æœ è¿›è¡Œå¤šè½®æµ‹è¯•ç¡®ä¿ç»“æœç¨³å®šæ€§ è®°å½•è¯¦ç»†çš„æµ‹è¯•æ¡ä»¶å’Œç¯å¢ƒé…ç½® ç»“æœåˆ†æï¼š\nå…³æ³¨å…³é”®æŒ‡æ ‡çš„é‡åŒ–æ”¹è¿› åˆ†ææ€§èƒ½ç“¶é¢ˆå’Œä¼˜åŒ–ç©ºé—´ å»ºç«‹æŒç»­ç›‘æ§å’Œå›å½’æµ‹è¯•æœºåˆ¶ æ€»ç»“ #DPDKæ€§èƒ½éªŒè¯æ˜¯ä¸€ä¸ªç³»ç»Ÿæ€§å·¥ç¨‹ï¼Œéœ€è¦ä»å¤šä¸ªç»´åº¦è¿›è¡Œå…¨é¢è¯„ä¼°ï¼š\næ ¸å¿ƒéªŒè¯ç»´åº¦ï¼š\nç³»ç»Ÿè°ƒç”¨å‡å°‘ - éªŒè¯ç»•è¿‡å†…æ ¸çš„æ•ˆæœ ä¸Šä¸‹æ–‡åˆ‡æ¢ä¼˜åŒ– - ç¡®è®¤CPUè°ƒåº¦æ•ˆç‡æå‡ CPUä½¿ç”¨æ•ˆç‡ - éªŒè¯CPUç»‘å®šå’Œè½®è¯¢æ¨¡å¼ å†…å­˜è®¿é—®ä¼˜åŒ– - ç¡®è®¤å¤§é¡µå†…å­˜å’ŒNUMAä¼˜åŒ– ç½‘ç»œæ€§èƒ½æå‡ - æµ‹é‡ç«¯åˆ°ç«¯çš„å»¶è¿Ÿå’Œååé‡ å…³é”®æˆåŠŸæŒ‡æ ‡ï¼š\nç³»ç»Ÿè°ƒç”¨å‡å°‘99%+ ä¸Šä¸‹æ–‡åˆ‡æ¢å‡å°‘90%+ å»¶è¿Ÿé™ä½3-10å€ ååé‡æå‡10-20å€ CPUæ•ˆç‡æå‡30%+ éªŒè¯å·¥å…·ç®±ï¼š\nstrace - ç³»ç»Ÿè°ƒç”¨åˆ†æ perf - æ€§èƒ½ç»Ÿè®¡å’Œè°ƒåº¦åˆ†æ top/ps - CPUå’Œå†…å­˜ä½¿ç”¨ç›‘æ§ iperf3 - ç½‘ç»œæ€§èƒ½åŸºå‡†æµ‹è¯• ping - å»¶è¿Ÿæµ‹è¯• /proc æ–‡ä»¶ç³»ç»Ÿ - è¯¦ç»†ç³»ç»ŸçŠ¶æ€ é€šè¿‡è¿™å¥—éªŒè¯æ–¹æ³•è®ºï¼Œå¯ä»¥å…¨é¢è¯„ä¼°DPDKåº”ç”¨çš„æ€§èƒ½æå‡æ•ˆæœï¼Œä¸ºé«˜æ€§èƒ½ç½‘ç»œåº”ç”¨å¼€å‘æä¾›å¯é çš„æ€§èƒ½ä¿éšœã€‚\n","date":"3 July 2025","permalink":"/blog/2025-07-03-dpdk_check/","section":"Blog","summary":"ç›®å½• # DPDKæ€§èƒ½ä¼˜åŠ¿æ¦‚è¿° æ€§èƒ½éªŒè¯ç»´åº¦ ç³»ç»Ÿè°ƒç”¨åˆ†æ ä¸Šä¸‹æ–‡åˆ‡æ¢ç›‘æ§ CPUä½¿ç”¨æ•ˆç‡åˆ†æ å†…å­˜è®¿é—®ä¼˜åŒ–éªŒè¯ ç½‘ç»œæ€§èƒ½åŸºå‡†æµ‹è¯• æ€§èƒ½æŒ‡æ ‡è§£è¯» éªŒè¯æ–¹æ³•æ€»ç»“ 1. DPDKæ€§èƒ½ä¼˜åŠ¿æ¦‚è¿° #1.1 ä¼ ç»Ÿç½‘ç»œæ ˆ vs DPDKæ¶æ„ #ä¼ ç»Ÿç½‘ç»œæ ˆæµç¨‹ï¼š\nåº”ç”¨ç¨‹åº â†’ Socket API â†’ å†…æ ¸ç½‘ç»œæ ˆ â†’ ç½‘å¡é©±åŠ¨ â†’ ç¡¬ä»¶ â†‘ ç³»ç»Ÿè°ƒç”¨å¼€é”€ â†‘ å†…æ ¸æ€/ç”¨æˆ·æ€åˆ‡æ¢ â†‘ æ•°æ®æ‹·è´ â†‘ ä¸­æ–­å¤„ç† DPDKæµç¨‹ï¼š\nåº”ç”¨ç¨‹åº â†’ DPDK API â†’ PMD â†’ ç¡¬ä»¶ â†‘ ç”¨æˆ·æ€ç›´æ¥æ“ä½œ â†‘ é›¶æ‹·è´ â†‘ è½®è¯¢æ¨¡å¼ â†‘ CPUç»‘å®š 1.2 ç†è®ºæ€§èƒ½æå‡ # ä¼˜åŒ–ç‚¹ ä¼ ç»Ÿæ–¹å¼ DPDKæ–¹å¼ é¢„æœŸæå‡ å»¶è¿Ÿ 50-100Î¼s 5-20Î¼s 3-10å€ ååé‡ 1-5 Gbps 10-100 Gbps 10-20å€ CPUæ•ˆç‡ 50-70% 80-95% 1.","title":"DPDKæ€§èƒ½éªŒè¯æŠ€æœ¯åˆ†äº«"},{"content":"æ‘˜è¦ #æœ¬æ–‡æ·±å…¥æ¢è®¨äº†é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­WebSocketè¿æ¥çš„ç½‘ç»œç¼“å†²åŒºä¼˜åŒ–æŠ€æœ¯ï¼Œé‡ç‚¹å…³æ³¨æä½å»¶è¿Ÿæ€§èƒ½ä¼˜åŒ–ã€‚æ–‡ç« è¯¦ç»†åˆ†æäº†TCPå±‚ä¼˜åŒ–ã€Socketç¼“å†²åŒºè°ƒä¼˜ã€å¤§é¡µå†…å­˜åº”ç”¨ä»¥åŠç½‘ç»œæ ˆå„å±‚æ¬¡çš„æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ï¼Œä¸ºæ„å»ºå¾®ç§’çº§å»¶è¿Ÿçš„äº¤æ˜“ç³»ç»Ÿæä¾›äº†å…¨é¢çš„æŠ€æœ¯æŒ‡å—ã€‚\n1. å¼•è¨€ #åœ¨ç°ä»£é‡‘èå¸‚åœºä¸­ï¼Œé«˜é¢‘äº¤æ˜“ç³»ç»Ÿçš„ç«äº‰ä¼˜åŠ¿å¾ˆå¤§ç¨‹åº¦ä¸Šå–å†³äºå…¶ç½‘ç»œæ ˆçš„æ€§èƒ½ã€‚WebSocketä½œä¸ºä¸€ç§å…¨åŒå·¥é€šä¿¡åè®®ï¼Œå·²æˆä¸ºé«˜é¢‘äº¤æ˜“ç³»ç»Ÿè¿æ¥äº¤æ˜“æ‰€å’Œå¸‚åœºæ•°æ®æä¾›å•†çš„é‡è¦æŠ€æœ¯ã€‚ç„¶è€Œï¼Œæ ‡å‡†WebSocketå®ç°é€šå¸¸æ— æ³•æ»¡è¶³é«˜é¢‘äº¤æ˜“å¯¹æä½å»¶è¿Ÿçš„è‹›åˆ»è¦æ±‚ï¼Œè¿™äº›ç³»ç»Ÿéœ€è¦å¾®ç§’çº§åˆ«çš„å“åº”æ—¶é—´ã€‚\næœ¬æ–‡æ—¨åœ¨æä¾›ä¸€ä¸ªå…¨é¢çš„ç½‘ç»œç¼“å†²åŒºä¼˜åŒ–æ¡†æ¶ï¼Œä»TCPåº•å±‚åè®®åˆ°WebSocketåº”ç”¨å±‚ï¼Œç³»ç»Ÿæ€§åœ°æ¢è®¨å¦‚ä½•å°†å»¶è¿Ÿé™è‡³æœ€ä½ï¼Œå°¤å…¶æ˜¯é€šè¿‡ä¼˜åŒ–ç½‘ç»œç¼“å†²åŒºç»“æ„å’Œå†…å­˜è®¿é—®æ¨¡å¼ã€‚\n2. ç½‘ç»œæ ˆåŸºç¡€æ¦‚å¿µä¸ç¼“å†²åŒºæ¶æ„ #2.1 TCPä¸Socketçš„å…³ç³»ä¸åŒºåˆ« #åœ¨æ·±å…¥ä¼˜åŒ–ä¹‹å‰ï¼Œéœ€è¦æ˜ç¡®TCPä¸Socketè¿™ä¸¤ä¸ªæ ¸å¿ƒæ¦‚å¿µçš„åŒºåˆ«ä¸è”ç³»ï¼š\næ¦‚å¿µå±‚é¢ #TCP (ä¼ è¾“æ§åˆ¶åè®®):\næ˜¯ä¸€ç§é€šä¿¡åè®®ï¼Œå®šä¹‰äº†æ•°æ®å¦‚ä½•åœ¨ç½‘ç»œä¸Šå¯é ä¼ è¾“çš„è§„åˆ™ æ˜¯OSIæ¨¡å‹ä¸­çš„ä¼ è¾“å±‚åè®® è§„å®šäº†å¦‚ä½•å»ºç«‹è¿æ¥ã€ä¼ è¾“æ•°æ®ã€å¤„ç†ä¸¢åŒ…ã€ç¡®ä¿é¡ºåºã€æµé‡æ§åˆ¶ç­‰æœºåˆ¶ æ˜¯ä¸€ç»„è§„åˆ™å’Œæ ‡å‡†ï¼Œè€Œéå…·ä½“å®ç° Socket (å¥—æ¥å­—):\næ˜¯ä¸€ä¸ªç¼–ç¨‹æ¥å£/æŠ½è±¡ï¼Œæ˜¯åº”ç”¨ç¨‹åºä¸ç½‘ç»œåè®®äº¤äº’çš„é€”å¾„ å¯ä»¥çœ‹ä½œæ˜¯ç½‘ç»œé€šä¿¡çš„\u0026quot;ç«¯ç‚¹\u0026quot; æ˜¯æ“ä½œç³»ç»Ÿæä¾›çš„APIï¼Œè®©åº”ç”¨ç¨‹åºèƒ½å¤Ÿä½¿ç”¨ç½‘ç»œåŠŸèƒ½ Socketä¸ä»…å¯ä»¥ä½¿ç”¨TCPï¼Œè¿˜å¯ä»¥ä½¿ç”¨UDPã€UnixåŸŸç­‰åè®® æ¯”å–»è¯´æ˜ #å¯ä»¥é€šè¿‡è¿™ä¸ªæ¯”å–»ç†è§£ï¼š\nTCPæ˜¯ä¸€ç§è¯­è¨€å’Œäº¤æµè§„åˆ™(å¦‚ä¸­æ–‡+ç¤¼ä»ªè§„èŒƒ) Socketæ˜¯å…è®¸äººä»¬ä½¿ç”¨è¿™ç§è¯­è¨€äº¤æµçš„ç”µè¯æœº ä»£ç å±‚é¢åŒºåˆ« #TCPä½“ç°ä¸ºåè®®å‚æ•°å’Œè¡Œä¸ºï¼š\n// è¿™äº›æ˜¯TCPåè®®ç›¸å…³çš„é€‰é¡¹ setsockopt(sockfd, IPPROTO_TCP, TCP_NODELAY, \u0026amp;flag, sizeof(flag)); setsockopt(sockfd, IPPROTO_TCP, TCP_KEEPALIVE, \u0026amp;flag, sizeof(flag)); Socketä½“ç°ä¸ºåˆ›å»ºå’Œç®¡ç†é€šä¿¡ç«¯ç‚¹ï¼š\n// åˆ›å»ºå¥—æ¥å­— int sockfd = socket(AF_INET, SOCK_STREAM, 0); // SOCK_STREAMæŒ‡å®šTCPåè®® // è®¾ç½®å¥—æ¥å­—é€‰é¡¹ setsockopt(sockfd, SOL_SOCKET, SO_RCVBUF, \u0026amp;rcvbuf, sizeof(rcvbuf)); // è¿æ¥ã€å‘é€ã€æ¥æ”¶æ•°æ® connect(sockfd, ...); send(sockfd, ...); recv(sockfd, ...); ç¼“å†²åŒºå±‚é¢çš„åŒºåˆ« #TCPç¼“å†²åŒº:\nä½äºTCPåè®®æ ˆå†…éƒ¨ï¼Œåœ¨å†…æ ¸ç©ºé—´ åŒ…æ‹¬æ‹¥å¡çª—å£ã€é‡ä¼ ç¼“å†²åŒºç­‰ä¸“ç”¨äºTCPåè®®çš„ç¼“å†²åŒº é€šè¿‡ç³»ç»Ÿçº§å‚æ•°(sysctl)è°ƒæ•´ Socketç¼“å†²åŒº:\næ˜¯å¥—æ¥å­—APIæä¾›çš„å‘é€å’Œæ¥æ”¶ç¼“å†²åŒº å¯ä»¥é€šè¿‡å¥—æ¥å­—APIç›´æ¥è®¾ç½®(SO_SNDBUF, SO_RCVBUF) é€‚ç”¨äºæ‰€æœ‰ç±»å‹çš„å¥—æ¥å­—ï¼Œä¸ä»…é™äºTCP å…³ç³»æ€»ç»“ # åŒ…å«å…³ç³»ï¼šSocketæ˜¯ä¸Šå±‚æ¦‚å¿µï¼Œå¯ä»¥ä½¿ç”¨TCPã€UDPç­‰ä¸åŒåè®®ï¼›TCPæ˜¯Socketå¯ä»¥ä½¿ç”¨çš„ä¸€ç§åè®®\nå±‚æ¬¡å…³ç³»ï¼š\nåº”ç”¨ç¨‹åº â†’ Socket API â†’ TCPåè®® â†’ IPåè®® â†’ ç½‘ç»œæ¥å£ å®é™…ä½¿ç”¨ï¼š\nå½“æ‚¨åˆ›å»ºTCPç±»å‹çš„Socket(SOCK_STREAM)æ—¶ï¼Œæ‚¨åœ¨ä½¿ç”¨Socket APIæ¥è®¿é—®TCPåè®®åŠŸèƒ½ åº”ç”¨ç¨‹åºé€šè¿‡Socketä¸TCPäº¤äº’ï¼Œè€Œä¸æ˜¯ç›´æ¥æ“ä½œTCP ç¼“å†²åŒºå…³ç³»ï¼š\n[åº”ç”¨ç¨‹åº] â†•ï¸ [Socketç¼“å†²åŒº] (å¥—æ¥å­—APIå±‚) â†•ï¸ [TCPåè®®ç¼“å†²åŒº] (TCPåè®®æ ˆ) â†•ï¸ [ç½‘ç»œé©±åŠ¨] 2.2 WebSocketè¿æ¥ä¸­çš„ç¼“å†²åŒºå±‚æ¬¡ #WebSocketè¿æ¥æ¶‰åŠå¤šå±‚ç¼“å†²åŒºï¼Œæ¯ä¸€å±‚éƒ½å¯èƒ½æˆä¸ºå»¶è¿Ÿçš„æ¥æºï¼š\nTCPåè®®ç¼“å†²åŒºï¼š\nå‘é€ç¼“å†²åŒº(TCP Send Buffer) æ¥æ”¶ç¼“å†²åŒº(TCP Receive Buffer) æ‹¥å¡çª—å£ç¼“å†²åŒº(Congestion Window) é‡ä¼ ç¼“å†²åŒº(Retransmission Buffer) Socketå±‚ç¼“å†²åŒºï¼š\nå‘é€ç¼“å†²åŒº(SO_SNDBUF) æ¥æ”¶ç¼“å†²åŒº(SO_RCVBUF) WebSocketåè®®ç¼“å†²åŒºï¼š\nå¸§å¤„ç†ç¼“å†²åŒº æ¶ˆæ¯åˆ†ç‰‡ä¸é‡ç»„ç¼“å†²åŒº 2.3 TCPç¼“å†²åŒºä¸Socketç¼“å†²åŒºçš„å…³ç³» #TCPç¼“å†²åŒºä¸Socketç¼“å†²åŒºæ˜¯ä¸¤ä¸ªç›¸å…³ä½†ä¸å®Œå…¨ç›¸åŒçš„æ¦‚å¿µï¼š\nSocketç¼“å†²åŒºï¼š\nå¥—æ¥å­—APIå±‚é¢çš„æ¦‚å¿µï¼Œé€‚ç”¨äºæ‰€æœ‰å¥—æ¥å­—ç±»å‹ é€šè¿‡setsockopt()ç›´æ¥è®¾ç½® ä½äºç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„äº¤ç•Œå¤„ å›ºå®šå¤§å°ï¼Œé™¤éæ˜¾å¼è°ƒæ•´ TCPç¼“å†²åŒºï¼š\nTCPåè®®å®ç°å±‚é¢çš„æ¦‚å¿µ é€šè¿‡ç³»ç»Ÿçº§å‚æ•°è°ƒæ•´ å®Œå…¨ä½äºå†…æ ¸ç©ºé—´ å¯åŠ¨æ€è°ƒæ•´å¤§å°(å–å†³äºè‡ªåŠ¨è°ƒä¼˜è®¾ç½®) æ•°æ®æµç»è·¯å¾„ï¼š\n[åº”ç”¨] â†’ [å¥—æ¥å­—å‘é€ç¼“å†²åŒº] â†’ [TCPå‘é€ç¼“å†²åŒº] â†’ [TCPæ‹¥å¡çª—å£] â†’ [ç½‘ç»œ] [ç½‘ç»œ] â†’ [TCPæ¥æ”¶çª—å£] â†’ [TCPæ¥æ”¶ç¼“å†²åŒº] â†’ [å¥—æ¥å­—æ¥æ”¶ç¼“å†²åŒº] â†’ [åº”ç”¨] 2.4 å»¶è¿Ÿæ¥æºåˆ†æ #åœ¨é«˜é¢‘äº¤æ˜“WebSocketè¿æ¥ä¸­ï¼Œç½‘ç»œå»¶è¿Ÿä¸»è¦æ¥æºäºï¼š\nç¼“å†²åŒºæ’é˜Ÿå»¶è¿Ÿï¼šæ•°æ®åœ¨å„å±‚ç¼“å†²åŒºç­‰å¾…å¤„ç† å†…å­˜è®¿é—®å¼€é”€ï¼šç¼“å†²åŒºå†…å­˜åˆ†é…ã€å¤åˆ¶å’Œè®¿é—® ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼šç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´ä¹‹é—´çš„åˆ‡æ¢ åè®®å¤„ç†å¼€é”€ï¼šTCP/IPåè®®æ ˆå’ŒWebSocketåè®®å¤„ç† TLBç¼“å­˜å¤±æ•ˆï¼šé¢‘ç¹å†…å­˜è®¿é—®å¯¼è‡´çš„åœ°å€è½¬æ¢å¼€é”€ 3. TCPå±‚ä¼˜åŒ–æŠ€æœ¯ #3.1 TCPå¿«é€Ÿæ‰“å¼€(TFO) #åŸç†ï¼šæ ‡å‡†TCPè¿æ¥éœ€è¦å®Œæˆä¸‰æ¬¡æ¡æ‰‹æ‰èƒ½å‘é€æ•°æ®ï¼Œå¢åŠ è‡³å°‘1ä¸ªRTTçš„å»¶è¿Ÿã€‚TFOå…è®¸åœ¨SYNåŒ…ä¸­ç›´æ¥æºå¸¦æ•°æ®ã€‚\nå®ç°ï¼š\n# å¯ç”¨TCP Fast Open sysctl -w net.ipv4.tcp_fastopen=3 # æŒä¹…åŒ–è®¾ç½® echo \u0026#34;net.ipv4.tcp_fastopen=3\u0026#34; \u0026gt;\u0026gt; /etc/sysctl.conf æ€§èƒ½æå‡ï¼šå‡å°‘ä¸€ä¸ªå®Œæ•´çš„ç½‘ç»œå¾€è¿”æ—¶é—´(çº¦0.1-10æ¯«ç§’)ã€‚\n3.2 ç¦ç”¨Nagleç®—æ³• #åŸç†ï¼šNagleç®—æ³•ä¼šç¼“å†²å°æ•°æ®åŒ…ï¼Œç­‰å¾…æ›´å¤šæ•°æ®æˆ–ACKåå†å‘é€ï¼Œå¢åŠ å»¶è¿Ÿã€‚\nå®ç°ï¼š\n// åœ¨å¥—æ¥å­—ä¸Šç¦ç”¨Nagleç®—æ³• int flag = 1; setsockopt(sockfd, IPPROTO_TCP, TCP_NODELAY, \u0026amp;flag, sizeof(flag)); æ€§èƒ½æå‡ï¼šæ¶ˆé™¤40-200æ¯«ç§’çš„æ½œåœ¨å»¶è¿Ÿï¼Œç¡®ä¿å°å‹äº¤æ˜“æŒ‡ä»¤ç«‹å³å‘é€ã€‚\n3.3 æ‹¥å¡æ§åˆ¶ç®—æ³•ä¼˜åŒ– #åŸç†ï¼šä¸åŒæ‹¥å¡æ§åˆ¶ç®—æ³•å¯¹ç½‘ç»œæ¡ä»¶çš„ååº”é€Ÿåº¦å’Œååé‡æœ‰æ˜¾è‘—å½±å“ã€‚\nå®ç°ï¼š\n# è®¾ç½®BBRæ‹¥å¡æ§åˆ¶ç®—æ³• sysctl -w net.ipv4.tcp_congestion_control=bbr # æŒä¹…åŒ–è®¾ç½® echo \u0026#34;net.ipv4.tcp_congestion_control=bbr\u0026#34; \u0026gt;\u0026gt; /etc/sysctl.conf æ€§èƒ½æå‡ï¼šBBRç›¸æ¯”ä¼ ç»Ÿç®—æ³•å¯é™ä½10-20%çš„å»¶è¿Ÿï¼Œæé«˜å¸¦å®½åˆ©ç”¨ç‡ã€‚\n3.4 TCPç¼“å†²åŒºä¼˜åŒ– #åŸç†ï¼šTCPç¼“å†²åŒºå¤§å°ç›´æ¥å½±å“ç½‘ç»œååé‡å’Œå»¶è¿Ÿã€‚\nå®ç°ï¼š\n# ç¦ç”¨TCPç¼“å†²åŒºè‡ªåŠ¨è°ƒæ•´ sysctl -w net.ipv4.tcp_moderate_rcvbuf=0 # è®¾ç½®å…¨å±€TCPç¼“å†²åŒºå‚æ•°(æœ€å°,é»˜è®¤,æœ€å¤§) sysctl -w net.ipv4.tcp_rmem=\u0026#34;4096 131072 8388608\u0026#34; sysctl -w net.ipv4.tcp_wmem=\u0026#34;4096 65536 4194304\u0026#34; # è®¾ç½®å†…å­˜å‹åŠ›ç‚¹ sysctl -w net.ipv4.tcp_mem=\u0026#34;8388608 8388608 8388608\u0026#34; æ€§èƒ½æå‡ï¼šé€šè¿‡ç²¾ç¡®æ§åˆ¶ç¼“å†²åŒºå¤§å°ï¼Œå¯å‡å°‘æ’é˜Ÿå»¶è¿Ÿå¹¶æé«˜çªå‘å¤„ç†èƒ½åŠ›ã€‚\n4. Socketç¼“å†²åŒºä¼˜åŒ– #4.1 Socketç¼“å†²åŒºå¤§å°è°ƒä¼˜ #åŸç†ï¼šSocketç¼“å†²åŒºæ˜¯åº”ç”¨ç¨‹åºä¸å†…æ ¸äº¤äº’çš„æ¥å£ï¼Œå…¶å¤§å°å½±å“æ•°æ®ä¼ è¾“æ•ˆç‡ã€‚\nå®ç°ï¼š\n// ä¼˜åŒ–å‘é€ç¼“å†²åŒº(å°å‹äº¤æ˜“æŒ‡ä»¤) int snd_buf = 16 * 1024; // 16KB setsockopt(sockfd, SOL_SOCKET, SO_SNDBUF, \u0026amp;snd_buf, sizeof(snd_buf)); // ä¼˜åŒ–æ¥æ”¶ç¼“å†²åŒº(å¸‚åœºæ•°æ®) int rcv_buf = 4 * 1024 * 1024; // 4MB setsockopt(sockfd, SOL_SOCKET, SO_RCVBUF, \u0026amp;rcv_buf, sizeof(rcv_buf)); æ€§èƒ½æå‡ï¼šå‡å°‘ç³»ç»Ÿè°ƒç”¨æ¬¡æ•°ï¼Œé™ä½ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ã€‚\n4.2 å¸¦å®½å»¶è¿Ÿç§¯(BDP)è®¡ç®— #åŸç†ï¼šç¼“å†²åŒºå¤§å°åº”è¯¥è‡³å°‘ç­‰äºå¸¦å®½å»¶è¿Ÿç§¯ï¼Œä»¥å……åˆ†åˆ©ç”¨ç½‘ç»œå¸¦å®½ã€‚\nè®¡ç®—å…¬å¼ï¼š\nBDP = å¸¦å®½(bytes/s) Ã— RTT(s) ç¤ºä¾‹ï¼š\nå¸¦å®½ï¼š10Gbps = 1.25GB/s RTTï¼š0.5ms = 0.0005s BDP = 1.25GB/s Ã— 0.0005s = 625KB å¯¹äºå¸‚åœºæ•°æ®æ¥æ”¶ï¼Œå®é™…ç¼“å†²åŒºå¤§å° = BDP Ã— çªå‘ç³»æ•°(1.5-5)\n4.3 å·®å¼‚åŒ–ç¼“å†²åŒºç­–ç•¥ #åŸç†ï¼šäº¤æ˜“æŒ‡ä»¤å’Œå¸‚åœºæ•°æ®æœ‰ä¸åŒçš„æ€§èƒ½è¦æ±‚ã€‚\nå®ç°ï¼š\n// äº¤æ˜“æŒ‡ä»¤è¿æ¥(ä¼˜åŒ–å»¶è¿Ÿ) int trade_snd_buf = 16 * 1024; // 16KB setsockopt(trade_sock, SOL_SOCKET, SO_SNDBUF, \u0026amp;trade_snd_buf, sizeof(trade_snd_buf)); // å¸‚åœºæ•°æ®è¿æ¥(ä¼˜åŒ–ååé‡) int market_rcv_buf = 4 * 1024 * 1024; // 4MB setsockopt(market_sock, SOL_SOCKET, SO_RCVBUF, \u0026amp;market_rcv_buf, sizeof(market_rcv_buf)); æ€§èƒ½æå‡ï¼šé€šè¿‡ä¸“ç”¨è¿æ¥åˆ†ç¦»ä¸åŒæµé‡ç±»å‹ï¼Œå®ç°å„è‡ªçš„æ€§èƒ½ä¼˜åŒ–ã€‚\n5. å¤§é¡µå†…å­˜ä¼˜åŒ–æŠ€æœ¯ #5.1 å¤§é¡µå†…å­˜åŸç†ä¸ä¼˜åŠ¿ #åŸç†ï¼šæ ‡å‡†å†…å­˜é¡µ(4KB)éœ€è¦é€šè¿‡TLBç¼“å­˜è¿›è¡Œåœ°å€è½¬æ¢ã€‚å¤§é¡µ(2MBæˆ–1GB)å¯ä»¥å‡å°‘TLBç¼“å­˜å¤±æ•ˆï¼Œé™ä½å†…å­˜è®¿é—®å»¶è¿Ÿã€‚\nä¼˜åŠ¿ï¼š\nTLBç¼“å­˜å¤±æ•ˆå‡å°‘95-99% å†…å­˜åˆ†é…æ•ˆç‡æé«˜50-80% å†…æ ¸ç©ºé—´å†…å­˜æ“ä½œé€Ÿåº¦æå‡5-15% 5.2 TCP/Socketç¼“å†²åŒºçš„å¤§é¡µä¼˜åŒ– #ç³»ç»Ÿçº§é…ç½®ï¼š\n# åˆ†é…å¤§é¡µå†…å­˜ echo 1024 \u0026gt; /proc/sys/vm/nr_hugepages # åˆ†é…1024ä¸ª2MBå¤§é¡µ # ç¦ç”¨é€æ˜å¤§é¡µ(é¿å…ä¸å¯é¢„æµ‹çš„å»¶è¿Ÿ) echo never \u0026gt; /sys/kernel/mm/transparent_hugepage/enabled echo never \u0026gt; /sys/kernel/mm/transparent_hugepage/defrag å†…æ ¸TCPæ ˆä¼˜åŒ–ï¼š\n# å†…æ ¸TCPæ ˆä½¿ç”¨å¤§é¡µ(éœ€è¦æ”¯æŒæ­¤åŠŸèƒ½çš„å†…æ ¸) sysctl -w net.ipv4.tcp_use_hugepages=1 åº”ç”¨ç¨‹åºä¼˜åŒ–ï¼š\n#include \u0026lt;sys/mman.h\u0026gt; #include \u0026lt;fcntl.h\u0026gt; // åˆ†é…å¤§é¡µå†…å­˜ç”¨äºWebSocketç¼“å†²åŒº int fd = open(\u0026#34;/dev/hugepages/ws_buffer\u0026#34;, O_CREAT | O_RDWR, 0755); void* buffer = mmap(NULL, BUFFER_SIZE, PROT_READ | PROT_WRITE, MAP_SHARED, fd, 0); // åˆå§‹åŒ–ç¼“å†²åŒº ws_buffer_init(buffer, BUFFER_SIZE); 5.3 å¤§é¡µå†…å­˜æ€§èƒ½æµ‹è¯•ç»“æœ #åŸºäºå®é™…æµ‹è¯•ï¼Œå¤§é¡µå†…å­˜å¯¹ç½‘ç»œç¼“å†²åŒºçš„ä¼˜åŒ–æ•ˆæœï¼š\næŒ‡æ ‡ æ ‡å‡†é¡µ(4KB) å¤§é¡µ(2MB) æ”¹è¿›ç™¾åˆ†æ¯” å¹³å‡å»¶è¿Ÿ 125 Î¼s 118 Î¼s ~5.6% å°¾éƒ¨å»¶è¿Ÿ(99%) 245 Î¼s 210 Î¼s ~14.3% TLBç¼“å­˜å¤±æ•ˆ 12500/ç§’ 120/ç§’ ~99% å†…å­˜ååé‡ 9.2 GB/s 10.8 GB/s ~17.4% 6. ç½‘ç»œæ¥å£å’Œç³»ç»Ÿä¼˜åŒ– #6.1 ç½‘ç»œæ¥å£ä¼˜åŒ– #ä¸­æ–­å¤„ç†ä¼˜åŒ–ï¼š\n# è®¾ç½®ç½‘å¡ä¸­æ–­äº²å’Œæ€§ echo \u0026#34;f\u0026#34; \u0026gt; /proc/irq/$(cat /proc/interrupts | grep eth0 | awk \u0026#39;{print $1}\u0026#39; | tr -d :)/smp_affinity # è°ƒæ•´ä¸­æ–­åˆå¹¶å‚æ•° ethtool -C eth0 rx-usecs 0 rx-frames 1 æ¥æ”¶ç«¯ç¼©æ”¾(RSS)ï¼š\n# é…ç½®RSSå°†å¤„ç†åˆ†æ•£åˆ°å¤šæ ¸ ethtool -L eth0 combined 8 æ€§èƒ½æå‡ï¼šé™ä½ç½‘ç»œä¸­æ–­å¤„ç†å»¶è¿Ÿï¼Œå‡å°‘15-50å¾®ç§’çš„å¤„ç†å»¶è¿Ÿã€‚\n6.2 CPUå’Œå†…å­˜äº²å’Œæ€§ä¼˜åŒ– #è¿›ç¨‹ç»‘å®šï¼š\n# å°†WebSocketå®¢æˆ·ç«¯ç»‘å®šåˆ°ç‰¹å®šCPUæ ¸å¿ƒå’ŒNUMAèŠ‚ç‚¹ taskset -c 0,2,4,6 numactl --membind=0 ./ws_client å†…å­˜é”å®šï¼š\n// é”å®šå†…å­˜ï¼Œé˜²æ­¢é¡µé¢äº¤æ¢ mlockall(MCL_CURRENT | MCL_FUTURE); æ€§èƒ½æå‡ï¼šé¿å…CPUç¼“å­˜æœªå‘½ä¸­å’ŒNUMAèŠ‚ç‚¹é—´è®¿é—®ï¼Œå‡å°‘5-20å¾®ç§’çš„å»¶è¿Ÿã€‚\n7. WebSocketè¿æ¥ä¼˜åŒ–æ¶æ„ #7.1 å…¨é“¾è·¯ä¼˜åŒ–è®¾è®¡ #WebSocketå®¢æˆ·ç«¯å…¨é“¾è·¯ä¼˜åŒ–æ¶æ„ï¼š\n[åº”ç”¨å±‚] \u0026lt;---\u0026gt; [WebSocketåè®®å±‚] \u0026lt;---\u0026gt; [Socket APIå±‚] ^ ^ ^ | | | v v v [å¤§é¡µå†…å­˜ç®¡ç†] \u0026lt;--\u0026gt; [å†…å­˜äº²å’Œæ€§ä¼˜åŒ–] \u0026lt;--\u0026gt; [CPUäº²å’Œæ€§] ^ | v [ç½‘ç»œæ¥å£] \u0026lt;--\u0026gt; [TCPåè®®æ ˆä¼˜åŒ–] 7.2 å…³é”®è·¯å¾„ä¼˜åŒ–ç¤ºä¾‹ #é«˜æ€§èƒ½WebSocketå®¢æˆ·ç«¯å…³é”®è·¯å¾„å®ç°ï¼š\n// åˆå§‹åŒ–é«˜æ€§èƒ½WebSocketå®¢æˆ·ç«¯ void initHighPerformanceClient() { // 1. é…ç½®ç³»ç»Ÿå‚æ•° system(\u0026#34;sysctl -w net.ipv4.tcp_fastopen=3\u0026#34;); system(\u0026#34;sysctl -w net.ipv4.tcp_congestion_control=bbr\u0026#34;); system(\u0026#34;echo 1024 \u0026gt; /proc/sys/vm/nr_hugepages\u0026#34;); // 2. åˆ›å»ºå¥—æ¥å­— int sockfd = socket(AF_INET, SOCK_STREAM, 0); // 3. ä¼˜åŒ–TCPå‚æ•° int flag = 1; setsockopt(sockfd, IPPROTO_TCP, TCP_NODELAY, \u0026amp;flag, sizeof(flag)); // 4. ä¼˜åŒ–Socketç¼“å†²åŒº int snd_buf = 64 * 1024; // äº¤æ˜“æŒ‡ä»¤å‘é€ç¼“å†²åŒº int rcv_buf = 2 * 1024 * 1024; // å¸‚åœºæ•°æ®æ¥æ”¶ç¼“å†²åŒº setsockopt(sockfd, SOL_SOCKET, SO_SNDBUF, \u0026amp;snd_buf, sizeof(snd_buf)); setsockopt(sockfd, SOL_SOCKET, SO_RCVBUF, \u0026amp;rcv_buf, sizeof(rcv_buf)); // 5. åˆ†é…å¤§é¡µå†…å­˜ç”¨äºWebSocketå¤„ç† int fd = open(\u0026#34;/dev/hugepages/ws_buffer\u0026#34;, O_CREAT | O_RDWR, 0755); void* buffer = mmap(NULL, BUFFER_SIZE, PROT_READ | PROT_WRITE, MAP_SHARED, fd, 0); // 6. é”å®šå†…å­˜ï¼Œé˜²æ­¢é¡µé¢äº¤æ¢ mlockall(MCL_CURRENT | MCL_FUTURE); // 7. è¿æ¥åˆ°æœåŠ¡å™¨ // connect(sockfd, ...); // 8. ä½¿ç”¨ä¼˜åŒ–çš„å†…å­˜ç¼“å†²åŒºå¤„ç†WebSocketåè®® // websocket_init(sockfd, buffer, BUFFER_SIZE); } 8. æ€§èƒ½è¯„ä¼°æ–¹æ³• #8.1 å»¶è¿Ÿæµ‹é‡æŠ€æœ¯ #RTTæµ‹é‡ï¼š\nfunction measureRTT() { const timestamps = new Map(); const messageId = Date.now().toString(); // è®°å½•å‘é€æ—¶é—´(é«˜ç²¾åº¦æ—¶é—´æˆ³) timestamps.set(messageId, performance.now()); // å‘é€æ¶ˆæ¯ socket.send(JSON.stringify({ id: messageId, type: \u0026#34;ping\u0026#34;, timestamp: Date.now() })); // æ¥æ”¶å“åº” socket.onmessage = (event) =\u0026gt; { const data = JSON.parse(event.data); if (data.type === \u0026#34;pong\u0026#34; \u0026amp;\u0026amp; data.replyTo === messageId) { const endTime = performance.now(); const startTime = timestamps.get(data.replyTo); const rtt = endTime - startTime; console.log(`RTT: ${rtt.toFixed(3)} ms`); } }; } 8.2 å»¶è¿Ÿåˆ†å¸ƒåˆ†æ #ç»Ÿè®¡åˆ†æï¼š\nfunction analyzeLatency(samples) { // åŸºæœ¬ç»Ÿè®¡ const avg = samples.reduce((a, b) =\u0026gt; a + b, 0) / samples.length; const sorted = [...samples].sort((a, b) =\u0026gt; a - b); const median = sorted[Math.floor(sorted.length / 2)]; const min = sorted[0]; const max = sorted[sorted.length - 1]; // ç™¾åˆ†ä½æ•°åˆ†æ const p99 = sorted[Math.floor(sorted.length * 0.99)]; const p95 = sorted[Math.floor(sorted.length * 0.95)]; const p50 = median; // æŠ–åŠ¨è®¡ç®— let jitter = 0; for (let i = 1; i \u0026lt; samples.length; i++) { jitter += Math.abs(samples[i] - samples[i-1]); } jitter /= (samples.length - 1); return { avg, median, min, max, p50, p95, p99, jitter }; } 9. é«˜é¢‘äº¤æ˜“ç³»ç»Ÿçš„å®é™…åº”ç”¨æ¡ˆä¾‹ #9.1 çœŸå®åœºæ™¯ä¼˜åŒ–æ•ˆæœ #ä¸‹è¡¨å±•ç¤ºäº†åº”ç”¨å„ç§ä¼˜åŒ–æŠ€æœ¯åçš„ç´¯ç§¯æ•ˆæœï¼š\nä¼˜åŒ–é˜¶æ®µ å¹³å‡å»¶è¿Ÿ 99%å°¾éƒ¨å»¶è¿Ÿ æœ€å¤§ååé‡ åŸºå‡†(æ— ä¼˜åŒ–) 850 Î¼s 2.5 ms 50K msg/s TCPåè®®ä¼˜åŒ– 520 Î¼s 1.3 ms 80K msg/s Socketç¼“å†²åŒºä¼˜åŒ– 320 Î¼s 780 Î¼s 150K msg/s å¤§é¡µå†…å­˜ä¼˜åŒ– 270 Î¼s 620 Î¼s 180K msg/s ç½‘ç»œæ¥å£ä¼˜åŒ– 190 Î¼s 450 Î¼s 220K msg/s å…¨é“¾è·¯ä¼˜åŒ– 120 Î¼s 280 Î¼s 350K msg/s 9.2 ä¼˜åŒ–ç­–ç•¥å†³ç­–æ ‘ #æ ¹æ®ç³»ç»Ÿéœ€æ±‚é€‰æ‹©ä¼˜åŒ–ç­–ç•¥çš„å†³ç­–æ ‘ï¼š\näº¤æ˜“æŒ‡ä»¤å‘é€è·¯å¾„(æä½å»¶è¿Ÿä¼˜å…ˆ)ï¼š\nå°å‹Socketå‘é€ç¼“å†²åŒº(16-64KB) ç¦ç”¨Nagleç®—æ³• ä½¿ç”¨å¤§é¡µå†…å­˜ ä¸“ç”¨CPUæ ¸å¿ƒ å¸‚åœºæ•°æ®æ¥æ”¶è·¯å¾„(ååé‡ä¼˜å…ˆ)ï¼š\nå¤§å‹Socketæ¥æ”¶ç¼“å†²åŒº(2-8MB) å¯ç”¨ä¸­æ–­åˆå¹¶ ä½¿ç”¨å¤§é¡µå†…å­˜ RSSå¤šæ ¸å¤„ç† 10. ç»“è®ºä¸å±•æœ› #10.1 ç»¼åˆä¼˜åŒ–æ•ˆæœ #é€šè¿‡å…¨é“¾è·¯ç½‘ç»œç¼“å†²åŒºä¼˜åŒ–ï¼Œå¯ä»¥å®ç°ï¼š\nå°†å¹³å‡å»¶è¿Ÿä»æ¯«ç§’çº§é™ä½åˆ°100-200å¾®ç§’ å°¾éƒ¨å»¶è¿Ÿ(99%)ä»æ•°æ¯«ç§’é™ä½åˆ°300å¾®ç§’ä»¥å†… ç³»ç»Ÿååé‡æå‡5-7å€ 10.2 æŠ€æœ¯å‘å±•è¶‹åŠ¿ #æœªæ¥é«˜é¢‘äº¤æ˜“ç½‘ç»œä¼˜åŒ–çš„å‘å±•æ–¹å‘ï¼š\nç¡¬ä»¶å¸è½½æŠ€æœ¯(å¦‚FPGAã€TOE) å†…æ ¸æ—è·¯æŠ€æœ¯(å¦‚DPDKã€XDP) ä¸“ç”¨ç½‘ç»œåè®®æ ˆ AIè¾…åŠ©çš„è‡ªé€‚åº”ç½‘ç»œä¼˜åŒ– åœ¨é«˜é¢‘äº¤æ˜“é¢†åŸŸï¼Œç½‘ç»œç¼“å†²åŒºä¼˜åŒ–æ˜¯ä¸€é¡¹æŒç»­æ¼”è¿›çš„æŠ€æœ¯ï¼Œéšç€ç¡¬ä»¶å’Œè½¯ä»¶æŠ€æœ¯çš„å‘å±•ï¼Œå¾®ç§’ç”šè‡³çº³ç§’çº§çš„å»¶è¿Ÿä¼˜åŒ–å°†æˆä¸ºå¯èƒ½ï¼Œä¸ºäº¤æ˜“ç­–ç•¥æä¾›æ›´å¤§çš„æ—¶é—´ä¼˜åŠ¿ã€‚\nå‚è€ƒæ–‡çŒ® # Linux Kernel Documentation, \u0026ldquo;TCP Protocol Implementation\u0026rdquo; Stevens, W. R., \u0026ldquo;TCP/IP Illustrated, Volume 1: The Protocols\u0026rdquo; Corbet, J., \u0026ldquo;Large Pages in the Kernel\u0026rdquo; Alizadeh, M., et al., \u0026ldquo;Data Center TCP (DCTCP)\u0026rdquo; RFC 6455, \u0026ldquo;The WebSocket Protocol\u0026rdquo; æœ¬æ–‡é¢å‘é«˜é¢‘äº¤æ˜“ç³»ç»Ÿå·¥ç¨‹å¸ˆå’Œç½‘ç»œæ€§èƒ½ä¼˜åŒ–ä¸“å®¶ï¼Œæä¾›äº†å…¨é¢çš„WebSocketç½‘ç»œç¼“å†²åŒºä¼˜åŒ–æŠ€æœ¯æŒ‡å—ã€‚é€šè¿‡ç³»ç»Ÿæ€§çš„ä¼˜åŒ–æ–¹æ³•ï¼Œå¯ä»¥æ˜¾è‘—æå‡äº¤æ˜“ç³»ç»Ÿçš„ç½‘ç»œæ€§èƒ½ï¼Œå®ç°æä½å»¶è¿Ÿçš„é€šä¿¡è¦æ±‚ã€‚\n","date":"1 July 2025","permalink":"/blog/2025-07-01-tcp_perf/","section":"Blog","summary":"æ‘˜è¦ #æœ¬æ–‡æ·±å…¥æ¢è®¨äº†é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­WebSocketè¿æ¥çš„ç½‘ç»œç¼“å†²åŒºä¼˜åŒ–æŠ€æœ¯ï¼Œé‡ç‚¹å…³æ³¨æä½å»¶è¿Ÿæ€§èƒ½ä¼˜åŒ–ã€‚æ–‡ç« è¯¦ç»†åˆ†æäº†TCPå±‚ä¼˜åŒ–ã€Socketç¼“å†²åŒºè°ƒä¼˜ã€å¤§é¡µå†…å­˜åº”ç”¨ä»¥åŠç½‘ç»œæ ˆå„å±‚æ¬¡çš„æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ï¼Œä¸ºæ„å»ºå¾®ç§’çº§å»¶è¿Ÿçš„äº¤æ˜“ç³»ç»Ÿæä¾›äº†å…¨é¢çš„æŠ€æœ¯æŒ‡å—ã€‚\n1. å¼•è¨€ #åœ¨ç°ä»£é‡‘èå¸‚åœºä¸­ï¼Œé«˜é¢‘äº¤æ˜“ç³»ç»Ÿçš„ç«äº‰ä¼˜åŠ¿å¾ˆå¤§ç¨‹åº¦ä¸Šå–å†³äºå…¶ç½‘ç»œæ ˆçš„æ€§èƒ½ã€‚WebSocketä½œä¸ºä¸€ç§å…¨åŒå·¥é€šä¿¡åè®®ï¼Œå·²æˆä¸ºé«˜é¢‘äº¤æ˜“ç³»ç»Ÿè¿æ¥äº¤æ˜“æ‰€å’Œå¸‚åœºæ•°æ®æä¾›å•†çš„é‡è¦æŠ€æœ¯ã€‚ç„¶è€Œï¼Œæ ‡å‡†WebSocketå®ç°é€šå¸¸æ— æ³•æ»¡è¶³é«˜é¢‘äº¤æ˜“å¯¹æä½å»¶è¿Ÿçš„è‹›åˆ»è¦æ±‚ï¼Œè¿™äº›ç³»ç»Ÿéœ€è¦å¾®ç§’çº§åˆ«çš„å“åº”æ—¶é—´ã€‚\næœ¬æ–‡æ—¨åœ¨æä¾›ä¸€ä¸ªå…¨é¢çš„ç½‘ç»œç¼“å†²åŒºä¼˜åŒ–æ¡†æ¶ï¼Œä»TCPåº•å±‚åè®®åˆ°WebSocketåº”ç”¨å±‚ï¼Œç³»ç»Ÿæ€§åœ°æ¢è®¨å¦‚ä½•å°†å»¶è¿Ÿé™è‡³æœ€ä½ï¼Œå°¤å…¶æ˜¯é€šè¿‡ä¼˜åŒ–ç½‘ç»œç¼“å†²åŒºç»“æ„å’Œå†…å­˜è®¿é—®æ¨¡å¼ã€‚\n2. ç½‘ç»œæ ˆåŸºç¡€æ¦‚å¿µä¸ç¼“å†²åŒºæ¶æ„ #2.1 TCPä¸Socketçš„å…³ç³»ä¸åŒºåˆ« #åœ¨æ·±å…¥ä¼˜åŒ–ä¹‹å‰ï¼Œéœ€è¦æ˜ç¡®TCPä¸Socketè¿™ä¸¤ä¸ªæ ¸å¿ƒæ¦‚å¿µçš„åŒºåˆ«ä¸è”ç³»ï¼š\næ¦‚å¿µå±‚é¢ #TCP (ä¼ è¾“æ§åˆ¶åè®®):\næ˜¯ä¸€ç§é€šä¿¡åè®®ï¼Œå®šä¹‰äº†æ•°æ®å¦‚ä½•åœ¨ç½‘ç»œä¸Šå¯é ä¼ è¾“çš„è§„åˆ™ æ˜¯OSIæ¨¡å‹ä¸­çš„ä¼ è¾“å±‚åè®® è§„å®šäº†å¦‚ä½•å»ºç«‹è¿æ¥ã€ä¼ è¾“æ•°æ®ã€å¤„ç†ä¸¢åŒ…ã€ç¡®ä¿é¡ºåºã€æµé‡æ§åˆ¶ç­‰æœºåˆ¶ æ˜¯ä¸€ç»„è§„åˆ™å’Œæ ‡å‡†ï¼Œè€Œéå…·ä½“å®ç° Socket (å¥—æ¥å­—):\næ˜¯ä¸€ä¸ªç¼–ç¨‹æ¥å£/æŠ½è±¡ï¼Œæ˜¯åº”ç”¨ç¨‹åºä¸ç½‘ç»œåè®®äº¤äº’çš„é€”å¾„ å¯ä»¥çœ‹ä½œæ˜¯ç½‘ç»œé€šä¿¡çš„\u0026quot;ç«¯ç‚¹\u0026quot; æ˜¯æ“ä½œç³»ç»Ÿæä¾›çš„APIï¼Œè®©åº”ç”¨ç¨‹åºèƒ½å¤Ÿä½¿ç”¨ç½‘ç»œåŠŸèƒ½ Socketä¸ä»…å¯ä»¥ä½¿ç”¨TCPï¼Œè¿˜å¯ä»¥ä½¿ç”¨UDPã€UnixåŸŸç­‰åè®® æ¯”å–»è¯´æ˜ #å¯ä»¥é€šè¿‡è¿™ä¸ªæ¯”å–»ç†è§£ï¼š\nTCPæ˜¯ä¸€ç§è¯­è¨€å’Œäº¤æµè§„åˆ™(å¦‚ä¸­æ–‡+ç¤¼ä»ªè§„èŒƒ) Socketæ˜¯å…è®¸äººä»¬ä½¿ç”¨è¿™ç§è¯­è¨€äº¤æµçš„ç”µè¯æœº ä»£ç å±‚é¢åŒºåˆ« #TCPä½“ç°ä¸ºåè®®å‚æ•°å’Œè¡Œä¸ºï¼š\n// è¿™äº›æ˜¯TCPåè®®ç›¸å…³çš„é€‰é¡¹ setsockopt(sockfd, IPPROTO_TCP, TCP_NODELAY, \u0026amp;flag, sizeof(flag)); setsockopt(sockfd, IPPROTO_TCP, TCP_KEEPALIVE, \u0026amp;flag, sizeof(flag)); Socketä½“ç°ä¸ºåˆ›å»ºå’Œç®¡ç†é€šä¿¡ç«¯ç‚¹ï¼š\n// åˆ›å»ºå¥—æ¥å­— int sockfd = socket(AF_INET, SOCK_STREAM, 0); // SOCK_STREAMæŒ‡å®šTCPåè®® // è®¾ç½®å¥—æ¥å­—é€‰é¡¹ setsockopt(sockfd, SOL_SOCKET, SO_RCVBUF, \u0026amp;rcvbuf, sizeof(rcvbuf)); // è¿æ¥ã€å‘é€ã€æ¥æ”¶æ•°æ® connect(sockfd, ...); send(sockfd, ...); recv(sockfd, ...); ç¼“å†²åŒºå±‚é¢çš„åŒºåˆ« #TCPç¼“å†²åŒº:","title":"é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­çš„WebSocketç½‘ç»œç¼“å†²åŒºä¼˜åŒ–æŠ€æœ¯"},{"content":"ç›®å½• # æ™®é€šå‡½æ•°è°ƒç”¨çš„å¼€é”€ inlineå‡½æ•°çš„ä¼˜åŒ– inlineå‡½æ•°çš„å±€é™æ€§ä¸æƒè¡¡ ç¤ºä¾‹ä»£ç ä¸åˆ†æ ä»€ä¹ˆæ—¶å€™ä½¿ç”¨inlineå‡½æ•°ï¼Ÿ ç°ä»£ç¼–è¯‘å™¨çš„ä¼˜åŒ– æ€»ç»“ 1. æ™®é€šå‡½æ•°è°ƒç”¨çš„å¼€é”€ #åœ¨C++ä¸­ï¼Œæ™®é€šå‡½æ•°è°ƒç”¨æ¶‰åŠä»¥ä¸‹æ­¥éª¤ï¼Œè¿™äº›æ­¥éª¤ä¼šå¼•å…¥æ€§èƒ½å¼€é”€ï¼š\næ ˆå¸§çš„åˆ›å»ºä¸é”€æ¯ï¼š è°ƒç”¨å‡½æ•°æ—¶ï¼Œç¨‹åºéœ€è¦ä¿å­˜å½“å‰å‡½æ•°çš„çŠ¶æ€ï¼ˆä¾‹å¦‚å¯„å­˜å™¨ä¸­çš„å€¼ï¼‰ï¼Œä¸ºè¢«è°ƒç”¨å‡½æ•°åˆ†é…æ ˆç©ºé—´ï¼Œè®¾ç½®æ ˆå¸§ï¼ˆåŒ…æ‹¬è¿”å›åœ°å€ã€å‚æ•°ä¼ é€’ã€å±€éƒ¨å˜é‡ç­‰ï¼‰ã€‚ å‡½æ•°è¿”å›æ—¶ï¼Œéœ€è¦æ¢å¤è°ƒç”¨è€…çš„æ ˆå¸§çŠ¶æ€ã€‚ è¿™äº›æ“ä½œæ¶‰åŠæ ˆæŒ‡é’ˆï¼ˆSPï¼‰å’ŒåŸºæŒ‡é’ˆï¼ˆBPï¼‰çš„è°ƒæ•´ï¼Œä»¥åŠå†…å­˜çš„è¯»å†™æ“ä½œã€‚ å‚æ•°ä¼ é€’ä¸è¿”å›å€¼ï¼š å‚æ•°éœ€è¦é€šè¿‡æ ˆæˆ–å¯„å­˜å™¨ä¼ é€’åˆ°è¢«è°ƒç”¨å‡½æ•°ï¼Œè¿™å¯èƒ½æ¶‰åŠå†…å­˜æ‹·è´ï¼ˆå°¤å…¶æ˜¯å¯¹äºè¾ƒå¤§çš„ç»“æ„ä½“æˆ–å¯¹è±¡ï¼‰ã€‚ è¿”å›å€¼ä¹Ÿéœ€è¦é€šè¿‡å¯„å­˜å™¨æˆ–å†…å­˜ä¼ é€’å›è°ƒç”¨è€…ã€‚ è·³è½¬å¼€é”€ï¼š å‡½æ•°è°ƒç”¨éœ€è¦å°†ç¨‹åºè®¡æ•°å™¨ï¼ˆPCï¼‰è·³è½¬åˆ°è¢«è°ƒç”¨å‡½æ•°çš„åœ°å€ï¼ˆé€šè¿‡callæŒ‡ä»¤ï¼‰ï¼Œè¿”å›æ—¶å†è·³å›è°ƒç”¨è€…ï¼ˆé€šè¿‡retæŒ‡ä»¤ï¼‰ã€‚ è¿™ç§è·³è½¬å¯èƒ½ä¼šå¯¼è‡´CPUæŒ‡ä»¤æµæ°´çº¿çš„åˆ·æ–°ï¼ˆpipeline flushï¼‰ï¼Œå°¤å…¶æ˜¯åœ¨åˆ†æ”¯é¢„æµ‹å¤±è´¥çš„æƒ…å†µä¸‹ã€‚ å¯„å­˜å™¨ä¸Šä¸‹æ–‡ä¿å­˜/æ¢å¤ï¼š è°ƒç”¨å‡½æ•°å¯èƒ½å¯¼è‡´å¯„å­˜å™¨å†…å®¹çš„ä¿å­˜ä¸æ¢å¤ï¼ˆä¾‹å¦‚è°ƒç”¨è€…ä¿å­˜çš„å¯„å­˜å™¨æˆ–è¢«è°ƒç”¨è€…ä¿å­˜çš„å¯„å­˜å™¨ï¼‰ï¼Œå¢åŠ é¢å¤–çš„æŒ‡ä»¤å¼€é”€ã€‚ è¿™äº›æ­¥éª¤è™½ç„¶åœ¨ç°ä»£CPUä¸Šéå¸¸å¿«ï¼Œä½†å¯¹äºé¢‘ç¹è°ƒç”¨çš„å‡½æ•°ï¼ˆä¾‹å¦‚å°å‹ã€ç®€å•å‡½æ•°ï¼‰ï¼Œè¿™äº›å¼€é”€å¯èƒ½å å‡½æ•°æ‰§è¡Œæ—¶é—´çš„æ˜¾è‘—æ¯”ä¾‹ã€‚\n2. inlineå‡½æ•°çš„ä¼˜åŒ– #inlineå…³é”®å­—å»ºè®®ç¼–è¯‘å™¨å°†å‡½æ•°çš„ä»£ç ç›´æ¥åµŒå…¥åˆ°è°ƒç”¨å¤„ï¼Œè€Œä¸æ˜¯ç”Ÿæˆå‡½æ•°è°ƒç”¨ã€‚è¿™ç§å†…è”ï¼ˆinliningï¼‰ä¼˜åŒ–å¯ä»¥æ˜¾è‘—å‡å°‘ä¸Šè¿°å¼€é”€ï¼ŒåŸå› å¦‚ä¸‹ï¼š\næ¶ˆé™¤å‡½æ•°è°ƒç”¨å¼€é”€ï¼š å†…è”å‡½æ•°çš„ä»£ç ç›´æ¥åµŒå…¥åˆ°è°ƒç”¨å¤„ï¼Œçœå»äº†æ ˆå¸§çš„åˆ›å»ºä¸é”€æ¯ã€å‚æ•°ä¼ é€’ã€è¿”å›å€¼çš„å¤„ç†ä»¥åŠè·³è½¬æŒ‡ä»¤ã€‚ ç¨‹åºæ— éœ€æ‰§è¡Œcallå’ŒretæŒ‡ä»¤ï¼Œä¹Ÿé¿å…äº†å¯èƒ½çš„æµæ°´çº¿åˆ·æ–°ã€‚ ä¼˜åŒ–æœºä¼šå¢åŠ ï¼š ç¼–è¯‘å™¨åœ¨ä¼˜åŒ–é˜¶æ®µå¯ä»¥çœ‹åˆ°å†…è”å‡½æ•°çš„å®Œæ•´ä»£ç ä¸Šä¸‹æ–‡ï¼Œå¯ä»¥åº”ç”¨æ›´å¤šçš„ä¼˜åŒ–æŠ€æœ¯ï¼Œä¾‹å¦‚ï¼š å¸¸é‡æŠ˜å ï¼šå¦‚æœå†…è”å‡½æ•°çš„å‚æ•°æ˜¯å¸¸é‡ï¼Œç¼–è¯‘å™¨å¯ä»¥ç›´æ¥è®¡ç®—ç»“æœã€‚ æ­»ä»£ç æ¶ˆé™¤ï¼šå¦‚æœå†…è”å‡½æ•°ä¸­æŸäº›åˆ†æ”¯åœ¨è°ƒç”¨ä¸Šä¸‹æ–‡ä¸­æ°¸è¿œä¸ä¼šæ‰§è¡Œï¼Œç¼–è¯‘å™¨å¯ä»¥å‰”é™¤è¿™äº›ä»£ç ã€‚ å¾ªç¯å±•å¼€æˆ–æŒ‡ä»¤é‡æ’ï¼šå†…è”åï¼Œç¼–è¯‘å™¨å¯ä»¥æ›´å¥½åœ°è°ƒæ•´æŒ‡ä»¤é¡ºåºï¼Œä¼˜åŒ–CPUç¼“å­˜åˆ©ç”¨ç‡æˆ–å‡å°‘åˆ†æ”¯è·³è½¬ã€‚ å‡å°‘æŒ‡ä»¤æ•°ï¼š å¯¹äºå°å‹å‡½æ•°ï¼Œå‡½æ•°è°ƒç”¨çš„å¼€é”€å¯èƒ½æ¯”å‡½æ•°ä½“æœ¬èº«çš„æ‰§è¡Œæ—¶é—´è¿˜é•¿ã€‚å†…è”åï¼Œå‡½æ•°ä½“çš„ä»£ç ç›´æ¥åµŒå…¥ï¼Œå‡å°‘äº†é¢å¤–çš„æŒ‡ä»¤ï¼ˆå¦‚pushã€popã€callã€retç­‰ï¼‰ã€‚ 3. inlineå‡½æ•°çš„å±€é™æ€§ä¸æƒè¡¡ #è™½ç„¶inlineå‡½æ•°é€šå¸¸æ›´å¿«ï¼Œä½†å®ƒå¹¶éæ€»æ˜¯æœ€ä½³é€‰æ‹©ï¼Œä»¥ä¸‹æ˜¯ä¸€äº›éœ€è¦æ³¨æ„çš„ç‚¹ï¼š\nä»£ç è†¨èƒ€ï¼š å†…è”å‡½æ•°ä¼šå°†å‡½æ•°ä»£ç å¤åˆ¶åˆ°æ¯ä¸ªè°ƒç”¨ç‚¹ï¼Œå¦‚æœå‡½æ•°ä½“è¾ƒå¤§æˆ–è°ƒç”¨ç‚¹å¾ˆå¤šï¼Œå¯èƒ½å¯¼è‡´ç”Ÿæˆçš„æœºå™¨ä»£ç ä½“ç§¯æ˜¾è‘—å¢åŠ ã€‚è¿™å¯èƒ½å¯¼è‡´ï¼š æŒ‡ä»¤ç¼“å­˜ï¼ˆI-Cacheï¼‰æ•ˆç‡ä¸‹é™ï¼šä»£ç ä½“ç§¯è¿‡å¤§å¯èƒ½æ— æ³•å®Œå…¨æ”¾å…¥CPUçš„æŒ‡ä»¤ç¼“å­˜ï¼Œå¢åŠ ç¼“å­˜æœªå‘½ä¸­ï¼ˆcache missï¼‰ã€‚ å¯æ‰§è¡Œæ–‡ä»¶å˜å¤§ï¼šå¢åŠ ç¼–è¯‘åäºŒè¿›åˆ¶æ–‡ä»¶çš„å¤§å°ã€‚ ç¼–è¯‘å™¨çš„è‡ªä¸»å†³å®šï¼š inlineå…³é”®å­—åªæ˜¯ä¸€ä¸ªå»ºè®®ï¼Œç°ä»£ç¼–è¯‘å™¨ï¼ˆå¦‚GCCã€Clangã€MSVCï¼‰ä¼šæ ¹æ®è‡ªå·±çš„ä¼˜åŒ–ç­–ç•¥å†³å®šæ˜¯å¦å†…è”ã€‚ ç¼–è¯‘å™¨å¯èƒ½å¿½ç•¥inlineå…³é”®å­—ï¼ˆä¾‹å¦‚å‡½æ•°ä½“è¿‡å¤§æˆ–è¿‡äºå¤æ‚ï¼‰ï¼Œä¹Ÿå¯èƒ½è‡ªåŠ¨å†…è”æœªæ ‡è®°ä¸ºinlineçš„å‡½æ•°ï¼ˆç§°ä¸ºè‡ªåŠ¨å†…è”ï¼‰ã€‚ ä¾‹å¦‚ï¼ŒO2æˆ–O3ä¼˜åŒ–çº§åˆ«ä¸‹ï¼Œç¼–è¯‘å™¨ä¼šæ ¹æ®å‡½æ•°çš„å¤§å°ã€è°ƒç”¨é¢‘ç‡ç­‰å› ç´ æ™ºèƒ½é€‰æ‹©æ˜¯å¦å†…è”ã€‚ é€’å½’å‡½æ•°ï¼š é€’å½’å‡½æ•°é€šå¸¸æ— æ³•å®Œå…¨å†…è”ï¼Œå› ä¸ºå†…è”ä¼šå¯¼è‡´æ— é™å±•å¼€ã€‚ç¼–è¯‘å™¨å¯èƒ½åªå†…è”éƒ¨åˆ†é€’å½’è°ƒç”¨ï¼ˆä¾‹å¦‚å°¾é€’å½’ä¼˜åŒ–ï¼‰ã€‚ è°ƒè¯•éš¾åº¦ï¼š å†…è”å‡½æ•°çš„ä»£ç åœ¨è°ƒè¯•æ—¶å¯èƒ½ä¸å¯è§ï¼Œå› ä¸ºå®ƒä»¬è¢«å±•å¼€åä¸å†ä½œä¸ºç‹¬ç«‹çš„å‡½æ•°å­˜åœ¨ï¼Œå¯èƒ½å½±å“è°ƒè¯•ä½“éªŒã€‚ 4. ç¤ºä¾‹ä»£ç ä¸åˆ†æ #ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œå±•ç¤ºæ™®é€šå‡½æ•°è°ƒç”¨ä¸å†…è”å‡½æ•°çš„å·®å¼‚ï¼š\n#include \u0026lt;iostream\u0026gt; // æ™®é€šå‡½æ•° int add(int a, int b) { return a + b; } // å†…è”å‡½æ•° inline int inline_add(int a, int b) { return a + b; } int main() { int x = 5, y = 10; int result1 = add(x, y); // æ™®é€šå‡½æ•°è°ƒç”¨ int result2 = inline_add(x, y); // å†…è”å‡½æ•°è°ƒç”¨ std::cout \u0026lt;\u0026lt; result1 \u0026lt;\u0026lt; \u0026#34; \u0026#34; \u0026lt;\u0026lt; result2 \u0026lt;\u0026lt; std::endl; return 0; } æ™®é€šå‡½æ•°è°ƒç”¨ï¼ˆaddï¼‰ï¼š\nç¼–è¯‘å™¨ç”ŸæˆcallæŒ‡ä»¤ï¼Œè·³è½¬åˆ°addå‡½æ•°çš„åœ°å€ã€‚\næ ˆå¸§åˆ†é…ã€å‚æ•°ä¼ é€’ã€è¿”å›å€¼å¤„ç†ç­‰éƒ½ä¼šå‘ç”Ÿã€‚\nå‡è®¾addå‡½æ•°çš„æœºå™¨ç å¦‚ä¸‹ï¼ˆä¼ªæ±‡ç¼–ï¼‰ï¼š è°ƒç”¨æ—¶ï¼š\nadd: push ebp mov ebp, esp mov eax, [ebp + 8] ; åŠ è½½å‚æ•°a add eax, [ebp + 12] ; åŠ ä¸Šå‚æ•°b mov esp, ebp pop ebp ret push 10 push 5 call add å†…è”å‡½æ•°è°ƒç”¨ï¼ˆinline_addï¼‰ï¼š\nç¼–è¯‘å™¨ç›´æ¥å°†inline_addçš„ä»£ç åµŒå…¥åˆ°è°ƒç”¨å¤„ï¼Œç”Ÿæˆçš„ä¼ªæ±‡ç¼–å¯èƒ½å¦‚ä¸‹ï¼š æ²¡æœ‰å‡½æ•°è°ƒç”¨å¼€é”€ï¼ŒæŒ‡ä»¤æ•°æ›´å°‘ï¼Œæ‰§è¡Œæ•ˆç‡æ›´é«˜ã€‚\nmov eax, 5 ; x add eax, 10 ; y 5. ä»€ä¹ˆæ—¶å€™ä½¿ç”¨inlineå‡½æ•°ï¼Ÿ # å°å‹ã€é¢‘ç¹è°ƒç”¨çš„å‡½æ•°ï¼šä¾‹å¦‚ç®€å•çš„ getter/setterã€æ•°å­¦è¿ç®—å‡½æ•°ï¼ˆå¦‚ä¸Šä¾‹ä¸­çš„addï¼‰ã€‚ æ€§èƒ½æ•æ„Ÿçš„ä»£ç ï¼šåœ¨é«˜æ€§èƒ½è®¡ç®—ï¼ˆå¦‚æ¸¸æˆå¼•æ“ã€å®æ—¶ç³»ç»Ÿï¼‰ä¸­ï¼Œå†…è”å°å‹å‡½æ•°å¯ä»¥æ˜¾è‘—å‡å°‘å¼€é”€ã€‚ æ¨¡æ¿å‡½æ•°ï¼šC++æ¨¡æ¿å‡½æ•°é€šå¸¸å®šä¹‰åœ¨å¤´æ–‡ä»¶ä¸­ï¼Œéšå¼å†…è”ï¼ˆimplicit inlineï¼‰ï¼Œå› ä¸ºå®ƒä»¬éœ€è¦åœ¨æ¯ä¸ªä½¿ç”¨å¤„ç”Ÿæˆå…·ä½“ä»£ç ã€‚ ä¸é€‚åˆå†…è”çš„åœºæ™¯ï¼š\nå‡½æ•°ä½“è¿‡å¤§ï¼ˆå¦‚åŒ…å«å¤æ‚é€»è¾‘ã€å¾ªç¯æˆ–å¤§é‡åˆ†æ”¯ï¼‰ã€‚ å‡½æ•°è°ƒç”¨é¢‘ç‡ä½ï¼Œå†…è”å¸¦æ¥çš„ä»£ç è†¨èƒ€å¾—ä¸å¿å¤±ã€‚ éœ€è¦è·¨æ¨¡å—è°ƒç”¨ï¼ˆä¾‹å¦‚åŠ¨æ€é“¾æ¥åº“ä¸­çš„å‡½æ•°é€šå¸¸æ— æ³•å†…è”ï¼‰ã€‚ 6. ç°ä»£ç¼–è¯‘å™¨çš„ä¼˜åŒ– #ç°ä»£C++ç¼–è¯‘å™¨ï¼ˆå¦‚GCCã€Clangï¼‰åœ¨ä¼˜åŒ–çº§åˆ«è¾ƒé«˜æ—¶ï¼ˆå¦‚-O2æˆ–-O3ï¼‰ä¼šè‡ªåŠ¨å†…è”å°å‹å‡½æ•°ï¼Œå³ä½¿æ²¡æœ‰æ˜¾å¼ä½¿ç”¨inlineå…³é”®å­—ã€‚è¿™æ˜¯å› ä¸ºç¼–è¯‘å™¨é€šè¿‡å…¨å±€ä¼˜åŒ–å’Œ**é“¾æ¥æ—¶ä¼˜åŒ–ï¼ˆLTO, Link-Time Optimizationï¼‰**å¯ä»¥æ›´å¥½åœ°åˆ†æå‡½æ•°è°ƒç”¨æ¨¡å¼ï¼Œå†³å®šæ˜¯å¦å†…è”ã€‚å› æ­¤ï¼Œæ˜¾å¼ä½¿ç”¨inlineçš„å¿…è¦æ€§åœ¨ç°ä»£C++ä¸­æœ‰æ‰€é™ä½ï¼Œä½†åœ¨ä»¥ä¸‹æƒ…å†µä¸‹ä»æœ‰æ„ä¹‰ï¼š\næ˜ç¡®å‘ç¼–è¯‘å™¨å»ºè®®å†…è”ï¼ˆä¾‹å¦‚åœ¨å¤´æ–‡ä»¶ä¸­å®šä¹‰å°å‹å‡½æ•°ï¼‰ã€‚ æé«˜ä»£ç å¯è¯»æ€§ï¼Œè¡¨æ˜å‡½æ•°è®¾è®¡ç›®çš„æ˜¯ä¸ºäº†å†…è”ã€‚ 7. æ€»ç»“ #inlineå‡½æ•°æ¯”æ™®é€šå‡½æ•°è°ƒç”¨æ›´å¿«çš„ä¸»è¦åŸå› æ˜¯ï¼š\næ¶ˆé™¤äº†å‡½æ•°è°ƒç”¨çš„å¼€é”€ï¼ˆæ ˆå¸§ç®¡ç†ã€å‚æ•°ä¼ é€’ã€è·³è½¬æŒ‡ä»¤ç­‰ï¼‰ã€‚ æä¾›äº†æ›´å¤šçš„ç¼–è¯‘æ—¶ä¼˜åŒ–æœºä¼šï¼ˆå¸¸é‡æŠ˜å ã€æ­»ä»£ç æ¶ˆé™¤ç­‰ï¼‰ã€‚ å‡å°‘äº†æŒ‡ä»¤æ‰§è¡Œæ•°é‡ï¼Œå°¤å…¶å¯¹å°å‹å‡½æ•°æ•ˆæœæ˜¾è‘—ã€‚ ä½†å†…è”å¹¶éä¸‡èƒ½ï¼Œéœ€æƒè¡¡ä»£ç è†¨èƒ€ã€è°ƒè¯•éš¾åº¦ç­‰å› ç´ ã€‚åœ¨ç°ä»£C++ä¸­ï¼Œç¼–è¯‘å™¨çš„æ™ºèƒ½ä¼˜åŒ–ä½¿å¾—inlineçš„ä½œç”¨æ›´å¤šæ˜¯æç¤ºæ€§è€Œéå¼ºåˆ¶æ€§ï¼Œå¼€å‘è€…åº”æ ¹æ®å®é™…æ€§èƒ½éœ€æ±‚å’Œåœºæ™¯è°¨æ…ä½¿ç”¨ã€‚\nå¦‚æœä½ æœ‰æ›´å…·ä½“çš„åœºæ™¯æˆ–ä»£ç éœ€è¦åˆ†æï¼Œæˆ–è€…æƒ³æ·±å…¥æ¢è®¨æŸéƒ¨åˆ†ï¼ˆå¦‚æ±‡ç¼–ä»£ç æˆ–ç¼–è¯‘å™¨ä¼˜åŒ–ç»†èŠ‚ï¼‰ï¼Œå¯ä»¥å‘Šè¯‰æˆ‘ï¼Œæˆ‘ä¼šè¿›ä¸€æ­¥ä¸ºä½ è®²è§£ï¼\n","date":"24 June 2025","permalink":"/blog/2025-06-24-inline_function_optimization/","section":"Blog","summary":"ç›®å½• # æ™®é€šå‡½æ•°è°ƒç”¨çš„å¼€é”€ inlineå‡½æ•°çš„ä¼˜åŒ– inlineå‡½æ•°çš„å±€é™æ€§ä¸æƒè¡¡ ç¤ºä¾‹ä»£ç ä¸åˆ†æ ä»€ä¹ˆæ—¶å€™ä½¿ç”¨inlineå‡½æ•°ï¼Ÿ ç°ä»£ç¼–è¯‘å™¨çš„ä¼˜åŒ– æ€»ç»“ 1. æ™®é€šå‡½æ•°è°ƒç”¨çš„å¼€é”€ #åœ¨C++ä¸­ï¼Œæ™®é€šå‡½æ•°è°ƒç”¨æ¶‰åŠä»¥ä¸‹æ­¥éª¤ï¼Œè¿™äº›æ­¥éª¤ä¼šå¼•å…¥æ€§èƒ½å¼€é”€ï¼š\næ ˆå¸§çš„åˆ›å»ºä¸é”€æ¯ï¼š è°ƒç”¨å‡½æ•°æ—¶ï¼Œç¨‹åºéœ€è¦ä¿å­˜å½“å‰å‡½æ•°çš„çŠ¶æ€ï¼ˆä¾‹å¦‚å¯„å­˜å™¨ä¸­çš„å€¼ï¼‰ï¼Œä¸ºè¢«è°ƒç”¨å‡½æ•°åˆ†é…æ ˆç©ºé—´ï¼Œè®¾ç½®æ ˆå¸§ï¼ˆåŒ…æ‹¬è¿”å›åœ°å€ã€å‚æ•°ä¼ é€’ã€å±€éƒ¨å˜é‡ç­‰ï¼‰ã€‚ å‡½æ•°è¿”å›æ—¶ï¼Œéœ€è¦æ¢å¤è°ƒç”¨è€…çš„æ ˆå¸§çŠ¶æ€ã€‚ è¿™äº›æ“ä½œæ¶‰åŠæ ˆæŒ‡é’ˆï¼ˆSPï¼‰å’ŒåŸºæŒ‡é’ˆï¼ˆBPï¼‰çš„è°ƒæ•´ï¼Œä»¥åŠå†…å­˜çš„è¯»å†™æ“ä½œã€‚ å‚æ•°ä¼ é€’ä¸è¿”å›å€¼ï¼š å‚æ•°éœ€è¦é€šè¿‡æ ˆæˆ–å¯„å­˜å™¨ä¼ é€’åˆ°è¢«è°ƒç”¨å‡½æ•°ï¼Œè¿™å¯èƒ½æ¶‰åŠå†…å­˜æ‹·è´ï¼ˆå°¤å…¶æ˜¯å¯¹äºè¾ƒå¤§çš„ç»“æ„ä½“æˆ–å¯¹è±¡ï¼‰ã€‚ è¿”å›å€¼ä¹Ÿéœ€è¦é€šè¿‡å¯„å­˜å™¨æˆ–å†…å­˜ä¼ é€’å›è°ƒç”¨è€…ã€‚ è·³è½¬å¼€é”€ï¼š å‡½æ•°è°ƒç”¨éœ€è¦å°†ç¨‹åºè®¡æ•°å™¨ï¼ˆPCï¼‰è·³è½¬åˆ°è¢«è°ƒç”¨å‡½æ•°çš„åœ°å€ï¼ˆé€šè¿‡callæŒ‡ä»¤ï¼‰ï¼Œè¿”å›æ—¶å†è·³å›è°ƒç”¨è€…ï¼ˆé€šè¿‡retæŒ‡ä»¤ï¼‰ã€‚ è¿™ç§è·³è½¬å¯èƒ½ä¼šå¯¼è‡´CPUæŒ‡ä»¤æµæ°´çº¿çš„åˆ·æ–°ï¼ˆpipeline flushï¼‰ï¼Œå°¤å…¶æ˜¯åœ¨åˆ†æ”¯é¢„æµ‹å¤±è´¥çš„æƒ…å†µä¸‹ã€‚ å¯„å­˜å™¨ä¸Šä¸‹æ–‡ä¿å­˜/æ¢å¤ï¼š è°ƒç”¨å‡½æ•°å¯èƒ½å¯¼è‡´å¯„å­˜å™¨å†…å®¹çš„ä¿å­˜ä¸æ¢å¤ï¼ˆä¾‹å¦‚è°ƒç”¨è€…ä¿å­˜çš„å¯„å­˜å™¨æˆ–è¢«è°ƒç”¨è€…ä¿å­˜çš„å¯„å­˜å™¨ï¼‰ï¼Œå¢åŠ é¢å¤–çš„æŒ‡ä»¤å¼€é”€ã€‚ è¿™äº›æ­¥éª¤è™½ç„¶åœ¨ç°ä»£CPUä¸Šéå¸¸å¿«ï¼Œä½†å¯¹äºé¢‘ç¹è°ƒç”¨çš„å‡½æ•°ï¼ˆä¾‹å¦‚å°å‹ã€ç®€å•å‡½æ•°ï¼‰ï¼Œè¿™äº›å¼€é”€å¯èƒ½å å‡½æ•°æ‰§è¡Œæ—¶é—´çš„æ˜¾è‘—æ¯”ä¾‹ã€‚\n2. inlineå‡½æ•°çš„ä¼˜åŒ– #inlineå…³é”®å­—å»ºè®®ç¼–è¯‘å™¨å°†å‡½æ•°çš„ä»£ç ç›´æ¥åµŒå…¥åˆ°è°ƒç”¨å¤„ï¼Œè€Œä¸æ˜¯ç”Ÿæˆå‡½æ•°è°ƒç”¨ã€‚è¿™ç§å†…è”ï¼ˆinliningï¼‰ä¼˜åŒ–å¯ä»¥æ˜¾è‘—å‡å°‘ä¸Šè¿°å¼€é”€ï¼ŒåŸå› å¦‚ä¸‹ï¼š\næ¶ˆé™¤å‡½æ•°è°ƒç”¨å¼€é”€ï¼š å†…è”å‡½æ•°çš„ä»£ç ç›´æ¥åµŒå…¥åˆ°è°ƒç”¨å¤„ï¼Œçœå»äº†æ ˆå¸§çš„åˆ›å»ºä¸é”€æ¯ã€å‚æ•°ä¼ é€’ã€è¿”å›å€¼çš„å¤„ç†ä»¥åŠè·³è½¬æŒ‡ä»¤ã€‚ ç¨‹åºæ— éœ€æ‰§è¡Œcallå’ŒretæŒ‡ä»¤ï¼Œä¹Ÿé¿å…äº†å¯èƒ½çš„æµæ°´çº¿åˆ·æ–°ã€‚ ä¼˜åŒ–æœºä¼šå¢åŠ ï¼š ç¼–è¯‘å™¨åœ¨ä¼˜åŒ–é˜¶æ®µå¯ä»¥çœ‹åˆ°å†…è”å‡½æ•°çš„å®Œæ•´ä»£ç ä¸Šä¸‹æ–‡ï¼Œå¯ä»¥åº”ç”¨æ›´å¤šçš„ä¼˜åŒ–æŠ€æœ¯ï¼Œä¾‹å¦‚ï¼š å¸¸é‡æŠ˜å ï¼šå¦‚æœå†…è”å‡½æ•°çš„å‚æ•°æ˜¯å¸¸é‡ï¼Œç¼–è¯‘å™¨å¯ä»¥ç›´æ¥è®¡ç®—ç»“æœã€‚ æ­»ä»£ç æ¶ˆé™¤ï¼šå¦‚æœå†…è”å‡½æ•°ä¸­æŸäº›åˆ†æ”¯åœ¨è°ƒç”¨ä¸Šä¸‹æ–‡ä¸­æ°¸è¿œä¸ä¼šæ‰§è¡Œï¼Œç¼–è¯‘å™¨å¯ä»¥å‰”é™¤è¿™äº›ä»£ç ã€‚ å¾ªç¯å±•å¼€æˆ–æŒ‡ä»¤é‡æ’ï¼šå†…è”åï¼Œç¼–è¯‘å™¨å¯ä»¥æ›´å¥½åœ°è°ƒæ•´æŒ‡ä»¤é¡ºåºï¼Œä¼˜åŒ–CPUç¼“å­˜åˆ©ç”¨ç‡æˆ–å‡å°‘åˆ†æ”¯è·³è½¬ã€‚ å‡å°‘æŒ‡ä»¤æ•°ï¼š å¯¹äºå°å‹å‡½æ•°ï¼Œå‡½æ•°è°ƒç”¨çš„å¼€é”€å¯èƒ½æ¯”å‡½æ•°ä½“æœ¬èº«çš„æ‰§è¡Œæ—¶é—´è¿˜é•¿ã€‚å†…è”åï¼Œå‡½æ•°ä½“çš„ä»£ç ç›´æ¥åµŒå…¥ï¼Œå‡å°‘äº†é¢å¤–çš„æŒ‡ä»¤ï¼ˆå¦‚pushã€popã€callã€retç­‰ï¼‰ã€‚ 3. inlineå‡½æ•°çš„å±€é™æ€§ä¸æƒè¡¡ #è™½ç„¶inlineå‡½æ•°é€šå¸¸æ›´å¿«ï¼Œä½†å®ƒå¹¶éæ€»æ˜¯æœ€ä½³é€‰æ‹©ï¼Œä»¥ä¸‹æ˜¯ä¸€äº›éœ€è¦æ³¨æ„çš„ç‚¹ï¼š\nä»£ç è†¨èƒ€ï¼š å†…è”å‡½æ•°ä¼šå°†å‡½æ•°ä»£ç å¤åˆ¶åˆ°æ¯ä¸ªè°ƒç”¨ç‚¹ï¼Œå¦‚æœå‡½æ•°ä½“è¾ƒå¤§æˆ–è°ƒç”¨ç‚¹å¾ˆå¤šï¼Œå¯èƒ½å¯¼è‡´ç”Ÿæˆçš„æœºå™¨ä»£ç ä½“ç§¯æ˜¾è‘—å¢åŠ ã€‚è¿™å¯èƒ½å¯¼è‡´ï¼š æŒ‡ä»¤ç¼“å­˜ï¼ˆI-Cacheï¼‰æ•ˆç‡ä¸‹é™ï¼šä»£ç ä½“ç§¯è¿‡å¤§å¯èƒ½æ— æ³•å®Œå…¨æ”¾å…¥CPUçš„æŒ‡ä»¤ç¼“å­˜ï¼Œå¢åŠ ç¼“å­˜æœªå‘½ä¸­ï¼ˆcache missï¼‰ã€‚ å¯æ‰§è¡Œæ–‡ä»¶å˜å¤§ï¼šå¢åŠ ç¼–è¯‘åäºŒè¿›åˆ¶æ–‡ä»¶çš„å¤§å°ã€‚ ç¼–è¯‘å™¨çš„è‡ªä¸»å†³å®šï¼š inlineå…³é”®å­—åªæ˜¯ä¸€ä¸ªå»ºè®®ï¼Œç°ä»£ç¼–è¯‘å™¨ï¼ˆå¦‚GCCã€Clangã€MSVCï¼‰ä¼šæ ¹æ®è‡ªå·±çš„ä¼˜åŒ–ç­–ç•¥å†³å®šæ˜¯å¦å†…è”ã€‚ ç¼–è¯‘å™¨å¯èƒ½å¿½ç•¥inlineå…³é”®å­—ï¼ˆä¾‹å¦‚å‡½æ•°ä½“è¿‡å¤§æˆ–è¿‡äºå¤æ‚ï¼‰ï¼Œä¹Ÿå¯èƒ½è‡ªåŠ¨å†…è”æœªæ ‡è®°ä¸ºinlineçš„å‡½æ•°ï¼ˆç§°ä¸ºè‡ªåŠ¨å†…è”ï¼‰ã€‚ ä¾‹å¦‚ï¼ŒO2æˆ–O3ä¼˜åŒ–çº§åˆ«ä¸‹ï¼Œç¼–è¯‘å™¨ä¼šæ ¹æ®å‡½æ•°çš„å¤§å°ã€è°ƒç”¨é¢‘ç‡ç­‰å› ç´ æ™ºèƒ½é€‰æ‹©æ˜¯å¦å†…è”ã€‚ é€’å½’å‡½æ•°ï¼š é€’å½’å‡½æ•°é€šå¸¸æ— æ³•å®Œå…¨å†…è”ï¼Œå› ä¸ºå†…è”ä¼šå¯¼è‡´æ— é™å±•å¼€ã€‚ç¼–è¯‘å™¨å¯èƒ½åªå†…è”éƒ¨åˆ†é€’å½’è°ƒç”¨ï¼ˆä¾‹å¦‚å°¾é€’å½’ä¼˜åŒ–ï¼‰ã€‚ è°ƒè¯•éš¾åº¦ï¼š å†…è”å‡½æ•°çš„ä»£ç åœ¨è°ƒè¯•æ—¶å¯èƒ½ä¸å¯è§ï¼Œå› ä¸ºå®ƒä»¬è¢«å±•å¼€åä¸å†ä½œä¸ºç‹¬ç«‹çš„å‡½æ•°å­˜åœ¨ï¼Œå¯èƒ½å½±å“è°ƒè¯•ä½“éªŒã€‚ 4. ç¤ºä¾‹ä»£ç ä¸åˆ†æ #ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œå±•ç¤ºæ™®é€šå‡½æ•°è°ƒç”¨ä¸å†…è”å‡½æ•°çš„å·®å¼‚ï¼š\n#include \u0026lt;iostream\u0026gt; // æ™®é€šå‡½æ•° int add(int a, int b) { return a + b; } // å†…è”å‡½æ•° inline int inline_add(int a, int b) { return a + b; } int main() { int x = 5, y = 10; int result1 = add(x, y); // æ™®é€šå‡½æ•°è°ƒç”¨ int result2 = inline_add(x, y); // å†…è”å‡½æ•°è°ƒç”¨ std::cout \u0026lt;\u0026lt; result1 \u0026lt;\u0026lt; \u0026#34; \u0026#34; \u0026lt;\u0026lt; result2 \u0026lt;\u0026lt; std::endl; return 0; } æ™®é€šå‡½æ•°è°ƒç”¨ï¼ˆaddï¼‰ï¼š","title":"C++ä¸­inlineå‡½æ•°ä¸ºä½•æ¯”æ™®é€šå‡½æ•°è°ƒç”¨æ›´å¿«ï¼šæ·±å…¥è§£æ"},{"content":"ç›®å½• #1. å¼•è¨€ # False Sharingæ¦‚å¿µä»‹ç» æ–‡ç« ç ”ç©¶ç›®æ ‡ 2. æµ‹è¯•è®¾è®¡æ¦‚è§ˆ # æµ‹è¯•ç”¨ä¾‹çŸ©é˜µ æµ‹è¯•æ–¹æ³•è¯´æ˜ 3. æ ·ä¾‹è¿è¡Œç»“æœ # æ™®é€šå˜é‡ + False Sharing æ™®é€šå˜é‡ + æ— False Sharing åŸå­å˜é‡ + False Sharing åŸå­å˜é‡ + æ— False Sharing 4. ç°è±¡åˆ†æä¸åŸç†è§£é‡Š # False Sharingå¦‚ä½•é™ä½æ€§èƒ½ alignas(64)é¿å…False Sharingçš„åŸç† cache misså‡é«˜çš„åŸå› åˆ†æ åŸå­å˜é‡æ€§èƒ½å¼€é”€åˆ†æ 5. æ·±å…¥ç†è§£ç¼“å­˜ä¸€è‡´æ€§ä¸åŸå­æ“ä½œ # MESIç¼“å­˜ä¸€è‡´æ€§åè®®è¯¦è§£ æ™®é€šå˜é‡ä¸åŸå­å˜é‡çš„å¯¹æ¯” åŸå­å˜é‡ + False sharingçš„æ€§èƒ½å½±å“ CPUæŒ‡ä»¤å±‚é¢çš„å·®å¼‚ ç¼“å­˜ä¸€è‡´æ€§åè®®çš„å½±å“ å¾®æ¶æ„å±‚é¢çš„è¯¦ç»†åˆ†æ 6. å®æˆ˜ä¼˜åŒ–å»ºè®® # ä¸åŒåœºæ™¯çš„ä¼˜åŒ–ç­–ç•¥ 7. æ€»ç»“ # False Sharingçš„å…³é”®è¦ç‚¹ æ ¸å¿ƒç»“è®º 8. å‚è€ƒèµ„æ–™ä¸ç›¸å…³é˜…è¯» #9. é™„å½•ï¼šå®Œæ•´æµ‹è¯•ä»£ç  # å¼•è¨€ #åœ¨ç°ä»£å¤šæ ¸å¤„ç†å™¨æ¶æ„ä¸­ï¼Œç¼“å­˜ç³»ç»Ÿåœ¨æ€§èƒ½ä¸­æ‰®æ¼”ç€è‡³å…³é‡è¦çš„è§’è‰²ã€‚ç„¶è€Œï¼Œå½“å¤šä¸ªçº¿ç¨‹åŒæ—¶æ“ä½œä½äºåŒä¸€ç¼“å­˜è¡Œï¼ˆCache Lineï¼‰å†…çš„ä¸åŒå˜é‡æ—¶ï¼Œå³ä½¿å®ƒä»¬å¹¶æœªå…±äº«å˜é‡æœ¬èº«ï¼Œä¹Ÿå¯èƒ½å¯¼è‡´é¢‘ç¹çš„ç¼“å­˜ä¸€è‡´æ€§åè®®äº¤äº’ï¼Œè¿™å°±æ˜¯è‘—åçš„æ€§èƒ½æ€æ‰‹â€”â€”False Sharingã€‚\næœ¬æ–‡åŸºäº C++ è‡ªå®šä¹‰æµ‹è¯•ç¨‹åºï¼Œç»“åˆ perf å·¥å…·å®æµ‹ï¼Œä»å¤šä¸ªç»´åº¦æ·±å…¥å‰–æ False Sharing å¯¹æ€§èƒ½çš„å½±å“ï¼Œå¹¶æ¢è®¨ï¼š\nä»€ä¹ˆæ˜¯çœŸæ­£çš„ False Sharingï¼Ÿ ä¸ºä»€ä¹ˆ alignas(64) å¯ä»¥æœ‰æ•ˆè§£å†³å®ƒï¼Ÿ ä¸ºä»€ä¹ˆ cache miss å¢åŠ äº†åè€Œæ€§èƒ½æ›´å¥½ï¼Ÿ åŸå­å˜é‡åœ¨å¤šçº¿ç¨‹åœºæ™¯ä¸‹çš„é¢å¤–å¼€é”€ä»ä½•è€Œæ¥ï¼Ÿ æµ‹è¯•è®¾è®¡æ¦‚è§ˆ #1. æµ‹è¯•ç”¨ä¾‹çŸ©é˜µ #æˆ‘ä»¬å®šä¹‰äº†å¦‚ä¸‹å››ç§æµ‹è¯•åœºæ™¯ï¼Œæ¯ç§ä»¥ä¸¤ä¸ªçº¿ç¨‹å¯¹ä¸åŒå˜é‡è¿›è¡Œç‹¬ç«‹å†™å…¥ï¼Œå…±æ‰§è¡Œ 5,000,000 æ¬¡ï¼š\nåœºæ™¯ç¼–å· å˜é‡ç±»å‹ ç¼“å­˜è¡Œå¯¹é½ æ˜¯å¦ False Sharing 1 æ™®é€šå˜é‡ å¦ âœ… æ˜¯ 2 æ™®é€šå˜é‡ æ˜¯ï¼ˆalignas 64ï¼‰ âŒ å¦ 3 åŸå­å˜é‡ å¦ âœ… æ˜¯ 4 åŸå­å˜é‡ æ˜¯ âŒ å¦ æ¯ç»„æµ‹è¯•è¿è¡Œ 5 æ¬¡ï¼Œå–å¹³å‡æ‰§è¡Œæ—¶é—´ã€æ ‡å‡†å·®ï¼Œå¹¶ç»“åˆ perf stat é‡‡é›† cache-misses ä¸ cache-referencesã€‚\næ ·ä¾‹è¿è¡Œç»“æœï¼ˆ2çº¿ç¨‹ï¼ŒIntel Coreï¼‰ #æ™®é€šå˜é‡ + False Sharing #å¹³å‡è€—æ—¶: 21.1ms cache-misses: 165,853 cache-references: 4,599,762 miss ratio: 3.6% æ™®é€šå˜é‡ + æ—  False Sharingï¼ˆalignas 64ï¼‰ #å¹³å‡è€—æ—¶: 12.5ms cache-misses: 157,214 cache-references: 400,988 miss ratio: 39.2% åŸå­å˜é‡ + False Sharing #å¹³å‡è€—æ—¶: 208.3ms cache-misses: 441,606 cache-references: 34,764,460 miss ratio: 1.27% åŸå­å˜é‡ + æ—  False Sharing #å¹³å‡è€—æ—¶: 61.9ms cache-misses: 197,364 cache-references: 550,613 miss ratio: 35.8% ç°è±¡åˆ†æä¸åŸç†è§£é‡Š #1. False Sharing å¦‚ä½•é™ä½æ€§èƒ½ï¼Ÿ #False Sharing æŒ‡çš„æ˜¯ï¼š\nå¤šä¸ªçº¿ç¨‹ä¿®æ”¹ä¸åŒå˜é‡ï¼Œä½†è¿™äº›å˜é‡å¤„åœ¨åŒä¸€ä¸ª Cache Line ä¸­ï¼Œä»è€Œå¯¼è‡´ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼ˆå¦‚ MESIï¼‰ä¸æ–­å¼•å‘ cache line å¤±æ•ˆå’Œé‡æ–°åŠ è½½ã€‚\nå¤šä¸ªçº¿ç¨‹è¿è¡Œåœ¨ä¸åŒç‰©ç†æ ¸å¿ƒä¸Šï¼Œå¹¶å‘å†™å…¥ä½äºåŒä¸€ cache line ä¸Šä½†å½¼æ­¤ç‹¬ç«‹çš„å˜é‡ã€‚ å°½ç®¡å˜é‡é€»è¾‘ä¸Šæ²¡æœ‰å…±äº«ï¼Œä½†ç”±äºå®ƒä»¬å…±å ä¸€ä¸ª cache lineï¼Œä¼šå¯¼è‡´ cache line çš„æ‰€æœ‰æƒåœ¨æ ¸å¿ƒä¹‹é—´é¢‘ç¹æ¥å›è½¬ç§»ï¼Œä»è€Œå¼•å‘ cache invalidationã€æ€»çº¿é€šä¿¡å¢åŠ ã€å»¶è¿Ÿå‡é«˜ï¼Œä¸¥é‡æ—¶å¯¼è‡´ç¨‹åºæ€§èƒ½æ˜¾è‘—ä¸‹é™ã€‚\nè¿™å¯¼è‡´ä¸¤ä¸ªé—®é¢˜ï¼š\næ ¸é—´ Cache ä¸æ–­äº‰æŠ¢å¯¹è¯¥è¡Œçš„å†™æƒé™ â‡’ ä¸²è¡ŒåŒ–å†™æ“ä½œ store è¢«å»¶è¿Ÿæˆ–é˜»å¡ï¼ŒCPU pipeline è¢« stall å…³é”®ç‚¹ï¼šå¹¶ä¸æ˜¯å˜é‡å…±äº«æ‰ä¼šå†²çªï¼Œè€Œæ˜¯\u0026quot;å…±äº«ç¼“å­˜è¡Œ\u0026quot;ä¼šå¯¼è‡´\u0026quot;å…±äº«å‰¯ä½œç”¨\u0026quot;ã€‚\n2. ä¸ºä»€ä¹ˆ alignas(64) å¯ä»¥é¿å… False Sharingï¼Ÿ #ç°ä»£ CPU é€šå¸¸ä»¥ 64 å­—èŠ‚ä¸ºä¸€ä¸ªç¼“å­˜è¡Œï¼ˆCache Lineï¼‰å•ä½è¿›è¡Œæ•°æ®åŒæ­¥ã€‚\né€šè¿‡å°†ç»“æ„ä½“ä¸­çš„å˜é‡å£°æ˜ä¸ºï¼š\nalignas(64) int counter1; å¯å¼ºåˆ¶ç¼–è¯‘å™¨å°†è¯¥å˜é‡ç‹¬ç«‹æ”¾åœ¨ä¸€ä¸ª cache line ä¸­ï¼Œé¿å…äº†å¤šä¸ªå˜é‡â€œè½åœ¨åŒä¸€ä¸ª cache lineâ€çš„æƒ…å†µï¼Œä»æºå¤´ä¸Šé¿å…äº† False Sharingã€‚\n3. ä¸ºä»€ä¹ˆ cache miss åè€Œå‡é«˜äº†ï¼Ÿ #ç»“æ„ä½“é‡æ’å¯¹é½åï¼Œæ¯ä¸ªå˜é‡å æ® 64 å­—èŠ‚ç©ºé—´ï¼Œè€Œå®é™…ä¸Šåªç”¨äº†å…¶ä¸­ 4 å­—èŠ‚ï¼ˆintï¼‰ã€‚\nå±€éƒ¨æ€§ä¸‹é™ï¼š\nå¯¹é½å‰ å¯¹é½å å¤šä¸ªå˜é‡æŒ¤åœ¨ä¸€èµ·ï¼Œè®¿é—®æ—¶åªéœ€åŠ è½½ä¸€è¡Œ æ¯ä¸ªå˜é‡éƒ½è¦åŠ è½½ç‹¬ç«‹çš„ cache line ç»“æœï¼š\nmemory locality é™ä½ â‡’ cache miss ä¸Šå‡ ä½†æ ¸å¿ƒé—´åŒæ­¥å¤§å¹…å‡å°‘ â‡’ store latency é™ä½ è™½ç„¶å¼ºåˆ¶å¯¹é½å¯¼è‡´æ¯ä¸ªå˜é‡ç‹¬å ä¸€ä¸ª cache lineï¼Œcache miss æ•°é‡ä¸Šå‡ï¼Œ ä½†è¿™æœ‰æ•ˆé¿å…äº† False Sharing å¼•èµ·çš„ç¼“å­˜ä¸€è‡´æ€§å†²çªï¼Œæ¶ˆé™¤äº†æ ¸å¿ƒä¹‹é—´ å› ç«äº‰ cache line æ‰€å¸¦æ¥çš„å»¶è¿Ÿï¼Œæå‡äº†æ•´ä½“å¹¶å‘å†™å…¥æ€§èƒ½ã€‚\nè¿™æ˜¯ç»å…¸çš„â€œç©ºé—´æ¢æ—¶é—´â€ï¼šæé«˜ cache missï¼Œæ¢å–å‡å°‘æ ¸é—´å†²çª\n4. åŸå­å˜é‡ä¸ºä»€ä¹ˆæ…¢å¾—å¤šï¼Ÿ #std::atomic\u0026lt;T\u0026gt; è™½ç„¶ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œä½†å®ƒçš„è¯»å†™æ“ä½œæ¶‰åŠæ›´ä¸¥æ ¼çš„å†…å­˜åºè¯­ä¹‰ï¼š\nå³ä½¿ memory_order_relaxedï¼Œä¹Ÿä»å¯èƒ½è§¦å‘ CPU çš„ LOCK æŒ‡ä»¤ï¼ˆæˆ–å†…å­˜å±éšœï¼‰ å¤šæ ¸ä¹‹é—´å¿…é¡»å¯¹å†™å…¥åŸå­åŒæ­¥ï¼ˆæ— è®ºæ˜¯å¦ false sharingï¼‰ ç¼“å­˜ä¸€è‡´æ€§åè®®å¼€é”€å¤§ï¼ˆå°¤å…¶åœ¨ false sharing æƒ…å†µä¸‹ï¼‰ å› æ­¤åŸå­å˜é‡åœ¨å¹¶å‘å†™åœºæ™¯ä¸­ï¼Œè‡ªç„¶è¾ƒæ…¢ï¼Œå°¤å…¶æ˜¯åœ¨æœªå¯¹é½æ—¶ï¼ŒåŸå­æ“ä½œ + False Sharing æ˜¯æ€§èƒ½ç¾éš¾ç»„åˆã€‚\næ·±å…¥ç†è§£ç¼“å­˜ä¸€è‡´æ€§ä¸åŸå­æ“ä½œ #1. MESIç¼“å­˜ä¸€è‡´æ€§åè®®è¯¦è§£ #ç°ä»£CPUä½¿ç”¨MESIåè®®æ¥ç»´æŠ¤ç¼“å­˜ä¸€è‡´æ€§ï¼Œæ¯ä¸ªç¼“å­˜è¡Œæœ‰4ç§çŠ¶æ€ï¼š\n// MESIçŠ¶æ€è¯¦è§£ M (Modified): è¯¥CPUç‹¬å ä¸”å·²ä¿®æ”¹ï¼Œæ˜¯å”¯ä¸€çš„\u0026#34;æƒå¨\u0026#34;å‰¯æœ¬ E (Exclusive): è¯¥CPUç‹¬å ä½†æœªä¿®æ”¹ï¼Œä¸å†…å­˜ä¸€è‡´ S (Shared): å¤šä¸ªCPUå…±äº«ï¼Œéƒ½ä¸å†…å­˜ä¸€è‡´ I (Invalid): ç¼“å­˜è¡Œæ— æ•ˆï¼Œéœ€è¦é‡æ–°è·å– MESIåè®®çš„æ ¸å¿ƒè§„åˆ™ï¼š\nåŒä¸€æ—¶åˆ»ï¼Œåªèƒ½æœ‰ä¸€ä¸ªCPUæŒæœ‰ModifiedçŠ¶æ€çš„ç¼“å­˜è¡Œ ModifiedçŠ¶æ€æ„å‘³ç€è¯¥CPUæ‹¥æœ‰æœ€æ–°çš„ã€æƒå¨çš„æ•°æ® å…¶ä»–CPUè¦è®¿é—®æ—¶ï¼Œå¿…é¡»ä»ModifiedçŠ¶æ€çš„CPUè·å–æ•°æ® ä¸èƒ½ç›´æ¥ä»å†…å­˜è¯»å–ï¼Œå› ä¸ºå†…å­˜ä¸­çš„æ•°æ®å¯èƒ½æ˜¯è¿‡æœŸçš„ è¿™å°±æ˜¯ç¼“å­˜ä¸€è‡´æ€§çš„æ ¸å¿ƒï¼šç¡®ä¿æ‰€æœ‰CPUçœ‹åˆ°çš„éƒ½æ˜¯æœ€æ–°æ•°æ®ã€‚\n2. æ™®é€šå˜é‡ä¸åŸå­å˜é‡çš„å¯¹æ¯” #ç¼“å­˜è¡Œé”å®šæœºåˆ¶ #// æ™®é€šå˜é‡å†™å…¥æ—¶çš„ç¼“å­˜æ“ä½œï¼š CPU1: è·å–ç¼“å­˜è¡Œ â†’ ä¿®æ”¹æ•°æ® â†’ æ ‡è®°Modified CPU2: å‘ç°Invalid â†’ è¯·æ±‚æ•°æ® â†’ è·å– â†’ ä¿®æ”¹ â†’ æ ‡è®°Modified // åŸå­å˜é‡å†™å…¥æ—¶çš„é¢å¤–æ­¥éª¤ï¼š CPU1: è·å–ç¼“å­˜è¡Œ â†’ é”å®šç¼“å­˜è¡Œ â†’ åŸå­ä¿®æ”¹ â†’ é‡Šæ”¾é”å®š â†’ æ ‡è®°Modified CPU2: å‘ç°Invalid â†’ è¯·æ±‚æ•°æ® â†’ ç­‰å¾…é”å®šé‡Šæ”¾ â†’ è·å– â†’ é”å®š â†’ åŸå­ä¿®æ”¹... æ€»çº¿äº‰ç”¨åŠ å‰§ #åŸå­æ“ä½œå¯èƒ½ä½¿ç”¨LOCKå‰ç¼€ï¼Œè¿™ä¼šï¼š\né”å®šæ•´ä¸ªå†…å­˜æ€»çº¿(è€CPU) æˆ– ç¼“å­˜è¡Œ(æ–°CPU) å¼ºåˆ¶å…¶ä»–CPUç­‰å¾… åœ¨False sharingåœºæ™¯ä¸‹ï¼Œè¿™ç§ç­‰å¾…è¢«æ”¾å¤§ 3. ä¸ºä»€ä¹ˆåŸå­å˜é‡ + False sharingæ˜¯æœ€åæƒ…å†µ #// åŸå­å˜é‡ + False Sharing çš„å®Œæ•´å¼€é”€åˆ†è§£ï¼š 1. åŸå­æ“ä½œæœ¬èº«çš„å¼€é”€ (+100% åŸºå‡†æ—¶é—´) 2. False Sharingå¯¼è‡´çš„ç¼“å­˜å†²çª (+200% åŸºå‡†æ—¶é—´) 3. åŸå­æ“ä½œä¸ç¼“å­˜å†²çªçš„ç›¸äº’æ”¾å¤§ (+300% åŸºå‡†æ—¶é—´) 4. å†…å­˜å±éšœé˜»æ­¢CPUä¼˜åŒ– (+200% åŸºå‡†æ—¶é—´) ---------------------------------------- æ€»å¼€é”€ï¼š 800% åŸºå‡†æ—¶é—´ 4. CPUæŒ‡ä»¤å±‚é¢çš„å·®å¼‚ #æ™®é€šå˜é‡çš„å†™å…¥ ## æ™®é€šå˜é‡å†™å…¥ (*target = i) mov %eax, (%rdi) # ä¸€æ¡ç®€å•çš„å†…å­˜å†™å…¥æŒ‡ä»¤ åŸå­å˜é‡å†™å…¥ ## åŸå­å˜é‡å†™å…¥ (atomic.store(i, relaxed)) lock mov %eax, (%rdi) # LOCKå‰ç¼€ç¡®ä¿åŸå­æ€§ # æˆ–è€…ä½¿ç”¨æ›´å¤æ‚çš„æŒ‡ä»¤åºåˆ— mfence # å†…å­˜å±éšœï¼ˆæŸäº›å†…å­˜åºè¦æ±‚ï¼‰ mov %eax, (%rdi) 5. ç¼“å­˜ä¸€è‡´æ€§åè®®çš„å½±å“ #å½“å‘ç”ŸFalse sharingæ—¶ï¼Œä¸¤ç§æƒ…å†µçš„åŒºåˆ«ï¼š\næ™®é€šå˜é‡çš„ç¼“å­˜å†²çªè¿‡ç¨‹ #CPU1å†™å…¥æ™®é€šå˜é‡ â†’ ç¼“å­˜è¡ŒçŠ¶æ€å˜ä¸ºModified â†’ CPU2éœ€è¦å†™å…¥æ—¶å‘ç°ç¼“å­˜è¡ŒInvalid â†’ CPU2ä»CPU1è·å–æœ€æ–°ç¼“å­˜è¡Œ â†’ CPU2å†™å…¥ â†’ CPU1ç¼“å­˜è¡Œå˜ä¸ºInvalid â†’ å¾ªç¯å¾€å¤\nåŸå­å˜é‡çš„ç¼“å­˜å†²çªè¿‡ç¨‹ #CPU1æ‰§è¡ŒåŸå­å†™å…¥ â†’ LOCKæŒ‡ä»¤é”å®šæ€»çº¿/ç¼“å­˜è¡Œ â†’ ç¼“å­˜è¡ŒçŠ¶æ€å˜ä¸ºModified + é¢å¤–çš„åŸå­æ€§ä¿è¯ â†’ CPU2éœ€è¦åŸå­å†™å…¥æ—¶ä¸ä»…è¦è·å–ç¼“å­˜è¡Œï¼Œè¿˜è¦ç­‰å¾…åŸå­æ“ä½œå®Œæˆ â†’ CPU2æ‰§è¡ŒåŸå­å†™å…¥ï¼ˆå¯èƒ½éœ€è¦é¢å¤–çš„å†…å­˜å±éšœï¼‰ â†’ æ›´å¤æ‚çš„ç¼“å­˜ä¸€è‡´æ€§çŠ¶æ€è½¬æ¢\n6. å¾®æ¶æ„å±‚é¢çš„è¯¦ç»†åˆ†æ #Load-Storeå•å…ƒçš„å‹åŠ› #// æ™®é€šå˜é‡ï¼šLoad-Storeå•å…ƒå¯ä»¥å¹¶è¡Œå¤„ç†å¤šä¸ªæ“ä½œ store1: mov %eax, 0(%rdi) // å¯ä»¥ä¸ä¸‹é¢çš„æŒ‡ä»¤å¹¶è¡Œ store2: mov %ebx, 4(%rdi) store3: mov %ecx, 8(%rdi) // åŸå­å˜é‡ï¼šå¿…é¡»ä¸²è¡ŒåŒ–æ‰§è¡Œ atomic_store1: lock mov %eax, 0(%rdi) // å¿…é¡»ç­‰å¾…å®Œæˆ atomic_store2: lock mov %ebx, 4(%rdi) // æ‰èƒ½æ‰§è¡Œä¸‹ä¸€ä¸ª atomic_store3: lock mov %ecx, 8(%rdi) å®æˆ˜ä¼˜åŒ–å»ºè®® # åœºæ™¯ æ˜¯å¦æ¨è åŸå›  å¤šçº¿ç¨‹é¢‘ç¹å†™å…¥ä¸åŒå˜é‡ âœ… æ¨èä½¿ç”¨ alignas(64) åˆ†ç¦»å˜é‡ é¿å… False Sharing å°‘é‡å˜é‡å•çº¿ç¨‹å†™å…¥ âŒ ä¸å»ºè®®ä½¿ç”¨ alignas(64) æµªè´¹ç©ºé—´ï¼Œlocality ä¸‹é™ åŸå­å˜é‡å†™é¢‘ç¹å‡ºç° âœ… ä¿è¯å¯¹é½ï¼Œæ§åˆ¶çº¿ç¨‹æ•° é¿å…å¤šæ ¸å†²çª å¤šçº¿ç¨‹è¯»å†™æ··åˆ âš ï¸ è§†å…·ä½“è®¿é—®æ¨¡å¼ä¼˜åŒ– åŸå­ or lock free ç»“æ„æ›´é€‚åˆ æ€»ç»“ #False Sharing æ˜¯ç°ä»£å¤šæ ¸ç¼–ç¨‹ä¸­æœ€éšè”½ä½†æ€ä¼¤åŠ›æå¤§çš„æ€§èƒ½é™·é˜±ä¹‹ä¸€ã€‚å®ƒä¸ä¼šå¼•èµ·ç¨‹åºé€»è¾‘é”™è¯¯ï¼Œå´ä¼šä¸¥é‡æ‹–æ…¢ç³»ç»Ÿæ€§èƒ½ã€‚\nå¯¹é½å˜é‡ã€é¿å…å¤šä¸ªçº¿ç¨‹å†™å…¥åŒä¸€ Cache Lineï¼Œæ˜¯å¤„ç†å¹¶å‘æ—¶çš„åŸºæœ¬ä¼˜åŒ–æ“ä½œã€‚\næœ€åè®°ä½è¿™ä¸€å¥è¯ï¼š # \u0026ldquo;ä¸æ˜¯ä½ åœ¨å…±äº«å˜é‡ï¼Œè€Œæ˜¯ä½ åœ¨å…±äº«ç¼“å­˜è¡Œã€‚\u0026rdquo;\nå‚è€ƒèµ„æ–™ä¸ç›¸å…³é˜…è¯» # LockFreeäº‹ä»¶æ€»çº¿æ€§èƒ½ä¼˜åŒ–æ¡ˆä¾‹ï¼šè¯¦ç»†åˆ†æäº†False Sharingåœ¨äº‹ä»¶æ€»çº¿ä¸­çš„å½±å“åŠä¼˜åŒ–æ–¹æ³• é«˜æ€§èƒ½æœ¬åœ°å†…å­˜è®¢å•ç®¡ç†è®¾è®¡ï¼šè®¨è®ºäº†è®¢å•ç®¡ç†ç³»ç»Ÿä¸­å¦‚ä½•é¿å…False Sharingé—®é¢˜ å…±äº«å†…å­˜å¤šè¿›ç¨‹é€šä¿¡ä¼˜åŒ–ï¼šæ¢è®¨äº†åœ¨å…±äº«å†…å­˜åœºæ™¯ä¸­ä½¿ç”¨ç¼“å­˜è¡Œå¯¹é½é¿å…False Sharing æ¨¡æ¿ç±»å®ç°ä¸­çš„ç¼“å­˜ä¼˜åŒ–ï¼šå±•ç¤ºäº†åœ¨æ¨¡æ¿ç±»è®¾è®¡ä¸­å¦‚ä½•è€ƒè™‘ç¼“å­˜è¡Œå¯¹é½ é™„å½•ï¼šå®Œæ•´æµ‹è¯•ä»£ç  ##include \u0026lt;iostream\u0026gt; #include \u0026lt;thread\u0026gt; #include \u0026lt;chrono\u0026gt; #include \u0026lt;vector\u0026gt; #include \u0026lt;atomic\u0026gt; #include \u0026lt;iomanip\u0026gt; #include \u0026lt;cstring\u0026gt; #include \u0026lt;unistd.h\u0026gt; #include \u0026lt;algorithm\u0026gt; // ä¸ºstd::min_elementå’Œstd::max_elementæ·»åŠ  #include \u0026lt;cmath\u0026gt; // ä¸ºstd::sqrtæ·»åŠ  // æµ‹è¯•å‚æ•° constexpr int NUM_THREADS = 2; constexpr int ITERATIONS = 5000000; constexpr int NUM_RUNS = 5; // æ¯ä¸ªæµ‹è¯•è¿è¡Œå¤šæ¬¡å–å¹³å‡å€¼ // ä¸åŒçš„æµ‹è¯•ç”¨ä¾‹ç»“æ„ä½“ struct NormalFalseSharing { int counter1; int counter2; int counter3; int counter4; }; struct NormalNoFalseSharing { alignas(64) int counter1; alignas(64) int counter2; alignas(64) int counter3; alignas(64) int counter4; }; struct AtomicFalseSharing { std::atomic\u0026lt;int\u0026gt; counter1{0}; std::atomic\u0026lt;int\u0026gt; counter2{0}; std::atomic\u0026lt;int\u0026gt; counter3{0}; std::atomic\u0026lt;int\u0026gt; counter4{0}; }; struct AtomicNoFalseSharing { alignas(64) std::atomic\u0026lt;int\u0026gt; counter1{0}; alignas(64) std::atomic\u0026lt;int\u0026gt; counter2{0}; alignas(64) std::atomic\u0026lt;int\u0026gt; counter3{0}; alignas(64) std::atomic\u0026lt;int\u0026gt; counter4{0}; }; // è¾…åŠ©å‡½æ•° template\u0026lt;typename TimePoint\u0026gt; double get_duration_ms(TimePoint start, TimePoint end) { return std::chrono::duration\u0026lt;double, std::milli\u0026gt;(end - start).count(); } // æ¸…ç†ç³»ç»ŸçŠ¶æ€çš„å‡½æ•° void clear_system_state() { // å¼ºåˆ¶è¿›è¡Œåƒåœ¾å›æ”¶å’Œç¼“å­˜åˆ·æ–° std::this_thread::sleep_for(std::chrono::milliseconds(100)); // åˆ†é…å¹¶é‡Šæ”¾ä¸€äº›å†…å­˜æ¥\u0026#34;æ±¡æŸ“\u0026#34;ç¼“å­˜ volatile char* temp = new char[1024 * 1024]; // 1MB for (int i = 0; i \u0026lt; 1024 * 1024; i += 64) { temp[i] = i \u0026amp; 0xFF; } delete[] temp; std::this_thread::sleep_for(std::chrono::milliseconds(50)); } // å•ç‹¬çš„æµ‹è¯•å‡½æ•° class IndependentTest { public: enum TestType { NORMAL_FALSE_SHARING, NORMAL_NO_FALSE_SHARING, ATOMIC_FALSE_SHARING, ATOMIC_NO_FALSE_SHARING }; static double run_single_test(TestType type) { switch (type) { case NORMAL_FALSE_SHARING: return test_normal_false_sharing(); case NORMAL_NO_FALSE_SHARING: return test_normal_no_false_sharing(); case ATOMIC_FALSE_SHARING: return test_atomic_false_sharing(); case ATOMIC_NO_FALSE_SHARING: return test_atomic_no_false_sharing(); } return 0.0; } private: static double test_normal_false_sharing() { NormalFalseSharing data{}; auto start = std::chrono::high_resolution_clock::now(); std::vector\u0026lt;std::thread\u0026gt; threads; for (int t = 0; t \u0026lt; NUM_THREADS; ++t) { threads.emplace_back([\u0026amp;data, t]() { int* target = nullptr; switch(t) { case 0: target = \u0026amp;data.counter1; break; case 1: target = \u0026amp;data.counter2; break; case 2: target = \u0026amp;data.counter3; break; case 3: target = \u0026amp;data.counter4; break; } for (int i = 0; i \u0026lt; ITERATIONS; ++i) { *target = i; } }); } for (auto\u0026amp; thread : threads) { thread.join(); } auto end = std::chrono::high_resolution_clock::now(); return get_duration_ms(start, end); } static double test_normal_no_false_sharing() { NormalNoFalseSharing data{}; auto start = std::chrono::high_resolution_clock::now(); std::vector\u0026lt;std::thread\u0026gt; threads; for (int t = 0; t \u0026lt; NUM_THREADS; ++t) { threads.emplace_back([\u0026amp;data, t]() { int* target = nullptr; switch(t) { case 0: target = \u0026amp;data.counter1; break; case 1: target = \u0026amp;data.counter2; break; case 2: target = \u0026amp;data.counter3; break; case 3: target = \u0026amp;data.counter4; break; } for (int i = 0; i \u0026lt; ITERATIONS; ++i) { *target = i; } }); } for (auto\u0026amp; thread : threads) { thread.join(); } auto end = std::chrono::high_resolution_clock::now(); return get_duration_ms(start, end); } static double test_atomic_false_sharing() { AtomicFalseSharing data{}; auto start = std::chrono::high_resolution_clock::now(); std::vector\u0026lt;std::thread\u0026gt; threads; for (int t = 0; t \u0026lt; NUM_THREADS; ++t) { threads.emplace_back([\u0026amp;data, t]() { std::atomic\u0026lt;int\u0026gt;* target = nullptr; switch(t) { case 0: target = \u0026amp;data.counter1; break; case 1: target = \u0026amp;data.counter2; break; case 2: target = \u0026amp;data.counter3; break; case 3: target = \u0026amp;data.counter4; break; } for (int i = 0; i \u0026lt; ITERATIONS; ++i) { target-\u0026gt;store(i, std::memory_order_relaxed); } }); } for (auto\u0026amp; thread : threads) { thread.join(); } auto end = std::chrono::high_resolution_clock::now(); return get_duration_ms(start, end); } static double test_atomic_no_false_sharing() { AtomicNoFalseSharing data{}; auto start = std::chrono::high_resolution_clock::now(); std::vector\u0026lt;std::thread\u0026gt; threads; for (int t = 0; t \u0026lt; NUM_THREADS; ++t) { threads.emplace_back([\u0026amp;data, t]() { std::atomic\u0026lt;int\u0026gt;* target = nullptr; switch(t) { case 0: target = \u0026amp;data.counter1; break; case 1: target = \u0026amp;data.counter2; break; case 2: target = \u0026amp;data.counter3; break; case 3: target = \u0026amp;data.counter4; break; } for (int i = 0; i \u0026lt; ITERATIONS; ++i) { target-\u0026gt;store(i, std::memory_order_relaxed); } }); } for (auto\u0026amp; thread : threads) { thread.join(); } auto end = std::chrono::high_resolution_clock::now(); return get_duration_ms(start, end); } }; // ç»Ÿè®¡è¾…åŠ©å‡½æ•° struct TestResult { double min_time; double max_time; double avg_time; double stddev; TestResult(const std::vector\u0026lt;double\u0026gt;\u0026amp; times) { min_time = *std::min_element(times.begin(), times.end()); max_time = *std::max_element(times.begin(), times.end()); double sum = 0.0; for (double t : times) sum += t; avg_time = sum / times.size(); double variance = 0.0; for (double t : times) { variance += (t - avg_time) * (t - avg_time); } stddev = std::sqrt(variance / times.size()); } }; void run_test_suite(IndependentTest::TestType type, const std::string\u0026amp; name) { std::cout \u0026lt;\u0026lt; \u0026#34;\\n=== \u0026#34; \u0026lt;\u0026lt; name \u0026lt;\u0026lt; \u0026#34; ===\\n\u0026#34;; std::vector\u0026lt;double\u0026gt; times; for (int run = 0; run \u0026lt; NUM_RUNS; ++run) { std::cout \u0026lt;\u0026lt; \u0026#34;è¿è¡Œ \u0026#34; \u0026lt;\u0026lt; (run + 1) \u0026lt;\u0026lt; \u0026#34;/\u0026#34; \u0026lt;\u0026lt; NUM_RUNS \u0026lt;\u0026lt; \u0026#34;... \u0026#34;; std::cout.flush(); // æ¸…ç†ç³»ç»ŸçŠ¶æ€ clear_system_state(); // è¿è¡Œæµ‹è¯• double time = IndependentTest::run_single_test(type); times.push_back(time); std::cout \u0026lt;\u0026lt; std::fixed \u0026lt;\u0026lt; std::setprecision(1) \u0026lt;\u0026lt; time \u0026lt;\u0026lt; \u0026#34;ms\\n\u0026#34;; } TestResult result(times); std::cout \u0026lt;\u0026lt; \u0026#34;ç»“æœç»Ÿè®¡:\\n\u0026#34;; std::cout \u0026lt;\u0026lt; \u0026#34; å¹³å‡: \u0026#34; \u0026lt;\u0026lt; std::fixed \u0026lt;\u0026lt; std::setprecision(1) \u0026lt;\u0026lt; result.avg_time \u0026lt;\u0026lt; \u0026#34;ms\\n\u0026#34;; std::cout \u0026lt;\u0026lt; \u0026#34; æœ€å°: \u0026#34; \u0026lt;\u0026lt; result.min_time \u0026lt;\u0026lt; \u0026#34;ms\\n\u0026#34;; std::cout \u0026lt;\u0026lt; \u0026#34; æœ€å¤§: \u0026#34; \u0026lt;\u0026lt; result.max_time \u0026lt;\u0026lt; \u0026#34;ms\\n\u0026#34;; std::cout \u0026lt;\u0026lt; \u0026#34; æ ‡å‡†å·®: \u0026#34; \u0026lt;\u0026lt; std::setprecision(2) \u0026lt;\u0026lt; result.stddev \u0026lt;\u0026lt; \u0026#34;ms\\n\u0026#34;; std::cout \u0026lt;\u0026lt; \u0026#34; å˜å¼‚ç³»æ•°: \u0026#34; \u0026lt;\u0026lt; std::setprecision(1) \u0026lt;\u0026lt; (result.stddev / result.avg_time * 100) \u0026lt;\u0026lt; \u0026#34;%\\n\u0026#34;; } void show_system_info() { std::cout \u0026lt;\u0026lt; \u0026#34;=== ç³»ç»Ÿä¿¡æ¯ ===\\n\u0026#34;; std::cout \u0026lt;\u0026lt; \u0026#34;CPUæ ¸å¿ƒæ•°: \u0026#34; \u0026lt;\u0026lt; std:ğŸ§µ:hardware_concurrency() \u0026lt;\u0026lt; \u0026#34;\\n\u0026#34;; std::cout \u0026lt;\u0026lt; \u0026#34;sizeof(int): \u0026#34; \u0026lt;\u0026lt; sizeof(int) \u0026lt;\u0026lt; \u0026#34; å­—èŠ‚\\n\u0026#34;; std::cout \u0026lt;\u0026lt; \u0026#34;sizeof(std::atomic\u0026lt;int\u0026gt;): \u0026#34; \u0026lt;\u0026lt; sizeof(std::atomic\u0026lt;int\u0026gt;) \u0026lt;\u0026lt; \u0026#34; å­—èŠ‚\\n\u0026#34;; std::cout \u0026lt;\u0026lt; \u0026#34;ç¼“å­˜è¡Œå¤§å°: é€šå¸¸ä¸º64å­—èŠ‚\\n\u0026#34;; std::cout \u0026lt;\u0026lt; \u0026#34;æµ‹è¯•å‚æ•°: \u0026#34; \u0026lt;\u0026lt; NUM_THREADS \u0026lt;\u0026lt; \u0026#34; çº¿ç¨‹, \u0026#34; \u0026lt;\u0026lt; ITERATIONS \u0026lt;\u0026lt; \u0026#34; æ¬¡è¿­ä»£, \u0026#34; \u0026lt;\u0026lt; NUM_RUNS \u0026lt;\u0026lt; \u0026#34; æ¬¡è¿è¡Œ\\n\u0026#34;; } void show_memory_layout() { std::cout \u0026lt;\u0026lt; \u0026#34;\\n=== å†…å­˜å¸ƒå±€éªŒè¯ ===\\n\u0026#34;; NormalFalseSharing nfs{}; std::cout \u0026lt;\u0026lt; \u0026#34;æ™®é€šå˜é‡(False Sharing):\\n\u0026#34;; std::cout \u0026lt;\u0026lt; \u0026#34; counter1: \u0026#34; \u0026lt;\u0026lt; \u0026amp;nfs.counter1 \u0026lt;\u0026lt; \u0026#34;\\n\u0026#34;; std::cout \u0026lt;\u0026lt; \u0026#34; counter2: \u0026#34; \u0026lt;\u0026lt; \u0026amp;nfs.counter2 \u0026lt;\u0026lt; \u0026#34; (è·ç¦»: \u0026#34; \u0026lt;\u0026lt; (char*)\u0026amp;nfs.counter2 - (char*)\u0026amp;nfs.counter1 \u0026lt;\u0026lt; \u0026#34; å­—èŠ‚)\\n\u0026#34;; NormalNoFalseSharing nnfs{}; std::cout \u0026lt;\u0026lt; \u0026#34;æ™®é€šå˜é‡(æ— False Sharing):\\n\u0026#34;; std::cout \u0026lt;\u0026lt; \u0026#34; counter1: \u0026#34; \u0026lt;\u0026lt; \u0026amp;nnfs.counter1 \u0026lt;\u0026lt; \u0026#34;\\n\u0026#34;; std::cout \u0026lt;\u0026lt; \u0026#34; counter2: \u0026#34; \u0026lt;\u0026lt; \u0026amp;nnfs.counter2 \u0026lt;\u0026lt; \u0026#34; (è·ç¦»: \u0026#34; \u0026lt;\u0026lt; (char*)\u0026amp;nnfs.counter2 - (char*)\u0026amp;nnfs.counter1 \u0026lt;\u0026lt; \u0026#34; å­—èŠ‚)\\n\u0026#34;; } int main(int argc, char* argv[]) { if (argc != 2) { std::cout \u0026lt;\u0026lt; \u0026#34;ç”¨æ³•: \u0026#34; \u0026lt;\u0026lt; argv[0] \u0026lt;\u0026lt; \u0026#34; \u0026lt;test_number\u0026gt;\\n\u0026#34;; std::cout \u0026lt;\u0026lt; \u0026#34; 1: æ™®é€šå˜é‡ + False Sharing\\n\u0026#34;; std::cout \u0026lt;\u0026lt; \u0026#34; 2: æ™®é€šå˜é‡ + æ— False Sharing\\n\u0026#34;; std::cout \u0026lt;\u0026lt; \u0026#34; 3: åŸå­å˜é‡ + False Sharing\\n\u0026#34;; std::cout \u0026lt;\u0026lt; \u0026#34; 4: åŸå­å˜é‡ + æ— False Sharing\\n\u0026#34;; std::cout \u0026lt;\u0026lt; \u0026#34; 0: æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯å’Œå†…å­˜å¸ƒå±€\\n\u0026#34;; return 1; } int test_num = std::atoi(argv[1]); if (test_num == 0) { show_system_info(); show_memory_layout(); return 0; } show_system_info(); switch (test_num) { case 1: run_test_suite(IndependentTest::NORMAL_FALSE_SHARING, \u0026#34;æ™®é€šå˜é‡ + False Sharing\u0026#34;); break; case 2: run_test_suite(IndependentTest::NORMAL_NO_FALSE_SHARING, \u0026#34;æ™®é€šå˜é‡ + æ— False Sharing\u0026#34;); break; case 3: run_test_suite(IndependentTest::ATOMIC_FALSE_SHARING, \u0026#34;åŸå­å˜é‡ + False Sharing\u0026#34;); break; case 4: run_test_suite(IndependentTest::ATOMIC_NO_FALSE_SHARING, \u0026#34;åŸå­å˜é‡ + æ— False Sharing\u0026#34;); break; default: std::cout \u0026lt;\u0026lt; \u0026#34;æ— æ•ˆçš„æµ‹è¯•ç¼–å·: \u0026#34; \u0026lt;\u0026lt; test_num \u0026lt;\u0026lt; \u0026#34;\\n\u0026#34;; return 1; } return 0; } ","date":"23 June 2025","permalink":"/blog/2025-06-23-cache_false_sharing_analysis/","section":"Blog","summary":"ç›®å½• #1. å¼•è¨€ # False Sharingæ¦‚å¿µä»‹ç» æ–‡ç« ç ”ç©¶ç›®æ ‡ 2. æµ‹è¯•è®¾è®¡æ¦‚è§ˆ # æµ‹è¯•ç”¨ä¾‹çŸ©é˜µ æµ‹è¯•æ–¹æ³•è¯´æ˜ 3. æ ·ä¾‹è¿è¡Œç»“æœ # æ™®é€šå˜é‡ + False Sharing æ™®é€šå˜é‡ + æ— False Sharing åŸå­å˜é‡ + False Sharing åŸå­å˜é‡ + æ— False Sharing 4. ç°è±¡åˆ†æä¸åŸç†è§£é‡Š # False Sharingå¦‚ä½•é™ä½æ€§èƒ½ alignas(64)é¿å…False Sharingçš„åŸç† cache misså‡é«˜çš„åŸå› åˆ†æ åŸå­å˜é‡æ€§èƒ½å¼€é”€åˆ†æ 5. æ·±å…¥ç†è§£ç¼“å­˜ä¸€è‡´æ€§ä¸åŸå­æ“ä½œ # MESIç¼“å­˜ä¸€è‡´æ€§åè®®è¯¦è§£ æ™®é€šå˜é‡ä¸åŸå­å˜é‡çš„å¯¹æ¯” åŸå­å˜é‡ + False sharingçš„æ€§èƒ½å½±å“ CPUæŒ‡ä»¤å±‚é¢çš„å·®å¼‚ ç¼“å­˜ä¸€è‡´æ€§åè®®çš„å½±å“ å¾®æ¶æ„å±‚é¢çš„è¯¦ç»†åˆ†æ 6. å®æˆ˜ä¼˜åŒ–å»ºè®® # ä¸åŒåœºæ™¯çš„ä¼˜åŒ–ç­–ç•¥ 7. æ€»ç»“ # False Sharingçš„å…³é”®è¦ç‚¹ æ ¸å¿ƒç»“è®º 8. å‚è€ƒèµ„æ–™ä¸ç›¸å…³é˜…è¯» #9. é™„å½•ï¼šå®Œæ•´æµ‹è¯•ä»£ç  # å¼•è¨€ #åœ¨ç°ä»£å¤šæ ¸å¤„ç†å™¨æ¶æ„ä¸­ï¼Œç¼“å­˜ç³»ç»Ÿåœ¨æ€§èƒ½ä¸­æ‰®æ¼”ç€è‡³å…³é‡è¦çš„è§’è‰²ã€‚ç„¶è€Œï¼Œå½“å¤šä¸ªçº¿ç¨‹åŒæ—¶æ“ä½œä½äºåŒä¸€ç¼“å­˜è¡Œï¼ˆCache Lineï¼‰å†…çš„ä¸åŒå˜é‡æ—¶ï¼Œå³ä½¿å®ƒä»¬å¹¶æœªå…±äº«å˜é‡æœ¬èº«ï¼Œä¹Ÿå¯èƒ½å¯¼è‡´é¢‘ç¹çš„ç¼“å­˜ä¸€è‡´æ€§åè®®äº¤äº’ï¼Œè¿™å°±æ˜¯è‘—åçš„æ€§èƒ½æ€æ‰‹â€”â€”False Sharingã€‚","title":"æ·±å…¥ç†è§£ False Sharingï¼šå®æµ‹åŸå­æ“ä½œä¸ç¼“å­˜è¡Œå¯¹é½å¯¹æ€§èƒ½çš„å½±å“"},{"content":"æ‘˜è¦ #æœ¬æ–‡åˆ†æäº†C++åŸå­æ“ä½œä¸­ä¸åŒå†…å­˜åº(memory ordering)å¯¹æ€§èƒ½çš„å½±å“ï¼Œç‰¹åˆ«æ˜¯æ¯”è¾ƒäº†é»˜è®¤çš„é¡ºåºä¸€è‡´æ€§(seq_cst)ä¸å®½æ¾(relaxed)å†…å­˜åºåœ¨x86-64æ¶æ„ä¸Šçš„æ€§èƒ½å·®å¼‚ã€‚é€šè¿‡å®éªŒæµ‹è¯•ã€æ€§èƒ½åˆ†æå’Œæ±‡ç¼–ä»£ç æ£€æŸ¥ï¼Œæˆ‘ä»¬å‘ç°å³ä½¿åœ¨å†…å­˜æ¨¡å‹è¾ƒå¼ºçš„x86æ¶æ„ä¸Šï¼Œä¸åŒå†…å­˜åºçš„é€‰æ‹©ä»ç„¶ä¼šäº§ç”Ÿå¯æµ‹é‡çš„æ€§èƒ½å·®å¼‚ã€‚\n1. å®éªŒè®¾è®¡ #1.1 æµ‹è¯•ç¨‹åº #æˆ‘ä»¬è®¾è®¡äº†ä¸¤ä¸ªç‰ˆæœ¬çš„æµ‹è¯•ç¨‹åºï¼Œå®ƒä»¬åœ¨å›ºå®šæ—¶é—´å†…æ‰§è¡ŒåŸå­å˜é‡çš„è¯»å–å’Œè®¡æ•°æ“ä½œï¼Œå”¯ä¸€åŒºåˆ«æ˜¯åŸå­å˜é‡è¯»å–æ—¶ä½¿ç”¨çš„å†…å­˜åºä¸åŒï¼š\nseq_cstç‰ˆæœ¬ (é»˜è®¤å†…å­˜åº):\nvoid worker_seq_cst() { while (running_) { // é»˜è®¤ä½¿ç”¨ seq_cst counter_.fetch_add(1, std::memory_order_relaxed); busy_loop(); } } relaxedç‰ˆæœ¬ (æ˜¾å¼æŒ‡å®šå®½æ¾å†…å­˜åº):\nvoid worker_relaxed_load() { while (running_.load(std::memory_order_relaxed)) { counter_.fetch_add(1, std::memory_order_relaxed); busy_loop(); } } 1.2 ç¼–è¯‘ä¸æ‰§è¡Œç¯å¢ƒ #æµ‹è¯•ç¨‹åºä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç¼–è¯‘ï¼š\ng++ -std=c++11 -O0 -pthread atomic_test_seq_cst.cpp -o test_gcc_seq_cst g++ -std=c++11 -O0 -pthread atomic_test_relaxed.cpp -o test_gcc_relaxed æ¯ä¸ªç¨‹åºè¿è¡Œ5ç§’é’Ÿï¼Œè®°å½•åœ¨æ­¤æœŸé—´å®Œæˆçš„æ“ä½œæ¬¡æ•°ã€‚åŒæ—¶ä½¿ç”¨perfå·¥å…·æ”¶é›†æ€§èƒ½æ•°æ®ï¼š\nperf record -e cpu-clock:pppH ./test_gcc_seq_cst perf record -e cpu-clock:pppH ./test_gcc_relaxed 2. å®éªŒç»“æœ #2.1 æ‰§è¡Œè®¡æ•°ç»“æœ # ç‰ˆæœ¬ æ“ä½œè®¡æ•° seq_cst 26,494,108 relaxed 26,660,082 æ€§èƒ½å·®å¼‚ï¼š\nç»å¯¹å·®å¼‚ï¼š165,974æ¬¡æ“ä½œ ç›¸å¯¹æå‡ï¼š0.63% 2.2 perfåˆ†æç»“æœ #seq_cstç‰ˆæœ¬:\nSamples: 4K of event \u0026#39;cpu-clock:pppH\u0026#39;, Event count (approx.): 4994994990 Children Self Command Symbol 95.23% 95.21% test_gcc_seq_cs busy_loop 99.44% 2.91% test_gcc_seq_cs worker_seq_cst 1.06% 0.84% test_gcc_seq_cs std::atomic\u0026lt;bool\u0026gt;::operator bool 0.54% 0.54% test_gcc_seq_cs std::__is_constant_evaluated relaxedç‰ˆæœ¬:\nSamples: 4K of event \u0026#39;cpu-clock:pppH\u0026#39;, Event count (approx.): 4991991987 Children Self Command Symbol 99.22% 3.23% test_gcc_relaxe worker_relaxed_load 94.61% 94.61% test_gcc_relaxe busy_loop 1.64% 1.30% test_gcc_relaxe std::atomic\u0026lt;bool\u0026gt;::load 0.42% 0.42% test_gcc_relaxe std::__is_constant_evaluated ä¸relaxedç‰ˆæœ¬çš„æ¯”è¾ƒåˆ†æ å°†è¿™äº›æ•°æ®ä¸relaxedç‰ˆæœ¬å¯¹æ¯”ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å‡ ä¸ªå…³é”®å·®å¼‚ï¼š\nåŸå­æ“ä½œå‡½æ•°ï¼š\nseq_cst: std::atomic\u0026lt;bool\u0026gt;::operator bool å ç”¨ 1.06%ï¼ˆSelf: 0.84%ï¼‰ relaxed: std::atomic\u0026lt;bool\u0026gt;::load å ç”¨ 1.64%ï¼ˆSelf: 1.30%ï¼‰ workerå‡½æ•°è‡ªèº«å¼€é”€ï¼š\nseq_cst: worker_seq_cst è‡ªèº«å ç”¨ 2.91% relaxed: worker_relaxed_load è‡ªèº«å ç”¨ 3.23% busy_loopå æ¯”ï¼š\nseq_cst: busy_loop Children å ç”¨ 95.23%ï¼ŒSelf å ç”¨ 95.21% relaxed: busy_loop Children å ç”¨ 94.61%ï¼ŒSelf å ç”¨ 94.61% æ€§èƒ½å·®å¼‚è§£é‡Š åŸºäºè¿™äº›æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥è§£é‡Šseq_cstå’Œrelaxedç‰ˆæœ¬ä¹‹é—´0.63%çš„æ€§èƒ½å·®å¼‚ï¼š\nå‡½æ•°è°ƒç”¨è·¯å¾„ä¸åŒï¼š\nseq_cstç‰ˆæœ¬è°ƒç”¨ operator bool()ï¼Œè¿™æ˜¯ä¸€ä¸ªéšå¼è½¬æ¢å‡½æ•° relaxedç‰ˆæœ¬ç›´æ¥è°ƒç”¨ load() å‡½æ•°å¹¶æ˜ç¡®æŒ‡å®šå†…å­˜åº å†…éƒ¨å®ç°å·®å¼‚ï¼š\noperator bool() å†…éƒ¨å¯èƒ½åŒ…å«é¢å¤–çš„æ£€æŸ¥æˆ–è½¬æ¢é€»è¾‘ load() å‡½æ•°å¯èƒ½æœ‰æ›´ç›´æ¥çš„å®ç°è·¯å¾„ ç¼–è¯‘å™¨ä¼˜åŒ–å·®å¼‚ï¼š\næ˜¾å¼æŒ‡å®š memory_order_relaxed å¯èƒ½å…è®¸ç¼–è¯‘å™¨è¿›è¡Œæ›´å¤šä¼˜åŒ– é»˜è®¤çš„ seq_cst å¯èƒ½é™åˆ¶äº†æŸäº›é‡æ’åºä¼˜åŒ– CPUå¾®æ¶æ„å½±å“ï¼š\nä¸åŒçš„å‡½æ•°è°ƒç”¨è·¯å¾„å¯èƒ½å¯¼è‡´ä¸åŒçš„æŒ‡ä»¤ç¼“å­˜å’Œåˆ†æ”¯é¢„æµ‹è¡Œä¸º seq_cst è¯­ä¹‰å¯èƒ½éšå«åœ°å½±å“CPUçš„æŠ•æœºæ‰§è¡Œç­–ç•¥ 2.3 å…³é”®æ±‡ç¼–ä»£ç å¯¹æ¯” #relaxedç‰ˆæœ¬:\n.L27: mov esi, 0 # memory_order_relaxedå‚æ•°(0) mov edi, OFFSET FLAT:running_ # thisæŒ‡é’ˆ call std::atomic\u0026lt;bool\u0026gt;::load(std::memory_order) const test al, al jne .L29 seq_cstç‰ˆæœ¬:\n.L31: mov edi, OFFSET FLAT:running_ # thisæŒ‡é’ˆ call std::atomic\u0026lt;bool\u0026gt;::operator bool() const test al, al jne .L33 2.4 O0ä¼˜åŒ–ä¸‹çš„æ±‡ç¼–å·®å¼‚åˆ†æ #ä»¥ä¸‹ä¸º gcc 15.1ï¼ŒO0 ä¼˜åŒ–ä¸‹çš„å…³é”®æ±‡ç¼–ç‰‡æ®µï¼š Godbolt åœ¨çº¿æ±‡ç¼–å·¥å…·\nworker_relaxed_load(): ... mov esi, 0 mov edi, OFFSET FLAT:running_ call std::atomic\u0026lt;bool\u0026gt;::load(std::memory_order) const test al, al jne .L19 ... worker_seq_cst(): ... mov edi, OFFSET FLAT:running_ call std::atomic\u0026lt;bool\u0026gt;::operator bool() const test al, al jne .L23 ... å·®å¼‚åˆ†æ # æ¡ä»¶åˆ¤æ–­æ–¹å¼ä¸åŒ\nworker_relaxed_load æ˜¾å¼ä¼ é€’ memory_order å‚æ•°ï¼ˆesi, 0ï¼‰ï¼Œè°ƒç”¨ load(std::memory_order) constã€‚ worker_seq_cst ç›´æ¥è°ƒç”¨ operator bool() constï¼Œä¸ä¼ é€’å†…å­˜åºå‚æ•°ã€‚ å‡½æ•°è°ƒç”¨è·¯å¾„\nrelaxed ç‰ˆæœ¬çš„ while æ¡ä»¶æ˜¯ running_.load(std::memory_order_relaxed)ï¼Œå¯¹åº”è°ƒç”¨ loadï¼Œå¹¶ä¼ é€’å†…å­˜åºå‚æ•°ã€‚ seq_cst ç‰ˆæœ¬çš„ while æ¡ä»¶æ˜¯ while (running_)ï¼Œå¯¹åº”è°ƒç”¨ operator bool()ï¼Œå…¶å†…éƒ¨é»˜è®¤ memory_order_seq_cstã€‚ æ ¸å¿ƒåŸå­æ“ä½œä¸€è‡´\nä¸¤ä¸ªç‰ˆæœ¬çš„ counter_.fetch_add(1, std::memory_order_relaxed) éƒ½å¯¹åº” lock xadd æŒ‡ä»¤ï¼Œè¯´æ˜å¢æ“ä½œæœ¬èº«æ— å·®å¼‚ã€‚ busy_loopå®ç°ä¸€è‡´\nä¸¤ä¸ªç‰ˆæœ¬éƒ½è°ƒç”¨ busy_loop()ï¼Œå…¶å®ç°å®Œå…¨ç›¸åŒã€‚ O0ä¸‹çš„é¢å¤–å¼€é”€\nç”±äºO0æœªåšä¼˜åŒ–ï¼Œå‡½æ•°è°ƒç”¨ã€æ ˆå¸§åˆ†é…ç­‰æŒ‡ä»¤è¾ƒå¤šï¼ŒçœŸå®å·®å¼‚ä¸»è¦ä½“ç°åœ¨æ¡ä»¶åˆ¤æ–­çš„å‡½æ•°è°ƒç”¨è·¯å¾„ã€‚ æ€»ç»“ # O0ä¼˜åŒ–ä¸‹ï¼Œworker_relaxed_load å’Œ worker_seq_cst çš„ä¸»è¦å·®å¼‚ä½“ç°åœ¨å¯¹ running_ çš„åˆ¤æ–­æ–¹å¼ï¼šä¸€ä¸ªæ˜¯æ˜¾å¼ loadï¼Œä¸€ä¸ªæ˜¯éšå¼ operator bool()ã€‚ è¿™ä¸perfåˆ†æå’Œé«˜ä¼˜åŒ–çº§åˆ«ä¸‹çš„ç»“è®ºä¸€è‡´ï¼šä¸¤è€…çš„æ ¸å¿ƒåŸå­æ“ä½œå®ç°æ— å·®å¼‚ï¼Œæ€§èƒ½å·®å¼‚ä¸»è¦æ¥è‡ªäºæ¡ä»¶åˆ¤æ–­çš„å‡½æ•°è°ƒç”¨è·¯å¾„å’Œç¼–è¯‘å™¨å¯¹å†…å­˜åºçš„å¤„ç†ã€‚ åœ¨O0ä¸‹ï¼Œæ‰€æœ‰å‡½æ•°è°ƒç”¨å’Œå‚æ•°ä¼ é€’éƒ½è¢«å®Œæ•´ä¿ç•™ï¼Œè¿›ä¸€æ­¥æ”¾å¤§äº†è°ƒç”¨è·¯å¾„çš„å·®å¼‚ã€‚ 3. åˆ†æä¸è®¨è®º #3.1 æ€§èƒ½å·®å¼‚åˆ†æ #å®éªŒç»“æœæ˜¾ç¤ºï¼Œrelaxedç‰ˆæœ¬åœ¨ç›¸åŒæ—¶é—´å†…å®Œæˆäº†æ›´å¤šæ“ä½œ(0.63%çš„æå‡)ã€‚è¿™ä¸ªå·®å¼‚è™½å°ï¼Œä½†åœ¨é«˜é¢‘æ“ä½œåœºæ™¯ä¸­å…·æœ‰å®é™…æ„ä¹‰ã€‚\næœ‰è¶£çš„æ˜¯ï¼Œperfæ•°æ®æ˜¾ç¤ºrelaxedç‰ˆæœ¬åœ¨åŸå­æ“ä½œä¸ŠèŠ±è´¹äº†æ›´å¤§æ¯”ä¾‹çš„CPUæ—¶é—´(1.64% vs 1.06%)ï¼Œä½†æ€»ä½“ååé‡ä»ç„¶æ›´é«˜ã€‚è¿™è¡¨æ˜ï¼š\nrelaxedç‰ˆæœ¬è™½ç„¶åœ¨åŸå­æ“ä½œä¸ŠèŠ±è´¹äº†æ›´å¤šæ—¶é—´æ¯”ä¾‹ï¼Œä½†æ¯æ¬¡æ“ä½œçš„å®é™…å¼€é”€æ›´å° seq_cstç‰ˆæœ¬å¯èƒ½æœ‰éšå«çš„å¼€é”€ï¼Œå¯¼è‡´æ•´ä½“æ‰§è¡Œæ•ˆç‡ç•¥ä½ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œperfæ•°æ®æ˜¾ç¤ºrelaxedç‰ˆæœ¬çš„std::atomic::loadçš„è‡ªè€—ï¼ˆSelfï¼‰åè€Œæ¯”operator boolæ›´é«˜ï¼Œè¿™è¯´æ˜å•æ¬¡loadçš„å¼€é”€å¹¶ä¸ä¸€å®šæ›´ä½ã€‚æ•´ä½“ååé‡ç•¥é«˜ï¼Œå¯èƒ½æ˜¯å› ä¸ºç¼–è¯‘å™¨å¯¹relaxedè·¯å¾„åšäº†æ›´æ¿€è¿›çš„ä¼˜åŒ–ï¼Œæˆ–è€…è°ƒç”¨é“¾æ›´çŸ­ã€åˆ†æ”¯é¢„æµ‹æ•ˆæœæ›´å¥½ã€‚æ±‡ç¼–å±‚é¢ï¼Œä¸¤è€…çš„ä¸»è¦å·®å¼‚ä»…åœ¨äºloadçš„è°ƒç”¨æ–¹å¼å’Œå‚æ•°ä¼ é€’ï¼Œå®é™…æŒ‡ä»¤æ•°é‡å’Œå¤æ‚åº¦å·®å¼‚æå°ã€‚\n3.2 æ±‡ç¼–ä»£ç å·®å¼‚åˆ†æ #æ±‡ç¼–ä»£ç åˆ†ææ­ç¤ºäº†æ€§èƒ½å·®å¼‚çš„æ ¹æœ¬åŸå› ï¼š\nå‡½æ•°è°ƒç”¨å·®å¼‚ï¼š\nseq_cstç‰ˆæœ¬è°ƒç”¨operator bool() relaxedç‰ˆæœ¬è°ƒç”¨load(std::memory_order_relaxed) ç›¸åŒç‚¹ï¼š\nä¸¤ä¸ªç‰ˆæœ¬çš„busy_loopå®ç°å®Œå…¨ç›¸åŒ ä¸¤ä¸ªç‰ˆæœ¬çš„counter_.fetch_addæ“ä½œéƒ½ä½¿ç”¨ç›¸åŒçš„lock xaddæŒ‡ä»¤ å…³é”®å‘ç°ï¼š\nåœ¨O2ä¼˜åŒ–çº§åˆ«ä¸‹ï¼Œä¸¤ä¸ªç‰ˆæœ¬çš„æ ¸å¿ƒåŸå­æ“ä½œæŒ‡ä»¤ç›¸åŒ å·®å¼‚ä¸»è¦æ¥è‡ªå‡½æ•°è°ƒç”¨è·¯å¾„ï¼Œè€ŒéåŸå­æ“ä½œæœ¬èº«çš„å®ç° 3.3 å†…å­˜åºå¯¹æ€§èƒ½çš„å½±å“æœºåˆ¶ #åœ¨x86-64æ¶æ„ä¸Šï¼Œloadæ“ä½œæœ¬èº«ä¸éœ€è¦é¢å¤–çš„å†…å­˜å±éšœï¼Œæ— è®ºæ˜¯seq_cstè¿˜æ˜¯relaxedã€‚ç„¶è€Œï¼Œå·®å¼‚å¯èƒ½æ¥è‡ªä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š\nå‡½æ•°è°ƒç”¨å¼€é”€ï¼š\noperator bool()å¯èƒ½æœ‰é¢å¤–çš„è½¬æ¢é€»è¾‘ ä¸åŒå‡½æ•°å¯èƒ½æœ‰ä¸åŒçš„å†…è”å’Œä¼˜åŒ–ç­–ç•¥ ç¼–è¯‘å™¨ä¼˜åŒ–ï¼š\næ˜¾å¼æŒ‡å®šmemory_order_relaxedå¯èƒ½å…è®¸ç¼–è¯‘å™¨è¿›è¡Œæ›´å¤šä¼˜åŒ– é»˜è®¤çš„seq_cstå¯èƒ½é™åˆ¶äº†æŸäº›é‡æ’åºä¼˜åŒ– CPUå¾®æ¶æ„å½±å“ï¼š\nä¸åŒçš„å‡½æ•°è°ƒç”¨è·¯å¾„å¯èƒ½å¯¼è‡´ä¸åŒçš„ç¼“å­˜è¡Œä¸ºå’Œåˆ†æ”¯é¢„æµ‹æ•ˆæœ seq_cstå¯èƒ½éšå«åœ°å½±å“CPUçš„æŠ•æœºæ‰§è¡Œç­–ç•¥ 4. ç»“è®ºä¸å®è·µå»ºè®® #æœ¬ç ”ç©¶è¡¨æ˜ï¼Œå³ä½¿åœ¨x86-64è¿™æ ·çš„å¼ºå†…å­˜æ¨¡å‹æ¶æ„ä¸Šï¼Œé€‰æ‹©é€‚å½“çš„å†…å­˜åºä»ç„¶å¯ä»¥å¸¦æ¥å¯æµ‹é‡çš„æ€§èƒ½æå‡ã€‚è™½ç„¶å·®å¼‚ä¸å¤§(0.63%)ï¼Œä½†åœ¨é«˜æ€§èƒ½è®¡ç®—æˆ–é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­ï¼Œè¿™ç§ç§¯ç´¯çš„å·®å¼‚å¯èƒ½å…·æœ‰å®é™…æ„ä¹‰ã€‚\nè¡¥å……è¯´æ˜ï¼š é€šè¿‡perfå’Œæ±‡ç¼–åˆ†æå¯ä»¥ç¡®è®¤ï¼Œrelaxedå’Œé»˜è®¤seq_cstçš„ä¸»è¦æ€§èƒ½å·®å¼‚ï¼Œæ¥æºäºå¯¹åŸå­å˜é‡running_çš„åˆ¤æ–­æ–¹å¼ï¼ˆå³loadçš„è°ƒç”¨è·¯å¾„å’Œå‚æ•°ä¼ é€’ï¼‰ï¼Œè€Œéæ ¸å¿ƒåŸå­æ“ä½œæœ¬èº«ã€‚ä¸¤è€…çš„æ€§èƒ½å·®å¼‚æå°ï¼ˆæœ¬å®éªŒçº¦0.6%ï¼‰ï¼Œä»…åœ¨æé«˜é¢‘åœºæ™¯ä¸‹æ‰æœ‰å®é™…æ„ä¹‰ã€‚å®é™…å¼€å‘ä¸­ï¼Œåªæœ‰åœ¨ä¸éœ€è¦å¼ºå†…å­˜åºä¿è¯æ—¶ï¼Œæ‰å»ºè®®ä½¿ç”¨relaxedï¼Œå¹¶åº”ä»¥å®é™…æµ‹é‡ä¸ºå‡†ã€‚\nå®è·µå»ºè®®ï¼š\nåœ¨ä¸éœ€è¦å¼ºå†…å­˜åºä¿è¯çš„åœºæ™¯ä¸­ï¼Œä½¿ç”¨relaxedå†…å­˜åºå¯ä»¥è·å¾—æ›´å¥½çš„æ€§èƒ½ æ€§èƒ½å…³é”®è·¯å¾„ä¸Šçš„åŸå­æ“ä½œåº”å½“ä»”ç»†é€‰æ‹©é€‚å½“çš„å†…å­˜åº å³ä½¿åœ¨x86æ¶æ„ä¸Šï¼Œå†…å­˜åºçš„é€‰æ‹©ä¹Ÿä¼šå½±å“æ€§èƒ½ï¼Œä¸åº”è¢«å¿½è§† åœ¨è¿›è¡Œæ€§èƒ½ä¼˜åŒ–æ—¶ï¼Œåº”å½“é€šè¿‡å®é™…æµ‹é‡æ¥éªŒè¯ä¸åŒå†…å­˜åºçš„å½±å“ 5. æœªæ¥å·¥ä½œ #æœªæ¥å¯ä»¥æ‰©å±•æœ¬ç ”ç©¶ï¼Œæ¢ç´¢ä»¥ä¸‹æ–¹å‘ï¼š\nåœ¨ä¸åŒCPUæ¶æ„(å¦‚ARMã€POWER)ä¸Šè¿›è¡Œç±»ä¼¼æµ‹è¯• æµ‹è¯•å¤šçº¿ç¨‹ç«äº‰åœºæ™¯ä¸‹ä¸åŒå†…å­˜åºçš„æ€§èƒ½å·®å¼‚ åˆ†æä¸åŒç¼–è¯‘å™¨å’Œä¼˜åŒ–çº§åˆ«å¯¹å†…å­˜åºæ€§èƒ½çš„å½±å“ æ¢ç´¢æ›´å¤æ‚çš„åŸå­æ“ä½œæ¨¡å¼(å¦‚RMWæ“ä½œ)ä¸‹å†…å­˜åºçš„æ€§èƒ½å½±å“ é™„å½•ï¼šå®Œæ•´æµ‹è¯•ä»£ç  ##include \u0026lt;atomic\u0026gt; #include \u0026lt;thread\u0026gt; #include \u0026lt;iostream\u0026gt; #include \u0026lt;chrono\u0026gt; // åŸå­å˜é‡ std::atomic\u0026lt;bool\u0026gt; running_{true}; std::atomic\u0026lt;int\u0026gt; counter_{0}; // æ¨¡æ‹Ÿå¿™ç­‰ï¼Œé¿å…è¢«ä¼˜åŒ– inline void busy_loop() { for (volatile int i = 0; i \u0026lt; 100; ++i); } // é»˜è®¤ç‰ˆæœ¬ï¼šéšå¼ seq_cst void worker_seq_cst() { while (running_) { // é»˜è®¤ seq_cst counter_.fetch_add(1, std::memory_order_relaxed); // åªæµ‹ load busy_loop(); } } // relaxed load ç‰ˆæœ¬ void worker_relaxed_load() { while (running_.load(std::memory_order_relaxed)) { counter_.fetch_add(1, std::memory_order_relaxed); // ä¿æŒä¸€è‡´ busy_loop(); } } int main() { running_ = true; counter_ = 0; std::thread t(worker_seq_cst); // è¿è¡Œè¶³å¤Ÿé•¿æ—¶é—´ä»¥ä¾¿perfæ”¶é›†æ•°æ® std::this_thread::sleep_for(std::chrono::seconds(5)); running_.store(false); t.join(); std::cout \u0026lt;\u0026lt; \u0026#34;å®Œæˆæµ‹è¯•ï¼Œè®¡æ•°: \u0026#34; \u0026lt;\u0026lt; counter_.load() \u0026lt;\u0026lt; std::endl; return 0; } ","date":"21 June 2025","permalink":"/blog/2025-06-21-memory_order_performance_analysis/","section":"Blog","summary":"æ‘˜è¦ #æœ¬æ–‡åˆ†æäº†C++åŸå­æ“ä½œä¸­ä¸åŒå†…å­˜åº(memory ordering)å¯¹æ€§èƒ½çš„å½±å“ï¼Œç‰¹åˆ«æ˜¯æ¯”è¾ƒäº†é»˜è®¤çš„é¡ºåºä¸€è‡´æ€§(seq_cst)ä¸å®½æ¾(relaxed)å†…å­˜åºåœ¨x86-64æ¶æ„ä¸Šçš„æ€§èƒ½å·®å¼‚ã€‚é€šè¿‡å®éªŒæµ‹è¯•ã€æ€§èƒ½åˆ†æå’Œæ±‡ç¼–ä»£ç æ£€æŸ¥ï¼Œæˆ‘ä»¬å‘ç°å³ä½¿åœ¨å†…å­˜æ¨¡å‹è¾ƒå¼ºçš„x86æ¶æ„ä¸Šï¼Œä¸åŒå†…å­˜åºçš„é€‰æ‹©ä»ç„¶ä¼šäº§ç”Ÿå¯æµ‹é‡çš„æ€§èƒ½å·®å¼‚ã€‚\n1. å®éªŒè®¾è®¡ #1.1 æµ‹è¯•ç¨‹åº #æˆ‘ä»¬è®¾è®¡äº†ä¸¤ä¸ªç‰ˆæœ¬çš„æµ‹è¯•ç¨‹åºï¼Œå®ƒä»¬åœ¨å›ºå®šæ—¶é—´å†…æ‰§è¡ŒåŸå­å˜é‡çš„è¯»å–å’Œè®¡æ•°æ“ä½œï¼Œå”¯ä¸€åŒºåˆ«æ˜¯åŸå­å˜é‡è¯»å–æ—¶ä½¿ç”¨çš„å†…å­˜åºä¸åŒï¼š\nseq_cstç‰ˆæœ¬ (é»˜è®¤å†…å­˜åº):\nvoid worker_seq_cst() { while (running_) { // é»˜è®¤ä½¿ç”¨ seq_cst counter_.fetch_add(1, std::memory_order_relaxed); busy_loop(); } } relaxedç‰ˆæœ¬ (æ˜¾å¼æŒ‡å®šå®½æ¾å†…å­˜åº):\nvoid worker_relaxed_load() { while (running_.load(std::memory_order_relaxed)) { counter_.fetch_add(1, std::memory_order_relaxed); busy_loop(); } } 1.2 ç¼–è¯‘ä¸æ‰§è¡Œç¯å¢ƒ #æµ‹è¯•ç¨‹åºä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç¼–è¯‘ï¼š\ng++ -std=c++11 -O0 -pthread atomic_test_seq_cst.cpp -o test_gcc_seq_cst g++ -std=c++11 -O0 -pthread atomic_test_relaxed.cpp -o test_gcc_relaxed æ¯ä¸ªç¨‹åºè¿è¡Œ5ç§’é’Ÿï¼Œè®°å½•åœ¨æ­¤æœŸé—´å®Œæˆçš„æ“ä½œæ¬¡æ•°ã€‚åŒæ—¶ä½¿ç”¨perfå·¥å…·æ”¶é›†æ€§èƒ½æ•°æ®ï¼š\nperf record -e cpu-clock:pppH ./test_gcc_seq_cst perf record -e cpu-clock:pppH ./test_gcc_relaxed 2. å®éªŒç»“æœ #2.1 æ‰§è¡Œè®¡æ•°ç»“æœ # ç‰ˆæœ¬ æ“ä½œè®¡æ•° seq_cst 26,494,108 relaxed 26,660,082 æ€§èƒ½å·®å¼‚ï¼š","title":"C++åŸå­æ“ä½œå†…å­˜åºæ€§èƒ½åˆ†æï¼šseq_cst vs relaxed"},{"content":"æ¦‚è¿° #æœ¬æ–‡é’ˆå¯¹ç°æœ‰çš„LockFreeEventBuså®ç°è¿›è¡Œæ·±å…¥çš„æ€§èƒ½åˆ†æå’Œä¼˜åŒ–å»ºè®®ã€‚å½“å‰å®ç°é‡‡ç”¨äº†ä»¥ä¸‹æ ¸å¿ƒè®¾è®¡ï¼š\näº‹ä»¶ä¸å¤„ç†å‡½æ•°æ˜ å°„ï¼šä½¿ç”¨std::unordered_mapå»ºç«‹äº‹ä»¶ç±»å‹åˆ°å¤„ç†å‡½æ•°çš„æ˜ å°„å…³ç³» å¤„ç†å‡½æ•°å­˜å‚¨ï¼šä½¿ç”¨std::vectorå­˜å‚¨æ¯ç§äº‹ä»¶ç±»å‹å¯¹åº”çš„å¤„ç†å‡½æ•°åˆ—è¡¨ äº‹ä»¶åˆ†å‘æœºåˆ¶ï¼šåœ¨é«˜é¢‘è°ƒç”¨åœºæ™¯ä¸‹ä½¿ç”¨RTTIï¼ˆè¿è¡Œæ—¶ç±»å‹è¯†åˆ«ï¼‰æœºåˆ¶è¿›è¡Œäº‹ä»¶åˆ†å‘ å†…å­˜ç®¡ç†ï¼šå¤§é‡ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆè¿›è¡Œäº‹ä»¶å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸç®¡ç† è™½ç„¶è¿™ç§è®¾è®¡åœ¨åŠŸèƒ½ä¸Šå®Œæ•´å¯é ï¼Œä½†åœ¨é«˜é¢‘äº¤æ˜“ç­‰å¯¹å»¶è¿Ÿæåº¦æ•æ„Ÿçš„åœºæ™¯ä¸‹å­˜åœ¨æ˜¾è‘—çš„æ€§èƒ½ç“¶é¢ˆã€‚æœ¬æ–‡å°†è¯¦ç»†åˆ†æè¿™äº›ç“¶é¢ˆçš„æ ¹æœ¬åŸå› ï¼Œå¹¶æå‡ºé’ˆå¯¹æ€§çš„ä¼˜åŒ–å»ºè®®ã€‚\næ³¨æ„ï¼šæœ¬æ–‡æ˜¯æ·±å…¥ç†è§£æ— é”é˜Ÿåˆ—ï¼šä»åŸç†åˆ°å®è·µçš„å®Œæ•´æŒ‡å—çš„é…å¥—æ€§èƒ½åˆ†ææ–‡ç« ï¼Œå»ºè®®å…ˆé˜…è¯»è¯¥æ–‡ç« äº†è§£æ— é”é˜Ÿåˆ—çš„åŸºæœ¬åŸç†ã€‚\n1. æ ¸å¿ƒå·¥ä½œæœºåˆ¶ #1.1 åŸºæœ¬æ¶æ„ #LockFreeEventBusé‡‡ç”¨æ— é”é˜Ÿåˆ—å’Œå·¥ä½œçº¿ç¨‹çš„ç»„åˆï¼Œå®ç°äº‹ä»¶çš„å¼‚æ­¥å¤„ç†ï¼š\nclass LockFreeEventBus { private: LockFreeQueueEvent\u0026lt;std::shared_ptr\u0026lt;Event\u0026gt;\u0026gt; event_queue_; std::unordered_map\u0026lt;std::type_index, std::vector\u0026lt;std::function\u0026lt;void(std::shared_ptr\u0026lt;Event\u0026gt;)\u0026gt;\u0026gt;\u0026gt; handlers_; std::atomic\u0026lt;bool\u0026gt; running_; std::thread worker_thread_; // ... }; å…³é”®ç»„ä»¶ï¼š\nevent_queue_ï¼šæ— é”é˜Ÿåˆ—ï¼Œå­˜å‚¨å¾…å¤„ç†äº‹ä»¶ handlers_ï¼šä»¥äº‹ä»¶ç±»å‹ä¸ºé”®çš„å¤„ç†å‡½æ•°æ˜ å°„è¡¨ worker_thread_ï¼šå•ç‹¬å·¥ä½œçº¿ç¨‹ï¼Œå¾ªç¯å¤„ç†äº‹ä»¶é˜Ÿåˆ— 1.2 äº‹ä»¶å‘å¸ƒæµç¨‹ #void publish(std::shared_ptr\u0026lt;Event\u0026gt; event) { // è®¾ç½®å‘å¸ƒæ—¶é—´ event-\u0026gt;setPublishTime(std::chrono::high_resolution_clock::now()); // æ›´æ–°é˜Ÿåˆ—ç»Ÿè®¡ auto current_size = queue_size_.fetch_add(1) + 1; // ... // å…¥é˜Ÿ event_queue_.enqueue(std::move(event)); } é‡è¦è¯´æ˜ï¼šå‘å¸ƒäº‹ä»¶åªæ¶‰åŠé˜Ÿåˆ—æ“ä½œï¼Œä¸ä¼šä¿®æ”¹handlers_æ˜ å°„è¡¨ã€‚æ¯æ¬¡publishè°ƒç”¨åªæ˜¯å°†äº‹ä»¶å¯¹è±¡åŠ å…¥é˜Ÿåˆ—ï¼Œä¸æ¶‰åŠå¯¹å¤„ç†å‡½æ•°æ˜ å°„è¡¨çš„ä»»ä½•è¯»å†™æ“ä½œã€‚äº‹ä»¶ç±»å‹ä½œä¸ºkeyåœ¨subscribeé˜¶æ®µå·²ç»ç¡®å®šï¼Œè¿è¡Œæ—¶çš„publishæ“ä½œä¸handlers_æ˜ å°„è¡¨å®Œå…¨è§£è€¦ã€‚\n1.3 äº‹ä»¶å¤„ç†æµç¨‹ #void process_events() { while (running_) { std::shared_ptr\u0026lt;Event\u0026gt; event; if (event_queue_.dequeue(event)) { // è®¡ç®—å¤„ç†å»¶è¿Ÿ // ... // æ ¸å¿ƒåˆ†å‘é€»è¾‘ auto it = handlers_.find(typeid(*event)); if (it != handlers_.end()) { for (const auto\u0026amp; handler : it-\u0026gt;second) { handler(event); } } // ... } } } å·¥ä½œçº¿ç¨‹ä¸æ–­ä»é˜Ÿåˆ—å–å‡ºäº‹ä»¶ï¼Œé€šè¿‡typeid(*event)è·å–äº‹ä»¶ç±»å‹ï¼Œç„¶åæŸ¥æ‰¾å¹¶è°ƒç”¨å¯¹åº”çš„å¤„ç†å‡½æ•°ã€‚\n2. äº‹ä»¶ä¸å¤„ç†å‡½æ•°çš„å¯¹åº”å…³ç³» #2.1 åŸºäºRTTIçš„ç±»å‹åˆ†å‘æœºåˆ¶ #auto it = handlers_.find(typeid(*event)); è¿™è¡Œä»£ç æ˜¯æ•´ä¸ªäº‹ä»¶åˆ†å‘çš„æ ¸å¿ƒï¼Œé€šè¿‡C++çš„RTTIæœºåˆ¶è·å–äº‹ä»¶çš„å®é™…è¿è¡Œæ—¶ç±»å‹ï¼Œç„¶ååœ¨handlers_æ˜ å°„è¡¨ä¸­æŸ¥æ‰¾ã€‚\n2.2 å¤„ç†å‡½æ•°æ³¨å†Œæœºåˆ¶ #template\u0026lt;typename E\u0026gt; void subscribe(std::function\u0026lt;void(std::shared_ptr\u0026lt;E\u0026gt;)\u0026gt; handler) { auto wrapped_handler = [handler](std::shared_ptr\u0026lt;Event\u0026gt; base_event) { if (auto derived_event = std::dynamic_pointer_cast\u0026lt;E\u0026gt;(base_event)) { handler(derived_event); } }; handlers_[typeid(E)].push_back(wrapped_handler); } è¿™ä¸ªæ¨¡æ¿æ–¹æ³•å®ç°äº†ç±»å‹å®‰å…¨çš„äº‹ä»¶è®¢é˜…ï¼š\né€šè¿‡typeid(E)è·å–äº‹ä»¶ç±»å‹çš„æ ‡è¯†ç¬¦ å°†å¤„ç†å‡½æ•°åŒ…è£…åå­˜å‚¨åˆ°å¯¹åº”ç±»å‹çš„å¤„ç†å‡½æ•°åˆ—è¡¨ä¸­ åŒ…è£…å‡½æ•°å†…éƒ¨ä½¿ç”¨std::dynamic_pointer_castè¿›è¡Œç±»å‹æ£€æŸ¥å’Œè½¬æ¢ 2.3 äº‹ä»¶IDé—®é¢˜ #å½“å‰å®ç°ä¸­ï¼Œäº‹ä»¶æ²¡æœ‰å†…ç½®çš„å”¯ä¸€IDæœºåˆ¶ï¼š\nç›¸åŒç±»å‹çš„å¤šä¸ªäº‹ä»¶å®ä¾‹æ²¡æœ‰è‡ªåŠ¨åˆ†é…çš„å”¯ä¸€æ ‡è¯†ç¬¦ äº‹ä»¶çš„è¯†åˆ«ä¸»è¦ä¾é å…¶ç±»å‹ï¼Œè€Œéå”¯ä¸€ID å¯¹äºå½“å‰ä¸šåŠ¡åœºæ™¯ï¼šåªéœ€è¦åŒºåˆ†ä¸åŒç±»å‹çš„äº‹ä»¶ï¼Œä¸éœ€è¦åŒºåˆ†ç›¸åŒç±»å‹çš„ä¸åŒäº‹ä»¶å®ä¾‹ï¼Œå› æ­¤ä¸éœ€è¦å”¯ä¸€IDæœºåˆ¶ å¦‚éœ€åŒºåˆ†åŒç±»å‹çš„ä¸åŒäº‹ä»¶ï¼Œéœ€è¦åœ¨äº‹ä»¶ç±»ä¸­è‡ªè¡Œæ·»åŠ æ ‡è¯†å­—æ®µ 3. æ€§èƒ½ç“¶é¢ˆåˆ†æ #3.1 handlers_æ˜ å°„è¡¨çš„æ€§èƒ½é—®é¢˜ #std::unordered_map\u0026lt;std::type_index, std::vector\u0026lt;std::function\u0026lt;void(std::shared_ptr\u0026lt;Event\u0026gt;)\u0026gt;\u0026gt;\u0026gt; handlers_; æŸ¥æ‰¾å¤æ‚åº¦é—®é¢˜ï¼š\nstd::unordered_mapçš„å¹³å‡æŸ¥æ‰¾å¤æ‚åº¦æ˜¯O(1) å¯¹äºå°‘é‡äº‹ä»¶ç±»å‹ï¼ˆé€šå¸¸å‡ åç§ï¼‰ï¼Œå“ˆå¸Œå†²çªæ¦‚ç‡ç¡®å®å¾ˆä½ ä½†std::type_indexä½œä¸ºkeyçš„å“ˆå¸Œè´¨é‡å–å†³äºç¼–è¯‘å™¨å®ç°ï¼Œå­˜åœ¨ä¸ç¡®å®šæ€§ æ›´é‡è¦çš„æ˜¯ï¼Œå³ä½¿æ²¡æœ‰å†²çªï¼Œstd::unordered_mapæœ¬èº«çš„æŸ¥æ‰¾å¼€é”€ï¼ˆå“ˆå¸Œè®¡ç®—ã€æ¡¶å®šä½ã€é”®æ¯”è¾ƒï¼‰ä»ç„¶æ¯”ç›´æ¥æ•°ç»„ç´¢å¼•é«˜æ•°å€ å†…å­˜å±€éƒ¨æ€§é—®é¢˜ï¼š\nstd::unordered_mapçš„å†…å­˜å¸ƒå±€ä¸è¿ç»­ï¼Œæ¯ä¸ªé”®å€¼å¯¹å¯èƒ½åˆ†å¸ƒåœ¨å†…å­˜çš„ä¸åŒä½ç½® å¯¼è‡´CPUç¼“å­˜å‘½ä¸­ç‡é™ä½ï¼Œåœ¨é«˜é¢‘è®¿é—®åœºæ™¯ä¸‹å¢åŠ cache miss å¯¹äºæœ‰é™çš„äº‹ä»¶ç±»å‹é›†åˆï¼ˆé€šå¸¸å‡ åç§ï¼‰ï¼Œè¿™ç§å†…å­˜å¸ƒå±€æ˜¯ä½æ•ˆçš„ äº‹ä»¶ç±»å‹æ•°é‡æœ‰é™ï¼š\nåœ¨å®é™…åº”ç”¨ä¸­ï¼Œäº‹ä»¶ç±»å‹é€šå¸¸æ˜¯æœ‰é™çš„ï¼ˆå¯èƒ½åªæœ‰å‡ åç§ï¼‰ ä½¿ç”¨æ˜ å°„è¡¨å­˜å‚¨å°‘é‡é”®å€¼å¯¹æ˜¯ä½æ•ˆçš„ å¯ä»¥è€ƒè™‘ä½¿ç”¨æ›´é«˜æ•ˆçš„æ•°æ®ç»“æ„ï¼Œå¦‚æ•°ç»„æˆ–è‡ªå®šä¹‰å“ˆå¸Œè¡¨ å†™æ“ä½œæ€§èƒ½ä¸è®¢é˜…åœºæ™¯ï¼š\nåœ¨subscribeæ–¹æ³•ä¸­éœ€è¦ä¿®æ”¹handlers_æ˜ å°„è¡¨ å½“å‰ä¸šåŠ¡åœºæ™¯ï¼šæ¯ä¸ªäº‹ä»¶ç±»å‹åªéœ€è¦è®¢é˜…ä¸€æ¬¡ï¼Œåœ¨ç³»ç»Ÿå¯åŠ¨é˜¶æ®µå®Œæˆï¼Œè¿è¡Œæ—¶ä¸ä¼šé¢‘ç¹ä¿®æ”¹ é«˜é¢‘è®¢é˜…åœºæ™¯ï¼šæŸäº›å¤æ‚ç³»ç»Ÿå¯èƒ½å­˜åœ¨åŠ¨æ€è®¢é˜…éœ€æ±‚ï¼Œå¦‚ï¼š æ’ä»¶ç³»ç»Ÿï¼šè¿è¡Œæ—¶åŠ¨æ€åŠ è½½/å¸è½½æ’ä»¶æ—¶éœ€è¦æ³¨å†Œ/æ³¨é”€äº‹ä»¶å¤„ç†å‡½æ•° å¤šç§Ÿæˆ·ç³»ç»Ÿï¼šä¸åŒç§Ÿæˆ·åŠ¨æ€æ³¨å†Œè‡ªå®šä¹‰äº‹ä»¶å¤„ç†é€»è¾‘ A/Bæµ‹è¯•åœºæ™¯ï¼šæ ¹æ®å®éªŒé…ç½®åŠ¨æ€è°ƒæ•´äº‹ä»¶å¤„ç†ç­–ç•¥ çƒ­æ›´æ–°ç³»ç»Ÿï¼šä¸šåŠ¡é€»è¾‘æ›´æ–°æ—¶éœ€è¦é‡æ–°æ³¨å†Œäº‹ä»¶å¤„ç†å‡½æ•° å¯¹äºè¿™äº›é«˜é¢‘è®¢é˜…åœºæ™¯ï¼Œå½“å‰çš„std::unordered_mapå®ç°ä¼šæˆä¸ºæ˜¾è‘—ç“¶é¢ˆ 3.2 RTTIæœºåˆ¶çš„æ€§èƒ½å¼€é”€ #auto it = handlers_.find(typeid(*event)); è¿è¡Œæ—¶ç±»å‹è¯†åˆ«å¼€é”€ï¼š\ntypeidè¿ç®—ç¬¦æ¶‰åŠè¿è¡Œæ—¶ç±»å‹ä¿¡æ¯æŸ¥æ‰¾ï¼Œæœ‰é¢å¤–å¼€é”€ åœ¨é«˜é¢‘è°ƒç”¨åœºæ™¯ä¸‹ï¼Œè¿™ç§åŠ¨æ€ç±»å‹æ£€æŸ¥ä¼šæˆä¸ºæ€§èƒ½ç“¶é¢ˆ ç°ä»£ç¼–è¯‘å™¨å¯¹RTTIçš„ä¼˜åŒ–æœ‰é™ï¼Œæ— æ³•å®Œå…¨æ¶ˆé™¤å¼€é”€ åˆ†æ”¯é¢„æµ‹é—®é¢˜ï¼š\nif (it != handlers_.end()) { // è¿™ä¸ªåˆ†æ”¯å¯èƒ½éš¾ä»¥é¢„æµ‹ for (const auto\u0026amp; handler : it-\u0026gt;second) { handler(event); } } äº‹ä»¶ç±»å‹çš„åˆ†å¸ƒå¯èƒ½ä¸å‡åŒ€ï¼Œå¯¼è‡´åˆ†æ”¯é¢„æµ‹å¤±æ•ˆ CPUæµæ°´çº¿åœé¡¿ä¼šæ˜¾è‘—å½±å“æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨é«˜é¢‘åœºæ™¯ä¸‹ åŠ¨æ€ç±»å‹è½¬æ¢å¼€é”€ï¼š\nif (auto derived_event = std::dynamic_pointer_cast\u0026lt;E\u0026gt;(base_event)) { handler(derived_event); } std::dynamic_pointer_castéœ€è¦åœ¨è¿è¡Œæ—¶è¿›è¡Œç±»å‹æ£€æŸ¥ æ¯æ¬¡äº‹ä»¶å¤„ç†éƒ½è¦æ‰§è¡Œç±»å‹è½¬æ¢ï¼Œç´¯ç§¯å¼€é”€æ˜¾è‘— é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­ï¼Œè¿™ç§è¿è¡Œæ—¶å¼€é”€æ˜¯ä¸å¯æ¥å—çš„ 3.3 æ™ºèƒ½æŒ‡é’ˆå¼€é”€è¯¦è§£ #std::shared_ptråœ¨å½“å‰å®ç°ä¸­è¢«å¹¿æ³›ä½¿ç”¨ï¼Œä½†åœ¨é«˜é¢‘åœºæ™¯ä¸‹ä¼šå¸¦æ¥æ˜¾è‘—çš„æ€§èƒ½å¼€é”€ï¼š\n3.3.1 å¼•ç”¨è®¡æ•°çš„åŸå­æ“ä½œå¼€é”€ #// æ¯æ¬¡æ‹·è´shared_ptréƒ½ä¼šè§¦å‘åŸå­æ“ä½œ void publish(std::shared_ptr\u0026lt;Event\u0026gt; event) { // æ‹·è´æ„é€ ï¼Œå¼•ç”¨è®¡æ•°+1 event_queue_.enqueue(std::move(event)); // ç§»åŠ¨ï¼Œä½†ä»æœ‰å¼•ç”¨è®¡æ•°æ“ä½œ } // åœ¨äº‹ä»¶å¤„ç†å¾ªç¯ä¸­ std::shared_ptr\u0026lt;Event\u0026gt; event; if (event_queue_.dequeue(event)) { // å¯èƒ½çš„æ‹·è´ï¼Œå¼•ç”¨è®¡æ•°+1 for (const auto\u0026amp; handler : it-\u0026gt;second) { handler(event); // ä¼ é€’ç»™å¤„ç†å‡½æ•°ï¼Œå¯èƒ½å†æ¬¡æ‹·è´ } } // ä½œç”¨åŸŸç»“æŸï¼Œå¼•ç”¨è®¡æ•°-1ï¼Œå¯èƒ½è§¦å‘ææ„ æ€§èƒ½å½±å“åˆ†æï¼š\næ¯ä¸ªåŸå­æ“ä½œåœ¨x86-64æ¶æ„ä¸‹é€šå¸¸éœ€è¦20-100ä¸ªCPUå‘¨æœŸ åœ¨é«˜é¢‘åœºæ™¯ä¸‹ï¼ˆç™¾ä¸‡äº‹ä»¶/ç§’ï¼‰ï¼Œä»…å¼•ç”¨è®¡æ•°æ“ä½œå°±å¯èƒ½æ¶ˆè€—10-20%çš„CPUæ—¶é—´ åŸå­æ“ä½œè¿˜ä¼šå¯¼è‡´CPUç¼“å­˜è¡Œå¤±æ•ˆï¼Œè¿›ä¸€æ­¥æ”¾å¤§æ€§èƒ½å½±å“ 3.3.2 å†…å­˜åˆ†é…å’Œæ§åˆ¶å—å¼€é”€ #// shared_ptrçš„å†…å­˜å¸ƒå±€ std::shared_ptr\u0026lt;Event\u0026gt; event = std::make_shared\u0026lt;OrderEvent\u0026gt;(); // å®é™…åˆ†é…ï¼šEventå¯¹è±¡ + æ§åˆ¶å—ï¼ˆå¼•ç”¨è®¡æ•°ã€å¼±å¼•ç”¨è®¡æ•°ã€åˆ é™¤å™¨ç­‰ï¼‰ å¼€é”€æ¥æºï¼š\næ¯ä¸ªshared_ptréœ€è¦é¢å¤–çš„æ§åˆ¶å—ï¼Œé€šå¸¸å ç”¨16-32å­—èŠ‚ é¢‘ç¹çš„å †å†…å­˜åˆ†é…/é‡Šæ”¾å¯¼è‡´å†…å­˜åˆ†é…å™¨å‹åŠ› å†…å­˜ç¢ç‰‡åŒ–å½±å“ç¼“å­˜å±€éƒ¨æ€§ï¼Œé™ä½æ•´ä½“æ€§èƒ½ 3.3.3 å¤šçº¿ç¨‹ç«äº‰é—®é¢˜ #// å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®åŒä¸€ä¸ªshared_ptræ—¶ std::shared_ptr\u0026lt;Event\u0026gt; global_event; // å…¨å±€äº‹ä»¶å¯¹è±¡ // çº¿ç¨‹1 auto local_copy = global_event; // åŸå­é€’å¢ // çº¿ç¨‹2 auto another_copy = global_event; // åŸå­é€’å¢ï¼Œå¯èƒ½ä¸çº¿ç¨‹1ç«äº‰åŒä¸€ç¼“å­˜è¡Œ åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œä¸åŒçº¿ç¨‹å¯¹åŒä¸€shared_ptrçš„å¹¶å‘è®¿é—®ä¼šå¯¼è‡´ç¼“å­˜è¡Œåœ¨CPUæ ¸å¿ƒé—´é¢‘ç¹ä¼ è¾“ï¼Œä¸¥é‡å½±å“æ€§èƒ½ã€‚\n3.3.4 æ€§èƒ½æ•°æ®å¯¹æ¯” # æ“ä½œç±»å‹ shared_ptrè€—æ—¶(ns) unique_ptrè€—æ—¶(ns) è£¸æŒ‡é’ˆè€—æ—¶(ns) æ€§èƒ½å·®è· å¯¹è±¡åˆ›å»º 45-60 15-25 5-10 6-9å€ æ‹·è´èµ‹å€¼ 25-35 N/A 1-2 15-25å€ ææ„é‡Šæ”¾ 30-45 10-15 1-2 20-30å€ 3.4 æ™ºèƒ½æŒ‡é’ˆä¼˜åŒ–æ–¹æ¡ˆ #3.4.1 æŒ‰å€¼ä¼ é€’ä¸å¼•ç”¨ä¼ é€’é—®é¢˜ #å½“å‰å®ç°ä¸­ï¼Œpublishæ–¹æ³•ä½¿ç”¨æŒ‰å€¼ä¼ é€’æ–¹å¼æ¥æ”¶std::shared_ptrï¼š\nvoid publish(std::shared_ptr\u0026lt;Event\u0026gt; event) { // æŒ‰å€¼ä¼ é€’ï¼Œè§¦å‘æ‹·è´æ„é€  event_queue_.enqueue(std::move(event)); // ç§»åŠ¨è¯­ä¹‰ } æŒ‰å€¼ä¼ é€’çš„é—®é¢˜ï¼š\næ¯æ¬¡è°ƒç”¨éƒ½ä¼šè§¦å‘æ‹·è´æ„é€ ï¼Œå¢åŠ å¼•ç”¨è®¡æ•° å³ä½¿åç»­ä½¿ç”¨std::moveï¼Œå‰é¢çš„æ‹·è´æ„é€ å¼€é”€å·²ç»äº§ç”Ÿ åœ¨é«˜é¢‘è°ƒç”¨åœºæ™¯ä¸‹ç´¯ç§¯æˆæ˜¾è‘—æ€§èƒ½æŸå¤± PS: ä¸ºä»€ä¹ˆvoid publish(std::shared_ptr\u0026lt;Event\u0026gt; event)æ˜¯æ‹·è´æ„é€ ï¼Ÿ\nå½“å‡½æ•°å‚æ•°ä¸ºstd::shared_ptr\u0026lt;Event\u0026gt; eventï¼ˆæŒ‰å€¼ä¼ é€’ï¼‰æ—¶ï¼š\nå‚æ•°ä¼ é€’æœºåˆ¶ï¼š\nC++ä¸­æŒ‰å€¼ä¼ é€’å‚æ•°ä¼šåˆ›å»ºå‚æ•°çš„ä¸€ä¸ªå‰¯æœ¬ å¯¹äºstd::shared_ptrï¼Œè¿™æ„å‘³ç€è°ƒç”¨å…¶æ‹·è´æ„é€ å‡½æ•° æ‹·è´æ„é€ çš„æ•ˆæœï¼š\nstd::shared_ptrçš„æ‹·è´æ„é€ ä¼šå¢åŠ å¼•ç”¨è®¡æ•°ï¼ˆ+1ï¼‰ åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„æ™ºèƒ½æŒ‡é’ˆå¯¹è±¡ï¼Œä½†æŒ‡å‘ç›¸åŒçš„Eventå¯¹è±¡ åŸå§‹æŒ‡é’ˆå’Œå‡½æ•°å†…çš„æŒ‡é’ˆå…±äº«æ‰€æœ‰æƒ ä»£ç ç¤ºä¾‹ï¼š\nstd::shared_ptr\u0026lt;Event\u0026gt; original = std::make_shared\u0026lt;OrderEvent\u0026gt;(); // å¼•ç”¨è®¡æ•° = 1 eventBus.publish(original); // è°ƒç”¨æ—¶å‘ç”Ÿæ‹·è´æ„é€ ï¼Œå¼•ç”¨è®¡æ•°å˜ä¸º2 // å‡½æ•°å†…éƒ¨æœ‰ä¸€ä¸ªoriginalçš„å‰¯æœ¬ // å‡½æ•°è¿”å›åï¼Œå‡½æ•°å†…çš„å‰¯æœ¬è¢«é”€æ¯ï¼Œå¼•ç”¨è®¡æ•°å‡ä¸º1 ä¸å³å€¼å¼•ç”¨å¯¹æ¯”ï¼š\n// ä½¿ç”¨å³å€¼å¼•ç”¨ç‰ˆæœ¬ void publish(std::shared_ptr\u0026lt;Event\u0026gt;\u0026amp;\u0026amp; event) { event_queue_.enqueue(std::move(event)); } // è°ƒç”¨ eventBus.publish(std::move(original)); // ä¸ä¼šåˆ›å»ºæ–°çš„shared_ptrå¯¹è±¡ï¼Œä¸ä¼šå¢åŠ å¼•ç”¨è®¡æ•° // ç›´æ¥è½¬ç§»originalçš„æ‰€æœ‰æƒåˆ°å‡½æ•°å‚æ•° // è°ƒç”¨åoriginalå˜ä¸ºç©ºæŒ‡é’ˆ å³ä½¿å½“å‰å®ç°ä¸­ä½¿ç”¨äº†std::move(event)å°†å‚æ•°ç§»å…¥é˜Ÿåˆ—ï¼Œä½†åœ¨å‡½æ•°è°ƒç”¨æ—¶å·²ç»å‘ç”Ÿäº†ä¸€æ¬¡æ‹·è´æ„é€ ï¼Œå¢åŠ äº†ä¸€æ¬¡ä¸å¿…è¦çš„å¼•ç”¨è®¡æ•°æ“ä½œã€‚ä½¿ç”¨å³å€¼å¼•ç”¨å‚æ•°å¯ä»¥å®Œå…¨é¿å…è¿™ä¸ªé¢å¤–çš„å¼•ç”¨è®¡æ•°æ“ä½œã€‚\n3.4.2 å³å€¼å¼•ç”¨ä¼˜åŒ–æ–¹æ¡ˆ #// ä¼˜åŒ–ç‰ˆæœ¬ï¼šä½¿ç”¨å³å€¼å¼•ç”¨ void publish(std::shared_ptr\u0026lt;Event\u0026gt;\u0026amp;\u0026amp; event) { // å³å€¼å¼•ç”¨å‚æ•° event_queue_.enqueue(std::move(event)); // ç§»åŠ¨è¯­ä¹‰ } // è°ƒç”¨æ–¹å¼ auto event = std::make_shared\u0026lt;OrderEvent\u0026gt;(...); eventBus.publish(std::move(event)); // æ˜¾å¼ç§»åŠ¨ï¼Œeventå˜ä¸ºç©º ä¼˜åŒ–æ•ˆæœï¼š\né¿å…äº†å‡½æ•°è°ƒç”¨æ—¶çš„æ‹·è´æ„é€ å’Œå¼•ç”¨è®¡æ•°å¢åŠ  æ˜ç¡®è¡¨è¾¾äº†æ‰€æœ‰æƒè½¬ç§»çš„è¯­ä¹‰ è°ƒç”¨ååŸæŒ‡é’ˆå˜ä¸ºç©ºï¼Œé˜²æ­¢è¯¯ç”¨ 3.4.3 å³å€¼å¼•ç”¨çš„å·¥ä½œæœºåˆ¶ #å‚æ•°ä¼ é€’ä¸­çš„å€¼ç±»åˆ«è½¬æ¢ # æŒ‰å€¼ä¼ é€’çš„æ‹·è´æ„é€ è¿‡ç¨‹ï¼š\nstd::shared_ptr\u0026lt;Event\u0026gt; original = std::make_shared\u0026lt;OrderEvent\u0026gt;(); // å¼•ç”¨è®¡æ•° = 1 eventBus.publish(original); // è°ƒç”¨æ—¶å‘ç”Ÿæ‹·è´æ„é€ ï¼Œå¼•ç”¨è®¡æ•°å˜ä¸º2 // å‡½æ•°è¿”å›åï¼Œå‡½æ•°å†…å‰¯æœ¬é”€æ¯ï¼Œå¼•ç”¨è®¡æ•°å‡ä¸º1 å³å€¼å¼•ç”¨çš„æ‰€æœ‰æƒè½¬ç§»ï¼š\nstd::shared_ptr\u0026lt;Event\u0026gt; original = std::make_shared\u0026lt;OrderEvent\u0026gt;(); // å¼•ç”¨è®¡æ•° = 1 eventBus.publish(std::move(original)); // std::moveå°†originalè½¬æ¢ä¸ºå³å€¼å¼•ç”¨ // ä¸è§¦å‘æ‹·è´æ„é€ ï¼Œè€Œæ˜¯ç›´æ¥è½¬ç§»æ‰€æœ‰æƒ // è°ƒç”¨åoriginalå˜ä¸ºç©ºæŒ‡é’ˆ å‡½æ•°å†…éƒ¨çš„å³å€¼å¤„ç† #åœ¨å‡½æ•°å†…éƒ¨ï¼Œå³ä½¿å‚æ•°æ˜¯é€šè¿‡å³å€¼å¼•ç”¨ä¼ å…¥ï¼Œå®ƒä¹Ÿä¼šå˜æˆå·¦å€¼ï¼š\nvoid publish(std::shared_ptr\u0026lt;Event\u0026gt;\u0026amp;\u0026amp; event) { // æ­¤å¤„eventè™½ç„¶é€šè¿‡å³å€¼å¼•ç”¨ä¼ å…¥ï¼Œä½†åœ¨å‡½æ•°å†…éƒ¨æ˜¯å·¦å€¼ event_queue_.enqueue(event); // é”™è¯¯ç”¨æ³•ï¼šä¼šè§¦å‘æ‹·è´æ„é€  // æ­£ç¡®ç”¨æ³•ï¼šéœ€è¦å†æ¬¡ä½¿ç”¨std::move event_queue_.enqueue(std::move(event)); // ä¿æŒç§»åŠ¨è¯­ä¹‰ } å…³é”®ç‚¹ï¼š\nåœ¨å‡½æ•°å†…éƒ¨ï¼Œæ‰€æœ‰å…·åå‚æ•°éƒ½æ˜¯å·¦å€¼ï¼Œæ— è®ºå®ƒä»¬å¦‚ä½•å£°æ˜ è¦ä¿æŒç§»åŠ¨è¯­ä¹‰ï¼Œéœ€è¦åœ¨å‡½æ•°å†…éƒ¨ä½¿ç”¨std::move è¿™ç¡®ä¿äº†èµ„æºçš„é«˜æ•ˆè½¬ç§»ï¼Œé¿å…äº†ä¸å¿…è¦çš„æ‹·è´ PS: å³å€¼å¼•ç”¨å‚æ•°ä¸€å®šè¦æ±‚åœ¨å‡½æ•°å†…éƒ¨ä½¿ç”¨std::move()ï¼Ÿ\nä¸å®Œå…¨æ˜¯è¿™æ ·ã€‚ä½¿ç”¨å³å€¼å¼•ç”¨å‚æ•°ä¸ä¸€å®šè¦æ±‚åœ¨å‡½æ•°å†…éƒ¨ä½¿ç”¨std::move()ï¼Œä½†è¿™æ˜¯æœ€ä½³å®è·µã€‚è®©æˆ‘æ¾„æ¸…ä¸€ä¸‹ï¼š\nåœ¨å‡½æ•°å‚æ•°ä¸­ä½¿ç”¨å³å€¼å¼•ç”¨ #å½“å‡½æ•°å‚æ•°å£°æ˜ä¸ºå³å€¼å¼•ç”¨æ—¶ï¼ˆå¦‚std::shared_ptr\u0026lt;Event\u0026gt;\u0026amp;\u0026amp;ï¼‰ï¼š\nå‚æ•°æœ¬èº«åœ¨å‡½æ•°å†…éƒ¨æ˜¯å·¦å€¼ï¼š\nå³ä½¿å‚æ•°æ˜¯é€šè¿‡å³å€¼å¼•ç”¨ä¼ å…¥çš„ï¼Œåœ¨å‡½æ•°ä½“å†…å®ƒæœ‰åç§°ï¼Œå› æ­¤æ˜¯ä¸€ä¸ªå·¦å€¼ å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™ä¸ªå‚æ•°è€Œä¸éœ€è¦std::move() ç¤ºä¾‹ï¼š\nvoid publish(std::shared_ptr\u0026lt;Event\u0026gt;\u0026amp;\u0026amp; event) { // åœ¨å‡½æ•°å†…éƒ¨ï¼Œeventæ˜¯å·¦å€¼ï¼ˆå°½ç®¡å®ƒé€šè¿‡å³å€¼å¼•ç”¨ä¼ å…¥ï¼‰ event_queue_.enqueue(event); // è¿™ä¼šè°ƒç”¨æ‹·è´æ„é€ ï¼Œè€Œéç§»åŠ¨æ„é€  } åœ¨å‡½æ•°å†…éƒ¨ä½¿ç”¨std::move()çš„åŸå›  #è™½ç„¶ä¸æ˜¯å¼ºåˆ¶è¦æ±‚ï¼Œä½†åœ¨å‡½æ•°å†…éƒ¨ä½¿ç”¨std::move()æœ‰ä»¥ä¸‹å¥½å¤„ï¼š\nä¼˜åŒ–æ€§èƒ½ï¼š\nå°†å·¦å€¼è½¬æ¢ä¸ºå³å€¼å¼•ç”¨ï¼Œå¯ç”¨ç§»åŠ¨è¯­ä¹‰ é¿å…ä¸å¿…è¦çš„æ‹·è´æ“ä½œ ä¿æŒè¯­ä¹‰ä¸€è‡´æ€§ï¼š\nå¦‚æœå‡½æ•°å‚æ•°æ˜¯å³å€¼å¼•ç”¨ï¼Œé€šå¸¸æ„å‘³ç€å‡½æ•°æ‰“ç®—\u0026quot;çªƒå–\u0026quot;èµ„æº åœ¨å‡½æ•°å†…éƒ¨ä½¿ç”¨std::move()ä¿æŒè¿™ç§è¯­ä¹‰ä¸€è‡´æ€§ ç¤ºä¾‹å¯¹æ¯”ï¼š\n// ä¸ä½¿ç”¨std::move - ä¼šå¯¼è‡´æ‹·è´ void publish(std::shared_ptr\u0026lt;Event\u0026gt;\u0026amp;\u0026amp; event) { event_queue_.enqueue(event); // æ‹·è´æ„é€ ï¼Œå¼•ç”¨è®¡æ•°+1 } // ä½¿ç”¨std::move - å®ç°ç§»åŠ¨ void publish(std::shared_ptr\u0026lt;Event\u0026gt;\u0026amp;\u0026amp; event) { event_queue_.enqueue(std::move(event)); // ç§»åŠ¨æ„é€ ï¼Œæ— å¼•ç”¨è®¡æ•°å˜åŒ– } æœ€ä½³å®è·µ # å‡½æ•°å‚æ•°ä½¿ç”¨å³å€¼å¼•ç”¨ï¼šè¡¨æ˜å‡½æ•°ä¼šæ¥ç®¡ï¼ˆçªƒå–ï¼‰èµ„æºæ‰€æœ‰æƒ\nå‡½æ•°å†…éƒ¨ä½¿ç”¨std::move()ï¼šå®é™…æ‰§è¡Œèµ„æºçªƒå–ï¼Œé¿å…æ‹·è´\nä¸€è‡´çš„çº¦å®šï¼š\nå¦‚æœå‚æ•°æ˜¯å³å€¼å¼•ç”¨ï¼Œé€šå¸¸åº”è¯¥åœ¨å‡½æ•°å†…éƒ¨ä½¿ç”¨std::move() è¿™æ ·å¯ä»¥ç¡®ä¿è¯­ä¹‰ä¸€è‡´ï¼Œå¹¶è·å¾—æ€§èƒ½ä¼˜åŠ¿ æ‰€ä»¥ï¼Œè™½ç„¶ä¸æ˜¯è¯­æ³•ä¸Šçš„å¼ºåˆ¶è¦æ±‚ï¼Œä½†ä»æœ€ä½³å®è·µå’Œæ€§èƒ½ä¼˜åŒ–è§’åº¦çœ‹ï¼Œå½“ä½¿ç”¨å³å€¼å¼•ç”¨å‚æ•°æ—¶ï¼Œåº”è¯¥åœ¨å‡½æ•°å†…éƒ¨ä½¿ç”¨std::move()æ¥ä¿æŒç§»åŠ¨è¯­ä¹‰çš„ä¸€è‡´æ€§ã€‚\nPS: ç†è§£\u0026quot;åœ¨å‡½æ•°å†…éƒ¨ï¼Œeventæ˜¯å·¦å€¼ï¼ˆå°½ç®¡å®ƒé€šè¿‡å³å€¼å¼•ç”¨ä¼ å…¥ï¼‰\u0026quot;\nè¿™å¥è¯æ¶‰åŠC++ä¸­å·¦å€¼å’Œå³å€¼çš„æ¦‚å¿µï¼Œä»¥åŠå¼•ç”¨ç±»å‹çš„ç‰¹æ€§ã€‚è®©æˆ‘è¯¦ç»†è§£é‡Šï¼š\nå·¦å€¼ä¸å³å€¼çš„åŸºæœ¬æ¦‚å¿µ # å·¦å€¼(lvalue)ï¼š\næœ‰åç§°ã€å¯ä»¥å–åœ°å€çš„è¡¨è¾¾å¼ é€šå¸¸å¯ä»¥å‡ºç°åœ¨èµ‹å€¼è¿ç®—ç¬¦çš„å·¦ä¾§ ä¾‹å¦‚ï¼šå˜é‡åã€æ•°ç»„å…ƒç´ ã€è§£å¼•ç”¨çš„æŒ‡é’ˆ å³å€¼(rvalue)ï¼š\nä¸´æ—¶çš„ã€æ— æ³•å–åœ°å€çš„è¡¨è¾¾å¼ åªèƒ½å‡ºç°åœ¨èµ‹å€¼è¿ç®—ç¬¦çš„å³ä¾§ ä¾‹å¦‚ï¼šå­—é¢å¸¸é‡ã€ä¸´æ—¶å¯¹è±¡ã€è¿”å›å€¼ å‡½æ•°å‚æ•°çš„å€¼ç±»åˆ« #åœ¨å‡½æ•°å†…éƒ¨ï¼Œæ‰€æœ‰å…·åå‚æ•°éƒ½æ˜¯å·¦å€¼ï¼Œæ— è®ºå®ƒä»¬æ˜¯å¦‚ä½•å£°æ˜æˆ–ä¼ å…¥çš„ï¼š\nvoid publish(std::shared_ptr\u0026lt;Event\u0026gt;\u0026amp;\u0026amp; event) { // è¿™é‡Œçš„eventæ˜¯ä¸€ä¸ªå·¦å€¼ï¼Œå› ä¸ºå®ƒæœ‰åç§° // å¯ä»¥å¯¹å®ƒå–åœ°å€: \u0026amp;event æ˜¯åˆæ³•çš„ // å¯ä»¥å¤šæ¬¡ä½¿ç”¨å®ƒ: event.use(); event.useAgain(); } å³ä½¿eventå‚æ•°æ˜¯é€šè¿‡å³å€¼å¼•ç”¨\u0026amp;\u0026amp;å£°æ˜çš„ï¼Œä¸€æ—¦å®ƒæœ‰äº†åç§°å¹¶åœ¨å‡½æ•°ä½“å†…å¯è®¿é—®ï¼Œå®ƒå°±æˆä¸ºäº†ä¸€ä¸ªå·¦å€¼ã€‚\nä¸ºä»€ä¹ˆè¿™å¾ˆé‡è¦ï¼Ÿ #è¿™ä¸€ç‚¹å¾ˆé‡è¦ï¼Œå› ä¸ºï¼š\nç§»åŠ¨è¯­ä¹‰åªå¯¹å³å€¼ç”Ÿæ•ˆï¼š\nç§»åŠ¨æ„é€ å‡½æ•°å’Œç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦åªæ¥å—å³å€¼å‚æ•° å·¦å€¼é»˜è®¤ä¼šè§¦å‘æ‹·è´æ“ä½œï¼Œè€Œéç§»åŠ¨æ“ä½œ åœ¨å‡½æ•°å†…éƒ¨ä½¿ç”¨å‚æ•°ï¼š\nvoid publish(std::shared_ptr\u0026lt;Event\u0026gt;\u0026amp;\u0026amp; event) { // è¿™ä¼šè°ƒç”¨æ‹·è´æ„é€ ï¼Œè€Œéç§»åŠ¨æ„é€  // å› ä¸ºeventåœ¨è¿™é‡Œæ˜¯å·¦å€¼ event_queue_.enqueue(event); } éœ€è¦std::move()è½¬æ¢ï¼š\nvoid publish(std::shared_ptr\u0026lt;Event\u0026gt;\u0026amp;\u0026amp; event) { // std::moveå°†å·¦å€¼eventè½¬æ¢ä¸ºå³å€¼å¼•ç”¨ // è¿™ä¼šè°ƒç”¨ç§»åŠ¨æ„é€ ï¼Œè€Œéæ‹·è´æ„é€  event_queue_.enqueue(std::move(event)); } ç›´è§‚ç†è§£ #å¯ä»¥è¿™æ ·ç†è§£ï¼š\nå³å€¼å¼•ç”¨å‚æ•°\u0026amp;\u0026amp;å‘Šè¯‰è°ƒç”¨è€…ï¼š\u0026ldquo;è¯·æŠŠä¸€ä¸ªä¸´æ—¶å¯¹è±¡ï¼ˆå³å€¼ï¼‰ä¼ ç»™æˆ‘\u0026rdquo; ä½†ä¸€æ—¦è¿™ä¸ªå¯¹è±¡è¿›å…¥å‡½æ•°ï¼Œå®ƒå°±æœ‰äº†åç§°(event)ï¼Œå› æ­¤å˜æˆäº†å·¦å€¼ å¦‚æœæƒ³åœ¨å‡½æ•°å†…éƒ¨ç»§ç»­åˆ©ç”¨ç§»åŠ¨è¯­ä¹‰ï¼Œéœ€è¦å†æ¬¡ä½¿ç”¨std::move()å°†å…¶è½¬æ¢å›å³å€¼å¼•ç”¨ è¿™å°±åƒæ˜¯ï¼šä½ å¯ä»¥æŠŠä¸€ä¸ªå³å°†è¢«é”€æ¯çš„ç‰©å“(å³å€¼)äº¤ç»™æŸäººä¿ç®¡(å‡½æ•°)ï¼Œä½†ä¸€æ—¦ä»–æ¥æ‰‹å¹¶ç»™å®ƒèµ·äº†åå­—(å‚æ•°å)ï¼Œè¿™ä¸ªç‰©å“å°±æœ‰äº†å›ºå®šçš„ä½ç½®(å·¦å€¼)ã€‚å¦‚æœä»–æƒ³å†æŠŠè¿™ä¸ªç‰©å“äº¤ç»™åˆ«äºº(å‡½æ•°å†…éƒ¨çš„å…¶ä»–æ“ä½œ)ï¼Œä»–éœ€è¦æ˜ç¡®è¡¨ç¤º\u0026quot;æˆ‘ä¸å†éœ€è¦è¿™ä¸ªç‰©å“\u0026quot;(std::move())ã€‚\næ€»ç»“ï¼šåç§°èµ‹äºˆäº†èº«ä»½ï¼Œæœ‰äº†èº«ä»½å°±æˆä¸ºäº†å·¦å€¼ã€‚å³ä½¿é€šè¿‡å³å€¼å¼•ç”¨ä¼ å…¥ï¼Œä¸€æ—¦åœ¨å‡½æ•°å†…éƒ¨æœ‰äº†åç§°ï¼Œå°±å˜æˆäº†å·¦å€¼ã€‚\n3.4.4 æ›´æ¿€è¿›çš„ä¼˜åŒ–ï¼šæ›¿ä»£shared_ptr #å¯¹äºæ€§èƒ½æåº¦æ•æ„Ÿçš„åœºæ™¯ï¼Œå¯ä»¥è€ƒè™‘å®Œå…¨æ›¿ä»£std::shared_ptrï¼š\nä½¿ç”¨std::unique_ptrï¼š\nvoid publish(std::unique_ptr\u0026lt;Event\u0026gt; event) { event_queue_.enqueue(std::move(event)); } å®Œå…¨æ¶ˆé™¤å¼•ç”¨è®¡æ•°å¼€é”€ æ˜ç¡®æ‰€æœ‰æƒè½¬ç§»è¯­ä¹‰ ä½†æ”¹å˜äº†APIå¥‘çº¦ï¼Œè°ƒç”¨æ–¹å¿…é¡»æ”¾å¼ƒæ‰€æœ‰æƒ ä½¿ç”¨å¯¹è±¡æ± å’Œè£¸æŒ‡é’ˆï¼š\nclass EventPool { // å¯¹è±¡æ± å®ç° public: Event* allocate() { /* ä»æ± ä¸­åˆ†é…äº‹ä»¶å¯¹è±¡ */ } void release(Event* event) { /* å½’è¿˜å¯¹è±¡åˆ°æ±  */ } }; void publish(Event* event) { event_queue_.enqueue(event); // å¯¹è±¡ç”Ÿå‘½å‘¨æœŸç”±é˜Ÿåˆ—è´Ÿè´£ç®¡ç† } æœ€é«˜æ€§èƒ½ï¼Œå‡ ä¹é›¶å¼€é”€ ä½†éœ€è¦ç²¾å¿ƒè®¾è®¡å¯¹è±¡ç”Ÿå‘½å‘¨æœŸç®¡ç† å¢åŠ äº†å†…å­˜å®‰å…¨é£é™© 3.4.5 ä¼˜åŒ–å»ºè®®æ€»ç»“ # ä¼˜åŒ–æ–¹æ¡ˆ æ€§èƒ½æå‡ å®ç°å¤æ‚åº¦ APIå…¼å®¹æ€§ ä½¿ç”¨å³å€¼å¼•ç”¨å‚æ•° ä¸­ç­‰ ä½ é«˜ æ›¿æ¢ä¸ºunique_ptr é«˜ ä¸­ ä¸­ è‡ªå®šä¹‰å¯¹è±¡æ± +è£¸æŒ‡é’ˆ æœ€é«˜ é«˜ ä½ æœ€ä½³å®è·µå»ºè®®ï¼š\nç¬¬ä¸€é˜¶æ®µï¼šå°†æ‰€æœ‰std::shared_ptræŒ‰å€¼å‚æ•°æ”¹ä¸ºå³å€¼å¼•ç”¨ ç¬¬äºŒé˜¶æ®µï¼šè¯„ä¼°æ˜¯å¦éœ€è¦æ›´æ¿€è¿›çš„ä¼˜åŒ–ï¼Œå¦‚æ›¿æ¢ä¸ºunique_ptr ç¬¬ä¸‰é˜¶æ®µï¼šåªåœ¨æ€§èƒ½æœ€å…³é”®çš„è·¯å¾„ä¸Šè€ƒè™‘ä½¿ç”¨å¯¹è±¡æ± å’Œè£¸æŒ‡é’ˆ 3.5 False Sharingé—®é¢˜è¯¦è§£ #3.5.1 ä»€ä¹ˆæ˜¯False Sharing #False Sharing æ˜¯ä¸€ç§ç¼“å­˜ä¸€è‡´æ€§å†²çªç°è±¡ï¼Œå‘ç”Ÿåœ¨ï¼š\nå¤šä¸ªçº¿ç¨‹è¿è¡Œåœ¨ä¸åŒç‰©ç†æ ¸å¿ƒä¸Šï¼Œå¹¶å‘å†™å…¥ä½äºåŒä¸€ cache line ä¸Šä½†å½¼æ­¤ç‹¬ç«‹çš„å˜é‡ã€‚ å°½ç®¡å˜é‡é€»è¾‘ä¸Šæ²¡æœ‰å…±äº«ï¼Œä½†ç”±äºå®ƒä»¬å…±å ä¸€ä¸ª cache lineï¼Œä¼šå¯¼è‡´ cache line çš„æ‰€æœ‰æƒåœ¨æ ¸å¿ƒä¹‹é—´é¢‘ç¹æ¥å›è½¬ç§»ï¼Œä»è€Œå¼•å‘ cache invalidationã€æ€»çº¿é€šä¿¡å¢åŠ ã€å»¶è¿Ÿå‡é«˜ï¼Œä¸¥é‡æ—¶å¯¼è‡´ç¨‹åºæ€§èƒ½æ˜¾è‘—ä¸‹é™ã€‚\nFalse Sharing æœ¬è´¨ä¸Šæ˜¯ ç¡¬ä»¶ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼ˆå¦‚ MESIï¼‰å¯¼è‡´çš„æ€§èƒ½å‰¯ä½œç”¨ï¼Œè€Œä¸æ˜¯è½¯ä»¶ bugï¼Œå› æ­¤å®ƒå°¤å…¶å®¹æ˜“è¢«åˆå­¦è€…å¿½è§†ã€‚\nç›¸å…³çŸ¥è¯†ï¼šå…³äºCPUç¼“å­˜æ¶æ„å’Œç¼“å­˜ä¸€è‡´æ€§åè®®çš„è¯¦ç»†è§£é‡Šï¼Œè¯·å‚è€ƒæ·±å…¥ç†è§£æ— é”é˜Ÿåˆ—ä¸­çš„\u0026quot;ç¡¬ä»¶åŸºç¡€\u0026quot;ç« èŠ‚ã€‚\nåŸºç¡€æ¦‚å¿µï¼š\nç¼“å­˜è¡Œï¼ˆCache Lineï¼‰ï¼šCPUç¼“å­˜çš„åŸºæœ¬å•ä½ï¼Œé€šå¸¸ä¸º64å­—èŠ‚ ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼šç¡®ä¿å¤šæ ¸ç³»ç»Ÿä¸­ç¼“å­˜æ•°æ®ä¸€è‡´æ€§çš„æœºåˆ¶ï¼ˆå¦‚MESIåè®®ï¼‰ ä¼ªå…±äº«ï¼šå¤šä¸ªæ ¸å¿ƒè®¿é—®åŒä¸€ç¼“å­˜è¡Œçš„ä¸åŒéƒ¨åˆ†ï¼Œé€ æˆä¸å¿…è¦çš„ç¼“å­˜åŒæ­¥ 3.5.2 å½“å‰å®ç°ä¸­çš„False Sharingåœºæ™¯ #class LockFreeEventBus { private: // è¿™äº›åŸå­å˜é‡å¯èƒ½ä½äºåŒä¸€ç¼“å­˜è¡Œä¸­ std::atomic\u0026lt;size_t\u0026gt; queue_size_; // 8å­—èŠ‚ std::atomic\u0026lt;size_t\u0026gt; processed_count_; // 8å­—èŠ‚ std::atomic\u0026lt;size_t\u0026gt; max_queue_size_; // 8å­—èŠ‚ std::atomic\u0026lt;size_t\u0026gt; total_processing_time_; // 8å­—èŠ‚ std::atomic\u0026lt;bool\u0026gt; running_; // 1å­—èŠ‚ // å¦‚æœè¿™äº›å˜é‡ç´§å¯†æ’åˆ—ï¼Œå¾ˆå¯èƒ½å…±äº«åŒä¸€ä¸ª64å­—èŠ‚çš„ç¼“å­˜è¡Œ }; 3.5.3 False Sharingçš„æ€§èƒ½å½±å“æœºåˆ¶ #åœºæ™¯åˆ†æï¼š\n// ç”Ÿäº§è€…çº¿ç¨‹ï¼ˆå‘å¸ƒäº‹ä»¶ï¼‰ void publish(std::shared_ptr\u0026lt;Event\u0026gt; event) { auto current_size = queue_size_.fetch_add(1); // ä¿®æ”¹queue_size_ if (current_size \u0026gt; max_queue_size_.load()) { // è¯»å–max_queue_size_ max_queue_size_.store(current_size); // å¯èƒ½ä¿®æ”¹max_queue_size_ } } // æ¶ˆè´¹è€…çº¿ç¨‹ï¼ˆå¤„ç†äº‹ä»¶ï¼‰ void process_events() { while (running_.load()) { // è¯»å–running_ if (event_queue_.dequeue(event)) { processed_count_.fetch_add(1); // ä¿®æ”¹processed_count_ // ... } } } é—®é¢˜åˆ†æï¼š\nç”Ÿäº§è€…çº¿ç¨‹é¢‘ç¹ä¿®æ”¹queue_size_å’Œmax_queue_size_ æ¶ˆè´¹è€…çº¿ç¨‹é¢‘ç¹ä¿®æ”¹processed_count_ï¼ŒåŒæ—¶è¯»å–running_ å¦‚æœè¿™äº›å˜é‡ä½äºåŒä¸€ç¼“å­˜è¡Œï¼Œä¼šå¯¼è‡´ï¼š ç”Ÿäº§è€…ä¿®æ”¹åï¼Œæ¶ˆè´¹è€…çš„ç¼“å­˜è¡Œå¤±æ•ˆ æ¶ˆè´¹è€…ä¿®æ”¹åï¼Œç”Ÿäº§è€…çš„ç¼“å­˜è¡Œå¤±æ•ˆ ç¼“å­˜è¡Œåœ¨CPUæ ¸å¿ƒé—´é¢‘ç¹ä¼ è¾“ 3.5.4 False Sharingçš„æ€§èƒ½å¼€é”€ #ç¼“å­˜è¡Œä¼ è¾“æˆæœ¬ï¼š\nL1ç¼“å­˜å‘½ä¸­ï¼š1-2ä¸ªCPUå‘¨æœŸ L2ç¼“å­˜å‘½ä¸­ï¼š10-20ä¸ªCPUå‘¨æœŸ L3ç¼“å­˜å‘½ä¸­ï¼š40-80ä¸ªCPUå‘¨æœŸ å†…å­˜è®¿é—®ï¼š200-400ä¸ªCPUå‘¨æœŸ è·¨æ ¸å¿ƒç¼“å­˜è¡Œä¼ è¾“ï¼š100-200ä¸ªCPUå‘¨æœŸ å®é™…æµ‹è¯•æ•°æ®ï¼š\nåœºæ™¯ è®¿é—®å»¶è¿Ÿ(ns) ååé‡å½±å“ æ— False Sharing 5-10 åŸºå‡† è½»åº¦False Sharing 50-100 é™ä½30-50% ä¸¥é‡False Sharing 200-500 é™ä½70-90% 3.5.5 è¯†åˆ«False Sharingçš„æ–¹æ³• #ä»£ç å®¡æŸ¥è¦ç‚¹ï¼š\n// å±é™©æ¨¡å¼ï¼šå¤šä¸ªåŸå­å˜é‡ç´§å¯†æ’åˆ— struct BadLayout { std::atomic\u0026lt;int\u0026gt; counter1; // å¯èƒ½åœ¨åŒä¸€ç¼“å­˜è¡Œ std::atomic\u0026lt;int\u0026gt; counter2; // å¯èƒ½åœ¨åŒä¸€ç¼“å­˜è¡Œ std::atomic\u0026lt;bool\u0026gt; flag; // å¯èƒ½åœ¨åŒä¸€ç¼“å­˜è¡Œ }; // å®‰å…¨æ¨¡å¼ï¼šç¼“å­˜è¡Œå¯¹é½ struct GoodLayout { alignas(64) std::atomic\u0026lt;int\u0026gt; counter1; // ç‹¬å ç¼“å­˜è¡Œ alignas(64) std::atomic\u0026lt;int\u0026gt; counter2; // ç‹¬å ç¼“å­˜è¡Œ alignas(64) std::atomic\u0026lt;bool\u0026gt; flag; // ç‹¬å ç¼“å­˜è¡Œ }; æ€§èƒ½åˆ†æå·¥å…·ï¼š\nIntel VTuneï¼šå¯ä»¥æ£€æµ‹false sharingçƒ­ç‚¹ perfï¼šLinuxä¸‹çš„æ€§èƒ½åˆ†æå·¥å…·ï¼Œæ”¯æŒç¼“å­˜äº‹ä»¶ç»Ÿè®¡ cachegrindï¼šValgrindå·¥å…·å¥—ä»¶ä¸­çš„ç¼“å­˜åˆ†æå™¨ 4. æ€§èƒ½æ•°æ®åˆ†æ #åŸºäºå…¸å‹é«˜é¢‘äº¤æ˜“åœºæ™¯çš„æ€§èƒ½æµ‹è¯•æ•°æ®ï¼š\n4.1 äº‹ä»¶åˆ†å‘å»¶è¿Ÿå¯¹æ¯” # å®ç°æ–¹å¼ å¹³å‡å»¶è¿Ÿ(ns) 99%åˆ†ä½å»¶è¿Ÿ(ns) æœ€å¤§å»¶è¿Ÿ(ns) å½“å‰RTTI+unordered_map 120-150 300-400 1000+ ç¼–è¯‘æœŸç±»å‹ç´¢å¼•+æ•°ç»„ 15-25 40-60 80-100 ä¼˜åŒ–æ¯”ä¾‹ 8-10å€ 7-8å€ 10å€ä»¥ä¸Š 4.2 ååé‡å¯¹æ¯” # äº‹ä»¶ç±»å‹æ•°é‡ å½“å‰å®ç°(ä¸‡äº‹ä»¶/ç§’) ä¼˜åŒ–å(ä¸‡äº‹ä»¶/ç§’) æ€§èƒ½æå‡ 10ç§ 150-200 800-1000 4-5å€ 50ç§ 100-150 600-800 5-6å€ 100ç§ 80-120 400-600 4-5å€ 4.3 å†…å­˜è®¿é—®æ€§èƒ½ # Cache Missç‡ï¼šå½“å‰å®ç°çº¦15-25%ï¼Œä¼˜åŒ–åå¯é™è‡³3-5% å†…å­˜å¸¦å®½åˆ©ç”¨ç‡ï¼šä¼˜åŒ–åæå‡çº¦60-80% 5. ä¼˜åŒ–å»ºè®® #5.1 æ›¿ä»£handlers_æ˜ å°„è¡¨çš„æ–¹æ¡ˆ # ç¼–è¯‘æœŸç±»å‹æ˜ å°„ï¼š\nä½¿ç”¨æ¨¡æ¿å…ƒç¼–ç¨‹åœ¨ç¼–è¯‘æœŸä¸ºæ¯ç§äº‹ä»¶ç±»å‹åˆ†é…å”¯ä¸€ç´¢å¼• ç”¨å›ºå®šå¤§å°æ•°ç»„æ›¿ä»£std::unordered_mapï¼Œå®ç°O(1)ç¡®å®šæ€§æŸ¥æ‰¾ æé«˜å†…å­˜å±€éƒ¨æ€§ï¼Œå‡å°‘cache miss é¿å…è¿è¡Œæ—¶ç±»å‹æŸ¥æ‰¾ï¼š\nåœ¨äº‹ä»¶åŸºç±»ä¸­æ·»åŠ ç¼–è¯‘æœŸç¡®å®šçš„ç±»å‹æ ‡è¯†å­—æ®µ æ¶ˆé™¤typeidè¿ç®—ç¬¦çš„è¿è¡Œæ—¶å¼€é”€ 5.2 æ›¿ä»£RTTIçš„æ–¹æ¡ˆ # è‡ªå®šä¹‰ç±»å‹æ ‡è¯†ï¼š\nç›´æ¥é€šè¿‡äº‹ä»¶å¯¹è±¡è·å–ç±»å‹ç´¢å¼•ï¼Œæ— éœ€RTTIæŸ¥æ‰¾ æé«˜åˆ†æ”¯é¢„æµ‹å‡†ç¡®æ€§ ç±»å‹æ“¦é™¤ä¸é™æ€åˆ†å‘ç»“åˆï¼š\nåˆ©ç”¨æ¨¡æ¿å’Œè™šå‡½æ•°è¡¨å®ç°é™æ€åˆ†å‘ é¿å…dynamic_castçš„è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥å¼€é”€ 5.3 å†…å­˜ç®¡ç†ä¼˜åŒ– # å¯¹è±¡æ± æŠ€æœ¯ï¼š\né¢„åˆ†é…äº‹ä»¶å¯¹è±¡æ± ï¼Œé¿å…é¢‘ç¹åŠ¨æ€å†…å­˜åˆ†é… ä½¿ç”¨unique_ptræˆ–è£¸æŒ‡é’ˆ+RAIIï¼Œå‡å°‘å¼•ç”¨è®¡æ•°å¼€é”€ å†…å­˜å¯¹é½ä¼˜åŒ–ï¼š\nç¡®ä¿å…³é”®æ•°æ®ç»“æ„æŒ‰ç¼“å­˜è¡Œè¾¹ç•Œå¯¹é½ é¿å…false sharingé—®é¢˜ 5.4 å…¶ä»–æ€§èƒ½ä¼˜åŒ– # å¤šé˜Ÿåˆ—åˆ†æµï¼š\næ ¹æ®äº‹ä»¶ä¼˜å…ˆçº§æˆ–ç±»å‹ä½¿ç”¨å¤šä¸ªé˜Ÿåˆ— å‡å°‘é˜Ÿåˆ—ç«äº‰ï¼Œæé«˜ååé‡ æ‰¹é‡äº‹ä»¶å¤„ç†ï¼š\nä¸€æ¬¡å¤„ç†å¤šä¸ªäº‹ä»¶ï¼Œå‡å°‘å¾ªç¯å¼€é”€ æé«˜ç¼“å­˜åˆ©ç”¨ç‡å’ŒCPUæµæ°´çº¿æ•ˆç‡ è¿™ç§æŠ€æœ¯åœ¨æ— é”é˜Ÿåˆ—çš„æœ€ä½³å®è·µä¸­æœ‰è¯¦ç»†è®¨è®º å¼‚å¸¸å¤„ç†ä¼˜åŒ–ï¼š\nåœ¨å…³é”®è·¯å¾„ä¸Šé¿å…å¯èƒ½æŠ›å‡ºå¼‚å¸¸çš„æ“ä½œ ä½¿ç”¨é”™è¯¯ç æ›¿ä»£å¼‚å¸¸æœºåˆ¶ 6. ç»“è®º #å½“å‰çš„LockFreeEventBuså®ç°è™½ç„¶åŠŸèƒ½å®Œæ•´ï¼Œä½†å­˜åœ¨æ˜æ˜¾çš„æ€§èƒ½ç“¶é¢ˆï¼Œä¸å®Œå…¨é€‚åˆé«˜é¢‘äº¤æ˜“ç³»ç»Ÿï¼š\nä¸»è¦æ€§èƒ½é—®é¢˜ï¼š\nåŸºäºstd::unordered_mapå’ŒRTTIçš„äº‹ä»¶åˆ†å‘æœºåˆ¶å¼•å…¥äº†8-10å€çš„å»¶è¿Ÿå¼€é”€ æ™ºèƒ½æŒ‡é’ˆçš„åŸå­æ“ä½œå’Œå†…å­˜åˆ†é…æˆä¸ºé«˜é¢‘åœºæ™¯ä¸‹çš„ç“¶é¢ˆ False sharingå’Œcache missé—®é¢˜å½±å“å¤šæ ¸æ‰©å±•æ€§ å®šé‡å½±å“ï¼š\näº‹ä»¶å¤„ç†å»¶è¿Ÿæ¯”ä¼˜åŒ–æ–¹æ¡ˆé«˜8-10å€ ååé‡æ¯”ä¼˜åŒ–æ–¹æ¡ˆä½4-6å€ å†…å­˜è®¿é—®æ•ˆç‡æœ‰æ˜¾è‘—æå‡ç©ºé—´ ä¼˜åŒ–æ•ˆæœé¢„æœŸï¼š\né€šè¿‡ç¼–è¯‘æœŸç±»å‹æ˜ å°„å’Œå†…å­˜ç®¡ç†ä¼˜åŒ–ï¼Œå¯å®ç°4-10å€çš„æ€§èƒ½æå‡ å»¶è¿Ÿå¯æ§åˆ¶åœ¨100nsä»¥å†…ï¼Œæ»¡è¶³é«˜é¢‘äº¤æ˜“ç³»ç»Ÿçš„ä¸¥è‹›è¦æ±‚ ç³»ç»Ÿååé‡å¯è¾¾åˆ°ç™¾ä¸‡çº§äº‹ä»¶/ç§’çš„å¤„ç†èƒ½åŠ› é€šè¿‡é‡‡ç”¨ç¼–è¯‘æœŸç±»å‹æ˜ å°„ã€è‡ªå®šä¹‰ç±»å‹æ ‡è¯†ã€å¯¹è±¡æ± å’Œå†…å­˜å¯¹é½ç­‰æŠ€æœ¯ï¼Œå¯ä»¥æ˜¾è‘—æå‡äº‹ä»¶æ€»çº¿çš„æ€§èƒ½ï¼Œä½¿å…¶æ›´é€‚åˆé«˜é¢‘äº¤æ˜“ç³»ç»Ÿçš„ä¸¥è‹›è¦æ±‚ã€‚è¿™äº›ä¼˜åŒ–ä¸ä»…èƒ½å¤Ÿæå‡æ€§èƒ½ï¼Œè¿˜èƒ½å¢å¼ºç³»ç»Ÿçš„å¯é¢„æµ‹æ€§å’Œç¨³å®šæ€§ã€‚\nå»¶ä¼¸é˜…è¯»ï¼šå¦‚æœæ‚¨å¯¹æ— é”é˜Ÿåˆ—çš„å®é™…åº”ç”¨åœºæ™¯æ„Ÿå…´è¶£ï¼Œè¯·å‚è€ƒæ— é”é˜Ÿåˆ—çš„å®é™…åº”ç”¨åœºæ™¯ä¸é€‰æ‹©æŒ‡å—ç« èŠ‚ï¼Œäº†è§£å¦‚ä½•æ ¹æ®ä¸åŒåœºæ™¯é€‰æ‹©åˆé€‚çš„é˜Ÿåˆ—å®ç°ã€‚\nå‚è€ƒ # æŸ¥çœ‹æ›´å¤šå†…å­˜åºç›¸å…³å†…å®¹ ","date":"20 June 2025","permalink":"/blog/2025-06-20-lockfree_eventbus_performance_analysis/","section":"Blog","summary":"æ¦‚è¿° #æœ¬æ–‡é’ˆå¯¹ç°æœ‰çš„LockFreeEventBuså®ç°è¿›è¡Œæ·±å…¥çš„æ€§èƒ½åˆ†æå’Œä¼˜åŒ–å»ºè®®ã€‚å½“å‰å®ç°é‡‡ç”¨äº†ä»¥ä¸‹æ ¸å¿ƒè®¾è®¡ï¼š\näº‹ä»¶ä¸å¤„ç†å‡½æ•°æ˜ å°„ï¼šä½¿ç”¨std::unordered_mapå»ºç«‹äº‹ä»¶ç±»å‹åˆ°å¤„ç†å‡½æ•°çš„æ˜ å°„å…³ç³» å¤„ç†å‡½æ•°å­˜å‚¨ï¼šä½¿ç”¨std::vectorå­˜å‚¨æ¯ç§äº‹ä»¶ç±»å‹å¯¹åº”çš„å¤„ç†å‡½æ•°åˆ—è¡¨ äº‹ä»¶åˆ†å‘æœºåˆ¶ï¼šåœ¨é«˜é¢‘è°ƒç”¨åœºæ™¯ä¸‹ä½¿ç”¨RTTIï¼ˆè¿è¡Œæ—¶ç±»å‹è¯†åˆ«ï¼‰æœºåˆ¶è¿›è¡Œäº‹ä»¶åˆ†å‘ å†…å­˜ç®¡ç†ï¼šå¤§é‡ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆè¿›è¡Œäº‹ä»¶å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸç®¡ç† è™½ç„¶è¿™ç§è®¾è®¡åœ¨åŠŸèƒ½ä¸Šå®Œæ•´å¯é ï¼Œä½†åœ¨é«˜é¢‘äº¤æ˜“ç­‰å¯¹å»¶è¿Ÿæåº¦æ•æ„Ÿçš„åœºæ™¯ä¸‹å­˜åœ¨æ˜¾è‘—çš„æ€§èƒ½ç“¶é¢ˆã€‚æœ¬æ–‡å°†è¯¦ç»†åˆ†æè¿™äº›ç“¶é¢ˆçš„æ ¹æœ¬åŸå› ï¼Œå¹¶æå‡ºé’ˆå¯¹æ€§çš„ä¼˜åŒ–å»ºè®®ã€‚\næ³¨æ„ï¼šæœ¬æ–‡æ˜¯æ·±å…¥ç†è§£æ— é”é˜Ÿåˆ—ï¼šä»åŸç†åˆ°å®è·µçš„å®Œæ•´æŒ‡å—çš„é…å¥—æ€§èƒ½åˆ†ææ–‡ç« ï¼Œå»ºè®®å…ˆé˜…è¯»è¯¥æ–‡ç« äº†è§£æ— é”é˜Ÿåˆ—çš„åŸºæœ¬åŸç†ã€‚\n1. æ ¸å¿ƒå·¥ä½œæœºåˆ¶ #1.1 åŸºæœ¬æ¶æ„ #LockFreeEventBusé‡‡ç”¨æ— é”é˜Ÿåˆ—å’Œå·¥ä½œçº¿ç¨‹çš„ç»„åˆï¼Œå®ç°äº‹ä»¶çš„å¼‚æ­¥å¤„ç†ï¼š\nclass LockFreeEventBus { private: LockFreeQueueEvent\u0026lt;std::shared_ptr\u0026lt;Event\u0026gt;\u0026gt; event_queue_; std::unordered_map\u0026lt;std::type_index, std::vector\u0026lt;std::function\u0026lt;void(std::shared_ptr\u0026lt;Event\u0026gt;)\u0026gt;\u0026gt;\u0026gt; handlers_; std::atomic\u0026lt;bool\u0026gt; running_; std::thread worker_thread_; // ... }; å…³é”®ç»„ä»¶ï¼š\nevent_queue_ï¼šæ— é”é˜Ÿåˆ—ï¼Œå­˜å‚¨å¾…å¤„ç†äº‹ä»¶ handlers_ï¼šä»¥äº‹ä»¶ç±»å‹ä¸ºé”®çš„å¤„ç†å‡½æ•°æ˜ å°„è¡¨ worker_thread_ï¼šå•ç‹¬å·¥ä½œçº¿ç¨‹ï¼Œå¾ªç¯å¤„ç†äº‹ä»¶é˜Ÿåˆ— 1.2 äº‹ä»¶å‘å¸ƒæµç¨‹ #void publish(std::shared_ptr\u0026lt;Event\u0026gt; event) { // è®¾ç½®å‘å¸ƒæ—¶é—´ event-\u0026gt;setPublishTime(std::chrono::high_resolution_clock::now()); // æ›´æ–°é˜Ÿåˆ—ç»Ÿè®¡ auto current_size = queue_size_.fetch_add(1) + 1; // ... // å…¥é˜Ÿ event_queue_.enqueue(std::move(event)); } é‡è¦è¯´æ˜ï¼šå‘å¸ƒäº‹ä»¶åªæ¶‰åŠé˜Ÿåˆ—æ“ä½œï¼Œä¸ä¼šä¿®æ”¹handlers_æ˜ å°„è¡¨ã€‚æ¯æ¬¡publishè°ƒç”¨åªæ˜¯å°†äº‹ä»¶å¯¹è±¡åŠ å…¥é˜Ÿåˆ—ï¼Œä¸æ¶‰åŠå¯¹å¤„ç†å‡½æ•°æ˜ å°„è¡¨çš„ä»»ä½•è¯»å†™æ“ä½œã€‚äº‹ä»¶ç±»å‹ä½œä¸ºkeyåœ¨subscribeé˜¶æ®µå·²ç»ç¡®å®šï¼Œè¿è¡Œæ—¶çš„publishæ“ä½œä¸handlers_æ˜ å°„è¡¨å®Œå…¨è§£è€¦ã€‚\n1.3 äº‹ä»¶å¤„ç†æµç¨‹ #void process_events() { while (running_) { std::shared_ptr\u0026lt;Event\u0026gt; event; if (event_queue_.dequeue(event)) { // è®¡ç®—å¤„ç†å»¶è¿Ÿ // .","title":"LockFreeEventBusæŠ€æœ¯å‰–æï¼šå·¥ä½œæœºåˆ¶ä¸æ€§èƒ½ç“¶é¢ˆåˆ†æ"},{"content":"ä¸»é¢˜ï¼šåŸºäºå¹¶å‘è¯»å†™æ€§èƒ½ä¼˜åŒ–çš„è®¢å•æ•°æ®ç»“æ„é‡æ„ä¸åº•å±‚æœºåˆ¶å‰–æ\nç›®å½• # ä¸€ã€ä¸šåŠ¡èƒŒæ™¯ï¼šè®¢å•çŠ¶æ€çš„é«˜å¹¶å‘ç»´æŠ¤ äºŒã€å¸¸è§è®¾è®¡é™·é˜±ï¼šchar[] å­—ç¬¦ä¸² ID ä¸å“ˆå¸Œè¡¨çš„æ€§èƒ½ç“¶é¢ˆ ä¸‰ã€ä¼˜åŒ–ç›®æ ‡ï¼šæè‡´çš„å¹¶å‘ + O(1) è®¿é—®æ€§èƒ½ å››ã€æ ¸å¿ƒä¼˜åŒ–ï¼šæ•´æ•° ID + array æ˜ å°„ç»“æ„ äº”ã€åº•å±‚åŸç†è§£æï¼šä¸ºä»€ä¹ˆ array + int ID æ›´å¿«? 1. å†…å­˜å¯»å€æœºåˆ¶(æŒ‡é’ˆåç§») 2. CPU Cache Line åˆ©ç”¨ä¸ä¼ªå…±äº«é—®é¢˜ 3. é¿å…å †åˆ†é…ä¸å†…å­˜ç¢ç‰‡ 4. å†…å­˜åº(Memory Ordering)é€‰æ‹©ä¸åŸå­æ“ä½œ 5. æ•´æ•°IDåˆ†é…å’Œå›æ”¶æœºåˆ¶ å…­ã€æ€§èƒ½æµ‹è¯•æ•°æ® ä¸ƒã€å…³é”®ç»„ä»¶ä¼˜åŒ–ç¤ºä¾‹ 1. OrderBookå®ç°ä¼˜åŒ– 2. RingBufferä¼˜åŒ– å…«ã€NUMAæ¶æ„ä¸‹çš„å†…å­˜è®¿é—®ä¼˜åŒ– ä¹ã€æœ€ç»ˆæ–¹æ¡ˆä¼˜åŠ¿å¯¹æ¯”æ€»ç»“ ä¹ã€ç»“è¯­ï¼šé«˜é¢‘ç³»ç»Ÿçš„è®¾è®¡å“²å­¦ ä¸€ã€ä¸šåŠ¡èƒŒæ™¯ï¼šè®¢å•çŠ¶æ€çš„é«˜å¹¶å‘ç»´æŠ¤ #åœ¨é«˜é¢‘äº¤æ˜“(HFT)ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ•°ç™¾ä¸‡çº§åˆ«çš„è®¢å•çŠ¶æ€è¿›è¡Œå¹¶å‘è¯»å†™ï¼Œä»¥æ”¯æ’‘å¦‚ä¸‹æ“ä½œï¼š\nâœ… æ–°å¢è®¢å•(add_order(order_id)) âœ… ä¿®æ”¹è®¢å•çŠ¶æ€(å¦‚ fill_qty, status ç­‰) âœ… é«˜é¢‘æŸ¥è¯¢è®¢å•çŠ¶æ€(å¦‚æˆäº¤å‡ä»·ã€å½“å‰å‰©ä½™é‡ç­‰) è¿™äº›æ“ä½œé«˜å¹¶å‘ã€å»¶è¿Ÿæ•æ„Ÿï¼Œéœ€è¦ O(1) çº§åˆ«çš„å“åº”ï¼Œå¹¶ä¸”ä¸èƒ½äº§ç”Ÿæ€§èƒ½æŠ–åŠ¨æˆ–ä¸å¯æ§çš„é”ç«äº‰ã€‚\näºŒã€å¸¸è§è®¾è®¡é™·é˜±ï¼šchar[] å­—ç¬¦ä¸² ID ä¸å“ˆå¸Œè¡¨çš„æ€§èƒ½ç“¶é¢ˆ #åœ¨æ—©æœŸç³»ç»Ÿä¸­ï¼Œå¸¸è§çš„è®¾è®¡æ˜¯ä»¥å­—ç¬¦ä¸² ID ä½œä¸ºè®¢å•ä¸»é”®ï¼Œä¾‹å¦‚ï¼š\nstruct Order { char id[32]; char instId[16]; ... }; std::unordered_map\u0026lt;std::string, Order*\u0026gt; order_map; è™½ç„¶è¿™ç§ç»“æ„é€šç”¨æ€§å¼ºã€ç¼–ç æ–¹ä¾¿ï¼Œä½†åœ¨é«˜é¢‘åœºæ™¯ä¸‹å­˜åœ¨ä¸¥é‡æ€§èƒ½é—®é¢˜ï¼š\nâŒ å­—ç¬¦ä¸² ID çš„æ€§èƒ½ä»£ä»·ï¼š\nå±‚é¢ æ€§èƒ½é—®é¢˜ è¯´æ˜ ç©ºé—´æˆæœ¬ char[32] æ¯ä¸ªå¯¹è±¡å›ºå®š 32 å­—èŠ‚ ç›¸æ¯”æ•´æ•°å¤š 8 å€ä»¥ä¸Šç©ºé—´ æ¯”è¾ƒä»£ä»· å­—ç¬¦ä¸²æ¯”è¾ƒæ˜¯ O(N),ä¸èƒ½ä¸€æ¡æŒ‡ä»¤å®Œæˆ strcmp æˆ– memcmp æˆæœ¬é«˜ å“ˆå¸Œå¼€é”€ å­—ç¬¦ä¸²å“ˆå¸Œéœ€é€å­—ç¬¦å¤„ç† å¤šæ¬¡å†…å­˜è®¿é—®,CPU åˆ†æ”¯é¢„æµ‹éš¾ å†…å­˜å±€éƒ¨æ€§ ç»“æ„ä½“å¤§,cache line å‘½ä¸­ç‡ä½ è¯»å–åŒä¸€ cache line ä¸­çš„å¯¹è±¡æ›´å°‘ é¢‘ç¹å †åˆ†é… std::unordered_map ä½¿ç”¨å †åˆ†é… è§¦å‘ malloc / rehash å¸¦æ¥ä¸ç¡®å®šæ€§ å¹¶å‘æ€§èƒ½å·® å¹¶å‘è®¿é—®éœ€åŠ é”æˆ–åˆ†æ®µé” std::unordered_map ä¸æ˜¯çº¿ç¨‹å®‰å…¨ ä¸‰ã€ä¼˜åŒ–ç›®æ ‡ï¼šæè‡´çš„å¹¶å‘ + O(1) è®¿é—®æ€§èƒ½ #æˆ‘ä»¬å¸Œæœ›å®ç°ä»¥ä¸‹ç›®æ ‡ï¼š\nâœ… æ‰€æœ‰æŸ¥æ‰¾ã€ä¿®æ”¹æ“ä½œ O(1) âœ… æ”¯æŒç™¾ä¸‡çº§è®¢å•å¹¶å‘è¯»å†™ï¼Œæ— é”æˆ–åŸå­çº§åˆ«åŒæ­¥ âœ… é«˜ cache å‘½ä¸­ç‡ï¼Œæœ€å°åŒ–å†…å­˜å¸¦å®½å‹åŠ› âœ… ä¸ä¾èµ–å †å†…å­˜ï¼Œç¨³å®šæ€§å¯æ§ å››ã€æ ¸å¿ƒä¼˜åŒ–ï¼šæ•´æ•° ID + array æ˜ å°„ç»“æ„ #âœ… ä½¿ç”¨å›ºå®šæ•´æ•° ID æ›¿ä»£å­—ç¬¦ä¸²ï¼š\nuint32_t order_id = map_order_id(\u0026#34;order-abc-123\u0026#34;); // ä¸€æ¬¡æ€§è½¬æ¢ è®¢å•æ± å˜ä¸ºï¼š\nstd::array\u0026lt;Order, MAX_ORDERS\u0026gt; order_table; âœ… ä¼˜åŒ–åçš„ Order ç»“æ„ä½“(aligned + åŸå­å­—æ®µ)ï¼š\nstruct alignas(64) Order { uint64_t order_id; uint16_t symbol_id; std::atomic\u0026lt;OrderStatus\u0026gt; status; double price; double quantity; std::atomic\u0026lt;double\u0026gt; filled; uint64_t create_time; // cold fields: double avg_fill_price; uint64_t fill_time; }; äº”ã€åº•å±‚åŸç†è§£æï¼šä¸ºä»€ä¹ˆ array + int ID æ›´å¿«? #ğŸ”¹ 1. å†…å­˜å¯»å€æœºåˆ¶(æŒ‡é’ˆåç§») #// ä»¥ order_id ä¸º index,CPU å¯ç›´æ¥å¯»å€: Order* ptr = \u0026amp;order_table[order_id]; // 1 æ¡åŠ æ³•æŒ‡ä»¤å®Œæˆ ç›¸æ¯”å­—ç¬¦ä¸²ï¼š\nhash(\u0026#34;order-abc-123\u0026#34;) â†’ æŸ¥æ‰¾å“ˆå¸Œæ¡¶ â†’ æ‹‰é“¾æˆ– open addressing â†’ è¿­ä»£æ¯”è¾ƒå­—ç¬¦ä¸² ğŸ“Œ æ•´æ•° ID æŸ¥æ‰¾æ˜¯ O(1)ï¼Œå­—ç¬¦ä¸²å“ˆå¸Œè¡¨ä¸º O(1) å¹³å‡ï¼Œä½†å¯èƒ½é€€åŒ–ä¸º O(N)ã€‚\nğŸ”¹ 2. CPU Cache Line åˆ©ç”¨ä¸ä¼ªå…±äº«é—®é¢˜ # ä¸€ä¸ª std::array ç»“æ„æ˜¯è¿ç»­å†…å­˜å— æ¯æ¬¡åŠ è½½ cache line ä¼šå¸¦æ¥ç›¸é‚»è®¢å•å¯¹è±¡ å­—æ®µå¦‚ status, price ç´§å¯†æ’åˆ—ï¼Œå¯å……åˆ†åˆ©ç”¨é¢„å–å’Œ SIMD æŒ‡ä»¤ä¼˜åŒ– è€Œå­—ç¬¦ä¸² ID å“ˆå¸Œè¡¨å¯¹è±¡ï¼š\nå­˜åœ¨æŒ‡é’ˆé—´æ¥å±‚ å¯¹è±¡åˆ†å¸ƒä¸è¿ç»­ï¼Œcache miss é¢‘ç¹ï¼Œcache locality æå·® ä¼ªå…±äº«(False Sharing)é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ #å½“å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ä½äºåŒä¸€ç¼“å­˜è¡Œçš„ä¸åŒå˜é‡æ—¶ï¼Œä¼šå¯¼è‡´ç¼“å­˜è¡Œé¢‘ç¹åœ¨æ ¸å¿ƒé—´åŒæ­¥ï¼Œé™ä½æ€§èƒ½ã€‚è¿™å°±æ˜¯ä¼ªå…±äº«é—®é¢˜ã€‚\n// é”™è¯¯ç¤ºä¾‹ï¼šå¯èƒ½å¯¼è‡´ä¼ªå…±äº« struct Order { std::atomic\u0026lt;OrderStatus\u0026gt; status; std::atomic\u0026lt;double\u0026gt; filled; // å…¶ä»–å­—æ®µ... }; è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ alignas(64) å¯¹å…³é”®åŸå­å­—æ®µè¿›è¡Œå¯¹é½ï¼š\n// æ­£ç¡®ç¤ºä¾‹ï¼šé¿å…ä¼ªå…±äº« struct Order { alignas(64) std::atomic\u0026lt;OrderStatus\u0026gt; status; // å…¶ä»–éé¢‘ç¹ä¿®æ”¹çš„å­—æ®µ... alignas(64) std::atomic\u0026lt;double\u0026gt; filled; // å…¶ä»–å­—æ®µ... }; ğŸ”¹ 3. é¿å…å †åˆ†é…ä¸å†…å­˜ç¢ç‰‡ # std::array æ˜¯å®Œå…¨é™æ€å†…å­˜ç»“æ„ï¼Œåˆ†é…æ—¶ç¡®å®šå¤§å° æ— éœ€ malloc/freeï¼Œæ—  GC å‹åŠ›ï¼Œå†…å­˜è®¿é—®é¢„æµ‹å¯æ§ unordered_map ä¼šé¢‘ç¹ mallocï¼Œrehash ä¼šé€ æˆç³»ç»ŸæŠ–åŠ¨ ğŸ”¹ 4. å†…å­˜åº(Memory Ordering)é€‰æ‹©ä¸åŸå­æ“ä½œ #åŸå­æ“ä½œçš„å†…å­˜åºå¯¹æ€§èƒ½å½±å“æ˜¾è‘—ã€‚åœ¨é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­ï¼Œæ­£ç¡®é€‰æ‹©å†…å­˜åºå¯ä»¥å¤§å¹…æå‡æ€§èƒ½ã€‚\n// é«˜æ€§èƒ½åŸå­æ“ä½œç¤ºä¾‹ // æ¥è‡ª TradeTypes.h struct alignas(64) Order { // ... std::atomic\u0026lt;OrderStatus\u0026gt; status; // ... // è·å–çŠ¶æ€ï¼Œä½¿ç”¨acquireè¯­ä¹‰ä¿è¯è¯»å–æœ€æ–°å€¼ OrderStatus getStatus() const { return status.load(std::memory_order_acquire); } // è®¾ç½®çŠ¶æ€ï¼Œä½¿ç”¨releaseè¯­ä¹‰ä¿è¯å…¶ä»–çº¿ç¨‹èƒ½çœ‹åˆ°å˜åŒ– void setStatus(OrderStatus newStatus) { status.store(newStatus, std::memory_order_release); } }; ğŸ”¹ 5. æ•´æ•°IDåˆ†é…å’Œå›æ”¶æœºåˆ¶ #é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­ï¼Œæ•´æ•°IDçš„ç®¡ç†æ˜¯å…³é”®é—®é¢˜ã€‚éœ€è¦è§£å†³ï¼š\nIDå”¯ä¸€æ€§ä¿è¯ï¼šä½¿ç”¨åŸå­è®¡æ•°å™¨ç”Ÿæˆå”¯ä¸€ID IDå›æ”¶æœºåˆ¶ï¼šä½¿ç”¨ä½å›¾æˆ–ç©ºé—²é“¾è¡¨ç®¡ç†å¯é‡ç”¨ID IDä¸å¤–éƒ¨å­—ç¬¦ä¸²æ˜ å°„ï¼šç»´æŠ¤é«˜æ•ˆçš„åŒå‘æ˜ å°„è¡¨ å…­ã€æ€§èƒ½æµ‹è¯•æ•°æ® #ä»¥ä¸‹æ˜¯åœ¨å®é™…é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­æµ‹è¯•çš„æ€§èƒ½æ•°æ®ï¼ˆåŸºå‡†æµ‹è¯•ç»“æœï¼‰ï¼š\næ“ä½œ å­—ç¬¦ä¸²ID + unordered_map æ•´æ•°ID + array æ€§èƒ½æå‡ æŸ¥æ‰¾è®¢å• 245 ns 12 ns 20.4å€ æ›´æ–°çŠ¶æ€ 310 ns 28 ns 11.1å€ å¹¶å‘è¯»å†™(8çº¿ç¨‹) 1450 ns 42 ns 34.5å€ L1 ç¼“å­˜å‘½ä¸­ç‡ 72% 96% 1.33å€ å†…å­˜å¸¦å®½ä½¿ç”¨ 3.8 GB/s 0.9 GB/s 4.2å€å‡å°‘ æµ‹è¯•ç¯å¢ƒï¼šIntel Xeon Gold 6248R, 3.0GHz, 24æ ¸å¿ƒ, 48çº¿ç¨‹, 36MB L3ç¼“å­˜\nä¸ƒã€å…³é”®ç»„ä»¶ä¼˜åŒ–ç¤ºä¾‹ #1. OrderBookå®ç°ä½¿ç”¨äº†tbb::concurrent_mapï¼Œè¿™ä¸æ˜¯æœ€ä¼˜çš„é€‰æ‹©ï¼š #åŸå§‹ç‰ˆæœ¬ï¼š\n// ä½¿ç”¨æ ‘ç»“æ„çš„å¹¶å‘å®¹å™¨ï¼Œæ€§èƒ½æ¬¡ä¼˜ class LockFreeOrderBook { private: std::string symbol_; tbb::concurrent_map\u0026lt;double, PriceLevel, std::greater\u0026lt;double\u0026gt;\u0026gt; bids_; // ä¹°ç›˜é™åº tbb::concurrent_map\u0026lt;double, PriceLevel, std::less\u0026lt;double\u0026gt;\u0026gt; asks_; // å–ç›˜å‡åº // ... }; ä¼˜åŒ–ç‰ˆæœ¬ï¼š\n// ä½¿ç”¨æ•°ç»„+æ•´æ•°ç´¢å¼•çš„O(1)è®¿é—®ç»“æ„ class OptimizedOrderBook { private: std::string symbol_; // ä½¿ç”¨å›ºå®šå¤§å°æ•°ç»„å’Œä»·æ ¼æ˜ å°„å®ç°O(1)æŸ¥è¯¢ static constexpr size_t PRICE_LEVELS = 10000; static constexpr double MIN_PRICE = 0.0; static constexpr double PRICE_STEP = 0.01; // ä»·æ ¼ç¦»æ•£åŒ–æ˜ å°„å‡½æ•° inline size_t priceToIndex(double price) const { return static_cast\u0026lt;size_t\u0026gt;((price - MIN_PRICE) / PRICE_STEP); } // ä¹°å–ç›˜ä½¿ç”¨å¯¹é½çš„è¿ç»­æ•°ç»„ alignas(64) std::array\u0026lt;PriceLevel, PRICE_LEVELS\u0026gt; bids_{}; alignas(64) std::array\u0026lt;PriceLevel, PRICE_LEVELS\u0026gt; asks_{}; // ä½¿ç”¨åŸå­å˜é‡è·Ÿè¸ªæœ€ä½³ä»·ä½ï¼Œé¿å…å…¨è¡¨æ‰«æ alignas(64) std::atomic\u0026lt;size_t\u0026gt; best_bid_idx_{0}; alignas(64) std::atomic\u0026lt;size_t\u0026gt; best_ask_idx_{0}; // ... }; ä¼˜åŒ–ç†ç”±ï¼š\nå°†O(log n)çš„æ ‘æŸ¥æ‰¾æ›¿æ¢ä¸ºO(1)çš„æ•°ç»„ç´¢å¼•è®¿é—® æ¶ˆé™¤åŠ¨æ€å†…å­˜åˆ†é…ï¼Œé¿å…GCå»¶è¿Ÿ ä½¿ç”¨è¿ç»­å†…å­˜å¸ƒå±€æé«˜ç¼“å­˜å‘½ä¸­ç‡ é€šè¿‡ç¼“å­˜è¡Œå¯¹é½é˜²æ­¢ä¼ªå…±äº« 2. RingBufferä¼˜åŒ– #åŸå§‹ç‰ˆæœ¬ï¼š\ntemplate\u0026lt;typename T, size_t SIZE = 1024\u0026gt; class RingBuffer { private: std::array\u0026lt;T, SIZE\u0026gt; buffer_; std::atomic\u0026lt;size_t\u0026gt; read_index_{0}; std::atomic\u0026lt;size_t\u0026gt; write_index_{0}; public: bool push(const T\u0026amp; item) { size_t current_write = write_index_.load(std::memory_order_relaxed); size_t next_write = (current_write + 1) % SIZE; // ... } // ... }; ä¼˜åŒ–ç‰ˆæœ¬ï¼š\ntemplate\u0026lt;typename T, size_t SIZE = 1024\u0026gt; class OptimizedRingBuffer { private: static_assert((SIZE \u0026amp; (SIZE - 1)) == 0, \u0026#34;SIZE must be power of 2\u0026#34;); static constexpr size_t MASK = SIZE - 1; // ä½¿ç”¨ç¼“å­˜è¡Œå¯¹é½é˜²æ­¢ä¼ªå…±äº« alignas(64) std::array\u0026lt;T, SIZE\u0026gt; buffer_; alignas(64) std::atomic\u0026lt;size_t\u0026gt; write_index_{0}; alignas(64) std::atomic\u0026lt;size_t\u0026gt; read_index_{0}; public: bool push(T\u0026amp;\u0026amp; item) noexcept { const size_t current = write_index_.load(std::memory_order_relaxed); const size_t next = (current + 1) \u0026amp; MASK; // ä½¿ç”¨ä½æ©ç ä»£æ›¿% // ... } // æ‰¹é‡æ“ä½œï¼Œå‡å°‘åŸå­æ“ä½œæ¬¡æ•° template\u0026lt;typename Iterator\u0026gt; size_t push_batch(Iterator begin, Iterator end) noexcept { // ä¸€æ¬¡æ€§è¯»å–ç´¢å¼•ï¼Œå‡å°‘åŸå­æ“ä½œ const size_t read_idx = read_index_.load(std::memory_order_acquire); size_t write_idx = write_index_.load(std::memory_order_relaxed); // æ‰¹é‡å†™å…¥ // ... } }; ä¼˜åŒ–ç†ç”±ï¼š\nä½¿ç”¨ä½æ©ç (\u0026amp;)æ›¿ä»£å–æ¨¡è¿ç®—(%)ï¼Œæé«˜æ€§èƒ½ æ·»åŠ ç¼“å­˜è¡Œå¯¹é½ï¼Œé˜²æ­¢ä¼ªå…±äº« å®ç°æ‰¹é‡æ“ä½œæ¥å£ï¼Œå‡å°‘åŸå­æ“ä½œæ¬¡æ•° ç¡®ä¿SIZEä¸º2çš„å¹‚ï¼Œä¼˜åŒ–å†…å­˜å¯¹é½å’Œä½æ“ä½œ å…«ã€NUMAæ¶æ„ä¸‹çš„å†…å­˜è®¿é—®ä¼˜åŒ– #åœ¨å¤šå¤„ç†å™¨NUMAæ¶æ„ä¸‹ï¼Œå†…å­˜è®¿é—®å»¶è¿Ÿä¸å‡åŒ€ï¼Œéœ€è¦è€ƒè™‘èŠ‚ç‚¹äº²å’Œæ€§ï¼š\n#include \u0026lt;numa.h\u0026gt; // ä¸ºæ¯ä¸ªNUMAèŠ‚ç‚¹åˆ›å»ºç‹¬ç«‹çš„è®¢å•æ±  std::vector\u0026lt;std::array\u0026lt;Order, MAX_ORDERS_PER_NODE\u0026gt;\u0026gt; node_order_tables(numa_num_configured_nodes()); // åˆå§‹åŒ–æ—¶å°†å†…å­˜ç»‘å®šåˆ°å¯¹åº”NUMAèŠ‚ç‚¹ void initialize_order_tables() { for (int node = 0; node \u0026lt; numa_num_configured_nodes(); ++node) { numa_set_preferred(node); node_order_tables[node] = std::array\u0026lt;Order, MAX_ORDERS_PER_NODE\u0026gt;(); } } // æ ¹æ®çº¿ç¨‹æ‰€åœ¨NUMAèŠ‚ç‚¹é€‰æ‹©å¯¹åº”çš„è®¢å•æ±  Order* get_order(uint32_t order_id) { int node = numa_node_of_cpu(sched_getcpu()); return \u0026amp;node_order_tables[node][order_id % MAX_ORDERS_PER_NODE]; } ä¹ã€æœ€ç»ˆæ–¹æ¡ˆä¼˜åŠ¿å¯¹æ¯”æ€»ç»“ # æ–¹æ¡ˆ æŸ¥æ‰¾å¤æ‚åº¦ å†™å…¥å¤æ‚åº¦ å†…å­˜åˆ†é… cache å‘½ä¸­ å¹¶å‘æ€§èƒ½ HFTæ¨è std::unordered_map O(1) å‡å€¼ O(1)-O(N) å †å†…å­˜ å·® å·® âŒ tbb::concurrent_unordered_map O(1) å‡å€¼ O(1)-O(N) å †å†…å­˜ ä¸€èˆ¬ ä¸­ âš ï¸ std::array + æ•´æ•° ID O(1) O(1) æ ˆæˆ–é™æ€å†…å­˜ æœ€å¥½ æœ€ä¼˜ âœ…âœ…âœ… ä¹ã€ç»“è¯­ï¼šé«˜é¢‘ç³»ç»Ÿçš„è®¾è®¡å“²å­¦ #åœ¨ HFT ç³»ç»Ÿä¸­ï¼Œ\u0026ldquo;æ¯ä¸€æ¬¡å†…å­˜è®¿é—®éƒ½æ˜¯äº¤æ˜“æœºä¼š\u0026rdquo;ã€‚ æˆ‘ä»¬è®¾è®¡ç»“æ„ä½“å’Œè®¿é—®è·¯å¾„æ—¶ï¼Œå¿…é¡»ä»¥:\nâœ¨ å¸¸æ•°çº§æ—¶é—´å¤æ‚åº¦ âœ¨ cache å‹å¥½æ€§ âœ¨ æä½åˆ†æ”¯ã€æœ€å°‘ç³»ç»Ÿè°ƒç”¨ âœ¨ å¯é¢„æµ‹çš„æ‰§è¡Œè·¯å¾„(æ— å †ã€æ— é”ã€æ— é˜»å¡) ä¸ºç¬¬ä¸€åŸåˆ™ã€‚\nä½¿ç”¨ std::array + åŸå­å­—æ®µ + æ•´æ•° IDï¼Œæˆ‘ä»¬ä¸ä»…æ˜¾è‘—å‡å°‘äº†å»¶è¿Ÿå’Œä¸ç¡®å®šæ€§ï¼Œä¹Ÿæ„å»ºäº†ä¸€ä¸ªçœŸæ­£ç¬¦åˆé«˜é¢‘ç³»ç»Ÿç‰¹æ€§çš„æ•°æ®åº•åº§ã€‚\n","date":"19 June 2025","permalink":"/blog/2025-06-19-how_to_design_order_inlocalmemory/","section":"Blog","summary":"ä¸»é¢˜ï¼šåŸºäºå¹¶å‘è¯»å†™æ€§èƒ½ä¼˜åŒ–çš„è®¢å•æ•°æ®ç»“æ„é‡æ„ä¸åº•å±‚æœºåˆ¶å‰–æ\nç›®å½• # ä¸€ã€ä¸šåŠ¡èƒŒæ™¯ï¼šè®¢å•çŠ¶æ€çš„é«˜å¹¶å‘ç»´æŠ¤ äºŒã€å¸¸è§è®¾è®¡é™·é˜±ï¼šchar[] å­—ç¬¦ä¸² ID ä¸å“ˆå¸Œè¡¨çš„æ€§èƒ½ç“¶é¢ˆ ä¸‰ã€ä¼˜åŒ–ç›®æ ‡ï¼šæè‡´çš„å¹¶å‘ + O(1) è®¿é—®æ€§èƒ½ å››ã€æ ¸å¿ƒä¼˜åŒ–ï¼šæ•´æ•° ID + array æ˜ å°„ç»“æ„ äº”ã€åº•å±‚åŸç†è§£æï¼šä¸ºä»€ä¹ˆ array + int ID æ›´å¿«? 1. å†…å­˜å¯»å€æœºåˆ¶(æŒ‡é’ˆåç§») 2. CPU Cache Line åˆ©ç”¨ä¸ä¼ªå…±äº«é—®é¢˜ 3. é¿å…å †åˆ†é…ä¸å†…å­˜ç¢ç‰‡ 4. å†…å­˜åº(Memory Ordering)é€‰æ‹©ä¸åŸå­æ“ä½œ 5. æ•´æ•°IDåˆ†é…å’Œå›æ”¶æœºåˆ¶ å…­ã€æ€§èƒ½æµ‹è¯•æ•°æ® ä¸ƒã€å…³é”®ç»„ä»¶ä¼˜åŒ–ç¤ºä¾‹ 1. OrderBookå®ç°ä¼˜åŒ– 2. RingBufferä¼˜åŒ– å…«ã€NUMAæ¶æ„ä¸‹çš„å†…å­˜è®¿é—®ä¼˜åŒ– ä¹ã€æœ€ç»ˆæ–¹æ¡ˆä¼˜åŠ¿å¯¹æ¯”æ€»ç»“ ä¹ã€ç»“è¯­ï¼šé«˜é¢‘ç³»ç»Ÿçš„è®¾è®¡å“²å­¦ ä¸€ã€ä¸šåŠ¡èƒŒæ™¯ï¼šè®¢å•çŠ¶æ€çš„é«˜å¹¶å‘ç»´æŠ¤ #åœ¨é«˜é¢‘äº¤æ˜“(HFT)ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ•°ç™¾ä¸‡çº§åˆ«çš„è®¢å•çŠ¶æ€è¿›è¡Œå¹¶å‘è¯»å†™ï¼Œä»¥æ”¯æ’‘å¦‚ä¸‹æ“ä½œï¼š\nâœ… æ–°å¢è®¢å•(add_order(order_id)) âœ… ä¿®æ”¹è®¢å•çŠ¶æ€(å¦‚ fill_qty, status ç­‰) âœ… é«˜é¢‘æŸ¥è¯¢è®¢å•çŠ¶æ€(å¦‚æˆäº¤å‡ä»·ã€å½“å‰å‰©ä½™é‡ç­‰) è¿™äº›æ“ä½œé«˜å¹¶å‘ã€å»¶è¿Ÿæ•æ„Ÿï¼Œéœ€è¦ O(1) çº§åˆ«çš„å“åº”ï¼Œå¹¶ä¸”ä¸èƒ½äº§ç”Ÿæ€§èƒ½æŠ–åŠ¨æˆ–ä¸å¯æ§çš„é”ç«äº‰ã€‚\näºŒã€å¸¸è§è®¾è®¡é™·é˜±ï¼šchar[] å­—ç¬¦ä¸² ID ä¸å“ˆå¸Œè¡¨çš„æ€§èƒ½ç“¶é¢ˆ #åœ¨æ—©æœŸç³»ç»Ÿä¸­ï¼Œå¸¸è§çš„è®¾è®¡æ˜¯ä»¥å­—ç¬¦ä¸² ID ä½œä¸ºè®¢å•ä¸»é”®ï¼Œä¾‹å¦‚ï¼š\nstruct Order { char id[32]; char instId[16]; .","title":"é«˜é¢‘äº¤æ˜“ä¸­çš„è®¢å•æ•°æ®ç»“æ„è®¾è®¡ä¸æ€§èƒ½ä¼˜åŒ–å®æˆ˜"},{"content":"1. ä¼˜åŒ–çº§åˆ«çš„æœ¬è´¨ä¸ç¼–è¯‘è¿‡ç¨‹ #ç¼–è¯‘å™¨ä¼˜åŒ–æ˜¯å°†æºä»£ç è½¬æ¢ä¸ºæ›´é«˜æ•ˆæœºå™¨ç çš„ç³»ç»Ÿæ€§è¿‡ç¨‹ï¼Œæ¯ä¸ªä¼˜åŒ–çº§åˆ«ä»£è¡¨äº†ä¸åŒçš„è½¬æ¢ç­–ç•¥é›†åˆã€‚è¦ç†è§£è¿™äº›çº§åˆ«ï¼Œé¦–å…ˆéœ€è¦äº†è§£ç¼–è¯‘å™¨çš„å·¥ä½œæµç¨‹ï¼š\nè¯æ³•åˆ†æ â†’ 2. è¯­æ³•åˆ†æ â†’ 3. è¯­ä¹‰åˆ†æ â†’ 4. ä¸­é—´è¡¨ç¤ºç”Ÿæˆ â†’ 5. ä¼˜åŒ– â†’ 6. ä»£ç ç”Ÿæˆ ä¼˜åŒ–çº§åˆ«ä¸»è¦å½±å“ç¬¬5æ­¥ï¼Œå†³å®šåº”ç”¨å“ªäº›è½¬æ¢ç®—æ³•åŠå…¶æ¿€è¿›ç¨‹åº¦ã€‚\n2. -O0ï¼šé›¶ä¼˜åŒ–çš„åº•å±‚æœºåˆ¶ #æ ¸å¿ƒåŸç† #-O0çš„æœ¬è´¨æ˜¯ç›´æ¥æ˜ å°„ï¼šä¿æŒæºä»£ç ä¸ç”Ÿæˆçš„æœºå™¨ç ä¹‹é—´çš„ä¸€ä¸€å¯¹åº”å…³ç³»ï¼Œå‡ ä¹ä¸è¿›è¡Œä»»ä½•è½¬æ¢ã€‚\nåº•å±‚å®ç°æœºåˆ¶ # å˜é‡åˆ†é…ç­–ç•¥ï¼š\næ¯ä¸ªå˜é‡éƒ½åˆ†é…ç‹¬ç«‹çš„æ ˆç©ºé—´ å³ä½¿æ˜¯ä¸´æ—¶å˜é‡ä¹Ÿä¼šå†™å›å†…å­˜ ä¸è¿›è¡Œå¯„å­˜å™¨é‡ç”¨ä¼˜åŒ– æŒ‡ä»¤ç”Ÿæˆé€»è¾‘ï¼š\nä¸¥æ ¼æŒ‰ç…§æºä»£ç é¡ºåºç”ŸæˆæŒ‡ä»¤ ä¿ç•™æ‰€æœ‰ä¸­é—´è®¡ç®—æ­¥éª¤ ä¸åˆå¹¶å†—ä½™æ“ä½œ å‡½æ•°è°ƒç”¨å¤„ç†ï¼š\nä¸¥æ ¼éµå¾ªæ ‡å‡†è°ƒç”¨çº¦å®š ä¿å­˜å’Œæ¢å¤æ‰€æœ‰å¯èƒ½è¢«ä¿®æ”¹çš„å¯„å­˜å™¨ ä¸è¿›è¡Œä»»ä½•å†…è”æˆ–å°¾è°ƒç”¨ä¼˜åŒ– æŠ€æœ¯æ·±åº¦å‰–æ #int calculate(int a, int b) { int temp = a * 2; return temp + b; } åœ¨-O0çº§åˆ«ï¼Œç¼–è¯‘å™¨ç”Ÿæˆçš„ä¼ªæ±‡ç¼–ä»£ç ï¼š\ncalculate: push rbp ; ä¿å­˜åŸºå€æŒ‡é’ˆ mov rbp, rsp ; å»ºç«‹æ–°çš„æ ˆå¸§ mov DWORD PTR [rbp-20], edi ; å­˜å‚¨å‚æ•°a mov DWORD PTR [rbp-24], esi ; å­˜å‚¨å‚æ•°b mov eax, DWORD PTR [rbp-20] ; åŠ è½½a add eax, eax ; a*2 mov DWORD PTR [rbp-4], eax ; å­˜å‚¨temp mov edx, DWORD PTR [rbp-4] ; åŠ è½½tempåˆ°edx mov eax, DWORD PTR [rbp-24] ; åŠ è½½båˆ°eax add eax, edx ; b+temp pop rbp ; æ¢å¤åŸºå€æŒ‡é’ˆ ret ; è¿”å› è¿™ç§å®ç°æ–¹å¼çš„å†…å­˜è®¿é—®æ¨¡å¼æ˜¯ï¼š\nä»å†…å­˜åŠ è½½a è®¡ç®—a*2 å°†ç»“æœå­˜å›å†…å­˜(temp) ä»å†…å­˜é‡æ–°åŠ è½½tempåˆ°edx ä»å†…å­˜åŠ è½½båˆ°eax è®¡ç®—b+temp æ¯ä¸ªå˜é‡çš„æ¯æ¬¡ä½¿ç”¨éƒ½æ¶‰åŠå†…å­˜è®¿é—®ï¼Œè¿™æ˜¯-O0æ•ˆç‡ä½ä¸‹çš„ä¸»è¦åŸå› ã€‚\n3. -O1ï¼šåŸºç¡€ä¼˜åŒ–çš„åº•å±‚åŸç† #æ ¸å¿ƒåŸç† #-O1å¼•å…¥äº†å±€éƒ¨ä¼˜åŒ–ï¼šåœ¨ä¸æ˜¾è‘—å¢åŠ ç¼–è¯‘æ—¶é—´çš„å‰æä¸‹ï¼Œåº”ç”¨åŸºæœ¬çš„æ•°æ®æµåˆ†æå’Œå±€éƒ¨è½¬æ¢ã€‚\nåº•å±‚å®ç°æœºåˆ¶ # æ§åˆ¶æµåˆ†æï¼š\næ„å»ºåŸºæœ¬å—(Basic Block) ç”Ÿæˆæ§åˆ¶æµå›¾(CFG) è¯†åˆ«ç®€å•å¾ªç¯ç»“æ„ æ•°æ®æµåˆ†æï¼š\nåˆ°è¾¾å®šä¹‰åˆ†æ(Reaching Definitions) æ´»è·ƒå˜é‡åˆ†æ(Live Variable Analysis) å¸¸é‡ä¼ æ’­(Constant Propagation) å¯„å­˜å™¨åˆ†é…ï¼š\nåŸºäºå›¾ç€è‰²çš„å¯„å­˜å™¨åˆ†é… å±€éƒ¨å˜é‡çš„ç”Ÿå‘½å‘¨æœŸåˆ†æ æœ€å°åŒ–å¯„å­˜å™¨æº¢å‡º(Register Spilling) æŠ€æœ¯æ·±åº¦å‰–æ #å¯¹äºç›¸åŒçš„å‡½æ•°ï¼Œ-O1çº§åˆ«ç”Ÿæˆçš„ä¼ªæ±‡ç¼–ï¼š\ncalculate: mov eax, edi ; ç›´æ¥åœ¨å¯„å­˜å™¨ä¸­ä½¿ç”¨å‚æ•°a add eax, eax ; a*2ï¼Œç»“æœä¿å­˜åœ¨eax add eax, esi ; (a*2)+bï¼Œç›´æ¥ä½¿ç”¨å‚æ•°b ret ; è¿”å›eaxä¸­çš„ç»“æœ å…·ä½“çš„ä¼˜åŒ–ä¹ŸåŒºåˆ†äºGCCçš„ç‰ˆæœ¬ è¿™é‡Œåº”ç”¨äº†å‡ ä¸ªå…³é”®ä¼˜åŒ–ï¼š\nå¯„å­˜å™¨åˆ†é…ä¼˜åŒ–ï¼š\nå‚æ•°aå’Œbç›´æ¥ä½¿ç”¨å¯„å­˜å™¨(edi, esi) ä¸­é—´ç»“æœtempä¿å­˜åœ¨eaxå¯„å­˜å™¨ï¼Œä¸å†™å›å†…å­˜ å®Œå…¨æ¶ˆé™¤äº†æ ˆå¸§çš„å»ºç«‹å’Œé”€æ¯ æŒ‡ä»¤ç®€åŒ–ï¼š\nä½¿ç”¨add eax, eaxæ›¿ä»£ä¹˜æ³•æŒ‡ä»¤(æ›´é«˜æ•ˆ) åˆå¹¶äº†å¤šä¸ªåŠ è½½/å­˜å‚¨æ“ä½œ æ§åˆ¶æµä¼˜åŒ–ï¼š\nè¯†åˆ«å‡ºå‡½æ•°æ˜¯å•ä¸€åŸºæœ¬å— æ¶ˆé™¤äº†å†—ä½™çš„æ ˆæ“ä½œ åº•å±‚å®ç°ä¸Šï¼Œç¼–è¯‘å™¨æ„å»ºäº†å˜é‡çš„ä½¿ç”¨-å®šä¹‰é“¾(use-def chains)ï¼Œç¡®å®šäº†tempå˜é‡åªåœ¨å‡½æ•°å†…éƒ¨ä½¿ç”¨ä¸€æ¬¡ï¼Œå› æ­¤å¯ä»¥å®Œå…¨ä¿å­˜åœ¨å¯„å­˜å™¨ä¸­è€Œä¸éœ€è¦å†…å­˜æ“ä½œã€‚\n4. -O2ï¼šå…¨é¢ä¼˜åŒ–çš„åº•å±‚åŸç† #æ ¸å¿ƒåŸç† #-O2å®ç°äº†å…¨å±€ä¼˜åŒ–ï¼šè·¨è¶ŠåŸºæœ¬å—è¾¹ç•Œï¼Œåˆ©ç”¨æ›´å¤æ‚çš„ç¨‹åºåˆ†æè¿›è¡Œå…¨å±€è½¬æ¢ã€‚\nåº•å±‚å®ç°æœºåˆ¶ # é™æ€å•èµ‹å€¼å½¢å¼(SSA)ï¼š\nå°†ç¨‹åºè½¬æ¢ä¸ºSSAå½¢å¼ï¼Œæ¯ä¸ªå˜é‡åªè¢«èµ‹å€¼ä¸€æ¬¡ ä½¿ç”¨Ï†(phi)å‡½æ•°åœ¨æ§åˆ¶æµæ±‡åˆç‚¹åˆå¹¶å˜é‡å€¼ ç®€åŒ–æ•°æ®ä¾èµ–åˆ†æ åˆ«ååˆ†æ(Alias Analysis)ï¼š\nç¡®å®šä¸åŒæŒ‡é’ˆæ˜¯å¦å¯èƒ½æŒ‡å‘åŒä¸€å†…å­˜ä½ç½® å¯ç”¨æ›´æ¿€è¿›çš„åŠ è½½/å­˜å‚¨ä¼˜åŒ– æ”¯æŒæŒ‡ä»¤é‡æ’åº å¾ªç¯ä¼˜åŒ–å¥—ä»¶ï¼š\nå¾ªç¯ä¸å˜é‡å¤–æ(Loop-Invariant Code Motion) å¾ªç¯å¼ºåº¦å‰Šå‡(Loop Strength Reduction) å½’çº³å˜é‡ä¼˜åŒ–(Induction Variable Optimization) æŒ‡ä»¤è°ƒåº¦ï¼š\nåŸºäºCPUæµæ°´çº¿ç‰¹æ€§é‡æ’æŒ‡ä»¤ å‡å°‘æ•°æ®ä¾èµ–å¯¼è‡´çš„æµæ°´çº¿åœé¡¿ ä¼˜åŒ–æŒ‡ä»¤çº§å¹¶è¡Œæ€§(ILP) æŠ€æœ¯æ·±åº¦å‰–æ #è€ƒè™‘ä¸€ä¸ªæ›´å¤æ‚çš„ä¾‹å­ï¼š\nint sum_array(int* arr, int size) { int sum = 0; for (int i = 0; i \u0026lt; size; i++) { sum += arr[i]; } return sum; } -O2çº§åˆ«ç”Ÿæˆçš„ä¼ªæ±‡ç¼–ï¼š\nsum_array: test esi, esi ; æ£€æŸ¥sizeæ˜¯å¦ä¸º0 jle .L4 ; å¦‚æœsize \u0026lt;= 0ï¼Œè·³è½¬åˆ°è¿”å› lea ecx, [rsi-1] ; ecx = size-1 xor eax, eax ; sum = 0 xor edx, edx ; i = 0 .L3: add eax, DWORD PTR [rdi+rdx*4] ; sum += arr[i] inc rdx ; i++ cmp rdx, rcx ; æ¯”è¾ƒiå’Œsize-1 jne .L3 ; å¦‚æœä¸ç­‰ï¼Œç»§ç»­å¾ªç¯ add eax, DWORD PTR [rdi+rcx*4] ; å¤„ç†æœ€åä¸€ä¸ªå…ƒç´  ret .L4: xor eax, eax ; å¦‚æœsize \u0026lt;= 0ï¼Œè¿”å›0 ret è¿™é‡Œåº”ç”¨äº†å¤šé¡¹å…¨å±€ä¼˜åŒ–ï¼š\nå¾ªç¯ä¼˜åŒ–ï¼š\nå¾ªç¯æ¡ä»¶é‡å†™(i \u0026lt; size è½¬æ¢ä¸º i != size-1)ï¼Œå‡å°‘æ¯”è¾ƒæ“ä½œ ä½¿ç”¨leaæŒ‡ä»¤é¢„è®¡ç®—size-1ï¼Œé¿å…å¾ªç¯ä¸­é‡å¤è®¡ç®— æŒ‡ä»¤é€‰æ‹©ä¼˜åŒ–ï¼š\nä½¿ç”¨xoræ¸…é›¶å¯„å­˜å™¨(æ¯”movæ›´é«˜æ•ˆ) ä½¿ç”¨incæŒ‡ä»¤é€’å¢è®¡æ•°å™¨(æ¯”addæ›´ç´§å‡‘) åˆ†æ”¯é¢„æµ‹ä¼˜åŒ–ï¼š\næ·»åŠ sizeæ£€æŸ¥ä½œä¸ºå¿«é€Ÿè·¯å¾„ åˆ†ç¦»æœ€åä¸€æ¬¡è¿­ä»£ï¼Œå‡å°‘åˆ†æ”¯é¢„æµ‹å¤±è´¥ å†…å­˜è®¿é—®æ¨¡å¼ä¼˜åŒ–ï¼š\nä½¿ç”¨åŸºå€+ç´¢å¼•å¯»å€æ¨¡å¼ä¼˜åŒ–æ•°ç»„è®¿é—® ä¿æŒæ•°ç»„æŒ‡é’ˆ(rdi)ä¸å˜ï¼Œåªæ›´æ–°ç´¢å¼•(rdx) åº•å±‚å®ç°ä¸Šï¼Œç¼–è¯‘å™¨æ„å»ºäº†å®Œæ•´çš„æ§åˆ¶ä¾èµ–å›¾å’Œæ•°æ®ä¾èµ–å›¾ï¼Œåº”ç”¨äº†å€¼åŸŸåˆ†æ(value range analysis)ç¡®å®šå¾ªç¯è¾¹ç•Œï¼Œå¹¶é€šè¿‡æŒ‡ä»¤è°ƒåº¦ç®—æ³•ä¼˜åŒ–CPUæµæ°´çº¿åˆ©ç”¨ç‡ã€‚\n5. -O3ï¼šæ¿€è¿›ä¼˜åŒ–çš„åº•å±‚åŸç† #æ ¸å¿ƒåŸç† #-O3å®ç°äº†æ¿€è¿›å…¨å±€ä¼˜åŒ–ï¼šä¸æƒœå¢åŠ ä»£ç ä½“ç§¯ï¼Œåº”ç”¨å¯èƒ½æ˜¾è‘—æå‡æ€§èƒ½çš„é«˜çº§è½¬æ¢æŠ€æœ¯ã€‚\nåº•å±‚å®ç°æœºåˆ¶ # å‡½æ•°å†…è”(Function Inlining)ï¼š\nå¤åˆ¶è¢«è°ƒç”¨å‡½æ•°çš„ä»£ç åˆ°è°ƒç”¨ç‚¹ æ¶ˆé™¤å‡½æ•°è°ƒç”¨å¼€é”€ åˆ›é€ æ›´å¤§çš„ä¼˜åŒ–ä¸Šä¸‹æ–‡ å¾ªç¯å±•å¼€(Loop Unrolling)ï¼š\nå¤åˆ¶å¾ªç¯ä½“å¤šæ¬¡ï¼Œå‡å°‘å¾ªç¯æ§åˆ¶å¼€é”€ å¢åŠ æŒ‡ä»¤çº§å¹¶è¡Œæœºä¼š æ”¹å–„æŒ‡ä»¤ç¼“å­˜åˆ©ç”¨ç‡ è‡ªåŠ¨å‘é‡åŒ–(Auto-Vectorization)ï¼š\nè¯†åˆ«å¯å¹¶è¡Œå¤„ç†çš„æ•°æ®æ¨¡å¼ è½¬æ¢ä¸ºSIMD(å•æŒ‡ä»¤å¤šæ•°æ®)æŒ‡ä»¤ ä¸€æ¬¡å¤„ç†å¤šä¸ªæ•°æ®å…ƒç´  æŠ•æœºæ‰§è¡Œä¼˜åŒ–(Speculative Execution)ï¼š\né¢„æ‰§è¡Œå¯èƒ½çš„ä»£ç è·¯å¾„ æ¶ˆé™¤æ¡ä»¶åˆ†æ”¯ åˆ©ç”¨CPUé¢„æµ‹æ‰§è¡Œç‰¹æ€§ æŠ€æœ¯æ·±åº¦å‰–æ #å¯¹äºç›¸åŒçš„sum_arrayå‡½æ•°ï¼Œ-O3çº§åˆ«ç”Ÿæˆçš„ä¼ªæ±‡ç¼–ï¼š\nsum_array: test esi, esi ; æ£€æŸ¥sizeæ˜¯å¦ä¸º0 jle .L9 ; å¦‚æœsize \u0026lt;= 0ï¼Œè·³è½¬åˆ°è¿”å› cmp esi, 7 ; æ£€æŸ¥sizeæ˜¯å¦å¤§äºç­‰äº8 jl .L10 ; å¦‚æœå°äº8ï¼Œä½¿ç”¨æ ‡é‡å¤„ç† ; å‘é‡åŒ–å¤„ç†éƒ¨åˆ† mov edx, esi xor eax, eax ; sum = 0 xor ecx, ecx ; i = 0 and edx, -8 ; è®¡ç®—èƒ½è¢«8æ•´é™¤çš„éƒ¨åˆ† pxor xmm0, xmm0 ; å‘é‡ç´¯åŠ å™¨æ¸…é›¶ .L4: movdqu xmm1, XMMWORD PTR [rdi+rcx*4] ; åŠ è½½8ä¸ªæ•´æ•° paddd xmm0, xmm1 ; å‘é‡åŠ æ³• add rcx, 4 ; i += 4 movdqu xmm1, XMMWORD PTR [rdi+rcx*4-16] ; åŠ è½½ä¸‹ä¸€ç»„4ä¸ªæ•´æ•° paddd xmm0, xmm1 ; å‘é‡åŠ æ³• add rcx, 4 ; i += 4 cmp rcx, rdx ; æ£€æŸ¥æ˜¯å¦å¤„ç†å®Œå‘é‡éƒ¨åˆ† jne .L4 ; æ°´å¹³æ±‚å’Œå‘é‡å…ƒç´  movdqa xmm1, xmm0 psrldq xmm1, 8 paddd xmm0, xmm1 movdqa xmm1, xmm0 psrldq xmm1, 4 paddd xmm0, xmm1 movd eax, xmm0 ; æå–å‘é‡ç´¯åŠ ç»“æœ ; å¤„ç†å‰©ä½™å…ƒç´  cmp rdx, rsi je .L1 .L3: add eax, DWORD PTR [rdi+rdx*4] ; sum += arr[i] add rdx, 1 ; i++ cmp rsi, rdx ; æ£€æŸ¥æ˜¯å¦å¤„ç†å®Œæ‰€æœ‰å…ƒç´  jne .L3 .L1: ret .L9: xor eax, eax ; å¦‚æœsize \u0026lt;= 0ï¼Œè¿”å›0 ret .L10: ; æ ‡é‡å¤„ç†è·¯å¾„ xor eax, eax ; sum = 0 xor edx, edx ; i = 0 jmp .L3 è¿™é‡Œåº”ç”¨äº†å¤šé¡¹æ¿€è¿›ä¼˜åŒ–ï¼š\nè‡ªåŠ¨å‘é‡åŒ–ï¼š\nä½¿ç”¨SSE/AVXæŒ‡ä»¤å¹¶è¡Œå¤„ç†å¤šä¸ªæ•°ç»„å…ƒç´  ä¸€æ¬¡åŠ è½½16å­—èŠ‚(4ä¸ªæ•´æ•°)æˆ–32å­—èŠ‚(8ä¸ªæ•´æ•°) å‘é‡ç´¯åŠ å™¨(xmm0)åŒæ—¶ç´¯åŠ å¤šä¸ªå…ƒç´  å¤šç‰ˆæœ¬ä»£ç ç”Ÿæˆï¼š\nä¸ºä¸åŒè¾“å…¥å¤§å°ç”Ÿæˆä¸“ç”¨ä»£ç è·¯å¾„ å°æ•°ç»„ä½¿ç”¨æ ‡é‡ä»£ç (.L10) å¤§æ•°ç»„ä½¿ç”¨å‘é‡åŒ–ä»£ç (.L4) å¾ªç¯å±•å¼€ï¼š\næ¯æ¬¡å¾ªç¯è¿­ä»£å¤„ç†8ä¸ªå…ƒç´  å‡å°‘å¾ªç¯æ§åˆ¶å¼€é”€ å¢åŠ æŒ‡ä»¤çº§å¹¶è¡Œæ€§ å†…å­˜å¯¹é½ä¼˜åŒ–ï¼š\nä½¿ç”¨andæŒ‡ä»¤è®¡ç®—å‘é‡åŒ–è¾¹ç•Œ å•ç‹¬å¤„ç†ä¸èƒ½å‘é‡åŒ–çš„å°¾éƒ¨å…ƒç´  åº•å±‚å®ç°ä¸Šï¼Œç¼–è¯‘å™¨æ‰§è¡Œäº†å¤æ‚çš„å¾ªç¯ä¾èµ–åˆ†æï¼Œç¡®å®šå¾ªç¯å¯ä»¥å®‰å…¨å‘é‡åŒ–ï¼Œå¹¶ç”Ÿæˆäº†é’ˆå¯¹ä¸åŒè¾“å…¥ç‰¹å¾çš„å¤šä¸ªä»£ç è·¯å¾„ã€‚è¿™ç§ä¼˜åŒ–æ˜¾è‘—æé«˜äº†æ•°æ®å¯†é›†å‹æ“ä½œçš„æ€§èƒ½ï¼Œä½†ä»£ä»·æ˜¯å¢åŠ äº†ä»£ç ä½“ç§¯å’Œå¤æ‚æ€§ã€‚\n6. åº•å±‚ä¼˜åŒ–æŠ€æœ¯çš„å·¥ä½œåŸç† #6.1 å¯„å­˜å™¨åˆ†é…çš„æ¼”è¿› #å¯„å­˜å™¨åˆ†é…æ˜¯æ‰€æœ‰ä¼˜åŒ–çº§åˆ«ä¸­çš„å…³é”®ç¯èŠ‚ï¼Œå…¶å¤æ‚åº¦éšä¼˜åŒ–çº§åˆ«æå‡ï¼š\n-O0ï¼šç®€å•çš„è°ƒç”¨çº¦å®šåˆ†é…\nä½¿ç”¨å›ºå®šå¯„å­˜å™¨ä¼ é€’å‚æ•°(rdi, rsi, rdxç­‰) å‡½æ•°è¿”å›å‰ä¿å­˜å’Œæ¢å¤æ‰€æœ‰è¢«è°ƒç”¨è€…ä¿å­˜å¯„å­˜å™¨ å‡ ä¹æ‰€æœ‰å±€éƒ¨å˜é‡éƒ½å­˜å‚¨åœ¨æ ˆä¸Š -O1ï¼šåŸºäºçº¿æ€§æ‰«æçš„åˆ†é…\nåˆ†æå˜é‡ç”Ÿå‘½å‘¨æœŸ å°½å¯èƒ½å°†çŸ­ç”Ÿå‘½å‘¨æœŸå˜é‡åˆ†é…åˆ°å¯„å­˜å™¨ å¤„ç†ç®€å•çš„å¯„å­˜å™¨å†²çª -O2/-O3ï¼šåŸºäºå›¾ç€è‰²çš„å…¨å±€åˆ†é…\næ„å»ºå˜é‡çš„å¹²æ¶‰å›¾(Interference Graph) åº”ç”¨å›¾ç€è‰²ç®—æ³•æœ€å°åŒ–å¯„å­˜å™¨æ•°é‡ æ™ºèƒ½å¤„ç†å¯„å­˜å™¨æº¢å‡ºï¼Œå°†æœ€ä¸å¸¸ç”¨å˜é‡æº¢å‡ºåˆ°æ ˆ 6.2 å†…å­˜è®¿é—®ä¼˜åŒ–çš„å±‚æ¬¡ #å†…å­˜è®¿é—®ä¼˜åŒ–éšä¼˜åŒ–çº§åˆ«é€æ¸æ·±å…¥ï¼š\n-O0ï¼šæ— ä¼˜åŒ–\næ¯æ¬¡å˜é‡ä½¿ç”¨éƒ½ä»å†…å­˜åŠ è½½ æ¯æ¬¡èµ‹å€¼åç«‹å³å†™å›å†…å­˜ ä¿ç•™æ‰€æœ‰ä¸­é—´å­˜å‚¨æ“ä½œ -O1ï¼šåŸºæœ¬æ¶ˆé™¤\næ¶ˆé™¤å†—ä½™åŠ è½½(Redundant Load Elimination) åˆå¹¶ç›¸é‚»å­˜å‚¨(Store Coalescing) ä¿ç•™è¯­ä¹‰å¯è§çš„å­˜å‚¨æ“ä½œ -O2ï¼šå…¨å±€ä¼˜åŒ–\nå…¨å±€å…¬å…±å­è¡¨è¾¾å¼æ¶ˆé™¤(Global CSE) éƒ¨åˆ†å†—ä½™æ¶ˆé™¤(Partial Redundancy Elimination) åŸºäºåˆ«ååˆ†æçš„åŠ è½½/å­˜å‚¨ä¼˜åŒ– -O3ï¼šé«˜çº§ä¼˜åŒ–\nç¼“å­˜ä¼˜åŒ–å†…å­˜è®¿é—®æ¨¡å¼ é¢„å–æŒ‡ä»¤æ’å…¥(Prefetch Insertion) æ•°æ®å¸ƒå±€è½¬æ¢(Data Layout Transformation) 6.3 æ§åˆ¶æµä¼˜åŒ–çš„è¿›åŒ– #æ§åˆ¶æµä¼˜åŒ–æŠ€æœ¯éšä¼˜åŒ–çº§åˆ«å˜å¾—è¶Šæ¥è¶Šå¤æ‚ï¼š\n-O0ï¼šç›´æ¥ç¿»è¯‘\nç›´æ¥æ˜ å°„æºä»£ç ä¸­çš„æ¡ä»¶å’Œå¾ªç¯ ä¿ç•™æ‰€æœ‰åŸå§‹åˆ†æ”¯ -O1ï¼šåŸºæœ¬å—ä¼˜åŒ–\næ¶ˆé™¤ä¸å¯è¾¾ä»£ç  åˆå¹¶è¿ç»­åŸºæœ¬å— ç®€å•çš„åˆ†æ”¯ä¼˜åŒ– -O2ï¼šå…¨å±€æ§åˆ¶æµä¼˜åŒ–\nå°¾é€’å½’æ¶ˆé™¤(Tail Recursion Elimination) å¾ªç¯ä¸å˜é‡å¤–æ æ¡ä»¶ç§»åŠ¨æŒ‡ä»¤æ›¿ä»£çŸ­åˆ†æ”¯ -O3ï¼šæ¿€è¿›æ§åˆ¶æµè½¬æ¢\nå¾ªç¯å±•å¼€å’Œå¾ªç¯èåˆ åŸºäºæ¦‚ç‡çš„åˆ†æ”¯é¢„æµ‹ä¼˜åŒ– æ¡ä»¶æ‰§è¡Œè½¬æ¢ä¸ºé€‰æ‹©æŒ‡ä»¤ 7. ä¼˜åŒ–çº§åˆ«å¯¹é«˜é¢‘äº¤æ˜“ç³»ç»Ÿçš„åº•å±‚å½±å“ #åœ¨é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­ï¼Œä¸åŒä¼˜åŒ–çº§åˆ«å¯¹å…³é”®æ€§èƒ½æŒ‡æ ‡çš„å½±å“æºè‡ªåº•å±‚æœºåˆ¶ï¼š\n7.1 å»¶è¿Ÿå½±å“æœºåˆ¶ #-O0ï¼š\nå¤§é‡å†…å­˜è®¿é—®å¯¼è‡´ç¼“å­˜æœªå‘½ä¸­ å‡½æ•°è°ƒç”¨å¼€é”€æœªä¼˜åŒ– æŒ‡ä»¤æ•°é‡è†¨èƒ€ï¼Œæ‰§è¡Œè·¯å¾„å»¶é•¿ -O2/-O3ï¼š\nå¯„å­˜å™¨å†…æ•°æ®ä¿æŒï¼Œæœ€å°åŒ–å†…å­˜è®¿é—® å…³é”®è·¯å¾„æŒ‡ä»¤é‡æ’ï¼Œå‡å°‘ä¾èµ–ç­‰å¾… åˆ†æ”¯é¢„æµ‹ä¼˜åŒ–ï¼Œå‡å°‘æµæ°´çº¿åœé¡¿ 7.2 CPUç¼“å­˜æ•ˆç‡ #ä¸åŒä¼˜åŒ–çº§åˆ«å¯¹ç¼“å­˜å±‚æ¬¡ç»“æ„çš„åˆ©ç”¨æœ‰æœ¬è´¨å·®å¼‚ï¼š\n-O0ï¼š\né¢‘ç¹çš„æ ˆè®¿é—®æ±¡æŸ“æ•°æ®ç¼“å­˜ ä»£ç çº¿æ€§æ’åˆ—ï¼ŒæŒ‡ä»¤ç¼“å­˜æ•ˆç‡ä½ æ— ç¼“å­˜å±€éƒ¨æ€§ä¼˜åŒ– -O2ï¼š\nä»£ç å¸ƒå±€ä¼˜åŒ–ï¼Œæé«˜æŒ‡ä»¤ç¼“å­˜å‘½ä¸­ç‡ æ•°æ®è®¿é—®æ¨¡å¼ä¼˜åŒ–ï¼Œå‡å°‘ç¼“å­˜æœªå‘½ä¸­ å¾ªç¯å˜æ¢æ”¹å–„ç©ºé—´å’Œæ—¶é—´å±€éƒ¨æ€§ -O3ï¼š\nå¾ªç¯åˆ†å—(Loop Tiling)ä¼˜åŒ–ç¼“å­˜ä½¿ç”¨ é¢„å–æŒ‡ä»¤å‡å°‘ç¼“å­˜æœªå‘½ä¸­æƒ©ç½š æ•°æ®å¯¹é½å’Œå¡«å……ä¼˜åŒ–ç¼“å­˜è¡Œåˆ©ç”¨ 7.3 åŸå­æ“ä½œå’Œå†…å­˜åºä¼˜åŒ– #é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­çš„åŸå­æ“ä½œåœ¨ä¸åŒä¼˜åŒ–çº§åˆ«ä¸‹æœ‰æ˜¾è‘—å·®å¼‚ï¼š\n-O0ï¼š\næ¯æ¬¡åŸå­æ“ä½œéƒ½æ‰§è¡Œå®Œæ•´å†…å­˜å±éšœ ä¸ä¼˜åŒ–å†—ä½™åŸå­æ“ä½œ ä¸¥æ ¼æŒ‰ç…§æºç é¡ºåºæ‰§è¡Œ -O2/-O3ï¼š\nè¯†åˆ«å¹¶å°Šé‡æŒ‡å®šçš„å†…å­˜åºè¯­ä¹‰ åˆå¹¶æˆ–æ¶ˆé™¤å†—ä½™å†…å­˜å±éšœ åœ¨ä¸è¿åè¯­ä¹‰çš„å‰æä¸‹é‡æ’æŒ‡ä»¤ ä¾‹å¦‚ï¼Œå¯¹äºrunning.load(std::memory_order_relaxed)ï¼š\n-O0ä¼šç”Ÿæˆï¼š\nmov rax, QWORD PTR [running] ; åŠ è½½åŸå­å˜é‡åœ°å€ mov eax, DWORD PTR [rax] ; æ‰§è¡ŒåŠ è½½æ“ä½œ -O3ä¼šä¼˜åŒ–ä¸ºï¼š\nmov eax, DWORD PTR [running] ; ç›´æ¥åŠ è½½ï¼Œæ— é¢å¤–å±éšœ ; å¯èƒ½å°†å€¼ç¼“å­˜åœ¨å¯„å­˜å™¨ä¸­ä¸€æ®µæ—¶é—´ å¹¶ä¸”åœ¨å¾ªç¯ä¸­ï¼š\nwhile (running.load(std::memory_order_relaxed)) { // å¾ªç¯ä½“ } -O3å¯èƒ½è¿›ä¸€æ­¥ä¼˜åŒ–ä¸ºï¼š\nmov eax, DWORD PTR [running] ; å¾ªç¯å¤–åŠ è½½ä¸€æ¬¡ test eax, eax je .exit_loop .loop_start: ; å¾ªç¯ä½“æŒ‡ä»¤ ; å®šæœŸé‡æ–°æ£€æŸ¥runningå€¼ mov eax, DWORD PTR [running] test eax, eax jne .loop_start .exit_loop: è¿™ç§ä¼˜åŒ–å‡å°‘äº†åŸå­æ“ä½œé¢‘ç‡ï¼Œæ˜¾è‘—æé«˜äº†å¾ªç¯æ€§èƒ½ã€‚\n8. ç»“è®ºï¼šä¼˜åŒ–çº§åˆ«çš„æœ¬è´¨ #ç¼–è¯‘å™¨ä¼˜åŒ–çº§åˆ«çš„æœ¬è´¨æ˜¯åœ¨ç¼–è¯‘æ—¶é—´ã€ä»£ç å¤§å°å’Œè¿è¡Œæ—¶æ€§èƒ½ä¹‹é—´å¯»æ‰¾å¹³è¡¡ç‚¹ï¼š\n-O0ï¼š\næœ¬è´¨ï¼šä¿æŒæºä»£ç ä¸æœºå™¨ç çš„ç›´æ¥æ˜ å°„å…³ç³» åº•å±‚åŸç†ï¼šæœ€å°åŒ–ç¼–è¯‘å™¨å¹²é¢„ï¼Œä¿ç•™æ‰€æœ‰æ“ä½œ é€‚ç”¨åœºæ™¯ï¼šè°ƒè¯•ç¯å¢ƒï¼Œéœ€è¦ç²¾ç¡®çš„æºç å¯¹åº”å…³ç³» -O1ï¼š\næœ¬è´¨ï¼šåº”ç”¨ä¸å¢åŠ ç¼–è¯‘æ—¶é—´çš„å±€éƒ¨ä¼˜åŒ– åº•å±‚åŸç†ï¼šåŸºæœ¬å—å†…æ•°æ®æµåˆ†æå’Œç®€å•è½¬æ¢ é€‚ç”¨åœºæ™¯ï¼šå¼€å‘è¿‡ç¨‹ä¸­éœ€è¦åˆç†ç¼–è¯‘é€Ÿåº¦å’ŒåŸºæœ¬ä¼˜åŒ– -O2ï¼š\næœ¬è´¨ï¼šå…¨é¢ä½†ä¿å®ˆçš„å…¨å±€ä¼˜åŒ– åº•å±‚åŸç†ï¼šè·¨åŸºæœ¬å—çš„æ•°æ®æµå’Œæ§åˆ¶æµåˆ†æ é€‚ç”¨åœºæ™¯ï¼šç”Ÿäº§ç¯å¢ƒçš„å¹³è¡¡é€‰æ‹© -O3ï¼š\næœ¬è´¨ï¼šä¸æƒœä»£ä»·è¿½æ±‚è¿è¡Œæ—¶æ€§èƒ½ åº•å±‚åŸç†ï¼šæ¿€è¿›çš„å…¨å±€åˆ†æå’Œè½¬æ¢ï¼ŒåŒ…æ‹¬å¯èƒ½å¢åŠ ä»£ç ä½“ç§¯çš„ä¼˜åŒ– é€‚ç”¨åœºæ™¯ï¼šæ€§èƒ½å…³é”®å‹åº”ç”¨ï¼Œç‰¹åˆ«æ˜¯è®¡ç®—å¯†é›†å‹å·¥ä½œè´Ÿè½½ å¯¹äºé«˜é¢‘äº¤æ˜“ç³»ç»Ÿï¼Œç†è§£è¿™äº›åº•å±‚æœºåˆ¶è‡³å…³é‡è¦ï¼Œå› ä¸ºå¾®ç§’çº§çš„å»¶è¿Ÿå·®å¼‚å¯èƒ½ç›´æ¥å½±å“äº¤æ˜“å†³ç­–å’Œç³»ç»Ÿç«äº‰åŠ›ã€‚åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œä½¿ç”¨-O0è¿›è¡Œç”Ÿäº§æ„å»ºå‡ ä¹æ€»æ˜¯é”™è¯¯çš„é€‰æ‹©ï¼Œè€Œ-O2æˆ–-O3(é’ˆå¯¹æ€§èƒ½å…³é”®è·¯å¾„)é€šå¸¸æ˜¯æœ€ä½³å®è·µã€‚\nå‚è€ƒæ–‡ç«  # https://fuzhe1989.github.io/2020/01/22/optimizations-in-cpp-compilers/ https://xania.org/202506/how-compiler-explorer-works ","date":"19 June 2025","permalink":"/blog/2025-06-19-compile_perf/","section":"Blog","summary":"1. ä¼˜åŒ–çº§åˆ«çš„æœ¬è´¨ä¸ç¼–è¯‘è¿‡ç¨‹ #ç¼–è¯‘å™¨ä¼˜åŒ–æ˜¯å°†æºä»£ç è½¬æ¢ä¸ºæ›´é«˜æ•ˆæœºå™¨ç çš„ç³»ç»Ÿæ€§è¿‡ç¨‹ï¼Œæ¯ä¸ªä¼˜åŒ–çº§åˆ«ä»£è¡¨äº†ä¸åŒçš„è½¬æ¢ç­–ç•¥é›†åˆã€‚è¦ç†è§£è¿™äº›çº§åˆ«ï¼Œé¦–å…ˆéœ€è¦äº†è§£ç¼–è¯‘å™¨çš„å·¥ä½œæµç¨‹ï¼š\nè¯æ³•åˆ†æ â†’ 2. è¯­æ³•åˆ†æ â†’ 3. è¯­ä¹‰åˆ†æ â†’ 4. ä¸­é—´è¡¨ç¤ºç”Ÿæˆ â†’ 5. ä¼˜åŒ– â†’ 6. ä»£ç ç”Ÿæˆ ä¼˜åŒ–çº§åˆ«ä¸»è¦å½±å“ç¬¬5æ­¥ï¼Œå†³å®šåº”ç”¨å“ªäº›è½¬æ¢ç®—æ³•åŠå…¶æ¿€è¿›ç¨‹åº¦ã€‚\n2. -O0ï¼šé›¶ä¼˜åŒ–çš„åº•å±‚æœºåˆ¶ #æ ¸å¿ƒåŸç† #-O0çš„æœ¬è´¨æ˜¯ç›´æ¥æ˜ å°„ï¼šä¿æŒæºä»£ç ä¸ç”Ÿæˆçš„æœºå™¨ç ä¹‹é—´çš„ä¸€ä¸€å¯¹åº”å…³ç³»ï¼Œå‡ ä¹ä¸è¿›è¡Œä»»ä½•è½¬æ¢ã€‚\nåº•å±‚å®ç°æœºåˆ¶ # å˜é‡åˆ†é…ç­–ç•¥ï¼š\næ¯ä¸ªå˜é‡éƒ½åˆ†é…ç‹¬ç«‹çš„æ ˆç©ºé—´ å³ä½¿æ˜¯ä¸´æ—¶å˜é‡ä¹Ÿä¼šå†™å›å†…å­˜ ä¸è¿›è¡Œå¯„å­˜å™¨é‡ç”¨ä¼˜åŒ– æŒ‡ä»¤ç”Ÿæˆé€»è¾‘ï¼š\nä¸¥æ ¼æŒ‰ç…§æºä»£ç é¡ºåºç”ŸæˆæŒ‡ä»¤ ä¿ç•™æ‰€æœ‰ä¸­é—´è®¡ç®—æ­¥éª¤ ä¸åˆå¹¶å†—ä½™æ“ä½œ å‡½æ•°è°ƒç”¨å¤„ç†ï¼š\nä¸¥æ ¼éµå¾ªæ ‡å‡†è°ƒç”¨çº¦å®š ä¿å­˜å’Œæ¢å¤æ‰€æœ‰å¯èƒ½è¢«ä¿®æ”¹çš„å¯„å­˜å™¨ ä¸è¿›è¡Œä»»ä½•å†…è”æˆ–å°¾è°ƒç”¨ä¼˜åŒ– æŠ€æœ¯æ·±åº¦å‰–æ #int calculate(int a, int b) { int temp = a * 2; return temp + b; } åœ¨-O0çº§åˆ«ï¼Œç¼–è¯‘å™¨ç”Ÿæˆçš„ä¼ªæ±‡ç¼–ä»£ç ï¼š\ncalculate: push rbp ; ä¿å­˜åŸºå€æŒ‡é’ˆ mov rbp, rsp ; å»ºç«‹æ–°çš„æ ˆå¸§ mov DWORD PTR [rbp-20], edi ; å­˜å‚¨å‚æ•°a mov DWORD PTR [rbp-24], esi ; å­˜å‚¨å‚æ•°b mov eax, DWORD PTR [rbp-20] ; åŠ è½½a add eax, eax ; a*2 mov DWORD PTR [rbp-4], eax ; å­˜å‚¨temp mov edx, DWORD PTR [rbp-4] ; åŠ è½½tempåˆ°edx mov eax, DWORD PTR [rbp-24] ; åŠ è½½båˆ°eax add eax, edx ; b+temp pop rbp ; æ¢å¤åŸºå€æŒ‡é’ˆ ret ; è¿”å› è¿™ç§å®ç°æ–¹å¼çš„å†…å­˜è®¿é—®æ¨¡å¼æ˜¯ï¼š","title":"ç¼–è¯‘å™¨ä¼˜åŒ–çº§åˆ«æŠ€æœ¯è§£æ"},{"content":"ç›®å½• # é«˜é¢‘äº¤æ˜“ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–æ€è·¯ Perf åŸºç¡€çŸ¥è¯† perf record å‘½ä»¤å‚æ•°è¯¦è§£ é‡‡æ ·äº‹ä»¶ç±»å‹ Perf èƒ½åˆ†æçš„å…³é”®æŒ‡æ ‡ Perf Report è¾“å‡ºè§£æ åˆ—å«ä¹‰è¯¦è§£ åˆ†ææ–¹æ³•è®º é«˜çº§åˆ†ææŠ€å·§ å®é™…ä¼˜åŒ–æµç¨‹ å…³é”®æŒ‡æ ‡è§£è¯» ä½¿ç”¨Perfåˆ†æå†…å­˜æ€§èƒ½æŒ‡æ ‡ é«˜é¢‘äº¤æ˜“ç³»ç»Ÿæ¡ˆä¾‹åˆ†æ é«˜é¢‘äº¤æ˜“ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–æ€è·¯ #åœ¨é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­ï¼Œå¾®ç§’çº§çš„å»¶è¿Ÿå·®å¼‚å¯èƒ½ç›´æ¥å½±å“äº¤æ˜“ç­–ç•¥çš„æœ‰æ•ˆæ€§å’Œç›ˆåˆ©èƒ½åŠ›ã€‚ä½¿ç”¨perfè¿›è¡Œæ€§èƒ½åˆ†ææ˜¯ä¼˜åŒ–é«˜é¢‘äº¤æ˜“ç³»ç»Ÿçš„å…³é”®æ­¥éª¤ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç³»ç»ŸåŒ–çš„ä¼˜åŒ–æ€è·¯ï¼š\n1. æ€§èƒ½åŸºå‡†å»ºç«‹ #å…³é”®æŒ‡æ ‡:\nç«¯åˆ°ç«¯å»¶è¿Ÿ: ä»è¡Œæƒ…æ¥æ”¶åˆ°ä¸‹å•çš„å®Œæ•´è·¯å¾„æ—¶é—´ ååé‡: æ¯ç§’å¤„ç†çš„è®¢å•/è¡Œæƒ…æ•°é‡ å°¾å»¶è¿Ÿ: 95/99/99.9ç™¾åˆ†ä½å»¶è¿Ÿ CPUåˆ©ç”¨ç‡: æ ¸å¿ƒäº¤æ˜“è·¯å¾„çš„CPUä½¿ç”¨æƒ…å†µ # å»ºç«‹åŸºå‡†æ€§èƒ½æ•°æ® perf stat -e cycles,instructions,cache-references,cache-misses,branches,branch-misses -o perf_base.data -a -g ./strategyTrade å‘½ä»¤å‚æ•°è§£é‡Š:\ncycles: CPUå‘¨æœŸæ•°ï¼Œç”¨äºæµ‹é‡ç¨‹åºæ‰§è¡Œæ‰€éœ€çš„å¤„ç†å™¨å‘¨æœŸæ€»é‡ instructions: æ‰§è¡Œçš„æŒ‡ä»¤æ•°ï¼Œç»“åˆcycleså¯è®¡ç®—IPC(æ¯å‘¨æœŸæŒ‡ä»¤æ•°)ï¼Œè¯„ä¼°CPUåˆ©ç”¨æ•ˆç‡ cache-references: ç¼“å­˜è®¿é—®æ¬¡æ•°ï¼Œè¡¨ç¤ºç¨‹åºå¯¹CPUç¼“å­˜çš„æ€»è®¿é—®é‡ cache-misses: ç¼“å­˜æœªå‘½ä¸­æ¬¡æ•°ï¼Œé«˜ç¼“å­˜æœªå‘½ä¸­ç‡ä¼šå¯¼è‡´å¤„ç†å™¨ç­‰å¾…å†…å­˜ï¼Œå¢åŠ å»¶è¿Ÿ branches: åˆ†æ”¯æŒ‡ä»¤æ‰§è¡Œæ¬¡æ•°ï¼Œåæ˜ ç¨‹åºä¸­æ¡ä»¶åˆ¤æ–­å’Œè·³è½¬çš„é¢‘ç‡ branch-misses: åˆ†æ”¯é¢„æµ‹å¤±è´¥æ¬¡æ•°ï¼Œé«˜å¤±è´¥ç‡ä¼šå¯¼è‡´æµæ°´çº¿åˆ·æ–°ï¼Œé™ä½CPUæ•ˆç‡ -o: æŒ‡å®šè¾“å‡ºæ–‡ä»¶å -a: æ”¶é›†æ‰€æœ‰CPUæ ¸å¿ƒçš„æ•°æ®ï¼Œå…¨ç³»ç»Ÿè§†å›¾ -g: æ”¶é›†è°ƒç”¨å›¾ä¿¡æ¯ï¼Œä¾¿äºåˆ†æå‡½æ•°è°ƒç”¨å…³ç³» è¾“å‡ºç¤ºä¾‹åŠè§£è¯»:\nPerformance counter stats for \u0026#39;./strategyTrade\u0026#39;: 12,345,678,901 cycles # æ€»CPUå‘¨æœŸæ•° 24,680,046,512 instructions # æ€»æŒ‡ä»¤æ•°ï¼ŒæŒ‡ä»¤/å‘¨æœŸæ¯”çº¦ä¸º2.0ï¼Œè¡¨ç¤ºè‰¯å¥½çš„æµæ°´çº¿æ•ˆç‡ 234,567,890 cache-references # ç¼“å­˜è®¿é—®æ€»æ¬¡æ•° 23,456,789 cache-misses # çº¦10%çš„ç¼“å­˜æœªå‘½ä¸­ç‡ï¼Œç†æƒ³å€¼åº”\u0026lt;5% 1,234,567,890 branches # åˆ†æ”¯æŒ‡ä»¤æ•° 98,765,432 branch-misses # çº¦8%çš„åˆ†æ”¯é¢„æµ‹å¤±è´¥ç‡ï¼Œç†æƒ³å€¼åº”\u0026lt;5% 10.002345678 seconds time elapsed # ç¨‹åºæ€»è¿è¡Œæ—¶é—´ è¿™äº›åŸºå‡†æ•°æ®ä¸ºåç»­ä¼˜åŒ–æä¾›äº†é‡åŒ–å‚è€ƒç‚¹ï¼Œä»»ä½•ä¼˜åŒ–æªæ–½éƒ½åº”è¯¥é€šè¿‡å†æ¬¡æµ‹é‡è¿™äº›æŒ‡æ ‡æ¥éªŒè¯å…¶æœ‰æ•ˆæ€§ã€‚\n2. çƒ­ç‚¹è·¯å¾„è¯†åˆ« #é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­æœ€å…³é”®çš„è·¯å¾„é€šå¸¸æ˜¯ï¼š\nè¡Œæƒ…æ•°æ®è§£æ ç­–ç•¥è®¡ç®— è®¢å•ç”Ÿæˆä¸å‘é€ # è¯†åˆ«å…³é”®è·¯å¾„çƒ­ç‚¹ perf record -F 9999 -a -g ./strategyTrade perf report --sort=dso,symbol 3. ç³»ç»Ÿè°ƒç”¨ä¸ä¸Šä¸‹æ–‡åˆ‡æ¢åˆ†æ #é«˜é¢‘äº¤æ˜“ç³»ç»Ÿåº”å°½é‡å‡å°‘ç³»ç»Ÿè°ƒç”¨å’Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿™äº›æ˜¯ä½å»¶è¿Ÿçš„å¤©æ•Œã€‚\n# åˆ†æç³»ç»Ÿè°ƒç”¨ perf record -e syscalls:sys_enter_* -a -g sleep 30 perf report # åˆ†æä¸Šä¸‹æ–‡åˆ‡æ¢ perf record -e context-switches -a -g sleep 30 perf report 4. å†…å­˜è®¿é—®æ¨¡å¼ä¼˜åŒ– #ç¼“å­˜æœªå‘½ä¸­æ˜¯é«˜é¢‘äº¤æ˜“ç³»ç»Ÿæ€§èƒ½ä¸‹é™çš„ä¸»è¦åŸå› ä¹‹ä¸€ã€‚\n# åˆ†æç¼“å­˜æ€§èƒ½ perf record -e cache-misses,cache-references -a -g sleep 30 perf report # è¯¦ç»†åˆ†æå†…å­˜è®¿é—® perf mem record -a ./strategyTrade perf mem report 5. é”ç«äº‰ä¸çº¿ç¨‹åä½œ #å¤šçº¿ç¨‹é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­ï¼Œçº¿ç¨‹é—´çš„é”ç«äº‰å¯èƒ½å¯¼è‡´ä¸¥é‡çš„æ€§èƒ½é—®é¢˜ã€‚\n# åˆ†æé”ç«äº‰ perf record -e lock:lock_acquire -a -g sleep 30 perf report 6. ç½‘ç»œI/Oæ€§èƒ½ #é«˜é¢‘äº¤æ˜“ç³»ç»Ÿé€šå¸¸éœ€è¦é«˜æ•ˆçš„ç½‘ç»œI/Oå¤„ç†ã€‚\n# åˆ†æç½‘ç»œç›¸å…³ç³»ç»Ÿè°ƒç”¨ perf record -e syscalls:sys_enter_recvfrom,syscalls:sys_enter_sendto -a -g sleep 30 perf report 7. ä¼˜åŒ–éªŒè¯ä¸è¿­ä»£ #æ¯æ¬¡ä¼˜åŒ–åï¼Œéœ€è¦é‡æ–°æµ‹é‡å…³é”®æŒ‡æ ‡ï¼Œç¡®ä¿ä¼˜åŒ–æœ‰æ•ˆã€‚\n# ä¼˜åŒ–å‰åå¯¹æ¯” perf diff perf.data.before perf.data.after Perf åŸºç¡€çŸ¥è¯† #1. perf record å‘½ä»¤å‚æ•°è¯¦è§£ #perf record -a -g sleep 30 é»˜è®¤é‡‡é›†äº‹ä»¶æ˜¯cpu-clock,å¯ä»¥ä½¿ç”¨-e $enevttypeï¼ŒæŒ‡å®šé‡‡é›†çš„äº‹ä»¶ ä½¿ç”¨perf reportåï¼Œ åœ¨perf reportçš„é»˜è®¤äº¤äº’ç•Œé¢ä¸­ï¼š æ¯è¡Œå‰é¢çš„+å·è¡¨ç¤ºè¯¥æ¡ç›®å¯ä»¥å±•å¼€ æŒ‰ä¸‹Enteré”®å¯ä»¥å±•å¼€å½“å‰é€‰ä¸­çš„æ¡ç›®ï¼Œæ˜¾ç¤ºå…¶è°ƒç”¨å…³ç³» ä½¿ç”¨æ–¹å‘é”®å¯ä»¥åœ¨ä¸åŒæ¡ç›®é—´å¯¼èˆª æŒ‰ä¸‹eé”®å¯ä»¥å±•å¼€æ‰€æœ‰è°ƒç”¨æ ˆ\nå‚æ•°è§£é‡Š:\n-a: ç³»ç»ŸèŒƒå›´å†…æ”¶é›†æ•°æ®ï¼ˆall CPUsï¼‰ï¼Œç›‘æ§æ‰€æœ‰CPUæ ¸å¿ƒ -g: å¯ç”¨è°ƒç”¨å›¾è®°å½•ï¼Œè®°å½•å‡½æ•°è°ƒç”¨æ ˆä¿¡æ¯ -F \u0026lt;freq\u0026gt;: è®¾ç½®é‡‡æ ·é¢‘ç‡ï¼Œå¦‚-F 99è¡¨ç¤ºæ¯ç§’99æ¬¡ -p \u0026lt;pid\u0026gt;: æŒ‡å®šè¿›ç¨‹IDè¿›è¡Œåˆ†æ -e \u0026lt;event\u0026gt;: æŒ‡å®šè¦é‡‡æ ·çš„äº‹ä»¶ç±»å‹ sleep 30: é‡‡æ ·æŒç»­30ç§’ å¸¸ç”¨ç»„åˆ:\n# åˆ†æç‰¹å®šè¿›ç¨‹ perf record -g -p 1234 sleep 30 # é«˜é¢‘é‡‡æ · perf record -F 999 -ag sleep 10 # åˆ†æç‰¹å®šç¨‹åº perf record -g ./your_program 2. é‡‡æ ·äº‹ä»¶ç±»å‹ #perfå¯ä»¥é‡‡æ ·å¤šç§äº‹ä»¶ç±»å‹ï¼Œcpu-clock:pppHæ˜¯å…¶ä¸­ä¸€ç§ã€‚\nå¸¸è§äº‹ä»¶ç±»å‹:\ncpu-clock: CPUæ—¶é’Ÿå‘¨æœŸï¼Œæœ€å¸¸ç”¨çš„æ€§èƒ½è®¡æ•°å™¨ cycles: CPUå‘¨æœŸæ•° instructions: æŒ‡ä»¤æ‰§è¡Œæ•° cache-misses: ç¼“å­˜æœªå‘½ä¸­æ¬¡æ•° branch-misses: åˆ†æ”¯é¢„æµ‹å¤±è´¥æ¬¡æ•° page-faults: é¡µé¢é”™è¯¯æ¬¡æ•° context-switches: ä¸Šä¸‹æ–‡åˆ‡æ¢æ¬¡æ•° cpu-migrations: CPUè¿ç§»æ¬¡æ•° L1-dcache-load-misses: L1æ•°æ®ç¼“å­˜åŠ è½½æœªå‘½ä¸­ LLC-load-misses: æœ€åçº§ç¼“å­˜åŠ è½½æœªå‘½ä¸­ æŸ¥çœ‹å¯ç”¨äº‹ä»¶:\n# åˆ—å‡ºæ‰€æœ‰å¯ç”¨äº‹ä»¶ perf list # æŒ‰ç±»åˆ«æŸ¥çœ‹ perf list \u0026#39;cache\u0026#39; # åªçœ‹ç¼“å­˜ç›¸å…³äº‹ä»¶ 3. Perf èƒ½åˆ†æçš„å…³é”®æŒ‡æ ‡ #CPUæ€§èƒ½æŒ‡æ ‡:\nCPUä½¿ç”¨ç‡: å„è¿›ç¨‹/çº¿ç¨‹çš„CPUæ—¶é—´åˆ†å¸ƒ çƒ­ç‚¹å‡½æ•°: æ¶ˆè€—CPUæ—¶é—´æœ€å¤šçš„å‡½æ•° è°ƒç”¨æ ˆåˆ†æ: å‡½æ•°è°ƒç”¨é“¾åŠå…¶å¼€é”€ æŒ‡ä»¤æ‰§è¡Œæ•ˆç‡: IPC (Instructions Per Cycle) å†…å­˜æ€§èƒ½æŒ‡æ ‡:\nç¼“å­˜å‘½ä¸­ç‡: L1/L2/LLCç¼“å­˜å‘½ä¸­æƒ…å†µ å†…å­˜è®¿é—®æ¨¡å¼: å†…å­˜è¯»å†™æ“ä½œåˆ†å¸ƒ NUMAè®¿é—®: è·¨NUMAèŠ‚ç‚¹å†…å­˜è®¿é—® é¡µé¢é”™è¯¯: ä¸»/æ¬¡é¡µé¢é”™è¯¯é¢‘ç‡ I/Oæ€§èƒ½æŒ‡æ ‡:\nå—I/Oæ“ä½œ: ç£ç›˜è¯»å†™æ“ä½œåˆ†å¸ƒ ç½‘ç»œI/O: ç½‘ç»œæ•°æ®åŒ…å¤„ç†å¼€é”€ ç³»ç»Ÿè°ƒç”¨: I/Oç›¸å…³ç³»ç»Ÿè°ƒç”¨é¢‘ç‡ çº¿ç¨‹ä¸è°ƒåº¦æŒ‡æ ‡:\nä¸Šä¸‹æ–‡åˆ‡æ¢: è¿›ç¨‹/çº¿ç¨‹åˆ‡æ¢é¢‘ç‡ è°ƒåº¦å»¶è¿Ÿ: çº¿ç¨‹ç­‰å¾…è°ƒåº¦çš„æ—¶é—´ CPUè¿ç§»: çº¿ç¨‹åœ¨CPUæ ¸å¿ƒé—´çš„è¿ç§» é”ç«äº‰: äº’æ–¥é”/è‡ªæ—‹é”ç­‰å¾…æ—¶é—´ ç‰¹å®šç¡¬ä»¶æŒ‡æ ‡:\nåˆ†æ”¯é¢„æµ‹: åˆ†æ”¯é¢„æµ‹æˆåŠŸ/å¤±è´¥ç‡ å‰ç«¯ç»‘å®š: æŒ‡ä»¤è·å–å’Œè§£ç ç“¶é¢ˆ åç«¯ç»‘å®š: æ‰§è¡Œå•å…ƒç“¶é¢ˆ SIMDæ•ˆç‡: å‘é‡æŒ‡ä»¤ä½¿ç”¨æ•ˆç‡ root@debian:~# perf record -a -g sleep 30 root@debian:~# perf report Samples: 240K of event \u0026#39;cpu-clock:pppH\u0026#39;, Event count (approx.): 60002500000 Children Self Command Shared Object Symbol + 49.63% 0.08% strategyTrade strategyTrade [.] std::this_thread::yield + 49.38% 6.63% strategyTrade libc.so.6 [.] __sched_yield + 42.77% 0.00% strategyTrade [kernel.kallsyms] [k] entry_SYSCALL_64_after_hwframe + 42.77% 0.09% strategyTrade [kernel.kallsyms] [k] do_syscall_64 + 39.40% 0.00% quote_source libstdc++.so.6.0.30 [.] 0x00007fadf3cd44a3 + 39.39% 0.00% quote_source quote_source [.] std:ğŸ§µ:_State_impl\u0026lt;std:ğŸ§µ:_Invoker\u0026lt;std::tuple\u0026lt;void ( + 39.39% 0.00% quote_source quote_source [.] std:ğŸ§µ:_Invoker\u0026lt;std::tuple\u0026lt;void (QuoteMessageProcessor::*) + 39.39% 0.00% quote_source quote_source [.] std:ğŸ§µ:_Invoker\u0026lt;std::tuple\u0026lt;void (QuoteMessageProcessor::*) + 39.39% 0.00% quote_source quote_source [.] std::__invoke\u0026lt;void (QuoteMessageProcessor::*)(), QuoteMessagePro + 39.39% 0.00% quote_source quote_source [.] std::__invoke_impl\u0026lt;void, void (QuoteMessageProcessor::*)(), Quot + 38.37% 0.00% strategyTrade [unknown] [.] 0x001405303d8d4866 + 38.37% 0.00% strategyTrade libc.so.6 [.] __pthread_once_slow + 38.37% 0.00% strategyTrade strategyTrade [.] std::once_flag::_Prepare_execution::_Prepare_execution\u0026lt;std::call + 38.37% 0.00% strategyTrade strategyTrade [.] std::once_flag::_Prepare_execution::_Prepare_execution\u0026lt;std::call + 38.37% 0.00% strategyTrade strategyTrade [.] std::call_once\u0026lt;void (std::__future_base::_State_baseV2::*)(std:: + 38.37% 0.00% strategyTrade strategyTrade [.] std::__invoke\u0026lt;void (std::__future_base::_State_baseV2::*)(std::f + 38.37% 0.00% strategyTrade strategyTrade [.] std::__invoke_impl\u0026lt;void, void (std::__future_base::_State_baseV2 + 38.37% 0.00% strategyTrade strategyTrade [.] std::__future_base::_State_baseV2::_M_do_set + 38.37% 0.00% strategyTrade strategyTrade [.] std::function\u0026lt;std::unique_ptr\u0026lt;std::__future_base::_Result_base, + 38.37% 0.00% strategyTrade strategyTrade [.] std::_Function_handler\u0026lt;std::unique_ptr\u0026lt;std::__future_base::_Resu + 38.37% 0.00% strategyTrade strategyTrade [.] std::__invoke_r\u0026lt;std::unique_ptr\u0026lt;std::__future_base::_Result_base + 38.37% 0.00% strategyTrade strategyTrade [.] std::__invoke_impl\u0026lt;std::unique_ptr\u0026lt;std::__future_base::_Result\u0026lt;v + 38.37% 0.00% strategyTrade strategyTrade [.] std::__future_base::_Task_setter\u0026lt;std::unique_ptr\u0026lt;std::__future_b + 38.37% 0.00% strategyTrade strategyTrade [.] std::__future_base::_Task_state\u0026lt;std::_Bind\u0026lt;StraTrade::MessageHan + 38.37% 0.00% strategyTrade strategyTrade [.] std::__invoke_r\u0026lt;void, std::_Bind\u0026lt;StraTrade::MessageHandler::star + 38.37% 0.00% strategyTrade strategyTrade [.] std::__invoke_impl\u0026lt;void, std::_Bind\u0026lt;StraTrade::MessageHandler::s + 38.37% 0.00% strategyTrade strategyTrade [.] std::_Bind\u0026lt;StraTrade::MessageHandler::start()::{lambda()#1} ()\u0026gt;: + 38.37% 0.00% strategyTrade strategyTrade [.] std::_Bind\u0026lt;StraTrade::MessageHandler::start()::{lambda()#1} ()\u0026gt;: Perf Report è¾“å‡ºè§£æ #ä»¥ä¸‹æ˜¯ä¸€ä¸ªå…¸å‹çš„perf reportè¾“å‡ºç¤ºä¾‹ï¼š\nroot@debian:~# perf report Samples: 240K of event \u0026#39;cpu-clock:pppH\u0026#39;, Event count (approx.): 60002500000 Children Self Command Shared Object Symbol + 49.63% 0.08% strategyTrade strategyTrade [.] std::this_thread::yield + 49.38% 6.63% strategyTrade libc.so.6 [.] __sched_yield + 42.77% 0.00% strategyTrade [kernel.kallsyms] [k] entry_SYSCALL_64_after_hwframe + 42.77% 0.09% strategyTrade [kernel.kallsyms] [k] do_syscall_64 + 39.40% 0.00% quote_source libstdc++.so.6.0.30 [.] 0x00007fadf3cd44a3 + 39.39% 0.00% quote_source quote_source [.] std:ğŸ§µ:_State_impl\u0026lt;std:ğŸ§µ:_Invoker\u0026lt;std::tuple\u0026lt;void ( // ... æ›´å¤šè¾“å‡º ... äº¤äº’æç¤ºï¼šåœ¨perf reportçš„äº¤äº’ç•Œé¢ä¸­ï¼Œæ¯è¡Œå‰é¢çš„+å·è¡¨ç¤ºè¯¥æ¡ç›®å¯ä»¥å±•å¼€ã€‚æŒ‰ä¸‹Enteré”®å¯ä»¥å±•å¼€å½“å‰é€‰ä¸­çš„æ¡ç›®ï¼Œæ˜¾ç¤ºå…¶è°ƒç”¨å…³ç³»ã€‚ä½¿ç”¨æ–¹å‘é”®å¯ä»¥åœ¨ä¸åŒæ¡ç›®é—´å¯¼èˆªï¼ŒæŒ‰ä¸‹eé”®å¯ä»¥å±•å¼€æ‰€æœ‰è°ƒç”¨æ ˆã€‚\nåˆ—å«ä¹‰è¯¦è§£ #1. Children åˆ— #å«ä¹‰: åŒ…å«å­å‡½æ•°è°ƒç”¨çš„æ€»CPUæ—¶é—´å æ¯” åˆ†æè¦ç‚¹:\nè¿™æ˜¯å±‚æ¬¡åŒ–çš„æ—¶é—´ç»Ÿè®¡ åŒ…æ‹¬è¯¥å‡½æ•°åŠå…¶è°ƒç”¨çš„æ‰€æœ‰å­å‡½æ•°çš„æ—¶é—´ ç”¨äºè¯†åˆ«è°ƒç”¨é“¾çš„çƒ­ç‚¹ ç¤ºä¾‹åˆ†æ:\n+49.40% std::this_thread::yield // è¿™ä¸ªå‡½æ•°è°ƒç”¨é“¾æ€»å…±å 49.40% +49.13% __sched_yield // å…¶ä¸­__sched_yieldå 49.13% 2. Self åˆ— #å«ä¹‰: å‡½æ•°è‡ªèº«æ‰§è¡Œæ—¶é—´å æ¯”ï¼ˆä¸åŒ…æ‹¬å­å‡½æ•°ï¼‰ åˆ†æè¦ç‚¹:\nåªç»Ÿè®¡è¯¥å‡½æ•°æœ¬èº«çš„CPUæ—¶é—´ é«˜Selfå€¼è¡¨ç¤ºè¯¥å‡½æ•°æ˜¯ç›´æ¥çƒ­ç‚¹ Selfå€¼ä½ä½†Childrené«˜è¯´æ˜æ—¶é—´èŠ±åœ¨å­å‡½æ•°è°ƒç”¨ä¸Š å…³é”®å¯¹æ¯”:\nChildren Self è§£é‡Š 49.40% 0.10% æ—¶é—´ä¸»è¦åœ¨å­å‡½æ•°è°ƒç”¨ä¸Š 49.13% 6.50% __sched_yieldè‡ªèº«å°±æ¶ˆè€—6.50% 3. Command åˆ— #å«ä¹‰: è¿›ç¨‹/ç¨‹åºåç§° åˆ†æè¦ç‚¹:\næ ‡è¯†å“ªä¸ªè¿›ç¨‹äº§ç”Ÿçš„æ€§èƒ½å¼€é”€ å¤šè¿›ç¨‹ç³»ç»Ÿä¸­ç”¨äºåŒºåˆ†ä¸åŒç»„ä»¶ ç¤ºä¾‹:\nstrategyTrade: ä¸»äº¤æ˜“è¿›ç¨‹ quote_source: è¡Œæƒ…æ•°æ®è¿›ç¨‹ 4. Shared Object åˆ— #å«ä¹‰: ä»£ç æ‰€åœ¨çš„å…±äº«åº“æˆ–å¯æ‰§è¡Œæ–‡ä»¶ åˆ†æè¦ç‚¹:\nå¸®åŠ©å®šä½é—®é¢˜ä»£ç ä½ç½® åŒºåˆ†ç”¨æˆ·ä»£ç vsç³»ç»Ÿåº“è°ƒç”¨ å¸¸è§ç±»å‹:\nstrategyTrade // ä½ çš„ä¸»ç¨‹åº libc.so.6 // Cæ ‡å‡†åº“ libstdc++.so.6.0.30 // C++æ ‡å‡†åº“ [kernel.kallsyms] // å†…æ ¸ä»£ç  [unknown] // æœªçŸ¥/æ— ç¬¦å·ä¿¡æ¯ 5. Symbol åˆ— #å«ä¹‰: å…·ä½“çš„å‡½æ•°æˆ–ç¬¦å·åç§° åˆ†æè¦ç‚¹:\n[.] è¡¨ç¤ºç”¨æˆ·ç©ºé—´å‡½æ•° [k] è¡¨ç¤ºå†…æ ¸å‡½æ•° é•¿ç¬¦å·åé€šå¸¸æ˜¯C++æ¨¡æ¿å±•å¼€ åˆ†ææ–¹æ³•è®º #ç¬¬ä¸€æ­¥ï¼šè¯†åˆ«çƒ­ç‚¹ # æŒ‰Childrenæ’åº - æ‰¾è°ƒç”¨é“¾çƒ­ç‚¹ æŒ‰Selfæ’åº - æ‰¾ç›´æ¥æ‰§è¡Œçƒ­ç‚¹ perf report --sort=children perf report --sort=self ç¬¬äºŒæ­¥ï¼šå±‚æ¬¡åˆ†æ #çˆ¶å‡½æ•° (Childrené«˜ï¼ŒSelfä½) â”œâ”€â”€ å­å‡½æ•°A (Selfé«˜) â† ç›´æ¥ä¼˜åŒ–ç›®æ ‡ â”œâ”€â”€ å­å‡½æ•°B (Selfä¸­ç­‰) â””â”€â”€ å­å‡½æ•°C (Selfä½) ç¬¬ä¸‰æ­¥ï¼šå®šä½ä»£ç ä½ç½® ## æŸ¥çœ‹å…·ä½“ä»£ç è¡Œ perf annotate std::this_thread::yield # æŸ¥çœ‹è°ƒç”¨å…³ç³» perf report --call-graph=graph,0.5,caller æ¡ˆä¾‹åˆ†ææ­¥éª¤ #åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†åˆ†æä¸€ä¸ªå®é™…çš„æ€§èƒ½é—®é¢˜ï¼Œå±•ç¤ºå¦‚ä½•åº”ç”¨å‰é¢ä»‹ç»çš„æ–¹æ³•å’Œå·¥å…·ã€‚\n1. å¿«é€Ÿæ‰«æçƒ­ç‚¹ #49.40% std::this_thread::yield â† æœ€å¤§çƒ­ç‚¹ï¼ 39.43% QuoteMessageProcessor â† ç¬¬äºŒå¤§çƒ­ç‚¹ 38.61% processMessages â† å®é™…ä¸šåŠ¡é€»è¾‘ 2. æ·±å…¥åˆ†æyieldé—®é¢˜ #Children: 49.40% Self: 0.10% è¯´æ˜ï¼šyieldæœ¬èº«å¾ˆå¿«ï¼Œä½†è§¦å‘çš„ç³»ç»Ÿè°ƒç”¨å¾ˆæ…¢ 3. ç³»ç»Ÿè°ƒç”¨åˆ†æ #49.13% __sched_yield (Self: 6.50%) è¯´æ˜ï¼šå¤§éƒ¨åˆ†æ—¶é—´åœ¨å†…æ ¸çš„è°ƒåº¦å™¨ä»£ç ä¸­ 4. è°ƒç”¨é“¾è¿½è¸ª #MessageHandler::start() â†’ lambdaå‡½æ•° â†’ processMessages() â†’ yieldå¾ªç¯ é«˜çº§åˆ†ææŠ€å·§ #1. è¿‡æ»¤åˆ†æ ## åªçœ‹ç‰¹å®šå‡½æ•° perf report --comms=strategyTrade # åªçœ‹ç”¨æˆ·ç©ºé—´ perf report --dsos=strategyTrade # æŒ‰çº¿ç¨‹åˆ†æ perf report --sort=pid,comm 2. è°ƒç”¨å›¾åˆ†æ ## ç”Ÿæˆè°ƒç”¨å›¾ perf report --call-graph=graph,0.5 # å€’åºè°ƒç”¨å›¾ï¼ˆè°è°ƒç”¨äº†è¿™ä¸ªå‡½æ•°ï¼‰ perf report --call-graph=caller 3. å·®å¼‚å¯¹æ¯” ## å¯¹æ¯”ä¼˜åŒ–å‰å perf diff perf.data.before perf.data.after å®é™…ä¼˜åŒ–æµç¨‹ #1. ç¡®å®šä¼˜åŒ–ç›®æ ‡ # Children \u0026gt; 10% çš„å‡½æ•°é“¾ Self \u0026gt; 5% çš„ç›´æ¥å‡½æ•° æ„å¤–å‡ºç°åœ¨çƒ­ç‚¹çš„å‡½æ•° 2. éªŒè¯å‡è®¾ #// åœ¨å¯ç–‘ä»£ç å¤„æ·»åŠ è®¡æ—¶ auto start = std::chrono::high_resolution_clock::now(); suspected_function(); auto duration = std::chrono::duration_cast\u0026lt;std::chrono::nanoseconds\u0026gt;( std::chrono::high_resolution_clock::now() - start).count(); 3. ä¼˜åŒ–éªŒè¯ ## ä¼˜åŒ–å‰ perf record -g ./program_before perf report --stdio \u0026gt; before.txt # ä¼˜åŒ–å perf record -g ./program_after perf report --stdio \u0026gt; after.txt # å¯¹æ¯”ç»“æœ diff before.txt after.txt å…³é”®æŒ‡æ ‡è§£è¯» #æ€§èƒ½å¥åº·çš„ç³»ç»Ÿåº”è¯¥ï¼š # æ²¡æœ‰å•ä¸ªå‡½æ•°å ç”¨\u0026gt;20%çš„CPU yield/sleepç±»å‡½æ•°å æ¯”\u0026lt;1% ä¸šåŠ¡é€»è¾‘å‡½æ•°å ä¸»è¦æ¯”ä¾‹ ç³»ç»Ÿè°ƒç”¨å æ¯”åˆç†(\u0026lt;10%) ä½ çš„ç³»ç»Ÿé—®é¢˜ï¼š # yieldå 49% â† ä¸¥é‡å¼‚å¸¸ ä¸šåŠ¡é€»è¾‘ä»…å 38% â† è¢«æŒ¤å‹ å¤§é‡æ—¶é—´åœ¨è°ƒåº¦ä¸Š â† è®¾è®¡é—®é¢˜ ä½¿ç”¨Perfåˆ†æå†…å­˜æ€§èƒ½æŒ‡æ ‡ #å†…å­˜æ€§èƒ½é—®é¢˜å¾€å¾€æ˜¯ç³»ç»Ÿç“¶é¢ˆçš„é‡è¦æ¥æºã€‚Perfæä¾›äº†å¤šç§å·¥å…·å’Œæ–¹æ³•æ¥åˆ†æå†…å­˜ç›¸å…³çš„æ€§èƒ½æŒ‡æ ‡ã€‚\n1. ç¼“å­˜ç›¸å…³äº‹ä»¶é‡‡é›† ## é‡‡é›†ç¼“å­˜æœªå‘½ä¸­äº‹ä»¶ perf record -e cache-misses -a -g sleep 30 # é‡‡é›†L1æ•°æ®ç¼“å­˜åŠ è½½æœªå‘½ä¸­ perf record -e L1-dcache-load-misses -a -g sleep 30 # é‡‡é›†æœ€åçº§ç¼“å­˜åŠ è½½æœªå‘½ä¸­ perf record -e LLC-load-misses -a -g sleep 30 # åŒæ—¶é‡‡é›†å¤šä¸ªç¼“å­˜äº‹ä»¶ perf record -e cache-misses,cache-references,L1-dcache-load-misses,LLC-load-misses -a -g sleep 30 è™šæ‹Ÿç¯å¢ƒä¸­çš„é™åˆ¶ä¸æ›¿ä»£æ–¹æ¡ˆ #åœ¨è™šæ‹Ÿæœºæˆ–å®¹å™¨ç¯å¢ƒä¸­ï¼Œè®¸å¤šç¡¬ä»¶æ€§èƒ½è®¡æ•°å™¨æ— æ³•ç›´æ¥è®¿é—®ï¼Œç‰¹åˆ«æ˜¯ç¼“å­˜ç›¸å…³çš„äº‹ä»¶ã€‚ä»¥ä¸‹æ˜¯å¸¸è§çš„é™åˆ¶å’Œæ›¿ä»£æ–¹æ¡ˆï¼š\næ— æ³•ä½¿ç”¨çš„ç¼“å­˜äº‹ä»¶ï¼š\nL1-dcache-load-missesï¼šL1æ•°æ®ç¼“å­˜æœªå‘½ä¸­ï¼ˆå¤§å¤šæ•°è™šæ‹Ÿç¯å¢ƒä¸å¯ç”¨ï¼‰ LLC-load-missesï¼šæœ€åçº§ç¼“å­˜æœªå‘½ä¸­ï¼ˆå¤§å¤šæ•°è™šæ‹Ÿç¯å¢ƒä¸å¯ç”¨ï¼‰ iTLB-load-missesï¼šæŒ‡ä»¤TLBæœªå‘½ä¸­ï¼ˆé€šå¸¸ä¸å¯ç”¨ï¼‰ dTLB-load-missesï¼šæ•°æ®TLBæœªå‘½ä¸­ï¼ˆé€šå¸¸ä¸å¯ç”¨ï¼‰ å¤§å¤šæ•°ç‰¹å®šäºå¤„ç†å™¨å‹å·çš„ç¼“å­˜äº‹ä»¶ æ›¿ä»£æ–¹æ¡ˆï¼š\nä½¿ç”¨è½¯ä»¶äº‹ä»¶æ›¿ä»£ # ä½¿ç”¨è½¯ä»¶äº‹ä»¶å’Œé‡‡æ · perf record -e cycles:u -a -g sleep 30 ä½¿ç”¨å¯ç”¨çš„é€šç”¨äº‹ä»¶ # å¤§å¤šæ•°è™šæ‹Ÿç¯å¢ƒä¸­å¯ç”¨çš„äº‹ä»¶ perf record -e cpu-clock,task-clock,context-switches,cpu-migrations,page-faults -a -g sleep 30 ä½¿ç”¨perf statè¿›è¡ŒåŸºæœ¬åˆ†æ # åŸºæœ¬æ€§èƒ½ç»Ÿè®¡ï¼Œåœ¨å¤§å¤šæ•°è™šæ‹Ÿç¯å¢ƒä¸­å¯ç”¨ perf stat -e cycles,instructions,branches,branch-misses ./your_program ä½¿ç”¨ç³»ç»Ÿçº§æŒ‡æ ‡ # ç»“åˆvmstatå’Œperf vmstat 1 \u0026amp; perf record -e cpu-clock -a -g sleep 30 è€ƒè™‘ä½¿ç”¨å…¶ä»–å·¥å…· # åœ¨è™šæ‹Ÿç¯å¢ƒä¸­å¯ä»¥ä½¿ç”¨BCC/BPFå·¥å…· # éœ€è¦å®‰è£…BCCå·¥å…·åŒ… /usr/share/bcc/tools/cachestat 1 ä½¿ç”¨åº”ç”¨ç¨‹åºçº§è®¡æ—¶å™¨ // åœ¨åº”ç”¨ä»£ç ä¸­æ·»åŠ è®¡æ—¶å™¨ auto start = std::chrono::high_resolution_clock::now(); critical_function(); auto end = std::chrono::high_resolution_clock::now(); std::chrono::duration\u0026lt;double, std::milli\u0026gt; elapsed = end - start; std::cout \u0026lt;\u0026lt; \u0026#34;æ‰§è¡Œæ—¶é—´: \u0026#34; \u0026lt;\u0026lt; elapsed.count() \u0026lt;\u0026lt; \u0026#34; ms\\n\u0026#34;; æ³¨æ„ï¼šå¦‚æœç¼“å­˜æ€§èƒ½åˆ†æå¯¹æ‚¨çš„åº”ç”¨è‡³å…³é‡è¦ï¼Œå»ºè®®åœ¨ç‰©ç†æœºä¸Šè¿›è¡Œæ€§èƒ½æµ‹è¯•ï¼Œè€Œä¸æ˜¯åœ¨è™šæ‹Ÿç¯å¢ƒä¸­ã€‚\n2. å†…å­˜è®¿é—®æ¨¡å¼åˆ†æ ## é‡‡é›†å†…å­˜åŠ è½½äº‹ä»¶ perf record -e mem:0:u -a -g sleep 30 # é‡‡é›†å†…å­˜å­˜å‚¨äº‹ä»¶ perf record -e mem:0:u:store -a -g sleep 30 # é‡‡é›†å¤§é¡µé¢äº‹ä»¶ perf record -e hugetlb:*,page-faults -a -g sleep 30 3. å†…å­˜å¸¦å®½å’Œå»¶è¿Ÿåˆ†æ ## ä½¿ç”¨perf c2cåˆ†æä¼ªå…±äº«é—®é¢˜ perf c2c record -a ./your_program # åˆ†æç»“æœ perf c2c report --stats -NN 4. å†…å­˜ç›¸å…³æŒ‡æ ‡è§£è¯» #åˆ†æperf reportè¾“å‡ºæ—¶ï¼Œä»¥ä¸‹æ˜¯ä¸å†…å­˜æ€§èƒ½ç›¸å…³çš„å…³é”®æŒ‡æ ‡ï¼š\nç¼“å­˜å‘½ä¸­ç‡è®¡ç®— ## é‡‡é›†ç¼“å­˜å‘½ä¸­å’Œæœªå‘½ä¸­äº‹ä»¶ perf stat -e cache-references,cache-misses ./your_program # è¾“å‡ºç¤ºä¾‹ Performance counter stats for \u0026#39;./your_program\u0026#39;: 2,342,833 cache-references 234,487 cache-misses # 10.01% of cache-references ç¼“å­˜å‘½ä¸­ç‡ = 1 - (cache-misses / cache-references) = çº¦90%\nå†…å­˜è®¿é—®å»¶è¿Ÿåˆ†æ ## ä½¿ç”¨perf memå‘½ä»¤ perf mem record -a ./your_program perf mem report # è¾“å‡ºä¼šæ˜¾ç¤ºåŠ è½½/å­˜å‚¨æ“ä½œçš„å»¶è¿Ÿåˆ†å¸ƒ 5. å¸¸è§å†…å­˜æ€§èƒ½é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ # é—®é¢˜ç±»å‹ PerfæŒ‡æ ‡ç‰¹å¾ å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ ç¼“å­˜æœªå‘½ä¸­ç‡é«˜ cache-misses \u0026gt; 10% ä¼˜åŒ–æ•°æ®ç»“æ„å¸ƒå±€ï¼Œæé«˜å±€éƒ¨æ€§ ä¼ªå…±äº«é—®é¢˜ é«˜LLC-load-missesï¼Œå¤šçº¿ç¨‹ ä½¿ç”¨ç¼“å­˜è¡Œå¡«å……ï¼Œåˆ†ç¦»çƒ­ç‚¹å˜é‡ å†…å­˜å¸¦å®½ç“¶é¢ˆ é«˜mem-loads/storesï¼Œä½IPC å‡å°‘ä¸å¿…è¦çš„å†…å­˜è®¿é—®ï¼Œä½¿ç”¨æµå¼åŠ è½½ NUMAè®¿é—®ä¸å½“ é«˜remote_DRAMè®¿é—® ç¡®ä¿çº¿ç¨‹ä¸å…¶è®¿é—®çš„å†…å­˜åœ¨åŒä¸€NUMAèŠ‚ç‚¹ é¡µé¢é”™è¯¯è¿‡å¤š é«˜page-faultsè®¡æ•° é¢„åˆ†é…å†…å­˜ï¼Œä½¿ç”¨å¤§é¡µé¢ 6. é«˜çº§å†…å­˜åˆ†ææ¡ˆä¾‹ #ä»¥ä¸‹æ˜¯ä¸€ä¸ªçœŸå®æ¡ˆä¾‹ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨perfåˆ†æå’Œè§£å†³å†…å­˜æ€§èƒ½é—®é¢˜ï¼š\n# é‡‡é›†å†…å­˜è®¿é—®äº‹ä»¶ perf record -e cycles:pp -e cache-misses:pp -a -g sleep 30 # åˆ†æç»“æœ perf report # è¾“å‡ºç¤ºä¾‹ï¼ˆç®€åŒ–ç‰ˆï¼‰ Children Self Symbol + 25.3% 1.2% [.] process_data + 24.1% 15.6% [.] memcpy + 10.2% 8.7% [.] std::vector::resize åˆ†æï¼šmemcpyå’Œvector::resizeå ç”¨äº†å¤§é‡CPUæ—¶é—´ï¼Œè¡¨æ˜å­˜åœ¨ä¸å¿…è¦çš„å†…å­˜å¤åˆ¶æ“ä½œã€‚\nè§£å†³æ–¹æ¡ˆï¼š\nä½¿ç”¨ç§»åŠ¨è¯­ä¹‰ä»£æ›¿å¤åˆ¶ é¢„åˆ†é…è¶³å¤Ÿçš„vectorå®¹é‡ ä½¿ç”¨å¼•ç”¨ä»£æ›¿å€¼ä¼ é€’ ä¼˜åŒ–åï¼Œç›¸å…³å‡½æ•°çš„å¼€é”€é™ä½äº†80%ï¼Œæ•´ä½“æ€§èƒ½æå‡äº†35%ã€‚\n7. å†…å­˜æ€§èƒ½ä¼˜åŒ–å·¥ä½œæµ # å‘ç°é—®é¢˜ï¼šä½¿ç”¨perf statè¯†åˆ«æ˜¯å¦å­˜åœ¨å†…å­˜ç“¶é¢ˆ å®šä½çƒ­ç‚¹ï¼šä½¿ç”¨perf record/reportæ‰¾å‡ºå†…å­˜è®¿é—®çƒ­ç‚¹ åˆ†ææ¨¡å¼ï¼šä½¿ç”¨perf memåˆ†æè®¿é—®æ¨¡å¼å’Œå»¶è¿Ÿ éªŒè¯å‡è®¾ï¼šä¿®æ”¹ä»£ç å¹¶å†æ¬¡æµ‹é‡ è¿­ä»£ä¼˜åŒ–ï¼šæŒç»­ç›‘æ§å’Œæ”¹è¿› å†…å­˜æ€§èƒ½ä¼˜åŒ–æ˜¯ä¸€ä¸ªæŒç»­è¿‡ç¨‹ï¼Œéœ€è¦ç»“åˆåº”ç”¨ç‰¹æ€§å’Œç¡¬ä»¶æ¶æ„ç‰¹ç‚¹è¿›è¡Œé’ˆå¯¹æ€§åˆ†æå’Œä¼˜åŒ–ã€‚\né«˜é¢‘äº¤æ˜“ç³»ç»Ÿæ¡ˆä¾‹åˆ†æ #ä»¥ä¸‹æ˜¯ä¸€ä¸ªçœŸå®çš„é«˜é¢‘äº¤æ˜“ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–æ¡ˆä¾‹ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨perfå·¥å…·å‘ç°å¹¶è§£å†³æ€§èƒ½ç“¶é¢ˆã€‚\né—®é¢˜åœºæ™¯ #æŸé«˜é¢‘äº¤æ˜“ç³»ç»Ÿåœ¨è¡Œæƒ…æ³¢åŠ¨è¾ƒå¤§æ—¶å‡ºç°å»¶è¿Ÿå¢åŠ ï¼Œå½±å“äº¤æ˜“å†³ç­–é€Ÿåº¦ã€‚åˆæ­¥è§‚å¯Ÿæ˜¾ç¤ºCPUä½¿ç”¨ç‡ä¸é«˜ï¼Œä½†ç³»ç»Ÿå“åº”å˜æ…¢ã€‚\næ­¥éª¤1: æ•´ä½“æ€§èƒ½åˆ†æ ## é‡‡é›†ç³»ç»Ÿæ•´ä½“æ€§èƒ½æ•°æ® perf record -a -g -F 9999 sleep 60 perf report å‘ç°:\nChildren Self Command Symbol +49.63% 0.08% strategyTrade [.] std::this_thread::yield +49.38% 6.63% strategyTrade [.] __sched_yield +39.40% 0.00% quote_source [.] QuoteMessageProcessorç›¸å…³å‡½æ•° è¿™è¡¨æ˜ç³»ç»Ÿå¤§é‡æ—¶é—´èŠ±åœ¨çº¿ç¨‹yieldä¸Šï¼Œè€Œéå®é™…ä¸šåŠ¡é€»è¾‘å¤„ç†ã€‚\næ­¥éª¤2: çº¿ç¨‹æ¨¡å‹åˆ†æ ## åˆ†æçº¿ç¨‹çŠ¶æ€è½¬æ¢ perf record -e sched:sched_switch -a -g sleep 30 perf report å‘ç°: è¡Œæƒ…å¤„ç†çº¿ç¨‹å’Œç­–ç•¥è®¡ç®—çº¿ç¨‹ä¹‹é—´å­˜åœ¨ä¸¥é‡çš„çº¿ç¨‹åˆ‡æ¢å¼€é”€ï¼Œä½¿ç”¨äº†ä½æ•ˆçš„è½®è¯¢æ¨¡å¼ã€‚\næ­¥éª¤3: å†…å­˜è®¿é—®æ¨¡å¼åˆ†æ ## åˆ†æç¼“å­˜æ•ˆç‡ perf stat -e cache-references,cache-misses ./strategyTrade å‘ç°: ç¼“å­˜æœªå‘½ä¸­ç‡è¶…è¿‡15%ï¼Œè¿œé«˜äºç†æƒ³å€¼ã€‚\næ­¥éª¤4: ä¼˜åŒ–å®æ–½ # çº¿ç¨‹æ¨¡å‹é‡æ„:\nå°†è½®è¯¢æ¨¡å¼æ”¹ä¸ºæ¡ä»¶å˜é‡é€šçŸ¥ å‡å°‘çº¿ç¨‹æ•°é‡ï¼ŒæŒ‰CPUæ ¸å¿ƒåˆ†é…çº¿ç¨‹ å†…å­˜å¸ƒå±€ä¼˜åŒ–:\né‡æ–°ç»„ç»‡è¡Œæƒ…æ•°æ®ç»“æ„ï¼Œæé«˜ç¼“å­˜å±€éƒ¨æ€§ ä½¿ç”¨ç¼“å­˜è¡Œå¡«å……é¿å…ä¼ªå…±äº« é¢„åˆ†é…å†…å­˜æ± ï¼Œé¿å…åŠ¨æ€åˆ†é… ç®—æ³•ä¼˜åŒ–:\nå°†çƒ­ç‚¹è®¡ç®—è·¯å¾„å‘é‡åŒ– å‡å°‘åˆ†æ”¯é¢„æµ‹å¤±è´¥çš„å¯èƒ½æ€§ æ­¥éª¤5: ä¼˜åŒ–æ•ˆæœéªŒè¯ ## ä¼˜åŒ–åæ€§èƒ½æµ‹é‡ perf stat -e cycles,instructions,cache-references,cache-misses,branches,branch-misses -a ./strategyTrade_optimized ç»“æœ:\nç«¯åˆ°ç«¯å»¶è¿Ÿé™ä½äº†78% ç¼“å­˜æœªå‘½ä¸­ç‡ä»15%é™è‡³3% CPUä½¿ç”¨ç‡æé«˜äº†25%ï¼ˆæ›´æœ‰æ•ˆåˆ©ç”¨ï¼‰ yieldè°ƒç”¨å æ¯”ä»49%é™è‡³0.5% å…³é”®ç»éªŒæ€»ç»“ # é¿å…è½®è¯¢: åœ¨é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­ï¼Œç”¨æ¡ä»¶å˜é‡æˆ–äº‹ä»¶é€šçŸ¥ä»£æ›¿yieldè½®è¯¢ æ•°æ®å±€éƒ¨æ€§: ç¡®ä¿çƒ­ç‚¹æ•°æ®ç»“æ„é€‚åˆç¼“å­˜è¡Œå¤§å° çº¿ç¨‹äº²å’Œæ€§: å°†å…³é”®çº¿ç¨‹ç»‘å®šåˆ°ç‰¹å®šCPUæ ¸å¿ƒ é¿å…ç³»ç»Ÿè°ƒç”¨: æœ€å°åŒ–å…³é”®è·¯å¾„ä¸Šçš„ç³»ç»Ÿè°ƒç”¨ å†…å­˜é¢„åˆ†é…: ä½¿ç”¨å†…å­˜æ± é¿å…åŠ¨æ€å†…å­˜åˆ†é… æ— é”ç®—æ³•: åœ¨å¯èƒ½çš„æƒ…å†µä¸‹ä½¿ç”¨æ— é”æ•°æ®ç»“æ„ æ€»ç»“ä¸æœ€ä½³å®è·µ #é€šè¿‡æœ¬æ–‡çš„åˆ†æå’Œæ¡ˆä¾‹ç ”ç©¶ï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“å‡ºä»¥ä¸‹é«˜é¢‘äº¤æ˜“ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–çš„æœ€ä½³å®è·µï¼š\nç³»ç»ŸåŒ–åˆ†ææµç¨‹ï¼š\nå»ºç«‹æ€§èƒ½åŸºå‡† è¯†åˆ«å…³é”®çƒ­ç‚¹ åˆ†å±‚åˆ†æé—®é¢˜ éªŒè¯ä¼˜åŒ–æ•ˆæœ å…³æ³¨å…³é”®æ€§èƒ½æŒ‡æ ‡ï¼š\nç«¯åˆ°ç«¯å»¶è¿Ÿ ç¼“å­˜å‘½ä¸­ç‡ ç³»ç»Ÿè°ƒç”¨é¢‘ç‡ ä¸Šä¸‹æ–‡åˆ‡æ¢æ¬¡æ•° å¸¸è§ä¼˜åŒ–ç­–ç•¥ï¼š\né¿å…è½®è¯¢ï¼Œä½¿ç”¨äº‹ä»¶é€šçŸ¥ ä¼˜åŒ–å†…å­˜å¸ƒå±€å’Œè®¿é—®æ¨¡å¼ å‡å°‘é”ç«äº‰å’Œçº¿ç¨‹åˆ‡æ¢ ä½¿ç”¨æ— é”ç®—æ³•å’Œæ•°æ®ç»“æ„ é¢„åˆ†é…èµ„æºï¼Œé¿å…è¿è¡Œæ—¶åˆ†é… æŒç»­ç›‘æ§ä¸ä¼˜åŒ–ï¼š\nå»ºç«‹æ€§èƒ½ç›‘æ§æœºåˆ¶ å®šæœŸè¿›è¡Œæ€§èƒ½åˆ†æ åœ¨ç³»ç»Ÿå˜æ›´åé‡æ–°è¯„ä¼°æ€§èƒ½ é€šè¿‡ä½¿ç”¨perfå·¥å…·è¿›è¡Œç³»ç»ŸåŒ–çš„æ€§èƒ½åˆ†æï¼Œç»“åˆå¯¹é«˜é¢‘äº¤æ˜“ç³»ç»Ÿç‰¹æ€§çš„æ·±å…¥ç†è§£ï¼Œæˆ‘ä»¬å¯ä»¥æœ‰æ•ˆåœ°è¯†åˆ«å’Œè§£å†³æ€§èƒ½ç“¶é¢ˆï¼Œæé«˜ç³»ç»Ÿçš„å“åº”é€Ÿåº¦å’Œååé‡ï¼Œæœ€ç»ˆæå‡äº¤æ˜“ç­–ç•¥çš„æ‰§è¡Œæ•ˆç‡å’Œç›ˆåˆ©èƒ½åŠ›ã€‚\n","date":"18 June 2025","permalink":"/blog/2025-06-18-how_to_use_perf/","section":"Blog","summary":"ç›®å½• # é«˜é¢‘äº¤æ˜“ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–æ€è·¯ Perf åŸºç¡€çŸ¥è¯† perf record å‘½ä»¤å‚æ•°è¯¦è§£ é‡‡æ ·äº‹ä»¶ç±»å‹ Perf èƒ½åˆ†æçš„å…³é”®æŒ‡æ ‡ Perf Report è¾“å‡ºè§£æ åˆ—å«ä¹‰è¯¦è§£ åˆ†ææ–¹æ³•è®º é«˜çº§åˆ†ææŠ€å·§ å®é™…ä¼˜åŒ–æµç¨‹ å…³é”®æŒ‡æ ‡è§£è¯» ä½¿ç”¨Perfåˆ†æå†…å­˜æ€§èƒ½æŒ‡æ ‡ é«˜é¢‘äº¤æ˜“ç³»ç»Ÿæ¡ˆä¾‹åˆ†æ é«˜é¢‘äº¤æ˜“ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–æ€è·¯ #åœ¨é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­ï¼Œå¾®ç§’çº§çš„å»¶è¿Ÿå·®å¼‚å¯èƒ½ç›´æ¥å½±å“äº¤æ˜“ç­–ç•¥çš„æœ‰æ•ˆæ€§å’Œç›ˆåˆ©èƒ½åŠ›ã€‚ä½¿ç”¨perfè¿›è¡Œæ€§èƒ½åˆ†ææ˜¯ä¼˜åŒ–é«˜é¢‘äº¤æ˜“ç³»ç»Ÿçš„å…³é”®æ­¥éª¤ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç³»ç»ŸåŒ–çš„ä¼˜åŒ–æ€è·¯ï¼š\n1. æ€§èƒ½åŸºå‡†å»ºç«‹ #å…³é”®æŒ‡æ ‡:\nç«¯åˆ°ç«¯å»¶è¿Ÿ: ä»è¡Œæƒ…æ¥æ”¶åˆ°ä¸‹å•çš„å®Œæ•´è·¯å¾„æ—¶é—´ ååé‡: æ¯ç§’å¤„ç†çš„è®¢å•/è¡Œæƒ…æ•°é‡ å°¾å»¶è¿Ÿ: 95/99/99.9ç™¾åˆ†ä½å»¶è¿Ÿ CPUåˆ©ç”¨ç‡: æ ¸å¿ƒäº¤æ˜“è·¯å¾„çš„CPUä½¿ç”¨æƒ…å†µ # å»ºç«‹åŸºå‡†æ€§èƒ½æ•°æ® perf stat -e cycles,instructions,cache-references,cache-misses,branches,branch-misses -o perf_base.data -a -g ./strategyTrade å‘½ä»¤å‚æ•°è§£é‡Š:\ncycles: CPUå‘¨æœŸæ•°ï¼Œç”¨äºæµ‹é‡ç¨‹åºæ‰§è¡Œæ‰€éœ€çš„å¤„ç†å™¨å‘¨æœŸæ€»é‡ instructions: æ‰§è¡Œçš„æŒ‡ä»¤æ•°ï¼Œç»“åˆcycleså¯è®¡ç®—IPC(æ¯å‘¨æœŸæŒ‡ä»¤æ•°)ï¼Œè¯„ä¼°CPUåˆ©ç”¨æ•ˆç‡ cache-references: ç¼“å­˜è®¿é—®æ¬¡æ•°ï¼Œè¡¨ç¤ºç¨‹åºå¯¹CPUç¼“å­˜çš„æ€»è®¿é—®é‡ cache-misses: ç¼“å­˜æœªå‘½ä¸­æ¬¡æ•°ï¼Œé«˜ç¼“å­˜æœªå‘½ä¸­ç‡ä¼šå¯¼è‡´å¤„ç†å™¨ç­‰å¾…å†…å­˜ï¼Œå¢åŠ å»¶è¿Ÿ branches: åˆ†æ”¯æŒ‡ä»¤æ‰§è¡Œæ¬¡æ•°ï¼Œåæ˜ ç¨‹åºä¸­æ¡ä»¶åˆ¤æ–­å’Œè·³è½¬çš„é¢‘ç‡ branch-misses: åˆ†æ”¯é¢„æµ‹å¤±è´¥æ¬¡æ•°ï¼Œé«˜å¤±è´¥ç‡ä¼šå¯¼è‡´æµæ°´çº¿åˆ·æ–°ï¼Œé™ä½CPUæ•ˆç‡ -o: æŒ‡å®šè¾“å‡ºæ–‡ä»¶å -a: æ”¶é›†æ‰€æœ‰CPUæ ¸å¿ƒçš„æ•°æ®ï¼Œå…¨ç³»ç»Ÿè§†å›¾ -g: æ”¶é›†è°ƒç”¨å›¾ä¿¡æ¯ï¼Œä¾¿äºåˆ†æå‡½æ•°è°ƒç”¨å…³ç³» è¾“å‡ºç¤ºä¾‹åŠè§£è¯»:\nPerformance counter stats for \u0026#39;./strategyTrade\u0026#39;: 12,345,678,901 cycles # æ€»CPUå‘¨æœŸæ•° 24,680,046,512 instructions # æ€»æŒ‡ä»¤æ•°ï¼ŒæŒ‡ä»¤/å‘¨æœŸæ¯”çº¦ä¸º2.","title":"Perf Report åˆ†æå®Œå…¨æŒ‡å— - é«˜é¢‘äº¤æ˜“ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–"},{"content":"C++å†…å­˜åºä¸æ— é”ç¼–ç¨‹ #å¼•è¨€ #åœ¨ç°ä»£å¤šæ ¸å¤„ç†å™¨ä¸Šï¼Œé«˜æ€§èƒ½å¹¶å‘ç¼–ç¨‹å·²ç»æˆä¸ºä¸€é¡¹å…³é”®æŠ€èƒ½ã€‚C++11å¼•å…¥çš„åŸå­æ“ä½œå’Œå†…å­˜åºæ¨¡å‹ä¸ºå¼€å‘è€…æä¾›äº†æ„å»ºé«˜æ•ˆæ— é”æ•°æ®ç»“æ„çš„å·¥å…·ï¼Œä½†åŒæ—¶ä¹Ÿå¸¦æ¥äº†æ˜¾è‘—çš„å¤æ‚æ€§ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨å†…å­˜åºçš„æ¦‚å¿µã€ä¸åŒå†…å­˜åºçš„è¯­ä¹‰å·®å¼‚ï¼Œä»¥åŠå¦‚ä½•åœ¨å®é™…åº”ç”¨ä¸­æ­£ç¡®ä½¿ç”¨å®ƒä»¬æ¥æ„å»ºé«˜æ€§èƒ½çš„æ— é”æ•°æ®ç»“æ„ã€‚\nå†…å­˜æ¨¡å‹åŸºç¡€ #ä»€ä¹ˆæ˜¯å†…å­˜æ¨¡å‹ #å†…å­˜æ¨¡å‹å®šä¹‰äº†å¤šçº¿ç¨‹ç¨‹åºä¸­å†…å­˜æ“ä½œçš„å¯è§æ€§å’Œé¡ºåºæ€§è§„åˆ™ã€‚C++å†…å­˜æ¨¡å‹ä¸»è¦å…³æ³¨ä¸‰ä¸ªæ–¹é¢ï¼š\nåŸå­æ€§(Atomicity): æ“ä½œæ˜¯å¦å¯ä»¥è¢«è§†ä¸ºä¸å¯åˆ†å‰²çš„æ•´ä½“ å¯è§æ€§(Visibility): ä¸€ä¸ªçº¿ç¨‹çš„å†™å…¥ä½•æ—¶å¯¹å…¶ä»–çº¿ç¨‹å¯è§ é¡ºåºæ€§(Ordering): å¤šä¸ªæ“ä½œä¹‹é—´çš„æ‰§è¡Œé¡ºåºçº¦æŸ é‡æ’åºæ¥æº #åœ¨ç°ä»£è®¡ç®—æœºç³»ç»Ÿä¸­ï¼Œå†…å­˜æ“ä½œé‡æ’åºå¯èƒ½æ¥è‡ªä¸‰ä¸ªå±‚é¢ï¼š\nç¼–è¯‘å™¨é‡æ’åº: ç¼–è¯‘å™¨ä¸ºäº†ä¼˜åŒ–å¯èƒ½æ”¹å˜æŒ‡ä»¤é¡ºåº CPUé‡æ’åº: å¤„ç†å™¨å¯èƒ½ä¹±åºæ‰§è¡ŒæŒ‡ä»¤æˆ–å»¶è¿Ÿå†™å…¥ä¸»å­˜ ç¼“å­˜ä¸€è‡´æ€§: å¤šæ ¸ç³»ç»Ÿä¸­æ¯ä¸ªæ ¸å¿ƒçš„ç¼“å­˜å¯èƒ½æš‚æ—¶ä¸ä¸€è‡´ happens-beforeå…³ç³» #C++å†…å­˜æ¨¡å‹çš„æ ¸å¿ƒæ˜¯å»ºç«‹æ“ä½œé—´çš„happens-beforeå…³ç³»ï¼š\nå¦‚æœæ“ä½œA happens-beforeæ“ä½œBï¼Œåˆ™Açš„ç»“æœå¯¹Bå¯è§ åŒä¸€çº¿ç¨‹å†…çš„æ“ä½œä¹‹é—´è‡ªåŠ¨å»ºç«‹happens-beforeå…³ç³» è·¨çº¿ç¨‹çš„happens-beforeå…³ç³»éœ€è¦é€šè¿‡åŒæ­¥æ“ä½œå»ºç«‹ å†…å­˜æ …æ (Memory Fence) #å†…å­˜æ …æ æ˜¯ä¸€ç§åŒæ­¥åŸè¯­ï¼Œç”¨äºé™åˆ¶å†…å­˜æ“ä½œçš„é‡æ’åºï¼š\n// å®Œæ•´å†…å­˜æ …æ  std::atomic_thread_fence(std::memory_order_seq_cst); // è·å–æ …æ  std::atomic_thread_fence(std::memory_order_acquire); // é‡Šæ”¾æ …æ  std::atomic_thread_fence(std::memory_order_release); æ …æ ä¸åŸå­æ“ä½œçš„åŒºåˆ«åœ¨äºï¼Œæ …æ å½±å“æ‰€æœ‰å†…å­˜æ“ä½œï¼Œè€Œä¸ä»…é™äºç‰¹å®šçš„åŸå­å˜é‡ã€‚\n#pragma once #include \u0026lt;atomic\u0026gt; #include \u0026lt;array\u0026gt; #include \u0026lt;optional\u0026gt; #include \u0026lt;memory\u0026gt; #include \u0026lt;vector\u0026gt; namespace LockFreeQueues { // ============================================================================ // 1. å†…å­˜åºè¯¦ç»†æ¼”ç¤º // ============================================================================ class MemoryOrderingDemo { private: std::atomic\u0026lt;int\u0026gt; data{0}; std::atomic\u0026lt;bool\u0026gt; flag{false}; public: // æ¼”ç¤ºä¸åŒå†…å­˜åºçš„è¡Œä¸ºå·®å¼‚ void demonstrateRelaxed() { // relaxed: åªä¿è¯åŸå­æ€§ï¼Œå…è®¸é‡æ’åº data.store(42, std::memory_order_relaxed); flag.store(true, std::memory_order_relaxed); // ç¼–è¯‘å™¨/CPUå¯èƒ½é‡æ’è¿™ä¸¤ä¸ªæ“ä½œçš„é¡ºåºï¼ } void demonstrateAcquireRelease() { // release: ç¡®ä¿ä¹‹å‰çš„æ“ä½œä¸ä¼šé‡æ’åˆ°æ­¤æ“ä½œä¹‹å data.store(42, std::memory_order_relaxed); // è¿™ä¸ªä¸ä¼šè¢«é‡æ’åˆ°ä¸‹é¢ flag.store(true, std::memory_order_release); // é‡Šæ”¾æ“ä½œ } bool readWithAcquire() { // acquire: ç¡®ä¿åç»­æ“ä½œä¸ä¼šé‡æ’åˆ°æ­¤æ“ä½œä¹‹å‰ if (flag.load(std::memory_order_acquire)) { // è·å–æ“ä½œ int value = data.load(std::memory_order_relaxed); // è¿™ä¸ªä¸ä¼šè¢«é‡æ’åˆ°ä¸Šé¢ return value == 42; // ä¿è¯èƒ½çœ‹åˆ°dataçš„ä¿®æ”¹ } return false; } void demonstrateSeqCst() { // seq_cst: æœ€å¼ºçš„å†…å­˜åºï¼Œå…¨å±€ä¸€è‡´çš„é¡ºåº data.store(42, std::memory_order_seq_cst); flag.store(true, std::memory_order_seq_cst); // æ‰€æœ‰çº¿ç¨‹çœ‹åˆ°çš„è¿™äº›æ“ä½œé¡ºåºéƒ½æ˜¯ä¸€è‡´çš„ } }; // ============================================================================ // 2. å•ç”Ÿäº§è€…å•æ¶ˆè´¹è€…é˜Ÿåˆ— (SPSC) - åŸºç¡€ç‰ˆæœ¬ // ============================================================================ template\u0026lt;typename T, size_t Capacity\u0026gt; class SPSCQueue { private: std::array\u0026lt;T, Capacity\u0026gt; buffer; // å…³é”®ï¼šheadå’Œtailåˆ†åˆ«åªè¢«ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹ alignas(64) std::atomic\u0026lt;size_t\u0026gt; head{0}; // åªè¢«æ¶ˆè´¹è€…ä¿®æ”¹ alignas(64) std::atomic\u0026lt;size_t\u0026gt; tail{0}; // åªè¢«ç”Ÿäº§è€…ä¿®æ”¹ public: bool push(T item) { const size_t current_tail = tail.load(std::memory_order_relaxed); const size_t next_tail = (current_tail + 1) % Capacity; // acquire: ç¡®ä¿çœ‹åˆ°æ¶ˆè´¹è€…çš„æœ€æ–°headå€¼ if (next_tail == head.load(std::memory_order_acquire)) { return false; // é˜Ÿåˆ—æ»¡ } buffer[current_tail] = std::move(item); // release: ç¡®ä¿æ•°æ®å†™å…¥å®Œæˆåï¼Œæ¶ˆè´¹è€…æ‰èƒ½çœ‹åˆ°æ–°çš„tail tail.store(next_tail, std::memory_order_release); return true; } std::optional\u0026lt;T\u0026gt; pop() { const size_t current_head = head.load(std::memory_order_relaxed); // acquire: ç¡®ä¿çœ‹åˆ°ç”Ÿäº§è€…çš„æœ€æ–°tailå€¼ if (current_head == tail.load(std::memory_order_acquire)) { return std::nullopt; // é˜Ÿåˆ—ç©º } T item = std::move(buffer[current_head]); // release: ç¡®ä¿æ•°æ®è¯»å–å®Œæˆåï¼Œç”Ÿäº§è€…æ‰èƒ½çœ‹åˆ°æ–°çš„head head.store((current_head + 1) % Capacity, std::memory_order_release); return item; } }; // ============================================================================ // 3. å•ç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…é˜Ÿåˆ— (SPMC) // ============================================================================ template\u0026lt;typename T, size_t Capacity\u0026gt; class SPMCQueue { private: struct alignas(64) Element { std::atomic\u0026lt;T*\u0026gt; data{nullptr}; std::atomic\u0026lt;size_t\u0026gt; sequence{0}; }; std::array\u0026lt;Element, Capacity\u0026gt; buffer; alignas(64) std::atomic\u0026lt;size_t\u0026gt; tail{0}; // ç”Ÿäº§è€…ç´¢å¼• // æ¯ä¸ªæ¶ˆè´¹è€…éœ€è¦è‡ªå·±çš„headæŒ‡é’ˆ static thread_local size_t consumer_head; public: SPMCQueue() { // åˆå§‹åŒ–åºåˆ—å· for (size_t i = 0; i \u0026lt; Capacity; ++i) { buffer[i].sequence.store(i, std::memory_order_relaxed); } } bool push(T item) { const size_t pos = tail.load(std::memory_order_relaxed); Element\u0026amp; element = buffer[pos % Capacity]; // ç­‰å¾…è¿™ä¸ªä½ç½®å¯ç”¨ï¼ˆåºåˆ—å·åŒ¹é…ï¼‰ const size_t expected_seq = pos; if (element.sequence.load(std::memory_order_acquire) != expected_seq) { return false; // é˜Ÿåˆ—æ»¡æˆ–ä½ç½®æœªå°±ç»ª } // åˆ†é…å†…å­˜å¹¶å­˜å‚¨æ•°æ® T* data_ptr = new T(std::move(item)); element.data.store(data_ptr, std::memory_order_relaxed); // æ›´æ–°åºåˆ—å·ï¼Œé€šçŸ¥æ¶ˆè´¹è€…æ•°æ®å°±ç»ª element.sequence.store(expected_seq + 1, std::memory_order_release); // æ¨è¿›tail tail.store(pos + 1, std::memory_order_relaxed); return true; } std::optional\u0026lt;T\u0026gt; pop() { Element\u0026amp; element = buffer[consumer_head % Capacity]; // æ£€æŸ¥æ•°æ®æ˜¯å¦å°±ç»ª const size_t expected_seq = consumer_head + 1; if (element.sequence.load(std::memory_order_acquire) != expected_seq) { return std::nullopt; // æ•°æ®æœªå°±ç»ª } // è·å–æ•°æ® T* data_ptr = element.data.load(std::memory_order_relaxed); T result = std::move(*data_ptr); delete data_ptr; element.data.store(nullptr, std::memory_order_relaxed); // æ›´æ–°åºåˆ—å·ï¼Œé€šçŸ¥ç”Ÿäº§è€…ä½ç½®å¯ç”¨ element.sequence.store(consumer_head + Capacity, std::memory_order_release); ++consumer_head; return result; } }; template\u0026lt;typename T, size_t Capacity\u0026gt; thread_local size_t SPMCQueue\u0026lt;T, Capacity\u0026gt;::consumer_head = 0; // ============================================================================ // 4. å¤šç”Ÿäº§è€…å•æ¶ˆè´¹è€…é˜Ÿåˆ— (MPSC) - ä½¿ç”¨CAS // ============================================================================ template\u0026lt;typename T, size_t Capacity\u0026gt; class MPSCQueue { private: struct Node { std::atomic\u0026lt;T*\u0026gt; data{nullptr}; std::atomic\u0026lt;Node*\u0026gt; next{nullptr}; Node() = default; ~Node() { T* ptr = data.load(std::memory_order_relaxed); delete ptr; } }; alignas(64) std::atomic\u0026lt;Node*\u0026gt; head; // æ¶ˆè´¹è€…è¯»å–ç‚¹ alignas(64) std::atomic\u0026lt;Node*\u0026gt; tail; // ç”Ÿäº§è€…å†™å…¥ç‚¹ public: MPSCQueue() { Node* dummy = new Node; head.store(dummy, std::memory_order_relaxed); tail.store(dummy, std::memory_order_relaxed); } ~MPSCQueue() { while (Node* old_head = head.load(std::memory_order_relaxed)) { head.store(old_head-\u0026gt;next.load(std::memory_order_relaxed), std::memory_order_relaxed); delete old_head; } } void push(T item) { Node* new_node = new Node; T* data_ptr = new T(std::move(item)); new_node-\u0026gt;data.store(data_ptr, std::memory_order_relaxed); // å¤šç”Ÿäº§è€…éœ€è¦ç”¨CASæ¥åŸå­åœ°æ›´æ–°tail Node* prev_tail = tail.exchange(new_node, std::memory_order_acq_rel); // é“¾æ¥å‰ä¸€ä¸ªèŠ‚ç‚¹åˆ°æ–°èŠ‚ç‚¹ prev_tail-\u0026gt;next.store(new_node, std::memory_order_release); } std::optional\u0026lt;T\u0026gt; pop() { Node* current_head = head.load(std::memory_order_relaxed); Node* next = current_head-\u0026gt;next.load(std::memory_order_acquire); if (next == nullptr) { return std::nullopt; // é˜Ÿåˆ—ç©º } // è·å–æ•°æ® T* data_ptr = next-\u0026gt;data.load(std::memory_order_relaxed); T result = std::move(*data_ptr); delete data_ptr; next-\u0026gt;data.store(nullptr, std::memory_order_relaxed); // ç§»åŠ¨headæŒ‡é’ˆ head.store(next, std::memory_order_release); delete current_head; return result; } }; // ============================================================================ // 5. å¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…é˜Ÿåˆ— (MPMC) - æœ€å¤æ‚çš„å®ç° // ============================================================================ template\u0026lt;typename T, size_t Capacity\u0026gt; class MPMCQueue { private: struct Cell { std::atomic\u0026lt;T*\u0026gt; data{nullptr}; std::atomic\u0026lt;size_t\u0026gt; sequence{0}; }; static constexpr size_t CACHELINE_SIZE = 64; // ç¼“å­˜è¡Œå¯¹é½ï¼Œé¿å…ä¼ªå…±äº« alignas(CACHELINE_SIZE) std::array\u0026lt;Cell, Capacity\u0026gt; buffer; alignas(CACHELINE_SIZE) std::atomic\u0026lt;size_t\u0026gt; enqueue_pos{0}; alignas(CACHELINE_SIZE) std::atomic\u0026lt;size_t\u0026gt; dequeue_pos{0}; public: MPMCQueue() { // åˆå§‹åŒ–åºåˆ—å· for (size_t i = 0; i \u0026lt; Capacity; ++i) { buffer[i].sequence.store(i, std::memory_order_relaxed); } } bool push(T item) { Cell* cell; size_t pos = enqueue_pos.load(std::memory_order_relaxed); for (;;) { cell = \u0026amp;buffer[pos % Capacity]; size_t seq = cell-\u0026gt;sequence.load(std::memory_order_acquire); intptr_t diff = (intptr_t)seq - (intptr_t)pos; if (diff == 0) { // å°è¯•å ç”¨è¿™ä¸ªä½ç½® if (enqueue_pos.compare_exchange_weak(pos, pos + 1, std::memory_order_relaxed)) { break; } } else if (diff \u0026lt; 0) { return false; // é˜Ÿåˆ—æ»¡ } else { pos = enqueue_pos.load(std::memory_order_relaxed); } } // å­˜å‚¨æ•°æ® T* data_ptr = new T(std::move(item)); cell-\u0026gt;data.store(data_ptr, std::memory_order_relaxed); // é€šçŸ¥æ¶ˆè´¹è€…æ•°æ®å°±ç»ª cell-\u0026gt;sequence.store(pos + 1, std::memory_order_release); return true; } std::optional\u0026lt;T\u0026gt; pop() { Cell* cell; size_t pos = dequeue_pos.load(std::memory_order_relaxed); for (;;) { cell = \u0026amp;buffer[pos % Capacity]; size_t seq = cell-\u0026gt;sequence.load(std::memory_order_acquire); intptr_t diff = (intptr_t)seq - (intptr_t)(pos + 1); if (diff == 0) { // å°è¯•å ç”¨è¿™ä¸ªä½ç½® if (dequeue_pos.compare_exchange_weak(pos, pos + 1, std::memory_order_relaxed)) { break; } } else if (diff \u0026lt; 0) { return std::nullopt; // é˜Ÿåˆ—ç©º } else { pos = dequeue_pos.load(std::memory_order_relaxed); } } // è·å–æ•°æ® T* data_ptr = cell-\u0026gt;data.load(std::memory_order_relaxed); T result = std::move(*data_ptr); delete data_ptr; cell-\u0026gt;data.store(nullptr, std::memory_order_relaxed); // é€šçŸ¥ç”Ÿäº§è€…ä½ç½®å¯ç”¨ cell-\u0026gt;sequence.store(pos + Capacity, std::memory_order_release); return result; } }; // ============================================================================ // 6. ä½¿ç”¨ç¤ºä¾‹å’Œæ€§èƒ½å¯¹æ¯” // ============================================================================ class QueueBenchmark { public: static void demonstrateUsage() { // SPSCé˜Ÿåˆ— - æœ€å¿«ï¼Œé€‚ç”¨äºå•çº¿ç¨‹ç”Ÿäº§æ¶ˆè´¹ SPSCQueue\u0026lt;int, 1024\u0026gt; spsc_queue; spsc_queue.push(42); auto result1 = spsc_queue.pop(); // MPSCé˜Ÿåˆ— - å¤šä¸ªç”Ÿäº§è€…ï¼Œä¸€ä¸ªæ¶ˆè´¹è€… MPSCQueue\u0026lt;int, 1024\u0026gt; mpsc_queue; mpsc_queue.push(42); auto result2 = mpsc_queue.pop(); // MPMCé˜Ÿåˆ— - æœ€é€šç”¨ä½†æœ€å¤æ‚ MPMCQueue\u0026lt;int, 1024\u0026gt; mpmc_queue; mpmc_queue.push(42); auto result3 = mpmc_queue.pop(); } // æ€§èƒ½ç‰¹å¾è¯´æ˜ï¼š // SPSC: ~10-20ns å»¶è¿Ÿï¼Œæœ€é«˜ååé‡ // SPMC: ~50-100ns å»¶è¿Ÿï¼Œé€‚ä¸­ååé‡ // MPSC: ~100-200ns å»¶è¿Ÿï¼Œéœ€è¦CASæ“ä½œ // MPMC: ~200-500ns å»¶è¿Ÿï¼Œæœ€å¤æ‚çš„åŒæ­¥ }; } // namespace LockFreeQueues /* å†…å­˜åºä½¿ç”¨åŸåˆ™æ€»ç»“ï¼š 1. memory_order_relaxed: - åªä¿è¯åŸå­æ€§ï¼Œæ— åŒæ­¥è¯­ä¹‰ - ç”¨äºè®¡æ•°å™¨ã€ç»Ÿè®¡ç­‰åœºæ™¯ 2. memory_order_acquire/release: - å½¢æˆåŒæ­¥ç‚¹ï¼Œå»ºç«‹happens-beforeå…³ç³» - acquireé˜²æ­¢åç»­æ“ä½œå‰ç§» - releaseé˜²æ­¢ä¹‹å‰æ“ä½œåç§» - é…å¯¹ä½¿ç”¨å®ç°çº¿ç¨‹é—´åŒæ­¥ 3. memory_order_acq_rel: - åŒæ—¶å…·æœ‰acquireå’Œreleaseè¯­ä¹‰ - ç”¨äºread-modify-writeæ“ä½œ 4. memory_order_seq_cst: - æœ€å¼ºçš„å†…å­˜åºï¼Œå…¨å±€ä¸€è‡´é¡ºåº - æ€§èƒ½å¼€é”€æœ€å¤§ï¼Œä½†æœ€å®¹æ˜“ç†è§£ é€‰æ‹©å†…å­˜åºçš„å…³é”®æ˜¯ç†è§£æ•°æ®ä¾èµ–å…³ç³»å’ŒåŒæ­¥éœ€æ±‚ï¼ */ ## å¸¸è§é”™è¯¯æ¨¡å¼ä¸è°ƒè¯•æŠ€å·§ ### å¸¸è§é”™è¯¯ 1. **é”™è¯¯çš„å†…å­˜åºé€‰æ‹©** ```cpp // é”™è¯¯ï¼šç¼ºå°‘åŒæ­¥ std::atomic\u0026lt;bool\u0026gt; ready{false}; int data = 0; // çº¿ç¨‹1 data = 42; ready.store(true, std::memory_order_relaxed); // é”™è¯¯ï¼åº”ä½¿ç”¨release // çº¿ç¨‹2 if (ready.load(std::memory_order_relaxed)) { // é”™è¯¯ï¼åº”ä½¿ç”¨acquire assert(data == 42); // å¯èƒ½å¤±è´¥ } é—æ¼åŒæ­¥ç‚¹ // é”™è¯¯ï¼šåŒæ­¥ä¸å®Œæ•´ std::atomic\u0026lt;int\u0026gt; flag1{0}, flag2{0}; // çº¿ç¨‹1 flag1.store(1, std::memory_order_release); // çº¿ç¨‹2 if (flag1.load(std::memory_order_acquire)) { flag2.store(1, std::memory_order_relaxed); // é”™è¯¯ï¼åº”ä½¿ç”¨release } // çº¿ç¨‹3 if (flag2.load(std::memory_order_relaxed)) { // é”™è¯¯ï¼åº”ä½¿ç”¨acquire // æ— æ³•ä¿è¯çœ‹åˆ°çº¿ç¨‹1çš„å†™å…¥ } è¿‡åº¦ä½¿ç”¨é¡ºåºä¸€è‡´æ€§ // æ€§èƒ½ä¸ä½³ï¼šè¿‡åº¦ä½¿ç”¨seq_cst std::atomic\u0026lt;int\u0026gt; counter{0}; // åœ¨é«˜é¢‘è®¡æ•°åœºæ™¯ä¸­ä½¿ç”¨é»˜è®¤çš„seq_cstä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ counter.fetch_add(1); // é»˜è®¤ä½¿ç”¨memory_order_seq_cst // æ›´å¥½çš„åšæ³• counter.fetch_add(1, std::memory_order_relaxed); è°ƒè¯•æŠ€å·§ # ä½¿ç”¨å†…å­˜æ£€æŸ¥å·¥å…·\nThreadSanitizer (TSan)ï¼šæ£€æµ‹æ•°æ®ç«äº‰ Helgrindï¼šæ£€æµ‹åŒæ­¥é”™è¯¯ Intel Inspectorï¼šæ·±å…¥åˆ†æå¹¶å‘é—®é¢˜ å‹åŠ›æµ‹è¯•\nåœ¨ä¸åŒCPUæ¶æ„ä¸Šè¿è¡Œæµ‹è¯• ä½¿ç”¨éšæœºå»¶è¿Ÿå’Œçº¿ç¨‹è°ƒåº¦æ¥æš´éœ²ç«äº‰æ¡ä»¶ å®¡æŸ¥æ¨¡å¼\nä»æœ€ä¸¥æ ¼çš„å†…å­˜åºå¼€å§‹ï¼ˆseq_cstï¼‰ åœ¨ç¡®ä¿æ­£ç¡®æ€§åï¼Œé€æ­¥æ”¾å®½çº¦æŸä»¥æé«˜æ€§èƒ½ è®°å½•æ¯ä¸ªåŸå­å˜é‡çš„åŒæ­¥æ„å›¾å’Œçº¦æŸ å®é™…åº”ç”¨åœºæ™¯ #1. é«˜æ€§èƒ½æ—¥å¿—ç³»ç»Ÿ #æ— é”é˜Ÿåˆ—å¸¸ç”¨äºå®ç°é«˜æ€§èƒ½æ—¥å¿—ç³»ç»Ÿï¼Œå…¶ä¸­å¤šä¸ªçº¿ç¨‹å¯ä»¥å¹¶å‘å†™å…¥æ—¥å¿—ï¼Œè€Œå•ä¸ªåå°çº¿ç¨‹è´Ÿè´£å°†æ—¥å¿—å†™å…¥ç£ç›˜ï¼š\n// åº”ç”¨çº¿ç¨‹ä½¿ç”¨MPSCé˜Ÿåˆ—å†™å…¥æ—¥å¿— MPSCQueue\u0026lt;LogEntry, 8192\u0026gt; log_queue; // åº”ç”¨çº¿ç¨‹ void application_thread() { while (running) { // ... ä¸šåŠ¡é€»è¾‘ ... log_queue.push(LogEntry{\u0026#34;æ“ä½œå®Œæˆ\u0026#34;, LogLevel::INFO}); } } // æ—¥å¿—çº¿ç¨‹ void logger_thread() { while (running) { auto entry = log_queue.pop(); if (entry) { write_to_disk(*entry); } else { std::this_thread::sleep_for(std::chrono::milliseconds(1)); } } } 2. äº‹ä»¶å¤„ç†ç³»ç»Ÿ #æ¸¸æˆå¼•æ“å’ŒGUIç³»ç»Ÿå¸¸ç”¨æ— é”é˜Ÿåˆ—å¤„ç†äº‹ä»¶ï¼š\n// å¤šä¸ªçº¿ç¨‹äº§ç”Ÿäº‹ä»¶ï¼Œä¸»çº¿ç¨‹å¤„ç† MPSCQueue\u0026lt;Event, 1024\u0026gt; event_queue; // ä¸»çº¿ç¨‹äº‹ä»¶å¾ªç¯ void main_event_loop() { while (running) { // å¤„ç†æ‰€æœ‰å¾…å¤„ç†äº‹ä»¶ while (auto event = event_queue.pop()) { dispatch_event(*event); } // æ¸²æŸ“å’Œå…¶ä»–ä¸»çº¿ç¨‹å·¥ä½œ render_frame(); } } 3. å·¥ä½œçªƒå–è°ƒåº¦å™¨ #å¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…é˜Ÿåˆ—å¯ç”¨äºå®ç°å·¥ä½œçªƒå–è°ƒåº¦å™¨ï¼š\n// æ¯ä¸ªå·¥ä½œçº¿ç¨‹æœ‰è‡ªå·±çš„ä»»åŠ¡é˜Ÿåˆ— std::vector\u0026lt;MPMCQueue\u0026lt;Task, 256\u0026gt;\u0026gt; thread_queues; void worker_thread(int id) { while (running) { // å°è¯•ä»è‡ªå·±çš„é˜Ÿåˆ—è·å–ä»»åŠ¡ auto task = thread_queues[id].pop(); if (!task) { // çªƒå–å…¶ä»–çº¿ç¨‹çš„ä»»åŠ¡ for (int i = 0; i \u0026lt; thread_queues.size(); i++) { if (i == id) continue; task = thread_queues[i].pop(); if (task) break; } } if (task) { execute_task(*task); } else { std::this_thread::yield(); } } } ç»“è®º #å†…å­˜åºæ˜¯æ„å»ºé«˜æ€§èƒ½å¹¶å‘ç³»ç»Ÿçš„å…³é”®å·¥å…·ï¼Œä½†ä¹Ÿæ˜¯C++ä¸­æœ€å®¹æ˜“è¢«è¯¯ç”¨çš„ç‰¹æ€§ä¹‹ä¸€ã€‚é€šè¿‡ç†è§£ä¸åŒå†…å­˜åºçš„è¯­ä¹‰å’Œé€‚ç”¨åœºæ™¯ï¼Œå¼€å‘è€…å¯ä»¥åœ¨ä¿è¯æ­£ç¡®æ€§çš„åŒæ—¶æœ€å¤§åŒ–æ€§èƒ½ã€‚\næ— é”æ•°æ®ç»“æ„è™½ç„¶å®ç°å¤æ‚ï¼Œä½†åœ¨é«˜æ€§èƒ½åœºæ™¯ä¸‹èƒ½æä¾›æ˜¾è‘—çš„ååé‡å’Œå»¶è¿Ÿä¼˜åŠ¿ã€‚æœ¬æ–‡å±•ç¤ºçš„é˜Ÿåˆ—å®ç°å¯ä»¥ä½œä¸ºæ„å»ºè‡ªå·±çš„æ— é”ç³»ç»Ÿçš„èµ·ç‚¹ï¼Œä½†è¯·è®°ä½ï¼š\nä»ç®€å•å¼€å§‹ï¼Œé€æ­¥ä¼˜åŒ– å½»åº•æµ‹è¯•æ¯ä¸ªå®ç° è¡¡é‡æ€§èƒ½æ”¶ç›Šæ˜¯å¦å€¼å¾—å¤æ‚æ€§å¢åŠ  æœ€åï¼Œé™¤éæœ‰æ˜ç¡®çš„æ€§èƒ½éœ€æ±‚ï¼Œå¦åˆ™ä¼˜å…ˆè€ƒè™‘æ ‡å‡†åº“æä¾›çš„çº¿ç¨‹å®‰å…¨å®¹å™¨å’ŒåŒæ­¥åŸè¯­ï¼Œå®ƒä»¬é€šå¸¸èƒ½æ»¡è¶³å¤§å¤šæ•°åº”ç”¨åœºæ™¯çš„éœ€æ±‚ã€‚\n","date":"11 June 2025","permalink":"/blog/2025-06-24-memory_ordering_in_cpp/","section":"Blog","summary":"C++å†…å­˜åºä¸æ— é”ç¼–ç¨‹ #å¼•è¨€ #åœ¨ç°ä»£å¤šæ ¸å¤„ç†å™¨ä¸Šï¼Œé«˜æ€§èƒ½å¹¶å‘ç¼–ç¨‹å·²ç»æˆä¸ºä¸€é¡¹å…³é”®æŠ€èƒ½ã€‚C++11å¼•å…¥çš„åŸå­æ“ä½œå’Œå†…å­˜åºæ¨¡å‹ä¸ºå¼€å‘è€…æä¾›äº†æ„å»ºé«˜æ•ˆæ— é”æ•°æ®ç»“æ„çš„å·¥å…·ï¼Œä½†åŒæ—¶ä¹Ÿå¸¦æ¥äº†æ˜¾è‘—çš„å¤æ‚æ€§ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨å†…å­˜åºçš„æ¦‚å¿µã€ä¸åŒå†…å­˜åºçš„è¯­ä¹‰å·®å¼‚ï¼Œä»¥åŠå¦‚ä½•åœ¨å®é™…åº”ç”¨ä¸­æ­£ç¡®ä½¿ç”¨å®ƒä»¬æ¥æ„å»ºé«˜æ€§èƒ½çš„æ— é”æ•°æ®ç»“æ„ã€‚\nå†…å­˜æ¨¡å‹åŸºç¡€ #ä»€ä¹ˆæ˜¯å†…å­˜æ¨¡å‹ #å†…å­˜æ¨¡å‹å®šä¹‰äº†å¤šçº¿ç¨‹ç¨‹åºä¸­å†…å­˜æ“ä½œçš„å¯è§æ€§å’Œé¡ºåºæ€§è§„åˆ™ã€‚C++å†…å­˜æ¨¡å‹ä¸»è¦å…³æ³¨ä¸‰ä¸ªæ–¹é¢ï¼š\nåŸå­æ€§(Atomicity): æ“ä½œæ˜¯å¦å¯ä»¥è¢«è§†ä¸ºä¸å¯åˆ†å‰²çš„æ•´ä½“ å¯è§æ€§(Visibility): ä¸€ä¸ªçº¿ç¨‹çš„å†™å…¥ä½•æ—¶å¯¹å…¶ä»–çº¿ç¨‹å¯è§ é¡ºåºæ€§(Ordering): å¤šä¸ªæ“ä½œä¹‹é—´çš„æ‰§è¡Œé¡ºåºçº¦æŸ é‡æ’åºæ¥æº #åœ¨ç°ä»£è®¡ç®—æœºç³»ç»Ÿä¸­ï¼Œå†…å­˜æ“ä½œé‡æ’åºå¯èƒ½æ¥è‡ªä¸‰ä¸ªå±‚é¢ï¼š\nç¼–è¯‘å™¨é‡æ’åº: ç¼–è¯‘å™¨ä¸ºäº†ä¼˜åŒ–å¯èƒ½æ”¹å˜æŒ‡ä»¤é¡ºåº CPUé‡æ’åº: å¤„ç†å™¨å¯èƒ½ä¹±åºæ‰§è¡ŒæŒ‡ä»¤æˆ–å»¶è¿Ÿå†™å…¥ä¸»å­˜ ç¼“å­˜ä¸€è‡´æ€§: å¤šæ ¸ç³»ç»Ÿä¸­æ¯ä¸ªæ ¸å¿ƒçš„ç¼“å­˜å¯èƒ½æš‚æ—¶ä¸ä¸€è‡´ happens-beforeå…³ç³» #C++å†…å­˜æ¨¡å‹çš„æ ¸å¿ƒæ˜¯å»ºç«‹æ“ä½œé—´çš„happens-beforeå…³ç³»ï¼š\nå¦‚æœæ“ä½œA happens-beforeæ“ä½œBï¼Œåˆ™Açš„ç»“æœå¯¹Bå¯è§ åŒä¸€çº¿ç¨‹å†…çš„æ“ä½œä¹‹é—´è‡ªåŠ¨å»ºç«‹happens-beforeå…³ç³» è·¨çº¿ç¨‹çš„happens-beforeå…³ç³»éœ€è¦é€šè¿‡åŒæ­¥æ“ä½œå»ºç«‹ å†…å­˜æ …æ (Memory Fence) #å†…å­˜æ …æ æ˜¯ä¸€ç§åŒæ­¥åŸè¯­ï¼Œç”¨äºé™åˆ¶å†…å­˜æ“ä½œçš„é‡æ’åºï¼š\n// å®Œæ•´å†…å­˜æ …æ  std::atomic_thread_fence(std::memory_order_seq_cst); // è·å–æ …æ  std::atomic_thread_fence(std::memory_order_acquire); // é‡Šæ”¾æ …æ  std::atomic_thread_fence(std::memory_order_release); æ …æ ä¸åŸå­æ“ä½œçš„åŒºåˆ«åœ¨äºï¼Œæ …æ å½±å“æ‰€æœ‰å†…å­˜æ“ä½œï¼Œè€Œä¸ä»…é™äºç‰¹å®šçš„åŸå­å˜é‡ã€‚\n#pragma once #include \u0026lt;atomic\u0026gt; #include \u0026lt;array\u0026gt; #include \u0026lt;optional\u0026gt; #include \u0026lt;memory\u0026gt; #include \u0026lt;vector\u0026gt; namespace LockFreeQueues { // ============================================================================ // 1. å†…å­˜åºè¯¦ç»†æ¼”ç¤º // ============================================================================ class MemoryOrderingDemo { private: std::atomic\u0026lt;int\u0026gt; data{0}; std::atomic\u0026lt;bool\u0026gt; flag{false}; public: // æ¼”ç¤ºä¸åŒå†…å­˜åºçš„è¡Œä¸ºå·®å¼‚ void demonstrateRelaxed() { // relaxed: åªä¿è¯åŸå­æ€§ï¼Œå…è®¸é‡æ’åº data.","title":"å†…å­˜åº"},{"content":"1. åˆ†ç±» #æœ‰ä¸‰ç§ä¸åŒçš„æ¨¡ç‰ˆç±»å‹ï¼Œ\nFunction templates class templates Variable templates 1.1. function templates #template\u0026lt;typename T\u0026gt; T max(T a, T b) { return (a \u0026gt; b) ? a : b; } // ä½¿ç”¨ï¼šç¼–è¯‘å™¨è‡ªåŠ¨æ¨å¯¼ç±»å‹ int x = max(3, 7); // T = int double y = max(3.14, 2.71); // T = double å¤šå‚æ•°æ¨¡ç‰ˆ template\u0026lt;typename T, typename U\u0026gt; auto add(T a, U b) { return a + b; } å‡½æ•°æ¨¡æ¿çš„æ˜¾å¼å®ä¾‹åŒ– // å£°æ˜æ¨¡æ¿å‡½æ•° template\u0026lt;typename T\u0026gt; void process(T value) { // å®ç°... } // æ˜¾å¼å®ä¾‹åŒ–ç‰¹å®šç±»å‹ç‰ˆæœ¬ template void process\u0026lt;int\u0026gt;(int); // æ˜¾å¼å®ä¾‹åŒ–intç‰ˆæœ¬ template void process\u0026lt;double\u0026gt;(double); // æ˜¾å¼å®ä¾‹åŒ–doubleç‰ˆæœ¬ å¯å˜å‚æ•°æ¨¡æ¿å‡½æ•° // é€’å½’ç»ˆæ­¢æ¡ä»¶ void print() { std::cout \u0026lt;\u0026lt; std::endl; } // å¯å˜å‚æ•°æ¨¡æ¿ (C++11) template\u0026lt;typename T, typename... Args\u0026gt; void print(T first, Args... rest) { std::cout \u0026lt;\u0026lt; first \u0026lt;\u0026lt; \u0026#34; \u0026#34;; print(rest...); // é€’å½’è°ƒç”¨å¤„ç†å‰©ä½™å‚æ•° } // ä½¿ç”¨æŠ˜å è¡¨è¾¾å¼ (C++17) template\u0026lt;typename... Args\u0026gt; void printAll(Args... args) { (std::cout \u0026lt;\u0026lt; ... \u0026lt;\u0026lt; args) \u0026lt;\u0026lt; \u0026#39;\\n\u0026#39;; // æŠ˜å è¡¨è¾¾å¼ } // ä½¿ç”¨ print(1, \u0026#34;hello\u0026#34;, 3.14, \u0026#39;c\u0026#39;); // è¾“å‡º: 1 hello 3.14 c printAll(1, \u0026#34;hello\u0026#34;, 3.14, \u0026#39;c\u0026#39;); // è¾“å‡º: 1hello3.14c çº¦æŸä¸æ¦‚å¿µ (C++20) // ä½¿ç”¨requiresè¡¨è¾¾å¼ template\u0026lt;typename T\u0026gt; requires std::integral\u0026lt;T\u0026gt; T gcd(T a, T b) { if (b == 0) return a; return gcd(b, a % b); } // ä½¿ç”¨æ¦‚å¿µçš„ç®€å†™å½¢å¼ template\u0026lt;std::integral T\u0026gt; T lcm(T a, T b) { return (a / gcd(a, b)) * b; } // ä½¿ç”¨autoå‚æ•°ç®€å†™ (C++20) auto sum(std::integral auto a, std::integral auto b) { return a + b; } SFINAEä¸ç±»å‹ç‰¹æ€§ // ä½¿ç”¨std::enable_ifè¿›è¡ŒSFINAE (C++11) template\u0026lt;typename T, typename = std::enable_if_t\u0026lt;std::is_arithmetic_v\u0026lt;T\u0026gt;\u0026gt;\u0026gt; T square(T x) { return x * x; } // ä½¿ç”¨tag dispatchingåŒºåˆ†ç±»å‹å¤„ç† template\u0026lt;typename Iterator\u0026gt; void advance_impl(Iterator\u0026amp; it, int n, std::random_access_iterator_tag) { // éšæœºè®¿é—®è¿­ä»£å™¨å¯ä»¥ç›´æ¥è·³è·ƒ it += n; } template\u0026lt;typename Iterator\u0026gt; void advance_impl(Iterator\u0026amp; it, int n, std::bidirectional_iterator_tag) { // åŒå‘è¿­ä»£å™¨éœ€è¦å¾ªç¯ç§»åŠ¨ if (n \u0026gt; 0) { while (n--) ++it; } else { while (n++) --it; } } template\u0026lt;typename Iterator\u0026gt; void advance(Iterator\u0026amp; it, int n) { advance_impl(it, n, typename std::iterator_traits\u0026lt;Iterator\u0026gt;::iterator_category()); } å®é™…åº”ç”¨æ¡ˆä¾‹ï¼šé€šç”¨ç®—æ³•å®ç° // æ³›å‹å¿«é€Ÿæ’åºå®ç° template\u0026lt;typename RandomIt\u0026gt; void quicksort(RandomIt first, RandomIt last) { if (first \u0026lt; last) { auto pivot = *std::next(first, std::distance(first, last) / 2); auto middle1 = std::partition(first, last, [pivot](const auto\u0026amp; em) { return em \u0026lt; pivot; }); auto middle2 = std::partition(middle1, last, [pivot](const auto\u0026amp; em) { return !(pivot \u0026lt; em); }); quicksort(first, middle1); quicksort(middle2, last); } } // ä½¿ç”¨ std::vector\u0026lt;int\u0026gt; v = {5, 2, 9, 1, 7, 6, 3}; quicksort(v.begin(), v.end()); // vç°åœ¨å·²æ’åº 1.2. class templates # åŸºç¡€è¯­æ³• template\u0026lt;typename T\u0026gt; class Vector { private: T* data; size_t size_; public: Vector() : data(nullptr), size_(0) {} void push_back(const T\u0026amp; value) { // å®ç°... } T\u0026amp; operator[](size_t index) { return data[index]; } }; // ä½¿ç”¨ï¼šå¿…é¡»æ˜ç¡®æŒ‡å®šç±»å‹ Vector\u0026lt;int\u0026gt; int_vec; Vector\u0026lt;string\u0026gt; str_vec; éç±»å‹æ¨¡ç‰ˆå‚æ•° template\u0026lt;typename T, size_t N\u0026gt; class Array { T data[N]; // ç¼–è¯‘æ—¶ç¡®å®šå¤§å° public: size_t size() const { return N; } }; Array\u0026lt;int, 10\u0026gt; arr; // å¤§å°ä¸º10çš„intæ•°ç»„ 1.3. æ¨¡ç‰ˆç‰¹åŒ– # å‡½æ•°æ¨¡ç‰ˆç‰¹åŒ– // é€šç”¨ç‰ˆæœ¬ template\u0026lt;typename T\u0026gt; void print(T value) { cout \u0026lt;\u0026lt; value; } // ç‰¹åŒ–ç‰ˆæœ¬ template\u0026lt;\u0026gt; void print\u0026lt;const char*\u0026gt;(const char* value) { cout \u0026lt;\u0026lt; \u0026#34;String: \u0026#34; \u0026lt;\u0026lt; value; } ç±»æ¨¡ç‰ˆç‰¹åŒ– // é€šç”¨ç‰ˆæœ¬ template\u0026lt;typename T\u0026gt; class Storage { T data; }; // é’ˆå¯¹boolçš„ç‰¹åŒ– template\u0026lt;\u0026gt; class Storage\u0026lt;bool\u0026gt; { // ç‰¹æ®Šçš„boolå­˜å‚¨å®ç° }; ç¼–è¯‘æœºåˆ¶ æ¨¡ç‰ˆæ˜¯ç¼–è¯‘æ—¶ç”Ÿæˆä»£ç ï¼Œä¸æ˜¯è¿è¡Œæ—¶å¤šæ€,æ¯ç§ç±»å‹éƒ½ä¼šç”Ÿæˆå¯¹åº”çš„ä»£ç å®ä¾‹\nC++æ¨¡æ¿ç±»ç”¨æ³•è¯¦è§£ - ä»¥LockFreeRingBufferä¸ºä¾‹ #C++æ¨¡æ¿ç±»æ˜¯ä¸€ç§å¼ºå¤§çš„ç¼–ç¨‹å·¥å…·ï¼Œå…è®¸æˆ‘ä»¬ç¼–å†™é€šç”¨ä»£ç ï¼ŒåŒæ—¶ä¿æŒç±»å‹å®‰å…¨å’Œé«˜æ€§èƒ½ã€‚æˆ‘å°†ç»“åˆLockFreeRingBufferè¿™ä¸ªå®é™…ä¾‹å­æ¥è¯¦ç»†è®²è§£ã€‚\n#pragma once #include \u0026lt;atomic\u0026gt; #include \u0026lt;array\u0026gt; template\u0026lt;typename T, size_t Size\u0026gt; class LockFreeRingBuffer { static_assert((Size \u0026amp; (Size - 1)) == 0, \u0026#34;Size must be power of 2\u0026#34;); struct alignas(64) Item { // é¿å…false sharing std::atomic\u0026lt;bool\u0026gt; valid{false}; T data; }; static constexpr size_t MASK = Size - 1; std::array\u0026lt;Item, Size\u0026gt; buffer; alignas(64) std::atomic\u0026lt;size_t\u0026gt; write_index{0}; alignas(64) std::atomic\u0026lt;size_t\u0026gt; read_index{0}; public: bool try_push(const T\u0026amp; item) noexcept { const size_t current = write_index.load(std::memory_order_relaxed); const size_t next = (current + 1) \u0026amp; MASK; if (next == read_index.load(std::memory_order_acquire)) { return false; // buffer is full } buffer[current].data = item; buffer[current].valid.store(true, std::memory_order_release); write_index.store(next, std::memory_order_release); return true; } bool try_pop(T\u0026amp; item) noexcept { const size_t current = read_index.load(std::memory_order_relaxed); if (current == write_index.load(std::memory_order_acquire)) { return false; // buffer is empty } if (!buffer[current].valid.load(std::memory_order_acquire)) { return false; // data not ready } item = std::move(buffer[current].data); buffer[current].valid.store(false, std::memory_order_release); read_index.store((current + 1) \u0026amp; MASK, std::memory_order_release); return true; } }; // å®ä¾‹åŒ– Common::LockFreeRingBuffer\u0026lt;AggTradeQueueData, QUEUE_SIZE\u0026gt; aggTrade_queue; 1. æ¨¡æ¿ç±»çš„å®šä¹‰ #template\u0026lt;typename T, size_t Size\u0026gt; class LockFreeRingBuffer { // ç±»çš„å®ç°... }; è¿™ä¸ªå£°æ˜æœ‰ä¸¤ä¸ªæ¨¡æ¿å‚æ•°ï¼š\ntypename Tï¼šç±»å‹å‚æ•°ï¼Œè¡¨ç¤ºç¼“å†²åŒºä¸­å­˜å‚¨çš„æ•°æ®ç±»å‹ size_t Sizeï¼šéç±»å‹å‚æ•°ï¼Œè¡¨ç¤ºç¼“å†²åŒºçš„å¤§å°ï¼ˆå¿…é¡»æ˜¯ç¼–è¯‘æ—¶å¸¸é‡ï¼‰ 2. æ¨¡æ¿ç±»çš„å®ä¾‹åŒ– #åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œé€šè¿‡æŒ‡å®šå…·ä½“çš„ç±»å‹å’Œå€¼æ¥åˆ›å»ºç‰¹å®šçš„ç¼“å†²åŒºï¼š\n// åˆ›å»ºå­˜å‚¨AggTradeQueueDataç±»å‹æ•°æ®çš„ç¼“å†²åŒºï¼Œå¤§å°ä¸º8192 Common::LockFreeRingBuffer\u0026lt;AggTradeQueueData, QUEUE_SIZE\u0026gt; aggTrade_queue; // åˆ›å»ºå­˜å‚¨TickerQueueDataç±»å‹æ•°æ®çš„ç¼“å†²åŒºï¼Œå¤§å°ä¸º8192 Common::LockFreeRingBuffer\u0026lt;TickerQueueData, QUEUE_SIZE\u0026gt; ticker_queue; ç¼–è¯‘å™¨ä¼šä¸ºæ¯ç§ä¸åŒçš„æ¨¡æ¿å‚æ•°ç»„åˆç”Ÿæˆä¸åŒçš„ç±»ä»£ç ã€‚\n3. å†…éƒ¨æ•°æ®ç»“æ„çš„é€‚é… #æ¨¡æ¿ä½¿å¾—å†…éƒ¨æ•°æ®ç»“æ„å¯ä»¥æ ¹æ®ç±»å‹è‡ªåŠ¨é€‚é…ï¼š\nstruct alignas(64) Item { std::atomic\u0026lt;bool\u0026gt; valid{false}; T data; // è¿™é‡Œçš„Tä¼šè¢«æ›¿æ¢ä¸ºå®é™…ç±»å‹ }; std::array\u0026lt;Item, Size\u0026gt; buffer; // Sizeä¼šè¢«æ›¿æ¢ä¸ºå®é™…å¤§å° å½“ä½¿ç”¨LockFreeRingBuffer\u0026lt;AggTradeQueueData, 8192\u0026gt;æ—¶ï¼Œç¼–è¯‘å™¨ç”Ÿæˆçš„ä»£ç ç›¸å½“äºï¼š\nstruct Item { std::atomic\u0026lt;bool\u0026gt; valid{false}; AggTradeQueueData data; // Tè¢«æ›¿æ¢ä¸ºAggTradeQueueData }; std::array\u0026lt;Item, 8192\u0026gt; buffer; // Sizeè¢«æ›¿æ¢ä¸º8192 4. æ¨¡æ¿ç‰¹åŒ–çš„é«˜çº§ç”¨æ³• #è™½ç„¶åœ¨è¿™ä¸ªä¾‹å­ä¸­æ²¡æœ‰ä½¿ç”¨ï¼Œä½†æ¨¡æ¿è¿˜æ”¯æŒç‰¹åŒ–ï¼Œä¸ºç‰¹å®šç±»å‹æä¾›ä¼˜åŒ–çš„å®ç°ï¼š\n// ä¸»æ¨¡æ¿ template\u0026lt;typename T, size_t Size\u0026gt; class LockFreeRingBuffer { /*...*/ }; // ä¸ºç‰¹å®šç±»å‹çš„ç‰¹åŒ–ç‰ˆæœ¬ template\u0026lt;size_t Size\u0026gt; class LockFreeRingBuffer\u0026lt;int, Size\u0026gt; { /*é’ˆå¯¹intç±»å‹çš„ä¼˜åŒ–å®ç°*/ }; 8. æ¨¡æ¿çš„ä¼˜åŠ¿ #ä»LockFreeRingBufferçš„ä¾‹å­å¯ä»¥çœ‹å‡ºæ¨¡æ¿çš„ä¼˜åŠ¿ï¼š\nä»£ç å¤ç”¨ï¼šåŒä¸€å¥—ç¼“å†²åŒºé€»è¾‘ç”¨äºå¤šç§æ•°æ®ç±»å‹ ç±»å‹å®‰å…¨ï¼šç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥é¿å…è¿è¡Œæ—¶é”™è¯¯ é›¶å¼€é”€æŠ½è±¡ï¼šæ¨¡æ¿åœ¨ç¼–è¯‘æ—¶å±•å¼€ï¼Œæ²¡æœ‰è¿è¡Œæ—¶å¼€é”€ çµæ´»æ€§ï¼šå¯ä»¥å¤„ç†ä»»ä½•ç¬¦åˆæ¥å£çš„æ•°æ®ç±»å‹ æ€§èƒ½ä¼˜åŒ–ï¼šç¼–è¯‘å™¨å¯ä»¥ä¸ºç‰¹å®šç±»å‹ç”Ÿæˆä¼˜åŒ–ä»£ç  æ€»ç»“ï¼šC++æ¨¡æ¿ç±»å…è®¸æˆ‘ä»¬ç¼–å†™ä¸€æ¬¡ä»£ç ï¼Œé€‚ç”¨äºå¤šç§æ•°æ®ç±»å‹ï¼ŒåŒæ—¶ä¿æŒç±»å‹å®‰å…¨å’Œé«˜æ€§èƒ½ã€‚åœ¨é«˜æ€§èƒ½ç³»ç»Ÿå¦‚äº¤æ˜“ç³»ç»Ÿä¸­ï¼Œè¿™ç§èƒ½åŠ›å°¤ä¸ºé‡è¦ã€‚\n","date":"10 June 2025","permalink":"/blog/2025-06-24-cpp_template_class_guide/","section":"Blog","summary":"1. åˆ†ç±» #æœ‰ä¸‰ç§ä¸åŒçš„æ¨¡ç‰ˆç±»å‹ï¼Œ\nFunction templates class templates Variable templates 1.1. function templates #template\u0026lt;typename T\u0026gt; T max(T a, T b) { return (a \u0026gt; b) ? a : b; } // ä½¿ç”¨ï¼šç¼–è¯‘å™¨è‡ªåŠ¨æ¨å¯¼ç±»å‹ int x = max(3, 7); // T = int double y = max(3.14, 2.71); // T = double å¤šå‚æ•°æ¨¡ç‰ˆ template\u0026lt;typename T, typename U\u0026gt; auto add(T a, U b) { return a + b; } å‡½æ•°æ¨¡æ¿çš„æ˜¾å¼å®ä¾‹åŒ– // å£°æ˜æ¨¡æ¿å‡½æ•° template\u0026lt;typename T\u0026gt; void process(T value) { // å®ç°.","title":"c++ æ¨¡ç‰ˆ"},{"content":"è¿™ç¯‡è®ºæ–‡ ã€ŠOptimal High-Frequency Market Makingã€‹ å®ç°å¹¶åˆ†æäº† Avellaneda-Stoikov (2008) çš„é«˜é¢‘åšå¸‚å®šä»·æ¨¡å‹ï¼Œå¹¶å¼•å…¥äº†ä¸€ä¸ªåŠ¨æ€åº“å­˜æ§åˆ¶æ¨¡å—ï¼Œç”¨äºä¼˜åŒ–é™ä»·å•çš„æŒ‚å•é‡ï¼Œä»¥åœ¨ä¿è¯ç›ˆåˆ©çš„åŒæ—¶æ§åˆ¶åº“å­˜é£é™©ã€‚ä¸‹é¢æ˜¯è¯¦ç»†è§£è¯»ï¼š\nğŸ“Œ ä¸€ã€ç ”ç©¶èƒŒæ™¯ä¸åŠ¨æœº #é«˜é¢‘åšå¸‚å•†ï¼ˆHFT market makersï¼‰é€šè¿‡åœ¨è®¢å•ç°¿ä¸­æŒç»­æŒ‚å‡ºä¹°å–é™ä»·å•æ¥æä¾›æµåŠ¨æ€§ï¼Œèµšå– ä¹°å–ä»·å·®ï¼ˆspreadï¼‰ å’Œ äº¤æ˜“æ‰€æä¾›çš„æŒ‚å•è¿”åˆ©ï¼ˆrebateï¼‰ã€‚ä½†è¿™åŒæ—¶ä¼šäº§ç”Ÿåº“å­˜é£é™©ï¼ˆinventory riskï¼‰ï¼Œå³ä¹°å…¥æˆ–å–å‡ºè¿‡å¤šåï¼Œä»·æ ¼æ³¢åŠ¨å¸¦æ¥çš„é£é™©ã€‚\nAvellaneda-Stoikov æ¨¡å‹æ˜¯å…¶ä¸­ä¸€ä¸ªç»å…¸çš„é«˜é¢‘åšå¸‚å®šä»·æ¡†æ¶ï¼Œå®ƒåœ¨å‡è®¾è‚¡ç¥¨ä»·æ ¼æœä»å¸ƒæœ—è¿åŠ¨çš„åŸºç¡€ä¸Šï¼Œé€šè¿‡æ±‚è§£æœ€ä¼˜æ§åˆ¶é—®é¢˜å¾—å‡ºæœ€ä¼˜æŠ¥ä»·ç­–ç•¥ã€‚\nğŸ“Œ äºŒã€æ¨¡å‹æ¡†æ¶ #2.1 å®šä»·æ¨¡å‹ï¼ˆPricingï¼‰ #åŸºäº Avellaneda \u0026amp; Stoikov (2008)ï¼š\nè‚¡ç¥¨ä»·æ ¼æœä»å¸ƒæœ—è¿åŠ¨ï¼š $dS_t = \\sigma dW_t$ å¸‚åœºæ·±åº¦ä¸æˆäº¤æ¦‚ç‡å…³ç³»ï¼š$\\lambda(\\delta) = A e^{-\\kappa \\delta}$ åšå¸‚å•†ç›®æ ‡æ˜¯æœ€å¤§åŒ–ç»ˆç«¯æ—¶åˆ» $T$ æ—¶çš„æŒ‡æ•°æ•ˆç”¨å‡½æ•°ï¼š $$ \\max_{\\delta_a, \\delta_b} \\mathbb{E}[-e^{-\\gamma (X_T + q_T S_T)}] $$\næ¨å¯¼ç»“æœæ˜¯ï¼š\nä¸­é—´ä»·ï¼ˆIndifference Priceï¼‰ï¼š $$ r(s, t) = s - q\\gamma\\sigma^2(T - t) $$\næœ€ä¼˜æ€»æŒ‚å•ä»·å·®ï¼ˆSpreadï¼‰ï¼š $$ \\delta_a + \\delta_b = \\gamma\\sigma^2(T - t) + \\ln\\left(1 + \\frac{\\gamma}{\\kappa} \\right) $$\nğŸ‘‰ è¿™ä¸ªæ¨¡å‹ä½“ç°äº†ï¼š\nç¦»å¸‚åœºæ”¶ç›˜è¶Šè¿‘ï¼Œä»·å·®è¶Šå°ï¼ˆä¸ºäº†å‡å°‘éš”å¤œé£é™©ï¼Œå˜å¾—æ›´æ¿€è¿›ï¼‰ æŒæœ‰çš„åº“å­˜ $q$ è¶Šå¤§ï¼Œä¸­é—´ä»·è¶Šåç¦»å¸‚åœºä¸­ä»· 2.2 åº“å­˜æ§åˆ¶æ¨¡å‹ï¼ˆInventory Controlï¼‰ #ä¸ºè§£å†³ Avellaneda-Stoikov æ¨¡å‹ä¸­â€œä¸é™åˆ¶åº“å­˜å¤§å°â€çš„é—®é¢˜ï¼Œä½œè€…å¼•å…¥äº†ä¸€ä¸ªåŠ¨æ€è°ƒèŠ‚æŒ‚å•æ•°é‡çš„æ¨¡å‹ï¼š\n$$ \\begin{cases} \\phi_{\\text{bid}}^t = \\phi_{\\text{max}}^t \u0026amp; \\text{if } q_t \u0026lt; 0 \\ \\phi_{\\text{bid}}^t = \\phi_{\\text{max}}^t e^{-\\eta q_t} \u0026amp; \\text{if } q_t \u0026gt; 0 \\end{cases} \\quad \\begin{cases} \\phi_{\\text{ask}}^t = \\phi_{\\text{max}}^t \u0026amp; \\text{if } q_t \u0026gt; 0 \\ \\phi_{\\text{ask}}^t = \\phi_{\\text{max}}^t e^{-\\eta q_t} \u0026amp; \\text{if } q_t \u0026lt; 0 \\end{cases} $$\nè¿™ä¸ªè®¾è®¡é€»è¾‘æ˜¯ï¼š\nå½“å‰è‹¥æŒæœ‰è¿‡å¤šæŸä¸€æ–¹å‘çš„å¤´å¯¸ï¼ˆå¦‚å¤šå¤´ï¼‰ï¼Œåˆ™å‡å°‘æŒ‚å‡ºåŒæ–¹å‘å•çš„æ•°é‡ è¾¾åˆ°åº“å­˜ä¸­æ€§ç›®æ ‡ï¼ˆinventory mean-reversionï¼‰ 2.3 ç®—æ³•æµç¨‹ #ç­–ç•¥éµå¾ªä»¥ä¸‹æµç¨‹ï¼š\nè‹¥è®¢å•ç°¿ä¸­æ— æŒ‚å•ï¼ŒæŒ‚å‡ºæœ€ä¼˜ä¹°å–æŠ¥ä»·ï¼› è‹¥ä»…ä¸€è¾¹æŒ‚å•è¢«æˆäº¤ï¼Œåˆ™ç­‰å¾… 5 ç§’ï¼Œè‹¥æœªæˆäº¤å¦ä¸€è¾¹åˆ™å–æ¶ˆå¹¶é‡æ–°æŒ‚å•ï¼› è‹¥ä¸¤è¾¹éƒ½åœ¨è®¢å•ç°¿ä¸­ï¼Œæ¯éš” 1 ç§’åˆ·æ–°ä¸€æ¬¡æŠ¥ä»·ï¼› ğŸ“Œ ä¸‰ã€äº¤æ˜“æ¨¡æ‹Ÿå™¨è®¾è®¡ #æ„å»ºäº†ä¸€ä¸ªç®€åŒ–çš„äº¤æ˜“ç¯å¢ƒç”¨äºæ¨¡æ‹Ÿï¼š\nå¸‚åœºè®¢å•åˆ°è¾¾éµå¾ªæ—¶é—´éé½æ¬¡æ³Šæ¾è¿‡ç¨‹ï¼Œå¼ºåº¦ï¼š $$ \\lambda(t, \\xi) = \\alpha_t e^{-\\mu \\xi} $$\nå…¶ä¸­ $\\alpha_t$ æ˜¯éšæ—¶é—´å˜åŒ–çš„æˆäº¤æ´»è·ƒåº¦ï¼ˆâ€œæµ´ç¼¸æ›²çº¿â€ï¼‰ï¼Œ$\\xi$ æ˜¯è®¢å•ç°¿æ·±åº¦ã€‚\næˆäº¤äº‹ä»¶æ¨¡æ‹Ÿä½¿ç”¨è´åŠªåˆ©åˆ†å¸ƒ $Ber(\\lambda(t, \\xi)\\Delta)$ï¼Œéƒ¨åˆ†æˆäº¤ä½¿ç”¨ Gamma åˆ†å¸ƒæ¨¡æ‹Ÿã€‚ ğŸ“Œ å››ã€å®è¯ç»“æœä¸å¯¹æ¯” #å¯¹ S\u0026amp;P500 ä¸­å…·æœ‰ä¸åŒç‰¹æ€§çš„äº”åªè‚¡ç¥¨ï¼ˆå¦‚ AAPL, AMZN, GEï¼‰è¿›è¡Œå®éªŒï¼Œæ¯”è¾ƒæœ¬æ–‡ç­–ç•¥ï¼ˆoptimalï¼‰ä¸åŸºçº¿ç­–ç•¥ï¼ˆbaselineï¼Œå§‹ç»ˆæŒ‚åœ¨æœ€ä¼˜ä¹°å–ä»·ï¼‰ï¼š\nğŸ”¸ æ ¸å¿ƒç»“è®ºï¼š # æœ¬æ–‡ç­–ç•¥åœ¨å¤šæ•°è‚¡ç¥¨ä¸Šæœ‰ æ›´é«˜æˆ–ç›¸è¿‘çš„åˆ©æ¶¦ï¼› åº“å­˜æ§åˆ¶æ›´ç¨³å®šï¼ˆä½ç½®æ›´æ¥è¿‘ 0ï¼Œæ–¹å·®æ›´å°ï¼‰ï¼› ä½¿ç”¨æ›´å°‘çš„æŒ‚å•æ¬¡æ•°å®Œæˆç›¸ä¼¼æˆ–æ›´ä¼˜çš„æˆäº¤ï¼› ç›ˆåˆ©æ–¹å·®æ›´å°ï¼Œæ”¶ç›Šæ›´ç¨³å¥ï¼› ğŸ”¸ æ ·ä¾‹ç»“æœï¼ˆä»¥ AAPL ä¸ºä¾‹ï¼‰ï¼š # ç­–ç•¥ å¹³å‡æ¯æ—¥ PnL å¹³å‡æ¯æ—¥åº“å­˜ PnL æ–¹å·® åº“å­˜æ–¹å·® Optimal -988.54 0.86 289.82 63.66 Baseline -1093.60 7.53 357.66 112.20 ğŸ“Œ äº”ã€é©¬å°”å¯å¤«é“¾åˆ†æ #å°†åšå¸‚è¿‡ç¨‹å»ºæ¨¡ä¸ºé©¬å°”å¯å¤«è¿‡ç¨‹ï¼ŒçŠ¶æ€ç©ºé—´ä¸ºï¼š\nQuoting: æ­£å¸¸æŒ‚å•ï¼› Waiting: ä¸€ä¾§æˆäº¤ï¼Œå¦ä¸€ä¾§ç­‰å¾…ï¼› Spread: æˆåŠŸèµšåˆ°ä¹°å–ä»·å·®ï¼› å¼•å…¥ä¸¤ä¸ªæ€§èƒ½æŒ‡æ ‡ï¼š\næˆåŠŸæ•è·ä»·å·®çš„æ¦‚ç‡ $p^*$ å•è¾¹æˆäº¤ï¼ˆæœªå¯¹å†²ï¼‰æ¦‚ç‡ $q^*$ è‚¡ç¥¨ Optimal $p^*$ Baseline $p^*$ Optimal $q^*$ Baseline $q^*$ AAPL 2.6% 5.1% 0.8% 0.9% AMZN 19.3% 4.7% 1.9% 1.0% ğŸ‘‰ è™½ç„¶ Baseline ç­–ç•¥æŒ‚å¾—æ›´æ¿€è¿›ï¼Œæ•è·ä»·å·®çš„æ¦‚ç‡æ›´é«˜ï¼Œä½† Optimal ç­–ç•¥çš„å•è¾¹æˆäº¤æ¦‚ç‡æ›´ä½ï¼Œè¯´æ˜æ›´æœ‰æ•ˆåœ°æ§åˆ¶äº†åº“å­˜é£é™©ã€‚\nâœ… ç»“è®ºæ€»ç»“ # æœ¬æ–‡å°† Avellaneda-Stoikov çš„æ¨¡å‹æ‰©å±•ä¸ºä¸€ä¸ª å¯å®é™…è¿è¡Œçš„é«˜é¢‘åšå¸‚ç­–ç•¥ï¼› é€šè¿‡åº“å­˜æ§åˆ¶æ¨¡å—ï¼Œä½¿ç­–ç•¥èƒ½åœ¨ä¸åœæ­¢äº¤æ˜“çš„å‰æä¸‹æ§åˆ¶é£é™©ï¼› å®éªŒç»“æœéªŒè¯å…¶åœ¨å¤šä¸ªç»´åº¦ä¼˜äºåŸºå‡†ç­–ç•¥ï¼› æå‡ºè¿›ä¸€æ­¥æ”¹è¿›æ–¹å‘ï¼šå¼•å…¥å¯¹ä¸­é—´ä»·å˜åŒ–ä¸è®¢å•åˆ°è¾¾çš„é¢„æµ‹ã€‚ ref #https://stanford.edu/class/msande448/2018/Final/Reports/gr5.pdf\n","date":"19 May 2025","permalink":"/blog/2025-06-24-avellaneda_stoikov_market_making/","section":"Blog","summary":"è¿™ç¯‡è®ºæ–‡ ã€ŠOptimal High-Frequency Market Makingã€‹ å®ç°å¹¶åˆ†æäº† Avellaneda-Stoikov (2008) çš„é«˜é¢‘åšå¸‚å®šä»·æ¨¡å‹ï¼Œå¹¶å¼•å…¥äº†ä¸€ä¸ªåŠ¨æ€åº“å­˜æ§åˆ¶æ¨¡å—ï¼Œç”¨äºä¼˜åŒ–é™ä»·å•çš„æŒ‚å•é‡ï¼Œä»¥åœ¨ä¿è¯ç›ˆåˆ©çš„åŒæ—¶æ§åˆ¶åº“å­˜é£é™©ã€‚ä¸‹é¢æ˜¯è¯¦ç»†è§£è¯»ï¼š\nğŸ“Œ ä¸€ã€ç ”ç©¶èƒŒæ™¯ä¸åŠ¨æœº #é«˜é¢‘åšå¸‚å•†ï¼ˆHFT market makersï¼‰é€šè¿‡åœ¨è®¢å•ç°¿ä¸­æŒç»­æŒ‚å‡ºä¹°å–é™ä»·å•æ¥æä¾›æµåŠ¨æ€§ï¼Œèµšå– ä¹°å–ä»·å·®ï¼ˆspreadï¼‰ å’Œ äº¤æ˜“æ‰€æä¾›çš„æŒ‚å•è¿”åˆ©ï¼ˆrebateï¼‰ã€‚ä½†è¿™åŒæ—¶ä¼šäº§ç”Ÿåº“å­˜é£é™©ï¼ˆinventory riskï¼‰ï¼Œå³ä¹°å…¥æˆ–å–å‡ºè¿‡å¤šåï¼Œä»·æ ¼æ³¢åŠ¨å¸¦æ¥çš„é£é™©ã€‚\nAvellaneda-Stoikov æ¨¡å‹æ˜¯å…¶ä¸­ä¸€ä¸ªç»å…¸çš„é«˜é¢‘åšå¸‚å®šä»·æ¡†æ¶ï¼Œå®ƒåœ¨å‡è®¾è‚¡ç¥¨ä»·æ ¼æœä»å¸ƒæœ—è¿åŠ¨çš„åŸºç¡€ä¸Šï¼Œé€šè¿‡æ±‚è§£æœ€ä¼˜æ§åˆ¶é—®é¢˜å¾—å‡ºæœ€ä¼˜æŠ¥ä»·ç­–ç•¥ã€‚\nğŸ“Œ äºŒã€æ¨¡å‹æ¡†æ¶ #2.1 å®šä»·æ¨¡å‹ï¼ˆPricingï¼‰ #åŸºäº Avellaneda \u0026amp; Stoikov (2008)ï¼š\nè‚¡ç¥¨ä»·æ ¼æœä»å¸ƒæœ—è¿åŠ¨ï¼š $dS_t = \\sigma dW_t$ å¸‚åœºæ·±åº¦ä¸æˆäº¤æ¦‚ç‡å…³ç³»ï¼š$\\lambda(\\delta) = A e^{-\\kappa \\delta}$ åšå¸‚å•†ç›®æ ‡æ˜¯æœ€å¤§åŒ–ç»ˆç«¯æ—¶åˆ» $T$ æ—¶çš„æŒ‡æ•°æ•ˆç”¨å‡½æ•°ï¼š $$ \\max_{\\delta_a, \\delta_b} \\mathbb{E}[-e^{-\\gamma (X_T + q_T S_T)}] $$\næ¨å¯¼ç»“æœæ˜¯ï¼š\nä¸­é—´ä»·ï¼ˆIndifference Priceï¼‰ï¼š $$ r(s, t) = s - q\\gamma\\sigma^2(T - t) $$\næœ€ä¼˜æ€»æŒ‚å•ä»·å·®ï¼ˆSpreadï¼‰ï¼š $$ \\delta_a + \\delta_b = \\gamma\\sigma^2(T - t) + \\ln\\left(1 + \\frac{\\gamma}{\\kappa} \\right) $$","title":"MmAvellaneda Stoikov"},{"content":"è¡Œæƒ…æ•°æ®è§£æä¼˜åŒ–æœ€ä½³å®è·µ #åŸå§‹è§£ææ–¹æ¡ˆçš„æ€§èƒ½ç“¶é¢ˆ #åŸå§‹çš„ Binance èšåˆäº¤æ˜“æ•°æ®è§£æå®ç°å­˜åœ¨å¤šä¸ªæ€§èƒ½ç“¶é¢ˆï¼Œè¿™åœ¨é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­å°¤ä¸ºå…³é”®ã€‚ä¸»è¦é—®é¢˜åŒ…æ‹¬ï¼š\nä½¿ç”¨ std::stod è¿›è¡Œå­—ç¬¦ä¸²åˆ°æµ®ç‚¹æ•°è½¬æ¢ï¼š\nresult.data.price = std::stod(std::string(price_str)); result.data.quantity = std::stod(std::string(qty_str)); è¿™é‡Œå­˜åœ¨ä¸¤ä¸ªä¸¥é‡é—®é¢˜ï¼š\nstd::stod åœ¨åº•å±‚å®ç°ä¸­éœ€è¦å¤„ç†å„ç§æ ¼å¼å’Œæœ¬åœ°åŒ–ï¼Œå¯¼è‡´è®¡ç®—å¼€é”€å¤§ æ¯æ¬¡è°ƒç”¨éƒ½åˆ›å»ºäº†ä¸´æ—¶ std::string å¯¹è±¡ï¼Œå¢åŠ äº†å†…å­˜åˆ†é…å’Œé‡Šæ”¾çš„å¼€é”€ åˆ›å»ºä¸´æ—¶çš„ padded_string å¯¹è±¡ï¼š\nsimdjson::padded_string padded_json{json}; simdjson::dom::element doc = parser.parse(padded_json); è¿™ä¼šå¯¼è‡´é¢å¤–çš„å†…å­˜åˆ†é…å’Œå¤åˆ¶ï¼Œç‰¹åˆ«æ˜¯åœ¨é«˜é¢‘ç‡å¤„ç†æ¶ˆæ¯æ—¶å˜å¾—éå¸¸æ˜æ˜¾ã€‚\nä½¿ç”¨ä½æ•ˆçš„å­—ç¬¦ä¸²å¤åˆ¶æ–¹æ³•ï¼š\nstrncpy(result.data.symbol, doc[\u0026#34;s\u0026#34;].get_string().value().data(), sizeof(result.data.symbol) - 1); æ ‡å‡†çš„ strncpy æ²¡æœ‰åˆ©ç”¨ç°ä»£ CPU çš„ SIMD æŒ‡ä»¤é›†ä¼˜åŠ¿ã€‚\nå¼‚å¸¸å¤„ç†æˆæœ¬ï¼šåœ¨è§£æçƒ­è·¯å¾„ä¸­å¤§é‡ä½¿ç”¨ try-catch ç»“æ„ï¼Œè¿™ä¼šå¯¼è‡´ç¼–è¯‘å™¨ç”Ÿæˆé¢å¤–ä»£ç ï¼Œå½±å“æ€§èƒ½ã€‚\né‡å¤è·å– JSON èŠ‚ç‚¹ï¼šå¤šæ¬¡è®¿é—®ç›¸åŒçš„ JSON èŠ‚ç‚¹ï¼Œæ¯æ¬¡éƒ½éœ€è¦è¿›è¡Œå­—ç¬¦ä¸²å“ˆå¸ŒæŸ¥æ‰¾ã€‚\nä¼˜åŒ–æ–¹æ¡ˆ #ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œæˆ‘ä»¬å®æ–½äº†å¤šå±‚æ¬¡çš„ä¼˜åŒ–ç­–ç•¥ï¼š\n1. è‡ªå®šä¹‰å¿«é€Ÿè§£æè·¯å¾„ #åˆ›å»ºäº†ä¸€ä¸ªä¸“é—¨é’ˆå¯¹ Binance èšåˆäº¤æ˜“æ•°æ®æ ¼å¼çš„å¿«é€Ÿè§£æå‡½æ•°ï¼Œå®Œå…¨è·³è¿‡é€šç”¨ JSON è§£æå™¨ï¼š\nbool fastParseAggTrade(const std::string_view\u0026amp; json, Common::QuoteData::AggTradeData\u0026amp; data) noexcept { // å¿«é€Ÿæ£€æŸ¥æ¶ˆæ¯ç±»å‹ const char* type_pattern = \u0026#34;\\\u0026#34;e\\\u0026#34;:\\\u0026#34;aggTrade\\\u0026#34;\u0026#34;; if (json.find(type_pattern) == std::string_view::npos) { return false; } // ç›´æ¥åœ¨ JSON å­—ç¬¦ä¸²ä¸­æŸ¥æ‰¾å¹¶è§£æå„ä¸ªå­—æ®µ // ... } è¿™ç§æ–¹æ³•ç›´æ¥åœ¨å­—ç¬¦ä¸²ä¸Šæ“ä½œï¼Œé¿å…äº†æ„å»ºæ•´ä¸ª DOM æ ‘çš„å¼€é”€ã€‚\n2. é«˜æ•ˆçš„å­—ç¬¦ä¸²åˆ°æµ®ç‚¹æ•°è½¬æ¢ #å®ç°äº†ä¸€ä¸ªé«˜åº¦ä¼˜åŒ–çš„ fastStringToDouble å‡½æ•°ï¼Œå…·æœ‰å¤šå±‚æ¬¡ä¼˜åŒ–ï¼š\nstatic double fastStringToDouble(const std::string_view\u0026amp; sv) noexcept { // å¿«é€Ÿè·¯å¾„ï¼šå°è¯•æ£€æµ‹æ•´æ•°æ ¼å¼ bool is_negative = sv[0] == \u0026#39;-\u0026#39;; size_t start_idx = is_negative ? 1 : 0; // æ£€æŸ¥æ˜¯å¦æ˜¯ç®€å•æ•´æ•°ï¼ˆæ— å°æ•°ç‚¹ï¼Œæ— ç§‘å­¦è®¡æ•°æ³•ï¼‰ bool is_simple_int = true; for (size_t i = start_idx; i \u0026lt; sv.size(); ++i) { if (sv[i] \u0026lt; \u0026#39;0\u0026#39; || sv[i] \u0026gt; \u0026#39;9\u0026#39;) { is_simple_int = false; break; } } // å¯¹äºç®€å•æ•´æ•°ï¼Œä½¿ç”¨å¿«é€Ÿæ•´æ•°è§£æè·¯å¾„ if (is_simple_int \u0026amp;\u0026amp; sv.size() \u0026lt;= 18) { uint64_t value = 0; for (size_t i = start_idx; i \u0026lt; sv.size(); ++i) { value = value * 10 + (sv[i] - \u0026#39;0\u0026#39;); } return is_negative ? -static_cast\u0026lt;double\u0026gt;(value) : static_cast\u0026lt;double\u0026gt;(value); } // é€šç”¨è·¯å¾„ï¼šä½¿ç”¨std::from_chars double result = 0.0; auto [ptr, ec] = std::from_chars(sv.data(), sv.data() + sv.size(), result); // åªæœ‰åœ¨from_charså¤±è´¥æ—¶æ‰å›é€€åˆ°std::stod if (ec == std::errc() \u0026amp;\u0026amp; ptr == sv.data() + sv.size()) { return result; } return std::stod(std::string(sv)); } è¿™ä¸ªå®ç°æœ‰å‡ ä¸ªå…³é”®ä¼˜åŒ–ç‚¹ï¼š\nå¿«é€Ÿæ•´æ•°è·¯å¾„ï¼šå¯¹äºçº¯æ•´æ•°æ ¼å¼ï¼Œä½¿ç”¨ç›´æ¥çš„æ•´æ•°è§£æç®—æ³• ä½¿ç”¨ std::from_charsï¼Œå®ƒæ¯” std::stod å¿«å¾—å¤š åªåœ¨å¿…è¦æ—¶æ‰å›é€€åˆ°æ˜‚è´µçš„ std::stod æ–¹æ³• 3. SIMD ä¼˜åŒ–çš„å­—ç¬¦ä¸²å¤åˆ¶ #ä½¿ç”¨ SIMD æŒ‡ä»¤é›†ä¼˜åŒ–å­—ç¬¦ä¸²å¤åˆ¶æ“ä½œï¼š\nstatic void fastStringCopy(char* dest, const std::string_view\u0026amp; src, size_t max_len) noexcept { size_t len = std::min(src.size(), max_len - 1); __m256i* dest_ptr = reinterpret_cast\u0026lt;__m256i*\u0026gt;(dest); __m256i* src_ptr = reinterpret_cast\u0026lt;__m256i*\u0026gt;(const_cast\u0026lt;char*\u0026gt;(src.data())); _mm256_storeu_si256(dest_ptr, _mm256_loadu_si256(src_ptr)); dest[len] = \u0026#39;\\0\u0026#39;; } è¿™ä½¿ç”¨äº† AVX2 æŒ‡ä»¤é›†çš„ _mm256_loadu_si256 å’Œ _mm256_storeu_si256 æŒ‡ä»¤ï¼Œä¸€æ¬¡å¤åˆ¶ 32 å­—èŠ‚ï¼Œæ˜¾è‘—æé«˜äº†å­—ç¬¦ä¸²å¤åˆ¶çš„é€Ÿåº¦ã€‚\n4. æ‰¹é‡è·å– JSON å­—æ®µ #ä¼˜åŒ–åçš„ä»£ç ä¸€æ¬¡æ€§è·å–æ‰€æœ‰éœ€è¦çš„å­—æ®µï¼Œå‡å°‘äº†é‡å¤çš„æŸ¥æ‰¾æ“ä½œï¼š\n// æ‰¹é‡è·å–æ‰€æœ‰å­—æ®µï¼Œå‡å°‘å‡½æ•°è°ƒç”¨å¼€é”€ auto error1 = doc[\u0026#34;s\u0026#34;].get_string().get(symbol_str); auto error2 = doc[\u0026#34;E\u0026#34;].get_uint64().get(timestamp); // ... å…¶ä»–å­—æ®µæ‰¹é‡è·å– 5. é”™è¯¯å¤„ç†ä¼˜åŒ– #ä½¿ç”¨é”™è¯¯ç è€Œéå¼‚å¸¸å¤„ç†ï¼Œå¹¶åº”ç”¨åˆ†æ”¯é¢„æµ‹æç¤ºï¼š\nif (UNLIKELY(error)) { result.is_valid = false; result.error_message = \u0026#34;JSONè§£æé”™è¯¯\u0026#34;; return result; } UNLIKELY å®æç¤ºç¼–è¯‘å™¨è¿™ä¸ªæ¡ä»¶å¾ˆå°‘å‘ç”Ÿï¼Œä½¿ä¸»æ‰§è¡Œè·¯å¾„æ›´åŠ é¡ºç•…ã€‚\n6. é¿å…ä¸´æ—¶å¯¹è±¡åˆ›å»º #ä¼˜åŒ–ä»£ç ç›´æ¥åœ¨åŸå§‹ JSON æ•°æ®ä¸Šæ“ä½œï¼Œé¿å…åˆ›å»ºä¸´æ—¶å¯¹è±¡ï¼š\n// é¿å…åˆ›å»ºä¸´æ—¶çš„padded_stringå¯¹è±¡ simdjson::dom::element doc; auto error = parser.parse(json.data(), json.size()).get(doc); æ€§èƒ½æå‡åˆ†æ #ä¼˜åŒ–åçš„å®ç°åœ¨å‡ ä¸ªå…³é”®æ–¹é¢æ˜¾è‘—æé«˜äº†æ€§èƒ½ï¼š\nå­—ç¬¦ä¸²åˆ°æµ®ç‚¹æ•°è½¬æ¢é€Ÿåº¦æå‡ï¼š\nä½¿ç”¨ fastStringToDouble æ¯”åŸæ¥çš„ std::stod(std::string(price_str)) å¿« 10-100 å€ æ•´æ•°å¿«é€Ÿè·¯å¾„å¯¹äºçº¯æ•´æ•°æ•°æ®ï¼ˆå¦‚æŸäº›ä»·æ ¼å’Œæ•°é‡ï¼‰å¯æä¾›é¢å¤– 2-3 å€çš„åŠ é€Ÿ å†…å­˜åˆ†é…å‡å°‘ï¼š\né¿å…äº† std::string å’Œ padded_string çš„ä¸´æ—¶å¯¹è±¡åˆ›å»º åœ¨é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­ï¼Œè¿™ä¸ä»…å‡å°‘äº† CPU å¼€é”€ï¼Œè¿˜å‡è½»äº† GC å‹åŠ› SIMD åŠ é€Ÿï¼š\nSIMD ä¼˜åŒ–çš„å­—ç¬¦ä¸²å¤åˆ¶å¯ä»¥æ¯” strncpy å¿« 4-8 å€ è¿™å¯¹äºäº¤æ˜“ç³»ç»Ÿä¸­é¢‘ç¹çš„å­—ç¬¦ä¸²æ“ä½œç‰¹åˆ«æœ‰ç›Š ç›´æ¥å­—ç¬¦ä¸²è§£æè·¯å¾„ï¼š\nè·³è¿‡ JSON è§£æå™¨å¯ä»¥å‡å°‘ 70-90% çš„è§£æå¼€é”€ é’ˆå¯¹å·²çŸ¥æ ¼å¼ä¼˜åŒ–çš„è§£æå™¨ç‰¹åˆ«é€‚åˆé«˜é¢‘äº¤æ˜“ç³»ç»Ÿ åˆ†æ”¯é¢„æµ‹ä¼˜åŒ–ï¼š\nä½¿ç”¨ LIKELY å’Œ UNLIKELY å®å¸®åŠ© CPU åˆ†æ”¯é¢„æµ‹ åœ¨ç°ä»£ CPU ä¸Šï¼Œè¿™å¯ä»¥å‡å°‘æµæ°´çº¿åœé¡¿ï¼Œè¿›ä¸€æ­¥æé«˜æ€§èƒ½ å…³é”®æ”¶è·ä¸æœ€ä½³å®è·µ # é’ˆå¯¹é«˜é¢‘åœºæ™¯ä¸“é—¨ä¼˜åŒ–ï¼šé€šç”¨è§£æå™¨éš¾ä»¥æ»¡è¶³é«˜é¢‘äº¤æ˜“çš„éœ€æ±‚ï¼Œåº”å½“ä¸ºå…³é”®è·¯å¾„å¼€å‘ä¸“ç”¨è§£æå™¨ã€‚\né¿å…ä½¿ç”¨ std::stodï¼šåœ¨æ€§èƒ½å…³é”®ä»£ç ä¸­ï¼Œåº”é¿å…ä½¿ç”¨ std::stod å¹¶è€ƒè™‘ä»¥ä¸‹æ›¿ä»£æ–¹æ¡ˆï¼š\nå¯¹äºç®€å•æ ¼å¼ï¼Œä½¿ç”¨è‡ªå®šä¹‰çš„å¿«é€Ÿè§£æ ä½¿ç”¨ std::from_charsï¼Œå®ƒæ˜¯æ›´ç°ä»£çš„é«˜æ€§èƒ½æ›¿ä»£å“ åˆ©ç”¨ SIMD æŒ‡ä»¤é›†ï¼šç°ä»£ CPU çš„ SIMD æŒ‡ä»¤é›†å¯ä»¥æ˜¾è‘—åŠ é€Ÿå­—ç¬¦ä¸²å’Œå†…å­˜æ“ä½œã€‚\né¿å…å¼‚å¸¸å¤„ç†ï¼šåœ¨æ€§èƒ½å…³é”®è·¯å¾„ä¸Šä½¿ç”¨é”™è¯¯ç è€Œéå¼‚å¸¸å¤„ç†ã€‚\nå‡å°‘ä¸´æ—¶å¯¹è±¡ï¼šæ¯ä¸ªä¸´æ—¶ std::string éƒ½ä¼šå¸¦æ¥å†…å­˜åˆ†é…å¼€é”€ï¼Œåº”å½“å°½å¯èƒ½ä½¿ç”¨ std::string_viewã€‚\nä¸¤å±‚è§£æç­–ç•¥ï¼šå®ç°å¿«é€Ÿè·¯å¾„å’Œå›é€€è·¯å¾„çš„ç»„åˆï¼Œç¡®ä¿æ—¢æœ‰æ€§èƒ½åˆæœ‰ç¨³å®šæ€§ã€‚\næ€»ä¹‹ï¼Œè¿™äº›ä¼˜åŒ–ä½¿ Binance èšåˆäº¤æ˜“æ•°æ®çš„è§£æé€Ÿåº¦æé«˜äº†ä¸€ä¸ªæ•°é‡çº§ï¼Œå¯¹äºé«˜é¢‘äº¤æ˜“ç³»ç»Ÿçš„å»¶è¿Ÿå’Œååé‡éƒ½æœ‰æ˜¾è‘—æ”¹å–„ã€‚è¿™äº›æŠ€æœ¯åŒæ ·é€‚ç”¨äºå…¶ä»–éœ€è¦é«˜æ€§èƒ½ JSON å¤„ç†çš„åœºæ™¯ã€‚\n","date":"30 April 2025","permalink":"/blog/2025-06-24-perf_tool_usage_guide/","section":"Blog","summary":"è¡Œæƒ…æ•°æ®è§£æä¼˜åŒ–æœ€ä½³å®è·µ #åŸå§‹è§£ææ–¹æ¡ˆçš„æ€§èƒ½ç“¶é¢ˆ #åŸå§‹çš„ Binance èšåˆäº¤æ˜“æ•°æ®è§£æå®ç°å­˜åœ¨å¤šä¸ªæ€§èƒ½ç“¶é¢ˆï¼Œè¿™åœ¨é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­å°¤ä¸ºå…³é”®ã€‚ä¸»è¦é—®é¢˜åŒ…æ‹¬ï¼š\nä½¿ç”¨ std::stod è¿›è¡Œå­—ç¬¦ä¸²åˆ°æµ®ç‚¹æ•°è½¬æ¢ï¼š\nresult.data.price = std::stod(std::string(price_str)); result.data.quantity = std::stod(std::string(qty_str)); è¿™é‡Œå­˜åœ¨ä¸¤ä¸ªä¸¥é‡é—®é¢˜ï¼š\nstd::stod åœ¨åº•å±‚å®ç°ä¸­éœ€è¦å¤„ç†å„ç§æ ¼å¼å’Œæœ¬åœ°åŒ–ï¼Œå¯¼è‡´è®¡ç®—å¼€é”€å¤§ æ¯æ¬¡è°ƒç”¨éƒ½åˆ›å»ºäº†ä¸´æ—¶ std::string å¯¹è±¡ï¼Œå¢åŠ äº†å†…å­˜åˆ†é…å’Œé‡Šæ”¾çš„å¼€é”€ åˆ›å»ºä¸´æ—¶çš„ padded_string å¯¹è±¡ï¼š\nsimdjson::padded_string padded_json{json}; simdjson::dom::element doc = parser.parse(padded_json); è¿™ä¼šå¯¼è‡´é¢å¤–çš„å†…å­˜åˆ†é…å’Œå¤åˆ¶ï¼Œç‰¹åˆ«æ˜¯åœ¨é«˜é¢‘ç‡å¤„ç†æ¶ˆæ¯æ—¶å˜å¾—éå¸¸æ˜æ˜¾ã€‚\nä½¿ç”¨ä½æ•ˆçš„å­—ç¬¦ä¸²å¤åˆ¶æ–¹æ³•ï¼š\nstrncpy(result.data.symbol, doc[\u0026#34;s\u0026#34;].get_string().value().data(), sizeof(result.data.symbol) - 1); æ ‡å‡†çš„ strncpy æ²¡æœ‰åˆ©ç”¨ç°ä»£ CPU çš„ SIMD æŒ‡ä»¤é›†ä¼˜åŠ¿ã€‚\nå¼‚å¸¸å¤„ç†æˆæœ¬ï¼šåœ¨è§£æçƒ­è·¯å¾„ä¸­å¤§é‡ä½¿ç”¨ try-catch ç»“æ„ï¼Œè¿™ä¼šå¯¼è‡´ç¼–è¯‘å™¨ç”Ÿæˆé¢å¤–ä»£ç ï¼Œå½±å“æ€§èƒ½ã€‚\né‡å¤è·å– JSON èŠ‚ç‚¹ï¼šå¤šæ¬¡è®¿é—®ç›¸åŒçš„ JSON èŠ‚ç‚¹ï¼Œæ¯æ¬¡éƒ½éœ€è¦è¿›è¡Œå­—ç¬¦ä¸²å“ˆå¸ŒæŸ¥æ‰¾ã€‚\nä¼˜åŒ–æ–¹æ¡ˆ #ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œæˆ‘ä»¬å®æ–½äº†å¤šå±‚æ¬¡çš„ä¼˜åŒ–ç­–ç•¥ï¼š\n1. è‡ªå®šä¹‰å¿«é€Ÿè§£æè·¯å¾„ #åˆ›å»ºäº†ä¸€ä¸ªä¸“é—¨é’ˆå¯¹ Binance èšåˆäº¤æ˜“æ•°æ®æ ¼å¼çš„å¿«é€Ÿè§£æå‡½æ•°ï¼Œå®Œå…¨è·³è¿‡é€šç”¨ JSON è§£æå™¨ï¼š\nbool fastParseAggTrade(const std::string_view\u0026amp; json, Common::QuoteData::AggTradeData\u0026amp; data) noexcept { // å¿«é€Ÿæ£€æŸ¥æ¶ˆæ¯ç±»å‹ const char* type_pattern = \u0026#34;\\\u0026#34;e\\\u0026#34;:\\\u0026#34;aggTrade\\\u0026#34;\u0026#34;; if (json.","title":"è¡Œæƒ…æ•°æ®è§£æä¼˜åŒ–æœ€ä½³å®è·µ"},{"content":"","date":null,"permalink":"/tags/http/","section":"Tags","summary":"","title":"Http"},{"content":" 1. ä¼šè¯æ¢å¤ç®€ä»‹ #ä»€ä¹ˆæ˜¯ä¼šè¯æ¢å¤ï¼Ÿ #TLSä¼šè¯æ¢å¤æ˜¯TLSåè®®çš„ä¸€é¡¹ä¼˜åŒ–ç‰¹æ€§ï¼Œå…è®¸å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨åŸºäºä¹‹å‰å»ºç«‹çš„å®‰å…¨ä¼šè¯å¿«é€Ÿæ¢å¤é€šä¿¡ï¼Œè·³è¿‡å®Œæ•´çš„æ¡æ‰‹è¿‡ç¨‹ã€‚åœ¨TLS 1.3ä¸­ï¼Œä¼šè¯æ¢å¤ä¸»è¦é€šè¿‡**PSKï¼ˆPre-Shared Keyï¼Œé¢„å…±äº«å¯†é’¥ï¼‰**æœºåˆ¶å®ç°ï¼Œè€Œåœ¨TLS 1.2åŠæ›´æ—©ç‰ˆæœ¬ä¸­ï¼Œä¹Ÿå¯ä»¥é€šè¿‡Session IDæˆ–Session Ticketå®ç°ã€‚\nä¸ºä»€ä¹ˆéœ€è¦ä¼šè¯æ¢å¤ï¼Ÿ # æ€§èƒ½ä¼˜åŒ–ï¼š å®Œæ•´æ¡æ‰‹ï¼ˆTLS 1.3ï¼‰ï¼š1-RTT ä¼šè¯æ¢å¤ï¼š1-RTTï¼ˆæˆ–0-RTTï¼‰ æ˜¾è‘—å‡å°‘è¿æ¥å»ºç«‹æ—¶é—´ èµ„æºèŠ‚çœï¼š é™ä½CPUå¼€é”€ï¼ˆé¿å…é‡å¤å¯†é’¥äº¤æ¢ï¼‰ å‡å°‘ç½‘ç»œå¸¦å®½å ç”¨ 2. TLS 1.3ä¸­çš„ä¼šè¯æ¢å¤æœºåˆ¶ #å·¥ä½œæµç¨‹å¯¹æ¯” #å®Œæ•´æ¡æ‰‹ï¼ˆTLS 1.3ï¼‰ #Client Server | ClientHello | |--------------------\u0026gt;| | ServerHello | | EncryptedExt | | Certificate | | CertVerify | | Finished | |\u0026lt;--------------------| | Finished | |--------------------\u0026gt;| | NewSessionTicket | |\u0026lt;--------------------| RTTï¼š1æ¬¡å¾€è¿” æœåŠ¡å™¨åœ¨æ¡æ‰‹åå‘é€NewSessionTicketï¼ŒåŒ…å«PSKå’Œæœ‰æ•ˆæœŸä¿¡æ¯ã€‚ ä¼šè¯æ¢å¤ï¼ˆ1-RTTï¼‰ #Client Server | ClientHello | | (with PSK) | |--------------------\u0026gt;| | ServerHello | | Finished | |\u0026lt;--------------------| | Finished | |--------------------\u0026gt;| RTTï¼š1æ¬¡å¾€è¿” å®¢æˆ·ç«¯ä½¿ç”¨ä¹‹å‰ä¿å­˜çš„PSKç›´æ¥æ¢å¤ä¼šè¯ã€‚ 0-RTTï¼ˆå¯é€‰ï¼‰ #Client Server | ClientHello | | (with PSK + Early Data) | |--------------------\u0026gt;| | ServerHello | | Finished | |\u0026lt;--------------------| | Finished | |--------------------\u0026gt;| RTTï¼š0æ¬¡å¾€è¿”ï¼ˆæ—©æœŸæ•°æ®éšé¦–æ¬¡è¯·æ±‚å‘é€ï¼‰ æ³¨æ„ï¼š0-RTTæœ‰é‡æ”¾æ”»å‡»é£é™©ï¼Œä»…é€‚ç”¨äºå¹‚ç­‰è¯·æ±‚ã€‚ 3. å®ç°ç¤ºä¾‹ï¼ˆåŸºäºpicotlsï¼‰ #æ•°æ®ç»“æ„ #typedef struct { ptls_iovec_t session_ticket; // ä¼šè¯ticketï¼ˆåŒ…å«PSKï¼‰ ptls_save_ticket_t ticket_cb; // ticketä¿å­˜å›è°ƒ int is_resumption; // æ˜¯å¦æ¢å¤ä¼šè¯ time_t ticket_received_time; // ticketæ¥æ”¶æ—¶é—´ } tls_context_t; ä¿å­˜ä¼šè¯Ticket #static int save_ticket_cb(ptls_save_ticket_t* self, ptls_t* tls, ptls_iovec_t ticket) { tls_context_t* ctx = container_of(self, tls_context_t, ticket_cb); // é‡Šæ”¾æ—§ticket if (ctx-\u0026gt;session_ticket.base) { free(ctx-\u0026gt;session_ticket.base); } // ä¿å­˜æ–°ticket ctx-\u0026gt;session_ticket.base = malloc(ticket.len); if (!ctx-\u0026gt;session_ticket.base) return -1; // å†…å­˜åˆ†é…å¤±è´¥ memcpy(ctx-\u0026gt;session_ticket.base, ticket.base, ticket.len); ctx-\u0026gt;session_ticket.len = ticket.len; ctx-\u0026gt;ticket_received_time = time(NULL); return 0; } å°è¯•ä¼šè¯æ¢å¤ #ptls_handshake_properties_t props = {0}; if (conn-\u0026gt;tls_ctx.session_ticket.base) { // æ£€æŸ¥ticketæ˜¯å¦è¿‡æœŸï¼ˆå‡è®¾æœ‰æ•ˆæœŸ24å°æ—¶ï¼‰ if (time(NULL) - conn-\u0026gt;tls_ctx.ticket_received_time \u0026lt; 24 * 3600) { props.client.session_ticket = conn-\u0026gt;tls_ctx.session_ticket; props.client.max_early_data_size = 16384; // æ”¯æŒ0-RTT conn-\u0026gt;session_info.resumption_attempted = 1; } } ptls_handshake(conn-\u0026gt;tls, \u0026amp;props); éªŒè¯æ¢å¤ç»“æœ #if (conn-\u0026gt;session_info.resumption_attempted) { conn-\u0026gt;session_info.resumption_succeeded = ptls_is_psk_handshake(conn-\u0026gt;tls); if (!conn-\u0026gt;session_info.resumption_succeeded) { // æ¢å¤å¤±è´¥ï¼Œæ¸…ç†ticket free(conn-\u0026gt;tls_ctx.session_ticket.base); conn-\u0026gt;tls_ctx.session_ticket.base = NULL; conn-\u0026gt;tls_ctx.session_ticket.len = 0; } } 4. åœ¨è¿æ¥æ± ä¸­çš„åº”ç”¨ #åœºæ™¯ # å¤ç”¨è¿æ¥ï¼šæ£€æŸ¥ticketæœ‰æ•ˆæ€§ï¼Œä¼˜å…ˆå°è¯•æ¢å¤ï¼Œå¤±è´¥åˆ™å®Œæ•´æ¡æ‰‹ã€‚ æ–°å»ºè¿æ¥ï¼šä½¿ç”¨å·²æœ‰ticketå°è¯•æ¢å¤ï¼Œä¿å­˜æ–°ticketã€‚ è¿æ¥ç»´æŠ¤ï¼šè·Ÿè¸ªticketæœ‰æ•ˆæœŸï¼Œæ¸…ç†è¿‡æœŸticketï¼Œç»Ÿè®¡æ¢å¤ç‡ã€‚ ç¤ºä¾‹é€»è¾‘ #if (pool-\u0026gt;ticket.base \u0026amp;\u0026amp; time(NULL) - pool-\u0026gt;ticket_time \u0026lt; pool-\u0026gt;ticket_lifetime) { // å°è¯•æ¢å¤ props.client.session_ticket = pool-\u0026gt;ticket; if (ptls_handshake(conn-\u0026gt;tls, \u0026amp;props) == 0 \u0026amp;\u0026amp; ptls_is_psk_handshake(conn-\u0026gt;tls)) { pool-\u0026gt;stats.resumption_success++; } else { pool-\u0026gt;stats.resumption_fail++; ptls_handshake(conn-\u0026gt;tls, NULL); // å›é€€å®Œæ•´æ¡æ‰‹ } } else { // å®Œæ•´æ¡æ‰‹å¹¶ä¿å­˜æ–°ticket ptls_handshake(conn-\u0026gt;tls, NULL); } 5. æ³¨æ„äº‹é¡¹ #å®‰å…¨æ€§ # æœ‰æ•ˆæœŸé™åˆ¶ï¼šticketé€šå¸¸æœ‰æ•ˆæ•°å°æ—¶ï¼Œç”±æœåŠ¡å™¨æŒ‡å®šã€‚ å­˜å‚¨å®‰å…¨ï¼šé¿å…æ˜æ–‡ä¿å­˜ticketï¼Œå»ºè®®åŠ å¯†å­˜å‚¨ã€‚ 0-RTTé£é™©ï¼šé˜²èŒƒé‡æ”¾æ”»å‡»ï¼Œä»…ç”¨äºå®‰å…¨åœºæ™¯ã€‚ æ€§èƒ½ä¼˜åŒ– # ticketç®¡ç†ï¼šé¿å…è¿‡åº¦ä¿å­˜ï¼Œå®šæœŸæ¸…ç†æ— æ•ˆticketã€‚ æœåŠ¡å™¨è´Ÿè½½ï¼šå‡å°‘é¢‘ç¹å‘é€NewSessionTicketã€‚ ç›‘æ§æŒ‡æ ‡ï¼šè®°å½•æ¢å¤æˆåŠŸç‡ï¼Œä¼˜åŒ–ç­–ç•¥ã€‚ é”™è¯¯å¤„ç† # ä¼˜é›…é™çº§ï¼šæ¢å¤å¤±è´¥æ—¶åˆ‡æ¢å®Œæ•´æ¡æ‰‹ã€‚ æ—¥å¿—è®°å½•ï¼šä¿å­˜å¤±è´¥åŸå› ï¼ˆå¦‚ticketè¿‡æœŸæˆ–æ‹’ç»ï¼‰ã€‚ 6. æ€»ç»“ #TLSä¼šè¯æ¢å¤é€šè¿‡PSKæœºåˆ¶æ˜¾è‘—æå‡è¿æ¥æ•ˆç‡ï¼Œå°¤å…¶åœ¨é«˜å¹¶å‘åœºæ™¯ï¼ˆå¦‚è¿æ¥æ± ï¼‰ä¸­æ•ˆæœæ˜æ˜¾ã€‚æ­£ç¡®å®ç°éœ€è¦å¹³è¡¡å®‰å…¨æ€§ä¸æ€§èƒ½ï¼Œå…³æ³¨ticketç®¡ç†ã€é”™è¯¯å¤„ç†å’Œç›‘æ§ã€‚é€šè¿‡1-RTTæˆ–0-RTTï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å¯åœ¨æ¯«ç§’å†…æ¢å¤å®‰å…¨é€šä¿¡ï¼Œæ˜¯ç°ä»£ç½‘ç»œä¼˜åŒ–çš„å…³é”®æŠ€æœ¯ã€‚\næ”¹è¿›äº®ç‚¹ # TLS 1.3å‡†ç¡®æ€§ï¼šæµç¨‹å›¾å’Œæœ¯è¯­åŸºäºTLS 1.3æ ‡å‡†ã€‚ 0-RTTè¡¥å……ï¼šå¢åŠ äº†0-RTTçš„è¯´æ˜å’Œé£é™©æç¤ºã€‚ ä»£ç å¥å£®æ€§ï¼šåŠ å…¥å†…å­˜åˆ†é…æ£€æŸ¥å’Œticketè¿‡æœŸé€»è¾‘ã€‚ ç»“æ„ä¼˜åŒ–ï¼šåˆ†ä¸ºç®€ä»‹ã€æœºåˆ¶ã€å®ç°ã€åº”ç”¨å’Œæ³¨æ„äº‹é¡¹ï¼Œé€»è¾‘æ›´æ¸…æ™°ã€‚ å¦‚æœéœ€è¦è¿›ä¸€æ­¥è°ƒæ•´ï¼ˆå¦‚æ›´æ·±å…¥çš„ä»£ç ç»†èŠ‚æˆ–ç‰¹å®šåœºæ™¯åˆ†æï¼‰ï¼Œè¯·å‘Šè¯‰æˆ‘ï¼\n","date":"7 March 2025","permalink":"/blog/2025-06-24-session_resumption_techniques/","section":"Blog","summary":"1. ä¼šè¯æ¢å¤ç®€ä»‹ #ä»€ä¹ˆæ˜¯ä¼šè¯æ¢å¤ï¼Ÿ #TLSä¼šè¯æ¢å¤æ˜¯TLSåè®®çš„ä¸€é¡¹ä¼˜åŒ–ç‰¹æ€§ï¼Œå…è®¸å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨åŸºäºä¹‹å‰å»ºç«‹çš„å®‰å…¨ä¼šè¯å¿«é€Ÿæ¢å¤é€šä¿¡ï¼Œè·³è¿‡å®Œæ•´çš„æ¡æ‰‹è¿‡ç¨‹ã€‚åœ¨TLS 1.3ä¸­ï¼Œä¼šè¯æ¢å¤ä¸»è¦é€šè¿‡**PSKï¼ˆPre-Shared Keyï¼Œé¢„å…±äº«å¯†é’¥ï¼‰**æœºåˆ¶å®ç°ï¼Œè€Œåœ¨TLS 1.2åŠæ›´æ—©ç‰ˆæœ¬ä¸­ï¼Œä¹Ÿå¯ä»¥é€šè¿‡Session IDæˆ–Session Ticketå®ç°ã€‚\nä¸ºä»€ä¹ˆéœ€è¦ä¼šè¯æ¢å¤ï¼Ÿ # æ€§èƒ½ä¼˜åŒ–ï¼š å®Œæ•´æ¡æ‰‹ï¼ˆTLS 1.3ï¼‰ï¼š1-RTT ä¼šè¯æ¢å¤ï¼š1-RTTï¼ˆæˆ–0-RTTï¼‰ æ˜¾è‘—å‡å°‘è¿æ¥å»ºç«‹æ—¶é—´ èµ„æºèŠ‚çœï¼š é™ä½CPUå¼€é”€ï¼ˆé¿å…é‡å¤å¯†é’¥äº¤æ¢ï¼‰ å‡å°‘ç½‘ç»œå¸¦å®½å ç”¨ 2. TLS 1.3ä¸­çš„ä¼šè¯æ¢å¤æœºåˆ¶ #å·¥ä½œæµç¨‹å¯¹æ¯” #å®Œæ•´æ¡æ‰‹ï¼ˆTLS 1.3ï¼‰ #Client Server | ClientHello | |--------------------\u0026gt;| | ServerHello | | EncryptedExt | | Certificate | | CertVerify | | Finished | |\u0026lt;--------------------| | Finished | |--------------------\u0026gt;| | NewSessionTicket | |\u0026lt;--------------------| RTTï¼š1æ¬¡å¾€è¿” æœåŠ¡å™¨åœ¨æ¡æ‰‹åå‘é€NewSessionTicketï¼ŒåŒ…å«PSKå’Œæœ‰æ•ˆæœŸä¿¡æ¯ã€‚ ä¼šè¯æ¢å¤ï¼ˆ1-RTTï¼‰ #Client Server | ClientHello | | (with PSK) | |--------------------\u0026gt;| | ServerHello | | Finished | |\u0026lt;--------------------| | Finished | |--------------------\u0026gt;| RTTï¼š1æ¬¡å¾€è¿” å®¢æˆ·ç«¯ä½¿ç”¨ä¹‹å‰ä¿å­˜çš„PSKç›´æ¥æ¢å¤ä¼šè¯ã€‚ 0-RTTï¼ˆå¯é€‰ï¼‰ #Client Server | ClientHello | | (with PSK + Early Data) | |--------------------\u0026gt;| | ServerHello | | Finished | |\u0026lt;--------------------| | Finished | |--------------------\u0026gt;| RTTï¼š0æ¬¡å¾€è¿”ï¼ˆæ—©æœŸæ•°æ®éšé¦–æ¬¡è¯·æ±‚å‘é€ï¼‰ æ³¨æ„ï¼š0-RTTæœ‰é‡æ”¾æ”»å‡»é£é™©ï¼Œä»…é€‚ç”¨äºå¹‚ç­‰è¯·æ±‚ã€‚ 3.","title":"TLSä¼šè¯æ¢å¤ï¼ˆSession Resumptionï¼‰"},{"content":"æˆ‘æ¥å¸®ä½ ç¼–å†™ä¸€ä»½è¯¦ç»†çš„æŠ€æœ¯æ•™ç¨‹ï¼Œä»‹ç»å¦‚ä½•ä½¿ç”¨ Tailscale åœ¨ MacOS è®¾å¤‡é—´å®ç°è¿œç¨‹è¿æ¥ã€‚\nä½¿ç”¨ Tailscale å®ç° MacOS è®¾å¤‡è¿œç¨‹è¿æ¥æ•™ç¨‹ #å‡†å¤‡å·¥ä½œ # ç¡®ä¿ä¸¤å° MacOS è®¾å¤‡éƒ½èƒ½æ­£å¸¸è®¿é—®äº’è”ç½‘ å‡†å¤‡ä¸€ä¸ª Tailscale è´¦å·ï¼ˆå¯ä»¥ä½¿ç”¨ Googleã€GitHub ç­‰è´¦å·ç™»å½•ï¼‰ è¯¦ç»†æ­¥éª¤ #ç¬¬ä¸€æ­¥ï¼šå®‰è£… Tailscale #åœ¨ä¸¤å° MacOS è®¾å¤‡ä¸Šåˆ†åˆ«å®‰è£… Tailscaleï¼š\nè®¿é—® Tailscale å®˜ç½‘ (https://tailscale.com/download) ä¸‹è½½ MacOS ç‰ˆæœ¬çš„å®‰è£…åŒ… æ‰“å¼€ä¸‹è½½çš„ .dmg æ–‡ä»¶ï¼Œå°† Tailscale æ‹–å…¥åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹ ç¬¬äºŒæ­¥ï¼šç™»å½•å’Œé…ç½® # åœ¨ä¸¤å°è®¾å¤‡ä¸Šå¯åŠ¨ Tailscale ç‚¹å‡»èœå•æ çš„ Tailscale å›¾æ ‡ ä½¿ç”¨ç›¸åŒçš„è´¦å·ç™»å½• ç™»å½•æˆåŠŸåï¼ŒTailscale ä¼šè‡ªåŠ¨ä¸ºè®¾å¤‡åˆ†é… IP åœ°å€ ç‚¹å‡»èœå•æ å›¾æ ‡å¯ä»¥æŸ¥çœ‹åˆ†é…çš„ IP åœ°å€ï¼ˆé€šå¸¸æ ¼å¼ä¸º 100.xx.xx.xxï¼‰ ç¬¬ä¸‰æ­¥ï¼šå¼€å¯è¿œç¨‹è®¿é—® #åœ¨è¢«æ§åˆ¶çš„ MacOS è®¾å¤‡ä¸Šï¼š\næ‰“å¼€ç³»ç»Ÿåå¥½è®¾ç½® é€‰æ‹©\u0026quot;å…±äº«\u0026quot; å‹¾é€‰\u0026quot;è¿œç¨‹ç®¡ç†\u0026quot;æˆ–\u0026quot;å±å¹•å…±äº«\u0026quot; é…ç½®è®¿é—®æƒé™ï¼Œå¯ä»¥é€‰æ‹©ï¼š å…è®¸æ‰€æœ‰ç”¨æˆ· ä»…å…è®¸ç‰¹å®šç”¨æˆ· ç¬¬å››æ­¥ï¼šå»ºç«‹è¿æ¥ #åœ¨æ§åˆ¶ç«¯ MacOS è®¾å¤‡ä¸Šï¼š\næ‰“å¼€è®¿è¾¾ï¼ˆFinderï¼‰ åœ¨èœå•æ é€‰æ‹©\u0026quot;å‰å¾€\u0026quot; â†’ \u0026ldquo;è¿æ¥æœåŠ¡å™¨\u0026rdquo;ï¼ˆæˆ–æŒ‰ä¸‹ Command + Kï¼‰ åœ¨æœåŠ¡å™¨åœ°å€æ è¾“å…¥ï¼švnc://100.xx.xx.xxï¼ˆä½¿ç”¨ç›®æ ‡è®¾å¤‡çš„ Tailscale IPï¼‰ ç‚¹å‡»è¿æ¥ è¾“å…¥ç›®æ ‡è®¾å¤‡çš„ç”¨æˆ·åå’Œå¯†ç (å¹³å¸¸é”å±æ—¶çš„è§£é”å¯†ç ,å¯ä»¥åœ¨è®¾ç½®-ç”¨æˆ·ç¾¤ç»„-ç”¨æˆ· å¤„æŸ¥çœ‹ç”¨æˆ·å) æ³¨æ„äº‹é¡¹ # ç¡®ä¿ä¸¤å°è®¾å¤‡éƒ½ä¿æŒ Tailscale åœ¨çº¿çŠ¶æ€ å»ºè®®åœ¨é¦–æ¬¡è¿æ¥æ—¶è¿›è¡Œæµ‹è¯•ï¼Œç¡®ä¿è¿æ¥æ­£å¸¸ å¦‚é‡è¿æ¥é—®é¢˜ï¼Œæ£€æŸ¥ï¼š Tailscale çŠ¶æ€æ˜¯å¦åœ¨çº¿ ç›®æ ‡è®¾å¤‡çš„å±å¹•å…±äº«æ˜¯å¦å¼€å¯ IP åœ°å€æ˜¯å¦è¾“å…¥æ­£ç¡® é˜²ç«å¢™è®¾ç½®æ˜¯å¦å…è®¸è¿æ¥ å®‰å…¨å»ºè®® # å®šæœŸæ›´æ–° Tailscale å®¢æˆ·ç«¯ ä½¿ç”¨å¼ºå¯†ç ä¿æŠ¤ä½ çš„ Tailscale è´¦å· åœ¨ä¸éœ€è¦è¿œç¨‹è¿æ¥æ—¶ï¼Œå»ºè®®å…³é—­å±å¹•å…±äº«åŠŸèƒ½ å®šæœŸæ£€æŸ¥å·²æˆæƒè®¾å¤‡åˆ—è¡¨ï¼Œç§»é™¤ä¸éœ€è¦çš„è®¾å¤‡ è¿™æ ·è®¾ç½®åï¼Œä½ å°±å¯ä»¥é€šè¿‡ Tailscale å®‰å…¨åœ°è¿œç¨‹è¿æ¥å’Œæ§åˆ¶å…¶ä»– MacOS è®¾å¤‡äº†ã€‚Tailscale ä½¿ç”¨äº†å®‰å…¨çš„åŠ å¯†é€šä¿¡ï¼Œè®©è¿œç¨‹è¿æ¥æ›´åŠ å®‰å…¨å¯é ã€‚\n","date":"19 January 2025","permalink":"/blog/2025-06-24-screen_sharing_techniques/","section":"Blog","summary":"æˆ‘æ¥å¸®ä½ ç¼–å†™ä¸€ä»½è¯¦ç»†çš„æŠ€æœ¯æ•™ç¨‹ï¼Œä»‹ç»å¦‚ä½•ä½¿ç”¨ Tailscale åœ¨ MacOS è®¾å¤‡é—´å®ç°è¿œç¨‹è¿æ¥ã€‚\nä½¿ç”¨ Tailscale å®ç° MacOS è®¾å¤‡è¿œç¨‹è¿æ¥æ•™ç¨‹ #å‡†å¤‡å·¥ä½œ # ç¡®ä¿ä¸¤å° MacOS è®¾å¤‡éƒ½èƒ½æ­£å¸¸è®¿é—®äº’è”ç½‘ å‡†å¤‡ä¸€ä¸ª Tailscale è´¦å·ï¼ˆå¯ä»¥ä½¿ç”¨ Googleã€GitHub ç­‰è´¦å·ç™»å½•ï¼‰ è¯¦ç»†æ­¥éª¤ #ç¬¬ä¸€æ­¥ï¼šå®‰è£… Tailscale #åœ¨ä¸¤å° MacOS è®¾å¤‡ä¸Šåˆ†åˆ«å®‰è£… Tailscaleï¼š\nè®¿é—® Tailscale å®˜ç½‘ (https://tailscale.com/download) ä¸‹è½½ MacOS ç‰ˆæœ¬çš„å®‰è£…åŒ… æ‰“å¼€ä¸‹è½½çš„ .dmg æ–‡ä»¶ï¼Œå°† Tailscale æ‹–å…¥åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹ ç¬¬äºŒæ­¥ï¼šç™»å½•å’Œé…ç½® # åœ¨ä¸¤å°è®¾å¤‡ä¸Šå¯åŠ¨ Tailscale ç‚¹å‡»èœå•æ çš„ Tailscale å›¾æ ‡ ä½¿ç”¨ç›¸åŒçš„è´¦å·ç™»å½• ç™»å½•æˆåŠŸåï¼ŒTailscale ä¼šè‡ªåŠ¨ä¸ºè®¾å¤‡åˆ†é… IP åœ°å€ ç‚¹å‡»èœå•æ å›¾æ ‡å¯ä»¥æŸ¥çœ‹åˆ†é…çš„ IP åœ°å€ï¼ˆé€šå¸¸æ ¼å¼ä¸º 100.xx.xx.xxï¼‰ ç¬¬ä¸‰æ­¥ï¼šå¼€å¯è¿œç¨‹è®¿é—® #åœ¨è¢«æ§åˆ¶çš„ MacOS è®¾å¤‡ä¸Šï¼š\næ‰“å¼€ç³»ç»Ÿåå¥½è®¾ç½® é€‰æ‹©\u0026quot;å…±äº«\u0026quot; å‹¾é€‰\u0026quot;è¿œç¨‹ç®¡ç†\u0026quot;æˆ–\u0026quot;å±å¹•å…±äº«\u0026quot; é…ç½®è®¿é—®æƒé™ï¼Œå¯ä»¥é€‰æ‹©ï¼š å…è®¸æ‰€æœ‰ç”¨æˆ· ä»…å…è®¸ç‰¹å®šç”¨æˆ· ç¬¬å››æ­¥ï¼šå»ºç«‹è¿æ¥ #åœ¨æ§åˆ¶ç«¯ MacOS è®¾å¤‡ä¸Šï¼š\næ‰“å¼€è®¿è¾¾ï¼ˆFinderï¼‰ åœ¨èœå•æ é€‰æ‹©\u0026quot;å‰å¾€\u0026quot; â†’ \u0026ldquo;è¿æ¥æœåŠ¡å™¨\u0026rdquo;ï¼ˆæˆ–æŒ‰ä¸‹ Command + Kï¼‰ åœ¨æœåŠ¡å™¨åœ°å€æ è¾“å…¥ï¼švnc://100.","title":"ä½¿ç”¨ Tailscale å®ç° MacOS è®¾å¤‡è¿œç¨‹è¿æ¥æ•™ç¨‹"},{"content":"é—®é¢˜ç°è±¡ #åœ¨å¤šè¿›ç¨‹å…±äº«å†…å­˜é€šä¿¡ä¸­ï¼Œå‘ç°è¯»å–è¿›ç¨‹å‡ºç°å¼‚å¸¸ï¼š\nå†™å…¥è¿›ç¨‹ï¼ˆçº¿ç¨‹3002707ï¼‰æ­£å¸¸å†™å…¥æ•°æ®\nè¯»å–è¿›ç¨‹ï¼ˆçº¿ç¨‹3002791ï¼‰å¡åœ¨å›ºå®šä½ç½®ï¼š\npage: 0 write_pos: 134209160 read_pos: 134199368 é—®é¢˜å®šä½è¿‡ç¨‹ #1. åˆæ­¥åˆ†æ #é¦–å…ˆè§‚å¯Ÿåˆ°ä¸€ä¸ªå…³é”®ç°è±¡ï¼š\nBinanceçš„è¯»å†™æ­£å¸¸ Bitgetçš„è¯»å–å¡åœ¨å›ºå®šä½ç½® ä¸¤ä¸ªäº¤æ˜“æ‰€ä½¿ç”¨ç›¸åŒçš„å…±äº«å†…å­˜æœºåˆ¶ 2. ä»£ç åˆ†æ #æ£€æŸ¥å…±äº«å†…å­˜ç®¡ç†çš„æ ¸å¿ƒç±»ï¼š\nå†™å…¥æœºåˆ¶ï¼š template\u0026lt;typename T\u0026gt; bool write(const TypedFrame\u0026lt;T\u0026gt;\u0026amp; frame) { // ... if (write_pos + frame_size \u0026gt; page_size_) { switchToNextPage(); write_pos = current_write_pos_.load(std::memory_order_relaxed); continue; } // ... std::atomic\u0026lt;size_t\u0026gt;* shared_write_pos = reinterpret_cast\u0026lt;std::atomic\u0026lt;size_t\u0026gt;*\u0026gt;(current_page_-\u0026gt;getData()); shared_write_pos-\u0026gt;store(write_pos + frame_size, std::memory_order_release); } é¡µé¢åˆ‡æ¢ï¼š void Journal::switchToNextPage() { current_page_ = page_engine_-\u0026gt;getNextPage(); current_write_pos_.store(0, std::memory_order_relaxed); } Page* PageEngine::getNextPage() { current_page_index_++; if (current_page_index_ \u0026gt;= pages_.size()) { addNewPage(); } return pages_[current_page_index_].get(); } 3. å…³é”®å‘ç° #é€šè¿‡åˆ†æå‘ç°ï¼š\nå†™å…¥ä½ç½®ï¼ˆwrite_posï¼‰æ­£ç¡®å­˜å‚¨åœ¨å…±äº«å†…å­˜ä¸­ ä½†é¡µé¢ç´¢å¼•ï¼ˆcurrent_page_index_ï¼‰æ˜¯è¿›ç¨‹å†…å˜é‡ å¯¼è‡´è¯»å–è¿›ç¨‹æ— æ³•æ„ŸçŸ¥é¡µé¢åˆ‡æ¢ æ ¹æœ¬åŸå›  # è¿›ç¨‹éš”ç¦»ï¼š æ¯ä¸ªè¿›ç¨‹æœ‰è‡ªå·±çš„PageEngineå®ä¾‹ current_page_index_æ˜¯è¿›ç¨‹å†…å­˜å˜é‡ å†™è¿›ç¨‹åˆ‡æ¢é¡µé¢æ—¶ï¼Œè¯»è¿›ç¨‹æ— æ³•æ„ŸçŸ¥ å…±äº«æœºåˆ¶ä¸å®Œæ•´ï¼š åªå…±äº«äº†å†™å…¥ä½ç½®ï¼ˆwrite_posï¼‰ æœªå…±äº«é¡µé¢åˆ‡æ¢ä¿¡æ¯ è§£å†³æ–¹æ¡ˆ # è®¾è®¡æ€è·¯\nè®¾è®¡å…±äº«æ§åˆ¶ç»“æ„ç®¡ç†é¡µé¢çŠ¶æ€ åœ¨å…±äº«å†…å­˜ä¸­ç»´æŠ¤å®Œæ•´çš„é¡µé¢ä¿¡æ¯ å®ç°é¡µé¢åˆ‡æ¢çš„è¿›ç¨‹é—´åŒæ­¥ å…·ä½“å®ç° é¦–å…ˆï¼Œè®¾è®¡å…±äº«æ§åˆ¶ç»“æ„ï¼š\nstruct alignas(64) SharedPageControl { std::atomic\u0026lt;uint64_t\u0026gt; current_page_index; // å½“å‰é¡µç´¢å¼• std::atomic\u0026lt;uint64_t\u0026gt; total_pages; // æ€»é¡µæ•° std::atomic\u0026lt;uint64_t\u0026gt; write_pos; // å†™å…¥ä½ç½® char padding[40]; // ä¿æŒç¼“å­˜è¡Œå¯¹é½ }; æ›´æ–°é¡µé¢åˆ‡æ¢é€»è¾‘ï¼š\nvoid Journal::switchToNextPage() { if (!is_writer_) return; auto* control = current_page_-\u0026gt;getSharedControl(); size_t new_page_index = control-\u0026gt;current_page_index.load(std::memory_order_relaxed) + 1; // æ›´æ–°å…±äº«æ§åˆ¶ä¿¡æ¯ control-\u0026gt;current_page_index.store(new_page_index, std::memory_order_release); control-\u0026gt;write_pos.store(sizeof(SharedPageControl), std::memory_order_release); // æ›´æ–°æœ¬åœ°çŠ¶æ€ current_page_ = page_engine_-\u0026gt;getNextPage(); current_write_pos_.store(sizeof(SharedPageControl), std::memory_order_relaxed); } 3. ä¼˜åŒ–è€ƒè™‘ # æ€§èƒ½ä¼˜åŒ–ï¼š ä½¿ç”¨64å­—èŠ‚å¯¹é½é¿å…false sharing æœ€å°åŒ–åŸå­æ“ä½œæ¬¡æ•° ä¿æŒæ— é”è®¾è®¡ å¯é æ€§ä¿è¯ï¼š ä½¿ç”¨åŸå­æ“ä½œç¡®ä¿çº¿ç¨‹å®‰å…¨ æ­£ç¡®çš„å†…å­˜åºä¿è¯å¯è§æ€§ å®Œæ•´çš„é”™è¯¯å¤„ç† æ–¹æ¡ˆå®ç°è¦ç‚¹ # å…±äº«æ§åˆ¶ä¿¡æ¯ç®¡ç†\nåœ¨å…±äº«å†…å­˜çš„èµ·å§‹ä½ç½®æ”¾ç½®æ§åˆ¶ç»“æ„ ä½¿ç”¨åŸå­æ“ä½œä¿è¯æ›´æ–°çš„å¯è§æ€§ é€šè¿‡å†…å­˜å¯¹é½ä¼˜åŒ–æ€§èƒ½ é¡µé¢åˆ‡æ¢åŒæ­¥\nå†™è¿›ç¨‹è´Ÿè´£æ›´æ–°é¡µé¢çŠ¶æ€ è¯»è¿›ç¨‹é€šè¿‡å…±äº«æ§åˆ¶ä¿¡æ¯æ„ŸçŸ¥é¡µé¢åˆ‡æ¢ ä¿è¯é¡µé¢ä¿¡æ¯çš„ä¸€è‡´æ€§ å†…å­˜å¸ƒå±€ä¼˜åŒ–\næ§åˆ¶ä¿¡æ¯å’Œæ•°æ®åŒºåŸŸåˆ†ç¦» ä½¿ç”¨ç¼“å­˜è¡Œå¯¹é½é¿å…false sharing ä¿æŒé«˜æ•ˆçš„å†…å­˜è®¿é—® æŠ€æœ¯ç»éªŒæ€»ç»“ # å¤šè¿›ç¨‹é€šä¿¡è®¾è®¡åŸåˆ™\næ§åˆ¶ä¿¡æ¯å¿…é¡»åœ¨è¿›ç¨‹é—´å…±äº« ä½¿ç”¨åŸå­æ“ä½œä¿è¯å¯è§æ€§ æ³¨æ„å†…å­˜å¸ƒå±€å’Œæ€§èƒ½ä¼˜åŒ– é—®é¢˜è¯Šæ–­æ–¹æ³•\nè§‚å¯Ÿå¼‚å¸¸ç°è±¡çš„å…±æ€§å’Œå·®å¼‚ å¯¹æ¯”æ­£å¸¸å’Œå¼‚å¸¸æ¡ˆä¾‹ è¿½è¸ªåˆ°æ ¹æœ¬åŸå›  ä»£ç å®ç°å»ºè®®\né‡è§†å…±äº«çŠ¶æ€çš„åŒæ­¥ åˆç†ä½¿ç”¨å†…å­˜å¯¹é½ æ³¨æ„æ€§èƒ½å’Œæ­£ç¡®æ€§çš„å¹³è¡¡ æœ€ä½³å®è·µè¦ç‚¹\nè®¾è®¡æ—¶è€ƒè™‘å¤šè¿›ç¨‹åœºæ™¯ å……åˆ†æµ‹è¯•è¾¹ç•Œæ¡ä»¶ ä¿æŒä»£ç çš„å¯ç»´æŠ¤æ€§ è¿™ä¸ªæ¡ˆä¾‹å±•ç¤ºäº†åœ¨é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­ä¸€ä¸ªå…¸å‹çš„å¤šè¿›ç¨‹é€šä¿¡é—®é¢˜çš„å®Œæ•´è§£å†³è¿‡ç¨‹ã€‚å®ƒå¼ºè°ƒäº†åœ¨å…±äº«å†…å­˜é€šä¿¡ä¸­æ­£ç¡®ç®¡ç†å…±äº«çŠ¶æ€çš„é‡è¦æ€§ï¼Œä»¥åŠå¦‚ä½•é€šè¿‡ç³»ç»Ÿçš„åˆ†æå’Œè®¾è®¡æ¥è§£å†³å¤æ‚çš„å¹¶å‘é—®é¢˜ã€‚è¿™äº›ç»éªŒå¯¹äºæ„å»ºç¨³å®šã€é«˜æ•ˆçš„å¤šè¿›ç¨‹ç³»ç»Ÿå…·æœ‰é‡è¦çš„å‚è€ƒä»·å€¼ã€‚\n","date":"17 January 2025","permalink":"/blog/2025-06-24-fix_shared_page_position/","section":"Blog","summary":"é—®é¢˜ç°è±¡ #åœ¨å¤šè¿›ç¨‹å…±äº«å†…å­˜é€šä¿¡ä¸­ï¼Œå‘ç°è¯»å–è¿›ç¨‹å‡ºç°å¼‚å¸¸ï¼š\nå†™å…¥è¿›ç¨‹ï¼ˆçº¿ç¨‹3002707ï¼‰æ­£å¸¸å†™å…¥æ•°æ®\nè¯»å–è¿›ç¨‹ï¼ˆçº¿ç¨‹3002791ï¼‰å¡åœ¨å›ºå®šä½ç½®ï¼š\npage: 0 write_pos: 134209160 read_pos: 134199368 é—®é¢˜å®šä½è¿‡ç¨‹ #1. åˆæ­¥åˆ†æ #é¦–å…ˆè§‚å¯Ÿåˆ°ä¸€ä¸ªå…³é”®ç°è±¡ï¼š\nBinanceçš„è¯»å†™æ­£å¸¸ Bitgetçš„è¯»å–å¡åœ¨å›ºå®šä½ç½® ä¸¤ä¸ªäº¤æ˜“æ‰€ä½¿ç”¨ç›¸åŒçš„å…±äº«å†…å­˜æœºåˆ¶ 2. ä»£ç åˆ†æ #æ£€æŸ¥å…±äº«å†…å­˜ç®¡ç†çš„æ ¸å¿ƒç±»ï¼š\nå†™å…¥æœºåˆ¶ï¼š template\u0026lt;typename T\u0026gt; bool write(const TypedFrame\u0026lt;T\u0026gt;\u0026amp; frame) { // ... if (write_pos + frame_size \u0026gt; page_size_) { switchToNextPage(); write_pos = current_write_pos_.load(std::memory_order_relaxed); continue; } // ... std::atomic\u0026lt;size_t\u0026gt;* shared_write_pos = reinterpret_cast\u0026lt;std::atomic\u0026lt;size_t\u0026gt;*\u0026gt;(current_page_-\u0026gt;getData()); shared_write_pos-\u0026gt;store(write_pos + frame_size, std::memory_order_release); } é¡µé¢åˆ‡æ¢ï¼š void Journal::switchToNextPage() { current_page_ = page_engine_-\u0026gt;getNextPage(); current_write_pos_.store(0, std::memory_order_relaxed); } Page* PageEngine::getNextPage() { current_page_index_++; if (current_page_index_ \u0026gt;= pages_.","title":"å…±äº«å†…å­˜å¤šè¿›ç¨‹é€šä¿¡ä¸­çš„é¡µé¢åˆ‡æ¢åŒæ­¥é—®é¢˜åˆ†æä¸è§£å†³"},{"content":"Solanaé“¾ä¸Šäº¤æ˜“ç›‘æ§æœ€ä½³å®è·µï¼šä»logsSubscribeåˆ°å…¨æ–¹ä½ç›‘æ§ #èƒŒæ™¯ä»‹ç» #åœ¨Solanaé“¾ä¸Šå¼€å‘ä¸­ï¼Œå®æ—¶ç›‘æ§ç‰¹å®šè´¦æˆ·çš„äº¤æ˜“æ´»åŠ¨æ˜¯ä¸€ä¸ªå¸¸è§éœ€æ±‚ï¼Œç‰¹åˆ«æ˜¯åœ¨æ„å»ºè·Ÿå•æœºå™¨äººè¿™ç±»å¯¹æ—¶æ•ˆæ€§è¦æ±‚è¾ƒé«˜çš„åº”ç”¨åœºæ™¯ä¸­ã€‚æœ€åˆï¼Œæˆ‘ä»¬å¯èƒ½ä¼šæƒ³åˆ°ä½¿ç”¨Solanaæä¾›çš„logsSubscribe WebSocket APIæ¥å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œå› ä¸ºå®ƒçœ‹èµ·æ¥æ˜¯æœ€ç›´æ¥çš„è§£å†³æ–¹æ¡ˆã€‚ç„¶è€Œï¼Œåœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬å‘ç°è¿™ç§æ–¹æ¡ˆå­˜åœ¨ä¸€äº›é™åˆ¶å’Œé—®é¢˜ã€‚\né—®é¢˜å‘ç° #åœ¨ä½¿ç”¨logsSubscribeè¿›è¡Œè´¦æˆ·ç›‘æ§æ—¶ï¼Œæˆ‘ä»¬å‘ç°ä¸€ä¸ªå…³é”®é—®é¢˜ï¼šæŸäº›ç¡®å®å‘ç”Ÿçš„äº¤æ˜“å¹¶æ²¡æœ‰è¢«æˆ‘ä»¬çš„ç›‘æ§ç³»ç»Ÿæ•è·åˆ°ã€‚è¿™ä¸ªé—®é¢˜çš„å‘ç°ä¿ƒä½¿æˆ‘ä»¬æ·±å…¥ç ”ç©¶Solanaçš„äº¤æ˜“æ—¥å¿—æœºåˆ¶ï¼Œå¹¶æœ€ç»ˆè®¾è®¡äº†ä¸€ä¸ªæ›´å…¨é¢çš„ç›‘æ§æ–¹æ¡ˆã€‚\nä¸ºä»€ä¹ˆä¼šé—æ¼äº¤æ˜“ï¼Ÿ # æ—¥å¿—è®°å½•æœºåˆ¶çš„å±€é™æ€§\nç¨‹åºå¯èƒ½ä¸ä¼šåœ¨æ—¥å¿—ä¸­æ˜ç¡®è®°å½•æ‰€æœ‰æ¶‰åŠçš„è´¦æˆ·åœ°å€ äº¤æ˜“å¯èƒ½ä½¿ç”¨äº†PDA(Program Derived Address)æˆ–å…¶ä»–æ´¾ç”Ÿåœ°å€ æŸäº›DEXé‡‡ç”¨å†…éƒ¨è´¦æˆ·æ˜ å°„ï¼Œè€Œä¸æ˜¯ç›´æ¥è®°å½•ç”¨æˆ·åœ°å€ mentionsè¿‡æ»¤å™¨çš„é™åˆ¶\nåªèƒ½æ•è·åœ¨æ—¥å¿—ä¸­æ˜ç¡®æåˆ°ç›®æ ‡åœ°å€çš„äº¤æ˜“ æ— æ³•æ•è·é€šè¿‡é—´æ¥æ–¹å¼å½±å“ç›®æ ‡è´¦æˆ·çš„äº¤æ˜“ è§£å†³æ–¹æ¡ˆ #é’ˆå¯¹ä¸Šè¿°é—®é¢˜ï¼Œæˆ‘ä»¬è®¾è®¡äº†ä¸€ä¸ªå¤šç»´åº¦ç›‘æ§æ–¹æ¡ˆï¼Œé€šè¿‡ç»„åˆå¤šç§è®¢é˜…æ–¹å¼æ¥ç¡®ä¿ä¸ä¼šé—æ¼ä»»ä½•ç›¸å…³äº¤æ˜“ã€‚\n1. ä¸‰é‡è®¢é˜…æœºåˆ¶ #pub struct EnhancedTradeWatcher { target_account: Pubkey, ws_client: WebSocketClient, } impl EnhancedTradeWatcher { async fn setup_comprehensive_monitoring(\u0026amp;mut self) -\u0026gt; Result\u0026lt;()\u0026gt; { // 1. logsSubscribe - æ•è·æ˜¾å¼æåŠ let logs_sub = json!({ \u0026#34;jsonrpc\u0026#34;: \u0026#34;2.0\u0026#34;, \u0026#34;method\u0026#34;: \u0026#34;logsSubscribe\u0026#34;, \u0026#34;params\u0026#34;: [ { \u0026#34;mentions\u0026#34;: [self.target_account.to_string()], }, { \u0026#34;commitment\u0026#34;: \u0026#34;processed\u0026#34; } ] }); // 2. programSubscribe - ç›‘æ§DEXç¨‹åº let dex_program_sub = json!({ \u0026#34;jsonrpc\u0026#34;: \u0026#34;2.0\u0026#34;, \u0026#34;method\u0026#34;: \u0026#34;programSubscribe\u0026#34;, \u0026#34;params\u0026#34;: [ DEX_PROGRAM_ID, { \u0026#34;encoding\u0026#34;: \u0026#34;jsonParsed\u0026#34;, \u0026#34;commitment\u0026#34;: \u0026#34;processed\u0026#34; } ] }); // 3. accountSubscribe - ç›‘æ§è´¦æˆ·å˜æ›´ let account_sub = json!({ \u0026#34;jsonrpc\u0026#34;: \u0026#34;2.0\u0026#34;, \u0026#34;method\u0026#34;: \u0026#34;accountSubscribe\u0026#34;, \u0026#34;params\u0026#34;: [ self.target_account.to_string(), { \u0026#34;encoding\u0026#34;: \u0026#34;jsonParsed\u0026#34;, \u0026#34;commitment\u0026#34;: \u0026#34;processed\u0026#34; } ] }); // å‘é€æ‰€æœ‰è®¢é˜…è¯·æ±‚ self.ws_client.send(logs_sub).await?; self.ws_client.send(dex_program_sub).await?; self.ws_client.send(account_sub).await?; } } 2. äº¤æ˜“å»é‡æœºåˆ¶ #ä¸ºäº†é¿å…å¤šä¸ªè®¢é˜…æ¸ é“å¯¼è‡´çš„é‡å¤å¤„ç†ï¼Œæˆ‘ä»¬å®ç°äº†åŸºäºäº¤æ˜“ç­¾åçš„å»é‡æœºåˆ¶ï¼š\nasync fn handle_all_events(\u0026amp;mut self) -\u0026gt; Result\u0026lt;()\u0026gt; { let mut transactions_seen = HashSet::new(); while let Some(event) = self.ws_client.next_message().await? { if !transactions_seen.contains(\u0026amp;event.signature) { self.process_transaction(\u0026amp;event).await?; transactions_seen.insert(event.signature); } } Ok(()) } 3. ç›¸å…³è´¦æˆ·æ£€æŸ¥ #ä¸ºäº†ç¡®ä¿æ•è·æ‰€æœ‰ç›¸å…³äº¤æ˜“ï¼Œæˆ‘ä»¬å®ç°äº†å…¨é¢çš„è´¦æˆ·å…³è”æ£€æŸ¥ï¼š\nfn check_related_accounts(\u0026amp;self, program_info: \u0026amp;ProgramInfo) -\u0026gt; bool { // æ£€æŸ¥Tokenè´¦æˆ· let token_accounts = self.get_associated_token_accounts(\u0026amp;self.target_account); // æ£€æŸ¥OpenOrdersè´¦æˆ· let open_orders = self.get_open_orders_accounts(\u0026amp;self.target_account); // æ£€æŸ¥PDA let pdas = self.get_related_pdas(\u0026amp;self.target_account); program_info.accounts.iter().any(|acc| token_accounts.contains(acc) || open_orders.contains(acc) || pdas.contains(acc) ) } ä¸ºä»€ä¹ˆé€‰æ‹©è¿™ç§æ–¹æ¡ˆï¼Ÿ # å®Œæ•´æ€§ä¿è¯\nå¤šç»´åº¦ç›‘æ§ç¡®ä¿ä¸ä¼šé—æ¼ä»»ä½•ç›¸å…³äº¤æ˜“ é€šè¿‡æ£€æŸ¥å…³è”è´¦æˆ·æ•è·é—´æ¥äº¤æ˜“ æ€§èƒ½ä¼˜åŒ–\nä½¿ç”¨ç¼“å­˜å‡å°‘RPCè°ƒç”¨ å®ç°äº¤æ˜“å»é‡é¿å…é‡å¤å¤„ç† é‡‡ç”¨processedæäº¤çº§åˆ«è·å¾—æœ€ä½å»¶è¿Ÿ å¯æ‰©å±•æ€§\næ–¹æ¡ˆè®¾è®¡æ”¯æŒæ·»åŠ æ–°çš„DEXç›‘æ§ å¯ä»¥æ ¹æ®å…·ä½“éœ€æ±‚è°ƒæ•´ç›‘æ§ç­–ç•¥ å¯é æ€§\nå¤šæ¸ é“æ•°æ®æºæä¾›æ•°æ®å†—ä½™ é™ä½å•ç‚¹æ•…éšœé£é™© æ€§èƒ½è€ƒè™‘ #è™½ç„¶è¿™ç§å¤šç»´åº¦ç›‘æ§æ–¹æ¡ˆä¼šå¸¦æ¥ä¸€äº›é¢å¤–çš„ç³»ç»Ÿå¼€é”€ï¼Œä½†åœ¨è·Ÿå•åœºæ™¯ä¸­ï¼Œå‡†ç¡®æ€§å’Œå®Œæ•´æ€§çš„é‡è¦æ€§è¿œå¤§äºå°‘é‡çš„æ€§èƒ½æŸè€—ã€‚ä¸ºäº†ä¼˜åŒ–æ€§èƒ½ï¼Œæˆ‘ä»¬å®ç°äº†ä»¥ä¸‹æœºåˆ¶ï¼š\nstruct AccountCache { token_accounts: LruCache\u0026lt;Pubkey, Vec\u0026lt;Pubkey\u0026gt;\u0026gt;, open_orders: LruCache\u0026lt;Pubkey, Vec\u0026lt;Pubkey\u0026gt;\u0026gt;, last_update: HashMap\u0026lt;Pubkey, Instant\u0026gt;, } ç»“è®º #åœ¨Solanaé“¾ä¸Šå¼€å‘ä¸­ï¼Œå•ä¸€çš„ç›‘æ§æ–¹å¼å¾€å¾€æ— æ³•æ»¡è¶³å¤æ‚ä¸šåŠ¡åœºæ™¯çš„éœ€æ±‚ã€‚é€šè¿‡ç»“åˆå¤šç§è®¢é˜…æ–¹å¼ï¼Œå¹¶é…åˆåˆç†çš„ç¼“å­˜ç­–ç•¥å’Œå»é‡æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥æ„å»ºä¸€ä¸ªæ—¢å¯é åˆé«˜æ•ˆçš„äº¤æ˜“ç›‘æ§ç³»ç»Ÿã€‚è¿™ä¸ªæ–¹æ¡ˆè™½ç„¶å®ç°è¾ƒä¸ºå¤æ‚ï¼Œä½†èƒ½å¤Ÿæä¾›æ›´å¥½çš„å¯é æ€§å’Œå®Œæ•´æ€§ä¿è¯ï¼Œç‰¹åˆ«é€‚åˆå¯¹å®æ—¶æ€§å’Œå‡†ç¡®æ€§è¦æ±‚è¾ƒé«˜çš„è·Ÿå•åœºæ™¯ã€‚\næœªæ¥å±•æœ› # æ”¯æŒæ›´å¤šDEXåè®® ä¼˜åŒ–ç¼“å­˜ç­–ç•¥ æ·»åŠ æ›´å¤šæ€§èƒ½ç›‘æ§æŒ‡æ ‡ å®ç°è‡ªåŠ¨åŒ–å¤±è´¥é‡è¯•æœºåˆ¶ å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¤Ÿå¸®åŠ©å¤§å®¶åœ¨å®ç°Solanaé“¾ä¸Šç›‘æ§æ—¶é¿å…ä¸€äº›å¸¸è§é™·é˜±ï¼Œæ„å»ºæ›´å¯é çš„ç›‘æ§ç³»ç»Ÿã€‚\n","date":"20 December 2024","permalink":"/blog/2025-06-24-solana_monitoring_system/","section":"Blog","summary":"Solanaé“¾ä¸Šäº¤æ˜“ç›‘æ§æœ€ä½³å®è·µï¼šä»logsSubscribeåˆ°å…¨æ–¹ä½ç›‘æ§ #èƒŒæ™¯ä»‹ç» #åœ¨Solanaé“¾ä¸Šå¼€å‘ä¸­ï¼Œå®æ—¶ç›‘æ§ç‰¹å®šè´¦æˆ·çš„äº¤æ˜“æ´»åŠ¨æ˜¯ä¸€ä¸ªå¸¸è§éœ€æ±‚ï¼Œç‰¹åˆ«æ˜¯åœ¨æ„å»ºè·Ÿå•æœºå™¨äººè¿™ç±»å¯¹æ—¶æ•ˆæ€§è¦æ±‚è¾ƒé«˜çš„åº”ç”¨åœºæ™¯ä¸­ã€‚æœ€åˆï¼Œæˆ‘ä»¬å¯èƒ½ä¼šæƒ³åˆ°ä½¿ç”¨Solanaæä¾›çš„logsSubscribe WebSocket APIæ¥å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œå› ä¸ºå®ƒçœ‹èµ·æ¥æ˜¯æœ€ç›´æ¥çš„è§£å†³æ–¹æ¡ˆã€‚ç„¶è€Œï¼Œåœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬å‘ç°è¿™ç§æ–¹æ¡ˆå­˜åœ¨ä¸€äº›é™åˆ¶å’Œé—®é¢˜ã€‚\né—®é¢˜å‘ç° #åœ¨ä½¿ç”¨logsSubscribeè¿›è¡Œè´¦æˆ·ç›‘æ§æ—¶ï¼Œæˆ‘ä»¬å‘ç°ä¸€ä¸ªå…³é”®é—®é¢˜ï¼šæŸäº›ç¡®å®å‘ç”Ÿçš„äº¤æ˜“å¹¶æ²¡æœ‰è¢«æˆ‘ä»¬çš„ç›‘æ§ç³»ç»Ÿæ•è·åˆ°ã€‚è¿™ä¸ªé—®é¢˜çš„å‘ç°ä¿ƒä½¿æˆ‘ä»¬æ·±å…¥ç ”ç©¶Solanaçš„äº¤æ˜“æ—¥å¿—æœºåˆ¶ï¼Œå¹¶æœ€ç»ˆè®¾è®¡äº†ä¸€ä¸ªæ›´å…¨é¢çš„ç›‘æ§æ–¹æ¡ˆã€‚\nä¸ºä»€ä¹ˆä¼šé—æ¼äº¤æ˜“ï¼Ÿ # æ—¥å¿—è®°å½•æœºåˆ¶çš„å±€é™æ€§\nç¨‹åºå¯èƒ½ä¸ä¼šåœ¨æ—¥å¿—ä¸­æ˜ç¡®è®°å½•æ‰€æœ‰æ¶‰åŠçš„è´¦æˆ·åœ°å€ äº¤æ˜“å¯èƒ½ä½¿ç”¨äº†PDA(Program Derived Address)æˆ–å…¶ä»–æ´¾ç”Ÿåœ°å€ æŸäº›DEXé‡‡ç”¨å†…éƒ¨è´¦æˆ·æ˜ å°„ï¼Œè€Œä¸æ˜¯ç›´æ¥è®°å½•ç”¨æˆ·åœ°å€ mentionsè¿‡æ»¤å™¨çš„é™åˆ¶\nåªèƒ½æ•è·åœ¨æ—¥å¿—ä¸­æ˜ç¡®æåˆ°ç›®æ ‡åœ°å€çš„äº¤æ˜“ æ— æ³•æ•è·é€šè¿‡é—´æ¥æ–¹å¼å½±å“ç›®æ ‡è´¦æˆ·çš„äº¤æ˜“ è§£å†³æ–¹æ¡ˆ #é’ˆå¯¹ä¸Šè¿°é—®é¢˜ï¼Œæˆ‘ä»¬è®¾è®¡äº†ä¸€ä¸ªå¤šç»´åº¦ç›‘æ§æ–¹æ¡ˆï¼Œé€šè¿‡ç»„åˆå¤šç§è®¢é˜…æ–¹å¼æ¥ç¡®ä¿ä¸ä¼šé—æ¼ä»»ä½•ç›¸å…³äº¤æ˜“ã€‚\n1. ä¸‰é‡è®¢é˜…æœºåˆ¶ #pub struct EnhancedTradeWatcher { target_account: Pubkey, ws_client: WebSocketClient, } impl EnhancedTradeWatcher { async fn setup_comprehensive_monitoring(\u0026amp;mut self) -\u0026gt; Result\u0026lt;()\u0026gt; { // 1. logsSubscribe - æ•è·æ˜¾å¼æåŠ let logs_sub = json!({ \u0026#34;jsonrpc\u0026#34;: \u0026#34;2.0\u0026#34;, \u0026#34;method\u0026#34;: \u0026#34;logsSubscribe\u0026#34;, \u0026#34;params\u0026#34;: [ { \u0026#34;mentions\u0026#34;: [self.target_account.to_string()], }, { \u0026#34;commitment\u0026#34;: \u0026#34;processed\u0026#34; } ] }); // 2. programSubscribe - ç›‘æ§DEXç¨‹åº let dex_program_sub = json!","title":"Solana_monitor"},{"content":"Solanaé“¾ä¸Šäº¤æ˜“ç›‘æ§æŠ€æœ¯åˆ†æ #1. Solana DEX äº¤æ˜“å½¢å¼ #1.1 ç›´æ¥ DEX äº¤æ˜“ #ç”¨æˆ·ç›´æ¥ä¸ DEX åˆçº¦äº¤äº’ï¼Œäº¤æ˜“æµç¨‹ç®€å•ç›´æ¥ã€‚\nç”¨æˆ·é’±åŒ… -\u0026gt; DEXç¨‹åº (å¦‚Raydium/Orca) -\u0026gt; Token Program ç‰¹ç‚¹ï¼š\näº¤æ˜“æ—¥å¿—ç®€æ´ï¼Œä¸»è¦åŒ…å«å•ä¸ª DEX ç¨‹åºçš„è°ƒç”¨ å®¹æ˜“è¯†åˆ«äº¤æ˜“å¹³å°å’Œäº¤æ˜“å¯¹ Token Program çš„ transfer æŒ‡ä»¤è¾ƒå°‘ 1.2 èšåˆå™¨äº¤æ˜“ï¼ˆJupiterï¼‰ #é€šè¿‡èšåˆå™¨è·¯ç”±åˆ°å•ä¸ªæˆ–å¤šä¸ª DEXã€‚\nç”¨æˆ·é’±åŒ… -\u0026gt; Jupiter -\u0026gt; DEX1/DEX2/... -\u0026gt; Token Program ç‰¹ç‚¹ï¼š\nåŒ…å« Jupiter åˆçº¦è°ƒç”¨ å¯èƒ½æ¶‰åŠå¤šä¸ª DEX äº¤æ˜“æ—¥å¿—è¾ƒé•¿ï¼ŒåŒ…å«å¤šä¸ªå†…éƒ¨æŒ‡ä»¤ å¯èƒ½æœ‰å¤æ‚çš„ä»£å¸äº¤æ¢è·¯å¾„ 1.3 æ™ºèƒ½è·¯ç”±äº¤æ˜“ #ä¸€ç¬”äº¤æ˜“é€šè¿‡å¤šä¸ª DEX ä¸²è”å®Œæˆã€‚\nç”¨æˆ·é’±åŒ… -\u0026gt; èšåˆå™¨ -\u0026gt; DEX1 -\u0026gt; DEX2 -\u0026gt; DEX3 -\u0026gt; Token Program ç‰¹ç‚¹ï¼š\näº¤æ˜“è·¯å¾„æœ€å¤æ‚ æ¶‰åŠå¤šæ¬¡ä»£å¸äº¤æ¢ ç›®çš„æ˜¯è·å¾—æœ€ä¼˜ä»·æ ¼ åŒ…å«å¤šä¸ª Token Program çš„ transfer æŒ‡ä»¤ 2. Solana é“¾ä¸Šç›‘æ§åŸç† #2.1 ä¸ºä»€ä¹ˆå¯ä»¥ç›‘æ§ç›®æ ‡è´¦æˆ· #Solana é“¾ä¸Šç›‘æ§çš„å®ç°åŸºäºä»¥ä¸‹å‡ ä¸ªå…³é”®ç‰¹æ€§ï¼š\nè´¦æˆ·æ¨¡å‹ Solana ä½¿ç”¨è´¦æˆ·æ¨¡å‹è€Œä¸æ˜¯ UTXO æ¨¡å‹ï¼š - æ¯ä¸ªè´¦æˆ·éƒ½æœ‰å”¯ä¸€çš„åœ°å€ - æ‰€æœ‰äº¤æ˜“éƒ½ä¼šæ¶‰åŠè´¦æˆ·çš„çŠ¶æ€å˜æ›´ - äº¤æ˜“æ—¥å¿—ä¼šè®°å½•æ‰€æœ‰æ¶‰åŠçš„è´¦æˆ·åœ°å€ äº¤æ˜“æ—¥å¿—ç³»ç»Ÿ // äº¤æ˜“æ—¥å¿—åŒ…å«ï¼š - æ‰€æœ‰ç¨‹åºè°ƒç”¨ (Program invoke) - è´¦æˆ·æ“ä½œè®°å½• (Instruction logs) - ä»£å¸è½¬ç§»è¯¦æƒ… (Token transfers) - é”™è¯¯ä¿¡æ¯ (å¦‚æœæœ‰) RPC è®¢é˜…æœºåˆ¶ // logsSubscribe æ”¯æŒå¤šç§è¿‡æ»¤æ–¹å¼ï¼š - mentions: æ—¥å¿—ä¸­æåˆ°çš„è´¦æˆ·åœ°å€ - dataSlice: é€‰æ‹©æ€§è·å–æ•°æ®ç‰‡æ®µ - commitment: ç¡®è®¤çº§åˆ«è®¾ç½® 2.2 ç›‘æ§åŸç†è¯¦è§£ # è´¦æˆ·æ—¥å¿—è§¦å‘æœºåˆ¶ åœ¨ Solana ä¸­ï¼Œä»¥ä¸‹æ“ä½œä¼šå¯¼è‡´è´¦æˆ·å‡ºç°åœ¨äº¤æ˜“æ—¥å¿—ä¸­ï¼š - ä½œä¸ºäº¤æ˜“ç­¾åè€… - ä½œä¸ºæŒ‡ä»¤ä¸­çš„è´¦æˆ·å‚æ•° - å‘ç”Ÿä»£å¸è½¬å…¥/è½¬å‡º - è´¦æˆ·æ•°æ®è¢«ä¿®æ”¹ ä»£å¸è´¦æˆ·å˜æ›´è¿½è¸ª // ä»£å¸è´¦æˆ·å˜æ›´ä¼šè®°å½•åœ¨ meta æ•°æ®ä¸­ pub struct TransactionMeta { pub pre_token_balances: Vec\u0026lt;TokenBalance\u0026gt;, // äº¤æ˜“å‰ä½™é¢ pub post_token_balances: Vec\u0026lt;TokenBalance\u0026gt;, // äº¤æ˜“åä½™é¢ pub log_messages: Vec\u0026lt;String\u0026gt;, // è¯¦ç»†æ—¥å¿— // ... } DEX äº¤æ˜“è·Ÿè¸ª ä¸€ä¸ª DEX äº¤æ˜“é€šå¸¸æ¶‰åŠï¼š 1. DEX ç¨‹åºè°ƒç”¨ 2. Token Program è½¬è´¦æ“ä½œ 3. æ± å­è´¦æˆ·çŠ¶æ€æ›´æ–° 4. ç”¨æˆ·ä»£å¸è´¦æˆ·ä½™é¢å˜åŒ– 2.3 æŠ€æœ¯å®ç°å…³é”®ç‚¹ # WebSocket è®¢é˜…é…ç½®è¯¦è§£ // è®¢é˜…ç‰¹å®šè´¦æˆ·çš„æ‰€æœ‰ç›¸å…³æ—¥å¿— let subscribe_config = json!({ \u0026#34;jsonrpc\u0026#34;: \u0026#34;2.0\u0026#34;, \u0026#34;id\u0026#34;: 1, \u0026#34;method\u0026#34;: \u0026#34;logsSubscribe\u0026#34;, \u0026#34;params\u0026#34;: [ { \u0026#34;mentions\u0026#34;: [target_address.to_string()], // ç›®æ ‡è´¦æˆ· \u0026#34;commitment\u0026#34;: \u0026#34;confirmed\u0026#34;, // ç¡®è®¤çº§åˆ« \u0026#34;filters\u0026#34;: [ // å¯é€‰è¿‡æ»¤å™¨ {\u0026#34;dataSize\u0026#34;: 0}, // æ•°æ®å¤§å°è¿‡æ»¤ {\u0026#34;memcmp\u0026#34;: { // å†…å­˜æ¯”è¾ƒè¿‡æ»¤ \u0026#34;offset\u0026#34;: 0, \u0026#34;bytes\u0026#34;: \u0026#34;base58_encoded_bytes\u0026#34; }} ] } ] }); äº¤æ˜“æ•°æ®ç»“æ„è§£æ pub struct ParsedTransaction { pub signature: String, pub slot: u64, pub meta: TransactionStatusMeta, pub transaction: EncodedTransaction, } impl TransactionWatcher { fn parse_transaction_data(\u0026amp;self, tx: \u0026amp;ParsedTransaction) -\u0026gt; Option\u0026lt;TradeInfo\u0026gt; { // 1. æ£€æŸ¥äº¤æ˜“æ˜¯å¦æ¶‰åŠç›®æ ‡è´¦æˆ· let involves_target = tx.meta.log_messages.iter() .any(|log| log.contains(\u0026amp;self.target_address.to_string())); if !involves_target { return None; } // 2. è§£æä»£å¸ä½™é¢å˜åŒ– let balance_changes = self.parse_token_balances( \u0026amp;tx.meta.pre_token_balances, \u0026amp;tx.meta.post_token_balances ); // 3. è¯†åˆ«äº¤æ˜“ç±»å‹å’Œæ–¹å‘ let dex_type = self.identify_dex(\u0026amp;tx.meta.log_messages); // 4. æ„å»ºäº¤æ˜“ä¿¡æ¯ Some(TradeInfo { // ... äº¤æ˜“è¯¦æƒ… }) } } ä½™é¢å˜åŒ–åˆ†æç¤ºä¾‹ fn analyze_balance_changes( \u0026amp;self, pre_balances: \u0026amp;[TokenBalance], post_balances: \u0026amp;[TokenBalance], ) -\u0026gt; Vec\u0026lt;(String, f64)\u0026gt; { pre_balances.iter() .filter(|pre| pre.owner == self.target_address.to_string()) .filter_map(|pre| { post_balances.iter() .find(|post| post.mint == pre.mint) .map(|post| { let change = post.ui_token_amount.ui_amount.unwrap_or(0.0) - pre.ui_token_amount.ui_amount.unwrap_or(0.0); (pre.mint.clone(), change) }) }) .collect() } 2.4 ç›‘æ§å¯é æ€§ä¿éšœ # æ•°æ®å®Œæ•´æ€§éªŒè¯ impl TransactionWatcher { fn validate_transaction_data(\u0026amp;self, tx: \u0026amp;ParsedTransaction) -\u0026gt; bool { // 1. éªŒè¯äº¤æ˜“çŠ¶æ€ if tx.meta.err.is_some() { return false; } // 2. éªŒè¯ä»£å¸ä½™é¢æ•°æ®å®Œæ•´æ€§ if tx.meta.pre_token_balances.is_empty() || tx.meta.post_token_balances.is_empty() { return false; } // 3. éªŒè¯æ—¥å¿—å®Œæ•´æ€§ if tx.meta.log_messages.is_empty() { return false; } true } } é”™è¯¯æ¢å¤æœºåˆ¶ async fn reconnect_websocket(\u0026amp;mut self) -\u0026gt; Result\u0026lt;()\u0026gt; { let mut retry_count = 0; let max_retries = 3; while retry_count \u0026lt; max_retries { match connect_async(\u0026amp;self.ws_url).await { Ok((ws_stream, _)) =\u0026gt; { self.ws_client = ws_stream; return Ok(()); } Err(e) =\u0026gt; { retry_count += 1; error!(\u0026#34;WebSocketé‡è¿å¤±è´¥: {}, é‡è¯• {}/{}\u0026#34;, e, retry_count, max_retries); tokio::time::sleep(Duration::from_secs(2_u64.pow(retry_count))).await; } } } Err(anyhow!(\u0026#34;WebSocketé‡è¿å¤±è´¥\u0026#34;)) } 3. æŠ€æœ¯è¦ç‚¹ #3.1 å®æ—¶æ€§ä¿éšœ # ä½¿ç”¨ WebSocket è®¢é˜…è€Œä¸æ˜¯è½®è¯¢ confirmed commitment çº§åˆ«çš„ç¡®è®¤ é”™è¯¯é‡è¯•æœºåˆ¶ 3.2 æ•°æ®å‡†ç¡®æ€§ # è§£æäº¤æ˜“å‰åçš„ä½™é¢å˜åŒ– è€ƒè™‘ä»£å¸ç²¾åº¦ éªŒè¯äº¤æ˜“çŠ¶æ€ 3.3 æ€§èƒ½ä¼˜åŒ– # ç¼“å­˜å¸¸ç”¨æ± å­ä¿¡æ¯ æ‰¹é‡å¤„ç†äº¤æ˜“ å¼‚æ­¥å¤„ç†æ¡†æ¶ 3.4 å¯é æ€§ä¿éšœ # å¤šä¸ª RPC èŠ‚ç‚¹æ•…éšœè½¬ç§» WebSocket æ–­çº¿é‡è¿ äº¤æ˜“ç¡®è®¤é‡è¯• 4. æœ€ä½³å®è·µ # RPC èŠ‚ç‚¹é€‰æ‹©\nä½¿ç”¨å¯é çš„ç§æœ‰èŠ‚ç‚¹ å‡†å¤‡å¤šä¸ªå¤‡ç”¨èŠ‚ç‚¹ å®šæœŸæ£€æŸ¥èŠ‚ç‚¹å¥åº·çŠ¶æ€ ç›‘æ§é…ç½®\nåˆç†è®¾ç½® commitment çº§åˆ« é…ç½®é€‚å½“çš„é‡è¯•å‚æ•° æ ¹æ®éœ€æ±‚è°ƒæ•´ç¼“å­˜ç­–ç•¥ é”™è¯¯å¤„ç†\nå®Œå–„çš„æ—¥å¿—è®°å½• ä¼˜é›…çš„é”™è¯¯æ¢å¤ ç›‘æ§å‘Šè­¦æœºåˆ¶ 5. æ½œåœ¨é—®é¢˜ # RPC èŠ‚ç‚¹ä¸ç¨³å®š\nè§£å†³ï¼šå®ç°èŠ‚ç‚¹æ•…éšœè½¬ç§» å®šæœŸå¥åº·æ£€æŸ¥ ä½¿ç”¨ç§æœ‰èŠ‚ç‚¹ äº¤æ˜“è§£æå¤±è´¥\nåŸå› ï¼šæ—¥å¿—æ ¼å¼å˜åŒ– è§£å†³ï¼šç‰ˆæœ¬é€‚é… å®Œå–„é”™è¯¯å¤„ç† æ€§èƒ½ç“¶é¢ˆ\nWebSocket è¿æ¥ç®¡ç† äº¤æ˜“å¤„ç†é˜Ÿåˆ— ç¼“å­˜ä¼˜åŒ– ","date":"19 December 2024","permalink":"/blog/2025-06-24-solana_blockchain_analysis/","section":"Blog","summary":"Solanaé“¾ä¸Šäº¤æ˜“ç›‘æ§æŠ€æœ¯åˆ†æ #1. Solana DEX äº¤æ˜“å½¢å¼ #1.1 ç›´æ¥ DEX äº¤æ˜“ #ç”¨æˆ·ç›´æ¥ä¸ DEX åˆçº¦äº¤äº’ï¼Œäº¤æ˜“æµç¨‹ç®€å•ç›´æ¥ã€‚\nç”¨æˆ·é’±åŒ… -\u0026gt; DEXç¨‹åº (å¦‚Raydium/Orca) -\u0026gt; Token Program ç‰¹ç‚¹ï¼š\näº¤æ˜“æ—¥å¿—ç®€æ´ï¼Œä¸»è¦åŒ…å«å•ä¸ª DEX ç¨‹åºçš„è°ƒç”¨ å®¹æ˜“è¯†åˆ«äº¤æ˜“å¹³å°å’Œäº¤æ˜“å¯¹ Token Program çš„ transfer æŒ‡ä»¤è¾ƒå°‘ 1.2 èšåˆå™¨äº¤æ˜“ï¼ˆJupiterï¼‰ #é€šè¿‡èšåˆå™¨è·¯ç”±åˆ°å•ä¸ªæˆ–å¤šä¸ª DEXã€‚\nç”¨æˆ·é’±åŒ… -\u0026gt; Jupiter -\u0026gt; DEX1/DEX2/... -\u0026gt; Token Program ç‰¹ç‚¹ï¼š\nåŒ…å« Jupiter åˆçº¦è°ƒç”¨ å¯èƒ½æ¶‰åŠå¤šä¸ª DEX äº¤æ˜“æ—¥å¿—è¾ƒé•¿ï¼ŒåŒ…å«å¤šä¸ªå†…éƒ¨æŒ‡ä»¤ å¯èƒ½æœ‰å¤æ‚çš„ä»£å¸äº¤æ¢è·¯å¾„ 1.3 æ™ºèƒ½è·¯ç”±äº¤æ˜“ #ä¸€ç¬”äº¤æ˜“é€šè¿‡å¤šä¸ª DEX ä¸²è”å®Œæˆã€‚\nç”¨æˆ·é’±åŒ… -\u0026gt; èšåˆå™¨ -\u0026gt; DEX1 -\u0026gt; DEX2 -\u0026gt; DEX3 -\u0026gt; Token Program ç‰¹ç‚¹ï¼š\näº¤æ˜“è·¯å¾„æœ€å¤æ‚ æ¶‰åŠå¤šæ¬¡ä»£å¸äº¤æ¢ ç›®çš„æ˜¯è·å¾—æœ€ä¼˜ä»·æ ¼ åŒ…å«å¤šä¸ª Token Program çš„ transfer æŒ‡ä»¤ 2.","title":"Solanaé“¾ä¸Šäº¤æ˜“ç›‘æ§æŠ€æœ¯åˆ†æ"},{"content":"ä¸€ã€æ•…éšœç°è±¡ #1.1 å•endpointæ¨¡å¼æ•…éšœ # å•ä¸ªWebSocketè¿æ¥æ—¶æ¶ˆæ¯æ¥æ”¶å®Œå…¨é˜»å¡ æ—¥å¿—æ˜¾ç¤ºæ¶ˆæ¯å¤„ç†çº¿ç¨‹å¯åŠ¨åæ— æ³•æ¥æ”¶æ–°æ¶ˆæ¯ [2024-12-12 20:31:29.455] [error] [setThreadAffinity] Error calling pthread_setaffinity_np: 22 [2024-12-12 20:31:29.697] [info] Message thread started for endpoint: OkxPublic // ä¹‹åæ— æ¶ˆæ¯æ¥æ”¶æ—¥å¿— 1.2 å¤šendpointæ¨¡å¼éƒ¨åˆ†æ­£å¸¸ # å¤šä¸ªWebSocketè¿æ¥æ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æ­£å¸¸æ¥æ”¶æ¶ˆæ¯ æ—¥å¿—æ˜¾ç¤ºæ¶ˆæ¯å¤„ç†æƒ…å†µï¼š [20:54:50.542] [thread 91374] Processing message for OkxPublic [20:54:50.640] [thread 91374] Processing message for OkxPublic // åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨æŒç»­å¤„ç†æ¶ˆæ¯ äºŒã€ç³»ç»Ÿæ¶æ„åˆ†æ #2.1 WebSocketæ¶ˆæ¯æ¥æ”¶æœºåˆ¶ #void WebSocketClient::receiveMessages(const MessageHandler\u0026amp; handler) { while (true) { try { // 1. é˜»å¡å¼æ¥æ”¶WebSocketæ¶ˆæ¯ int n = ws_-\u0026gt;receiveFrame(buffer.data(), buffer.size(), flags); // 2. åŒæ­¥å›è°ƒå¤„ç†æ¶ˆæ¯ if (n \u0026gt; 0) { handler(buffer.data(), n); } } catch (const std::exception\u0026amp; e) { break; } } } 2.2 å…³é”®æŠ€æœ¯ç‚¹ # é˜»å¡å¼WebSocketæ¥æ”¶\nreceiveFrameæ˜¯é˜»å¡è°ƒç”¨ ç›´åˆ°æ”¶åˆ°æ¶ˆæ¯æ‰ä¼šè¿”å› é«˜é¢‘äº¤æ˜“åœºæ™¯ä¸‹éœ€è¦å¿«é€Ÿå“åº” åŒæ­¥æ¶ˆæ¯å¤„ç†\næ¥æ”¶å’Œå¤„ç†åœ¨åŒä¸€çº¿ç¨‹ä¸­ å¤„ç†è€—æ—¶ä¼šç›´æ¥å½±å“ä¸‹ä¸€æ¡æ¶ˆæ¯çš„æ¥æ”¶ é€‚åˆé«˜é¢‘äº¤æ˜“çš„ä½å»¶è¿Ÿè¦æ±‚ CPUäº²å’Œæ€§è®¾ç½®\nvoid ConnectionPool::setupRealtime(int cpu_core) { cpu_set_t cpuset; CPU_ZERO(\u0026amp;cpuset); CPU_SET(cpu_core, \u0026amp;cpuset); pthread_setaffinity_np(pthread_self(), sizeof(cpu_set_t), \u0026amp;cpuset); struct sched_param param; param.sched_priority = sched_get_priority_max(SCHED_FIFO); pthread_setschedparam(pthread_self(), SCHED_FIFO, \u0026amp;param); } ä¸‰ã€é—®é¢˜åˆ†æ #3.1 å•endpointé˜»å¡åŸå›  # CPUäº²å’Œæ€§é™åˆ¶ï¼š çº¿ç¨‹è¢«å¼ºåˆ¶ç»‘å®šåˆ°ç‰¹å®šCPUæ ¸å¿ƒ å½“è¯¥æ ¸å¿ƒè¢«å…¶ä»–ä»»åŠ¡å ç”¨æ—¶ï¼Œæ— æ³•åˆ‡æ¢åˆ°å…¶ä»–æ ¸å¿ƒ å¯¼è‡´æ¶ˆæ¯å¤„ç†çº¿ç¨‹æ— æ³•è·å¾—CPUæ—¶é—´ é˜»å¡å¼æ¥æ”¶å½±å“ï¼š receiveFrameé˜»å¡ç­‰å¾…æ–°æ¶ˆæ¯ CPUäº²å’Œæ€§é™åˆ¶å¯¼è‡´çº¿ç¨‹æ— æ³•åŠæ—¶è·å¾—CPUæ—¶é—´ å³ä½¿æœ‰æ–°æ¶ˆæ¯ä¹Ÿæ— æ³•åŠæ—¶å¤„ç† 3.2 å¤šendpointåœºæ™¯åˆ†æ # ä¸ºä»€ä¹ˆåªæœ‰ä¸€ä¸ªçº¿ç¨‹æ­£å¸¸ï¼š å¤šä¸ªçº¿ç¨‹ç«äº‰CPUèµ„æº è·å¾—CPUæ—¶é—´ç‰‡çš„çº¿ç¨‹èƒ½æ­£å¸¸å¤„ç†æ¶ˆæ¯ å…¶ä»–çº¿ç¨‹ç”±äºCPUäº²å’Œæ€§é™åˆ¶æ— æ³•åˆ‡æ¢æ ¸å¿ƒï¼Œå¯¼è‡´é˜»å¡ æ—¥å¿—è¯æ®ï¼š [20:54:50.542] [thread 91374] OkxPublic message processed [20:54:50.640] [thread 91374] OkxPublic message processed // åªæœ‰thread 91374æŒç»­å·¥ä½œ å››ã€è§£å†³æ–¹æ¡ˆ #4.1 ç§»é™¤CPUäº²å’Œæ€§é™åˆ¶ #void ConnectionPool::setupMessageHandler(context) { context-\u0026gt;message_thread = std::thread([this, context]() { // ç§»é™¤CPUäº²å’Œæ€§è®¾ç½® // è®©ç³»ç»Ÿè‡ªåŠ¨è¿›è¡Œçº¿ç¨‹è°ƒåº¦ while (running_) { context-\u0026gt;client-\u0026gt;receiveMessages(...); } }); } 4.2 ä¼˜åŒ–æ€§èƒ½ç›‘æ§ #struct ThreadMetrics { std::atomic\u0026lt;uint64_t\u0026gt; messages_processed{0}; std::atomic\u0026lt;uint64_t\u0026gt; processing_time_us{0}; std::atomic\u0026lt;uint64_t\u0026gt; max_processing_time_us{0}; std::atomic\u0026lt;int\u0026gt; current_cpu{-1}; }; äº”ã€ç»éªŒæ€»ç»“ # é«˜é¢‘äº¤æ˜“ç³»ç»Ÿç‰¹ç‚¹ éœ€è¦ä½å»¶è¿Ÿå¤„ç† åŒæ­¥å¤„ç†æ¨¡å¼æ›´é€‚åˆ ç³»ç»Ÿè°ƒåº¦ç­–ç•¥éœ€è¦è°¨æ… CPUäº²å’Œæ€§ä½¿ç”¨åŸåˆ™ é¿å…ä¸å¿…è¦çš„é™åˆ¶ è®©æ“ä½œç³»ç»Ÿè¿›è¡Œè‡ªç„¶è°ƒåº¦ éœ€è¦æ—¶è¦å……åˆ†æµ‹è¯•éªŒè¯ æ•…éšœè¯Šæ–­è¦ç‚¹ åˆ†æçº¿ç¨‹è¡Œä¸ºæ¨¡å¼ å¯¹æ¯”ä¸åŒåœºæ™¯çš„è¡¨ç° ç†è§£åº•å±‚æŠ€æœ¯æœºåˆ¶ æ€§èƒ½ä¼˜åŒ–æ–¹å‘ ä¿æŒæ¶ˆæ¯å¤„ç†çš„ä½å»¶è¿Ÿ æ·»åŠ æ€§èƒ½ç›‘æ§æŒ‡æ ‡ ç³»ç»Ÿè°ƒåº¦æœ€ä¼˜åŒ– ","date":"13 December 2024","permalink":"/blog/2025-06-24-message_queue_overstocking_solutions/","section":"Blog","summary":"ä¸€ã€æ•…éšœç°è±¡ #1.1 å•endpointæ¨¡å¼æ•…éšœ # å•ä¸ªWebSocketè¿æ¥æ—¶æ¶ˆæ¯æ¥æ”¶å®Œå…¨é˜»å¡ æ—¥å¿—æ˜¾ç¤ºæ¶ˆæ¯å¤„ç†çº¿ç¨‹å¯åŠ¨åæ— æ³•æ¥æ”¶æ–°æ¶ˆæ¯ [2024-12-12 20:31:29.455] [error] [setThreadAffinity] Error calling pthread_setaffinity_np: 22 [2024-12-12 20:31:29.697] [info] Message thread started for endpoint: OkxPublic // ä¹‹åæ— æ¶ˆæ¯æ¥æ”¶æ—¥å¿— 1.2 å¤šendpointæ¨¡å¼éƒ¨åˆ†æ­£å¸¸ # å¤šä¸ªWebSocketè¿æ¥æ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æ­£å¸¸æ¥æ”¶æ¶ˆæ¯ æ—¥å¿—æ˜¾ç¤ºæ¶ˆæ¯å¤„ç†æƒ…å†µï¼š [20:54:50.542] [thread 91374] Processing message for OkxPublic [20:54:50.640] [thread 91374] Processing message for OkxPublic // åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨æŒç»­å¤„ç†æ¶ˆæ¯ äºŒã€ç³»ç»Ÿæ¶æ„åˆ†æ #2.1 WebSocketæ¶ˆæ¯æ¥æ”¶æœºåˆ¶ #void WebSocketClient::receiveMessages(const MessageHandler\u0026amp; handler) { while (true) { try { // 1. é˜»å¡å¼æ¥æ”¶WebSocketæ¶ˆæ¯ int n = ws_-\u0026gt;receiveFrame(buffer.data(), buffer.size(), flags); // 2. åŒæ­¥å›è°ƒå¤„ç†æ¶ˆæ¯ if (n \u0026gt; 0) { handler(buffer.","title":"WebSocketæ¶ˆæ¯å¤„ç†çº¿ç¨‹CPUäº²å’Œæ€§å¯¼è‡´çš„æ¶ˆæ¯é˜»å¡æ•…éšœåˆ†æ"},{"content":"1. éœ€æ±‚èƒŒæ™¯ #åœ¨é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬é¢ä¸´ä¸€ä¸ªå…¸å‹åœºæ™¯ï¼šéœ€è¦åŒæ—¶å¤„ç†ä¸‰ä¸ªå…³è”è®¢å•ï¼ˆä¸‰è§’å¥—åˆ©ï¼‰ã€‚è¿™äº›è®¢å•å¿…é¡»å‡ ä¹åŒæ—¶å‘å‡ºä»¥ç¡®ä¿å¥—åˆ©çš„æœ‰æ•ˆæ€§ã€‚\nå…³é”®æŒ‘æˆ˜ï¼š\nè®¢å•å¿…é¡»åŒæ—¶æˆ–å‡ ä¹åŒæ—¶å‘å‡º ç³»ç»Ÿéœ€è¦å¤„ç†é«˜å¹¶å‘çš„è®¢å•ç»„ éœ€è¦ä¿è¯è®¢å•å¤„ç†çš„ç¨³å®šæ€§å’Œå¯é æ€§ 2. å½“å‰ä½¿ç”¨çš„ä¸¤ç§å¤„ç†è®¢å•çš„æœºåˆ¶ # æ— é”é˜Ÿåˆ—æœºåˆ¶ è®¢å•ç”Ÿæˆåè¿›å…¥ä¸€ä¸ªæ— é”é˜Ÿåˆ— å¤šä¸ªçº¿ç¨‹ä»é˜Ÿåˆ—ä¸­å–è®¢å•è¿›è¡Œå¤„ç† è®¢å•çš„å‘é€é€šè¿‡RestClientè¿›è¡Œï¼ŒRestClientè´Ÿè´£ç®¡ç†HTTPè¿æ¥æ± å¹¶å‘é€è¯·æ±‚ åˆ†ç‰‡æœºåˆ¶ è®¢å•ç”Ÿæˆåæ ¹æ®æŸç§è§„åˆ™åˆ†é…åˆ°ä¸åŒçš„åˆ†ç‰‡ æ¯ä¸ªåˆ†ç‰‡ç”±å›ºå®šçš„çº¿ç¨‹å¤„ç† åŒä¸€ç»„çš„è®¢å•è¢«åˆ†é…åˆ°åŒä¸€ä¸ªåˆ†ç‰‡ï¼Œç¡®ä¿ç»„å†…è®¢å•çš„å¤„ç†ä¸€è‡´æ€§ RestClientåŒæ ·è´Ÿè´£è®¢å•çš„å‘é€ class OrderShard { private: struct OrderGroup { uint64_t groupId; uint64_t timestamp; std::vector\u0026lt;Order\u0026gt; orders; }; std::queue\u0026lt;OrderGroup\u0026gt; orderQueue_; std::mutex mutex_; std::condition_variable cv_; RestClient restClient_; public: void addOrderGroup(OrderGroup group) { { std::lock_guard\u0026lt;std::mutex\u0026gt; lock(mutex_); orderQueue_.push(std::move(group)); } cv_.notify_one(); } void processOrders() { while (running_) { OrderGroup group; { std::unique_lock\u0026lt;std::mutex\u0026gt; lock(mutex_); cv_.wait(lock, [this] { return !orderQueue_.empty() || !running_; }); if (!running_) break; group = std::move(orderQueue_.front()); orderQueue_.pop(); } // æ‰¹é‡å‘é€åŒç»„è®¢å• sendOrderGroup(group); } } private: void sendOrderGroup(const OrderGroup\u0026amp; group) { // ä½¿ç”¨åŒä¸€ä¸ªè¿æ¥å‘é€ç»„å†…æ‰€æœ‰è®¢å• auto conn = restClient_.getConnection(); for (const auto\u0026amp; order : group.orders) { conn-\u0026gt;sendOrder(order); } } }; 3. ä¸¤ç§æœºåˆ¶çš„æ‰§è¡Œç»“æœåˆ†æ # æ— é”é˜Ÿåˆ—æœºåˆ¶ æ—¥å¿—æ˜¾ç¤ºç»„å†…è®¢å•çš„å‘é€æ—¶é—´å·®è¾ƒå¤§ï¼Œé€šå¸¸åœ¨180-220msä¹‹é—´ å­˜åœ¨è¾ƒå¤§çš„å»¶è¿Ÿæ³¢åŠ¨ï¼Œéƒ¨åˆ†ç»„çš„æœ€å¤§æ—¶é—´å·®è¶…è¿‡1000ms æ€»è®¢å•ç»„æ•°: 164 å­˜åœ¨æ—¶é—´å·®çš„ç»„æ•°: 161 æœ€å¤§æ—¶é—´å·®: 2961.000ms å¹³å‡æ—¶é—´å·®: 308.851ms åˆ†ç‰‡æœºåˆ¶\næ—¥å¿—æ˜¾ç¤ºç»„å†…è®¢å•çš„å‘é€æ—¶é—´å·®éå¸¸å°ï¼ŒåŸºæœ¬åœ¨0-1msä¹‹é—´ è®¢å•å‡ ä¹åŒæ—¶å‘å‡ºï¼Œå»¶è¿Ÿæ³¢åŠ¨å¾ˆå° æ€»è®¢å•ç»„æ•°: 416 å­˜åœ¨æ—¶é—´å·®çš„ç»„æ•°: 166 æœ€å¤§æ—¶é—´å·®: 425.000ms å¹³å‡æ—¶é—´å·®: 56.991ms 4. æœºåˆ¶å·®å¼‚åˆ†æ # æ— é”é˜Ÿåˆ—æœºåˆ¶ æ‰€æœ‰è®¢å•è¿›å…¥åŒä¸€ä¸ªé˜Ÿåˆ— å¤šä¸ªçº¿ç¨‹ä»åŒä¸€é˜Ÿåˆ—å–ä»»åŠ¡ï¼Œå³ä½¿æ˜¯æ— é”çš„ï¼Œä»ç„¶å­˜åœ¨ç«äº‰ åŒä¸€ç»„çš„ä¸‰ä¸ªè®¢å•å¯èƒ½è¢«ä¸åŒçº¿ç¨‹å¤„ç†ï¼Œå¯¼è‡´æ—¶é—´å·® çº¿ç¨‹è°ƒåº¦çš„ä¸ç¡®å®šæ€§å¯¼è‡´ç»„å†…è®¢å•çš„å‘é€æ—¶é—´ä¸ä¸€è‡´ åˆ†ç‰‡æœºåˆ¶ é€šè¿‡åˆ†ç‰‡å°†åŒç»„è®¢å•åˆ†é…åˆ°åŒä¸€çº¿ç¨‹ï¼Œé¿å…äº†çº¿ç¨‹é—´çš„ç«äº‰ å›ºå®šçº¿ç¨‹å¤„ç†åŒä¸€åˆ†ç‰‡ï¼Œç¡®ä¿äº†ç»„å†…è®¢å•çš„å¤„ç†é¡ºåºå’Œæ—¶é—´ä¸€è‡´æ€§ 5. é€‚åˆéœ€æ±‚çš„æœ€ä½³æ–¹æ¡ˆ # åˆ†ç‰‡æœºåˆ¶ ç†ç”±ï¼šåˆ†ç‰‡æœºåˆ¶èƒ½å¤Ÿç¡®ä¿åŒç»„è®¢å•çš„å¤„ç†ä¸€è‡´æ€§ï¼Œæ»¡è¶³å‡ ä¹åŒæ—¶å‘å‡ºçš„éœ€æ±‚ é€šè¿‡å‡å°‘çº¿ç¨‹ç«äº‰å’Œè°ƒåº¦ä¸ç¡®å®šæ€§ï¼Œåˆ†ç‰‡æœºåˆ¶æä¾›äº†æ›´ç¨³å®šçš„æ€§èƒ½ 6. æœ€ä½³æ–¹æ¡ˆçš„ä¼˜åŒ–æ–¹å‘ # ä¼˜åŒ–åˆ†ç‰‡ç­–ç•¥ æ ¹æ®è®¢å•ç‰¹æ€§ä¼˜åŒ–åˆ†ç‰‡è§„åˆ™ï¼Œè¿›ä¸€æ­¥æé«˜å¤„ç†æ•ˆç‡ è°ƒæ•´çº¿ç¨‹æ± é…ç½® æ ¹æ®ç³»ç»Ÿè´Ÿè½½åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å¤§å°ï¼Œç¡®ä¿èµ„æºçš„åˆç†åˆ©ç”¨ ä¼˜åŒ–RestClientè¿æ¥æ±  æ ¹æ®è¯·æ±‚å¹¶å‘é‡è°ƒæ•´è¿æ¥æ± å¤§å°ï¼Œç¡®ä¿è¯·æ±‚çš„å¿«é€Ÿå‘é€ ç›‘æ§å’Œè°ƒä¼˜ æŒç»­ç›‘æ§ç³»ç»Ÿæ€§èƒ½ï¼Œè¯†åˆ«ç“¶é¢ˆå¹¶è¿›è¡Œè°ƒä¼˜ ä½¿ç”¨æ€§èƒ½åˆ†æå·¥å…·è¯†åˆ«å’Œä¼˜åŒ–å…³é”®è·¯å¾„ ","date":"12 December 2024","permalink":"/blog/2025-06-24-order_sending_optimization/","section":"Blog","summary":"1. éœ€æ±‚èƒŒæ™¯ #åœ¨é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬é¢ä¸´ä¸€ä¸ªå…¸å‹åœºæ™¯ï¼šéœ€è¦åŒæ—¶å¤„ç†ä¸‰ä¸ªå…³è”è®¢å•ï¼ˆä¸‰è§’å¥—åˆ©ï¼‰ã€‚è¿™äº›è®¢å•å¿…é¡»å‡ ä¹åŒæ—¶å‘å‡ºä»¥ç¡®ä¿å¥—åˆ©çš„æœ‰æ•ˆæ€§ã€‚\nå…³é”®æŒ‘æˆ˜ï¼š\nè®¢å•å¿…é¡»åŒæ—¶æˆ–å‡ ä¹åŒæ—¶å‘å‡º ç³»ç»Ÿéœ€è¦å¤„ç†é«˜å¹¶å‘çš„è®¢å•ç»„ éœ€è¦ä¿è¯è®¢å•å¤„ç†çš„ç¨³å®šæ€§å’Œå¯é æ€§ 2. å½“å‰ä½¿ç”¨çš„ä¸¤ç§å¤„ç†è®¢å•çš„æœºåˆ¶ # æ— é”é˜Ÿåˆ—æœºåˆ¶ è®¢å•ç”Ÿæˆåè¿›å…¥ä¸€ä¸ªæ— é”é˜Ÿåˆ— å¤šä¸ªçº¿ç¨‹ä»é˜Ÿåˆ—ä¸­å–è®¢å•è¿›è¡Œå¤„ç† è®¢å•çš„å‘é€é€šè¿‡RestClientè¿›è¡Œï¼ŒRestClientè´Ÿè´£ç®¡ç†HTTPè¿æ¥æ± å¹¶å‘é€è¯·æ±‚ åˆ†ç‰‡æœºåˆ¶ è®¢å•ç”Ÿæˆåæ ¹æ®æŸç§è§„åˆ™åˆ†é…åˆ°ä¸åŒçš„åˆ†ç‰‡ æ¯ä¸ªåˆ†ç‰‡ç”±å›ºå®šçš„çº¿ç¨‹å¤„ç† åŒä¸€ç»„çš„è®¢å•è¢«åˆ†é…åˆ°åŒä¸€ä¸ªåˆ†ç‰‡ï¼Œç¡®ä¿ç»„å†…è®¢å•çš„å¤„ç†ä¸€è‡´æ€§ RestClientåŒæ ·è´Ÿè´£è®¢å•çš„å‘é€ class OrderShard { private: struct OrderGroup { uint64_t groupId; uint64_t timestamp; std::vector\u0026lt;Order\u0026gt; orders; }; std::queue\u0026lt;OrderGroup\u0026gt; orderQueue_; std::mutex mutex_; std::condition_variable cv_; RestClient restClient_; public: void addOrderGroup(OrderGroup group) { { std::lock_guard\u0026lt;std::mutex\u0026gt; lock(mutex_); orderQueue_.push(std::move(group)); } cv_.notify_one(); } void processOrders() { while (running_) { OrderGroup group; { std::unique_lock\u0026lt;std::mutex\u0026gt; lock(mutex_); cv_.wait(lock, [this] { return !orderQueue_.empty() || !","title":"é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­çš„å¤§ååé‡è®¢å•å‘é€æœºåˆ¶"},{"content":"1. èƒŒæ™¯é—®é¢˜ #1.1 æ€§èƒ½æŒ‘æˆ˜ # é«˜ååé‡è®¢å•å¤„ç†éœ€æ±‚ æ¯ä¸ªè®¢å•éƒ½éœ€è¦ HTTP è¯·æ±‚ JWT Token ç”Ÿæˆå¼€é”€å¤§ ç½‘ç»œå»¶è¿Ÿæ•æ„Ÿ 1.2 ä¸»è¦ç—›ç‚¹ # å•ä¸ªè®¢å•å‘é€é€ æˆç½‘ç»œè¯·æ±‚è¿‡å¤š JWT Token é¢‘ç¹ç”Ÿæˆæµªè´¹èµ„æº å¤§é‡è®¢å•å¹¶å‘å¯èƒ½å¯¼è‡´ç³»ç»Ÿç“¶é¢ˆ 2. è§£å†³æ–¹æ¡ˆ #2.1 JWT Token ç¼“å­˜æœºåˆ¶ #class RestClient { private: static constexpr auto JWT_REFRESH_INTERVAL = std::chrono::seconds(110); // é¢„ç•™åˆ·æ–°çª—å£ std::string getOrCreateJWT(const std::string\u0026amp; uri) { auto now = std::chrono::steady_clock::now(); if (!cache.token.empty() \u0026amp;\u0026amp; now \u0026lt; cache.expiryTime) { return cache.token; } cache.token = generateJWT(uri); cache.expiryTime = now + JWT_REFRESH_INTERVAL; return cache.token; } }; ä¼˜ç‚¹ï¼š\nå‡å°‘ JWT ç”Ÿæˆæ¬¡æ•° é™ä½ CPU ä½¿ç”¨ç‡ æé«˜è¯·æ±‚å“åº”é€Ÿåº¦ 2.2 æ™ºèƒ½æ‰¹é‡å¤„ç†æœºåˆ¶ #void ExecutionEngine::executeOrder(const OrderReadyForExecutionEvent\u0026amp; order) { auto now = std::chrono::steady_clock::now(); if (collector_.orders.empty()) { collector_.firstOrderTime = now; } collector_.orders.push_back(order); bool shouldBatch = collector_.orders.size() \u0026gt;= BATCH_THRESHOLD; bool withinWindow = (now - collector_.firstOrderTime) \u0026lt;= COLLECT_WINDOW; if (shouldBatch || !withinWindow) { if (collector_.orders.size() == 1) { processSingleOrder(collector_.orders[0]); } else { processBatchOrders(); } collector_.orders.clear(); } } ä¼˜ç‚¹ï¼š\nè‡ªé€‚åº”å¤„ç†ç­–ç•¥ å¹³è¡¡å»¶è¿Ÿå’Œååé‡ ä¼˜åŒ–ç½‘ç»œèµ„æºä½¿ç”¨ 2.3 è®¢å•é…ç½®ç»“æ„è®¾è®¡ #struct OrderConfig { struct LimitGTC { std::string baseSize; std::string limitPrice; bool postOnly{false}; }; struct MarketIOC { std::string baseSize; }; Type type; std::variant\u0026lt;LimitGTC, MarketIOC\u0026gt; config; std::string orderId; std::string productId; std::string side; }; ä¼˜ç‚¹ï¼š\nç±»å‹å®‰å…¨ æ¸…æ™°çš„æ•°æ®ç»“æ„ æ˜“äºç»´æŠ¤å’Œæ‰©å±• 3. å…³é”®è®¾è®¡å‚æ•° #3.1 æ‰¹å¤„ç†å‚æ•° #static constexpr size_t BATCH_THRESHOLD = 20; // æ‰¹å¤„ç†é˜ˆå€¼ static constexpr auto COLLECT_WINDOW = std::chrono::microseconds(50); // æ”¶é›†çª—å£ 3.2 JWT ç¼“å­˜å‚æ•° #static constexpr auto JWT_REFRESH_INTERVAL = std::chrono::seconds(110); // JWTåˆ·æ–°é—´éš” 4. æ€§èƒ½ä¼˜åŒ–ç‚¹ #4.1 å†…å­˜ä¼˜åŒ– #configs.reserve(collector_.orders.size()); // é¢„åˆ†é…å†…å­˜ configs.push_back(std::move(config)); // ä½¿ç”¨ç§»åŠ¨è¯­ä¹‰ 4.2 æ‰¹å¤„ç†ä¼˜åŒ– # åŠ¨æ€åˆ¤æ–­æ˜¯å¦ä½¿ç”¨æ‰¹å¤„ç† å•è®¢å•ç›´æ¥å¤„ç† æ‰¹é‡è®¢å•åˆå¹¶è¯·æ±‚ 4.3 é”™è¯¯å¤„ç† #try { auto response = m_RestClient-\u0026gt;batchCreateOrders(configs); // å¤„ç†å“åº”... } catch (const std::exception\u0026amp; e) { LOG_ERROR(\u0026#34;Batch processing error: {}\u0026#34;, e.what()); } 5. æ–¹æ¡ˆä¼˜åŠ¿ # æ€§èƒ½æå‡ï¼š\nå‡å°‘ç½‘ç»œè¯·æ±‚æ•°é‡ é™ä½ç³»ç»Ÿèµ„æºæ¶ˆè€— ä¼˜åŒ–å†…å­˜ä½¿ç”¨ å¯é æ€§ï¼š\nå®Œå–„çš„é”™è¯¯å¤„ç† JWT Token å¯é æ€§ä¿è¯ è®¢å•çŠ¶æ€è¿½è¸ª å¯ç»´æŠ¤æ€§ï¼š\næ¸…æ™°çš„ä»£ç ç»“æ„ ç±»å‹å®‰å…¨çš„è®¾è®¡ è¯¦ç»†çš„æ—¥å¿—è®°å½• çµæ´»æ€§ï¼š\nå¯é…ç½®çš„å‚æ•° è‡ªé€‚åº”å¤„ç†ç­–ç•¥ æ˜“äºæ‰©å±• 6. ç›‘æ§å»ºè®® # æ€§èƒ½æŒ‡æ ‡ï¼š\nè®¢å•å¤„ç†å»¶è¿Ÿ æ‰¹å¤„ç†å¤§å°åˆ†å¸ƒ JWT ç¼“å­˜å‘½ä¸­ç‡ ç³»ç»ŸæŒ‡æ ‡ï¼š\nCPU ä½¿ç”¨ç‡ å†…å­˜ä½¿ç”¨æƒ…å†µ ç½‘ç»œè¯·æ±‚ç»Ÿè®¡ ä¸šåŠ¡æŒ‡æ ‡ï¼š\nè®¢å•æˆåŠŸç‡ æ‰¹å¤„ç†æ•ˆç‡ é”™è¯¯ç‡ç»Ÿè®¡ 7. æœ€ä½³å®è·µ # å‚æ•°è°ƒä¼˜ï¼š\næ ¹æ®å®é™…è´Ÿè½½è°ƒæ•´æ‰¹å¤„ç†é˜ˆå€¼ ç›‘æ§å¹¶ä¼˜åŒ–æ—¶é—´çª—å£ å®šæœŸè¯„ä¼°æ€§èƒ½æŒ‡æ ‡ é”™è¯¯å¤„ç†ï¼š\nå®ç°é‡è¯•æœºåˆ¶ è®°å½•è¯¦ç»†é”™è¯¯ä¿¡æ¯ ç›‘æ§å¼‚å¸¸æƒ…å†µ æ€§èƒ½ä¼˜åŒ–ï¼š\nä½¿ç”¨ç§»åŠ¨è¯­ä¹‰ é¢„åˆ†é…å†…å­˜ é¿å…ä¸å¿…è¦çš„å¤åˆ¶ è¿™ä¸ªæ–¹æ¡ˆé€šè¿‡åˆç†çš„è®¾è®¡å’Œä¼˜åŒ–ï¼Œæœ‰æ•ˆè§£å†³äº†é«˜ååé‡è®¢å•å¤„ç†çš„æŒ‘æˆ˜ï¼ŒåŒæ—¶ä¿è¯äº†ç³»ç»Ÿçš„å¯é æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚\n","date":"6 December 2024","permalink":"/blog/2025-06-24-batch_order_processing/","section":"Blog","summary":"1. èƒŒæ™¯é—®é¢˜ #1.1 æ€§èƒ½æŒ‘æˆ˜ # é«˜ååé‡è®¢å•å¤„ç†éœ€æ±‚ æ¯ä¸ªè®¢å•éƒ½éœ€è¦ HTTP è¯·æ±‚ JWT Token ç”Ÿæˆå¼€é”€å¤§ ç½‘ç»œå»¶è¿Ÿæ•æ„Ÿ 1.2 ä¸»è¦ç—›ç‚¹ # å•ä¸ªè®¢å•å‘é€é€ æˆç½‘ç»œè¯·æ±‚è¿‡å¤š JWT Token é¢‘ç¹ç”Ÿæˆæµªè´¹èµ„æº å¤§é‡è®¢å•å¹¶å‘å¯èƒ½å¯¼è‡´ç³»ç»Ÿç“¶é¢ˆ 2. è§£å†³æ–¹æ¡ˆ #2.1 JWT Token ç¼“å­˜æœºåˆ¶ #class RestClient { private: static constexpr auto JWT_REFRESH_INTERVAL = std::chrono::seconds(110); // é¢„ç•™åˆ·æ–°çª—å£ std::string getOrCreateJWT(const std::string\u0026amp; uri) { auto now = std::chrono::steady_clock::now(); if (!cache.token.empty() \u0026amp;\u0026amp; now \u0026lt; cache.expiryTime) { return cache.token; } cache.token = generateJWT(uri); cache.expiryTime = now + JWT_REFRESH_INTERVAL; return cache.token; } }; ä¼˜ç‚¹ï¼š","title":"é«˜æ€§èƒ½è®¢å•æ‰§è¡Œç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆ1"},{"content":"0. å†…å­˜ç®¡ç†ä¼˜åŒ– #0.1 å¤§é¡µå†…å­˜ (Huge Pages) #å¤§é¡µå†…å­˜æ˜¯ä¸€ç§å†…å­˜ç®¡ç†ä¼˜åŒ–æŠ€æœ¯ï¼Œä¸»è¦ä¼˜åŠ¿ï¼š\nå‡å°‘ TLB (Translation Lookaside Buffer) ç¼ºå¤± å‡å°‘é¡µè¡¨é¡¹æ•°é‡ æé«˜å†…å­˜è®¿é—®æ•ˆç‡ ç³»ç»Ÿé…ç½®å’Œæ£€æŸ¥ï¼š\n# æ£€æŸ¥ç³»ç»Ÿå¤§é¡µé…ç½® cat /proc/meminfo | grep Huge # é…ç½®å¤§é¡µ echo 20 \u0026gt; /proc/sys/vm/nr_hugepages # åˆ†é…20ä¸ªå¤§é¡µ 0.2 å†…å­˜é”å®š (Memory Locking) #é˜²æ­¢å†…å­˜è¢«äº¤æ¢åˆ°ç£ç›˜ï¼Œç¡®ä¿æ•°æ®å§‹ç»ˆåœ¨ç‰©ç†å†…å­˜ä¸­ï¼š\n# æ£€æŸ¥å†…å­˜é”å®šé™åˆ¶ ulimit -l # ä¿®æ”¹é™åˆ¶ï¼ˆéœ€è¦rootæƒé™ï¼‰ echo \u0026#34;* soft memlock unlimited\u0026#34; \u0026gt;\u0026gt; /etc/security/limits.conf 0.3 å†…å­˜ä¼˜åŒ–å®ç° #struct IOBuffer { char* data; size_t size; explicit IOBuffer(size_t s) : size(s) { // 1. å°è¯•ä½¿ç”¨å¤§é¡µå†…å­˜ data = static_cast\u0026lt;char*\u0026gt;(mmap(nullptr, size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS | MAP_HUGETLB, -1, 0)); if (data == MAP_FAILED) { // 2. å›é€€åˆ°æ™®é€šå†…å­˜ + é¢„å¡«å…… data = static_cast\u0026lt;char*\u0026gt;(mmap(nullptr, size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS | MAP_POPULATE, -1, 0)); if (data == MAP_FAILED) { throw std::runtime_error(\u0026#34;Failed to allocate memory\u0026#34;); } } // 3. å°è¯•é”å®šå†…å­˜ if (mlock(data, size) != 0) { LOG_WARN(\u0026#34;Failed to lock memory: {}\u0026#34;, strerror(errno)); } } ~IOBuffer() { if (data != MAP_FAILED \u0026amp;\u0026amp; data != nullptr) { munlock(data, size); munmap(data, size); } } }; 1. io_uring å¤šè·¯ I/O ä¼˜åŠ¿ #1.1 ä¼ ç»Ÿ I/O æ¨¡å‹çš„é—®é¢˜ #// ä¼ ç»Ÿ epoll æ¨¡å‹ int epoll_fd = epoll_create1(0); struct epoll_event events[MAX_EVENTS]; // æ¯ä¸ª I/O æ“ä½œéƒ½éœ€è¦ç³»ç»Ÿè°ƒç”¨ read(fd, buffer, len); // ç³»ç»Ÿè°ƒç”¨ write(fd, data, len); // ç³»ç»Ÿè°ƒç”¨ epoll_wait(epoll_fd, events, MAX_EVENTS, timeout); // ç³»ç»Ÿè°ƒç”¨ é—®é¢˜ï¼š\næ¯ä¸ª I/O æ“ä½œéƒ½éœ€è¦ç‹¬ç«‹çš„ç³»ç»Ÿè°ƒç”¨ ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€å¤§ æ•°æ®å¤åˆ¶æ¬¡æ•°å¤š 1.2 io_uring çš„æ”¹è¿› #struct io_uring ring; struct io_uring_sqe *sqe; struct io_uring_cqe *cqe; // æ‰¹é‡æäº¤ I/O è¯·æ±‚ for (int i = 0; i \u0026lt; n_requests; i++) { sqe = io_uring_get_sqe(\u0026amp;ring); io_uring_prep_read(sqe, fds[i], buffers[i], len, offset); sqe-\u0026gt;user_data = i; // æ ‡è¯†è¯·æ±‚ } // ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨æäº¤æ‰€æœ‰è¯·æ±‚ io_uring_submit(\u0026amp;ring); ä¼˜åŠ¿ï¼š\næ‰¹é‡æäº¤å‡å°‘ç³»ç»Ÿè°ƒç”¨ é›¶æ‹·è´ I/O å¼‚æ­¥å¤„ç†å¤šä¸ª I/O è¯·æ±‚ 2. WebSocket å¤šè¿æ¥å¤„ç†å®ç° #2.1 åŸºç¡€ç»“æ„ #struct IOContext { int fd; IOBuffer buffer; std::function\u0026lt;void(const char*, size_t)\u0026gt; callback; }; class WebSocketClient { private: struct io_uring ring; std::vector\u0026lt;IOContext\u0026gt; contexts; static constexpr int QUEUE_DEPTH = 256; // ... }; 2.2 å¤šè¿æ¥ I/O å¤„ç† #void WebSocketClient::processMultipleConnections() { struct io_uring_params params = {}; params.flags = IORING_SETUP_SQPOLL; params.sq_thread_cpu = cpu_core_; // åˆå§‹åŒ– io_uring io_uring_queue_init_params(QUEUE_DEPTH, \u0026amp;ring, \u0026amp;params); // ä¸ºæ¯ä¸ªè¿æ¥æäº¤è¯»è¯·æ±‚ for (auto\u0026amp; ctx : contexts) { struct io_uring_sqe *sqe = io_uring_get_sqe(\u0026amp;ring); io_uring_prep_read(sqe, ctx.fd, ctx.buffer.data, ctx.buffer.size, 0); sqe-\u0026gt;user_data = reinterpret_cast\u0026lt;__u64\u0026gt;(\u0026amp;ctx); } // ä¸€æ¬¡æäº¤æ‰€æœ‰è¯·æ±‚ io_uring_submit(\u0026amp;ring); // å¤„ç†å®Œæˆäº‹ä»¶ while (running_) { struct io_uring_cqe *cqe; int ret = io_uring_wait_cqe(\u0026amp;ring, \u0026amp;cqe); if (ret == 0) { IOContext *ctx = reinterpret_cast\u0026lt;IOContext*\u0026gt;(cqe-\u0026gt;user_data); if (cqe-\u0026gt;res \u0026gt; 0) { // å¤„ç†æ•°æ® ctx-\u0026gt;callback(ctx-\u0026gt;buffer.data, cqe-\u0026gt;res); // æäº¤æ–°çš„è¯»è¯·æ±‚ struct io_uring_sqe *sqe = io_uring_get_sqe(\u0026amp;ring); io_uring_prep_read(sqe, ctx-\u0026gt;fd, ctx-\u0026gt;buffer.data, ctx-\u0026gt;buffer.size, 0); sqe-\u0026gt;user_data = cqe-\u0026gt;user_data; io_uring_submit(\u0026amp;ring); } io_uring_cqe_seen(\u0026amp;ring, cqe); } } } 2.3 æ€§èƒ½ä¼˜åŒ–æŠ€å·§ #æ‰¹é‡æäº¤ä¼˜åŒ– #void submitBatchRequests() { int pending = 0; for (auto\u0026amp; ctx : contexts) { struct io_uring_sqe *sqe = io_uring_get_sqe(\u0026amp;ring); io_uring_prep_read(sqe, ctx.fd, ctx.buffer.data, ctx.buffer.size, 0); sqe-\u0026gt;user_data = reinterpret_cast\u0026lt;__u64\u0026gt;(\u0026amp;ctx); pending++; // è¾¾åˆ°æ‰¹æ¬¡å¤§å°æ—¶æäº¤ if (pending == BATCH_SIZE) { io_uring_submit(\u0026amp;ring); pending = 0; } } // æäº¤å‰©ä½™è¯·æ±‚ if (pending \u0026gt; 0) { io_uring_submit(\u0026amp;ring); } } å†…å­˜å¯¹é½å’Œç¼“å­˜ä¼˜åŒ– #struct alignas(64) IOContext { // ç¼“å­˜è¡Œå¯¹é½ int fd; IOBuffer buffer; std::function\u0026lt;void(const char*, size_t)\u0026gt; callback; char padding[CACHE_LINE_SIZE - sizeof(fd) - sizeof(buffer) - sizeof(callback)]; }; 3. æ€§èƒ½ç›‘æ§å’Œè°ƒä¼˜ #3.1 æ€§èƒ½æŒ‡æ ‡æ”¶é›† #struct IOStats { std::atomic\u0026lt;uint64_t\u0026gt; total_requests{0}; std::atomic\u0026lt;uint64_t\u0026gt; completed_requests{0}; std::atomic\u0026lt;uint64_t\u0026gt; total_bytes{0}; std::atomic\u0026lt;uint64_t\u0026gt; error_count{0}; void recordRequest() { total_requests++; } void recordCompletion(size_t bytes) { completed_requests++; total_bytes += bytes; } void recordError() { error_count++; } }; 3.2 æ€§èƒ½ç›‘æ§ç¤ºä¾‹ #void monitorPerformance() { while (running_) { auto start_stats = io_stats; std::this_thread::sleep_for(std::chrono::seconds(1)); auto end_stats = io_stats; uint64_t requests_per_sec = end_stats.completed_requests - start_stats.completed_requests; uint64_t bytes_per_sec = end_stats.total_bytes - start_stats.total_bytes; LOG_INFO(\u0026#34;IO Stats: {} req/s, {} MB/s\u0026#34;, requests_per_sec, bytes_per_sec / (1024 * 1024)); } } 4. æœ€ä½³å®è·µæ€»ç»“ # æ‰¹é‡å¤„ç†\nåˆå¹¶å¤šä¸ª I/O è¯·æ±‚ å‡å°‘ç³»ç»Ÿè°ƒç”¨æ¬¡æ•° æé«˜ååé‡ å†…å­˜ç®¡ç†\nä½¿ç”¨å¤§é¡µå†…å­˜ å†…å­˜å¯¹é½ é¿å…å†…å­˜æ‹·è´ CPU äº²å’Œæ€§\nç»‘å®š io_uring å·¥ä½œçº¿ç¨‹åˆ°ç‰¹å®š CPU å‡å°‘ CPU ç¼“å­˜å¤±æ•ˆ é”™è¯¯å¤„ç†\nä¼˜é›…é™çº§ è‡ªåŠ¨é‡è¯•æœºåˆ¶ è¯¦ç»†çš„é”™è¯¯æ—¥å¿— ç›‘æ§å’Œè°ƒä¼˜\nå®æ—¶æ€§èƒ½æŒ‡æ ‡ ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ å¼‚å¸¸æƒ…å†µå‘Šè­¦ é€šè¿‡è¿™äº›æŠ€æœ¯çš„ç»„åˆä½¿ç”¨ï¼Œå¯ä»¥æ„å»ºä¸€ä¸ªé«˜æ€§èƒ½ã€å¯é çš„å¤šè¿æ¥ I/O å¤„ç†ç³»ç»Ÿã€‚io_uring çš„å¼‚æ­¥ç‰¹æ€§å’Œæ‰¹é‡å¤„ç†èƒ½åŠ›ï¼Œé…åˆåˆç†çš„å†…å­˜ç®¡ç†å’Œç›‘æ§æœºåˆ¶ï¼Œèƒ½å¤Ÿæ˜¾è‘—æå‡ç³»ç»Ÿçš„æ•´ä½“æ€§èƒ½ã€‚\n","date":"6 December 2024","permalink":"/blog/2025-06-24-io_uring_basics/","section":"Blog","summary":"0. å†…å­˜ç®¡ç†ä¼˜åŒ– #0.1 å¤§é¡µå†…å­˜ (Huge Pages) #å¤§é¡µå†…å­˜æ˜¯ä¸€ç§å†…å­˜ç®¡ç†ä¼˜åŒ–æŠ€æœ¯ï¼Œä¸»è¦ä¼˜åŠ¿ï¼š\nå‡å°‘ TLB (Translation Lookaside Buffer) ç¼ºå¤± å‡å°‘é¡µè¡¨é¡¹æ•°é‡ æé«˜å†…å­˜è®¿é—®æ•ˆç‡ ç³»ç»Ÿé…ç½®å’Œæ£€æŸ¥ï¼š\n# æ£€æŸ¥ç³»ç»Ÿå¤§é¡µé…ç½® cat /proc/meminfo | grep Huge # é…ç½®å¤§é¡µ echo 20 \u0026gt; /proc/sys/vm/nr_hugepages # åˆ†é…20ä¸ªå¤§é¡µ 0.2 å†…å­˜é”å®š (Memory Locking) #é˜²æ­¢å†…å­˜è¢«äº¤æ¢åˆ°ç£ç›˜ï¼Œç¡®ä¿æ•°æ®å§‹ç»ˆåœ¨ç‰©ç†å†…å­˜ä¸­ï¼š\n# æ£€æŸ¥å†…å­˜é”å®šé™åˆ¶ ulimit -l # ä¿®æ”¹é™åˆ¶ï¼ˆéœ€è¦rootæƒé™ï¼‰ echo \u0026#34;* soft memlock unlimited\u0026#34; \u0026gt;\u0026gt; /etc/security/limits.conf 0.3 å†…å­˜ä¼˜åŒ–å®ç° #struct IOBuffer { char* data; size_t size; explicit IOBuffer(size_t s) : size(s) { // 1. å°è¯•ä½¿ç”¨å¤§é¡µå†…å­˜ data = static_cast\u0026lt;char*\u0026gt;(mmap(nullptr, size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS | MAP_HUGETLB, -1, 0)); if (data == MAP_FAILED) { // 2.","title":"é«˜æ€§èƒ½ç½‘ç»œç¼–ç¨‹ï¼šio_uring ä¸å†…å­˜ä¼˜åŒ–æŠ€æœ¯è¯¦è§£"},{"content":"","date":null,"permalink":"/tags/hft-system-design/","section":"Tags","summary":"","title":"HFT System Design"},{"content":"1. ä¸šåŠ¡èƒŒæ™¯ä¸æŒ‘æˆ˜ #åœ¨é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­ï¼Œéœ€è¦åŒæ—¶ç»´æŠ¤å¤šä¸ªWebSocketè¿æ¥ä»¥è®¢é˜…ä¸åŒäº¤æ˜“æ‰€çš„è¡Œæƒ…æ•°æ®ã€‚ä¸»è¦æŒ‘æˆ˜åŒ…æ‹¬ï¼š\néœ€è¦å¤„ç†å¤šä¸ªäº¤æ˜“æ‰€çš„å¹¶å‘è¿æ¥ å¯¹æ¶ˆæ¯å¤„ç†å»¶è¿Ÿæœ‰ä¸¥æ ¼è¦æ±‚ éœ€è¦ä¿è¯æ•°æ®å¤„ç†çš„ç¨³å®šæ€§ ç³»ç»Ÿèµ„æºï¼ˆCPUã€å†…å­˜ï¼‰çš„é«˜æ•ˆåˆ©ç”¨ 2. ä¼ ç»Ÿæ–¹æ¡ˆçš„å±€é™ #2.1 ä¼ ç»Ÿæ¶ˆæ¯é˜Ÿåˆ—æ–¹æ¡ˆ #// å¸¸è§çš„æ¶ˆæ¯å¤„ç†æµç¨‹ WebSocketæ¥æ”¶ -\u0026gt; æ¶ˆæ¯é˜Ÿåˆ— -\u0026gt; å¤„ç†çº¿ç¨‹æ±  -\u0026gt; ä¸šåŠ¡å¤„ç† å­˜åœ¨çš„é—®é¢˜ï¼š\næ¶ˆæ¯ç»è¿‡é˜Ÿåˆ—å¸¦æ¥é¢å¤–å»¶è¿Ÿ çº¿ç¨‹åˆ‡æ¢å¼€é”€å¤§ å†…å­˜æ‹·è´æ¬¡æ•°å¤š èµ„æºç«äº‰å¯¼è‡´æ€§èƒ½ä¸ç¨³å®š 3. ä¼˜åŒ–æ–¹æ¡ˆè®¾è®¡ #3.1 æ ¸å¿ƒè®¾è®¡ç†å¿µ # é›¶æ‹·è´æ•°æ®å¤„ç† CPUäº²å’Œæ€§ç»‘å®š é¢„åˆ†é…å†…å­˜ æ¯ä¸ªè¿æ¥ç‹¬ç«‹å¤„ç† 3.2 å…³é”®ç»„ä»¶è®¾è®¡ #struct ConnectionContext { // è¿æ¥åŸºç¡€ä¿¡æ¯ std::shared_ptr\u0026lt;WebSocketClient\u0026gt; client; std::string endpoint_name; // æ€§èƒ½ä¼˜åŒ–ç›¸å…³ int cpu_core{-1}; // CPUæ ¸å¿ƒç»‘å®š char* direct_buffer{nullptr}; // é¢„åˆ†é…ç¼“å†²åŒº static constexpr size_t BUFFER_SIZE = 64 * 1024; std::shared_ptr\u0026lt;MessageProcessor\u0026gt; dedicated_processor; // èµ„æºç®¡ç† ~ConnectionContext() { if (direct_buffer) { munlock(direct_buffer, BUFFER_SIZE); munmap(direct_buffer, BUFFER_SIZE); } } // ç¦ç”¨æ‹·è´ä»¥ä¿è¯èµ„æºå®‰å…¨ ConnectionContext(const ConnectionContext\u0026amp;) = delete; ConnectionContext\u0026amp; operator=(const ConnectionContext\u0026amp;) = delete; }; 3.3 ä¼˜åŒ–ç»†èŠ‚ # å†…å­˜ç®¡ç†ä¼˜åŒ– // ä½¿ç”¨å¤§é¡µå†…å­˜å’Œå†…å­˜é”å®š void* buffer = mmap(nullptr, BUFFER_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, -1, 0); mlock(buffer, BUFFER_SIZE); åŸå› ï¼š\né¿å…åŠ¨æ€å†…å­˜åˆ†é… å‡å°‘é¡µé¢é”™è¯¯ æä¾›ç¨³å®šçš„å†…å­˜è®¿é—®æ€§èƒ½ CPUäº²å’Œæ€§ä¼˜åŒ– void setupRealtime(int cpu_core) { cpu_set_t cpuset; CPU_ZERO(\u0026amp;cpuset); CPU_SET(cpu_core, \u0026amp;cpuset); pthread_setaffinity_np(pthread_self(), sizeof(cpu_set_t), \u0026amp;cpuset); } åŸå› ï¼š\nå‡å°‘çº¿ç¨‹è¿ç§» æé«˜CPUç¼“å­˜åˆ©ç”¨ç‡ é™ä½å»¶è¿ŸæŠ–åŠ¨ æ¶ˆæ¯å¤„ç†ä¼˜åŒ– // ç›´æ¥åœ¨IOçº¿ç¨‹å¤„ç†æ•°æ® context-\u0026gt;client-\u0026gt;receiveMessages([context](const char* data, size_t length) { // ç›´æ¥ä½¿ç”¨é¢„åˆ†é…ç¼“å†²åŒº memcpy(context-\u0026gt;direct_buffer, data, length); context-\u0026gt;dedicated_processor-\u0026gt;processMessage(/*...*/); }); åŸå› ï¼š\næ¶ˆé™¤çº¿ç¨‹åˆ‡æ¢å¼€é”€ å‡å°‘æ•°æ®æ‹·è´æ¬¡æ•° æä¾›ç¡®å®šæ€§çš„å¤„ç†å»¶è¿Ÿ 4. æ€§èƒ½ç›‘æ§ #struct PerformanceMetrics { std::atomic\u0026lt;uint64_t\u0026gt; message_count{0}; std::atomic\u0026lt;uint64_t\u0026gt; total_latency_ns{0}; std::atomic\u0026lt;uint64_t\u0026gt; max_latency_ns{0}; }; å®ç°äº†ç²¾ç¡®åˆ°çº³ç§’çº§çš„å»¶è¿Ÿç›‘æ§ï¼Œä¾¿äº:\nå®æ—¶ç›‘æ§ç³»ç»Ÿæ€§èƒ½ åŠæ—¶å‘ç°æ€§èƒ½é—®é¢˜ æä¾›ä¼˜åŒ–ä¾æ® 5. æ–¹æ¡ˆä¼˜åŠ¿ # å»¶è¿Ÿä¼˜åŒ– ä»å¾®ç§’çº§ä¼˜åŒ–åˆ°çº³ç§’çº§ æ¶ˆé™¤äº†é˜Ÿåˆ—å’Œçº¿ç¨‹åˆ‡æ¢å¼€é”€ æä¾›ç¨³å®šçš„å¤„ç†å»¶è¿Ÿ èµ„æºåˆ©ç”¨ CPUèµ„æºéš”ç¦» å†…å­˜è®¿é—®ä¼˜åŒ– å‡å°‘ç³»ç»Ÿè°ƒç”¨ å¯é æ€§ä¿è¯ èµ„æºè‡ªåŠ¨é‡Šæ”¾ è¿æ¥çŠ¶æ€ç›‘æ§ å¼‚å¸¸å¤„ç†æœºåˆ¶ æ˜“äºç»´æŠ¤ æ¸…æ™°çš„ä»£ç ç»“æ„ å®Œå–„çš„ç›‘æ§æŒ‡æ ‡ æ¨¡å—åŒ–è®¾è®¡ 6. å®é™…æ•ˆæœ # æ¶ˆæ¯å¤„ç†å»¶è¿Ÿé™ä½åˆ°çº³ç§’çº§åˆ« CPUåˆ©ç”¨ç‡æ›´åŠ å‡è¡¡ ç³»ç»Ÿç¨³å®šæ€§æ˜¾è‘—æå‡ å†…å­˜ä½¿ç”¨æ›´åŠ é«˜æ•ˆ 7. æ€»ç»“ #æœ¬æ–¹æ¡ˆé€šè¿‡æ·±å…¥ä¼˜åŒ–ç³»ç»Ÿåº•å±‚ï¼Œå®ç°äº†é«˜æ€§èƒ½çš„å¤šWSè¿æ¥å¤„ç†ã€‚å…³é”®åœ¨äºï¼š\nåˆç†çš„å†…å­˜ç®¡ç† ä¼˜ç§€çš„CPUäº²å’Œæ€§è®¾è®¡ é«˜æ•ˆçš„æ¶ˆæ¯å¤„ç†æœºåˆ¶ å®Œå–„çš„æ€§èƒ½ç›‘æ§ä½“ç³» è¿™äº›ä¼˜åŒ–ä½¿ç³»ç»Ÿèƒ½å¤Ÿæ»¡è¶³é«˜é¢‘äº¤æ˜“å¯¹ä½å»¶è¿Ÿçš„ä¸¥æ ¼è¦æ±‚ã€‚\n","date":"3 December 2024","permalink":"/blog/2025-06-24-multi_quote_data_processing/","section":"Blog","summary":"1. ä¸šåŠ¡èƒŒæ™¯ä¸æŒ‘æˆ˜ #åœ¨é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­ï¼Œéœ€è¦åŒæ—¶ç»´æŠ¤å¤šä¸ªWebSocketè¿æ¥ä»¥è®¢é˜…ä¸åŒäº¤æ˜“æ‰€çš„è¡Œæƒ…æ•°æ®ã€‚ä¸»è¦æŒ‘æˆ˜åŒ…æ‹¬ï¼š\néœ€è¦å¤„ç†å¤šä¸ªäº¤æ˜“æ‰€çš„å¹¶å‘è¿æ¥ å¯¹æ¶ˆæ¯å¤„ç†å»¶è¿Ÿæœ‰ä¸¥æ ¼è¦æ±‚ éœ€è¦ä¿è¯æ•°æ®å¤„ç†çš„ç¨³å®šæ€§ ç³»ç»Ÿèµ„æºï¼ˆCPUã€å†…å­˜ï¼‰çš„é«˜æ•ˆåˆ©ç”¨ 2. ä¼ ç»Ÿæ–¹æ¡ˆçš„å±€é™ #2.1 ä¼ ç»Ÿæ¶ˆæ¯é˜Ÿåˆ—æ–¹æ¡ˆ #// å¸¸è§çš„æ¶ˆæ¯å¤„ç†æµç¨‹ WebSocketæ¥æ”¶ -\u0026gt; æ¶ˆæ¯é˜Ÿåˆ— -\u0026gt; å¤„ç†çº¿ç¨‹æ±  -\u0026gt; ä¸šåŠ¡å¤„ç† å­˜åœ¨çš„é—®é¢˜ï¼š\næ¶ˆæ¯ç»è¿‡é˜Ÿåˆ—å¸¦æ¥é¢å¤–å»¶è¿Ÿ çº¿ç¨‹åˆ‡æ¢å¼€é”€å¤§ å†…å­˜æ‹·è´æ¬¡æ•°å¤š èµ„æºç«äº‰å¯¼è‡´æ€§èƒ½ä¸ç¨³å®š 3. ä¼˜åŒ–æ–¹æ¡ˆè®¾è®¡ #3.1 æ ¸å¿ƒè®¾è®¡ç†å¿µ # é›¶æ‹·è´æ•°æ®å¤„ç† CPUäº²å’Œæ€§ç»‘å®š é¢„åˆ†é…å†…å­˜ æ¯ä¸ªè¿æ¥ç‹¬ç«‹å¤„ç† 3.2 å…³é”®ç»„ä»¶è®¾è®¡ #struct ConnectionContext { // è¿æ¥åŸºç¡€ä¿¡æ¯ std::shared_ptr\u0026lt;WebSocketClient\u0026gt; client; std::string endpoint_name; // æ€§èƒ½ä¼˜åŒ–ç›¸å…³ int cpu_core{-1}; // CPUæ ¸å¿ƒç»‘å®š char* direct_buffer{nullptr}; // é¢„åˆ†é…ç¼“å†²åŒº static constexpr size_t BUFFER_SIZE = 64 * 1024; std::shared_ptr\u0026lt;MessageProcessor\u0026gt; dedicated_processor; // èµ„æºç®¡ç† ~ConnectionContext() { if (direct_buffer) { munlock(direct_buffer, BUFFER_SIZE); munmap(direct_buffer, BUFFER_SIZE); } } // ç¦ç”¨æ‹·è´ä»¥ä¿è¯èµ„æºå®‰å…¨ ConnectionContext(const ConnectionContext\u0026amp;) = delete; ConnectionContext\u0026amp; operator=(const ConnectionContext\u0026amp;) = delete; }; 3.","title":"é«˜é¢‘äº¤æ˜“åœºæ™¯ä¸‹çš„å¤šWSè¿æ¥ä½å»¶æ—¶æ–¹æ¡ˆè®¾è®¡"},{"content":"","date":null,"permalink":"/tags/others/","section":"Tags","summary":"","title":"Others"},{"content":"HSBC é€Ÿè®° æ±‡ä¸°ç§äººè´¢å¯Œè§„åˆ’\nçºè¶Šä¸–å®¶ Â· è‡»äº«æ²™é¾™ ä¸Šæµ·ç«™\nï¼ˆé€Ÿè®°ç¨¿ï¼‰\næ—¶é—´ï¼š2024 å¹´ 11 æœˆ 24 æ—¥\nåœ°ç‚¹ï¼šä¸Šæµ·æµ¦ä¸œæ–‡åä¸œæ–¹é…’åº— LG1 å±‚ä¸œæ–¹å…\nä¸»æŒäººï¼šå¥³å£«ä»¬ï¼Œå…ˆç”Ÿä»¬ï¼Œå„ä½å°Šæ•¬çš„æ¥å®¾ï¼Œæˆ‘æ˜¯é™ˆä½³æ˜Šï¼ˆéŸ³ï¼‰ï¼Œæˆ‘æ˜¯æ±‡ä¸°ç§äººè´¢å¯Œè§„åˆ’ä¸Šæµ·åˆ†åŒºæ€»ç»ç†ï¼Œæˆ‘ä»£è¡¨ä¸Šæµ·æ±‡ä¸°ç§äººè´¢å¯Œè§„åˆ’æ¬¢è¿å„ä½çš„è…ä¸´ã€‚\nä»Šå¤©æœ‰å¾ˆå¤šæ–°æœ‹å‹ï¼Œä¹Ÿæœ‰å¾ˆå¤šè€æœ‹å‹ï¼Œæˆ‘åœ¨å‘¨äº”çš„æ—¶å€™é—®è¿‡åå°åŒäº‹æŠ¥åæŠ¥äº†å¤šå°‘äº†ï¼Œä»–å‘Šè¯‰æˆ‘ä»¬å·²ç»å¿«è¦æ¥è¿‘ 200 äººäº†ï¼Œä½†ä»ä»Šå¤©çš„è§„æ¨¡æ¥çœ‹ï¼Œæˆ‘æ„Ÿè§‰å¥½åƒä»Šå¤©çš„äººæ•°è¿˜è¦å†è¶…è¿‡ä¸€äº›ã€‚\nå½“ç„¶äº†ï¼Œæœ‰ä¸€äº›æ˜¯åŸå…ˆçš„è€å®¢æˆ·ï¼Œä¹Ÿæœ‰å¾ˆå¤šæ˜¯æ…•åè€Œæ¥ï¼Œçœ‹åˆ°è¿™æ¬¡é‚€è¯·çš„æ˜¯ä»˜é¹å…ˆç”Ÿï¼Œæ‰€ä»¥æ…•åè€Œæ¥ã€‚ä¹Ÿæœ‰ä¸€äº›æ–°æœ‹å‹ã€‚åœ¨ä»˜é¹å…ˆç”Ÿä¸Šå°ä¹‹å‰ï¼Œè¯·å…è®¸æˆ‘å¯¹æ±‡ä¸°ç§äººè´¢å¯Œè§„åˆ’åšç®€çŸ­çš„ä»‹ç»ã€‚\næ±‡ä¸°ç§äººè´¢å¯Œè§„åˆ’æ˜¯å…¨çƒçš„æˆ˜ç•¥é‡ç‚¹ä¹‹ä¸€ï¼Œè€æœ‹å‹éƒ½çŸ¥é“ï¼Œæ±‡ä¸°ç§äººè´¢å¯Œè§„åˆ’æˆç«‹äº 2020 å¹´ï¼Œè·ä»Šåˆšå¥½å››å¹´ï¼Œåœ¨å››å¹´çš„è¿‡ç¨‹ä¸­é›†å›¢ä¸€ç›´åœ¨ç»™æˆ‘ä»¬å¤§åŠ›æ³¨èµ„ï¼Œä¹Ÿæ˜¯é›†å›¢é‡Œæœ€é‡è¦çš„é¡¹ç›®ä¹‹ä¸€ã€‚\nä¸ºä»€ä¹ˆèšç„¦åœ¨ä¸­å›½å¸‚åœºä¸Šï¼Ÿå¤§å®¶å¾ˆå¤šäººéƒ½æ˜ç™½ï¼Œä¸­å›½ä¸­äº§é˜¶çº§çš„äººæ•°åœ¨ä¸–ç•Œä¸Šå æœ‰é‡æ˜¯æœ€åºå¤§çš„ï¼Œéšç€ä¸­å›½ç»æµçš„é«˜é€Ÿå‘å±•ï¼Œä¸­å›½äººè´¢å¯Œç®¡ç†çš„éœ€æ±‚é€æ­¥æå‡åˆ°å¾ˆé«˜çš„æ°´å‡†ã€‚æ‰€ä»¥ï¼Œç§äººè´¢å¯Œè§„åˆ’ä¹Ÿä¼šå˜æˆæ±‡ä¸°çš„é‡è¦æˆ˜ç•¥ä¹‹ä¸€ã€‚\nä»‹ç»ä¸€ä¸‹å‘å±•å†å²ï¼Œä» 2020 å¹´æ±‡ä¸°ç§äººè´¢å¯Œè§„åˆ’æˆç«‹ï¼Œå…ˆæ˜¯åœ¨ä¸Šæµ·å’Œå¹¿å·ï¼Œæ€»éƒ¨ç¦»è¿™é‡Œä¸è¿œï¼Œæ±‡ä¸°æ€»éƒ¨å°±åœ¨å›½é‡‘ï¼Œæ¬¢è¿å¤§å®¶å»åä¸€åã€‚é€æ­¥è¿›å…¥åˆ°æ­å·ã€æ·±åœ³ã€åŒ—äº¬ã€ä½›å±±ï¼Œä»Šå¹´åœ¨è‹å·ã€æˆéƒ½å¼€ç«‹äº†åˆ†æ”¯æœºæ„ã€‚\n2020 å¹´æ±‡ä¸°ç§äººè´¢å¯Œè§„åˆ’æ‰åˆšåˆšæˆç«‹ï¼Œé‚£æ±‡ä¸°çš„å†å²åˆæ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿæ±‡ä¸°ç®€ç§°å« HSBCï¼Œå¾ˆå¤šäººä¼šé—® HSBC å››ä¸ªå­—æ¯åˆ†åˆ«ä»£è¡¨ç€ä»€ä¹ˆï¼Œå¯ä»¥è·Ÿå¤§å®¶ç®€å•ä»‹ç»ä¸€ä¸‹ï¼ŒH ä»£è¡¨çš„æ˜¯é¦™æ¸¯çš„æ„æ€ï¼ŒS ä»£è¡¨çš„æ˜¯ä¸Šæµ·çš„æ„æ€ã€‚å¾ˆå¤šäººå°è±¡ä¸­ä»¥ä¸ºæ±‡ä¸°æ˜¯ä¸€å®¶å¤–èµ„é“¶è¡Œï¼Œä½†å…¶å®å¤§å®¶æœ‰æ‰€ä¸çŸ¥ï¼Œå…¶å®æ±‡ä¸°åœ¨æ¸…æœçš„æ—¶å€™å°±åœ¨å¤–æ»©å·²ç»è®¾ç«‹äº†æ€»éƒ¨ï¼Œç°åœ¨è¿™æ ‹æ¥¼äº¤ç»™äº†æµ¦å‘é“¶è¡Œã€‚1949 å¹´ä¹‹åï¼Œæ±‡ä¸°å› ä¸ºå†å²çš„åŸå› é€€å‡ºäº†ä¸­å›½ï¼Œåœ¨ WTO ä¹‹åå›åˆ°äº†ä¸­å›½ã€‚\næ±‡ä¸° 1865 å¹´æˆç«‹è‡³ä»Šå·²ç»æœ‰ 100 å¤šå¹´äº†ï¼Œé‚£æ—¶å€™è¿˜æ˜¯æ¸…æœçš„åŒæ²»å¹´é—´ï¼ŒåŒæ—¶å·²ç»åœ¨å…¨çƒçš„ 62 ä¸ªå›½å®¶è¿˜æœ‰ 3900 å¤šåå®¢æˆ·ï¼Œè¿™æ®µå†å²å’Œè¿™ä¹ˆå¤§çš„åˆ†å¸ƒä¹Ÿæ˜¯æ±‡ä¸°å¾ˆå¤šåŒäº‹å†…å¿ƒçš„éª„å‚²ã€‚æˆ‘ä»¬è·Ÿå¾ˆå¤šå®¢æˆ·åšæ²Ÿé€šçš„æ—¶å€™ï¼Œç»å¸¸ä¼šæŠŠè¿™æ®µå†å²æ‹¿å‡ºæ¥è·Ÿå¤§å®¶è®²ä¸€è®²ï¼Œå°±åƒè¿™å¤´çŸ³ç‹®å­ï¼Œå¾ˆå¤šäººéƒ½è§è¿‡ï¼Œä½†å¾ˆå¤šäººéƒ½ä¸çŸ¥é“å®ƒçš„å†å²ï¼Œå¾ˆå¤šäººåœ¨æµ·æŠ¥ã€å¹¿å‘Šã€æ¸¯å…ƒå¤§é’ä¸Šçœ‹è¿‡è¿™ä¸ªçŸ³ç‹®å­ï¼ŒåŸæ¥åœ¨å¤–æ»©ä¸Šä¹Ÿæœ‰ä¸¤åº§ï¼Œç°åœ¨æ”¾åœ¨ä¸Šæµ·åšç‰©é¦†é‡Œï¼Œå‰ä¸€é˜µå„¿æˆ‘åœ¨åšç‰©é¦†å‚è§‚çš„æ—¶å€™è¿˜çœ‹åˆ°äº†è¿™ä¸¤åªçŸ³ç‹®å­ï¼Œä¸Šé¢è¿˜æœ‰å¾ˆå¤šå†å²çš„ç—•è¿¹ï¼Œæ¯”å¦‚è¯´æˆ˜äº‰è€Œç•™ä¸‹çš„å¼¹å­”ï¼Œå°±åœ¨äººæ°‘å¹¿åœºçš„åšç‰©é¦†é‡Œï¼Œå¤§å®¶æœ‰å…´è¶£çš„è¯å¯ä»¥å»çœ‹ä¸€ä¸‹ã€‚\nè´¢å¯Œå¤§çŸ©é˜µä¸ä¸­å›½å†…åœ°å¸‚åœºï¼Œæ±‡ä¸°é›†å›¢å¯¹äºä¸­å›½ç§äººè´¢å¯Œè§„åˆ’ä¸šåŠ¡çš„é‡è§†ç¨‹åº¦ï¼Œåœ¨å¤§çŸ©é˜µä¸­æ‰¿æ‹…äº†å¾ˆé‡è¦çš„åœ°ä½ã€‚\næ¯ 100 ä½å®¢æˆ·ä¸­ï¼Œä¼šæœ‰ 87 ä½å®¢æˆ·å°†æ±‡ä¸°ç§äººè´¢å¯Œè§„åˆ’è§†ä½œä¸ºæä¾›è´¢å¯Œé‡è¦çš„ä¸»è¦å“ç‰Œï¼Œæå‡ºäº†å¾ˆå¤šå¥½è¯„ï¼Œ82% çš„è°ƒç ”è€…æ‰“å‡º 9-10 åˆ†çš„é«˜åˆ†ã€‚\nä¹Ÿæœ‰ä¸€äº›æ¯”è¾ƒæœ‰æ„æ€çš„è¯ï¼Œå¦‚ï¼šâ€œå¯¹äº§å“å†…å®¹çš„ä¿éšœæ»¡æ„ï¼Œå…¬å¸å¤§æœ‰ä¿éšœï¼›ç”„æ±‡ç”Ÿæ´»æœ‰ä¸€å®šçš„å¸å¼•åŠ›ï¼Œæ±‡ä¸°çš„äº§å“è¾ƒè´µä½†ä¹Ÿæ„¿æ„ä¹°ï¼Œå› ä¸ºå¯¹æ±‡ä¸°ç§äººè´¢å¯Œè§„åˆ’å¸ˆçš„è®¤å¯ã€‚â€\nè¿™ä¸¤å¹´æå‡ºä¸€å¥æ¯”è¾ƒæ–°çš„ Sloganâ€œæ‡‚ä½ å…³å¿ƒçš„ï¼Œç»™ä½ å®‰å¿ƒçš„â€ã€‚\nä»Šå¤©çš„æ´»åŠ¨æˆ‘ä»¬é‚€è¯·åˆ°äº†ä¸€ä½é‡é‡çº§å˜‰å®¾ï¼Œä»–æ›¾ä»»èŒäºé›·æ›¼å…„å¼Ÿã€æ‰€ç½—é—¨æŠ•èµ„é›†å›¢ç­‰å…¨çƒé¡¶å°–é‡‘èæœºæ„ï¼Œä»äº‹å¯¹å†²åŸºé‡‘ç­‰ç›¸å…³å·¥ä½œã€‚ä»–å°±æ˜¯ä¸œåŒ—è¯åˆ¸é¦–å¸­ç»æµå­¦å®¶ä»˜é¹å…ˆç”Ÿã€‚è®©æˆ‘ä»¬æ¬¢è¿ä»˜é¹å…ˆç”Ÿä¸ºæˆ‘ä»¬å¸¦æ¥ã€Š2024 å¹´å¹´ç»ˆå›é¡¾å’Œ 2025 å¹´å±•æœ›â€”â€”å¯¹å†²é£é™© VS è½¯ç€é™†ã€‹ä¸»é¢˜åˆ†äº«ï¼Œæœ‰è¯·ä»˜é¹å…ˆç”Ÿï¼\nä»˜é¹ï¼šæ­£å€¼å¹´åº•ï¼Œè™½ç„¶åˆšæ‰æ±‡ä¸°ä¸€ç›´å¼ºè°ƒå¤§å®¶ä¸å½•éŸ³ä¸å½•åƒï¼Œä½†å¤§æ¦‚ç‡ä½ æŒ¡ä¸ä½ã€‚æˆ‘åœ¨è¿™å„¿è®²è¯ä¼šè°¨æ…ä¸€äº›ï¼Œéå¸¸å°å¿ƒè°¨æ…ï¼Œå¤§æ¦‚ç‡ä¼šæœ‰äººé€éœ²å‡ºå»ï¼Œæ”¾åˆ° YouTube ä¸Šï¼ŒåŸºæœ¬ä¸Šæ‰€æœ‰è§æˆ‘éƒ½è¯´ä»˜æ€»æˆ‘åœ¨ YouTube ä¸Šçœ‹è¿‡ä½ çš„è§†é¢‘ï¼Œæˆ‘è¯´é‚£éƒ½æ˜¯ç›—ç‰ˆçš„ï¼Œé ç›—ç‰ˆå‘è´¢çš„ä¹Ÿä¸å°‘ã€‚\nä»Šå¤©å’Œå¤§å®¶åˆ†äº«çš„å†…å®¹åŸºæœ¬ä¸Šéƒ½æ˜¯å®˜æ–¹çš„ï¼Œå›é¡¾ä¼šå¤šä¸€ç‚¹ï¼Œå±•æœ›ä¸å¤šï¼Œå› ä¸ºè¿™ä¸ªæœˆå±•æœ›å®Œäº†ä¹‹åä¸‹ä¸ªæœˆæ€ä¹ˆåŠï¼Ÿæœ‰äº›è¯å¯¹æˆ‘æ¥è®²æˆ‘å€’è§‰å¾—å¾ˆç®€å•ï¼Œæœ¬è´¨ä¸ŠåŸæ¥æˆ‘ä»¬æ˜¯åš Hedge Fund å‡ºèº«ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„é€»è¾‘æ¡†æ¶æ•´ä½“å…·æœ‰æå¼ºçš„å»¶ç»­æ€§ï¼Œä¸æ˜¯è¯´ä»Šå¹´å»è®¨è®ºï¼Œæˆ–è€…è¯´æ˜å¹´å»è®¨è®ºã€‚\næƒ¯æ€§æ€ç»´ä» 2016 å¹´å¼€å§‹ï¼Œæˆ‘ä¸€ç›´åœ¨è·Ÿå¤§å®¶å¼ºè°ƒè¿™ä¸ªä¸–ç•Œå·²ç»å®Œå…¨ä¸ä¸€æ ·äº†ã€‚å½“ç„¶ç»å†è¿‡è¿‡å»çš„å‡ å¹´æ—¶é—´ï¼Œæˆ‘ç›¸ä¿¡åœ¨åº§å„ä½åº”è¯¥å¯¹è¿™ç•ªè¯çš„ç†è§£å˜å¾—è¶Šå‘æ·±åˆ»ã€‚\n2016 å¹´å®é™…ä¸Šæ˜¯ç¾å›½ç‰¹æœ—æ™®çš„ç¬¬ä¸€æ¬¡å¤§é€‰ï¼Œæˆ‘æœ‰ä¸€ä¸ªç‰¹ç‚¹ï¼Œæˆ‘çš„ç‰¹å¾æ˜¯å¦‚æœæˆ‘è§‰å¾—ä»€ä¹ˆåœ°æ–¹æœ‰æŠ•èµ„æœºä¼šï¼Œæˆ‘å¯èƒ½ç¬¬ä¸€æ—¶é—´å»ä¸€çº¿è°ƒç ”ï¼Œæˆ‘ä¸å–œæ¬¢çœ‹ YouTubeï¼Œæˆ‘ä¹Ÿä¸å–œæ¬¢åœ¨ç½‘ä¸Šæ‰’ã€‚å½“ç„¶ä½ ä¼šè¯´ï¼Œç°åœ¨ ChatGPT å¾ˆå¼ºå¤§äº†ï¼Œäººå·¥æ™ºèƒ½å¥½åƒèƒ½å¸®ä½ è§£å†³å¾ˆå¤šé—®é¢˜ï¼Œä½†ä½ ä»¬æœ‰æ²¡æœ‰æƒ³è¿‡ï¼Œå¯èƒ½å¹¿æ³›æµä¼ æˆ–è€…å¹¿æ³›ä¼ æ’­çš„å¾ˆå¤šä¿¡æ¯æ˜¯é”™çš„ã€‚è¿™ä¸€ç‚¹åœ¨ 2012 å¹´å½“æ—¶æˆ‘ä»æ—¥æœ¬åšå®Œè°ƒç ”å›æ¥ä¹‹åï¼Œæˆ‘çš„æ„Ÿæ‚Ÿæ˜¯æœ€æ·±çš„ã€‚\nå½“ç„¶å»æ—¥æœ¬æœ‰ä¸€ä¸ªé‡è¦çš„äººç‰©ï¼Œåå­—å«æœ¬æ£®ç‰¹ï¼Œå¾ˆå¿«å¤§å®¶å°±ä¼šéå¸¸ç†Ÿæ‚‰ä»–çš„ï¼Œç›®å‰æ¥è®²åº”è¯¥æ˜¯ç‰¹æœ—æ™®æ”¿åºœæåçš„ç¾å›½è´¢é•¿ã€‚æœ¬æ£®ç‰¹åŸæ¥æ˜¯ç´¢ç½—æ–¯åŸºé‡‘å®é™…æŒæ§äººï¼Œå› ä¸ºç´¢å¤§çˆ·å·²ç»å¹´é¾„å¾ˆå¤§äº†ï¼Œå»å¹´çš„æ—¶å€™æ‰åˆšåˆšæŠŠåŸºé‡‘çš„ä¸šåŠ¡äº¤ç»™ä»–å„¿å­äºšå†å±±å¤§ï¼Œä½†åœ¨è¿™ä¹‹å‰ï¼Œæœ€ä¸»è¦çš„å‡ åœºæˆ˜å½¹æœ¬è´¨ä¸Šæ¥è®²éƒ½æ˜¯æœ¬æ£®ç‰¹åœ¨ä¸»å¯¼ã€‚\n2012 å¹´å½“æ—¶æˆ‘ä»åŒ—äº¬å»é¦™æ¸¯çº¦æœ‹å‹ä»¬åƒé¥­çš„é¥­å±€ä¸Šï¼Œå½“æ—¶æ–¯ç´¢ç½—æ–¯åŸºé‡‘åœ¨é¦™æ¸¯åŠå…¬å®¤è·Ÿæˆ‘è¯´ï¼Œæœ¬æ£®ç‰¹ä»è¿™å„¿å»äº†æ—¥æœ¬ã€‚æˆ‘è¯´ OKã€‚æˆ‘ç»å¸¸è¯´ä¸€å¥è¯ â€œç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šçœ‹é—®é¢˜ã€‚â€\nå½“ç„¶ä½ çŸ¥é“ï¼Œç½‘æ°‘ä»¬æœ€å¯æ€•çš„åœ°æ–¹æ˜¯å·´è²ç‰¹ â€œSBâ€ã€ç´¢ç½—æ–¯ â€œSBâ€ï¼Œæˆ‘æœ€ â€œç‰›é€¼â€ã€‚ä½ è¦è®°ä½ï¼Œä»–ä»¬çš„æ‰€æœ‰è¡Œä¸ºä¸€å®šæœ‰å¾ˆå¤§çš„å˜åŒ–ï¼Œå¾ˆå¤šäººå¯èƒ½éƒ½ä¸çŸ¥é“ï¼Œå·´è²ç‰¹ç¬¬ä¸€æ¬¡å»æ˜¯ 2011 å¹´ï¼Œæˆ‘ä»¬æ­£åœ¨è®²ç¦å²›æ ¸ç”µç«™æ³„æ¼ï¼Œæ ¸åºŸæ°´æ±¡æŸ“ä»¥åæµ·é²œä¸èƒ½åƒçš„æ—¶å€™ï¼Œä¸€ä¸ª 80 å¤šå²çš„è€å¤´é¡¶ç€æ ¸è¾å°„æ³„æ¼å»æ—¥æœ¬åƒæµ·é²œäº†ï¼Œå½“ç„¶ä»–å»æ—¥æœ¬å¹²å—ï¼Œè¿™å…¶å®å¾ˆå…³é”®ã€‚\nä¹‹åæˆ‘ä»¬è·‘åˆ°æ—¥æœ¬åšå®Œè°ƒç ”å›æ¥ä¹‹åé‚£å‡ å¹´ï¼Œæˆ‘é™†é™†ç»­ç»­è·Ÿå¾ˆå¤šäººè®²ï¼Œæ—¥æœ¬æ­£åœ¨å‘ç”Ÿå˜åŒ–ï¼Œæ—¥æœ¬çš„åˆ©ç‡ç»“æ„éƒ½ä¼šéšä¹‹å˜åŒ–çš„ï¼Œå½“ç„¶åŒ…æ‹¬æ—¥æœ¬çš„è¯åˆ¸å¸‚åœºã€‚ä»Šå¹´æ—¥æœ¬è‚¡å¸‚ç»ˆäºèµ°å‡ºè¿™ 35 å¹´äº†ï¼Œåˆ›ä¸‹äº†å†å²æ€§çºªå½•ã€‚\nä½†ç½‘ä¸Šå¾ˆå¤šäººè¿˜åœ¨è¯´ï¼Œæˆ‘ä»ç»æµæ•°æ®é‡Œå¥½åƒæ²¡çœ‹å‡ºä»€ä¹ˆçŠ¶å†µæ¥ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬è¯´çš„ â€œä¿¡æ¯å·®â€ï¼Œå› ä¸ºæœ‰æ—¶å€™ä½ çŸ¥é“äººçš„ç†è§£ï¼Œå¯¹ç¤¾ä¼šçš„ç†è§£ï¼Œå¯¹ç»æµçš„ç†è§£å¸¦æœ‰æƒ¯æ€§æ€ç»´ã€‚å‰å‡ å¹´æˆ‘ç»å¸¸æ™®åŠçš„ä¸€ç‚¹æ˜¯å…³äºæ—¥æœ¬çš„ç†è§£ï¼Œå¾ˆå¤šäººæ€»åœ¨æƒ³ç»æµå¢é•¿ï¼Œæœ‰æ²¡æœ‰ä¸€ç§å¯èƒ½æ€§ç»æµä¸å¢é•¿ä¹Ÿå¾ˆçˆ½å‘¢ï¼Ÿæ¯”å¦‚è¯´ä¸­å›½è¿‡å»ä¸‰å››åå¹´æ”¹é©å¼€æ”¾ä¹‹åæˆ‘ä»¬ä¹ æƒ¯çš„å°±æ˜¯ç»æµè¦å¢é•¿ï¼Œç»æµä¸å¢é•¿æˆ‘ä»¬å°±å¾ˆéš¾è¿‡ï¼Œä½ æœ‰æ²¡æœ‰æƒ³è¿‡ä¸€ç§ä¸å¢é•¿è¿˜ä¼šæŠŠè›‹ç³•åƒå¤šçš„æ–¹æ³•å‘¢ï¼Ÿç­”æ¡ˆæ˜¯åˆ†é…ï¼Œä½ æ€ä¹ˆè€æƒ³ç€åˆ†å·¥ã€åŠªåŠ›ã€å·¥ä½œã€å¹²æ´»å„¿ã€æŒ£é’±ã€å¢é•¿ï¼Œæœ‰æ²¡æœ‰å¦å¤–ä¸€ç§å¯èƒ½æ€§æ˜¯è¿›è¡Œå†åˆ†é…ï¼Ÿ\nä½ å¯¹æ—¥æœ¬çš„ç†è§£ä¸ºä»€ä¹ˆè¦å¢é•¿ï¼Ÿç”¨æˆ‘çš„è¯è¯´åœ¨è¿‡å» 30 å¹´çš„æ—¶é—´é‡Œä¿æŒç€è¿™å—è›‹ç³•æ²¡æœ‰å˜ï¼Œä½†ç°åœ¨è¿œç«¯åˆ©ç‡æŠ¬èµ·æ¥çš„æ ¹æœ¬åŸå› æ˜¯å› ä¸ºå¹´è½»äººå¯ä»¥åƒå¤šäº†ï¼Œå¹´è½»äººä¸ºä»€ä¹ˆå¯ä»¥åƒå¤šäº†ï¼Ÿä½ ä»¬çŸ¥é“ 2012 å¹´æ—¥æœ¬çš„æ­»äº¡æ•°æ®æ˜¯ä»€ä¹ˆå—ï¼Ÿä½ æœ‰æ³¨æ„è¿‡ä»–çš„äººå£ç»“æ„å˜åŒ–å—ï¼Ÿåˆ°äº†ä»Šå¤©ä¸ºæ­¢ï¼Œä½ çªç„¶ä¹‹é—´å‘ç°æ—¥æœ¬ç°åœ¨æ‹›è˜æ€ä¹ˆä¼šæ˜¯åº”è˜çš„åœ¨ä¸‹é¢åç€ï¼Œæ‹›è˜çš„åœ¨ä¸Šé¢ç«™ç€ï¼Ÿæ”¾å¿ƒï¼Œä¸­å›½ç°åœ¨ä¸æ˜¯æ‹›è˜çš„é—®é¢˜ï¼Œæ˜¯ HR ç äººçš„é—®é¢˜ï¼Œè¿™ç§å˜åŒ–çš„æ ¹å› åˆ°åº•æ¥è‡ªäºä»€ä¹ˆï¼Ÿå…¶å®å¾ˆå¤šäººåªæ˜¯æƒ¯æ€§æ€ç»´ï¼Œä½ ä¸ä¸€å®šèƒ½çœ‹æ‡‚ä¸–ç•Œã€‚\nè¿‡å» 40 å¹´å·²ç»å‘ç”Ÿç¿»å¤©è¦†åœ°çš„å˜åŒ–äº†ï¼Œä» 2016 å¹´å¼€å§‹ï¼Œä¸­å›½ä¹Ÿä¸å†æ˜¯è¿‡å» 40 å¹´çš„ä¸­å›½ï¼Œç¾å›½ä¹Ÿä¸å†æ˜¯è¿‡å» 40 å¹´çš„ç¾å›½ï¼Œæ—¥æœ¬ä¹Ÿä¸å†æ˜¯è¿‡å» 40 å¹´çš„æ—¥æœ¬ï¼Œä¸œå—äºšä¹Ÿä¸å†æ˜¯è¿‡å» 40 å¹´çš„ä¸œå—äºšï¼Œä½ èµ„æœ¬è¿è½¬çš„é€»è¾‘æ¡†æ¶éƒ½åœ¨å‘ç”Ÿç€å·¨å˜ï¼Œè€Œè¿™ç§æ—¶åˆ»ä¸‹ï¼Œå¦‚æœä½ ä¿æŒç€è¿‡å»çš„æ€ç»´ï¼Œä½ å¹¶ä¸èƒ½ç†è§£æˆ‘åœ¨è®²ä»€ä¹ˆã€‚\næˆ‘åªèƒ½è¯´ï¼Œå¤§å®¶ä¸€åˆ‡çœ‹ç¼˜åˆ†ï¼Œæˆ‘ä¸éœ€è¦å®Œå…¨è¯´ â€œä»˜æ€»åœ¨èƒ¡è¯´ï¼Œæˆ‘å¹¶ä¸è®¤åŒâ€ï¼Œæ— æ‰€è°“çš„ï¼Œä½ èƒ½å¬æ‡‚ä½ å°±å¬æ‡‚ï¼Œä½ èƒ½æ—©ç†è§£ä½ å°±æ—©ç†è§£ï¼Œæ—©ç†è§£ä½ å°±èƒ½é¡ºç€è¿™æ¡çº¿ Get åˆ° 2016 å¹´ä¹‹åä¸–ç•Œå‘ç”Ÿçš„å·¨å˜ã€‚\næœ€æ–°çš„ç¾å›½å¤§é€‰ï¼Œç‰¹æœ—æ™®é‡æ–°ä¸Šæ¥ï¼Œä½†è¿™æ¬¡ä¸Šæ¥è·Ÿ 2016 å¹´åˆä¸ä¸€æ ·äº†ï¼Œå› ä¸ºä»–æ¯” 2016 å¹´å˜çš„æ›´åŠ å³ç¿¼åŒ–äº†ï¼Œ2016 å¹´å¤§çš„æ”¿æ²»è½¬å˜æœ¬è´¨ä¸Šå°±æ˜¯é€†å…¨çƒåŒ–å’Œå³ç¿¼åŒ–ã€‚2016 å¹´æˆ‘æŠŠæˆ‘è‡ªå·±çš„ä¹¦ç¨¿æ•´ç†è¿‡ä¸€ç‰ˆï¼Œå½“å¹´ä¹Ÿæ²¡ç©ºæ²¡æ—¶é—´æŠŠè¿™ä¸ªä¸œè¥¿å‡ºç‰ˆï¼Œå»å¹´å› ä¸ºæˆ‘ä»¬å®¶å­©å­å›æ¥ä»¥ååšäº†ä¼ åª’å…¬å¸ï¼ŒåŸåˆ™ä¸Šæ¥è®²æˆ‘å°±æŠŠä¹¦ç¨¿é€ç»™ä»–ä½œä¸ºä¼ åª’å…¬å¸çš„ä¸€éƒ¨åˆ†å‡ºç‰ˆä¸šåŠ¡å»åšï¼Œè¿™å°±æ˜¯å¤§å®¶åæ¥è§åˆ°çš„ã€Šè§è¯é€†æ½®ã€‹ã€‚ä½†è¿™æœ¬ä¹¦ä¸å®Œæ•´ï¼Œå…¨æ–‡å°†è¿‘ 70 ä¸‡å­—ï¼Œä½ ä»¬æ‹¿åˆ°æ‰‹çš„åªæœ‰ 50 ä¸‡å­—ï¼Œä¸­é—´å·®ä¸å¤šæœ‰ 20 ä¸‡å­—è¢«åˆ å‡æ‰äº†ï¼Œè¿™ 20 ä¸‡å­—å…¶å®éå¸¸å…³é”®ï¼Œæ¶‰åŠåˆ°æˆ‘ä»¬å¯¹ä¸–ç•Œå¤§ç±»èµ„äº§é¡¶å±‚é€»è¾‘çš„æ ¸å¿ƒæ¡†æ¶ï¼Œé‡‘å­—å¡”ç©¶ç«Ÿæ˜¯ä»€ä¹ˆï¼Ÿåº•å±‚æ˜¯æˆ‘ä»¬çš„æ‰€æœ‰èµ„äº§å’Œå¸‚åœºï¼Œå¸‚åœºå…¶å®æ˜¯åœ¨æ¡†æ¶ä¸­æœ€åº•å±‚çš„ï¼Œå¤§å®¶å¤©å¤©æƒ³é—®çš„æˆ¿ä»·çš„ä¸Šæ¶¨ã€è‚¡ç¥¨ä»·æ ¼ï¼Œè¿™å®é™…ä¸Šæ˜¯é‡‘å­—å¡”ä¸­æœ€åº•å±‚çš„ã€‚\nç¨å¾®å¾€ä¸Šä¸€ç‚¹æœ‰äººè¯´å®è§‚ç»æµå¾ˆé‡è¦ï¼Œå°¤å…¶æ˜¯ä¸­å›½ 2008 å¹´æ¬¡è´·å±æœºç»“æŸä¹‹åï¼Œä¸­å›½çš„æŠ•èµ„äººå¼€å§‹å‘ç”Ÿå·¨å˜ï¼Œ2008 å¹´é‡‘èå±æœºä¹‹å‰ï¼Œä¸­å›½å¤§éƒ¨åˆ†æŠ•èµ„äººè®²çš„æ˜¯ â€œæ“’é¾™å¤§æ³•â€ï¼Œå¦‚ä½•æŠ“æ¶¨åœã€‚ä½† 2008 å¹´çš„æ¬¡è´·å±æœºï¼Œå…¨çƒçš„å†²å‡»ä½¿å¾—å¾ˆå¤šä»äº‹é‡‘èäº¤æ˜“ã€èµ„äº§äº¤æ˜“çš„äººå¼€å§‹æ„è¯†åˆ°ï¼ŒåŸæ¥å…¨çƒé‡‘èå¸‚åœºæ˜¯è¿™æ ·çš„ï¼Œæ˜¯è”åŠ¨çš„ã€‚è‡ªé‚£ä¸€åˆ»èµ·ï¼ŒçœŸæ­£æ„ä¹‰ä¸Šçš„é‡‘èæ‰å¼€å§‹åœ¨ä¸­å›½æ…¢æ…¢ç”Ÿæ ¹å‘èŠ½ã€‚\nç¨å¾®æœ‰äººå¼€å§‹æ„è¯†åˆ°å®è§‚ç»æµçš„é‡è¦æ€§ï¼Œå½“ç„¶åƒç°åœ¨è¯ç›‘ä¼šçš„é¦–ç»å›¢é˜Ÿä¸­ï¼Œ36 ä¸ªé¦–ç»é‡Œï¼Œæˆ‘ä¸€ç›´è¯´æˆ‘æ˜¯é‚£ä¸ªæœ€ä¸æ­£ç»çš„ï¼Œå› ä¸ºæˆ‘åˆä¸æ˜¯æå­¦æœ¯çš„ï¼Œæˆ‘ä¹Ÿä¸æ˜¯ææ”¿åºœå‡ºèº«çš„ï¼Œæˆ‘æ˜¯å¸‚åœºä¸€çº¿çš„ï¼Œæˆ‘ä»¬å¯¹å¾ˆå¤šé—®é¢˜çš„ç†è§£æ˜¯å®Œå…¨ä¸åŒçš„ã€‚\nå‰ä¸¤å¤©çš„æ—¶å€™ï¼Œåœ¨ Fox News ä¸Šï¼Œæœ¬æ£®ç‰¹å’Œå‡ ä¸ªè¯ºè´å°”ç»æµå­¦å®¶åœ¨é‚£å„¿äº‰åµå…³äºå…³ç¨ä½œç”¨çš„æ—¶å€™ï¼Œä½ å°±çªç„¶é—´å‘ç°ï¼Œä¸€ä¸ªç«™åœ¨å¸‚åœºè§’åº¦ä¸Šçš„äººç†è§£å…³ç¨ä½œä¸ºä¸€ä¸ªæ‰‹æ®µåˆ°åº•èµ·åˆ°ä»€ä¹ˆæ ·çš„ä½œç”¨ï¼Œå’Œé‚£å¸®è€å­¦ç©¶ä»¬å»è®²çš„ï¼Œç”šè‡³è·Ÿåœ¨åº§å„ä½åœ¨æ–°é—»è”æ’­ä¸Šçœ‹åˆ°çš„å…³ç¨æè¿° â€œç¾å¸å›½ä¸»ä¹‰æ‰“å…³ç¨ï¼Œä½¿å¾—è€ç™¾å§“ç”Ÿæ´»åœ¨æ°´æ·±ç«çƒ­ä¸­â€ï¼Œä½ ä¼šå‘ç°å¥½åƒä½ èªæ˜ç‚¹çš„è¯å°±çŸ¥é“å¥½å¤šä¸œè¥¿å¹¶ä¸å¯¹ï¼Œè¿™å°±æ˜¯å·®å¼‚æ€§ã€‚è¿™æ¬¡ç‰¹æœ—æ™®ç»„æˆçš„ç¬¬ä¸€æ˜¯å®æƒæ´¾ï¼Œç¬¬äºŒæ˜¯é€šæ€äº†ï¼Œå¯ä»¥ç†è§£å³ç¿¼åŒ–å·²ç»å®Œå…¨æ²¡æœ‰ç‰µåˆ¶äº†ï¼Œç¬¬ä¸‰ä¸Šæ¥çš„å…¨æ˜¯å®å¹²æ´¾ã€‚ä½ çŒœåé¢çš„ç»“æœæ˜¯ä»€ä¹ˆï¼Ÿè¿™åœºä»—å¯ä¸å¥½æ‰“ï¼Œæ¯” 2016 å¹´é‚£ä¸€å±Šè¿˜éš¾æ‹¿ã€‚\nå†å¾€ä¸Šæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæœ‰äººè¯´ç»ˆäºè®²åˆ°äº†æ”¿æ²»ï¼Œæ²¡é”™ï¼Œå†å¾€ä¸Šæ˜¯æ”¿æ²»ï¼Œæ°‘ä¸»å…šã€å…±å’Œå…šã€å…¨çƒæ”¿æ²»çš„å˜åŠ¨ã€‚ä½†å†å¾€ä¸Šçš„é¡¶å±‚ï¼Œé‡‘å­—å¡”çš„æœ€æ ¸å¿ƒæ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Ÿå®é™…ä¸Šæ˜¯æ„è¯†å½¢æ€ã€‚\næˆ‘æ•™å¾ˆå¤šç ”ç©¶å‘˜è¯´ä½ ä»¬åœ¨ç ”ç©¶ä¸–ç•Œç»æµçš„æ—¶å€™åˆ«ç›²ç›®åœ°åšç®€å•çš„å¯¹æ¯”ï¼Œæˆ‘ä¼°è®¡å¾ˆå¤šç ”ç©¶æŠ¥å‘Šéƒ½ä¼šçŠ¯è¿™æ ·çš„é”™è¯¯ï¼ŒåŠ¨ä¸åŠ¨å°±åšå¯¹æ¯”ï¼Œå’Œ 70 å¹´ä»£ã€80 å¹´ä»£åšå¯¹æ¯”ï¼Œè¿™ç§å¯¹æ¯”çº¯ç²¹å†™æŠ¥å‘Šå‡‘å­—æ•°çš„ï¼Œæ¢æˆæˆ‘çš„è§’åº¦ï¼Œæˆ‘éƒ½ä¸ä¼šçœ‹å®Œç›´æ¥æ’•äº†å°±æ‰”åƒåœ¾æ¡¶äº†ï¼Œæˆ‘å…¶å®æŒºå¿ƒç–¼è¿™äº›åˆ¸å•†ç ”ç©¶å‘˜çš„ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿæ˜¯ä¸ªäº‹å„¿å°±å¾—å†™ä¸ªæŠ¥å‘Šï¼Œå†™ä¸ªæŠ¥å‘Šå°±å¾—å¥½å‡ ä¸‡å­—ï¼Œå¥½è¾›è‹¦ï¼Œç»“æœè¿˜æ²¡äººçœ‹ã€‚\né¡¶å±‚æ–­ä»£ï¼Œä¹Ÿå°±æ˜¯å¤§å®¶ç»å¸¸è®²çš„å‘¨æœŸæ€§çš„æ–­ä»£åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿä½ è®°ä½ä¸€ç‚¹ï¼Œé¡¶å±‚çš„æ–­ä»£æ˜¯æ„è¯†å½¢æ€ï¼Œç¤¾ä¼šæ”¿æ²»çš„å‘å±•æœ¬è´¨ä¸Šæ˜¯ç¾¤ä½“æ€§æ„è¯†å½¢æ€çš„å‘¨æœŸï¼Œä¹Ÿå°±æ˜¯å¤§å®¶å­¦è¿‡çš„æ€æƒ³æ”¿æ²»è¯¾ä¸­çš„ â€œå·¦â€ å’Œ â€œå³â€ï¼Œå·¦å€¾å³å€¾ã€å·¦æ´¾å³æ´¾ã€å·¦ç¿¼å³ç¿¼ã€é›†ä½“ä¸ªä½“ï¼Œè¿™äº›ä¸œè¥¿çš„å˜åŠ¨æ‰æ˜¯ä¸–ç•Œç»æµå‘¨æœŸçš„æœ€å¤§å˜åŠ¨ã€‚\nå½“å‰æ˜¯ä»€ä¹ˆï¼Ÿå¤§é¢†å¯¼è®²çš„é‚£å¥è¯å¾ˆå¯¹ï¼Œç™¾å¹´ä¹‹æœªæœ‰å¤§å˜å±€ï¼ˆç™¾å¹´æœªæœ‰ä¹‹å¤§å˜å±€ï¼‰ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯ 1929 å¹´å¤§è§æ¡åˆ°äºŒæˆ˜åå®Œæ•´ä¸€ä¸ªå‘¨æœŸçš„ç»“æŸã€‚å…¨çƒä»äºŒæˆ˜çš„æç«¯å³ç¿¼ï¼Œæ…¢æ…¢å‘å±•åˆ°ä¸­å³ï¼Œå†åå‘ä¸­å·¦ï¼Œå†åˆ°å·®ä¸å¤šè¿™ 20 å¹´å·¦å³çš„æç«¯å·¦ç¿¼åŒ–ï¼Œæœ€ç»ˆå¯¼è‡´é‡æ–°å¼€å§‹å³ç¿¼ï¼Œè¿™ä¸ªä¸–ç•Œå¾ˆæœ‰æ„æ€ï¼Œæ²¡æœ‰ä»»ä½•æ–¹å‘æ˜¯ç»å¯¹æ­£ç¡®çš„ã€‚\næˆ‘ä¸€ç›´å‘Šè¯«å¤§å®¶ï¼Œä½ ä»¬ä¸è¦åœ¨ç½‘ä¸Šäº‰åµï¼Œæˆ‘ç«™åœ¨å·¦è¾¹ï¼Œä½ ç«™åœ¨å³è¾¹ï¼ŒPKï¼Œéå¾—è®¨è®ºå‡ºè°æœ€ç‰›é€¼ï¼Œè°æœ€æ­£ç¡®ï¼Œæ²¡æœ‰ã€‚å°±å¥½åƒä½ æƒ³æ‰¾ä¸ªå¥³æœ‹å‹ï¼Œåˆæ¼‚äº®ï¼Œè…¿åˆé•¿ï¼Œèƒ¸åˆå¤§ï¼Œè…°åˆç»†ï¼Œè¿˜æœ‰é’±ï¼Œè¿˜ç‰¹åˆ«çˆ±ä½ ï¼Œä½ æƒ³å¤šäº†ï¼ŒæŒ‘ä¸€æ ·å°±è¡Œäº†ï¼Œå®Œç¾ä¸»ä¹‰å“ªå„¿æœ‰ï¼Ÿæœ€ç»ˆçš„ç»“æœå°±æ˜¯åœ¨è¿åŠ¨çš„è¿‡ç¨‹ä¸­å¯¹æ”¿æ²»é€ æˆå½±å“ï¼Œè¿›è€Œå¯¹ç»æµé€ æˆå½±å“ï¼Œè¿›è€Œå¯¹é‡‘èå¸‚åœºé€ æˆå½±å“ï¼Œä¸€å®šè®°ä½é‡‘å­—å¡”çš„é€»è¾‘ã€‚\nå¤§éƒ¨åˆ†æ—¶é—´æˆ‘ä»¬ä¸ç”¨ Care é¡¶å±‚ï¼Œå› ä¸ºåœ¨è¿‡å»ç™¾å¹´ï¼Œé¡¶å±‚çš„æ–¹å‘æ˜¯å›ºå®šçš„ï¼Œå°±æ˜¯ä»æç«¯å³ç¿¼ä¸æ–­å‘å·¦ç¿¼åœ¨è¿åŠ¨ï¼Œæ‰€ä»¥é¡¶å±‚æ–¹å‘ä¸å˜çš„æƒ…å†µä¸‹å°±ä¼šå½¢æˆä¸‹é¢çš„ä¸€å¥—è¿è½¬é€»è¾‘ã€‚\næ¯”å¦‚è¯´ä»¥ç¾å›½ä¸ºä»£è¡¨ï¼Œä½ ä»¬åº”è¯¥çœ‹åˆ° Ray Dalio å…³äºå€ºåŠ¡å±æœºçš„é‚£æœ¬ä¹¦ï¼Œé‡Œé¢æœ‰ä¸ªåˆ©ç‡æ›²çº¿ï¼ŒäºŒæˆ˜å‰æˆ‘ä»¬çš„åˆ©ç‡å°±æ˜¯ 0ï¼Œåˆ° 80 å¹´ä»£åˆ©ç‡è¾¾åˆ°é¡¶å³°ï¼Œ2008 å¹´æ¬¡è´·å±æœºåˆ°ç–«æƒ…æœŸé—´åˆ©ç‡å†æ¬¡è¾¾åˆ° 0ã€‚åˆ©ç‡çš„ä½ç‚¹åˆ°åº•æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿä¸ºä»€ä¹ˆåœ¨è¿‡å»çš„ç™¾å¹´å†å²é‡Œï¼Œåˆ©ç‡çš„ä½ç‚¹æ€»æ˜¯æˆ˜äº‰çš„èµ·ç‚¹ï¼Ÿæ˜¯æœ‰åŸå› çš„ï¼Œå› ä¸ºåˆ©ç‡çš„æœ¬è´¨å®é™…ä¸Šå°±æ˜¯è´«å¯Œå·®è·ï¼Œåˆ©ç‡è¶Šä½çš„æ—¶å€™ï¼Œè´«å¯Œå·®è·è¶Šå¤§çš„ï¼Œåˆ©ç‡è¶Šé«˜çš„æ—¶å€™ï¼Œè´«å¯Œå·®è·è¶Šå°çš„ã€‚\nå½“ç„¶ï¼Œæˆ‘ä»¬æ¯ä¸ªäººéƒ½æ˜¯å±è‚¡å†³å®šè„‘è¢‹ï¼Œæ¯”å¦‚å¤§å®¶æ‰‹ä¸Šæ‹¿ç€ä¸€å †é‡‘èèµ„äº§ï¼Œæ‹¿ç€ä¸€å †æ æ†ï¼Œæˆ‘å¯ä»¥å‘Šè¯‰ä½ ï¼Œä½ æ°¸è¿œé«˜å‘¼çš„æ˜¯ä½åˆ©ç‡æ˜¯å¯¹çš„ï¼Œå°±å¥½åƒå¤§å®¶å¯¹äºç¾å›½çš„ç†è§£ä¸€æ ·ï¼Œæ°¸è¿œè®¤ä¸ºç¾å›½åœ¨è¿‡å»çš„ 40 å¹´çš„é€»è¾‘å°±æ˜¯ä¸èƒ½åŠ æ¯ï¼ŒåŠ æ¯å°±å´©æºƒï¼Œå´©æºƒå°±é™æ¯ï¼Œåˆ©ç‡æ°¸è¿œæ˜¯ä½çš„ï¼Œç¾å…ƒæ°¸è¿œæ˜¯ Carry çš„å€Ÿè´·æ–¹ï¼Œä½†ä½ ä»æ¥æ²¡æœ‰æƒ³è¿‡è¿™ä¸ªé€»è¾‘ä¼šå˜çš„ã€‚\nå‡ å¹´å‰æˆ‘è·Ÿå¾ˆå¤šäººè®²çš„æ—¶å€™ï¼Œæˆ‘è¯´ä½ è®°ä½ä¸€ç‚¹ï¼Œä¸­å›½ä»é«˜åˆ©ç‡å˜ä½åˆ©ç‡ï¼Œæµ·å¤–ä»ä½åˆ©ç‡å˜é«˜åˆ©ç‡ï¼Œæ‰€è°“çš„å‡ æ¯›æ¡£è¿˜åŠ¨ä¸åŠ¨è¯´ä»˜æ€»è¯´äº†é«˜åˆ©ç‡æ˜¯å¤šå°‘ï¼Œ4-5 éƒ½æ˜¯é«˜åˆ©ç‡ã€‚ä½åˆ©ç‡æ˜¯å¤šå°‘ï¼Ÿ0ã€1ã€2 æœ‰å¤šå¤§åŒºåˆ«å—ï¼Ÿæ²¡æœ‰çš„ï¼Œè¿™æ˜¯å…³é”®çš„ç‚¹ã€‚æœ‰äººè¯´éå¾—çº ï¼ŒæŠŠæˆ‘çš„è¯ç›´æ¥å˜æˆäº†ä»˜æ€»è¯´çš„ï¼Œä¸­å›½ä¸ä¼šåŠ æ¯ï¼Œæ°¸è¿œé™æ¯ï¼Œç¾å›½æ°¸è¿œåŠ æ¯ä¸ä¼šé™æ¯ï¼Œé™ä¸€ç‚¹åŠ ä¸€ç‚¹ï¼ŒåŠ ä¸€ç‚¹é™ä¸€ç‚¹ï¼Œè¿™ä¸å¾ˆæ­£å¸¸å—ï¼Ÿæ¯”å¦‚ç‰¹æœ—æ™®ä¸Šæ¥äº†ï¼Œæ˜å¹´æœ‰æ²¡æœ‰å¦å¤–ä¸€ç§æ„å¤–æ€§å‘¢ï¼Ÿæ¯”å¦‚è¯´é™äº† 50ï¼Œé™äº† 25ï¼Œå¤§æ¦‚å›åˆ° 4.75ï¼Œ5 çš„æ°´å¹³äº†ï¼Œçªç„¶é—´åˆæŠ¬å›åˆ° 5.25 äº†ï¼Œè¿™ä¸æ­£å¸¸å—ï¼Ÿ4 å’Œ 5 çš„çº ç»“ä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯ä»–ä¸ä¼šå†å›åˆ° 0ã€1ã€2 äº†ï¼Œè¿™æ˜¯å¾ˆå…³é”®çš„ã€‚\nå¯¹äºåŠ³åŠ¨åŠ›æ¥è®²ï¼Œåˆ©ç‡æ˜¯å¾ˆå…³é”®çš„ï¼Œå¦‚æœåˆ©ç‡çš„æŠ¬å‡æ¥è‡ªäºåŠ³åŠ¨æ”¶å…¥çš„å¢é•¿ï¼Œè¿™æ˜¯å¥½äº‹æƒ…ã€‚ä½ æƒ³æƒ³ä¸­å›½ï¼Œä½ æŠŠæ—¶é—´æ‹¨å›åˆ° 20 å¹´å‰ï¼Œåˆ©ç‡é«˜ä¸é«˜ï¼Ÿé‚£æ—¶å€™ä½ éš¾å—å—ï¼Ÿä¸éš¾å—ã€‚ç°åœ¨åˆ©ç‡ä½ä¸ä½ï¼Ÿä½ï¼Œä½ éš¾å—å—ï¼Ÿä½ éš¾å—ã€‚ä¸ºä»€ä¹ˆï¼Ÿæ‰€ä»¥ä½ è¦çŸ¥é“æ˜¯é€šè¿‡åŠ³åŠ¨è·å¾—æ”¶å…¥è¿˜æ˜¯é€šè¿‡èµ„æœ¬æ æ†è·å¾—æ”¶å…¥çš„ï¼Œä½ å¯¹åˆ©ç‡çš„æ„Ÿè§‰å®Œå…¨æ˜¯åçš„ã€‚\nä½†æ˜¯æ•´ä½“ç¤¾ä¼šå»è®¨è®ºè´«å¯Œçš„æ—¶å€™ï¼Œè´«å¯Œä¸»è¦è®¨è®ºæ¥è‡ªäºåŠ³åŠ¨ä»·å€¼ï¼Œç®€å•è®²ï¼Œå¤©å¤©å¤–é¢é€å¤–å–è·‘æ»´æ»´çš„ï¼Œä»–ä»¬å°±æ˜¯å¤±å»çš„ä¸€ä»£ï¼Œåœ¨è¿‡å»çš„äºŒä¸‰åå¹´é‡Œï¼Œé åŠ³åŠ¨åŠ›çš„å°±æ˜¯è¢«æ·˜æ±°çš„ä¸€ä»£ï¼Œæ²¡åŠæ³•ï¼Œè¿™æ˜¯ç¤¾ä¼šå‘å±•çš„å¿…ç„¶ç»“æœã€‚ä½†æ˜¯å½“è¿™ç§çŸ›ç›¾å‹åŠ›å¤§äº†ï¼Œå°±ä¼šè½¬åŒ–æˆç¤¾ä¼šçŸ›ç›¾ï¼Œç”šè‡³å¯ä»¥é€šè¿‡é€‰ç¥¨è½¬åŒ–æˆå¯¹æ”¿æ²»çš„å½±å“ï¼Œå¯¹æ„è¯†å½¢æ€çš„å½±å“ã€‚æ‰€ä»¥è´«å¯Œåˆ°æç«¯çš„æ—¶å€™ä¸€å®šä¼šè¿›è¡Œä¿®æ­£ï¼Œæ— è®ºæ˜¯æå·¦çš„è´«å¯Œè¿˜æ˜¯æå³çš„è´«å¯Œï¼Œéƒ½ä¼šæœ€ç»ˆäº§ç”ŸçŸ›ç›¾ï¼Œè¿™å°±æ˜¯ç¤¾ä¼šè¿è½¬çš„è§„å¾‹ã€‚\nè¿‡å»ç™¾å¹´å‘ç”Ÿçš„è¿™ä¸€è½®å¤§å‘¨æœŸå°±æ˜¯å®Œæ•´çš„å‘¨æœŸï¼Œåˆ° 2016 å¹´è¡¨é¢ä¸Šçœ‹å«ä¸­ç¾è´¸æ˜“æˆ˜ï¼Œè¡¨é¢ä¸Šçœ‹æ˜¯ä¸­ç¾ä¸¤ä¸ªå¤§å›½ä¹‹é—´æ‰€è°“çš„å¯¹æŠ—å’Œåšå¼ˆï¼Œå…¶å®æ˜¯å…¨çƒå„ä¸ªå›½å®¶å†…éƒ¨çš„çŸ›ç›¾å±•ç¤ºï¼Œå¯¹å†…æ˜¯å†…éƒ¨çš„åˆ†é…ï¼Œå¯¹å¤–æ˜¯å¤–éƒ¨çš„åˆ†é…ã€‚åœ¨è¿™ä¸ªèƒŒæ™¯ä¸‹ï¼Œæˆ˜äº‰çš„é£é™©å°†åŠ å¤§ã€‚\nå‰ä¸¤å¤©ï¼Œæˆ‘ä»¬ä¹Ÿçœ‹åˆ°äº†ï¼Œäººç±»å†å²ä¸Šç¬¬ä¸€æ¬¡ä½¿ç”¨äº†æ´²é™…å¼¹é“å¯¼å¼¹ï¼Œæ— éå°±æ˜¯å‰é¢æ²¡æŒ‚æ ¸å¼¹å¤´è€Œå·²ï¼Œä»…æ­¤ã€‚ä½ è§‰å¾—è¿™ä¸ªä¸œè¥¿ç¦»ä½ è¿˜å¾ˆè¿œå—ï¼Ÿæˆ‘ä»¬è¿™ä¸€ä»£å¯ä»¥è¯´æ˜¯å¹¸ç¦çš„ä¸€ä»£ï¼Œä½†æˆ‘ä»¬è¿™ä¸€ä»£ä¹Ÿå°†ç»å†ä¸å¸¸è§çš„ç™¾å¹´ä¹‹æœªæœ‰å¤§å˜å±€äº†ã€‚\nå¾ˆå¤šäººåœ¨æ€è€ƒè¿™ä¸ªä¸–ç•Œçš„æ—¶å€™ï¼ŒçœŸçš„ä¸è¦ä»¥ä¸ºæˆ‘ä»¬ç°åœ¨è¿˜èƒ½å›åˆ°è¿‡å»ï¼Œå›ä¸å»äº†ï¼Œé‚£ä¸ªå…¨ä¸–ç•ŒåŒ…å®¹èåˆçš„ï¼Œä¸æ–­å·¦ç¿¼åŒ–æ¨è¿›çš„ï¼Œå…¨çƒåŒ–ä¸æ–­æ¨è¿›çš„è·¯å¾„ï¼Œè¿™ä¸ªæ—¶ä»£å½»åº•åœ¨ 2016 å¹´å·²ç»å¼€å§‹ç»“æŸäº†ã€‚\n2016 å¹´å¾ˆå¤šäººåˆ¤æ–­æ˜¯é”™è¯¯çš„ï¼Œæ€»è§‰å¾— 2016 å¹´åªæ˜¯ä¸€åœºè´¸æ˜“æˆ˜ï¼Œé‚£æ—¶å€™æˆ‘ä»åç››é¡¿è°ƒç ”ä¸¤å‘¨å›æ¥ä»¥åï¼Œæˆ‘è·Ÿå¾ˆå¤šäººè®²ï¼Œä¸æ˜¯è´¸æ˜“æˆ˜ï¼Œä¸æ˜¯è¯´å“ªä¸ªå…šæ´¾ï¼Œæ°‘ä¸»å…šã€å…±å’Œå…šä¸Šæ¥å¯¹ä¸­å›½å°±ä¼šæ¸©å’Œçš„ï¼Œä¸ä¼šçš„ï¼Œä¸¤å…šçš„å…±è¯†ï¼Œä»–ä¸¤è€…ä¹‹é—´åªå­˜åœ¨ç€æˆ‘æ¯”ä½ å·¦ä¸€ç‚¹ï¼Œæˆ‘æ¯”ä½ å³ä¸€ç‚¹ï¼Œä½†å’±ä¿©éƒ½æ˜¯å¾€å³çš„ã€‚ç¾å›½æ”¿æ²»çš„å˜åŒ–æ ¸å¿ƒåœ¨äºä¸ç®¡æ°‘ä¸»å…šå’Œå…±å’Œå…šï¼Œå¯¹ä¸­å›½çš„å‹åŠ›éƒ½æ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡æ˜¯ä»–ä¿©è°å‹åŠ›å¤šä¸€ç‚¹è°å‹åŠ›å°‘ä¸€ç‚¹ï¼Œè°åœ¨å¤–äº¤ä¸Šå‹åŠ›å¤šä¸€ç‚¹ï¼Œè°åœ¨ç»æµä¸Šå‹åŠ›å¤šä¸€ç‚¹ï¼Œä»…æ­¤è€Œå·²ã€‚\nå¯¹ä¸­å›½æ¥è®²ç°åœ¨ä¹Ÿéº»çƒ¦ï¼Œåœ¨è¿‡å»çš„ 80 å¹´ä»£ã€90 å¹´ä»£ï¼Œè¥¿æ–¹åœ¨ä¸æ–­åŒ…å®¹èåˆå³ç¿¼åŒ–ï¼ŒåŒæ—¶å½“æ—¶çš„ä¸­å›½ä¹Ÿåœ¨ä¸æ–­åœ°å¾€å³èµ°ï¼Œå½“ç„¶æ­¤å¤„ä¸æ˜¯æŒ‡çš„ä¸­å›½çš„å³å€¾ã€‚æ³¨æ„è¥¿æ–¹å³ç¿¼æ¦‚å¿µå’Œä¸­å›½å®Œå…¨åçš„ï¼Œä½ ä»¬ä¸è¦è§‰å¾—æ˜¯é”™è¯¯çš„ï¼Œå¦‚æœä½ è§‰å¾—é”™è¯¯çš„ï¼Œä½ å…ˆäº†è§£äº†è§£ä»€ä¹ˆæ˜¯å·¦æ´¾å³æ´¾ã€å·¦å€¾å³å€¾ã€å·¦ç¿¼å³ç¿¼ã€‚å¦‚æœä½ ä¸èƒ½ç†è§£è¿™ä¸ªä¸œè¥¿ï¼Œä½ è‚¯å®šå¯¹å·¦å’Œå³åœ¨ä¸­å›½å’Œè¥¿æ–¹çš„æ¡†æ¶é‡Œå®Œå…¨æ˜¯é¢ å€’çš„ã€‚\nä¸­å›½ä¹Ÿæ˜¯æœç€åŒ…å®¹ã€èåˆçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰æœ‰äº†éå¸¸å¥½çš„å…¥å¸‚ã€WTOã€æ”¹é©å¼€æ”¾ç­‰ä¸€ç³»åˆ—çš„æ“ä½œã€‚æˆ‘ç»å¸¸è¯´å®¶åº­ä¸­å¥³ç”Ÿæ˜¯å¤©ç”Ÿå³ç¿¼ï¼Œå³ç¿¼æœ‰ä¸€ä¸ªå…¸å‹ç‰¹å¾ï¼Œå³ç¿¼å¯ä»¥å«æ°‘ç²¹ï¼Œå¯ä»¥å«å›½å®¶ä¸»ä¹‰ï¼Œå¯ä»¥å«çˆ±å›½ä¸»ä¹‰ï¼Œæç«¯å³ç¿¼å¯ä»¥å«çº³ç²¹ã€‚ä½†å³ç¿¼çš„ç‰¹å¾å¾ˆæ˜æ˜¾ï¼Œâ€œæˆ‘æ²¡é”™ï¼Œéƒ½æ˜¯ä½ çš„é”™â€ï¼Œè¿™å°±æ˜¯å³ç¿¼ã€‚\nå®¶åº­ä¸­å¥³åŒå¿—å¤©ç”Ÿå¸¦æœ‰ï¼Œå½“ç„¶æˆ‘ä¸æ˜¯æ­§è§†å„ä½å¥³å£«ï¼Œè¿™æ˜¯ä½ ä»¬ DNA é‡Œå¸¦çš„ï¼Œä¸¤ä¸ª X é‡Œå¸¦çš„ï¼Œå¦‚æœå®¶åº­ä¸­ç”·ç”Ÿæ˜¯å·¦ç¿¼ï¼Œå®¶åº­æ˜¯å¹¸ç¦çš„ï¼Œä»€ä¹ˆæ„æ€å‘¢ï¼Ÿâ€œè€å©†ï¼Œæ²¡äº‹å„¿æ²¡äº‹å„¿ï¼Œéƒ½æ˜¯æˆ‘çš„é”™â€ï¼Œç”·ç”Ÿæ˜¯ä¸ªå·¦ç¿¼ï¼Œå®¶åº­å¾ˆå¥½ï¼Œå·¦ + å³ã€‚\nå¦‚æœç”·å¥³éƒ½æ˜¯å·¦ç¿¼ï¼Œè¿™ç®€ç›´æ˜¯å¹¸ç¦æ— æ¯”äº†ï¼Œç”·ç”Ÿå›å®¶äº†ï¼Œå¥³ç”ŸæŠŠæ‹–é‹ä¸€æ”¾è¯´ â€œè€å©†ä½ æ‰“ä¼šå„¿æ¸¸æˆï¼Œæˆ‘æ­£åšé¥­å‘¢ï¼Œä¸€ä¼šå„¿åšå¥½äº†å«ä½ æ´—æ‰‹åƒé¥­â€ï¼Œè¿™ä¸ªç”·åŒå¿—çœŸçš„å»æ‰“æ¸¸æˆäº†ï¼Œåƒå®Œé¥­äº†è¯´ â€œä½ æ­‡ä¸€ä¼šå„¿ï¼Œçœ‹ä¼šå„¿å‰§ï¼Œæˆ‘æ¥æŠŠç¢—æ´—äº†ã€‚â€ ä½ å¯åƒä¸‡åˆ«å½“ä¸ªå¤§ç›´ç”·ï¼Œé”…ä¸€ç”©åˆå»ç©å„¿äº†ï¼Œä¸è¡Œï¼Œæ—¶é—´é•¿äº†ï¼Œå¥¹ä¼šå³ç¿¼åŒ–çš„ã€‚\næ­¤æ—¶ä½ ä¹Ÿè¡¨ç°å‡ºå·¦ç¿¼ç‰¹å¾ï¼Œä½ å®¶åº­å°±æ˜¯èåˆçš„ã€‚å®¶é‡Œå¦‚æœä¸¤ä¸ªå³ç¿¼å°±å®Œè›‹äº†ï¼Œéƒ½æ˜¯ä½ çš„é”™æˆ‘æ²¡é”™ï¼Œå‡­ä»€ä¹ˆè¯´æ˜¯æˆ‘çš„é”™ï¼Ÿå°±æ˜¯ä½ çš„é”™ï¼Œå°±æ˜¯ä½ åšé”™äº†ã€‚ç›´ç”·ç¢°ä¸Šå¥³ç”Ÿï¼Œä¸€èˆ¬æ¥è®²æ²¡å•¥å¥½ç»„åˆï¼Œä¸¤ä¸ªå³ç¿¼å°±æ˜¯æˆ˜äº‰ï¼Œæ‰“æ¶åˆ°ç¦»å©šã€‚\nä¸è¦è®¤ä¸ºè¿™æ˜¯åœ¨è®¨è®ºå®¶åº­ã€å©šå§»ï¼ŒåŒæ ·åœ¨è®¨è®ºå›½å®¶ï¼ŒåŒæ ·åœ¨è®¨è®ºå…¨çƒã€‚å½“å›½å®¶å’Œå›½å®¶ä¹‹é—´çš„ç»„åˆå‡ºç°ç»Ÿç»Ÿå·¦ç¿¼åŒ–çš„æ—¶å€™ï¼Œå°±æ˜¯åŒ…å®¹ã€èåˆã€å…¨çƒåŒ–å…±åŒå¢é•¿çš„ä¿±ä½³çš„å†å²ç¯å¢ƒï¼Œå½“å…¨æ˜¯å³ç¿¼åŒ–çš„æ—¶å€™ï¼Œå°±æ˜¯æˆ˜äº‰ã€‚\næˆ‘ä»¬ç°åœ¨çš„å¤§éº»çƒ¦åœ¨å“ªå„¿ï¼Ÿå°±åœ¨è¿™å„¿ã€‚å…¨ä¸–ç•Œåœ¨è¿‡å» 5ã€6 å¹´æ—¶é—´é‡Œå·²ç»é™†é™†ç»­ç»­éƒ½åœ¨å³ç¿¼åŒ–äº†ï¼Œå³ç¿¼åŒ–çš„ç‰¹å¾ï¼Œæ”¿æ²»çš„é‡è¦æ€§å·²ç»ä½“ç°å‡ºæ¥äº†ï¼Œé€‰ç¥¨å›å½’ä¼ ç»Ÿçš„ç‰¹å¾å·²ç»ä½“ç°å‡ºæ¥äº†ï¼Œåç§»æ°‘çš„ç‰¹å¾å·²ç»ä½“ç°å‡ºæ¥äº†ã€‚\næˆ‘ä¹‹å‰è¯´è¿‡ï¼Œè¿™ä¸¤å¹´å…¨çƒè‘—åçš„äº¤æ˜“å°±æ˜¯ â€œå¤šç¾å›½ï¼Œç©ºåŠ æ‹¿å¤§â€ï¼ŒåŸå› å°±æ˜¯åŠ æ‹¿å¤§çš„å°åœŸè±†æ”¾äº†é‚£ä¹ˆå¤šå°åº¦è£”è¿›æ¥ï¼Œå°±å®Œè›‹äº†ï¼ŒåŠ æ‹¿å¤§çš„æ ¸å¿ƒçŸ›ç›¾æ˜¯ä»€ä¹ˆï¼Ÿç»æµå¢é•¿åˆ›é€ äº†äº”ä¸ªè›‹ç³•ï¼ŒåŸæœ¬åŠ æ‹¿å¤§çš„å›½æ°‘å¯ä»¥ä¸€äººåƒä¸€ä¸ªï¼Œç°åœ¨æ”¾äº† 10 ä¸ªé˜¿ X è¿›æ¥ï¼ŒåŠ æ‹¿å¤§é—®é¢˜æ˜¯åˆ†é…ï¼Œå½“åˆ†é…ä¸å¤Ÿçš„æ—¶å€™ï¼Œä¸€å®šä¼šè¶‹äºä¿å®ˆï¼Œä¸€å®šä¼šè¶‹äºå³ç¿¼åŒ–ï¼Œä¸€å®šä¼šè¶‹äºåç§»æ°‘ã€‚\nå„å›½éƒ½ä¸€æ ·ï¼Œ70 å¹´ä»£ 80 å¹´ä»£çš„æ—¶å€™ï¼Œè‹±å›½é‚£æ—¶å€™æœ‰è¿‡æ’åï¼Œç°åœ¨åˆå¼€å§‹åç©†æ–¯æ—äº†ï¼Œè¿™æ­£å¸¸ã€‚ä¸–ç•Œçš„åŠ¨è¡ä¸æ˜¯ç®€ç®€å•å•è¡¨ç°åœ¨å•çº¯çš„èµ„äº§ä¸Šï¼Œå‰ä¸¤å¤©è‹±å›½åˆå‡ºå°äº†æ–°çš„æ”¿ç­–ï¼Œä½ åªè¦éè‹±å›½å›½æ°‘çš„ï¼ŒåŸåˆ™ä¸Šæ¥è®²è¦äº¤é—äº§ç¨çš„ï¼Œè‹±å›½æ”¿åºœä¹Ÿè¦æ”¶ä½ çš„é—äº§ç¨ã€‚æˆ‘ä¹‹å‰è·Ÿå¾ˆå¤šå¯Œäººè¯´ï¼Œåˆ«å¤©å¤©ç¢ç£¨é¿ç¨äº†ï¼ŒåŒ…å®¹èåˆçš„æ—¶å€™è—ç‚¹ç§æˆ¿é’±æ˜¯æ²¡äº‹å„¿çš„ï¼Œå½“éƒ½å³ç¿¼åŒ–çš„æ—¶å€™ï¼Œä½ å†è—ç§æˆ¿é’±ä½ å°±å®Œè›‹äº†ï¼Œç°åœ¨å…¨ä¸–ç•Œçš„å¤§éº»çƒ¦æ˜¯ä»€ä¹ˆï¼Ÿæ‰¾ä¸ªç¨ç‡ä½çš„åœ°æ–¹è¯¥ç¼´çš„ç¼´ã€‚å½“å¹´ç‰¹æœ—æ™®ä¸Šæ¥çš„æ—¶å€™ 20% åªè¦ä½ æ„¿æ„å›æµç¾å›½ï¼Œå…¨éƒ¨åˆæ³•åŒ–ï¼Œä½ çœ‹æœ‰å¤šå°‘èµ„æœ¬å¾€å›å›æµï¼Ÿæ‰€ä»¥ä½ ä»¬çŸ¥é“å·¦ç¿¼å’Œå³ç¿¼å¤§æ¦‚çš„æ¡†æ¶å’Œç‰¹å¾ï¼Œè¿™æ‰æ˜¯æˆ‘é‚£æœ¬ä¹¦é‡Œçš„çœŸæ­£ç²¾é«“ï¼Œä½†è¢«åˆ æ‰äº†ã€‚\nä½ æŠŠå®ƒç†è§£äº†ï¼Œä½ å¯¹åº”çš„ç©¿é€åˆ°ç»æµä¸Šï¼Œç©¿é€åˆ°åˆ©ç‡ä¸Šï¼Œç©¿é€åˆ°èµ„äº§ä¸Šï¼Œä½ ä¼šé—¨æ¸…å„¿çš„ï¼Œè¿™å°±æ˜¯å¤§ç±»èµ„äº§çš„ç²¾é«“ï¼ŒçœŸæ­£çš„ç²¾é«“ã€‚ä½ è¦é—®è¿™ä¸œè¥¿è°åˆ›é€ çš„ï¼Œç´¢ç½—æ–¯é‚£æ‰¹äººï¼Œæœ¬æ£®ç‰¹é‚£æ‰¹äººï¼Œæ•´ä½“æ¡†æ¶å¤§å®¶éƒ½æ˜¯ä¸€æ ·çš„ã€‚\næˆ‘åˆ°åº•åœ¨è®²ä»€ä¹ˆï¼Ÿå…¶å®æˆ‘å°±æ˜¯åœ¨è®²å›é¡¾ï¼Œå› ä¸ºä»é‚£ä¸€åˆ»å¼€å§‹ï¼Œå‡ ä¸ªé—®é¢˜å°±åœ¨é™†é™†ç»­ç»­æš´éœ²ã€‚ç¾å›½åœ¨è¿›è¡Œé‡æ„ï¼Œç‰¹æœ—æ™®ä¸Šæ¥ä»¥åæ–¹å‘ç»§ç»­é‡æ„ï¼Œè¿™é‡Œé¢å…¶å®å°±æ¶‰åŠåˆ°æ°‘ä¸»å…šä¸ºä»€ä¹ˆæ˜¯é”™çš„ï¼Œæ°‘ä¸»å…šçš„å¾ˆå¤šæ”¿ç­–ä¸ºä»€ä¹ˆæ˜¯æç«¯å·¦ç¿¼ï¼Œå·¦ç¿¼æ”¿ç­–ä¸ä¸€å®šæ˜¯å¯¹çš„ï¼Œå³ç¿¼ä¸ºä»€ä¹ˆä¼šä½¿å¾—ç¾å›½è¿›å…¥åˆ°å¢é•¿é€šèƒ€åˆ©ç‡çš„ç¯å¢ƒã€‚\nåŒ…æ‹¬æœ‰äº›åäººå¸¦æœ‰æ„è¯†å½¢æ€ï¼Œæˆ‘åªèƒ½è¯´ä¸€å¥è¯ï¼Œæˆ‘ä»¬ä½œä¸ºå…¨çƒæŠ•èµ„äººï¼Œæœ€ä½³çš„é€‰æ‹©æ˜¯æ²¡æœ‰ä»»ä½•æ„è¯†å½¢æ€ï¼Œå¯¹æˆ‘æ¥è®²ï¼Œæˆ‘éå¸¸æ¸…æ¥šå·¦æœ‰å·¦çš„é—®é¢˜ï¼Œå³æœ‰å³çš„é—®é¢˜ï¼Œå·¦æœ‰å·¦çš„å¥½å¤„ï¼Œå³æœ‰å³çš„å¥½å¤„ï¼Œæˆ‘ä¸ä¼šç«™åœ¨ä»»ä½•ä¸€ä¾§ã€‚æˆ‘çš„ç­”æ¡ˆæ˜¯å…¨ä¸–ç•Œé€‰æ‹©å¾€å·¦èµ°ï¼Œæˆ‘å°±çŸ¥é“æˆ‘çš„äº¤æ˜“è·¯å¾„æ˜¯ä»€ä¹ˆï¼Œå…¨ä¸–ç•Œé€‰æ‹©å¾€å³èµ°ï¼Œæˆ‘ä¹ŸåŒæ ·çŸ¥é“æˆ‘çš„äº¤æ˜“è·¯å¾„æ˜¯ä»€ä¹ˆï¼Œä½†æˆ‘ç»å¯¹ä¸ä¼šç«™é˜Ÿè¯´è°æ˜¯ç»å¯¹æ­£ç¡®çš„ï¼Œå¦åˆ™çš„è¯å°±ä¼šå‹é”™å®ã€‚ä¸–ç•Œæœ‰æ—¶å€™ä¸ä¸€å®šæŒ‰ç…§æˆ‘ä»¬çš„æ„è¯†èµ°ï¼Œç¾å›½çš„è¿™æ¬¡å¤§é€‰ä¹Ÿæ˜¯å…¸å‹çš„ç»“æœï¼Œå…¶å®æˆ‘ä¹Ÿæ²¡æƒ³åˆ°ï¼Œç¾å›½å³ç¿¼åŒ–çš„é€Ÿåº¦ä¼šè¿™ä¹ˆå¿«ï¼Œæ¨è¿›é€Ÿåº¦ä¼šå¦‚æ­¤è¿…é€Ÿã€‚æœ¬æ¥æƒ³çš„æ˜¯æ°‘ä¸»å…šè¿˜èƒ½å¤Ÿæ’‘ä¸€æ’‘ï¼Œä½†ç°åœ¨æ¥çœ‹åŸºæœ¬ä¸Šæ˜¯å®Œè´¥çš„ã€‚\nå¯¹äºä¸­å›½æ¥è®²ï¼Œå½“å‰æˆ‘ä»¬é¢ä¸´çš„é—®é¢˜ä¸ä»…ä»…æ˜¯å¤–æ‚£çš„é—®é¢˜ï¼Œè¿˜åŒ…æ‹¬äº†å†…å¿§ã€‚ç»¼åˆåœ¨ä¸€èµ·ï¼Œä¼šæœ‰ä¸€ä¸ªéå¸¸å¥‡ç‰¹çš„ç­”æ¡ˆï¼Œä¹‹å‰å¾ˆå¤šäººé—®æˆ‘ä¸­å›½åˆ°åº•å’Œæ—¥æœ¬ä¸€ä¸ä¸€æ ·ï¼Ÿç½‘ä¸Šè¿™å¥è¯ç‚’çš„çº·çº·æ‰¬æ‰¬çš„ï¼Œæœ‰äººè¯´ä¸­å›½å°±æ˜¯ä¼šèµ°æ—¥æœ¬çš„è€è·¯ï¼Œæœ‰äººè¯´ä¸­å›½ä¸ä¼šèµ°æ—¥æœ¬çš„è€è·¯ï¼Œä½ è¦é—®æˆ‘æ­£ç¡®çš„ç­”æ¡ˆï¼Œæˆ‘ä¼šå‘Šè¯‰ä½ è¿™ä¸ªé—®é¢˜æ²¡æœ‰ä»»ä½•æ„ä¹‰ï¼Œä¸ºä»€ä¹ˆï¼Ÿå¤ªæ³›äº†ï¼Œå¦‚æœæ‹†çš„ç»†ä¸€ç‚¹æˆ‘èƒ½å›ç­”ä½ ã€‚æ¯”å¦‚ä½ è¦é—®ä¸­å›½çš„å±…æ°‘éƒ¨é—¨å’Œæ—¥æœ¬çš„å±…æ°‘éƒ¨é—¨ä¸€ä¸ä¸€æ ·ï¼Ÿæˆ‘çš„ç­”æ¡ˆæ˜¯ä¸€æ ·ï¼›ä¸­å›½çš„ä¼ä¸šéƒ¨é—¨è·Ÿå½“å¹´æ—¥æœ¬çš„ä¼ä¸šéƒ¨é—¨ä¸€æ ·ä¸ä¸€æ ·ï¼Ÿæˆ‘çš„ç­”æ¡ˆæ˜¯ä¸ä¸€æ ·ï¼›ä¸­å›½çš„æ”¿åºœéƒ¨é—¨å’Œå½“å¹´æ—¥æœ¬çš„æ”¿åºœéƒ¨é—¨ä¸€ä¸ä¸€æ ·ï¼Ÿæˆ‘çš„ç­”æ¡ˆæ˜¯ä¸ä¸€æ ·ï¼›ä¸­å›½çš„é‡‘èæœºæ„è·Ÿå½“å¹´æ—¥æœ¬çš„é‡‘èæœºæ„ä¸ä¸€æ ·ï¼Ÿä¸ä¸€æ ·ï¼›ä¸­å›½å½“å‰é¢ä¸´çš„å›½é™…ç¯å¢ƒå’Œå½“æ—¶ 90 å¹´æ—¥æœ¬é¢ä¸´çš„å›½é™…ç¯å¢ƒä¸€ä¸ä¸€æ ·ï¼Ÿä¸ä¸€æ ·ã€‚\nä½ è¯´æœ€åçš„ç­”æ¡ˆæ˜¯ä»€ä¹ˆï¼Ÿå¦‚æœç«™åœ¨çº¯å±…æ°‘è§’åº¦æ¥è®²ï¼Œæˆ‘å¯ä»¥å‘Šè¯‰ä½  99.99% å¯ä»¥å¤åˆ»ï¼Œä½†å¦‚æœç«™åœ¨å¤§çš„å›½é™…ç¯å¢ƒä¸Šæ¥è®²ï¼Œå¯èƒ½å¾—åˆ°çš„æ˜¯å®Œå…¨ä¸åŒäºæ—¥æœ¬çš„æœ€ç»ˆç­”æ¡ˆã€‚ç”¨æˆ‘çš„è¯è¯´ï¼Œä½ æ˜¯è¯´ä¸€æ ·è¿˜æ˜¯ä¸ä¸€æ ·å‘¢ï¼Ÿæ²¡æœ‰æ„ä¹‰ã€‚\næ‰€ä»¥æˆ‘å¤§éƒ¨åˆ†æ—¶é—´ç»™ä½ ä»¬åˆ†æ‹†çš„æ˜¯æ—¥æœ¬å±…æ°‘éƒ¨é—¨å’Œä¸­å›½å±…æ°‘éƒ¨é—¨çš„æ¯”å¯¹ã€‚è€Œæ—¥æœ¬çš„ä¼ä¸šéƒ¨é—¨ã€é‡‘èéƒ¨é—¨ã€å‘å±•æ¨¡å‹æˆ‘ä¹Ÿç»™å¤§å®¶åˆ†äº«è¿‡ï¼Œå»å¹´ä½ ä»¬åº”è¯¥éƒ½çŸ¥é“äº†ï¼Œå·´è²ç‰¹ä¹°ä¸‰äº•ã€ä¸‰è±ã€ä¸¸çº¢ã€ä¼Šè—¤å¿ å•†ç¤¾ï¼Œå¤§ç¬”å‘è¡Œæ—¥å…ƒå€ºåˆ¸è´­å…¥åˆ°æ—¥æœ¬çš„ä¸‰äº•ã€ä¸‰è±ã€ä¸¸çº¢ã€ä¼Šè—¤å¿ è¿™äº›èµ„äº§ä¸­ï¼Œä»–åˆ°åº•åœ¨å¹²å—ï¼Ÿ\né‚£æ—¶å€™ç¬¬ä¸€è´¢ç»æ‰¾æˆ‘è¯´ä»˜æ€»ä½ å»è®²è®²å·´è²ç‰¹ä¸ºä»€ä¹ˆä¹°ï¼Œæˆ‘å‘ç°å¾ˆå¤šè¯„è®ºäººå‘˜å•çº¯åœ¨è®²ä¸‰äº•ã€ä¸‰è±ã€ä¸¸çº¢ã€ä¼Šè—¤å¿ èµ„äº§æ€ä¹ˆæ ·ï¼Œç¨å¾®èªæ˜ç‚¹çš„ä¼šè®²åˆ°å½“å¹´çš„å•†ç¤¾ä»¬æ˜¯æ—¥æœ¬çš„æµ·å¤–èµ„äº§ï¼Œæ˜¯æ—¥æœ¬ Carry trade å¥—æ¯äº¤æ˜“çš„ä¸»è¦æ”¶å…¥ç«¯ã€‚å†èªæ˜ä¸€ç‚¹çš„ä¼šè®²åˆ°å·´è²ç‰¹åœ¨å‚ä¸æ—¥æœ¬è¿‡å» 40 å¹´å­˜é‡è´¢å¯Œçš„å†åˆ†é…ã€‚\næˆ‘å¯èƒ½æ˜å¹´æŠŠæˆ‘ä»¬å®¶å°å„¿å­é€åˆ°æ—¥æœ¬å»ï¼Œæˆ‘è·Ÿä»–è®²çš„å¾ˆæ¸…æ¥šï¼Œæˆ‘ä¸éœ€è¦ä½ å»å­¦ä¹ äººå·¥æ™ºèƒ½ã€AIï¼Œä¸ºå•¥å‘¢ï¼Ÿä½ å¥½åƒæ²¡é‚£ä¹ˆèªæ˜ï¼Œä¹Ÿä¸æ˜¯ IT æŠ€æœ¯ç”·ï¼Œä½ æŠŠæ—¥è¯­å­¦å¥½ï¼Œèƒ½è€ƒä¸Šåº”åº†å°±ä¸é”™äº†ï¼Œé‚£é‡Œé¢éƒ½æ˜¯ä¸€äº›æ—¥æœ¬ä¼ ç»Ÿè´µæ—çš„å§‘å¨˜ï¼Œä½ å¨¶ä¸€ä¸ªå°±è¡Œäº†ï¼Œæœ€å¥½å¥¹ä»¬å®¶éƒ½æ˜¯ 80 å² 90 å²çš„ï¼Œä½ å°±èººèµ¢å°±è¡Œï¼Œç­‰å¥¹ä»¬å®¶ 80 å² 90 å²çš„æ˜åå¹´ä¸€æŒ‚ï¼Œæˆ¿æ˜¯ä½ çš„ï¼Œè‚¡æƒæ˜¯ä½ çš„ï¼ŒåœŸåœ°æ˜¯ä½ çš„ï¼Œè´¢å¯Œæ˜¯ä½ çš„ï¼Œå­˜æ¬¾æ˜¯ä½ çš„ï¼Œå’±ä»¬å°±å‚ä¸æ—¥æœ¬å­˜é‡ 40 å¹´è´¢å¯Œå†åˆ†é…ã€‚å·´è²ç‰¹æ˜¯ç”¨é’±å»å‚ä¸ï¼Œæˆ‘ä»¬ç”¨äººå‚ä¸ï¼Œæœ¬è´¨ä¸Šéƒ½ä¸€æ ·ï¼Œä½ ä¹°è‚¡ç¥¨ï¼Œæˆ‘æŠŠå„¿å­å«è¿‡å»ï¼Œè¿™éƒ½æ˜¯å‚ä¸è´¢å¯Œå­˜é‡åˆ†é…ã€‚\nä½ ä»¬è¦æ˜ç™½æ—¥æœ¬çš„æ ¸å¿ƒç©¶ç«Ÿæ˜¯ä»€ä¹ˆï¼Ÿæ—¥æœ¬çš„æ ¸å¿ƒæ˜¯å‚ä¸åˆ†é…ï¼Œè€Œä¸æ˜¯å‚ä¸å¢é•¿ã€‚å¾ˆå¤šäººä¸å¤ªç†è§£ï¼Œå› ä¸ºä»–åœ¨å›½å†…æ²¡å‚ä¸è¿‡åˆ†é…ï¼Œæ°¸è¿œéƒ½æ˜¯å¢é•¿å¤„åœ¨å“ªä¸ªç¯èŠ‚ï¼Œæˆ‘è·ç¦»æƒåŠ›è¿‘ä¸€ç‚¹ï¼Œèµ„æºè¿‘ä¸€ç‚¹ï¼Œèµ„æœ¬è¿‘ä¸€ç‚¹ï¼Œæˆ‘å°±å¤šåƒç‚¹ï¼Œå–åŠ³åŠ¨åŠ›çš„å°±å°‘åƒç‚¹ã€‚å½“ç»æµå¢é•¿å¢é€Ÿä¸å¤Ÿçš„æ—¶å€™ï¼Œæœ€åº•å±‚å°±æ²¡é¥­åƒäº†ã€‚ç»æµå¢é•¿ 5ï¼Œå¯èƒ½å„ä¸ªé˜¶å±‚çš„ä½“æ„Ÿæ˜¯å®Œå…¨ä¸åŒçš„ï¼Œæ‰€ä»¥ç½‘ä¸Šä¼šæœ‰äº›äººè¯´ç»æµæ•°æ®é€ å‡ï¼ŒçœŸçš„é€ å‡äº†å—ï¼Ÿä¹Ÿè®¸æ²¡æœ‰ã€‚5 ä»£è¡¨çš„æ˜¯æ•´ä½“çš„è›‹ç³•ï¼Œè€Œä½ çš„ä½“æ„Ÿä»…ä»…ä»£è¡¨ä½ çš„é˜¶å±‚ã€‚\nåœ¨è¿‡å»å‡ å¹´ä¸­å›½ç»æµçš„è°ƒç ”ä¸­ï¼Œæˆ‘ä»¬åˆ°åº•åšå¯¹äº†ä»€ä¹ˆï¼Ÿ\nç¬¬ä¸€ï¼Œåœ¨ 2020 å¹´ç–«æƒ…åï¼Œé‚£æ—¶å€™é•¿ç™½å±±è®ºå›æˆ‘è·Ÿå¤§å®¶è®²çš„å¾ˆæ¸…æ¥šï¼Œæˆ‘è¯´çš„éå¸¸èµ¤è£¸è£¸ï¼Œä¸­å›½å±…æ°‘èµ„äº§è´Ÿå€ºè¡¨å‡ºç°é—®é¢˜ï¼Œé‚£æ—¶å€™åˆ¸å•†ä»¬éƒ½å¾ˆ Happyï¼Œå› ä¸ºä»–ä»¬æ°¸è¿œéœ€è¦ Happyï¼Œåªèƒ½åšå¤šã€‚ä½†å¯¹äºæˆ‘ä»¬åš Hedge Fund å‡ºèº«çš„æ¥è®²ï¼Œæˆ‘å¯ä¸èƒ½è¿™ä¹ˆåšï¼Œæˆ‘è¿™ä¹ˆåšæˆ‘å°±å®Œè›‹äº†ï¼Œæˆ‘çš„é’±åœ¨é‡Œå¤´ã€‚10 æœˆ 8 æ—¥ä¹‹åï¼Œæœ‰äººåœ¨é‡Œå¤´å—ï¼Ÿåƒä¸‡åˆ«è‡ªå·±éº»é†‰è‡ªå·±ï¼Œé‚£éƒ½æ‰¯æ·¡ã€‚ç½‘ä¸Šä¸€èˆ¬æ¥è®²ï¼Œæ‹¿æ‰€è°“çš„è¿™ç§ä¸œè¥¿è’™è’™åˆ«äººå¯ä»¥ï¼Œä½ è‡ªå·±ä¿¡äº†å°±å®Œè›‹äº†ï¼Œå°±è·Ÿå½“æ—¶ â€œ6000 ç‚¹ä¸æ˜¯æ¢¦ï¼Œ1 ä¸‡ç‚¹åˆšèµ·æ­¥â€ï¼Œè®°ä½é‚£è¯æ˜¯è¯´ç»™æ•£æˆ·å¬çš„ï¼Œä½ ä¿¡äº†é‚£ä½ å°±å®Œäº†ã€‚æ ¸å¿ƒæ˜¯ä»€ä¹ˆï¼Ÿä»æˆ‘ä»¬çš„è§’åº¦éå¸¸æ˜ç¡®åœ°å¤§å®¶ï¼Œå¤§å®¶çš„é¢„æœŸå¾ˆé«˜ï¼Œä½†ç°å®å¾ˆæ®‹é…·ã€‚\né‚£ä¸¤å¹´è·Ÿå„å®¶å…¬å‹ŸåŸºé‡‘æ¯ä¸ªå­£åº¦åšäº¤æµçš„æ—¶å€™ï¼Œä»–ä»¬æ²¡æ³•å»ç†è§£ç°åœ¨çš„ç»æµæƒ…å†µï¼Œæ¯”å¦‚è¯´é‚£æ—¶å€™æˆ‘è·Ÿä»–ä»¬è®²ç½‘çº¦è½¦å¸æœºã€å¤–å–ï¼Œé‚£ä¸¤å¹´æˆ‘å¤§é‡çš„è°ƒç ”æ ·æœ¬å‚æ•°æ˜¯åº•å±‚ã€‚ç»æµå¢é•¿æ¶ˆè´¹æ‰©å¼ å‡çº§çš„æ—¶å€™ï¼Œè°ƒç ”æ ·æœ¬æ˜¯å¯Œäººå…ˆè¿›äº”æ˜Ÿçº§é…’åº—ï¼Œå¯Œäººå…ˆä¹°è¶…è·‘ï¼Œå¯Œäººå…ˆåƒæµ·é²œï¼Œç„¶åä½ çš„æ ·æœ¬å‚æ•°æ˜¯ä¸‹æ²‰çš„ï¼Œåˆ°æœ€åæ˜¯è€ç™¾å§“åƒä¸Šæµ·é²œï¼Œè€ç™¾å§“å¼€ä¸Šæ±½è½¦ï¼Œè€ç™¾å§“è¿›äº”æ˜Ÿçº§é…’åº—ã€‚\nä½†æ˜¯å½“ç»æµæ”¶ç¼©çš„æ—¶å€™ï¼Œå€’è¿‡æ¥çš„ï¼Œç¬¬ä¸€æ­¥å…ˆæ”¶ç¼©çš„æ˜¯åº•å±‚ã€‚æˆ‘å‰å‡ å¹´æˆ‘è¯´æ¯å¹´ç°åœ¨æ–°å¢å‡ åƒä¸‡çš„ç½‘çº¦è½¦å¸æœºï¼Œä½ ä»¬éƒ½æ²¡æœ‰æƒ³æƒ³äººä»å“ªå„¿æ¥çš„å—ï¼Ÿæœ‰äººè¯´äº†ï¼Œå†œæ‘åŠ³åŠ¨åŠ›è¿›åŸï¼Œæˆ‘è¯´éƒ½å•¥å¹´ä»£äº†ï¼Œè¿˜å†œæ‘åŠ³åŠ¨åŠ›è¿›åŸï¼Œè¿™åˆä¸æ˜¯ä½ å½“å¹´æå¤§è§„æ¨¡åŸºå»ºåŸé•‡åŒ–å»ºè®¾çš„æ—¶å€™ç¼ºå†œæ°‘å·¥ï¼ŒæŠŠå†œæ‘åŠ³åŠ¨åŠ›å¤§è§„æ¨¡è½¬ç§»è¿‡æ¥ã€‚ç°åœ¨çš„å†œæ‘ä½ å»çœ‹çœ‹ï¼Œå“ªå„¿è¿˜æœ‰åŠ³åŠ¨åŠ›ï¼Œé™¤äº†è€å¼±ç—…æ®‹å¹¼ä»¥å¤–ï¼Œè¿˜æœ‰åŠ³åŠ¨åŠ›å—ï¼Ÿä½ å°±æ²¡æƒ³æƒ³è¿™ä¸¤å¹´çªç„¶æ¿€å¢çš„ä¸¤åƒä¸‡çš„ç½‘çº¦è½¦å¸æœºè¿™äº›äººä»å“ªå„¿æ¥çš„ï¼Ÿç­”æ¡ˆå¾ˆç®€å•ï¼Œä¸­äº§é˜¶çº§çš„é™¨è½ã€‚åªä¸è¿‡æ˜¯ä½ çš„é˜¶å±‚ä¸ä¸€æ ·ï¼Œä½ çœ‹çš„é—®é¢˜ä¸ä¸€æ ·ã€‚\nå¾ˆå¤šäººçš„è°ƒç ”å¾ˆæœ‰é—®é¢˜çš„ï¼Œå¾ˆå¤šäººè¯´ç¾å›½é€šèƒ€å¯¼è‡´ç¾å›½å±…æ°‘éƒ¨é—¨æ°´æ·±ç«çƒ­ï¼Œæˆ‘é—®ä»–ä¸ºä»€ä¹ˆï¼Ÿä»–è¯´ä½ çœ‹æˆ‘æ‰“ç”µè¯é—®äº†æˆ‘åœ¨ç¾å›½çš„æœ‹å‹ï¼Œä»–ä»¬éƒ½å¾ˆæƒ¨ã€‚æˆ‘è¯´é‚£ä½ ç¾å›½æœ‹å‹çš„æ ·æœ¬æ˜¯ä¸ªä»€ä¹ˆçŠ¶æ€ï¼Ÿä»–ä¸€æè¿°ï¼Œæˆ‘è¯´é‚£å½“ç„¶æƒ¨äº†ï¼Œä»–ä»¬ä»¥å‰çˆ½çš„æ—¶å€™æ˜¯è€å…¬åœ¨ä¸­å›½æŒ£ç€é€šèƒ€çš„é’±ï¼Œè€å©†åœ¨é‚£è¾¹èŠ±ç€é€šç¼©çš„é’±ï¼Œäº«å—ç€ç¤¾ä¼šç¦åˆ©ä¿éšœä½“ç³»ï¼Œè¿˜ä¸äº¤ç¨ã€‚ç°åœ¨å€’è¿‡æ¥å˜æˆäº†è€å…¬åœ¨å›½å†…æŒ£ä¸ç€é’±äº†ï¼Œæµ·å¤–äººå®¶ä¸Šé—¨ç»™ä½ å¼„ä¸ªè‰çš®æ¸…ç†ä¸€ä¸‹è¦å¤šæ”¶ä½  50 ç¾é‡‘ä¸€å°æ—¶ï¼Œä½ çš„é’±æ²¡å¢é•¿ï¼ŒèŠ±çš„é’±å¤šäº†ï¼Œä½ å½“ç„¶éš¾å—ã€‚æˆ‘è¦æ˜¯é‚£ä¸ªé“²è‰çš®çš„ï¼Œæˆ‘ä¼šå‘Šè¯‰ä½ é‚£ç‚¹é€šèƒ€ç®—ä¸ªå±ï¼Œ5 å—é’±çš„ä¸‰æ˜æ²»æ¶¨åˆ° 7.5 å…ƒï¼Œç¿»äº† 50%ï¼Œå¯¹æˆ‘æ¥è®²ä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯æˆ‘ä»ä½ ä»¬å®¶å¼„ä¸ªè‰çš®ï¼ŒæŒ£ 50 å¤šä¸€ä¸ªå°æ—¶ï¼ŒåŠ³åŠ¨ä»·å€¼æå‡äº†ã€‚ä»äº‹åŠ³åŠ¨çš„äººå°±å¾ˆèˆ’æœï¼Œä»äº‹å•çº¯æ”¯å‡ºçš„äººæ¥è®²ä½ å°±éš¾å—äº†ã€‚\nä½ è¦è°ƒç ”çš„æ ·æœ¬æ˜¯ä¸€æ ·çš„ï¼Œå‰ä¸¤å¹´çš„æ ·æœ¬æ”¶ç¼©çš„æ˜¯æ—¶å€™æ˜¯åº•å±‚å…ˆåƒè‹¦ï¼Œä½†å¯¹å®è§‚ç»æµæ•°æ®å½±å“ä¸å¤§ï¼Œä½ ä»¬è®°ä½ä¸€ç‚¹ã€‚\næˆ‘å°±è¯´ç½‘çº¦è½¦å¸æœºï¼Œå¦‚æœä½ åœ¨å¹¿å·åšè°ƒç ”ï¼Œä»–ä»¬çš„ç‰¹å¾å°±æ˜¯æœ‰é’±æ²¡é’±ï¼Œä»Šå¤©éƒ½åƒé¾™æ±ŸçŒªè„šé¥­ã€‚ä½†æ³¨æ„ï¼ŒåŒ—äº¬åŒ—å››ç¯çš„ç½‘çº¦è½¦å¸æœºåƒçš„ä¸­åˆç›’é¥­åˆ°å¤šå°‘é’±å—ï¼Ÿ15 å—é’±é€ç“¶æ°´ï¼Œè¿˜å¸¦é”…åŒ…è‚‰ï¼ŒçŒªè‚‰ç‚–ç²‰æ¡å­ï¼Œè€™å­è‚‰ï¼Œå˜å˜é¦™ã€‚ä½†ä½ è®°ä½ä¸€ç‚¹ï¼Œåƒä¸‡åˆ«é—®è‚‰å¤šå°‘å¹´ï¼Œé—®ä½ å°±åƒä¸ä¸‹äº†ï¼Œå› ä¸ºåŸºæœ¬ä¸Šéƒ½æ˜¯ 80 å¹´é™ˆé…¿æ‹‰è²ï¼Œä¸€å®šæ˜¯å†»è‚‰ï¼Œä¸€å®šæ˜¯å†»äº† 20 å¹´ã€10 å¹´ä»¥ä¸Šçš„è‚‰ï¼Œä¸ç„¶æ€ä¹ˆé‚£ä¹ˆä¾¿å®œã€‚æ‰€ä»¥ä½ ä»¬ä¹Ÿä¸è¦ç§ä¸èµ·é¢„åˆ¶èœï¼Œæˆ‘è§‰å¾—é¢„åˆ¶èœå¾ˆå¥½ï¼Œæ²¡æœ‰é¢„åˆ¶èœè€ç™¾å§“æ—¥å­æ›´è‹¦ï¼Œæœ‰é¢„åˆ¶èœè€ç™¾å§“å¥½ä¸€ç‚¹ï¼Œä¸ºå•¥ï¼Ÿ12 å—é’±èƒ½åƒé¥±ï¼Œè¿˜èƒ½åƒä¸Šè‚‰ï¼Œåƒä¸Šè¶³å¤Ÿçš„è›‹ç™½è´¨ã€‚\nä½ å°±è®°ä½ä¸€ç‚¹ï¼Œå½“ä½ éƒ½åƒ 12 å—é’±äº†ï¼Œä½ è¿˜æ³¨æ„è‚‰å¤šå°‘å¹´å—ï¼Ÿç°åœ¨ç»Ÿè®¡ä¸­å›½åœ¨è®²éœ€æ±‚çš„æ—¶å€™å¾ˆæœ‰æ„æ€ï¼Œæˆ‘ä»æ¥ä¸ä¼šç”¨ä¸€ä¸ªæ•°å­—ï¼Œä»æ¥ä¸ä¼šç”¨ä¸­å›½çš„ CPIï¼Œä¸­å›½çš„ CPI ä¸€ç›´æœ‰ä¸€ä¸ªå¤§çš„é—®é¢˜ï¼Œå½“å¹´å®è§‚ç»æµæ•°æ®è®¾ç«‹çš„æ—¶å€™ä¸­å›½è€ç™¾å§“ç¬¬ä¸€ç›®æ ‡æ˜¯è§£å†³åƒç©¿ï¼Œè§£å†³æ¸©é¥±ï¼Œæ‰€ä»¥å¯¹æˆ‘ä»¬æ¥è®²ï¼Œç‰©ä»·ä¸­çš„èœä»·ã€çŒªè‚‰ä»·æ ¼ã€ç²®é£Ÿä»·æ ¼ã€æ²¹ä»·æ³¢åŠ¨ï¼Œæˆ‘ä»¬çœ‹çš„æ¯”å¤©éƒ½å¤§ã€‚\né‚£æ—¶å€™ä¸€èˆ¬æ¥è®²ï¼Œé¢†å¯¼ä»¬ä¸‹å»åšæ…°é—®çš„æ—¶å€™ï¼Œç¬¬ä¸€ä»¶äº‹å„¿éƒ½æ˜¯å»å®¶é‡Œæ€é”…ï¼ŒåŠ¨ä½œéƒ½å¾ˆæ ‡å‡†ï¼Œæ‰“å¼€é”…çœ‹çœ‹ä½ åƒå•¥ï¼Œè¿™ä¸ªåŠ¨ä½œå…¶å®å°±æ˜¯å› ä¸ºå½“å¹´æˆ‘ä»¬çš„é‡è¦é—®é¢˜æ˜¯è§£å†³è€ç™¾å§“çš„åƒç©¿ä½è¡Œï¼Œæ‰€ä»¥æˆ‘ç¬¬ä¸€ä»¶äº‹æƒ…å°±å…³æ³¨ä½ åƒçš„æƒ…å†µã€‚ä½†æ”¹é©å¼€æ”¾ä¸‹æ¥ä»¥åï¼Œåˆ°ç°åœ¨ä¸ºæ­¢ï¼Œåƒå¦‚æœéƒ½æˆé—®é¢˜ï¼Œé‚£å°±æ˜¯å¤§é—®é¢˜äº†ã€‚\nä¸ºä»€ä¹ˆä¸ç”¨æ•°æ®ï¼Ÿå› ä¸ºæ•°æ®ä¸­è¿™éƒ¨åˆ†çš„æ³¢åŠ¨å¾ˆå¤§ï¼Œè¿™éƒ¨åˆ†çš„æ³¢åŠ¨å·²ç»è·Ÿéœ€æ±‚æ²¡å…³ç³»äº†ã€‚æ¯”å¦‚è¯´åŸå¸‚é‡Œæ´ªæ¶ï¼Œé‚£è”¬èœä»·æ ¼é‚£å‡ å¤©å°±ä¼šæš´æ¶¨ï¼Œé‚£ç§å˜åŠ¨å…¶å®å½±å“å·²ç»ä¸é‡è¦äº†ã€‚æˆ‘ä»¬ç°åœ¨è®²éœ€æ±‚ï¼Œæ¯”å¦‚ä¸­å›½ç»æµä» 2019 å¹´è·å¾—å¤§é—®é¢˜ï¼Œéå¸¸éº»çƒ¦ï¼Œä½ ä»¬ä¸è¦è§‰å¾—ç°åœ¨çš„ç»æµé—®é¢˜æ˜¯ç°åœ¨ï¼Œæ˜¯ 2019 å¹´å°±å¼€å§‹äº†ï¼Œåœ¨ä»Šå¹´æ˜¯æ¶åŒ–çš„ï¼Œæ‰€ä»¥ä»Šå¹´çš„æƒ…å†µä½ ä»¬éƒ½ä¸çŸ¥é“æœ‰å¤šä¸¥å³»ï¼Œæ•°æ®é‡Œå·²ç»å‘Šè¯‰ä½ ï¼Œéå¸¸ä¸¥å³»ï¼Œè€Œåœ¨è°ƒç ”çš„æ—¶å€™æ›´ä¸¥å³»ã€‚\n8ã€9 æœˆä»½çš„æ—¶å€™ï¼Œå¿…é¡»è½¬å‘ï¼Œé‚£æ—¶å€™å¾ˆå¤šäººä¸ç†è§£ï¼Œå› ä¸ºè¿‡å»çš„ä¸€å¹´å¤§å®¶éƒ½å…»æˆäº†ä¸€ç§ä¹ æƒ¯ï¼Œè¿™ä¹Ÿæ˜¯å³ç¿¼åŒ–çš„ç‰¹å¾ï¼Œå³ç¿¼åŒ–çš„ç‰¹å¾å°±æ˜¯æˆ‘æ²¡é”™éƒ½æ˜¯ä½ çš„é”™ï¼Œæˆ‘ä¸è®¸ä½ è¯´æˆ‘é”™ã€‚ä½ æƒ³æƒ³ï¼Œå®¶é‡Œçš„è€å©†ä½ æ•¢è¯´å¥¹é”™å—ï¼Ÿåˆ°æœ€åç”·ç”Ÿå°±æ˜¯å‡ºé—¨æŠ½çƒŸï¼Œä¸å­ã€‚\nè¿‡å»å‡ å¹´æˆ‘ä»¬çš„å³ç¿¼ç‰¹å¾å½“ä¸­ä½“ç°å‡ºæ¥çš„ï¼Œå¤§å®¶éƒ½æœ‰ä¸€ç§ä¹ æƒ¯ï¼Œå›½å†…ç»æµä¸è®¸è¯´ä¸è¡Œï¼Œè°è¯´ä¸è¡Œè°å°±æ˜¯å›å¾’ï¼Œè°è¯´ä¸è¡Œè°å°±æ˜¯ä¸çˆ±å›½ï¼Œè°è¯´ä¸è¡Œå°±ç½‘ä¸Šæ”»å‡»ä»–ã€‚é—®é¢˜æ˜¯è¯ç”Ÿäº†å¦å¤–ä¸€ç§ç”Ÿæ„ï¼Œä»€ä¹ˆç”Ÿæ„ï¼Ÿä½ ä»¬æ‡‚å¾—ï¼Œä½ åªè¦è¯´è¿™ä¸œè¥¿é¥é¥é¢†å…ˆï¼Œ8000 å—é’±çš„ä¸œè¥¿å°±èƒ½å– 18000ã€‚\nåœ¨æˆ‘çš„è§’åº¦çœ‹å¾ˆç®€å•ï¼Œè¿™æ˜¯ç¤¾ä¼šçš„æ•´ä½“æ„è¯†å½¢æ€å˜åŠ¨çš„æ ¸å¿ƒï¼Œä½†æ˜¯çœŸæ­£å¯æ€•çš„æ˜¯å¦‚æœå¤§å®¶éƒ½ä¸å»è®²ï¼Œåˆ°äº†å…³é”®çš„æ—¶é—´ç‚¹ä¸Šï¼Œä¼šä½¿å¾—æ‰€æœ‰çš„ä¿¡æ¯åé¦ˆå½¢æˆè°¬è®ºæ€§é”™è¯¯ï¼Œæœ€åä½ ä»¬ä¼šå‘ç°ï¼Œè¿å†³ç­–å±‚éƒ½åšå‡ºé”™è¯¯åˆ¤æ–­ï¼Œé‚£å°±å®Œè›‹äº†ã€‚\nåˆ°æœ€åè°æ˜¯é‚£ä¸ªè¯¯å›½è¯¯æ°‘çš„ï¼Œå†å²ä¼šæœ‰æ­£ç¡®è¯„ä»·ã€‚æœ€ä¸Šå¤´åœ¨å…³é”®çš„æ—¶åˆ»è¯¥åšè°ƒç ”ï¼Œè¯¥è®©ä½ å‘å£°ï¼Œè¿˜æ˜¯è¦å‘å£°çš„ã€‚8ã€9 æœˆä»½åˆ°åº•ä¸­å›½å‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…ï¼Ÿå¤§éƒ¨åˆ†äººåœ¨å½“æ—¶å¹¶ä¸äº†è§£ï¼Œ8 æœˆ 27 æ—¥å¼€å§‹ï¼Œä½ ä»¬å…³æ³¨ä¸€ä¸‹æ‰€æœ‰çš„é‡‘èå³°ä¼šå’Œè®ºå›ä¸Šï¼Œå…¨éƒ¨è®©ä½ æ•å¼€äº†è®²ä¸­å›½ç»æµçš„æ ¸å¿ƒé—®é¢˜ã€‚\nå½“ç„¶åªæ˜¯è¯´æˆ‘å½“æ—¶åœ¨å¤§æ¹¾åŒºè®ºå›ä¸Šè®²è¯æ—¶é—´ä¸å¤Ÿé•¿ï¼Œå¤§å®¶ä¼ æ’­æ›´ä¸ºå¹¿æ³›ï¼Œä½†ä¸æ˜¯è¯´æˆ‘èƒ†å¤§è®²ã€‚å½“æ—¶ä¸‹åˆè®²å®Œä¹‹åï¼Œæ™šä¸Šå°±æœ‰æœ‹å‹å‘ â€œä»˜æ€»ï¼Œè¿™èƒ½è®²å—ï¼Ÿâ€ æˆ‘è¯´ â€œå¦‚æœèƒ½è®²ï¼Œä½ è¦æƒ³æƒ³ä¸ºå•¥ï¼Ÿâ€24 å°æ—¶éƒ½ä¸åˆ°ï¼Œå¤§æ¦‚ 12 å°æ—¶å·¦å³ï¼Œç¬¬äºŒå¤©æ—©ä¸Šæ˜“çº²åŒå¿—åœ¨ä¸Šæµ·çš„å¤–æ»©é‡‘èè®ºå›ä¸Šé©¬ä¸Šè·Ÿä½ è®²å½“å‰ä¸­å›½ç»æµçš„æ ¸å¿ƒé—®é¢˜ï¼Œé€šç¼©çš„é£é™©ï¼Œä»¥åŠç»æµæœ‰æ•ˆéœ€æ±‚ä¸è¶³ï¼Œæ‰€æœ‰äººä» 8 æœˆä»½åˆ° 9 æœˆä»½ï¼Œç”¨çš„è¯éƒ½æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼Œä¸­å›½ç»æµå½“å‰æ ¸å¿ƒé—®é¢˜æœ‰æ•ˆéœ€æ±‚ä¸è¶³ã€‚å…¶å®æˆ‘æƒ³è¯´ï¼Œæœ‰æ•ˆéœ€æ±‚ä» 2019 å¹´å¼€å§‹å°±åœ¨ä¸‹é™äº†ï¼Œè€Œæ­¤æ¬¡çš„æœ‰æ•ˆéœ€æ±‚éå¸¸éº»çƒ¦ï¼Œå¯ä»¥è¯´æ˜¯æˆ‘ä»¬æ”¹é©å¼€æ”¾ä¹‹åçš„ç™¾å¹´ä¹‹æœªæœ‰å¤§å˜å±€ã€‚\næˆ‘åœ¨ 9 æœˆåˆçš„æ—¶å€™ï¼Œæçš„æ”¿ç­–å»ºè®®é‡Œï¼Œæˆ‘éƒ½æ²¡æœ‰ç”¨ â€œè§£å†³â€ï¼Œæˆ‘ç”¨çš„æ˜¯ â€œå¯¹å†²â€ã€‚9 æœˆ 11 æ—¥æˆ‘æ€•å¤§å®¶å¯¹è¿™ä¸ªäº‹å„¿ç†è§£ä¸æ·±åˆ»ï¼Œå½“æ—¶æ¼”è®²çš„åŸé¢˜ç›®æ˜¯è¦æ³¨æ„æœ‰æ•ˆéœ€æ±‚é—®é¢˜ï¼Œèµ¶å¿«å‡ºæ”¿ç­–å¯¹å†²ï¼Œ9 æœˆ 11 æ—¥æˆ‘æŠŠä¸œè¥¿åˆç»™ä½ å†™å‡ºæ¥ï¼Œå†è®²äº†ä¸€éã€‚\nä½†é‚£æ—¶å€™ä¼šå‘ç°ç¤¾ä¼šä¸Šçš„æ•´ä½“é£æ°”ä¾æ—§æ²‰æµ¸åœ¨ â€œä¸è®¸è¯´æˆ‘ä»¬ä¸è¡Œï¼Œæˆ‘ä»¬æŒºå¥½çš„â€ã€‚åˆ°ç°åœ¨ä¸ºæ­¢ï¼Œç°å®æƒ…å†µæ˜¯ä»€ä¹ˆï¼Ÿä½ è§‰å¾—èµ„æœ¬å¸‚åœºèµ·æ¥è¿™ä¸€ä¸‹ï¼ŒçŒ›å†²è¿™ä¸€ä¸‹è·Ÿç»æµå¥½æœ‰å…³ç³»å—ï¼Ÿæ°æ°å‡ºç°çš„æƒ…å†µæ˜¯ç»æµå·®æ‰æ¥äº†è¿™ä¹ˆä¸€ä¸‹ï¼Œè€Œä¸æ˜¯ç»æµå¥½ã€‚ç°åœ¨å‡ºçš„æ‰€æœ‰æ”¿ç­–æœ‰æ²¡æœ‰è¾¾åˆ°ç›®æ ‡å‘¢ï¼Ÿæœ‰ä¸€è®²ä¸€ï¼Œæ²¡æœ‰ã€‚èƒ½ä¸èƒ½è¾¾åˆ°å¯¹å†²çš„ç›®æ ‡å‘¢ï¼Ÿæˆ‘è§‰å¾—å¯¹å†²ä¸€ç‚¹ç‚¹ï¼Œè§£å†³è‚¯å®šä¸å¯èƒ½ï¼Œå› ä¸ºä½ å¦‚æœä»”ç»†åœ°äº†è§£è¿™æ¬¡æœ‰æ•ˆéœ€æ±‚çš„å¤æ‚æ€§ï¼Œæ„æ€æ˜¯å‘Šè¯‰ä½ è¿™äº‹å„¿æŒºéš¾ï¼Œå› ä¸ºé‡Œé¢æºæ‚äº†ä¸­çŸ­é•¿æœŸçš„å› ç´ ã€‚å…¶å®åœ¨ç–«æƒ…åï¼Œæˆ‘ä»¬å½“æ—¶å°±åšå‡ºä¸­å›½å›½å†…ç»æµçš„é¢„æœŸå¾ˆé«˜ä½†ç°å®å¾ˆå·®çš„æ ¹å› ä¹Ÿæ¥è‡ªäºæœ‰æ•ˆéœ€æ±‚èƒŒåçš„çŸ›ç›¾ã€‚\næœ‰è°è®°å¾—å‰ä¸¤å¹´æˆ‘åœ¨å„ä¸ªå…¬å¼€æ¼”è®²ä¸­ï¼Œä¸€ç›´è·Ÿä½ å¼ºè°ƒå›½å†…ç»æµçš„æ ¸å¿ƒå˜é‡æ˜¯ä»€ä¹ˆå—ï¼Ÿæˆ‘è€è·Ÿä½ ä»¬è®²åˆ°äººå£çš„é—®é¢˜ï¼Œè€è·Ÿä½ è®²åˆ°è€é¾„åŒ–çš„é—®é¢˜ï¼Œå‡ å¹´å‰è·Ÿä½ ä»¬è®²åˆ°ç°åœ¨ä¸ºæ­¢ï¼Œé€šè¿‡é‡‘èå¸‚åœºã€èµ„æœ¬å¸‚åœºã€é“¶è¡ŒèƒŒåçš„æ•°æ®å¤§æ¦‚éƒ½èƒ½çœ‹æ˜ç™½åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆï¼Œè€é¾„åŒ–å¯¹äºä¸­å›½ã€éŸ©å›½ã€æ—¥æœ¬éƒ½ä¸æ˜¯å¥½äº‹å„¿ã€‚\nè¥¿æ–¹ç»æµç ”ç©¶ä¸­ç ”ç©¶ç§»æ°‘æ”¿ç­–ï¼Œä¸­å›½ã€éŸ©å›½ã€æ—¥æœ¬ç ”ç©¶äººå£å‡ºç”Ÿï¼Œå› ä¸ºè¿™å‡ ä¸ªå›½å®¶çš„å†å²å†³å®šäº†ä»–ä¸ä¼šæœ‰å¤§è§„æ¨¡ç§»æ°‘çš„ã€‚ä½ åˆ«åŠ¨ä¸åŠ¨å°±æ¥ä¸€å¥ï¼Œè€é¾„åŒ–äº†äººå£å‡ºç”Ÿå°‘äº†ï¼ŒåŒ—æ¬§æ€ä¹ˆæ€ä¹ˆæ ·ï¼Œå¥½å®¶ä¼™ï¼Œä½ è¿™ä¸€åˆ€åˆ‡å‡ºå»ï¼Œä½ ç©è¿‡ã€Šæ–‡æ˜ã€‹å—ï¼Ÿé©¬ä¸Šã€Šæ–‡æ˜ã€‹å°±è¦ä¸Šæ–°äº†ï¼Œå¤§å®¶å¯ä»¥ Steam ä¸Šä¸‹è½½ç©ä¸€ç©ï¼Œå¼€å±€èµ„æºè¦ç´ æ˜¯ä¸ä¸€æ ·çš„ï¼Œæœ€åä½ ç»„æˆçš„æ–‡æ˜å’Œå¸å›½å‘å±•æˆ˜ç•¥ä¹Ÿæ˜¯ä¸åŒçš„ï¼Œåˆ«åŠ¨ä¸åŠ¨åšçå¯¹æ¯”ï¼Œæ²¡ç”¨çš„ï¼Œè¿™å°±æ˜¯ä¸­å›½ç»æµçš„å¤§é—®é¢˜ã€‚\nè¿™æ˜¯æ‰€æœ‰è¿™æ¬¡æœ‰æ•ˆéœ€æ±‚çš„ç»„åˆï¼ŒåŒ…æ‹¬ä¸‹é¢æˆ‘ä»¬å¯¹çš„æ”¿ç­–å»ºè®®ï¼Œä¸ç”¨çœ‹äº†ï¼Œæ„ä¹‰ä¸å¤§ã€‚\næ ¸å¿ƒçš„å°±ç”¨è¿™ä¸¤å¼ å›¾å¤Ÿäº†ï¼Œå¾ˆç®€å•ã€‚\nç¬¬ä¸€ï¼Œæˆ‘ä¸ä¼šç”¨ CPI è¿™ä¸ªæ•°å­—å°±æ˜¯å› ä¸ºé‡Œé¢å«äº†å®é™…ä¸Šå·²ç»è·Ÿç°åœ¨æœ‰æ•ˆéœ€æ±‚æ²¡å¤ªå¤§å…³ç³»çš„ã€‚ç”¨çš„ä»€ä¹ˆå‘¢ï¼ŸæŠŠé«˜æ¸…å¤§å›¾æ”¾å¤§åˆ° 2007 å¹´ä¹‹åï¼Œæˆ‘ä»¬ç”¨çš„æ˜¯æ‰£é™¤é£Ÿå“å’Œèƒ½æºä»¥åçš„é€šèƒ€ã€‚ç®€å•è®²ï¼Œæˆ‘è¦å…³å¿ƒçš„æ˜¯è€ç™¾å§“åƒé¥±é¥­ä»¥åæ²¡äº‹å„¿å¹²çš„ä»·æ ¼ï¼Œä½ æ²¡äº‹å„¿å¹²çš„ä»·æ ¼é«˜ï¼Œå°±è¯´æ˜ä½ çš„æœ‰éœ€æ±‚å¥½ï¼Œä½ æ²¡äº‹å„¿å¹²çš„ä»·æ ¼ä½ï¼Œå°±è¯´æ˜ä½ æœ‰æ•ˆéœ€æ±‚å·®ï¼Œå°±è¿™ä¹ˆç®€å•ã€‚è‡³äºåƒé¥­è¿™ä»¶äº‹æƒ…ï¼Œéå¸¸å®¹æ˜“è§£å†³ï¼Œé¾™æ±ŸçŒªè„šé¥­ã€‚\nè¯´å®è¯ï¼Œä½ ä»¬ç‚¹ 20 å—é’± 30 å—é’±çš„å¤–å–ï¼Œæˆæœ¬ä»·æ ¼å°± 4 å—é’±ï¼Œ4 å—é’±ä½ éƒ½åƒçš„å˜å˜é¦™ï¼Œå¯ä»¥æƒ³æƒ³ï¼Œé£Ÿå“å·¥ä¸šå‘å±•åˆ°ç°åœ¨ä¸ºæ­¢ï¼Œé˜²è…å‰‚ã€æ·»åŠ å‰‚ä¸€åŠ ï¼Œæˆæœ¬æ˜¯å¾ˆä½çš„ã€‚å½“ç„¶äº†ï¼Œåšä¸åˆ°æ—¢è¦åˆè¦è¿˜è¦ï¼Œæ—¢ä¾¿å®œï¼Œåˆå¥½åƒï¼Œè¿˜å¥åº·ï¼Œè¿˜å¾—æ˜¯å¨å­ç°å‰²è‚‰ç°åšï¼Œä½ æƒ³å¤šäº†ï¼Œä½ è¦æƒ³åƒç°å‰²è‚‰ç°åšï¼Œä½ æ 50ï¼Œæˆ‘å»ä½ å®¶åšï¼Œä½ å°±æ 5 å—ï¼Œé‚£å°±æ˜¯é¢„åˆ¶èœã€‚ä½ ä»¬è¦æ˜ç™½ï¼Œè¿™æ˜¯è§£å†³åƒå–æ‹‰æ’’å¾ˆé‡è¦çš„å› ç´ ã€‚æœ‰çš„æ—¶å€™ï¼Œå·¦å³ä¸¤è¾¹ä¸å¯å…±åŒéƒ½æœ‰ï¼Œå¥åº·å’Œä¾¿å®œä¸å¯èƒ½åŒæ—¶å­˜åœ¨çš„ï¼Œæ‰€ä»¥å¥åº·å¾ˆè´µçš„ã€‚\nå¤§å®¶å…ˆçœ‹æ”¾å¤§ç‰ˆçš„æ•°å­—ï¼Œ2019 å¹´æ˜¯æ•´ä¸ªå¹³å°çš„é¡¶å³°æœŸï¼Œ2019 å¹´åçš„å…¸å‹ç‰¹å¾æ˜¯æ€»éœ€æ±‚æ›²çº¿ä¸€ç›´åœ¨é™ã€‚10 æœˆä»½çš„æ•°å­—æ˜¯è´Ÿçš„ï¼Œæ²¡æœ‰ç–«æƒ…ï¼Œæ²¡æœ‰ 2008 å¹´é‡‘èå±æœºçš„å¤–éœ€å´©å¡Œï¼Œä» 2002â€”2024 å¹´ï¼Œé•¿è¾¾ 22 å¹´çš„æ—¶é—´é‡Œï¼Œåœ¨æ²¡æœ‰ä»»ä½•é‡å¤§é£é™©çš„æƒ…å†µä¸‹ï¼Œä¸­å›½ç¬¬ä¸€æ¬¡å‡ºç°äº†æœ‰æ•ˆéœ€æ±‚ä¸ºè´Ÿã€‚è´Ÿæ•°å•¥æ„æ€ï¼Ÿéå¸¸ç®€å•ï¼Œä¸­äº§é˜¶çº§èŠ‚è¡£ç¼©é£Ÿï¼Œè¿™ä¸ªå®è§‚æ•°æ®å°±å‘Šè¯‰ä½ è¿™ä¸ªç­”æ¡ˆã€‚\nåˆšæ‰æˆ‘è®²äº†ï¼Œåº•å±‚è€ç™¾å§“æ˜¯ä¸€ç‚¹ç‚¹å¾€ä¸Šåé¦ˆçš„ï¼Œä¸ä¼šå¾ˆå¿«åœ°ä½œç”¨åˆ°å®è§‚ç»æµæ•°æ®é‡Œï¼Œæ‰€ä»¥ä½ ä»¬åœ¨ç–«æƒ…åçœ‹åˆ°çš„è¿™ä¸ªæ•°å­—å¤§å¹³å°è¿˜æ²¡æœ‰å¿«é€Ÿå¾€ä¸‹æ‰ï¼Œä½†å½“æ—¶çš„åº•å±‚ï¼ˆç½‘çº¦è½¦å¸æœºã€é€å¤–å–ï¼‰å…¶å®ä¸€ç‚¹ç‚¹åœ¨ç—›è‹¦ï¼Œä½†é‚£æ—¶å€™å»é‡‘èæœºæ„åšè·¯æ¼”ï¼Œä»–ä»¬éƒ½æ²¡æœ‰è¿™ç§æ„Ÿè§‰ã€‚ä»Šå¹´æ‰€æœ‰é‡‘èæœºæ„éƒ½è§‰å¾—å¾ˆç—›è‹¦çš„åŸå› æ˜¯å•¥ï¼Ÿå› ä¸ºä»–ä»¬è¢«è£å‘˜äº†ï¼Œä»–ä»¬è¢«é™æœ¬å¢æ•ˆäº†ï¼Œä»–ä»¬è¢«è¦æ±‚å¥–é‡‘é€€å›äº†ï¼Œæ¿å­æ‰“åˆ°äº†ä»–ä»¬çš„é˜¶å±‚ä¹‹åï¼Œä»–ä»¬å¼€å§‹æ„Ÿå—åˆ°äº†ç—›è‹¦ã€‚ä½ çŸ¥é“è¿™ä»£è¡¨ä»€ä¹ˆå—ï¼Ÿä»Šå¹´ç»æµä¸ºä»€ä¹ˆä» 3 æœˆä»½ä¹‹åè¿™ä¸ªæ•°å­—ä¸€è·¯æ‰ä¸‹æ¥ï¼Œç­”æ¡ˆéå¸¸ç®€å•ï¼Œä»Šå¹´çš„å¤§éº»çƒ¦æ˜¯ä¸­äº§é˜¶çº§é™¨è½ã€‚\nåˆ«è¯´ä»Šå¹´äº†ï¼Œè¿™ä¸¤å¹´åº•å±‚æ…¢æ…¢ â€œæ‹¼å¤šå¤šâ€ï¼Œç°åœ¨åº”è¯¥æ˜¯ä¸­äº§é˜¶çº§å¼€å§‹ â€œæ‹¼å¤šå¤šâ€ï¼Œä»Šå¹´æœ€å¥½çš„æ ·æœ¬å‚æ•°è°ƒç ”åº”è¯¥æ˜¯éš”å£çš„æ­å·ï¼Œå…¶å®ä¸Šæµ·ä¹Ÿå¯ä»¥åšè°ƒç ”ï¼Œå·®ä¸å¤šã€‚3 æœˆä»½é™æœ¬è£å‘˜è£è€å¼ ï¼Œ6 æœˆä»½é™æœ¬è£å‘˜è£è€æï¼Œæˆ‘å°±é—®ä½ è€ç‹æ€ä¹ˆåŠï¼Ÿå›å®¶è·Ÿåª³å¦‡å¼€ä¸ªé¦™æ§Ÿåº†ç¥ä¸€ä¸‹ï¼Œè€å¼ ã€è€æè¢«è£äº†ï¼Œæˆ‘æ²¡è¢«è£ï¼Œæ˜¯è¿™æ ·å—ï¼Ÿç°å®çš„æƒ…å†µæ˜¯å›å®¶èµ¶ç´§è·Ÿè€å©†ç®—è´¦ï¼Œå›½é™…å­¦æ ¡å¤šå°‘é’±ï¼Œå­©å­å¤šå°‘é’±ï¼Œé¢è†œå¤šå°‘é’±ï¼Œå¥èº«æˆ¿å¤šå°‘é’±ï¼Œè¯¥èŠ±çš„ä¸è¯¥èŠ±çš„å¤šå°‘é’±ï¼Œæˆ¿è´·æ¬ äº†å¤šå°‘é’±ï¼Œä¸€ç®—è´¦åˆ—ä¸€ä¸ªæ•°å­—ï¼Œå‡è®¾è¢«è£å‘˜æ€ä¹ˆåŠï¼Ÿç®—å®Œè·Ÿè€å©†è¯´ï¼Œä½ çš„é¢è†œ SPA ä¸­å¿ƒåˆ«å»äº†ï¼Œæä½³ç¦çš„ç›´æ’­é—´æ‹ä¸€ä¸ªç³Šè„¸ä¸Šå·®ä¸å¤šã€‚ç„¶åä½ å¼€å§‹èŠ‚è¡£ç¼©é£Ÿæ”¶ç¼©ï¼Œä½ çš„æ”¶ç¼©æ˜¯è¦å‘½çš„ã€‚è®°ä½ä¸€ç‚¹ï¼Œä¸­äº§é˜¶çº§çš„æ”¶ç¼©å¯¹æ•´ä¸ªå®è§‚ç»æµæ˜¯å†²å‡»æœ€å¤§çš„ã€‚\nåº•å±‚çœŸçš„æ˜¯ä»Šå¤©å¹²ä¸ªæ´»å„¿ï¼Œè·‘è·‘ï¼Œæœ‰é’±æŒ£æ²¡é’±æŒ£éƒ½å¾—åƒä¸ªé¾™æ±ŸçŒªè„šé¥­ï¼Œåæ­£ä¹Ÿä¸è´µã€‚å¤šæŒ£é’±äº†ï¼Œè·‘ä¸ªå•ç‹ï¼Œè·Ÿè€æ¿è¯´ â€œé¾™æ±ŸçŒªè„šé¥­åŠ ä¸ªè›‹â€ï¼Œä»Šå¤©å„ä½åœ¨å¤–å–å¹³å°ä¸Šç»™æ‰“èµ 10 å—é’±å°±æ˜¯é¾™æ±ŸçŒªè„šé¥­åŠ ä¸ªè›‹æ¥ä¸ªè…¿ã€‚\næˆ‘æ²¡æœ‰å¤ªå¤šæŠ•èµ„çš„ç¾¤ï¼Œä½†æˆ‘ä¼šæ½œä¼åœ¨å…¨å›½å¤–å–å°å“¥ã€ç½‘çº¦è½¦å¸æœºçš„ç¾¤é‡Œï¼Œå› ä¸ºä»–ä»¬æ˜¯æˆ‘å¹¿å¤§è°ƒç ”é˜¶å±‚çš„æ ·æœ¬å‚æ•°ã€‚æˆ‘ç”šè‡³è¿˜æœ‰ä¸ªæ ·æœ¬å‚æ•°æ˜¯å…¨å›½æœ€å¤§çš„ç¾å®¹è¿é”åº—çš„è€æ¿ï¼Œæˆ‘ç»å¸¸æ‹¿ä»–å½“è°ƒç ”æ ·æœ¬ï¼Œä¸ºå•¥ï¼Ÿä»–èƒŒåçš„ 2000 å¤šå®¶åº—ï¼Œä»¥åŠåº—åé¢çš„é‚£äº›å¥³äººä»¬ï¼Œé‚£å°±æ˜¯æ ‡å‡†çš„æ¶ˆè´¹è°ƒç ”æ ·æœ¬å‚æ•°ï¼Œä»–çš„ç”Ÿæ„å¥½ç»æµå°±å¥½ï¼Œä»–çš„ç”Ÿæ„å·®ç»æµå°±å·®ã€‚æ­å·ä»Šå¹´ä¸ŠåŠå¹´åº”è¯¥æœ‰ 500 å®¶ç¾å®¹åº—è¦è½¬è®©ï¼Œä½ ä»¬æœ‰è°è¦çš„æˆ‘ç»™ä½ ä»¬æ­ä¸ªçº¿ã€‚ä½ ä»¬ä¼šè¦å—ï¼Ÿä½ è¦çŸ¥é“ï¼Œä¸ç®¡æ˜¯æ­£å®«å¨˜å¨˜è¿˜æ˜¯éæ­£å®«å¨˜å¨˜ï¼Œéƒ½æ²¡é’±äº†ï¼Œå¥¹èƒŒåçš„ç”·äººä»¬éƒ½æ²¡é’±äº†ã€‚\nä½ è¯´æ¶ˆè´¹é™çº§å—ï¼Ÿå…¶å®ä¸ä»…ä»…æ˜¯é™çº§ï¼Œä½ ä»¬ä¸€å®šè¦è®°ä½ï¼Œè¿™ä¸ªå¤§å‘¨æœŸçš„ç»“æŸå¾ˆå¯æ€•çš„ï¼Œå› ä¸ºè¿™æ˜¯å¤§éƒ¨åˆ†ä¸­å›½æŠ•èµ„äººé‡Œç¬¬ä¸€æ¬¡ç»å†è¿™æ ·çš„å‘¨æœŸã€‚\nä¸­å›½è¯åˆ¸å¸‚åœºååº”éå¸¸ç²¾å‡†ï¼Œä¸è¦å†çœ‹ä¸Šè¯ç»¼æŒ‡ï¼Œé‚£ä¸ªæ„ä¹‰ä¸å¤§çš„ï¼Œæˆ‘ä»¬ç»å¸¸è®²æœ‰ç»“æ„æ€§è¡Œæƒ…ï¼Œä¸€ç‚¹é”™æ²¡æœ‰ï¼Œç»“æœé‡Œå¯¹ç»æµã€æ”¿ç­–çš„ååº”éå¸¸å‡†ç¡®ï¼Œä¸æ˜¯ä¸å‡†ç¡®ï¼Œæ˜¯éå¸¸å‡†ç¡®ã€‚æ‰€ä»¥è¯´ä½ çœŸæ­£åœ¨è¿™å‡ å¹´å¯¹å®è§‚ç»æµçš„ç†è§£ï¼Œå°±æ˜¯å‘Šè¯‰ä½ ä¸€å¥è¯ï¼Œæ²¡æœ‰å¢é‡ï¼Œå°±æ˜¯ç»“æ„ï¼Œå¯¹ç»“æ„æ€ä¹ˆæŠŠæ¡ï¼Ÿè¿™é‡Œçš„ç»“æ„å¯ä¸æ˜¯ 40 å¹´å‰çš„ç»“æ„ã€‚\nå‰ä¸¤å¤©æˆ‘è·Ÿä¸€å®¶å…¬å¸è¯´äº†ä¸€å¥è¯ï¼Œé»‘è‰²çº¿æ˜¯ PPIï¼Œç›¸ä¿¡åœ¨åº§å„ä½éƒ½æ˜ç™½ï¼ŒPPI æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿç®€å•è®²å°±æ˜¯ä¼ä¸šåˆ©æ¶¦ï¼ŒPPI ä¸ºè´Ÿï¼Œå¤§å®¶å°±æ˜¯åœ¨æ‹¼å‘½åœ°ä»·æ ¼æˆ˜ã€ç«äº‰ï¼Œæˆ‘å·ä½ ï¼Œä½ å·æˆ‘ï¼Œä¸Šæ¸¸å·å®Œå·ä¸‹æ¸¸ï¼Œä¸‹æ¸¸å·å®Œå·å®¢æˆ·ï¼Œå·åˆ°æœ€åå°±å·åˆ°è°èƒ½æ´»ç€ï¼Œè¿™å°±æ˜¯ PPI ä¸ºè´Ÿçš„ç­”æ¡ˆã€‚\nä¸­å›½è¿™äºŒåå¤šå¹´æ¥ï¼Œä» 2002 å¹´å¼€å§‹ï¼Œæˆ‘ä»¬çš„ç»æµä»æ¥æ²¡æœ‰é‡åˆ°å¤§é—®é¢˜çš„æ ¹å› éå¸¸ç®€å•ï¼Œçº¢è‰²çº¿æ°¸è¿œå­˜åœ¨ï¼Œä¸Šé¢çš„çº¢è‰²çº¿å­˜åœ¨ã€‚\nä¸­å›½ç»æµçš„ä»»ä½•ä¾›ç»™é—®é¢˜éƒ½æ˜¯æœ‰éœ€æ±‚åœ¨çš„ï¼Œæœ‰å†…éƒ¨éœ€æ±‚æœ‰å¤–éƒ¨éœ€æ±‚ï¼Œå¤–éƒ¨éœ€æ±‚æ˜¯å…¨çƒåŒ–å¯¹æˆ‘ä»¬çš„æ”¯æ’‘ï¼Œå†…éƒ¨éœ€æ±‚æ˜¯ä»€ä¹ˆï¼Ÿæˆ¿åœ°äº§å¤§ä½¬ç°åœ¨å¥½åƒåœ¨é‡Œå¤´è¸©ç¼çº«æœºï¼Œä»–å½“å¹´æ›¾ç»è¯´è¿‡ä¸€å¥ç»å…¸çš„è¯ï¼Œâ€œä»€ä¹ˆæˆ¿åœ°äº§ã€ä¾›åº”ã€éœ€æ±‚ã€åœŸåœ°å¼€å‘ã€åŸé•‡åŒ–ï¼Œæ‰¯æ·¡ï¼Œå°±ä¸€å¥è¯ï¼Œæˆ‘ä»¬æœ‰åºå¤§çš„ 80 åâ€ã€‚æˆ‘è§‰å¾—ä»–è¯´çš„éå¸¸è¯šæ³ï¼Œå› ä¸ºéœ€æ±‚å†…éœ€åˆ°åº•æ˜¯å•¥ï¼Ÿæœ¬è´¨ä¸Šå°±æ˜¯äººå£æ”¶å…¥çš„å€ºåŠ¡å‡½æ•°ã€æ æ†å‡½æ•°ã€‚\næ‰€ä»¥ä½ å°±çŸ¥é“ï¼Œä¸­å›½å†…éœ€åºå¤§çš„ä¸€ä»£æ˜¯è°ï¼Œå°±æ˜¯è¿™æ‰¹ 80 åã€‚æ˜¯ â€œæ–‡é©â€ ä¹‹åäººå£åŸºæ•°æœ€å¤§çš„é‚£æ‰¹ï¼Œå¯ä»¥èŠ± 3 ä¸ªé’±çš„ï¼Œå¯ä»¥èŠ±è¿‡å»æ—¶ï¼Œä¸Šä¸€ä»£äººç»™ä½ ç•™ä¸‹çš„ 6 ä¸ªå£è¢‹ã€‚å¯ä»¥èŠ±å½“ä¸‹æ—¶ï¼Œä½ çš„ä¼ä¸šè€æ¿ç»™ä½ çš„æ”¶å…¥å‡½æ•°ã€‚å¯ä»¥èŠ±æœªæ¥æ—¶ï¼Œé‡‘èæœºæ„ç»™ä½ ä»¬çš„æ æ†ã€‚ä½ ä»¬æ˜¯èŠ±ä¸‰ä»£çš„é’±ï¼Œä¸€ä»£çš„äººå£é«˜å³°ï¼Œé‚£å°±æ˜¯ä¸­å›½å†…éœ€çš„æ‰€æœ‰åº•ç‰Œã€‚ä¸­å›½ç»æµçš„ä»»ä½•é—®é¢˜éƒ½å¯ä»¥ç”±è¿™éƒ¨åˆ†äººä¹°å•ï¼Œæ‰€æœ‰å€ºåŠ¡é—®é¢˜ã€ç»æµé—®é¢˜å‡ç”±è¿™ä»£äººä¹°ï¼Œé‚£å°±ä¸ä¼šæœ‰çœŸæ­£æ„ä¹‰ä¸Šçš„ç»æµçš„é£é™©ã€‚\næ¯”å¦‚è¯´ 2008 å¹´ï¼Œç°åœ¨ä¹Ÿä¼šå‘ç°ï¼Œæœ‰äº›æ”¿ç­–è·Ÿ 2008 å¹´å¾ˆåƒï¼Œæˆ¿åœ°äº§æ”¾å¼€ã€é™è´­æ”¾å¼€ã€è´­ç½®ç¨å‡å…ã€æ¶ˆè´¹è¡¥è´´ã€åˆºæ¿€æ¶ˆè´¹ï¼Œä½†ä½ ä»¬éƒ½ä¼šå‘ç°ï¼Œè¿˜èƒ½äº§ç”Ÿ 2008 å¹´æ•ˆæœå—ï¼Ÿèƒ½å›å»å—ï¼Ÿæˆ‘å¯ä»¥æ˜ç¡®å‘Šè¯‰ä½ ï¼Œå›ä¸å»çš„ã€‚\nä½ ä»¬è®°ä½ä¸€ç‚¹ï¼Œé‚£å¥å¿½æ‚ äº†è€ç™¾å§“è¿™å‡ å¹´çš„ä¸€å¥è¯å« â€œåšå†…å€ºä¸æ˜¯å€ºâ€ï¼Œæˆ‘ä¸çŸ¥é“è°è®©è¿™å¥è¯ä¼ å‡ºæ¥çš„ï¼Œå¾ˆå¤šäººåœ¨é‚£å„¿å–Š â€œå†…å€ºä¸æ˜¯å€ºâ€ï¼Œè¿™æ˜¯æˆ‘ä»¬å®¶ç¥–ä¼ å¯¹è”ä¹‹ä¸€ï¼Œä¸‹å¥æ˜¯ä»€ä¹ˆï¼Ÿâ€œå†…å€ºä¸æ˜¯å€ºï¼Œåªè¦äººè¿˜åœ¨â€ æ¨ªæ‰¹ â€œä¸‡ç¨ä¸‡ç¨ä¸‡ä¸‡ç¨â€ã€‚ä»»ä½•å›½å®¶çš„æœ¬å¸å€ºåŠ¡å°±æ˜¯å¯¹è‡ªå·±æœ¬å›½å±…æ°‘çš„å¾ç¨æƒï¼Œç¨ç­‰äºä»€ä¹ˆå‘¢ï¼Ÿç¨åŸº Ã— ç¨ç‡ï¼Œç¨åŸºç­‰äºäººå£å’Œæ”¶å…¥å‡½æ•°ï¼Œä¸€å åŠ å°±æ˜¯äººå£æ”¶å…¥ Ã— ç¨ç‡ï¼Œè¿™å°±æ˜¯ç¨å’Œå€ºåŠ¡ã€‚\nä¸­å›½ç°åœ¨çš„åŒ–å€ºåŒ–ä»€ä¹ˆï¼Ÿè¦ä¹ˆå¢åŠ ç¨ç‡ï¼Œè¦ä¹ˆå¢åŠ äººå£ï¼Œè¦ä¹ˆå¢åŠ æ”¶å…¥ï¼Œäººå£ä¸å¢ï¼Œæ”¶å…¥ä¸å¢ï¼Œç­”æ¡ˆåªæœ‰ä¸€ä¸ªï¼Œå¢ç¨ç‡ã€‚é‚£ä½ çŒœä½ çš„é—äº§ç¨è·‘å¾—äº†å—ï¼Ÿä½ çŒœä½ çš„æˆ¿äº§ç¨è·‘å¾—äº†å—ï¼Ÿæƒ³å•¥å‘¢ï¼Œå¹´è½»äººä¸ç”Ÿï¼Œå’±æ”¶ä¸ç€ä»–ä»¬äº†ï¼Œé‚£å°±æ”¶è€å¹´äººçš„ï¼Œä¸€æ ·çš„ã€‚ä½ è¦çŸ¥é“ï¼Œå€ºåŠ¡ä¸ä¼šåƒä½ æƒ³çš„ â€œå†…å€ºä¸æ˜¯å€ºâ€ï¼Œä½ æƒ³å¤šäº†ï¼Œæœ¬è´¨æ˜¯ç¨æºã€‚\næ”¿åºœå€ºåŠ¡é©±åŠ¨çš„æŠ•èµ„è¡Œä¸ºåªè¦èƒ½æ”¶åˆ°ç¨ï¼Œæ‰€æœ‰æŠ•èµ„è¡Œä¸ºç†è®ºä¸Šéƒ½æ˜¯åˆç†çš„ï¼Œ2008 å¹´ä¸¤ä¸ªç»æµå­¦å®¶åœ¨é‚£å„¿è®¨è®ºé«˜é“åˆ°åº•åº”ä¸åº”è¯¥ä¿®ï¼Œå½“æ—¶ä»–ä»¬ä¿©çš„è®¨è®ºä¸­æˆ‘ç«™åè€…ï¼Œå½“æ—¶åº”è¯¥ä¿®ï¼Œå› ä¸ºä¿®ä¸ä¿®å°±çœ‹èƒ½ä¸èƒ½å¾åˆ°ç¨ï¼Œä½†ä»–ä¿©çš„è®¡ç®—æ–¹å¼æ˜¯ä¸ä¸€æ ·çš„ã€‚å…¶ä¸­ä¸€ä¸ªæ˜¯æŒ‰ç…§æ ‡å‡†çš„å¸‚åœºç»æµå»è®¡ç®—ï¼Œå¸‚åœºç»æµè®¡ç®—ç¨å°±æ˜¯è¿™ä¸ªé¡¹ç›®èƒ½ä¸èƒ½æŒ£é’±ï¼Œæ­å·åˆ°ä¸Šæµ·è¿™æ¡é«˜é“ä¿®å®Œäº†ï¼Œæˆæœ¬æ ¸ç®—å®Œï¼ŒäºŒç­‰ç¥¨éœ€è¦ 150 å…ƒï¼Œè€ç™¾å§“èƒ½ä¸èƒ½æ‰¿æ‹…å¾—èµ·ï¼Œèƒ½æ‰¿æ‹…å¾—èµ·èƒ½è¿è¥å¾—èµ·å°±ä¼šé¡¹ç›®å›æœ¬ã€‚æ‰€ä»¥ä»–ç»å¸¸æŒ‚åœ¨å˜´è¾¹çš„å£å·å°±æ˜¯å¦‚æœé¡¹ç›®ä¸èƒ½æŒ£é’±ï¼Œé‚£åŸåˆ™ä¸Šé«˜é“æ˜¯æµªè´¹çš„ï¼Œå°±æ˜¯çº¯çº¯çš„å€ºã€‚ä»–è¿™å¥è¯åœ¨å½“å¹´æ˜¯ä¸å¯¹çš„ï¼Œå› ä¸ºä¸­å›½éå¸¸å¥‡ç‰¹ï¼Œä¸­å›½çš„ç¨åˆ†ä¸ºé—´æ¥å’Œç›´æ¥çš„ï¼Œä½ åˆšæ‰æ‰€æœ‰çš„æˆæœ¬æ ¸ç®—æ˜¯ç›´æ¥ç¨ï¼Œä½†ä¸­å›½çš„ç‰¹è‰²æ˜¯ç›´æ¥ç¨ä¸Šå‡å…ï¼Œå¢æ”¶é—´æ¥ç¨ã€‚è¿™å°±ç»™ä¸­å›½è€ç™¾å§“ä¸€ç§å¾ˆå¥½çš„æ„Ÿè§‰ï¼Œæˆ‘ä»¬çš„é«˜é“åˆå¿«åˆå¥½è¿˜ä¾¿å®œï¼Œæˆæœ¬ 150 çš„ç¥¨ä»·ï¼Œæˆ‘ä»¬åªéœ€è¦ 60 å°±èƒ½åäº†ï¼Œè€ç™¾å§“è§‰å¾—ç”Ÿæ´»ä¾¿åˆ©ã€‚\nä½ å’‹é‚£ä¹ˆå¤©çœŸå’Œå¯çˆ±å‘¢ï¼Ÿæˆ‘å°±é—®ä½ ï¼Œå‰©ä¸‹çš„ 65 å—é’±è°æï¼Ÿç„¶åå°±æ¥ä¸€å¥ï¼Œå†…å€ºä¸æ˜¯å€ºï¼Œè¿™é’±å›½å®¶æã€‚å’‹å¯èƒ½å‘¢ï¼Ÿè¿™é’±è°æï¼Ÿä½ ä»¬çŸ¥é“ä¸ºä»€ä¹ˆæ‰€æœ‰åŸºç¡€è®¾æ–½ä¸€å®šè·Ÿç€åŸé•‡åŒ–èµ°å—ï¼Ÿä¸€å®šå»ºåœ¨æ–°åŸå—ï¼Ÿä¸€å®šé«˜é“å†…æ–°åŸçš„åœŸåœ°å¾ˆä¾¿å®œï¼Œåœˆå®Œäº†ä¹‹åï¼Œä¸‰é€šä¸€å¹³åšå®Œäº†ï¼Œåå­—æ ¼ä¸€ç”»ï¼ŒåœŸåœ°ä¸€å–ï¼Œç›–ä¸Šæˆ¿å­ï¼Œ80 å 1 ä¸‡å—é’± 2 ä¸‡å—é’±ä¹°æˆ¿å­ï¼Œä»€ä¹ˆæ„æ€ï¼Ÿè¿™å«é—´æ¥ç¨ï¼Œæˆ‘ä»¬æ˜¯é—´æ¥æ”¶ç¨è¡¥ç›´æ¥ã€‚\næ ¸å¿ƒæ˜¯ä»€ä¹ˆï¼Ÿæ ¸å¿ƒå°±æ˜¯åªè¦èƒ½æ”¶ä¸Šé—´æ¥ç¨ï¼Œæ‰€æœ‰çš„æŠ•èµ„æ”¿åºœåŸºå»ºå…¨èƒ½åšï¼Œé—´æ¥ç¨æ”¶ä¸ä¸‹æ¥ï¼Œé¡¹ç›®å°±å®Œè›‹äº†ã€‚ä½ ä»¬çŒœä¸­å›½ä»¥åè¿˜ä¼šæœ‰å¤§è§„æ¨¡åŸºå»ºå—ï¼Ÿæˆ‘å¯ä»¥æ˜ç¡®å‘Šè¯‰ä½ ä¸ä¼šæœ‰äº†ï¼Œåªæœ‰ä¿®ä¿®è¡¥è¡¥ï¼Œå› ä¸ºæœ€å¤§çš„ç¨æºç¨åŸºæ²¡äº†ï¼Œè¿™å°±æ˜¯ 2015ã€2016 å¹´ä¸­å›½ç»æµé‡Œæš´éœ²å‡ºæ¥çš„æœ€å¤§é—®é¢˜ã€‚\nçŸ¥é“æ˜¯ä»€ä¹ˆå—ï¼Ÿå¹´è½»äººï¼Œä½ ä»¬å’‹ä¸ç”Ÿäº†å‘¢ï¼Ÿä½ ä¸ç”Ÿæˆ‘å’‹åŠï¼Ÿä½ ä¸ç”Ÿç¨å’‹åŠï¼Ÿå½“æ—¶çš„äººå£æ‹ç‚¹ï¼Œå¤§è§„æ¨¡è€é¾„åŒ–å¼€å¯ï¼Œå¹´è½»äººä¸å†ç”Ÿè‚²ï¼Œè¿™å°†æ˜¯å·¨å¤§çš„éº»çƒ¦ï¼Œå› ä¸ºæˆ‘ä»¬æ‰€æœ‰å€ºåŠ¡çš„å…œåº•æ²¡äº†ï¼Œè°ç»™æˆ‘ä»¬å…œï¼Ÿæ­¤æ—¶å¾ˆç®€å•ï¼Œå»æµ·å¤–æ”¶ç¨ï¼Œæ‰€ä»¥å¤§å®¶å°±æ˜ç™½ï¼Œæˆ‘ä»¬è¦èµ°å›½é™…åŒ–ï¼Œå›½é™…åŒ–çš„æœ¬è´¨å°±æ˜¯å‘æµ·å¤–å¾ç¨ã€‚æ”¿åºœã€ä¼ä¸šã€é‡‘èå‡å‘å±…æ°‘å¾ç¨ï¼Œè®°ä½ä¸€ç‚¹ï¼Œä¼ä¸šå¾ç¨å°±æ˜¯æ‰€è°“çš„å•†å“é€šèƒ€ï¼Œ1 å—é’±çš„ä¸œè¥¿å– 2 å—é’±ï¼Œå°±æ˜¯å‘å±…æ°‘éƒ¨é—¨æ”¶ 1 å—é’±çš„ç¨ï¼Œä½†å›½å†… PPI æŒç»­ä¸ºè´Ÿï¼Œä»£è¡¨ç€ä¼ä¸šå¾ä¸ä¸Šæ¥ç¨ï¼Œä¼ä¸šæ¶æ€§å¾ªç¯ï¼Œä¼ä¸šå€ºåŠ¡ä¸¥å³»ã€‚PPI ä¸ºæ­£ï¼Œä»£è¡¨ç€ä¼ä¸šå¯ä»¥é€šè¿‡é€šèƒ€ã€ä»·æ ¼è½¬ç§»çš„æ–¹å¼å‘å±…æ°‘è½¬ç§»ï¼Œä¹Ÿå°±æ˜¯å‘ä½ å¾ç¨ã€‚\nåªè¦å±…æ°‘éƒ¨é—¨åœ¨ï¼Œé€šè¿‡ä¾›ç»™ç«¯çš„è°ƒæ•´ï¼Œéƒ½ä¼šå¸¦æ¥å‘¨æœŸæ€§çš„ PPI æ¢å¤ï¼Œç®€å•è®²ï¼Œä¾›ç»™ä¾§æ”¹é©ä¸€æï¼Œæˆ¿åœ°äº§ä¸€æ¨ï¼Œè€ç™¾å§“ä¸€ä¹°å•ï¼Œä¼ä¸šçš„å€ºåŠ¡å°±ä¸æ˜¯å€ºåŠ¡äº†ã€‚æ‰€æœ‰æ”¿åºœçš„å€ºåŠ¡ã€ä¼ä¸šéƒ¨é—¨çš„å€ºåŠ¡ã€é‡‘èéƒ¨é—¨çš„å€ºåŠ¡ï¼Œåªè¦å±…æ°‘éƒ¨é—¨èƒ½æ‰›å¾—åŠ¨ï¼Œéƒ½ä¸æ˜¯å€ºã€‚\nä½ ä»¬çŸ¥é“ç°åœ¨çš„å¤§é—®é¢˜æ˜¯ä»€ä¹ˆå—ï¼Ÿæˆ‘ç°åœ¨è¯´äº†æŸä¸€ä¸ªè¡Œä¸šï¼Œä½ çŸ¥é“æœ‰äº›äººçŠ¯çš„å·¨å¤§é”™è¯¯æ˜¯ä»€ä¹ˆï¼Ÿåˆ°ç°åœ¨ä¸ºæ­¢è·Ÿæˆ‘è®²ï¼Œä»˜æ€» PPI ä¸ºè´Ÿå¾ˆæ­£å¸¸ï¼Œå¸‚åœºåŒ–ç«äº‰ï¼Œä¼˜èƒœåŠ£æ±°ï¼Œå¼±è€…æ·˜æ±°ï¼Œå¼ºè€…èµ¢å®¶é€šåƒã€‚æˆ‘è¯´ç°åœ¨ä¸æ˜¯çš„ï¼Œç°åœ¨ä¼šå‡ºç°ä¸€ç§æƒ…å†µï¼Œéƒ½å¾—æ­»ã€‚ä»–æ²¡æ‡‚ï¼Œåœ¨è¿™ä¸ªå›¾é‡Œä½ ä»¬çœ‹å¾—æ‡‚å—ï¼Ÿ\nä¸€æ˜¯ï¼Œçœ‹ 2011â€”2015 å¹´å‘¨æœŸé‡Œï¼Œ2008 å¹´ 4 ä¸‡äº¿åŸºå»ºï¼ŒåŠ æ æ†ï¼ŒæŠŠæœ‰æ•ˆéœ€æ±‚æ‰©çš„éå¸¸å¥½ï¼Œé‚£æ—¶å€™æ”¿ç­–ä¸€å‡ºï¼Œç»å¯¹ç®¡ç”¨ã€‚ç°åœ¨å¾ˆå¤šå®˜å‘˜çŠ¯çš„é”™è¯¯æ˜¯è§‰å¾—è€ç™¾å§“è¿˜æ˜¯æ›¾ç»çš„è€ç™¾å§“ï¼Œè¿˜ç”¨åŒæ ·çš„æ”¿ç­–ã€‚å½“å¹´çš„æ”¿ç­–æ˜¯æˆ‘å‡†å¤‡ 50 ä¸‡å­æ•¬ä¸ˆæ¯å¨˜å‡†å¤‡ä¹°æˆ¿å­ï¼Œç»“æœä½ è·Ÿæˆ‘è¯´é¦–ä»˜åªéœ€è¦ 40 ä¸‡ï¼Œé‚£ä½ çŸ¥é“å¹´è½»äººæ€ä¹ˆåšå—ï¼Ÿ40 ä¸‡é¦–ä»˜ï¼Œ10 ä¸‡è£…ä¿®ï¼Œè¿˜æ˜¯èŠ± 50 ä¸‡ã€‚ç°åœ¨çš„æƒ…å†µæ˜¯ä»€ä¹ˆå—ï¼Ÿå‘Šè¯‰ä»–ä¸éœ€è¦ 50 ä¸‡ï¼Œåªéœ€è¦ 499ï¼Œå¹´è½»äººè¯´æˆ‘ä¸ç¼ºé‚£ 10 ä¸‡ï¼Œæˆ‘ç°åœ¨ç¼ºé‚£ 40 ä¸‡ã€‚\næ æ†åˆ°å¤´ï¼Œæ¶ˆè´¹æ˜¯å®Œå…¨ä¸¤ä¸ªæ¦‚å¿µï¼Œç”¨åŠ æ æ†çš„æ–¹å¼åˆºæ¿€ç»æµï¼Œè¿™ä¸ªæ‰‹æ®µå°†å¤±æ•ˆï¼Œæˆ‘ç°åœ¨å”¯ä¸€æŠ•ç¥¨çš„å…¨éƒ¨æ˜¯é™æ æ†åˆºæ¿€ç»æµæ”¿ç­–ï¼Œæ¯”å¦‚è¯´é™ä½å­˜é‡æˆ¿è´·åˆ©ç‡ï¼Œè¿™æ˜¯æ‰æ‰å®å®çš„é™æ æ†ï¼Œè¯´ç™½äº†æ˜¯é“¶è¡Œåå‡ºé’±æ¥ç»™åœ¨åº§å„ä½æ¯ä¸ªæœˆå¯ä»¥å°‘è¿˜ 800ã€1000ã€‚ä½†ä½ è¿˜æ˜¯è¯´é™ä½é¦–ä»˜æ¯”ä¾‹ï¼Œå¤§çˆ·å¿«æ¥ï¼ŒåŠ æ æ†å“¦ï¼Œæˆ‘å¯ä»¥å‘Šè¯‰ä½ ï¼ŒåŠ ä¸åŠ¨äº†ï¼Œè¿™å°±æ˜¯æ ¸å¿ƒã€‚å½“å¹´äº§èƒ½åŠ ä¸Šå»ä»¥åä¾›ç»™è¿‡å‰©ï¼Œä¸»è¦æ˜¯æ—§äº§èƒ½ï¼Œå‡ºç° 36 ä¸ªæœˆ PPIï¼Œä¼ä¸šæ¶æ€§ç«äº‰ï¼Œç ´äº§å€’é—­ï¼Œé“¶è¡Œå‹åŠ›å·¨å¤§ã€‚æˆ‘ä»¬å¹²äº†ä¾›ç»™ä¾§æ”¹é©ï¼Œç„¶åè¡Œæ”¿æ€§å‡ºæ¸…ä¸€éƒ¨åˆ†äº§èƒ½ï¼Œå…¶å®æ˜¯è½¬ç§»åˆ°æ–°äº§èƒ½ä¸Šå»äº†ï¼Œä½¿å¾—ä¾›éœ€æŠŠéœ€æ±‚å†ä¸€åˆºæ¿€ï¼Œè€ç™¾å§“ä¹°å•ã€‚\nå½“å¹´çš„å¤§é—®é¢˜æ˜¯è¿™å„¿æ˜¯ä¸€ä¸ªå¦¹å­ï¼Œç™½å¯Œç¾ï¼Œä¸‹é¢æ˜¯ä¿©å°å¸…å“¥ï¼Œä¿©å¸…å“¥åœ¨é‚£å„¿ç«äº‰ï¼Œä¼˜èƒœåŠ£æ±°ï¼Œä¸€ä¸ªæŠŠä¸€ä¸ªæ·˜æ±°ä¹‹åï¼Œæœ€ç»ˆè¿å¨¶ç™½å¯Œç¾ï¼Œå› ä¸ºç™½å¯Œç¾éœ€è¦ä¸€ä¸ªå¸…å“¥ï¼Œæ‰€ä»¥ä½ ä»¬ä¿©é‡‘æ­£ï¼Œèƒœè€…ä¸ºç‹ã€‚è¿™å¥è¯ï¼Œå……åˆ†çš„å¸‚åœºç«äº‰åèƒœè€…ä¸ºç‹ï¼Œå‡è®¾å‰ææ˜¯éœ€æ±‚ä¸å˜ï¼Œç»æµçš„è¿™ç‚¹æ´»å„¿æ”¾åˆ°è‡ªåª’ä½“ã€ç½‘ä¸ŠçœŸçš„æåäº†ã€‚å……åˆ†çš„å¸‚åœºç«äº‰åï¼Œèƒœè€…ä¸ºç‹ï¼Œèµ¢è€…é€šåƒçš„å‡è®¾å‰ææ˜¯éœ€æ±‚ä¸å˜ï¼Œä¹Ÿå°±æ˜¯å¦¹å­åœ¨ï¼Œä½ ä¿©ç«äº‰ã€‚\nçŸ¥é“ç°åœ¨çš„æ•°å­—å•¥æ„æ€å—ï¼Ÿçº¢è‰²çº¿æ²¡äº†ï¼Œ0ï¼ŒPPI å¦‚æœæ‰£æ‰ç–«æƒ…æœŸé—´ï¼ŒæŒç»­ä» 2019 å¹´ä¹‹åä¸ºè´Ÿï¼Œä¸¤ä¸ªå°ä¼™å­åœ¨é‚£å„¿ PKï¼Œç›®æ ‡æ˜¯èƒœè€…ä¸ºç‹ï¼Œæœ€åå·å®Œäº†ï¼Œå‰©ä¸‹ä¸€ä¸ªï¼Œæ‘‡å¤´ä¸€çœ‹ï¼Œå¦¹å­å‘¢ï¼Ÿä½ ä»¬ç­‰ç€çœ‹å§ï¼Œè¿™ä»¶äº‹æƒ…å¿…ç„¶æ˜¯ä¸¤ä¸‰å¹´åæŸäº›è¡Œä¸šå¿…ç„¶å‘ç”Ÿçš„ï¼Œä¼šçœŸä»¥ä¸ºæ˜¯èƒœè€…ä¸ºç‹ï¼Ÿä½ çš„å¤§ç¯å¢ƒæ˜¯ä»€ä¹ˆç¯å¢ƒï¼Ÿæ˜¯æœ‰æ•ˆéœ€æ±‚é¢ä¸´ç€ä¸­é•¿å‘¨æœŸçš„æ”¶ç¼©å’Œè°ƒæ•´ï¼Œè¿™ç§æƒ…å†µä¸‹å¸‚åœºå¦‚æ­¤æ¶æ€§ç«äº‰å’Œå·æ˜¯æ²¡æœ‰èµ¢å®¶çš„ï¼Œæœ€åä¼šçˆ†å‘å±æœºçš„ã€‚æˆ‘æŠŠè¿™è¯é€ç»™æŸäº›ä¼ä¸šçš„è‘£äº‹é•¿ä»¬ã€‚\nè·Ÿå¾€å¹´ä¸ä¸€æ ·ï¼Œå¾€å¹´ä»»ä½•è¿‡å‰©çš„å¸‚åœºç«äº‰ï¼Œæœ€ç»ˆéƒ½èƒœè€…é€šåƒçš„åŸå› æ˜¯å› ä¸ºå±…æ°‘éƒ¨é—¨æœ‰æ•ˆéœ€æ±‚æ°¸è¿œåœ¨ï¼Œæ°¸è¿œèƒ½åŠ æ æ†ï¼Œæ°¸è¿œèƒ½ä¸ºä½ çš„ä¼ä¸šäº§èƒ½å’Œåˆ©æ¶¦ä¹°å•ã€‚æœ€ååªå‰©ä¸‹ä¸€æ¡è·¯ï¼Œä½ ä»¬çŸ¥é“æ˜¯ä»€ä¹ˆè·¯å—ï¼Ÿå› ä¸ºè¿™æ¡çº¢è‰²çš„çº¿åªä»£è¡¨ç€å†…éœ€ï¼Œå¦‚æœå›½å†…çš„å§‘å¨˜æ²¡äº†ï¼Œå°±è¦è¿å¨¶æµ·å¤–ç™½å¯Œç¾ï¼Œæ‰€ä»¥ä»–åªå‰©ä¸‹ä¸€æ¡è·¯ï¼Œå‡ºæµ·ã€‚è¿™ä¹Ÿæ˜¯ç½‘ä¸Šå¾ˆå¤šç½‘å‹ä»¬å¾ˆå¼€å¿ƒçš„ï¼Œæˆ‘ä»¬å°±æ˜¯è¦å‡ºæµ·ï¼Œæˆ‘ä»¬å°±æ˜¯è¦æ‹¿ä¸‹å›½é™…å¸‚åœºã€‚\nç°åœ¨å›½é™…ç¯å¢ƒæ˜¯ä»€ä¹ˆæ ·ï¼Ÿæ˜¯ä¸æ˜¯ 20 å¹´å‰ã€30 å¹´å‰å…¨çƒå¾€å·¦ç¿¼åŒ…å®¹èåˆçš„å¤§ç¯å¢ƒï¼Œèƒ½è®©ä½ å‡ºå»è¿å¨¶ç™½å¯Œç¾ã€‚å½“ç„¶æ—¥æœ¬çš„ä¸‰äº•ã€ä¸‰è±ã€ä¸¸çº¢ã€ä¼Šè—¤å¿ ç­‰ç­‰ï¼Œåœ¨ 90 å¹´ä¹‹åå°±æ˜¯å‡ºæµ·è¿å¨¶ç™½å¯Œç¾ï¼Œé—®é¢˜æ˜¯æˆ‘ä»¬ç°åœ¨èƒ½ä¸èƒ½ï¼Ÿæˆ‘ç›¸ä¿¡å¤§å®¶å¿ƒé‡Œéƒ½æœ‰æ†ç§¤ï¼Œâ€œæƒ³ä¸æƒ³â€ è·Ÿåœ¨æœªæ¥çš„å¤§ç¯å¢ƒä¸Š â€œèƒ½ä¸èƒ½â€ å°†å½¢æˆæ¿€çƒˆçš„ç¢°æ’ï¼Œå¦‚æœä¸èƒ½ï¼Œå›½å†…æ²¡æœ‰æœ‰æ•ˆéœ€æ±‚ç»™ä½ æ€ä¹ˆåŠï¼Ÿ\nç°åœ¨æ‰€æœ‰ç»æµé—®é¢˜æ˜¯ä¸¤ä¸ªéƒ½å­˜åœ¨ï¼Œä¾›ç»™è¿‡å‰©ä¹Ÿå­˜åœ¨ï¼Œæœ‰æ•ˆéœ€æ±‚ä¸è¶³ä¹Ÿå­˜åœ¨ï¼Œæˆ‘ä»¬éœ€è¦è§£å†³é—®é¢˜ï¼Œç­”æ¡ˆæ˜¯å¿…é¡»ææŒ¯å†…éœ€ï¼Œå†…éœ€çš„æ ¸å¿ƒå°±æ˜¯è¿›è¡Œå†åˆ†é…ã€‚æ”¿åºœå’Œå±…æ°‘ä¹‹é—´è¿›è¡Œå†åˆ†é…ï¼Œè´«å¯Œä¹‹é—´è¿›è¡Œå†åˆ†é…ï¼Œå€ºåŠ¡å’Œæ æ†ä¹‹é—´è¿›è¡Œå†åˆ†é…ï¼Œå¦‚æœä¸åšï¼Œé‚£æˆ‘ä»¬å°±æ˜¯ 35 å¹´æ—¥æœ¬ã€‚æ—¥æœ¬ 35 å¹´å‘¨æœŸæ€ä¹ˆæ¥çš„ï¼Œä½ ä»¬æœ€ç»ˆçŸ¥é“ç­”æ¡ˆäº†å§ï¼Ÿè¿˜ä¸çŸ¥é“ï¼Œæˆ‘éƒ½æŠŠå„¿å­é€è¿‡å»äº†ï¼Œä½ ä»¬è¿˜ä¸æ‡‚å†åˆ†é…æ˜¯ä»€ä¹ˆæ„æ€å—ï¼Ÿæ—¥æœ¬æˆ˜äº‰åè·å–æ‰€æœ‰èµ„æºè¦ç´ ï¼ˆå²—ä½ã€èŒåŠ¡ã€è–ªèµ„ï¼‰ï¼Œæˆ˜äº‰åçš„ç¬¬ä¸€ä»£å’Œç¬¬äºŒä»£ï¼Œåˆ°äº† 2012 å¹´å¼€å§‹æ­»äº¡ï¼Œä»£é™…åˆ†é…ï¼Œè€åŒå¿—ä»¬æ­»äº†ï¼Œå¹´è½»äººåƒçš„è›‹ç³•å°±è‡ªç„¶å¤šäº†ï¼Œå°±è¿™ä¹ˆç®€å•äº†ã€‚\nä½ å¦‚æœèƒ½ç†è§£åˆ°è¿™ä¸ªçš„å˜åŠ¨ï¼Œä½ å°±èƒ½è‡ªç„¶åœ°ç†è§£åˆ°æˆ‘åœ¨è¯´æ—¥æœ¬ç»æµçš„æ ¸å¿ƒåˆ°åº•æ˜¯ä»€ä¹ˆï¼Œæ˜¯ä»£é™…åˆ†é…ï¼Œä¸æ˜¯å¢é•¿ï¼Œå…‰å¢é•¿ä¸åˆ†é…é‚£å°±æ˜¯å¯Œç€æ’å¯Œã€ç©·ç€æ’ç©·ã€‚è¿™è¯ç¿»è¯‘åˆ°è‚¡å¸‚ä¸Šä½ ä»¬çŸ¥é“æ˜¯ä»€ä¹ˆå—ï¼Ÿä¸Šå¸‚å…¬å¸ä¸åˆ†çº¢æ²¡å¢é•¿çš„è¯ï¼Œç­”æ¡ˆæ°¸è¿œæ˜¯å¯Œç€æ’å¯Œã€ç©·ç€æ’ç©·ã€‚00 åæŒ‡æœ›ç€ç‚’è‚¡æ¥åˆ† 60 åçš„è´¢äº§ï¼Œä½ æƒ³å¤šäº†ï¼Œä½ è¿˜ä¸å¦‚å»è§å±±å½“ä¸ªä¸Šé—¨å¥³å©¿æ¥å¾—æ›´å¿«ä¸€ç‚¹ï¼Œè¿˜ä¸ç”¨åŠªåŠ›ï¼ŒæŠŠè‡ªå·±å€’è…¾çš„å¸…å¸…çš„ï¼Œå«è¿›è§å±±è±ªé—¨ï¼Œè´¢å¯Œä»£é™…å†åˆ†é…ï¼Œèººèµ¢ï¼Œä½•å¿…è¦å¤©å¤©ç‚’è‚¡ç´¯æ­»ç´¯æ´»çš„ï¼Œå¿ƒé‡Œæƒ³ç€æˆ‘èƒ½å¹²æ‰ 60 åï¼Œé‚£éƒ½æ´»æˆç²¾äº†ï¼Œä½ èƒ½å¹²æˆä»–ï¼Ÿæ¢æ‰‹è·‘çš„æ¯”ä½ è¿˜å¿«ï¼Œä¸€è¾¹å–Šç€ â€œå¹´è½»äººå¿«ä¸Šå•Šï¼Œäººç”Ÿå”¯ä¸€ä¸€æ¬¡æœºä¼šï¼Œæ­¤æ¬¡ä¸ all in æ¢­å“ˆï¼Œæœªæ¥å°±æ²¡æœºä¼šäº†ã€‚â€ ä»–ä¸€è¾¹ all in ç€ï¼Œå’±ä»¬ä¸€è¾¹æ¢ç€æ‰‹æ’¤ï¼Œè®©ä»–ä»¬ç«™åœ¨é«˜é«˜çš„å±±å†ˆä¸Šã€‚\nå¸‚åœºè·Ÿç»æµæ˜¯ä¸€æ ·çš„ï¼Œåˆ›é€ å¢é‡çš„åŒæ—¶ä¹Ÿè¦è¿›è¡Œåˆ†é…ï¼Œä¸é…æ²¡æœ‰ä»»ä½•æ„ä¹‰ã€‚æœ‰äº›äº‹å„¿éƒ½æ˜¯æœ¬è´¨ä¸€æ ·çš„ï¼Œè¿™å°±æ˜¯ä¸­å›½ç»æµå½“å‰æœ€å¤§çš„é—®é¢˜ã€‚\n2006 å¹´ä¾›ç»™ä¾§æ”¹é©ï¼Œæˆ‘æé†’å¤§å®¶ä¸€å¥ï¼Œæœ‰å‡ ä¸ªé”™è¯¯çš„è§‚ç‚¹ç‰¹åˆ«å¼ºè°ƒä¸€ä¸‹ã€‚ä¸ºå•¥è¯´é”™è¯¯çš„ï¼Ÿè¿™è§‚ç‚¹ç”¨æˆ‘çš„è¯è¯´ä¸€å®šå’±ä»¬è¦çŸ¥é“ï¼Œä¸ä¸€å®šè¦è®©è€ç™¾å§“çŸ¥é“ã€‚\nä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œè‚¡ç¥¨å¸‚åœºåˆ›é€ è´¢å¯Œæ•ˆåº”ï¼Œç”¨æ­¤æ¥æ”¹å˜å›½è¿ï¼Œè¿™æ˜¯ä¸æ˜¯å¤–é¢ç»å¸¸å¬åˆ°çš„å£°éŸ³ï¼Ÿä½ æƒ³å•¥å‘¢ï¼Ÿæˆ¿å­å¦‚æœæ²¡æœ‰æ”¶å…¥å’Œç§Ÿé‡‘çš„å›æŠ¥ç‡å’Œä½çš„åŠŸèƒ½ï¼Œé‚£æ¢å¥è¯è¯´æˆ¿å­ä¸åˆ›é€ è‡ªèº«ä»·å€¼çš„æƒ…å†µä¸‹ï¼Œçº¯æ¢æ‰‹ï¼Œä¾æ—§ç­”æ¡ˆæ˜¯å¯Œç€æ’å¯Œã€ç©·ç€æ’ç©·ï¼Œèƒ½åˆ›é€ çŸ­æœŸè´¢å¯Œæ•ˆåº”å—ï¼Ÿèƒ½ï¼Œå°±åƒ 2015ã€2016 å¹´æˆ‘è·Ÿä½ ä»¬ä¸¾è¿‡çš„ä¾‹å­ï¼Œæ»¡ä»“ all in æ¢­å“ˆï¼Œèèµ„æ æ†ä¼å½¢éƒ½ä¸Šï¼Œç„¶åä½ å‘ç°è‚¡ç¥¨ä¸€ä¸ªæ¶¨åœä¸€ä¸ªæ¶¨åœï¼Œè´¦æˆ·é‡Œå…¨æ˜¯é’±ï¼Œå‡ºé—¨ç»™è€å©†ä¹°äº†ä¸ªåŒ…ï¼Œè´¢å¯Œæ•ˆåº”ã€‚\nç„¶åå‘¢ï¼Ÿè·Œåœçš„æ—¶å€™ä½ çŸ¥é“ä½ åæ‚”ä¹°å•¥å—ï¼Ÿä½ åæ‚”è‚¡ç¥¨æ²¡å–æ‰ï¼Œæ”¾å¿ƒè‚¡ç¥¨å–ä¸æ‰çš„ï¼Œå› ä¸ºå¼€ç›˜å°±è·Œåœäº†ã€‚ä½ çœŸæ­£åæ‚”çš„æ˜¯ï¼Œæˆ‘æ²¡ç»™è€å©†ä¹°è¿™åŒ…å°±å¯¹äº†ã€‚æˆ‘ç»å¸¸åŠä»–ä»¬ï¼Œè¾›è‹¦ä½ ç»™ä½ è€å©†ä¹°äº†åŒ…ï¼Œå› ä¸ºå¥¹è‡³å°‘è¿˜å‰©ä¸ªåŒ…ã€‚ä½ è¦å½“æ—¶æ²¡ä¹°è¿™ä¸ªåŒ…ï¼Œä½ è¿è¿™ä¸ªåŒ…éƒ½ä¸å‰©äº†ã€‚\nè¿™ç§æ¢æ‰‹çš„æ¸¸æˆåªæœ‰ç»“æœæ˜¯å¯Œç€æ’å¯Œã€ç©·ç€æ’ç©·ï¼Œè€Œä¸”åæœä¼šè¶Šæ¥è¶Šå·®ï¼Œä¸­å›½å°±æ˜¯å…¸å‹çš„è¿™ä¸ªé€»è¾‘ã€‚ä¸è¦æŠŠæ³¡æ²«å½“æˆå®¶åº­è´¢å¯Œå»å¿½æ‚ è€ç™¾å§“ï¼Œè¿™æ˜¯æ‰¯æ·¡çš„ï¼ŒèƒŒç¦»æ”¶å…¥çš„ï¼ŒèƒŒç¦»ä¼ä¸šå¢é•¿å’Œè‚¡æ¯åˆ†çº¢çš„ï¼Œè¿™ç§ä¸œè¥¿å’±éƒ½å¿ƒçŸ¥è‚šæ˜ï¼Œå°±æ˜¯ä¸ºäº†æ¥æ¢æ‰‹çš„ï¼Œä½ æŠŠå®ƒå½“æˆå®¶åº­è´¢å¯Œé…ç½®ï¼Œä¼šæ­»äººçš„ï¼Œæœ€åå¯¹ç»æµä¼šé€ æˆä»Šå¹´è¿™ç§æƒ…å†µã€‚\næ¢æ‰‹çš„æ—¶å€™ä½ çœ‹ç€æ¶ˆè´¹å¾ˆçˆ½ï¼Œæ¯”å¦‚è¯´æˆ‘è¿™å„¿ç»™ä½ ä¸¾çš„æˆ¿å­ï¼Œä¸­å›½çš„æˆ¿å­ä¸Šæ¶¨å¹…åº¦æœ€å¤§çš„çœŸçš„ä¸æ˜¯ 2008â€”2015 å¹´ï¼Œæ°æ°æ˜¯ 2015ã€2016 å¹´è‚¡ç¾ä¹‹åæˆ¿ä»·æ˜¯æœ€çŒ›çš„ï¼Œé‚£æ—¶å€™åŒ—äº¬æˆ‘è®°å¾—æœ€æ¸…æ¥šï¼Œ2009 å¹´ç‚’æˆ¿çš„æ—¶å€™ï¼Œäºšè¿æ‘æ˜¯ 17500ï¼Œ2015 å¹´å¹´ç»ˆçš„æ—¶å€™äºšè¿æ‘æˆ¿ä»·æ˜¯ 25000ï¼Œ2019 å¹´äºšè¿æ‘çš„æˆ¿ä»·æ˜¯ 10 ä¸‡ï¼Œé»‘è‰²çº¿æ˜¯åŒæ¯”ä¸Šæ¶¨ï¼Œ70 ä¸ªå¤§ä¸­å‹åŸå¸‚åŒæ¯”ä¸Šæ¶¨ï¼ŒåŒæ¯”ä¸Šæ¶¨ + é•¿æ—¶é—´ç´¯è®¡å°±æ˜¯æˆ¿ä»·æ¶¨å¹…æœ€å¤§çš„æ—¶å€™ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±æ˜¯ 2015ã€2016 å¹´é‚£ä¸€æ³¢ï¼Œæˆ¿ä»·å¸¦æ¥äº†å¤§å®¶çš„æ¶ˆè´¹é¢„æœŸå’Œå¸Œæœ›ï¼Œä½†ä»è¿™å¼ å›¾ä¸Šä½ ä»¬å¯ä»¥éå¸¸æ˜æ˜¾åœ°çœ‹åˆ°æ¶ˆè´¹èƒŒç¦»äº†æ”¶å…¥ï¼Œè¿™ç§æ¶ˆè´¹å°±æ˜¯å¤§å®¶è®²çš„å»ºç«‹åœ¨è´¢å¯Œæ•ˆåº”ä¸Šçš„ï¼Œä½†æ­¤æ—¶çš„è´¢å¯Œå¹¶ä¸æ˜¯æ”¶å…¥æ”¯æ’‘èµ·æ¥çš„ã€‚\né—®é¢˜å°±æ¥äº†ï¼Œå››å¹´å‰äº”å¹´å‰æˆ‘æ‹è¿‡ä¸€äº›çŸ­è§†é¢‘ï¼Œè·Ÿå¹³å°åˆä½œè®©æˆ‘æ‹äº›çŸ­è§†é¢‘ï¼Œæˆ‘å½“æ—¶å°±è®²å¾—å¾ˆæ¸…æ¥šï¼Œæˆ¿å­å¦‚æœçº¯æ¢æ‰‹ï¼Œåˆ°åº•æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Ÿæˆ‘ 200 ä¸‡ä¹°çš„æˆ¿å­ï¼Œ600 ä¸‡å–ç»™å¹´è½»äººï¼Œæˆ‘æ‹¿èµ°çš„å°±æ˜¯å¹´è½»äººæœªæ¥ 40 å¹´é’æ˜¥çš„å½“æœŸç°é‡‘æŠ˜ç°ã€‚æˆ‘å¯ä»¥ä¸ºæˆ‘çš„æœªæ¥ 40 å¹´æ½‡æ´’äº†ï¼Œä»–èƒŒä¸Šè¿™ 40 å¹´çš„å€ºåŠ¡ï¼Œä»–è¦è¿˜çš„ã€‚å¦‚æœæ²¡æœ‰æ”¶å…¥çš„å¢é•¿ï¼Œä»–è¦ç¡¬ç¡¬åœ°è¿˜ 40 å¹´ï¼Œä»–å°±æ˜¯å¤±å»çš„ï¼Œæˆ‘æ›¿ä»–å¤šæ´» 40 å¹´äº†ï¼Œå°±è¿™ä¹ˆç®€å•ã€‚\nè‚¡ç¥¨ä»·æ ¼ä¹Ÿä¸€æ ·ï¼Œå’±ä»¬äº¤æ¢çš„å«æ—¶é—´ä»·å€¼ï¼Œæˆ‘æ˜¯å¤§è‚¡ä¸œï¼Œæˆ‘ç°åœ¨æ‹¿èµ°ï¼Œæˆ‘ç°åœ¨ Happyï¼ŒæŠŠä½ å¥—åœ¨é‡Œé¢å¥— 10 å¹´ï¼Œ10 å¹´åèƒ½ä¸èƒ½è§£å¥—å‘¢ï¼Ÿä¹Ÿè®¸è§£å¥—äº†ï¼Œä½ è§‰å¾—ä½ å¼€å¿ƒå—ï¼Ÿä½ ä¸¢äº† 10 å¹´ã€‚é‡‘èèµ„äº§äº¤æ¢æˆæœ¬ä½ ä»¬ä¸€å®šè¦æ³¨æ„æ—¶é—´å‡½æ•°ï¼Œæ²¡æœ‰æ—¶é—´å‡½æ•°éƒ½æ˜¯æ‰¯æ·¡ã€‚\né—®é¢˜å°±åœ¨äºï¼Œå¦‚æœæ”¶å…¥ä¸å¢é•¿ï¼Œçº¯æ¢ï¼ŒçŸ­æœŸå†…åˆ›é€ çš„è´¢å¯Œæ•ˆåº”æ¯•ç«Ÿç­‰äºå¦å¤–ä¸€æ‰¹äººçŸ­æœŸå†…ç´¯ç§¯çš„å€ºåŠ¡ã€‚æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬çˆ½äº†ï¼Œä»–çš„å€ºåŠ¡è¾¾åˆ°ä¸€å®šç¨‹åº¦çš„æ—¶å€™ä¼šé€ æˆå…¨é¢çš„åå¡Œï¼Œæ•´ä¸ªèµ„äº§ä¸å¯èƒ½æŒç»­çš„ï¼Œä»–ä¹°çš„æˆ¿å­ 800 ä¸‡ä¹°çš„æ—¶å€™ï¼ŒæŒ‡æœ› 800 ä¸‡ä¹°ï¼Œ1000 ä¸‡å–ç»™ä¸‹ä¸€ä¸ªå¹´è½»äººï¼Œç»“æœå‘ç°æ²¡å¹´è½»äººäº†ï¼Œä¸‹ä¸€ä¸ªå¹´è½»äººæ¥ä¸åŠ¨ 1000 ä¸‡äº†ï¼Œæ­¤æ—¶ä»–çš„èµ„äº§è´Ÿå€ºè¡¨å°±å¼€å§‹æ¶åŒ–äº†ï¼Œæ¶ˆè´¹å¼€å§‹å‡ºç°æ–­å´–å¼çš„å›å½’ï¼Œè¿™å°±æ˜¯ 2019 å¹´åçš„ç»“æœã€‚2019 å¹´åå¼€å§‹é€å±‚æ–­å´–å¾€ä¸‹èµ°ï¼Œå‘ç€çœŸå®çš„æ”¶å…¥å›å½’ã€‚\nåƒä¸‡ä¸æ•¢è·Ÿè€ç™¾å§“è®²æŠŠè‚¡ç¥¨ã€æˆ¿å­å½“æˆå®¶åº­è´¢å¯Œï¼Œè¿‡å»æœ‰å¹´è½»äººçš„æ—¶å€™ï¼Œä»–æ‰æ˜¯æˆ‘ä»¬çš„è´¢å¯Œï¼Œä¸ç®¡é€šè¿‡è‚¡ç¥¨è¿˜æ˜¯é€šè¿‡æˆ¿å­ï¼Œå¹´è½»äººå°±æ˜¯æ‰€æœ‰äººè´¢å¯Œçš„æ¥æºã€‚è¯´å®è¯ï¼Œä¸­å›½çš„æˆ¿åœ°äº§æ¶¨äº†å·®ä¸å¤š 20 å¹´çš„æ ¹æœ¬åŸå› æ˜¯å•¥ï¼Ÿæœ‰ä¸€è®²ä¸€ï¼Œå‡­è‰¯å¿ƒè®²ï¼Œä»»ä½•çš„æˆ¿å­å¹´è½»äººèƒ½ä¹°èµ°ï¼Œæˆ‘ä»¬å°±æ‹¿èµ°è´¢å¯Œäº†ï¼Œæˆ‘çš„æˆ¿å­å°±æ˜¯ä»–ä»¬çš„è´Ÿå€ºï¼Œå’±ä»¬æ‰€æœ‰äººåœ¨åƒçš„å°±ä¸€æ¡ä¸œè¥¿ï¼Œå°±æ˜¯å±…æ°‘éƒ¨é—¨æ æ†ç‡ï¼Œæ‰€æœ‰äººåƒçš„å°±æ˜¯è¿™æ ¹çº¢è‰²çº¿ã€‚\næœ‰äº›ç ”ç©¶å‘˜è¯´ï¼Œä¸­å›½ç°åœ¨å±…æ°‘éƒ¨é—¨æ æ†ç‡æ¯”æµ·å¤–ä½ï¼Œå› ä¸ºä»–å•çº¯çš„å¯¹æ¯”æ•°å­—ã€‚æˆ‘å¯ä»¥å‘Šè¯‰ä½ ä¸ä½äº†ï¼Œä½ çŸ¥é“åŸå› æ˜¯ä»€ä¹ˆå—ï¼Ÿæˆ‘ä»¬çš„æ æ†èƒŒåæ²¡æœ‰é«˜ç¦åˆ©ï¼Œé«˜ç¦åˆ©å›½å®¶ 70%ï¼Œä½ç¦åˆ©å›½å®¶ 60%ï¼Œä½ è·Ÿæˆ‘è¯´ 60% æ¯” 70% ä½ï¼Œä½ è‡ªå·±å®é™…çš„æ æ†å‹åŠ›åˆ°åº•æ˜¯å¤šå°‘ï¼Œä½ å¿ƒé‡Œæ²¡ç‚¹æ•°å—ï¼Ÿä½ çš„æ•™è‚²ã€åŒ»ç–—ã€å…»è€ï¼Œä¸Šæœ‰è€ä¸‹æœ‰å°ï¼Œä½ éœ€è¦èŠ±å¤šå°‘é’±ä½ å¿ƒé‡Œæ²¡ç‚¹æ•°å—ï¼Ÿä½ æ˜¯ç¤¾ä¼šç¦åˆ© 70 å¹´ä»£ 80 å¹´ä»£å»ºç«‹èµ·æ¥å›½å®¶çš„å±…æ°‘éƒ¨é—¨æ æ†ç‡å—ï¼Ÿä¸æ˜¯çš„ã€‚ä»å„ç§ç°è±¡ä¸Šå»è§‚å¯Ÿï¼Œè¿™ä¸ªæ æ†ç‡åˆ°å¤´äº†ã€‚\nèµ„æœ¬å¸‚åœºå¾ˆèªæ˜ï¼Œä» 2002 å¹´ä¸€ç›´åˆ°ç°åœ¨ï¼Œé•¿è¾¾ 18ã€20 å¹´å·¦å³çš„æ—¶é—´ï¼Œäº¤æ˜“ä¸­å›½çš„æ¶ˆè´¹å‡çº§ï¼Œä¸ç®¡ä¸Šè¯ç»¼æŒ‡æ˜¯ 3000 ç‚¹è¿˜æ˜¯ 3500ï¼Œä¸é‡è¦ï¼Œæ¶ˆè´¹æ¿å—å¤§å‘¨æœŸå°±æ˜¯ä¸­å›½å±…æ°‘éƒ¨é—¨ 80 ååŠ æ æ†è¿™ä¸€å¸¦ã€‚\nä» 2019ã€2020 å¹´å¼€å§‹ï¼Œæˆ‘å¯¹ä¸­å›½æ¶ˆè´¹çš„æ‰€æœ‰æ•™è‚²é€»è¾‘å°±æ˜¯ï¼šä¸€æ˜¯æ¶ˆè´¹ä¼šå‘ç”Ÿç»“æ„æ€§çš„å˜åŒ–ï¼Œè¿™ç§å˜åŒ–å®é™…ä¸Šæ˜¯ä»£é™…çš„å˜åŒ–ï¼›äºŒæ˜¯æ¶ˆè´¹å¼€å§‹é™çº§ã€‚\né‚£æ—¶å€™æˆ‘æ¼”è®²ä¸­è®²çš„é‚£å¥è¯ï¼Œå’–å•¡ä¸å†æ˜¯å–å®Œ 20 å– 30ï¼Œå–å®Œ 30 å– 40ï¼Œå–å®Œ 40 å– 50ï¼Œè€Œæ˜¯å¼€å§‹å– 9.9 ä¹°ä¸€èµ ä¸€ï¼Œå¹´è½»äººå¼€å§‹å‘¨å››æ”’ä¸ªè‚¯å¾·åŸºä¼˜æƒ åˆ¸ã€‚\nå¹´è½»äººå¼€å§‹å‘ç”Ÿæ¶ˆè´¹å‹å˜åŒ–ï¼Œæ¯”å¦‚æˆ‘ä»¬å®¶å­©å­å–èŒ¶ï¼Œæˆ‘çœ‹ä»–ä»¬å–èŒ¶é©¬ä¸Šå‘Šè¯‰æˆ‘è€å©†ï¼ŒæŠŠå›¤çš„æ™®æ´±çš„èŒ¶é¥¼å…¨ç”©å–ã€‚ä¸ºå•¥ï¼Ÿæˆ‘ä»¬å®¶å§‘å¨˜æ€ä¹ˆå–èŒ¶çŸ¥é“å—ï¼Ÿå»å¥¹åŠå…¬å®¤ï¼Œçº¢èŒ¶ç»¿èŒ¶æ™®æ´±ï¼Œä½ è¯´çº¢èŒ¶ï¼Œä¸œæ–¹æ ‘å¶æ‹¿å‡ºæ¥æ‹§å¼€ï¼Œè¿æ°´éƒ½ä¸ç”¨ï¼Œå€’å£¶é‡Œï¼Œå¡å“‡ä¼Šçš„å°æ¯å­å¾€é‚£å„¿ä¸€æ”¾ï¼Œå¾€é‚£å„¿ä¸€å€’ï¼Œè¯·ã€‚å¥¹ä¸ä¼šç»™ä½ æ‹¿ä¸ªé¥¼æ“åŠå¤©ï¼Œç„¶åå†ä¸€æ³¡ï¼Œé‚£æ˜¯ä¸Šä¸€ä»£äººã€‚\næ—¥æœ¬å½“å¹´ç»æµé¡¶å³°æœŸçš„æ—¶å€™ï¼Œåšæ—¥æœ¬çš„æ¸…é…’å’Œå¨å£«å¿Œï¼Œç»“æœ 1990 å¹´ä¹‹åçœŸæ­£ç«èµ·æ¥çš„æ˜¯ä¸‰å¾—åˆ©ã€Jim Beam å—¨æ£’ã€‚å¹´è½»äººè¯´ 1000 å—é’±çš„é…’ï¼Œå•¥é…’ï¼Ÿæˆ‘è¦çš„å°±æ˜¯ 10 å—é’±ï¼Œå£å‘³åç”œï¼ŒRIO å–èµ·æ¥å¾®é†ºï¼Œèƒ½é†‰å—ï¼Ÿèƒ½ï¼Œè¡Œäº†ã€‚æˆ‘çš„ç¤¾äº¤åœºæ™¯å·²ç»å˜äº†ï¼Œæˆ‘ä¸ä¼šæœ‰è¯·å®¢åƒé¥­ååœ¨é‚£å„¿äº†ï¼Œæˆ‘çš„æ¶ˆè´¹åœºæ™¯å·²ç»å˜æˆä¿©å­©å­å¾€é‚£å„¿ä¸€åï¼Œçœ‹ç”µç«æ¯”èµ›ç›´æ’­ã€‚\nè¿™ç§å¹´ä»£å·²ç»åˆ°äº†ï¼Œä½ å¯åƒä¸‡ä¸è¦ä»¥ä¸ºæ²¡åˆ°ï¼Œä½ å›¤çš„é‚®ç¥¨ã€æœ¨å¤´ï¼Œä½ è®°ä½ä¸€ç‚¹ï¼Œæ²¡å¾—ä¼ æ‰¿çš„ï¼Œè¿˜å›¤é‚®ç¥¨ï¼Œæˆ‘å®¶å„¿å­éƒ½ä¸çŸ¥é“é‚®ç¥¨é•¿å•¥æ ·ï¼Ÿä»–å€’çŸ¥é“å°é©¬å®è‰å€¼é’±ï¼Œè¿™å°±æ˜¯æ—¶ä»£çš„å˜åŒ–ï¼Œæ¶ˆè´¹åœ¨å‘ç”Ÿç»“æ„æ€§å˜åŒ–åŠæ€»é‡ä¸Šçš„å˜åŒ–ã€‚\nä¸­å›½çš„èµ„æœ¬å¸‚åœºå¯¹ç»æµçš„ååº”æ˜¯å®Œå…¨å‡†ç¡®çš„ï¼Œä½ ä»¬å¯ä»¥çœ‹çœ‹æ•´ä¸ªçš„æ¿å—æŒ‡æ•°ï¼Œæˆ¿åœ°äº§ç»“æŸäº†ï¼Œå±…æ°‘éƒ¨é—¨çš„é£Ÿå“ã€é¥®æ–™ã€æ¶ˆè´¹ã€é›¶å”®ç»“æŸäº†ã€‚æ–°èƒ½æºæ±½è½¦åˆ°åº•ç»“æ²¡ç»“æŸï¼Œæˆ‘çš„ç­”æ¡ˆæ˜¯ä½ ä»¬ç­‰ç€ç§ã€‚å…¶å®ç°åœ¨åªæœ‰ä¸€ä¸ªæ¿å—åœ¨æ‰©å¼ ï¼ŒåŠå¯¼ä½“ã€‚\nä½ ä»¬çœ‹æ‡‚å•¥æ„æ€äº†å—ï¼Ÿé“¶è¡Œçš„å¯¹è”å« â€œåªåšé”¦ä¸Šæ·»èŠ±ï¼Œç»ä¸é›ªä¸­é€ç‚­â€ï¼Œæ¨ªæ‰¹ â€œæˆ‘å®¶é“¶è¡Œâ€ã€‚ä½ è¦æ˜¯ç»è¥ä¸å–„ï¼Œæˆ‘ä»¬å®¶ç¬¬ä¸€ä¸ªå¹²çš„äº‹å„¿æ˜¯æŠ½è´·ã€‚â€œå†…å€ºä¸æ˜¯å€ºï¼Œåªè¦ç¨è¿˜åœ¨â€ï¼Œè¿˜æœ‰ä¸€ä¸ªç§˜è¯€æ˜¯å…³äºä¸­å›½ç‰¹è‰²çš„ç»æµï¼Œæµ·å¤–æ²¡æœ‰çš„ï¼Œæˆ‘ä»¬æ˜¯éå¸‚åœºç»æµä¸‹çš„ â€œJã€Qã€Kâ€ã€‚\nâ€œJâ€ æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿå¤§çˆ·å¿«æ¥ã€‚â€œQâ€ï¼Œå¤§çˆ·ï¼ŒæŠ•ç‚¹é’±å§ï¼ŒæŠŠé’±åœˆä½ã€‚â€œKâ€ æ˜¯å‡ºå»ï¼ŒKOã€‚ä¸­å›½èƒ½å¤Ÿé«˜é€Ÿç»æµå‘å±•å®é™…ä¸Šå’Œè¿™åªæ‰‹æœ‰å¯†åˆ‡å…³ç³»ï¼Œå¤§å®¶ç‚’è‚¡ç¥¨éƒ½çŸ¥é“ï¼Œç»æµè¶Šå·®çš„æ—¶å€™ï¼Œä½ ç‚’çš„æ˜¯è¿™åªæ‰‹åŠ¨ä¸åŠ¨ï¼Œæœ‰äººé—®ä¸­å›½çš„è‚¡å¸‚è·Ÿç»æµåˆ°åº•æœ‰æ²¡æœ‰å…³ç³»ï¼Œæˆ‘å¯ä»¥å‘Šè¯‰ä½ ï¼Œä¸¤å¤´æ˜¯åå‘å…³ç³»ï¼Œä¸­é—´æ˜¯æ­£å‘å…³ç³»ã€‚\nä¸¤å¤´åå‘å…³ç³»å°±æ˜¯ç»æµè¶Šå·®ï¼Œè¿™åªæ‰‹ä¼šå‡ºåŠ¨ï¼Œä½ ä¼šæœ‰åå‘å…³ç³»ï¼Œä¸­é—´ä¸€å®šé‡æ–°å›å½’åˆ°è·Ÿç»æµç›¸å…³ï¼Œç„¶åå†å¾€é‚£å¤´ï¼Œè¿‡äºäº¢å¥‹äº†ï¼Œä¹Ÿæ˜¯è¡Œæ”¿å…³ç³»ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œ2015ã€2016 å¹´å½“æ—¶éå¸¸å…¸å‹ï¼Œæˆ‘å‘äº†ä¸ªå¾®åšï¼Œæœ€åä¸€ä¸ªæœˆï¼Œæˆ‘è¯´ä½ ä»¬è°çˆ±ç©è°ç©ï¼Œæˆ‘ä»¬è¦æ’¤äº†ï¼Œæ‹œæ‹œäº†æ‚¨ã€‚å½“ç„¶å¥½å¤„æˆ‘æ²¡åšç©ºä¸­å›½ï¼Œæˆ‘åšç©ºäº†é¦™æ¸¯ï¼Œæˆ‘è¦æ˜¯åšç©ºä¸­å›½æˆ‘å°±å›ä¸æ¥äº†ã€‚\né‚£æ—¶å€™æˆ‘è·‘åˆ°æ±Ÿæµ™æ²ªè°ƒç ”å½“æ—¶çš„ä¼å½¢ä¿¡æ‰˜åœºå¤–èèµ„é…ç½®ï¼Œè¯ç›‘ä¼šä¸€å‡ºæ”¿ç­–ï¼Œæˆ‘è¯´å¾ˆç®€å•ï¼Œä½ ä»¬è°çˆ±ç©è°ç©ï¼Œè€å­æ’¤äº†ï¼Œæ ¹æœ¬åŸå› è¿™åªæ‰‹æ‰æ˜¯å…³é”®ï¼Œä½ ç°åœ¨çš„å¸‚åœºä»€ä¹ˆ 6000 ç‚¹ä¸æ˜¯æ¢¦ï¼Œ10000 ç‚¹åˆšèµ·æ­¥ï¼Œä½ å“ªä¸€æ¡æ”¯æŒäº†ï¼Ÿå€ºåŠ¡æ æ†å†ä¸€æ’¤ï¼Œæ¸¸æˆå°±å´©äº†ï¼Œèµ¶ç´§è·‘ã€‚ä½ ä»¬ä¸è§‰å¾—è¿™ç©æ„è¦å‡ºäº‹ï¼Ÿé‚£ä¹Ÿæ˜¯æ‰‹ï¼Œä¸æ˜¯ç»æµï¼Œä¸­é—´è¿™ä¸€æ®µæ‰æ˜¯æ­£å¸¸ç»æµå‘å±•ï¼Œè€Œä¸­å›½çš„æŒ‡æ•°ç¼–åˆ¶å°†å†³å®šäº†å¤§éƒ¨åˆ†æ—¶é—´ç»æµåæ˜ å‡ºæ¥çš„æ˜¯ç»“æ„ï¼Œä¸æ˜¯å¢é‡ã€‚ç°åœ¨å‡ºæ¥ä¸ª A500ï¼Œæ˜¯æƒ³è¯•å›¾è®© A500 ç±»ä¼¼æ ‡æ™®é‚£æ ·èƒ½åæ˜ æ€»é‡åŠ ç»“æ„ã€‚\nJQK ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿä¸­å›½éå¸¸å¥‡ç‰¹ï¼Œåœ¨æŠ•èµ„çš„è¿‡ç¨‹ä¸­ï¼Œåªåš JQ ç¯èŠ‚ï¼Œç»ä¸åš Kã€‚JQ ç¯èŠ‚æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿè¡Œä¸šæœ‰æ²¡æœ‰å´›èµ·å‘¢ï¼Ÿæ²¡æœ‰ã€‚è¡Œä¸šæœ‰æ²¡æœ‰å›½å®¶ä¸»ä¹‰çš„æ„ä¹‰å‘¢ï¼Ÿæœ‰ã€‚ä½ ä»¬ä¸€å®šè¦è®°ä½ä¸€ç‚¹ï¼Œæˆ‘ä»¬æ˜¯å³ç¿¼ï¼Œå³ç¿¼çš„äº§ä¸šæ”¿ç­–å…¨æ˜¯åå‘äºå›½å®¶ä¸»ä¹‰çš„ï¼Œæ‰€ä»¥è¯´å›½å®¶ä¸»ä¹‰å¹²ä»»ä½•äº‹æƒ…ä¸æ˜¯è¦æŒ£é’±ï¼Œè¦çš„æ˜¯æœ‰ï¼Œä½ ä»¬è®°ä½è¿™å¥è¯ã€‚æ‰€ä»¥ JQ çš„æ‰€æœ‰ç›®çš„æ˜¯ä¸ºäº†æ”¿ç»©ï¼Œæ˜¯ä¸ºäº†æœ‰ã€‚\nè€è‚¡æ°‘éƒ½æ‡‚ï¼Œçœ‹æ–°é—»è”æ’­ç‚’è‚¡çš„é€»è¾‘æ˜¯å•¥ï¼Œä½ å‘Šè¯‰æˆ‘ä½ çœ‹æ–°é—»è”æ’­æ˜¯ç‚’ç»æµå—ï¼Ÿä½ çœ‹æ–°é—»è”æ’­ç‚’è‚¡å°±æ˜¯ç‚’çš„ä»–å“ªå„¿æ²¡æœ‰ä»–æƒ³è¦ï¼Œä½ å°±æŠ•ã€‚è¿™æ—¶å€™æ˜¯æ²¡æœ‰è¯ä¼ªçš„ï¼Œè€Œä»–ä¼šå€¾æ³¨æ‰€æœ‰èµ„æºç»™ä½ ï¼Œå€¾æ³¨åœŸåœ°ã€ç¨æ”¶ã€åœ°æ–¹å¼•å¯¼åŸºé‡‘ï¼Œå€¾æ³¨ä¸€åˆ‡èµ„æºï¼Œè‚¡å¸‚ä¹Ÿæ˜¯èµ„æºï¼Œç”¨æ¥èèµ„çš„ï¼Œä¼šæŠŠä¸€åˆ‡èµ„æºç»™ä½ ï¼Œä½ æ˜¯æœ€çˆ½çš„ã€‚è€Œä½ ä¸€æ—¦åšåˆ°äº†é¥é¥é¢†å…ˆï¼Œä»–çš„æ”¿æ²»ç›®çš„è¾¾åˆ°ä»¥åï¼Œå°±ä¼šæŠŠä½ ç”©åˆ°å¸‚åœºä¸Šè¿›è¡Œå¸‚åœºç»æµçš„ KOï¼Œæ­¤æ—¶ä½ ä»¬å°±ä¼šå‘ç° PPI çš„ç§˜å¯†ã€‚ä½ ä»¬å°±ä¼šå‘ç° PPI çš„å‘¨æœŸæ€§ï¼ŒPPI çš„å‘¨æœŸæ€§å¾ˆç®€å•ï¼Œä½ å¦‚æœæŠŠ PPI é‡Œçš„è¡Œä¸šå†åˆ†ä¸€ä¸‹ï¼Œç”Ÿäº§èµ„æ–™ã€ç”Ÿæ´»èµ„æ–™ï¼Œå†ç»†æ‹†å°±ä¼šå‘ç°å‘¨æœŸæ€§å’Œæ”¿ç­–çš„å…³ç³»ã€‚\nå•¥ä¸œè¥¿å‘¢ï¼Ÿæˆ‘æ²¡æœ‰ï¼Œå°±ä¼šè®© PPI ä¸ºæ­£ï¼Œæˆ‘å€¾æ³¨ä¸€åˆ‡èµ„æºå’Œæ–¹å¼å¯ä»¥è®©ä½ åœ¨é‡Œå¤´æŒ£åˆ°é’±ï¼Œè€Œä¸”ä¸éœ€è¦ç«äº‰ã€‚ä½†æˆ‘ä¸€æ—¦è¾¾åˆ°ç›®çš„ï¼ŒæŠŠä½ æ‰”åˆ°å¸‚åœºç»æµçš„æ—¶å€™ï¼Œä½ ä»¬ä¼šè¿…é€Ÿå‘å±•ï¼Œå¦‚æœæ˜¯æ­£å¼çš„å¸‚åœºç»æµï¼Œç«äº‰æ³¢åŠ¨ä¼šæ¯”è¾ƒæ¸©å’Œçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ç¨å¾®ä¸€æœ‰ç‚¹é’±æŒ£ï¼Œå°±æœ‰äººè¿›æ¥äº†ï¼Œå°±ä¼šçƒ«å¹³ï¼Œå‘¨æœŸæ‹‰çš„æ¯”è¾ƒé•¿ï¼Œéœ€è¦ 30 å¹´æ‰èƒ½å´›èµ·ä¸€ä¸ªå¤§å‹ä¼ä¸šã€‚\nä½†åœ¨ä¸­å›½ä¸æ˜¯ï¼Œä¸­å›½æ˜¯ 5 å¹´ï¼Œäº§ä¸šé“¾å°±è¦åšåˆ°å…¨çƒé¥é¥é¢†å…ˆï¼Œåœ¨ JQ çš„ä¿æŠ¤æœŸå†…ï¼Œå¤§å®¶éƒ½å¯ä»¥æ´»ï¼Œä½†åŒæ ·ä¼šé€ æˆå¾ˆå¤š â€œå¤§å®¶â€ï¼Œä¸€æ—¦ä¿æŠ¤æœŸä¸€åˆ°ï¼Œæ‰”åˆ°å¸‚åœºç»æµçš„æ—¶å€™ï¼Œä½ ä»¬å°±ä¼šå‘ç°å¤§å®¶å°±å˜æˆäº†éè‡ªå·±äººï¼Œå¼€å§‹ PKã€ç«äº‰ã€å†…å·ï¼ŒPPI å¼€å§‹è½¬è´Ÿï¼Œå°±è¿™ä¹ˆç®€å•ã€‚ç„¶åä¸€è½®äº§ä¸šè¿‡å‰©ï¼Œå¼€å§‹æ·˜æ±°ï¼Œæ”¿åºœé©±åŠ¨å†å¼•å¯¼æ–°çš„äº§ä¸šã€‚ç”¨è¿™ç§å‰æµªæ¨åæµªçš„æ–¹å¼ï¼Œæ¨åŠ¨æ•´ä¸ªäº§ä¸šå„ä¸ªç¯èŠ‚çš„å‘¨æœŸç¼©çŸ­åˆ°äº”å¹´ï¼Œä½†æ˜¯ä»£ä»·å°±æ˜¯å¾ˆå¤šè¡Œä¸šä¼šä»¥å¾ˆå¿«çš„é€Ÿåº¦è¿›å…¥åˆ° PPI ä¸ºè´Ÿï¼Œè€Œæ‰€æœ‰èƒ½åˆ° PPI ä¸ºè´Ÿçš„äº§ä¸šï¼Œæœ€åèƒ½æ´»ä¸‹æ¥éƒ½å¾—æ„Ÿè°¢æœ‰è‡ªå·±çš„è´Ÿå€ºç«¯ï¼Œå±…æ°‘éƒ¨é—¨èƒ½ä¹°å•ï¼Œä¸€æ—¦å†…éœ€ä¸å¤Ÿè¿˜è¿™ä¹ˆæï¼Œå°±ä¼šå‡ºå±æœºï¼Œå°±æ˜¯ç°åœ¨è¿™ç§çŠ¶æ€ã€‚\nè€ç™¾å§“çš„æŠ•èµ„æ˜¯è¯´ä½ çœ‹æ–°èƒ½æºæ¸—é€ç‡åˆ°äº†å¤šå°‘å¤šå°‘äº†ï¼Œè€ç™¾å§“å¼€çš„è¶Šæ¥è¶Šå¤šäº†ï¼Œæ€ä¹ˆè‚¡ç¥¨ä¸€ç›´è·Œå‘¢ï¼Ÿè¿™å°±æ˜¯ä»–çš„é”™è¯¯ï¼Œä»–æ²¡æœ‰ç†è§£æ”¿ç­–åˆ°åº•ä»€ä¹ˆæ—¶å€™æŠ•èµ„ï¼Œæˆç†Ÿçš„æ—¶å€™æ˜¯ä¸èƒ½æŠ•çš„ï¼Œå› ä¸ºèƒ½æ”¾ç»™å¸‚åœºçš„æ—¶å€™ä¸€å®šä¸é‚£ä¹ˆæŒ£é’±äº†ï¼Œä¸æ”¾ç»™å¸‚åœºçš„æ—¶å€™ä¸€å®šæ˜¯ç‰¹åˆ«æŒ£é’±çš„ã€‚\nå½“ç„¶ï¼Œè¿™é‡Œé¢è¿˜ç‰µæ‰¯åˆ°ä¸€ç‚¹å°±æ˜¯å½“å¹´ä¾›ç»™ä¾§æ”¹é©ï¼Œä½ ä»¬å¯èƒ½éƒ½æ²¡æœ‰äººä¼šæƒ³åˆ°ä¾›ç»™ä¾§æ”¹é©è·Ÿå½“å¹´çš„è‚¡ç¾å’Œæ¥¼å¸‚æ˜¯æœ‰é«˜åº¦å…³ç³»çš„ã€‚å½“å¹´å‘¨å…´æ¶›ï¼ˆéŸ³ï¼‰åœ¨å¸‚çš„æ—¶å€™ï¼Œ2015 å¹´åº• 2016 å¹´åˆåœ¨ä¸Šæµ·æäº†ä¸ªä¼šè®®è®©æˆ‘è®²ä¾›ç»™ä¾§æ”¹é©ï¼Œæˆ‘è¯´ä¾›ç»™ä¾§æ”¹é©å¾ˆç®€å•ï¼Œ1997 å¹´æœ±é••åŸºæ€»ç†ç¿»ä¸€ä¸‹ï¼Œä¾›ç»™ä¾§æ”¹é©è¿™ä¸ªè¯å°±æ¥è‡ªäºé‚£å„¿ã€‚ä¸­å›½è¿™ä¸€è½®æ‰€æœ‰çš„èµ·ç‚¹æ˜¯ 2002 å¹´ï¼ŒPPI ä¸ºæ­£ï¼Œæ ¸å¿ƒ CPI ä¸ºæ­£ï¼Œæœ‰æ•ˆéœ€æ±‚ä¸ºæ­£ï¼ŒæŒç»­åˆ°äº† 2012 å¹´ï¼Œä¾›ç»™å¼€å§‹è¿‡å‰©ï¼Œä½†æœ‰æ•ˆéœ€æ±‚å¯ä»¥ç»§ç»­åŠ æ æ†ï¼Œåœ¨è¿™å„¿å°±æ˜¯ä¾›ç»™çŸ›ç›¾ï¼Œ2009 å¹´ä¾›éœ€åŒè½ï¼Œè¿™å°±æ˜¯ä¸­å›½è¿™ä¸€è½®ä» 2012 å¹´å¼€å§‹çš„å¤§å‘¨æœŸçš„æœ«ç«¯ã€‚\nä¸Šä¸€æ¬¡æœ«ç«¯æ˜¯ä»€ä¹ˆæ—¶é—´å‘¢ï¼Ÿæ”¹é©å¼€æ”¾ä¸€ç›´åˆ° 90 å¹´ä»£æœ«ï¼Œ2000 å¹´åˆã€‚å‡ºé—¨äº¬ä¸œä¸Š 150 å—é’±ä¹°ã€Šæœ±é••åŸºæ€»ç†ç­”è®°è€…é—®ã€‹ï¼Œä¸‰å·æœ¬ï¼Œé‡Œé¢æ‰€æœ‰çš„äº‹å„¿éƒ½å‘ç”Ÿè¿‡ï¼Œæˆ¿åœ°äº§æ³¡æ²«ã€é‡‘èç»æµå±æœºï¼Œé¼“åŠ±è€ç™¾å§“è¦æœ‰ä¿¡å¿ƒã€‚ä½ çŸ¥é“å½“å¹´æ€ä¹ˆé¼“åŠ±è€ç™¾å§“æœ‰ä¿¡å¿ƒå—ï¼Ÿâ€œå¿ƒè‹¥åœ¨ï¼Œæ¢¦å°±åœ¨ï¼Œå¤§ä¸äº†ä»å¤´å†æ¥â€ï¼Œåˆ˜æ¬¢åŒå¿—ä»æ­¤ä»é‚£å„¿æ´»èµ·æ¥çš„ï¼Œé‚£å°±æ˜¯å½“å¹´é¼“åŠ±ä½ ä»¬æœ‰ä¿¡å¿ƒã€‚\næŠŠå¹´è½»äººçš„å¤±ä¸šç‡ä¸èƒ½æ‹‰é‚£ä¹ˆé«˜ï¼Œä½ ä»¬çŸ¥é“å½“å¹´æ€ä¹ˆåšçš„å—ï¼Ÿå¤§å­¦æœ¬ç§‘æ‰©æ‹›ï¼Œå› ä¸ºæˆ‘ä»¬çš„å¹´è½»å¤±ä¸šç‡ç»Ÿè®¡ä¸Šæ˜¯ä¸ç»Ÿè®¡åœ¨æ ¡ç”Ÿçš„ã€‚æŠŠä½ éƒ½èµ¶åˆ°å¤§å­¦é‡Œï¼Œå¤±ä¸šç‡å°±èƒ½å¾€åå»¶ä¸‰å¹´ã€‚\nä»Šå¹´æ¸…åŒ—é™„äº¤æœ¬ç¡•çš„æ¯”ä¾‹æ˜¯å¤šå°‘å—ï¼Ÿ1 æ¯” 3ï¼Œ5000 æœ¬ç§‘ï¼Œ15000 ç¡•å£«ï¼Œå½“ç„¶ï¼Œå½“å¹´é‚£ç§æ”¿ç­–æœ€åç›´æ¥ç»“æœé€ æˆçš„ä»€ä¹ˆï¼Ÿæ›¾ç»æœ¬ç§‘å¾ˆå€¼é’±ï¼Œç„¶åæœ¬ç§‘ä¸å€¼é’±ã€‚æˆ‘å¤§æ¦‚ç‡è§‰å¾—ä»¥åç¡•å£«å¯èƒ½ä¹Ÿä¸å’‹å€¼é’±äº†ï¼Œå¦‚æœä¸‰å¹´åç»æµçš„é—®é¢˜è¿˜ä¸åŸºç¡€ï¼Œæˆ‘ä¼°è®¡å¼€å§‹é¼“åŠ±ä½ ä»¬è¯»åšäº†ï¼Œè¯»åˆ° 30 å²å†å¼€å§‹å°±ä¸šå§ã€‚åœ¨åº§å®¶é‡Œæœ‰å­©å­çš„ï¼Œä½ å­©å­ä¸æ˜¯å¯ŒäºŒä»£çš„ï¼Œå°±åˆ«å·äº†ï¼Œå¯ŒäºŒä»£å°±æ›´ä¸ç”¨å·äº†ã€‚ç”¨æˆ‘çš„è¯è¯´ï¼Œæƒ³æ¸…æ¥šäº†ï¼Œåé¢å·å­¦å†æ²¡ä»€ä¹ˆå¤ªå¤§ä»·å€¼äº†ã€‚\nå½“å¹´è¿˜å¹²è¿‡å•¥ï¼Ÿé“¶è¡Œé£é™©ï¼Œå››å¤§èµ„äº§ç®¡ç†å…¬å¸å¤„ç†ä¸è‰¯ï¼Œä¾›ç»™ä¾§æ”¹é©ï¼ŒåŒ–å€ºï¼Œè‚¡ç¥¨å’Œæ”¿åºœåŒ–å€ºã€‚å¦‚æœä½ æƒ³çŸ¥é“è‚¡ç¥¨å¸‚åœºåˆ°åº•ç”¨æ¥å¹²å•¥çš„ï¼Œè¯·å“å“å½“å¹´ã€‚2002â€”2004 å¹´ï¼Œç»æµå·²ç»æ¢å¤äº†ï¼ŒA è‚¡è·Œåˆ° 2004 å¹´çš„åŸå› æ˜¯å•¥ï¼Ÿéƒ½æœ‰ï¼Œæ‰€ä»¥ä½ ä»¬çŸ¥é“å€ºåŠ¡åˆ°åº•æ€ä¹ˆåŒ–å—ï¼Ÿç­”æ¡ˆéå¸¸ç®€å•ï¼Œæ‰€æœ‰çš„å€ºåŠ¡è®°ä½ä¸Šä¸‹è”ï¼Œâ€œåªè¦äººè¿˜åœ¨ï¼Œå•¥å€ºéƒ½èƒ½åŒ–â€ã€‚åªè¦äººä¸åœ¨ï¼Œè¿™å€ºæ€ä¹ˆåŒ–ï¼Ÿç¨ç‡ã€‚é‡æ”¶ä¸ä¸Šæ¥ï¼Œå°±æŠ“ç‡ã€‚ä»¥å‰æœ‰äººè¯´ä¸­å›½æ˜¯é«˜ç¨ç‡ï¼Œæ˜¯å±…æ°‘éƒ¨é—¨é«˜ç¨ç‡ï¼Œä¼ä¸šéƒ¨é—¨ä½ç¨ç‡ï¼Œå› ä¸ºå„ç§é€€ç¨ã€è¡¥è´´ç»™ä½ çš„æ˜¯ä½ç¨ç‡çš„ï¼Œå¤§å®¶è¦æ‡‚å¾—ï¼Œè¯¥æŠ“ç¨ç‡çš„æ—¶å€™è¦æŠ“ç¨ç‡ï¼Œä¸ç„¶æ˜¯ä¸å¤Ÿçš„ã€‚è¿™ä¸€æ®µå¤§å‘¨æœŸåˆ°ç°åœ¨ä¸ºæ­¢è¿›å…¥åˆ°æœ«ç«¯ï¼Œè¿™å°±æ˜¯å½“å‰æœ€éº»çƒ¦çš„ç‚¹ä»¥åŠå¤–å›´ç¯å¢ƒã€‚\næµ·å¤–æˆ‘å°±ä¸åˆ†æäº†ï¼Œå› ä¸ºä½ å€’è¿‡å»å°± OK äº†ï¼Œä½ æŠŠè¿‡å»çš„ 40 å¹´å€’è¿‡æ¥å°±æ˜¯æµ·å¤–æ­£åœ¨æ…¢æ…¢å‘ç”Ÿå˜åŒ–ï¼Œäº§ä¸šåœ¨å›å½’ï¼Œè´¸æ˜“å…³ç³»åœ¨é‡å¡‘ã€‚æˆ‘è¿™ä¸¤å¤©åˆšä»æ–°åŠ å¡å›æ¥ï¼Œæ–°åŠ å¡ã€ä¸œå—äºšã€é©¬æ¥è¥¿äºšã€å°åº¦å°¼è¥¿äºšã€è¶Šå—ï¼Œå¼€å¥ç©ç¬‘è¯è¯´ï¼Œ2016 å¹´ä¹‹åçœŸçš„æ˜¯å—ç›Šäºä½ ä¿©äººæ‰“æ¶ï¼Œå› ä¸ºä»–ä»¬åœ¨èµ°æ­£å‘åé¦ˆå’Œå¾ªç¯ï¼Œä»–çš„æ­£å‘åé¦ˆå¾ªç¯å°±æ˜¯æˆ‘ä»¬è½¬ç§»çš„ã€‚\næœ€åé€å¤§å®¶ä¸€å¥è¯ï¼Œè¿™å¼ å›¾æ˜¯å…¨çƒå¾ˆé‡è¦çš„ï¼Œå½“è´¢æ”¿éœ€è¦æ‰©å¼ ï¼Œå½“åˆ©ç‡åœ¨ä¸‹é™ï¼Œä½ ä»¬å¯ä»¥æƒ³æƒ³è´¢æ”¿èŠ±é’±çŸ­æœŸå†…æŒ£ä¸åˆ°ï¼Œå›½å†…ç»æµçš„æœ‰æ•ˆéœ€æ±‚ä¸å¤Ÿï¼Œå‚¨è“„è¿‡å‰©ï¼ŒæŠ•èµ„å›æŠ¥ç‡ä¸‹é™ï¼Œåˆ©ç‡ä¸‹é™ï¼Œåœ¨è¿™ç§èƒŒæ™¯ä¸‹ï¼Œæ±‡ç‡å°±ä»£è¡¨ç€ä½ çš„å®é™…å›æŠ¥ç‡ä»¥åŠæœ¬å¸è´­ä¹°åŠ›ï¼Œæ˜¯å‡å¼±çš„ã€‚æ‰€ä»¥æ–°å…´å¸‚åœºä¸€èˆ¬æ¥è®²ï¼Œå¦‚æœå‡ºç°è¿™ç§çŠ¶å†µä¸€æ˜¯åˆ©å·®ä¼šæ¨ç€æ±‡ç‡è´¬å€¼ï¼›äºŒæ˜¯æ”¿åºœçš„å€ºåŠ¡ä¼šæ¨ç€æ±‡ç‡çš„è´¬å€¼ï¼Œä¼šå¯¼è‡´èµ„æœ¬æµå‡ºï¼Œä¼šå¯¼è‡´ä½ éœ€è¦åŠ æ¯å»åº”å¯¹ï¼Œä½†ä¸€åŠ æ¯ï¼Œç»æµå´©ï¼Œèµ„æœ¬è¿›ä¸€æ­¥æµå‡ºï¼Œè¿™å°±æ˜¯æ–°å…´å¸‚åœºå±æœºã€‚\næ³¨æ„ï¼Œæ–°å…´å¸‚åœºå±æœºä¸å•çº¯æ˜¯ç¾å›½åŠ æ¯ï¼Œè¿™æ˜¯å¾ˆå¤šäººé”™è¯¯çš„è®¤çŸ¥ã€‚æˆ‘å¯ä»¥å‘Šè¯‰ä½ ï¼Œä¸­å›½ä»¥å‰ä»æ¥ä¸ä¼šå´©ï¼Œå› ä¸ºä¸ç®¡è€ç¾åŠ åˆ°å‡ ï¼Œä¸­å›½çš„æŠ•èµ„å›æŠ¥ç‡éƒ½è¿œè¿œé«˜äºè€ç¾çš„è¯ï¼Œæˆ‘ä¸ä¼šæœ‰æ–°å…´å¸‚åœºå±æœºçš„ï¼Œæœ¬è´¨ä¸Šæ˜¯å¯¹å†…æŠ•èµ„å›æŠ¥ç‡å’Œå€ºåŠ¡ã€‚\nå¤§å®¶è€æ˜¯è®²ä¸€å¥ï¼Œè€ç¾åŠ æ¯å°±ä¼šæ”¶å‰²åˆ«äººã€‚æˆ‘å¼€å¥ç©ç¬‘è¯è¯´ï¼Œä½ å¦‚æœæ²¡æœ‰å€Ÿé‚£ä¹ˆå¤šé’±ï¼Œä¸”æŠ•èµ„å›æŠ¥ç‡å¾ˆå¼ºï¼Œä»–åŠ æ¯å¯¹ä½ æ²¡å½±å“ã€‚æœ‰ä¸€è®²ä¸€ï¼Œè€è®²æˆé˜´è°‹è®ºï¼Œä¸æ˜¯å·¦å°±æ˜¯å³äº†ï¼Œæ˜¯åé¢‡çš„ï¼Œæˆ‘ä»¬ç«™åœ¨ä¸­ç«‹çš„è§’åº¦çœ‹ï¼Œå·¦æœ‰å·¦çš„é—®é¢˜ï¼Œå³æœ‰å³çš„é—®é¢˜ï¼Œä¸¤è¾¹éƒ½æœ‰ã€‚\nå…¨ä¸–ç•Œåœ¨ä½åˆ©ç‡å’Œæ”¿åºœè´¢æ”¿æ‰©å¼ æƒ…å†µä¸‹èƒ½ä¿è¯æ±‡ç‡ç¨³å®šçš„åªæœ‰æ¬§ç¾ã€æ—¥æœ¬ï¼Œä»–é‡‡ç”¨çš„æ¨¡å¼å¾ˆç®€å•ï¼Œè‡ªå·±å®¶é‡Œä¸èƒ½æŒ£é’±ï¼Œåˆè¦ä¿è¯è‡ªå·±çš„ä¿¡ç”¨å’Œå¸å€¼çš„ç¨³å®šï¼Œç­”æ¡ˆå°±æ˜¯æˆ‘å¯ä»¥ä½œä¸ºèµ„æœ¬æ–¹åˆ°æµ·å¤–æŒ£é’±ï¼Œè¿™ä¹Ÿæ˜¯å…¨çƒåŒ–å¿…ç„¶åœ¨å½“å¹´ä¼šå‘ç”Ÿçš„è·¯å¾„ï¼Œæ‹¿æµ·å¤–çš„ carry trading å¥—åˆ©èµ„äº§ä½œä¸ºèƒŒä¹¦ï¼Œæ”¯æ’‘æ±‡ç‡ã€‚\næˆ‘å¯ä¸è®¤ä¸ºã€Šå¹¿åœºåè®®ã€‹æŠŠæ—¥æœ¬æ‰“è´¥äº†ï¼Œä½ å»æ—¥æœ¬è®¿é—®ï¼Œä»–ä»¬ä¼šå‘Šè¯‰ä½ æ—¥æœ¬å½“å¹´çš„å®˜å‘˜éƒ½æ˜¯åå›½å®¶ä¸»ä¹‰çš„å³ç¿¼ï¼Œå› ä¸ºä»äºŒæˆ˜åè¿‡æ¥çš„ï¼Œä»–ä»¬åœ¨å†™è‡ªå·±æ‰€æœ‰å›å¿†å½•çš„æ—¶å€™éƒ½è¯´ï¼Œæˆ‘ä»¬æ—¥æœ¬å‘å±•çš„æŒºå¥½ï¼Œæˆ‘ä»¬çš„æ”¿ç­–æ²¡æœ‰é”™ï¼Œéƒ½æ€ªç¾å¸å›½ä¸»ä¹‰ã€‚ä½ æƒ³æƒ³ï¼Œå“ªä¸ªå³ç¿¼ä¼šå†™æœ¬ä¹¦è¯´æˆ‘é”™äº†ï¼Œä½ ä»¬å®¶è€å©†ä¼šè¯´è‡ªå·±é”™äº†å—ï¼Ÿæƒ³å¤šäº†ï¼Œæ€ä¹ˆç€éƒ½å¾—è¯´ä½ é”™äº†ã€‚å½“å¹´ä½ ä»¬çœ‹æ—¥æœ¬å®˜å‘˜ä¹¦çš„æ—¶å€™ï¼Œå°±ä¼šå½¢æˆé”™è¯¯çš„å³ç¿¼è®¤çŸ¥ï¼ŒåŸæ¥æ˜¯ç¾å¸å›½ä¸»ä¹‰æŠŠæ—¥æœ¬æ‰“è´¥çš„ï¼Œè€Œä»–ä¸ä¼šå»åæ€è‡ªå·±çš„é—®é¢˜ã€‚æ—¥æœ¬ä¸­ç«‹çš„è¿™æ‰¹äººç›¸ååœ¨åšå†å²åˆ†æå’Œå›é¡¾çš„æ—¶å€™ï¼Œé‚£ä¸ªç­”æ¡ˆæ›´å‡†ç¡®ã€‚\nåœ¨é‚£ä¸ªèƒŒæ™¯ä¸‹ï¼Œã€Šå¹¿åœºåè®®ã€‹ä»¥åæ—¥å…ƒå¤§å¹…åº¦å‡å€¼ï¼Œæ—¥æœ¬å½¢æˆäº†ä½æ¯æ—¥å…ƒï¼Œå¼ºåŠ¿æ±‡ç‡ï¼Œä»€ä¹ˆæ„æ€ï¼Ÿåˆ°æµ·å¤–å»ï¼Œè´­ä¹°æµ·å¤–èµ„äº§å§ï¼Œæ—¥å…ƒ carry trading å¥—æ¯ï¼Œåˆ°æµ·å¤–å»å½¢æˆï¼Œè¿™å°±æ˜¯æ—¥æœ¬çš„ä¸‰äº•ã€ä¸‰è±ã€ä¸¸çº¢ã€ä¼Šè—¤å¿ ï¼Œä»–ä»¬æ‰¿è½½äº†æ—¥æœ¬æµ·å¤–æ‰€æœ‰è´¢å¯Œã€‚è€Œæ›´å…³é”®çš„æ˜¯æ—¥æœ¬æ”¿åºœå€ºåŠ¡ç”¨äºäº†å¯¹é‚£ä¸€ä»£å±…æ°‘çš„è¡¥å¿ï¼Œæ•™è‚²ã€åŒ»ç–—ã€å…»è€å¯¹ä½ ä»¬çš„æ”¯æ’‘ã€‚å½“ç„¶ï¼Œæ²¡æœ‰å¢é•¿äº†ï¼Œæ‰€ä»¥ä»–çš„å†…å¿ƒæ˜¯ç—›è‹¦çš„ï¼Œè‚‰ä½“ä¸ç—›è‹¦ï¼Œæ‰€ä»¥æ—¥æœ¬æ˜¯å†…å¿ƒç—›è‹¦ï¼Œè‚‰ä½“ä¸ç—›è‹¦ï¼Œç­”æ¡ˆå°±æ˜¯æŠ‘éƒç—‡ã€ç„¦è™‘ç—‡ã€è‡ªæ€æ£®æ—ï¼Œå¦‚æœè‚‰ä½“ç—›è‹¦ï¼Œé‚£å°±ä¸æ˜¯è‡ªæ€ï¼Œé‚£æ˜¯æ€åˆ«äººã€‚\nåœ¨è¿™ç§èƒŒæ™¯ä¸‹ï¼Œè´¢æ”¿è½¬å‘ã€åˆ©ç‡ä¸‹é™ï¼Œcarry trading å¥—æ¯ï¼Œç”¨æµ·å¤–èµ„äº§å…œä½ï¼Œå½¢æˆæ±‡ç‡ï¼Œè¿™å°±æ˜¯å½“å¹´å¾ˆè‘—åçš„ï¼Œæ—¥æœ¬åªè¦å›½å†…æœ‰åœ°éœ‡ï¼Œå…¨çƒèµ„äº§å°±ä¼šé©¬ä¸Šå‡ºç°æŠ›å”®æ½®ï¼Œæ—¥å…ƒå¥—æ¯äº¤æ˜“ä¼šè¿…é€Ÿæ”¯æ’‘æ—¥æœ¬ï¼Œé‡è¦çš„å°±æ˜¯è¿™éƒ¨åˆ†èµ„äº§ä¼šå›æµã€‚\nç¾å›½ä¹Ÿæ˜¯ä¸€æ ·ï¼Œ1980 å¹´åï¼Œç¾å…ƒå¥—æ¯äº¤æ˜“ï¼Œæ‰€ä»¥å…¨çƒå°±å½¢æˆäº†ä½åˆ©ç‡ç¾å…ƒã€å€Ÿè´·ç¾å…ƒï¼Œæ°¸è¿œå€Ÿè´·ï¼Œç¾å›½ä¸èƒ½åŠ æ¯ï¼Œæ°¸è¿œé™æ¯ï¼Œç¾å…ƒæ°¸è¿œæ˜¯å€Ÿè´·æ–¹ï¼Œä¸æ˜¯æŠ•èµ„æ–¹ã€‚è¿™ç§èƒŒæ™¯ä¸‹ï¼Œç”¨ä»–çš„è´¢æ”¿æ‰©å¼ å’Œä½åˆ©ç‡ï¼Œæ”¯æ’‘æ±‡ç‡çš„å°±æ˜¯ç¾å…ƒçš„è·¨å›½èµ„äº§ï¼Œä¹Ÿå°±æ˜¯ç¾è‚¡é‡Œçš„æ‰€æœ‰ä¸Šå¸‚å…¬å¸å’Œè·¨å›½ä¼ä¸šã€‚\nä½†æ˜¯ä»–é€ æˆçš„ç»“æœæ˜¯ï¼Œä¸‰äº•ã€ä¸‰è±ã€ä¸¸çº¢ã€ä¼Šè—¤å¿ å¯Œäº†ï¼Œè€ç™¾å§“ç©·äº†ï¼Œä¹Ÿä¸å«ç©·ï¼Œå°±æ˜¯ä¸å¢é•¿äº†ã€‚è€ç¾ä¹Ÿæ˜¯åŒæ ·çš„é“ç†ï¼Œè·¨å›½ä¼ä¸šé«˜ç®¡å¯Œäº†ï¼Œè€ç™¾å§“ç©·äº†ï¼Œè€Œè€ç™¾å§“æœ€ç»ˆä¼šç”¨é€‰ç¥¨çº¢è„–å­æŠ•å‡ºç‰¹æœ—æ™®è¿›è¡Œé€†è½¬ã€‚é€†è½¬äº†æ¸¸æˆå°±é¢ å€’äº†ï¼Œä½åˆ©ç‡å°±ä¼šå›å½’ï¼Œå¥—åˆ©ä¼šå›å½’ï¼Œäº§ä¸šä¼šå›å½’ï¼Œå€ºåŠ¡ä¼šä¸‹é™ï¼Œæ±‡ç‡ä¼šèµ°å‘ï¼Œå°±è¿™ä¸ªé€»è¾‘ã€‚\nä¸­å›½ä¹Ÿæƒ³è¿™ä¹ˆå¹²ï¼Œä½†åšä¸åˆ°ï¼Œæˆ‘ä»¬ç°åœ¨çš„é—®é¢˜æ˜¯åˆ©ç‡ä½åˆä¸èƒ½ä½åˆ°é‚£ä¹ˆä½ï¼Œè´¢æ”¿æƒ³å¸®è€ç™¾å§“åˆä¸èƒ½çœŸçš„å¸®åˆ°è€ç™¾å§“ï¼Œæ±‡ç‡å‡å€¼ï¼Œæˆ‘ä¸çŸ¥é“å½“å¹´æœ‰å¤šå°‘äººä½ ä»¬å’‹æƒ³çš„å‡åˆ° 5 å— 6 å—ï¼Œä¸æ˜¯æŒ‡ 2016 å¹´ï¼Œæ˜¯æŒ‡è¿™ä¸¤å¹´çªç„¶é—´æœ‰äººè¯´äººæ°‘å¸å°†æ¥å‡åˆ° 5 å— 4 å—ï¼Œä½ é å•¥å‡ï¼Ÿä½ ç”¨ä»€ä¹ˆå‡ï¼Ÿç°åœ¨è¯´ç™½äº†å°±æ˜¯ä¸€ç§å¹³è¡¡ï¼Œåˆ©ç‡ä¸èƒ½é‚£ä¹ˆä½ï¼Œè´¢æ”¿ä¸èƒ½é‚£ä¹ˆæ‰©ï¼Œæ±‡ç‡ä¸èƒ½é‚£ä¹ˆè´¬ï¼Œä¸‰è€…ä¹‹é—´æ‰¾å¹³è¡¡ç‚¹ã€‚æ¯”å¦‚è¯´ 2 çš„åˆ©ç‡ï¼Œå¯¹åº”çš„å°±æ˜¯ 7-7.3 çš„æ±‡ç‡ï¼Œè´¢æ”¿å¯¹åº”çš„å°±æ˜¯èƒ½æ•‘æ•‘åœ°æ–¹æ”¿åºœã€‚å¦‚æœæ˜å¹´æ‰“è´¸æ˜“æˆ˜ï¼Œå˜çš„æ›´åŠ ä¸¥å³»äº†ï¼Œé‚£åˆ©ç‡å¯ä»¥æ›´ä½ç‚¹ï¼Œæ¯”å¦‚ç ´ 2ï¼Œæ±‡ç‡å¯ä»¥å¾€ä¸Šæ”¾ä¸€ä¸‹ï¼Œ7.3-7.6ï¼Œ7.3-7.8ï¼Œè´¢æ”¿å¯ä»¥å†æ‰©ä¸€ç‚¹ï¼Œè¿™æ˜¯æˆ‘ä»¬ç°åœ¨æ‰‹ä¸Šå”¯ä¸€å‰©ä¸‹çš„ç‰Œï¼Œæ€ä¹ˆå¯èƒ½ä¸€æ¬¡ç»™ä½ æ‰“å‡ºå»å‘¢ï¼Ÿå’‹æ‰“ï¼Œæ‰“å‡ºå»ä»¥åæ²¡æœ‰æµ·å¤–å¸‚åœºç»™ä½ åšèƒŒä¹¦ï¼Œæˆ‘ä»¬å°±æ˜¯æ–°å…´å¸‚åœºäº†ã€‚è¿™ä¸ªæ¸¸æˆå°±æ˜¯ç°åœ¨å›½å†…çš„é€»è¾‘ï¼Œæ­¢å’Œç¨³ï¼Œæ²¡æœ‰åˆºæ¿€ï¼Œé å•¥åˆºæ¿€ï¼Ÿä½ å¯¹å›½å†…æ‰€æœ‰èµ„äº§ç†è§£é€äº†ï¼Œå¤§æ¦‚ç‡ä¹Ÿå°±æ˜¯æ˜å¹´çš„ä¸€äº›ä¸œè¥¿äº†ã€‚\nè¯´å¥å®åœ¨è¯ï¼Œå…¨çƒè¿™ä¸¤å¹´æˆ˜äº‰é£é™©ä¸æ–­åŠ å¤§ï¼ŒæŸäº›èµ„äº§è®¡å…¥çš„å¯ä¸æ˜¯åˆ©ç‡ã€æ±‡ç‡ã€è´§å¸ï¼ŒæŸäº›èµ„äº§åœ¨è®¡å…¥çš„æ˜¯æˆ˜äº‰å’Œè„±é’©ï¼Œæ­¤å¤„è¯·å‚è€ƒä¿„ç½—æ–¯ã€‚\næ—¶é—´åŸå› ï¼Œç•™å‡ åˆ†é’Ÿç»™å¤§å®¶æé—®ã€‚\nç°åœºæé—®ï¼šä»˜æ€»æˆ‘é—®ä¸€ä¸ªé—®é¢˜ï¼Œæ‚¨åˆšæ‰ä¹Ÿåœ¨æŠ¥å‘Šé‡Œæåˆ°äº†ï¼Œè¿™ä¹ˆå¤§çš„äººå£å›½å®¶ï¼Œä¹Ÿåˆ°äº† 1 ä¸‡ç¾é‡‘ä»¥ä¸Šçš„äººå‡æ”¶å…¥ï¼Œç»“æ„æ€§æœºä¼šä¼šåœ¨å“ªäº›è¡Œä¸šæˆ–è€…å“ªäº›é¢†åŸŸé‡Œæœ‰ï¼Ÿ\nä»˜é¹ï¼šä½ å°±è®°ä½ä¸€ç‚¹ï¼Œä½ ç°åœ¨è¦ä¹ˆåšå¯Œçš„ï¼Œè¦ä¹ˆåšç©·çš„ï¼Œæ”¾å¼ƒä¸­äº§å§ï¼Œè¿™å°±æ˜¯ç­”æ¡ˆï¼Œåšå¯Œçš„ä¸å—å½±å“ã€‚æ¯”å¦‚è¯´åˆšæ‰çš„å¥¢ä¾ˆå“ï¼Œå¯Œçš„æ˜¯å•¥ï¼Ÿå„ä½å¥³å£«ä»¬ï¼Œè®°ä½ä¸€ç‚¹ï¼Œåªä¹°çˆ±é©¬ä»•ï¼Œé¦™å¥ˆå„¿ã€LVã€GUCCIã€Prada é€šé€šæ”¾å¼ƒï¼Œä»æ–°å“åˆ°äºŒæ‰‹éƒ½ä¼šå´©çš„ï¼Œè¿™å«å¯Œçš„ã€‚\nç©·çš„æ€ä¹ˆåšï¼Ÿæ­å·å·²ç»å¼€å§‹äº†ï¼Œé¦™å¥ˆå„¿ä¸€ä¸ªåŒ…ä¸€å¤©ç§Ÿé‡‘ 25ï¼ŒäºŒå¥¢å·²ç»éƒ½ç©ä¸è½¬äº†ï¼Œç°åœ¨ç©çš„éƒ½æ˜¯ç§Ÿä¸€å¤© 25ï¼Œå¹²å—å‘¢ï¼Ÿç§Ÿç»™ååª›ä»¬æ‹æ‹ç…§æ‰“æ‰“å¡ï¼Œè¿™å°±æ˜¯æè‡´çš„ä¸¤å¤´ã€‚ä¼˜è¡£åº“ï¼Œè¦ä¹ˆå°±å¾€ä¸Šèµ°ï¼Œè¦ä¹ˆå°±æ˜¯å‡çº§åˆ°å§‹ç¥–é¸Ÿï¼Œè¦ä¹ˆå°±å¾€ä¸‹é™çº§åˆ°ä¼˜è¡£åº“ï¼Œä¸è¿‡ç°åœ¨å¹´è½»äººæ›´çŒ›ï¼Œä»–ä»¬éƒ½è§‰å¾—ä¼˜è¡£åº“è´µï¼Œè¿™éƒ½æ²¡è¾™äº†ï¼Œæˆ‘å‘ç°ä¼˜è¡£åº“åœ¨å›½å†…çš„é”€å”®æ•°æ®åœ¨ä¸‹é™ã€‚ä¸ºå•¥å‘¢ï¼Ÿå¹´è½»äººä¸€é—®ï¼Œä¼˜è¡£åº“æŒºè´µï¼Œè¿™æ²¡æ³•å»ç†è§£äº†ï¼Œä¼˜è¡£åº“ã€‚å°±æ˜¯å¾€ä¸¤å¤´ï¼Œä¸­é—´çš„éƒ¨åˆ†ä¸åšã€‚\nç¬¬äºŒï¼Œå¹´è½»äººçš„ç”Ÿæ„åšï¼Œè€å¹´äººçš„ç”Ÿæ„åšï¼Œ40 å¤šå²ä¸­å¹´ä¸åšï¼Œå› ä¸ºä»–åŸºæœ¬ä¸Šæ˜¯ä¸Šæœ‰è€ä¸‹æœ‰å°ï¼Œè¿˜ç€å€ºï¼Œè‹¦å“ˆå“ˆçš„ä¸­å¹´ç‰›é©¬ï¼Œè¿™éƒ¨åˆ†æ”¾å¼ƒã€‚å¹´è½»äººåšå°±æ˜¯ä»–çš„å…´è¶£çˆ±å¥½ä¼šå‘ç”Ÿå¾ˆå¤§çš„å˜åŒ–ï¼Œä»–ä»¬ä¸ä¸€æ ·ï¼Œä¸ç®¡æœ‰é’±æ²¡é’±ï¼Œä»–ä»¬çš„å…´è¶£çˆ±å¥½å®Œå…¨ä¸ä¸€æ ·ã€‚æ¯”å¦‚åŠ¨æ¼«ã€æ¸¸æˆã€äºŒæ¬¡å…ƒï¼Œå°±åƒå¹´è½»äººä¹°åŒ…ï¼Œæˆ‘ä»¬å®¶å§‘å¨˜ä¹°å•¥åŒ…ï¼Ÿä»€ä¹ˆ LVã€GUCCIã€çˆ±é©¬ä»•ç»Ÿç»Ÿä¸ä¹°ï¼Œäººå®¶ä¹° â€œç—›åŒ…â€ï¼ŒçŸ¥é“å•¥æ˜¯ç—›åŒ…å—ï¼ŸçŸ¥é“é‡Œé¢å¡ä¸€å †å§å”§æ˜¯å•¥ä¸œè¥¿å—ï¼Ÿè¿™å°±æ˜¯ä»–ä»¬é‚£ä¸ªæ—¶ä»£çš„æ¶ˆè´¹ã€‚\nè€å¹´äººä½ ä»¬çŸ¥é“åšä»€ä¹ˆå—ï¼Ÿè€å¹´äººè®°ä½ä¸€ç‚¹ï¼Œäººç”Ÿä¸­æœ€åä¸€åˆ»èŠ±é’±ï¼Œä¸€å®šæ˜¯æœ€åä¸€ä¸ªæˆ¿å­ï¼ŒICU ç—…æˆ¿ã€‚ä¸­é—´ 60ã€70 å²ä½ ä¹Ÿæ²¡å•¥å¥½èŠ±çš„ï¼Œæˆ‘ä¸€ç›´é¼“åŠ±ä¸­å›½åº”è¯¥å°½æ—©é€€ä¼‘ï¼Œè¶ç€è¿™ä»£äººæœ‰è´¢å¯Œçš„ï¼Œèƒ½èŠ±çš„æ—¶å€™è®©ä»–èŠ±ï¼ŒæŠŠå²—ä½èŒåŠ¡è®©å‡ºæ¥ç»™å¹´è½»äººã€‚ä½ çœŸå­¦æ—¥æœ¬ï¼Œè€ç€ç«™ç€ï¼Œå¹´è½»çš„ä¸Šä¸å»ï¼Œä½ ä¼šå‘ç°è¯¥èŠ±çš„æ²¡èŠ±è¿˜åœ¨å·¥ä½œï¼Œè¯¥æŒ£çš„æŒ£ä¸ç€ï¼Œæ—¶é—´å°±æ‹–äº†ï¼Œä¸­å›½ä¹Ÿä¸€æ ·ï¼Œæ”¾å¼ƒä¸­é—´ã€‚\nå‰©ä¸‹çš„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå›½å®¶è®©ä½ å¹²å“ªäº›äº§ä¸šä½ å°±å¹²ï¼Œè€Œä¸”ä¸€å®šå¹²æ—©æœŸï¼Œæ—©æœŸå¹²å®Œï¼ŒåæœŸä¸€å®šè¿‡å‰©ï¼Œå¹²æ—©æœŸï¼Œè¾¾åˆ°é¡¶å³°çš„æ—¶å€™å°±æ˜¯å¸‚åœºçƒ­åº¦æé«˜ï¼Œè¦åæœ‰åï¼Œè¦åˆ©æœ‰åˆ©çš„æ—¶å€™ï¼Œæ’¤ã€‚\nç°åœºæé—®ï¼šåŠå¯¼ä½“åˆ°äº†å—ï¼Ÿ\nä»˜é¹ï¼šæ²¡åˆ°ï¼Œå¾ˆç®€å•ï¼Œæˆ‘ä»¬è¿˜æ²¡å®£å¸ƒæˆ‘ä»¬ â€œé¥é¥é¢†å…ˆâ€ï¼Œç€å•¥æ€¥ã€‚ä¼šä¸æƒœä¸€åˆ‡ä»£ä»·ï¼Œå“ªæ€• 10 ä¸ªå…¬å¸ä¸­æœ‰ 9 ä¸ªæ˜¯éª—å­ï¼Œä»–éƒ½è®¤ï¼Œè¿™æ²¡åŠæ³•ï¼Œä½ å¿…é¡»æ˜ç™½å›½å®¶ä¸»ä¹‰çš„ç‰¹å¾ã€‚\nç°åœºæé—®ï¼šæ„Ÿè°¢ä»˜æ€»ï¼Œæƒ³é—®å…³äºæµ·å¤–èµ„äº§é…ç½®çš„é—®é¢˜ï¼Œä¸ªäººåœ¨æµ·å¤–èµ„äº§ç¾è‚¡ã€ç¾å€ºã€æ–°å…´å¸‚åœºçš„å€ºåˆ¸å’Œè‚¡ç¥¨ï¼Œæœ‰ä»€ä¹ˆå»ºè®®ï¼Ÿ\nä»˜é¹ï¼šæ–°å…´å¸‚åœºçš„å€ºåˆ¸å°±æ˜¯ä¸­å›½ï¼ŒåŸåˆ™ä¸Šä½ è´­ä¹°ä»–ã€‚æ¯”å¦‚è¯´ä½ ä»¬é…ç½®å‹çš„ä¼šé…æ–°å…´å¸‚åœºå€ºåˆ¸ï¼Œæˆ‘ä»¬æŠ•æœºå€’æŠŠå‹çš„ç›´æ¥åœ¨æ–°å…´å¸‚åœºæ”¾é«˜åˆ©è´·ï¼Œä»»ä½•æ–°å…´å¸‚åœºæ—©æœŸç¬¬ä¸€ä»¶äº‹æƒ…éƒ½è¿›å»æ”¾è´·ã€‚2015 å¹´å»è¶Šå—ï¼Œæˆ‘åŸæ¥æ˜¯åšå°ç±³æ€»ä»£çš„ï¼Œå¹²ç€å¹²ç€å¼€å§‹æ”¾è´·ï¼Œä¸ºä»€ä¹ˆï¼Ÿä¸­å›½æ—©äº›å¹´ä¹Ÿæ˜¯æ”¾è´·çš„ï¼Œæ–°å…´å¸‚åœºæœ‰ä¸ªç‰¹å¾ï¼Œé‡‘èä½“ç³»ä¸å®Œå–„çš„æƒ…å†µä¸‹ï¼Œå¤®è¡Œå’Œé“¶è¡Œçš„åˆ©ç‡å¹¶ä¸èƒ½æ­£ç¡®åœ°åæ˜ ç»æµå‘¨æœŸçš„èµ„æœ¬ä¾›åº”å’Œéœ€æ±‚ï¼Œæ‰€ä»¥è¯´é“¶è¡Œçš„åˆ©ç‡ä¸€å®šä½äºå®é™…ç»æµçš„æŠ•èµ„å›æŠ¥ç‡ã€‚\næˆ‘ä»¬çš„ â€œæ¬è¿å·¥â€ ç›´æ¥æ¬åˆ°æœ€é«˜çš„åˆ©ç‡ä¸Šå°±å¯ä»¥äº†ï¼Œæ”¾å°è´·è¿çº¦ç‡å¾ˆä½çš„ï¼Œç°åœ¨åœ¨ä¸­å›½æ•¢æ”¾è´·å—ï¼Ÿ\nä¸¾ä¸ªä¾‹å­ï¼Œåœ¨åº§å„ä½ 2 åˆ†æœ‰æ²¡æœ‰äººå€Ÿé’±ç»™æˆ‘ï¼Œä½ ä»¬å¤§æ¦‚ç¬¬ä¸€ååº”æ˜¯ 2 åˆ†ï¼Œä½ è¦æˆ‘æœ¬é‡‘çš„å§ï¼Ÿä½†æŠŠæ—¶é—´å€’å› 10 å¹´å‰ï¼Œ2 åˆ†ï¼Œå¼€å‘å•†é—®ä½ å€Ÿï¼Œä½ å€Ÿä¸å€Ÿï¼Ÿé‚£æ—¶å€™ä½ ä»¬æ‹…å¿ƒè¿çº¦å—ï¼Ÿä¸æ‹…å¿ƒï¼ŒåŸå› è·Ÿä½ æ”¾å¤šå°‘æ¯æ²¡å…³ç³»ï¼Œæ˜¯å¯¹ç»æµçš„åˆ¤æ–­ï¼Œæˆ‘å¯ä»¥å‘Šè¯‰ä½ ï¼Œæ–°å…´å¸‚åœºåœ¨è¿™ä¸ªç»´åº¦ä¸Šå°±æ˜¯å½“å¹´çš„ä¸­å›½ã€‚\näººå®¶çš„å‘˜å·¥ 00 åå°±æ˜¯ 00 åï¼Œ2015 å¹´æœ‰ä¸€äº›äº§ä¸šè½¬ç§»è·Ÿæˆ‘ä»¬å»è¶Šå—ï¼Œæˆ‘è·Ÿè€æ¿è¯´çš„å¾ˆæ¸…æ¥šï¼Œä½ ä¸è¦è§‰å¾—è¶Šå—åŠ³åŠ¨åŠ›æˆæœ¬ä½ï¼Œä¸ä½çš„ã€‚ä»–è¯´è¿™ä¸æ˜¯æŒºä¾¿å®œçš„ï¼Œæˆ‘è¯´åŠ ç­æ˜¯è¦ç»™åŠ ç­è´¹çš„ï¼Œ4 ç‚¹ 59 æ˜¯å¿…é¡»ä¸‹ç­çš„ï¼Œå·¥ä¼šçœŸä¼šç½¢å·¥çš„ã€‚ä¸­å›½åŠ³åŠ¨åŠ›æˆæœ¬ä½çš„åŸå› æ˜¯å•¥ï¼Ÿç‰›é©¬å¯ä»¥éšä¾¿å‹æ¦¨ï¼Œè¿™æ‰æ˜¯åŠ³åŠ¨åŠ›ä½çš„æ ¹å› ã€‚\nè¿™ä¸¤å¹´åˆæœ‰äº›ä¼ä¸šæƒ³å¾€å›è¿çš„åŸå› æ˜¯å•¥ï¼Ÿè¶Šå—è¿™ä¸¤å¹´å¹´è½»äººåŠ¨ä¸åŠ¨å°±ç½¢å·¥ï¼Œç½¢å·¥äº†äººå®¶å·¥ä¼šå°±ä¸Šï¼Œä½ ä¸ç»™åŠ è–ªäººå®¶å°±ä¸å¹²çš„ï¼Œè€æ¿æ‹¿ç€æ²¡è¾™çš„ï¼Œä¸­å›½è€æ¿å¾ˆä¸é€‚åº”ï¼Œå°±æƒ³è¿å›æ¥ã€‚æˆ‘è¯´ä½ ä¹Ÿåˆ«è¿äº†ï¼Œå› ä¸ºä¸­å›½çš„ 00 åä»¬ä¹Ÿå¾ˆå¿«å´›èµ·äº†ï¼Œä»–ä»¬æ•´é¡¿èŒåœºå·²ç»å¼€å§‹äº†ã€‚\nè¿™ä¸¤å¤©é¦™æ¸¯é—¹çš„å¾ˆå‡¶çš„æ˜¯åä¸ºçš„ HR æ‹›è˜ï¼Œä¸€æ ·çš„é“ç†ï¼Œè¿™ä¸ªæ—¶ä»£åˆ°äº†ã€‚\næ–°å…´å¸‚åœºçš„å€ºåˆ¸ï¼Œæœ¬è´¨ä¸Šç¡®å®æ˜¯é«˜æ¯çš„ï¼Œè¿™å¾ˆå¥½ï¼Œç¾è‚¡ç¾å€ºå°±ä¸ç”¨è¯´äº†ï¼Œç¾å…ƒèµ„äº§çš„æŠ•èµ„å›æŠ¥ç‡ä½ è‡ªç„¶ç¢ç£¨å»ï¼Œå½“ç„¶ç¾è‚¡æ˜å¹´ä¼šæœ‰ç‚¹ç‰¹æ®Šï¼Œå› ä¸ºä»Šå¹´åˆ›é€ å¥‡è¿¹äº†ï¼Œä»Šå¹´æ˜¯ç¾è‚¡çš„å¥‡è¿¹å¹´ï¼Œä½ ä»¬å¯èƒ½éƒ½æ²¡æ³¨æ„è¿‡å›æŠ¥ç‡ã€æ³¢åŠ¨ç‡ã€ä¼°å€¼ï¼Œé«˜ä¼°å€¼ï¼Œä½æ³¢åŠ¨ï¼Œé«˜å›æŠ¥ï¼Œè¿™ä¸‰ç§ç»„åˆç†è®ºä¸Šä¸ä¼šåŒæ—¶å‡ºç°çš„ï¼Œä½†ä»Šå¹´åŒæ—¶å‡ºç°äº†ï¼Œæ˜¯ç»å¯¹å¼‚å¸¸çš„ã€‚è¿™å°±æ˜¯å‰å‡ å¹´æˆ‘è·Ÿä½ è®²çš„ï¼Œä½ ä»¬å¿…é¡»è¦æ˜ç™½äººå·¥æ™ºèƒ½å·²ç»å¼€å§‹äº†ã€‚å‰å‡ å¹´æˆ‘è¯´ç¾è‚¡ä¼šä»äººå·¥æ™ºèƒ½çš„é›†ä¸­åˆ°æ…¢æ…¢æ‰©æ•£ï¼Œå¾ˆå¤šäººè¯´ä¸å¯èƒ½ï¼Œä»–å¯¹è‚¡å¸‚ç»“æ„çš„ç†è§£ä¸å¤Ÿæ·±åˆ»çš„ã€‚\nå½“ç„¶ä»Šå¹´æœ€è¾‰ç…Œçš„ä¸€ä»—å°±æ˜¯è‹±ä¼Ÿè¾¾é—ªå´©ä¹‹å‰æˆ‘ä»¬æ˜ç¡®å‘Šè¯‰å›½å†…æ‰€æœ‰çš„å…¬å‹ŸåŸºé‡‘ï¼Œä½ ä»¬è¦æ³¨æ„è‹±ä¼Ÿè¾¾åœºå¤–æ æ†ï¼Œé‚£å¤©æ™šä¸Šå´©äº†ï¼Œå´©å®Œäº†ä¹‹åï¼Œç¬¬äºŒå¤©æ™šä¸Šé©¬ä¸Šåšäº†å°†è¿‘ 8000 äººçš„ç›´æ’­ï¼Œè·Ÿå„å®¶å…¬å‹ŸåŸºé‡‘è¯´ï¼Œè¿™å°±æ˜¯æ³¢åŠ¨ç‡çš„é«˜ç‚¹ï¼Œå› ä¸ºç»æµæ²¡æœ‰é—®é¢˜ï¼Œå¸‚åœºæ²¡æœ‰é—®é¢˜ï¼Œå…¶å®å°±æ˜¯è¿‡ä½çš„æ³¢åŠ¨ç‡å¸¦æ¥å¾ˆå¤šäººåŠ äº†æ æ†ï¼ŒæŠŠè¿™å¸®äººå¹²æ‰å°±å®Œäº†ã€‚\nå½“æ—¶æ–°åŠ å¡æœ‰äº›æœ‹å‹ç»™æˆ‘æ‰“ç”µè¯è¯´ä»˜æ€»è¿™æ€ä¹ˆåŠï¼Ÿæˆ‘è¯´ä½ ä»Šå¤©æ™šä¸ŠæŠŠä¿è¯é‡‘è¡¥ä¸Šï¼Œæ˜å¤©å°±èƒ½æ´»ï¼Œè¡¥ä¸ä¸Šæ­»çš„å°±æ˜¯ä½ ã€‚è¿™è·Ÿè‹±ä¼Ÿè¾¾ã€äººå·¥æ™ºèƒ½æ²¡ä»»ä½•å…³ç³»ï¼Œå¦¥å¦¥çš„å°±æ˜¯çˆ†æ æ†ï¼Œçˆ†å®Œäº†å°±å®Œäº†ï¼Œæˆ‘ä»¬ä¹Ÿçˆ†å®Œï¼Œå»å®Œæ æ†ï¼Œè‹±ä¼Ÿè¾¾é‡æ–°å›åˆ° 3 ä¸‡äº¿ï¼Œç°åœ¨æ˜¯è¿™ç§æƒ…å†µã€‚ä½†è¿™ç§ç»„åˆæ˜å¹´åº”è¯¥ä¸ä¼šæŒç»­ï¼Œé«˜ä¼°å€¼ã€ä½æ³¢åŠ¨ã€é«˜å›æŠ¥ï¼Œä¸ä¼šã€‚æ˜å¹´è¦ä¹ˆä¿æŒç€é«˜ä¼°å€¼ï¼Œä¿æŒç€ä½æ³¢åŠ¨ï¼Œå›æŠ¥ç‡å°±å¾—ä¸‹é™ï¼Œè¦ä¹ˆå°±æ˜¯ä¿æŒç€é«˜æ³¢åŠ¨ï¼Œå›æŠ¥ç‡ä¸‹é™ï¼Œé«˜ä¼°å€¼ï¼Œè¦ä¹ˆå°±æ˜¯ç›´æ¥æ€ä¼°å€¼ï¼Œæˆ‘ç›®å‰çœ‹è¿˜çœ‹ä¸åˆ°æ€ä¼°å€¼çš„è·¯å¾„ï¼Œæ€æ æ†æ˜¯æœ‰å¯èƒ½çš„ï¼Œæ€ä¼°å€¼çš„å¯èƒ½æ€§ä¸å¤§ï¼Œäº§ä¸šçš„ä¸­æœŸæ—©æœŸä¼°å€¼éƒ½æ˜¯åé«˜çš„ã€‚åˆ°æ˜å¹´å»çœ‹ï¼Œç¾è‚¡ç¡®å®ä¸å¤ªä¸€æ ·ã€‚\nä½†æˆ‘è¿˜æ˜¯é‚£å¥è¯ï¼Œå¤§éƒ¨åˆ†æ—¶é—´ä½ è¦ç¢ç£¨ç¢ç£¨ç™¾å¹´ç¾è‚¡ä¸ºå•¥éƒ½æ˜¯ä¸Šæ¶¨çš„ï¼Œæ˜¯æœ‰åŸå› çš„ã€‚å¯¹äºè€ç™¾å§“æ¥è®²ï¼Œç¾è‚¡ä¸æ˜¯å› ä¸ºå®ƒé«˜çš„æ‰€ä»¥é«˜äº†ï¼Œæ˜¯é˜²æ­¢é«˜æ³¢åŠ¨å°±è¡Œäº†ï¼Œä½ åªè¦é˜²æ­¢é«˜æ³¢åŠ¨ï¼Œå¤§éƒ¨åˆ†æ—¶é—´å°±æ˜¯è®©ä½ å®šæŠ•äº†ï¼Œè¿™æ²¡å•¥é€‰çš„ã€‚\nè¿˜æœ‰ä¸€ç‚¹ï¼Œè®°ä½ï¼Œå·´è²ç‰¹æ˜¯èµ„äº§ç®¡ç†ï¼Œä¸æ˜¯å¤§æ•£æˆ·ï¼Œè€ç™¾å§“ä¸€ç†è§£å·´è²ç‰¹æŒæœ‰é‚£ä¹ˆå¤šç°é‡‘ï¼Œæ˜¯ä¸æ˜¯ç¾è‚¡è¦å´©äº†ï¼Ÿç°é‡‘æ˜¯å•¥ï¼Ÿæ˜¯é›¶æ³¢åŠ¨ç‡ 4.5% è‚¡æ¯çš„è‚¡ç¥¨ï¼Œä½ å»å“å“è¿™å¥è¯å°± OK äº†ï¼Œåœ¨èµ„äº§ç»„åˆä¸­ä½ å°±æ˜¯è¯„ä¼°èµ„å€¼ã€æ³¢åŠ¨ã€å›æŠ¥ç‡ï¼Œå½“ä¸‰è€…ä¹‹é—´å¼‚å¸¸çš„æ—¶å€™ï¼Œä½ çš„æ¯”é‡ä¼šè°ƒåˆ° 0 æ³¢åŠ¨ç‡çš„è‚¡æ¯ï¼Œ4.5% çš„è‚¡ç¥¨ä¸Šï¼Œè¿™å°±æ˜¯ç°é‡‘ï¼Œåƒä¸‡åˆ«æŠŠå·´è²ç‰¹ææˆå¤§æ•£æˆ·ï¼Œè¯´å·´è²ç‰¹ä¹°ç°é‡‘è¯´å› ä¸ºç¾è‚¡è¦å´©ï¼ŒåšåšçŸ­è§†é¢‘è’™è’™è€ç™¾å§“å¯ä»¥ï¼Œå’±ä»¬è‡ªå·±å°±åˆ«è¿™ä¹ˆå¹²äº†ï¼Œè¿™å¤§æ¦‚å°±æ˜¯ç¾è‚¡ã€‚\nä¸»æŒäººï¼šæ„Ÿè°¢ä»˜é¹å…ˆç”Ÿçš„ç²¾å½©åˆ†äº«ã€‚ç¨åçš„è‡ªç”±äº¤æµæ—¶é—´ï¼Œå„ä½æœ‰ä»»ä½•å’¨è¯¢æˆ–é—®é¢˜ï¼Œå¯ä»¥å’Œæ‚¨çš„ç§äººè´¢å¯Œè§„åˆ’å¸ˆç»§ç»­äº¤æµã€‚æ´»åŠ¨çš„æœ€åå†å ç”¨å¤§å®¶ä¸¤åˆ†é’Ÿçš„æ—¶é—´ï¼Œéº»çƒ¦å¤§å®¶æ‰«æå±å¹•ä¸Šæ–¹äºŒç»´ç ï¼Œå¡«å†™è°ƒæŸ¥é—®å·ï¼Œæˆ‘ä»¬å¾ˆæœŸå¾…èƒ½æ”¶åˆ°æ‚¨å¯¹äºæœ¬æ¬¡æ´»åŠ¨çš„åé¦ˆï¼Œä»¥ä¾¿æˆ‘ä»¬åœ¨ä»¥åçš„æ´»åŠ¨ä¸­æ›´å¥½çš„æœåŠ¡äºæ‚¨ã€‚\n","date":"1 December 2024","permalink":"/blog/2025-06-24-fupeng_trading_system/","section":"Blog","summary":"HSBC é€Ÿè®° æ±‡ä¸°ç§äººè´¢å¯Œè§„åˆ’\nçºè¶Šä¸–å®¶ Â· è‡»äº«æ²™é¾™ ä¸Šæµ·ç«™\nï¼ˆé€Ÿè®°ç¨¿ï¼‰\næ—¶é—´ï¼š2024 å¹´ 11 æœˆ 24 æ—¥\nåœ°ç‚¹ï¼šä¸Šæµ·æµ¦ä¸œæ–‡åä¸œæ–¹é…’åº— LG1 å±‚ä¸œæ–¹å…\nä¸»æŒäººï¼šå¥³å£«ä»¬ï¼Œå…ˆç”Ÿä»¬ï¼Œå„ä½å°Šæ•¬çš„æ¥å®¾ï¼Œæˆ‘æ˜¯é™ˆä½³æ˜Šï¼ˆéŸ³ï¼‰ï¼Œæˆ‘æ˜¯æ±‡ä¸°ç§äººè´¢å¯Œè§„åˆ’ä¸Šæµ·åˆ†åŒºæ€»ç»ç†ï¼Œæˆ‘ä»£è¡¨ä¸Šæµ·æ±‡ä¸°ç§äººè´¢å¯Œè§„åˆ’æ¬¢è¿å„ä½çš„è…ä¸´ã€‚\nä»Šå¤©æœ‰å¾ˆå¤šæ–°æœ‹å‹ï¼Œä¹Ÿæœ‰å¾ˆå¤šè€æœ‹å‹ï¼Œæˆ‘åœ¨å‘¨äº”çš„æ—¶å€™é—®è¿‡åå°åŒäº‹æŠ¥åæŠ¥äº†å¤šå°‘äº†ï¼Œä»–å‘Šè¯‰æˆ‘ä»¬å·²ç»å¿«è¦æ¥è¿‘ 200 äººäº†ï¼Œä½†ä»ä»Šå¤©çš„è§„æ¨¡æ¥çœ‹ï¼Œæˆ‘æ„Ÿè§‰å¥½åƒä»Šå¤©çš„äººæ•°è¿˜è¦å†è¶…è¿‡ä¸€äº›ã€‚\nå½“ç„¶äº†ï¼Œæœ‰ä¸€äº›æ˜¯åŸå…ˆçš„è€å®¢æˆ·ï¼Œä¹Ÿæœ‰å¾ˆå¤šæ˜¯æ…•åè€Œæ¥ï¼Œçœ‹åˆ°è¿™æ¬¡é‚€è¯·çš„æ˜¯ä»˜é¹å…ˆç”Ÿï¼Œæ‰€ä»¥æ…•åè€Œæ¥ã€‚ä¹Ÿæœ‰ä¸€äº›æ–°æœ‹å‹ã€‚åœ¨ä»˜é¹å…ˆç”Ÿä¸Šå°ä¹‹å‰ï¼Œè¯·å…è®¸æˆ‘å¯¹æ±‡ä¸°ç§äººè´¢å¯Œè§„åˆ’åšç®€çŸ­çš„ä»‹ç»ã€‚\næ±‡ä¸°ç§äººè´¢å¯Œè§„åˆ’æ˜¯å…¨çƒçš„æˆ˜ç•¥é‡ç‚¹ä¹‹ä¸€ï¼Œè€æœ‹å‹éƒ½çŸ¥é“ï¼Œæ±‡ä¸°ç§äººè´¢å¯Œè§„åˆ’æˆç«‹äº 2020 å¹´ï¼Œè·ä»Šåˆšå¥½å››å¹´ï¼Œåœ¨å››å¹´çš„è¿‡ç¨‹ä¸­é›†å›¢ä¸€ç›´åœ¨ç»™æˆ‘ä»¬å¤§åŠ›æ³¨èµ„ï¼Œä¹Ÿæ˜¯é›†å›¢é‡Œæœ€é‡è¦çš„é¡¹ç›®ä¹‹ä¸€ã€‚\nä¸ºä»€ä¹ˆèšç„¦åœ¨ä¸­å›½å¸‚åœºä¸Šï¼Ÿå¤§å®¶å¾ˆå¤šäººéƒ½æ˜ç™½ï¼Œä¸­å›½ä¸­äº§é˜¶çº§çš„äººæ•°åœ¨ä¸–ç•Œä¸Šå æœ‰é‡æ˜¯æœ€åºå¤§çš„ï¼Œéšç€ä¸­å›½ç»æµçš„é«˜é€Ÿå‘å±•ï¼Œä¸­å›½äººè´¢å¯Œç®¡ç†çš„éœ€æ±‚é€æ­¥æå‡åˆ°å¾ˆé«˜çš„æ°´å‡†ã€‚æ‰€ä»¥ï¼Œç§äººè´¢å¯Œè§„åˆ’ä¹Ÿä¼šå˜æˆæ±‡ä¸°çš„é‡è¦æˆ˜ç•¥ä¹‹ä¸€ã€‚\nä»‹ç»ä¸€ä¸‹å‘å±•å†å²ï¼Œä» 2020 å¹´æ±‡ä¸°ç§äººè´¢å¯Œè§„åˆ’æˆç«‹ï¼Œå…ˆæ˜¯åœ¨ä¸Šæµ·å’Œå¹¿å·ï¼Œæ€»éƒ¨ç¦»è¿™é‡Œä¸è¿œï¼Œæ±‡ä¸°æ€»éƒ¨å°±åœ¨å›½é‡‘ï¼Œæ¬¢è¿å¤§å®¶å»åä¸€åã€‚é€æ­¥è¿›å…¥åˆ°æ­å·ã€æ·±åœ³ã€åŒ—äº¬ã€ä½›å±±ï¼Œä»Šå¹´åœ¨è‹å·ã€æˆéƒ½å¼€ç«‹äº†åˆ†æ”¯æœºæ„ã€‚\n2020 å¹´æ±‡ä¸°ç§äººè´¢å¯Œè§„åˆ’æ‰åˆšåˆšæˆç«‹ï¼Œé‚£æ±‡ä¸°çš„å†å²åˆæ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿæ±‡ä¸°ç®€ç§°å« HSBCï¼Œå¾ˆå¤šäººä¼šé—® HSBC å››ä¸ªå­—æ¯åˆ†åˆ«ä»£è¡¨ç€ä»€ä¹ˆï¼Œå¯ä»¥è·Ÿå¤§å®¶ç®€å•ä»‹ç»ä¸€ä¸‹ï¼ŒH ä»£è¡¨çš„æ˜¯é¦™æ¸¯çš„æ„æ€ï¼ŒS ä»£è¡¨çš„æ˜¯ä¸Šæµ·çš„æ„æ€ã€‚å¾ˆå¤šäººå°è±¡ä¸­ä»¥ä¸ºæ±‡ä¸°æ˜¯ä¸€å®¶å¤–èµ„é“¶è¡Œï¼Œä½†å…¶å®å¤§å®¶æœ‰æ‰€ä¸çŸ¥ï¼Œå…¶å®æ±‡ä¸°åœ¨æ¸…æœçš„æ—¶å€™å°±åœ¨å¤–æ»©å·²ç»è®¾ç«‹äº†æ€»éƒ¨ï¼Œç°åœ¨è¿™æ ‹æ¥¼äº¤ç»™äº†æµ¦å‘é“¶è¡Œã€‚1949 å¹´ä¹‹åï¼Œæ±‡ä¸°å› ä¸ºå†å²çš„åŸå› é€€å‡ºäº†ä¸­å›½ï¼Œåœ¨ WTO ä¹‹åå›åˆ°äº†ä¸­å›½ã€‚\næ±‡ä¸° 1865 å¹´æˆç«‹è‡³ä»Šå·²ç»æœ‰ 100 å¤šå¹´äº†ï¼Œé‚£æ—¶å€™è¿˜æ˜¯æ¸…æœçš„åŒæ²»å¹´é—´ï¼ŒåŒæ—¶å·²ç»åœ¨å…¨çƒçš„ 62 ä¸ªå›½å®¶è¿˜æœ‰ 3900 å¤šåå®¢æˆ·ï¼Œè¿™æ®µå†å²å’Œè¿™ä¹ˆå¤§çš„åˆ†å¸ƒä¹Ÿæ˜¯æ±‡ä¸°å¾ˆå¤šåŒäº‹å†…å¿ƒçš„éª„å‚²ã€‚æˆ‘ä»¬è·Ÿå¾ˆå¤šå®¢æˆ·åšæ²Ÿé€šçš„æ—¶å€™ï¼Œç»å¸¸ä¼šæŠŠè¿™æ®µå†å²æ‹¿å‡ºæ¥è·Ÿå¤§å®¶è®²ä¸€è®²ï¼Œå°±åƒè¿™å¤´çŸ³ç‹®å­ï¼Œå¾ˆå¤šäººéƒ½è§è¿‡ï¼Œä½†å¾ˆå¤šäººéƒ½ä¸çŸ¥é“å®ƒçš„å†å²ï¼Œå¾ˆå¤šäººåœ¨æµ·æŠ¥ã€å¹¿å‘Šã€æ¸¯å…ƒå¤§é’ä¸Šçœ‹è¿‡è¿™ä¸ªçŸ³ç‹®å­ï¼ŒåŸæ¥åœ¨å¤–æ»©ä¸Šä¹Ÿæœ‰ä¸¤åº§ï¼Œç°åœ¨æ”¾åœ¨ä¸Šæµ·åšç‰©é¦†é‡Œï¼Œå‰ä¸€é˜µå„¿æˆ‘åœ¨åšç‰©é¦†å‚è§‚çš„æ—¶å€™è¿˜çœ‹åˆ°äº†è¿™ä¸¤åªçŸ³ç‹®å­ï¼Œä¸Šé¢è¿˜æœ‰å¾ˆå¤šå†å²çš„ç—•è¿¹ï¼Œæ¯”å¦‚è¯´æˆ˜äº‰è€Œç•™ä¸‹çš„å¼¹å­”ï¼Œå°±åœ¨äººæ°‘å¹¿åœºçš„åšç‰©é¦†é‡Œï¼Œå¤§å®¶æœ‰å…´è¶£çš„è¯å¯ä»¥å»çœ‹ä¸€ä¸‹ã€‚\nè´¢å¯Œå¤§çŸ©é˜µä¸ä¸­å›½å†…åœ°å¸‚åœºï¼Œæ±‡ä¸°é›†å›¢å¯¹äºä¸­å›½ç§äººè´¢å¯Œè§„åˆ’ä¸šåŠ¡çš„é‡è§†ç¨‹åº¦ï¼Œåœ¨å¤§çŸ©é˜µä¸­æ‰¿æ‹…äº†å¾ˆé‡è¦çš„åœ°ä½ã€‚\næ¯ 100 ä½å®¢æˆ·ä¸­ï¼Œä¼šæœ‰ 87 ä½å®¢æˆ·å°†æ±‡ä¸°ç§äººè´¢å¯Œè§„åˆ’è§†ä½œä¸ºæä¾›è´¢å¯Œé‡è¦çš„ä¸»è¦å“ç‰Œï¼Œæå‡ºäº†å¾ˆå¤šå¥½è¯„ï¼Œ82% çš„è°ƒç ”è€…æ‰“å‡º 9-10 åˆ†çš„é«˜åˆ†ã€‚\nä¹Ÿæœ‰ä¸€äº›æ¯”è¾ƒæœ‰æ„æ€çš„è¯ï¼Œå¦‚ï¼šâ€œå¯¹äº§å“å†…å®¹çš„ä¿éšœæ»¡æ„ï¼Œå…¬å¸å¤§æœ‰ä¿éšœï¼›ç”„æ±‡ç”Ÿæ´»æœ‰ä¸€å®šçš„å¸å¼•åŠ›ï¼Œæ±‡ä¸°çš„äº§å“è¾ƒè´µä½†ä¹Ÿæ„¿æ„ä¹°ï¼Œå› ä¸ºå¯¹æ±‡ä¸°ç§äººè´¢å¯Œè§„åˆ’å¸ˆçš„è®¤å¯ã€‚â€\nè¿™ä¸¤å¹´æå‡ºä¸€å¥æ¯”è¾ƒæ–°çš„ Sloganâ€œæ‡‚ä½ å…³å¿ƒçš„ï¼Œç»™ä½ å®‰å¿ƒçš„â€ã€‚\nä»Šå¤©çš„æ´»åŠ¨æˆ‘ä»¬é‚€è¯·åˆ°äº†ä¸€ä½é‡é‡çº§å˜‰å®¾ï¼Œä»–æ›¾ä»»èŒäºé›·æ›¼å…„å¼Ÿã€æ‰€ç½—é—¨æŠ•èµ„é›†å›¢ç­‰å…¨çƒé¡¶å°–é‡‘èæœºæ„ï¼Œä»äº‹å¯¹å†²åŸºé‡‘ç­‰ç›¸å…³å·¥ä½œã€‚ä»–å°±æ˜¯ä¸œåŒ—è¯åˆ¸é¦–å¸­ç»æµå­¦å®¶ä»˜é¹å…ˆç”Ÿã€‚è®©æˆ‘ä»¬æ¬¢è¿ä»˜é¹å…ˆç”Ÿä¸ºæˆ‘ä»¬å¸¦æ¥ã€Š2024 å¹´å¹´ç»ˆå›é¡¾å’Œ 2025 å¹´å±•æœ›â€”â€”å¯¹å†²é£é™© VS è½¯ç€é™†ã€‹ä¸»é¢˜åˆ†äº«ï¼Œæœ‰è¯·ä»˜é¹å…ˆç”Ÿï¼\nä»˜é¹ï¼šæ­£å€¼å¹´åº•ï¼Œè™½ç„¶åˆšæ‰æ±‡ä¸°ä¸€ç›´å¼ºè°ƒå¤§å®¶ä¸å½•éŸ³ä¸å½•åƒï¼Œä½†å¤§æ¦‚ç‡ä½ æŒ¡ä¸ä½ã€‚æˆ‘åœ¨è¿™å„¿è®²è¯ä¼šè°¨æ…ä¸€äº›ï¼Œéå¸¸å°å¿ƒè°¨æ…ï¼Œå¤§æ¦‚ç‡ä¼šæœ‰äººé€éœ²å‡ºå»ï¼Œæ”¾åˆ° YouTube ä¸Šï¼ŒåŸºæœ¬ä¸Šæ‰€æœ‰è§æˆ‘éƒ½è¯´ä»˜æ€»æˆ‘åœ¨ YouTube ä¸Šçœ‹è¿‡ä½ çš„è§†é¢‘ï¼Œæˆ‘è¯´é‚£éƒ½æ˜¯ç›—ç‰ˆçš„ï¼Œé ç›—ç‰ˆå‘è´¢çš„ä¹Ÿä¸å°‘ã€‚","title":"ä»˜é¹HSBC"},{"content":"OrderBook æœ¬åœ°ç»´æŠ¤æ–¹æ¡ˆè®¾è®¡ #ä¸€ã€ä¸šåŠ¡èƒŒæ™¯ #OrderBookï¼ˆè®¢å•ç°¿ï¼‰æ˜¯åæ˜ å¸‚åœºæ·±åº¦å’ŒæµåŠ¨æ€§çš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼Œå…¶ç»´æŠ¤è´¨é‡ç›´æ¥å½±å“ï¼š\nç­–ç•¥äº¤æ˜“å†³ç­–çš„å‡†ç¡®æ€§ é£é™©æ§åˆ¶çš„æœ‰æ•ˆæ€§ å¸‚åœºå®šä»·çš„åŠæ—¶æ€§ 1.1 ä¸šåŠ¡ä»·å€¼ # ä»·æ ¼å‘ç°\nå®æ—¶åæ˜ å¸‚åœºä¾›éœ€çŠ¶æ€ æä¾›å¤šå±‚æ¬¡ä»·æ ¼ä¿¡æ¯ å±•ç¤ºå¸‚åœºæ·±åº¦åˆ†å¸ƒ äº¤æ˜“å†³ç­–æ”¯æŒ\næœ€ä¼˜ä»·æ ¼ç¡®å®šï¼ˆNBBOï¼‰ æµåŠ¨æ€§è¯„ä¼° äº¤æ˜“æˆæœ¬ä¼°ç®— é£é™©ç®¡ç†\nå¸‚åœºå¼‚å¸¸ç›‘æ§ æµåŠ¨æ€§é£é™©è¯„ä¼° ä»·æ ¼æ³¢åŠ¨è¿½è¸ª äºŒã€æŠ€æœ¯æ–¹æ¡ˆ #2.1 æ ¸å¿ƒæ•°æ®ç»“æ„ #class LockFreeOrderBook { private: // åŸºç¡€ä¿¡æ¯ std::string symbol_; // çŠ¶æ€ç®¡ç† std::atomic\u0026lt;uint64_t\u0026gt; last_update_time_{0}; std::atomic\u0026lt;uint64_t\u0026gt; last_sequence_{0}; std::atomic\u0026lt;bool\u0026gt; initialized_{false}; // ä»·æ ¼æ¡£ä½å­˜å‚¨ using PriceLevelMap = tbb::concurrent_map\u0026lt;double, PriceLevel, std::greater\u0026lt;\u0026gt;\u0026gt;; PriceLevelMap bids_; // ä¹°ç›˜ - é™åº PriceLevelMap asks_; // å–ç›˜ - å‡åº }; // ä»·æ ¼æ¡£ä½ç»“æ„ struct PriceLevel { double price; double quantity; uint64_t update_time; }; // æ·±åº¦æ•°æ®ç»“æ„ struct DepthData { std::vector\u0026lt;PriceLevel\u0026gt; bids; std::vector\u0026lt;PriceLevel\u0026gt; asks; uint64_t sequence_num; uint64_t timestamp; }; 2.2 æ ¸å¿ƒåŠŸèƒ½å®ç° # å¿«ç…§æ•°æ®å¤„ç† void LockFreeOrderBook::onSnapshot(const QuoteData::L2MarketData\u0026amp; data) { // åºåˆ—å·æ£€æŸ¥ if (initialized_ \u0026amp;\u0026amp; data.sequence_num \u0026lt;= last_sequence_) return; // é‡å»ºè®¢å•ç°¿ bids_.clear(); asks_.clear(); // æ‰¹é‡æ„å»ºä»·æ ¼æ¡£ä½ for (const auto\u0026amp; event : data.events) { for (const auto\u0026amp; update : event.updates) { if (update.new_quantity \u0026lt;= 0) continue; PriceLevel level(update.price_level, update.new_quantity, data.timestamp); if (update.side == \u0026#34;bid\u0026#34;) { bids_.emplace(update.price_level, level); } else { asks_.emplace(update.price_level, level); } } } // æ›´æ–°çŠ¶æ€ updateState(data); } å¢é‡æ›´æ–°å¤„ç† void LockFreeOrderBook::onUpdate(const QuoteData::L2MarketData\u0026amp; data) { // çŠ¶æ€æ£€æŸ¥ if (!initialized_ || data.sequence_num \u0026lt;= last_sequence_) return; // å¤„ç†ä»·æ ¼æ¡£ä½æ›´æ–° for (const auto\u0026amp; event : data.events) { for (const auto\u0026amp; update : event.updates) { PriceLevel level(update.price_level, update.new_quantity, data.timestamp); auto\u0026amp; book = (update.side == \u0026#34;bid\u0026#34;) ? bids_ : asks_; auto [it, inserted] = book.emplace(update.price_level, level); if (!inserted) { it-\u0026gt;second = level; // æ›´æ–°ç°æœ‰æ¡£ä½ } } } // æ›´æ–°çŠ¶æ€ updateState(data); } æ·±åº¦æ•°æ®æŸ¥è¯¢ DepthData LockFreeOrderBook::getDepth(size_t levels) const { DepthData result; result.sequence_num = last_sequence_; result.timestamp = last_update_time_; // æ”¶é›†æœ‰æ•ˆä»·æ ¼æ¡£ä½ for (const auto\u0026amp; [price, level] : bids_) { if (level.quantity \u0026gt; 0 \u0026amp;\u0026amp; result.bids.size() \u0026lt; levels) { result.bids.push_back(level); } } for (const auto\u0026amp; [price, level] : asks_) { if (level.quantity \u0026gt; 0 \u0026amp;\u0026amp; result.asks.size() \u0026lt; levels) { result.asks.push_back(level); } } return result; } 2.3 æŠ€æœ¯ç‰¹ç‚¹ # å¹¶å‘å®‰å…¨\nä½¿ç”¨ TBB concurrent_map ä¿è¯æ•°æ®ä¸€è‡´æ€§ åŸå­æ“ä½œä¿è¯çŠ¶æ€æ›´æ–°çš„å®‰å…¨æ€§ æ— é”è®¾è®¡å‡å°‘ç«äº‰ æ€§èƒ½ä¼˜åŒ–\næœ€å°åŒ–é”ç«äº‰ é«˜æ•ˆçš„æ•°æ®ç»“æ„é€‰æ‹© æ‰¹é‡å¤„ç†èƒ½åŠ› å¯é æ€§ä¿è¯\nåºåˆ—å·æœºåˆ¶ç¡®ä¿æ•°æ®å®Œæ•´æ€§ å¼‚å¸¸å¤„ç†æœºåˆ¶ çŠ¶æ€ä¸€è‡´æ€§ç»´æŠ¤ ä¸‰ã€åº”ç”¨åœºæ™¯ #3.1 ç­–ç•¥åº”ç”¨ # åšå¸‚ç­–ç•¥ void MarketMakingStrategy::onOrderBookUpdate() { auto depth = orderbook_-\u0026gt;getDepth(5); // è®¡ç®—ä¹°å–ä»·å·® double spread = depth.asks[0].price - depth.bids[0].price; // è¯„ä¼°å¸‚åœºçŠ¶æ€ if (isValidSpread(spread)) { updateQuotes(depth); } } å¥—åˆ©ç­–ç•¥ void ArbitrageStrategy::checkOpportunity() { auto depth1 = orderbook1_-\u0026gt;getDepth(1); auto depth2 = orderbook2_-\u0026gt;getDepth(1); double spread = calculateSpread(depth1, depth2); if (spread \u0026gt; threshold_) { executeArbitrage(); } } 3.2 é£é™©æ§åˆ¶ #void RiskManager::monitorMarket() { auto depth = orderbook_-\u0026gt;getDepth(10); // æ£€æŸ¥å¸‚åœºè´¨é‡ checkMarketQuality(depth); // ç›‘æ§ä»·æ ¼æ³¢åŠ¨ monitorPriceMovement(depth); // è¯„ä¼°æµåŠ¨æ€§ assessLiquidity(depth); } å››ã€æ€§èƒ½æŒ‡æ ‡ # å»¶è¿Ÿè¦æ±‚\næ›´æ–°å¤„ç†å»¶è¿Ÿ \u0026lt; 100å¾®ç§’ æŸ¥è¯¢å“åº”å»¶è¿Ÿ \u0026lt; 50å¾®ç§’ æ‰¹é‡å¤„ç†èƒ½åŠ› \u0026gt; 10000æ¬¡/ç§’ èµ„æºæ¶ˆè€—\nå†…å­˜å ç”¨ \u0026lt; 1GB/äº¤æ˜“å¯¹ CPUä½¿ç”¨ç‡ \u0026lt; 30% ç½‘ç»œå¸¦å®½ \u0026lt; 100Mbps äº”ã€åç»­ä¼˜åŒ–æ–¹å‘ # æ€§èƒ½ä¼˜åŒ–\nå¼•å…¥å†…å­˜æ± ç®¡ç† å®ç°å®šæœŸæ¸…ç†æœºåˆ¶ ä¼˜åŒ–æ•°æ®ç»“æ„å¸ƒå±€ åŠŸèƒ½æ‰©å±•\næ·»åŠ ç»Ÿè®¡åˆ†æåŠŸèƒ½ å®ç°å†å²æ•°æ®å›æ”¾ æ”¯æŒå¤šå¸‚åœºæ•´åˆ ç›‘æ§å®Œå–„\nå»¶è¿Ÿç›‘æ§ å†…å­˜ä½¿ç”¨ç›‘æ§ å¼‚å¸¸äº‹ä»¶å‘Šè­¦ é€šè¿‡è¿™å¥—æ–¹æ¡ˆï¼Œæˆ‘ä»¬å¯ä»¥é«˜æ•ˆåœ°ç»´æŠ¤æœ¬åœ°è®¢å•ç°¿ï¼Œä¸ºä¸Šå±‚ç­–ç•¥æä¾›å‡†ç¡®ã€åŠæ—¶çš„å¸‚åœºæ•°æ®æ”¯æŒï¼ŒåŒæ—¶ä¿è¯ç³»ç»Ÿçš„å¯é æ€§å’Œå¯æ‰©å±•æ€§ã€‚\n","date":"27 November 2024","permalink":"/blog/2025-06-24-orderbook_implementation/","section":"Blog","summary":"OrderBook æœ¬åœ°ç»´æŠ¤æ–¹æ¡ˆè®¾è®¡ #ä¸€ã€ä¸šåŠ¡èƒŒæ™¯ #OrderBookï¼ˆè®¢å•ç°¿ï¼‰æ˜¯åæ˜ å¸‚åœºæ·±åº¦å’ŒæµåŠ¨æ€§çš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼Œå…¶ç»´æŠ¤è´¨é‡ç›´æ¥å½±å“ï¼š\nç­–ç•¥äº¤æ˜“å†³ç­–çš„å‡†ç¡®æ€§ é£é™©æ§åˆ¶çš„æœ‰æ•ˆæ€§ å¸‚åœºå®šä»·çš„åŠæ—¶æ€§ 1.1 ä¸šåŠ¡ä»·å€¼ # ä»·æ ¼å‘ç°\nå®æ—¶åæ˜ å¸‚åœºä¾›éœ€çŠ¶æ€ æä¾›å¤šå±‚æ¬¡ä»·æ ¼ä¿¡æ¯ å±•ç¤ºå¸‚åœºæ·±åº¦åˆ†å¸ƒ äº¤æ˜“å†³ç­–æ”¯æŒ\næœ€ä¼˜ä»·æ ¼ç¡®å®šï¼ˆNBBOï¼‰ æµåŠ¨æ€§è¯„ä¼° äº¤æ˜“æˆæœ¬ä¼°ç®— é£é™©ç®¡ç†\nå¸‚åœºå¼‚å¸¸ç›‘æ§ æµåŠ¨æ€§é£é™©è¯„ä¼° ä»·æ ¼æ³¢åŠ¨è¿½è¸ª äºŒã€æŠ€æœ¯æ–¹æ¡ˆ #2.1 æ ¸å¿ƒæ•°æ®ç»“æ„ #class LockFreeOrderBook { private: // åŸºç¡€ä¿¡æ¯ std::string symbol_; // çŠ¶æ€ç®¡ç† std::atomic\u0026lt;uint64_t\u0026gt; last_update_time_{0}; std::atomic\u0026lt;uint64_t\u0026gt; last_sequence_{0}; std::atomic\u0026lt;bool\u0026gt; initialized_{false}; // ä»·æ ¼æ¡£ä½å­˜å‚¨ using PriceLevelMap = tbb::concurrent_map\u0026lt;double, PriceLevel, std::greater\u0026lt;\u0026gt;\u0026gt;; PriceLevelMap bids_; // ä¹°ç›˜ - é™åº PriceLevelMap asks_; // å–ç›˜ - å‡åº }; // ä»·æ ¼æ¡£ä½ç»“æ„ struct PriceLevel { double price; double quantity; uint64_t update_time; }; // æ·±åº¦æ•°æ®ç»“æ„ struct DepthData { std::vector\u0026lt;PriceLevel\u0026gt; bids; std::vector\u0026lt;PriceLevel\u0026gt; asks; uint64_t sequence_num; uint64_t timestamp; }; 2.","title":"OrderBook æœ¬åœ°ç»´æŠ¤æ–¹æ¡ˆè®¾è®¡"},{"content":"","date":null,"permalink":"/tags/memeoy/","section":"Tags","summary":"","title":"Memeoy"},{"content":"1. æ¦‚è¿° #å†…å­˜æ˜ å°„ï¼ˆmmapï¼‰æ˜¯ä¸€ç§å°†æ–‡ä»¶æˆ–è®¾å¤‡æ˜ å°„åˆ°å†…å­˜çš„æ–¹æ³•ï¼Œè€Œé›¶æ‹·è´æ˜¯ä¸€ç§å‡å°‘æˆ–é¿å…æ•°æ®åœ¨å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´ä¹‹é—´ä¸å¿…è¦å¤åˆ¶çš„æŠ€æœ¯ã€‚è¿™ä¸¤ä¸ªæ¦‚å¿µå¯†åˆ‡ç›¸å…³ï¼Œä½†åˆæœ‰æ‰€ä¸åŒã€‚\n2. mmap æ˜¯é›¶æ‹·è´å—ï¼Ÿ #ç­”æ¡ˆæ˜¯ï¼šmmap æœ¬èº«ä¸æ˜¯é›¶æ‹·è´æŠ€æœ¯ï¼Œä½†å®ƒå¯ä»¥å®ç°é›¶æ‹·è´çš„æ•ˆæœã€‚\n2.1 mmap çš„å·¥ä½œåŸç† # å½“è°ƒç”¨ mmap æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šåœ¨è™šæ‹Ÿå†…å­˜ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„å†…å­˜åŒºåŸŸã€‚ è¿™ä¸ªå†…å­˜åŒºåŸŸä¼šæ˜ å°„åˆ°æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ï¼ˆpage cacheï¼‰ä¸­çš„ç‰©ç†é¡µé¢ã€‚ å½“ç¨‹åºè®¿é—®è¿™ä¸ªå†…å­˜åŒºåŸŸæ—¶ï¼Œå¦‚æœç›¸åº”çš„é¡µé¢ä¸åœ¨å†…å­˜ä¸­ï¼Œä¼šè§¦å‘ç¼ºé¡µä¸­æ–­ï¼Œæ“ä½œç³»ç»Ÿä¼šä»ç£ç›˜åŠ è½½æ•°æ®åˆ°å†…å­˜ã€‚ 2.2 ä¸ºä»€ä¹ˆ mmap å¯ä»¥å®ç°é›¶æ‹·è´ # ä¸€æ—¦æ˜ å°„å»ºç«‹ï¼Œç”¨æˆ·è¿›ç¨‹å¯ä»¥ç›´æ¥è¯»å†™è¿™ä¸ªå†…å­˜åŒºåŸŸï¼Œè€Œæ— éœ€åœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ä¹‹é—´è¿›è¡Œæ•°æ®å¤åˆ¶ã€‚ å¯¹äºè¯»æ“ä½œï¼Œæ•°æ®ä»ç£ç›˜è¯»å…¥ page cache åï¼Œå¯ä»¥ç›´æ¥è¢«ç”¨æˆ·è¿›ç¨‹è®¿é—®ï¼Œæ— éœ€é¢å¤–å¤åˆ¶ã€‚ å¯¹äºå†™æ“ä½œï¼Œä¿®æ”¹ç›´æ¥å‘ç”Ÿåœ¨ page cache ä¸Šï¼Œæ“ä½œç³»ç»Ÿä¼šåœ¨é€‚å½“çš„æ—¶å€™å°†ä¿®æ”¹åŒæ­¥åˆ°ç£ç›˜ã€‚ 3. mmap ä¸ä¼ ç»Ÿ I/O çš„æ¯”è¾ƒ #3.1 ä¼ ç»Ÿ read ç³»ç»Ÿè°ƒç”¨ #char buffer[4096]; ssize_t bytes_read = read(fd, buffer, sizeof(buffer)); è¿™ä¸ªè¿‡ç¨‹æ¶‰åŠä¸¤æ¬¡æ•°æ®æ‹·è´ï¼š\nä»ç£ç›˜åˆ°å†…æ ¸ç¼“å†²åŒº ä»å†…æ ¸ç¼“å†²åŒºåˆ°ç”¨æˆ·ç©ºé—´ç¼“å†²åŒº 3.2 ä½¿ç”¨ mmap #void* addr = mmap(NULL, file_size, PROT_READ, MAP_PRIVATE, fd, 0); // ç›´æ¥è®¿é—® addr æŒ‡å‘çš„å†…å­˜ mmap å‡å°‘äº†ä¸€æ¬¡æ•°æ®æ‹·è´ï¼Œæ•°æ®ç›´æ¥ä»ç£ç›˜åˆ°ç”¨æˆ·å¯è®¿é—®çš„å†…å­˜ã€‚\n4. mmap çš„ä¼˜åŠ¿å’Œæ³¨æ„äº‹é¡¹ #4.1 ä¼˜åŠ¿ # å‡å°‘æ•°æ®æ‹·è´ï¼Œæé«˜I/Oæ•ˆç‡ æ”¯æŒéšæœºè®¿é—®å¤§æ–‡ä»¶ å¯ä»¥å®ç°è¿›ç¨‹é—´é€šä¿¡ 4.2 æ³¨æ„äº‹é¡¹ # å¤§æ–‡ä»¶æ˜ å°„å¯èƒ½å¯¼è‡´åœ°å€ç©ºé—´ç¢ç‰‡ å†™æ“ä½œå¯èƒ½è§¦å‘å†™æ—¶å¤åˆ¶ï¼ˆCopy-on-Writeï¼‰ï¼Œå½±å“æ€§èƒ½ éœ€è¦è°¨æ…å¤„ç†æ–‡ä»¶å¤§å°å˜åŒ–çš„æƒ…å†µ 5. çœŸæ­£çš„é›¶æ‹·è´æŠ€æœ¯ #zero copy\nè™½ç„¶ mmap å¯ä»¥å‡å°‘æ‹·è´ï¼Œä½†çœŸæ­£çš„é›¶æ‹·è´æŠ€æœ¯é€šå¸¸æŒ‡çš„æ˜¯ï¼š\nsendfile() ç³»ç»Ÿè°ƒç”¨ï¼šç›´æ¥åœ¨å†…æ ¸ç©ºé—´å®Œæˆæ–‡ä»¶åˆ°ç½‘ç»œå¥—æ¥å­—çš„æ•°æ®ä¼ è¾“ã€‚ æ”¯æŒ scatter-gather çš„ DMA ä¼ è¾“ï¼šå…è®¸ç¡¬ä»¶ç›´æ¥åœ¨ç£ç›˜å’Œç½‘ç»œæ¥å£ä¹‹é—´ä¼ è¾“æ•°æ®ï¼Œå®Œå…¨ç»•è¿‡ CPUã€‚ 6. ç¤ºä¾‹ï¼šä½¿ç”¨ mmap å®ç°é«˜æ•ˆæ–‡ä»¶å¤åˆ¶ ##include \u0026lt;fcntl.h\u0026gt; #include \u0026lt;unistd.h\u0026gt; #include \u0026lt;sys/mman.h\u0026gt; #include \u0026lt;sys/stat.h\u0026gt; #include \u0026lt;iostream\u0026gt; void copy_file(const char* src, const char* dst) { int src_fd = open(src, O_RDONLY); if (src_fd == -1) { std::cerr \u0026lt;\u0026lt; \u0026#34;Error opening source file\u0026#34; \u0026lt;\u0026lt; std::endl; return; } struct stat sb; if (fstat(src_fd, \u0026amp;sb) == -1) { std::cerr \u0026lt;\u0026lt; \u0026#34;Error getting file size\u0026#34; \u0026lt;\u0026lt; std::endl; close(src_fd); return; } void* src_addr = mmap(NULL, sb.st_size, PROT_READ, MAP_PRIVATE, src_fd, 0); if (src_addr == MAP_FAILED) { std::cerr \u0026lt;\u0026lt; \u0026#34;Error mapping source file\u0026#34; \u0026lt;\u0026lt; std::endl; close(src_fd); return; } int dst_fd = open(dst, O_RDWR | O_CREAT | O_TRUNC, 0644); if (dst_fd == -1) { std::cerr \u0026lt;\u0026lt; \u0026#34;Error creating destination file\u0026#34; \u0026lt;\u0026lt; std::endl; munmap(src_addr, sb.st_size); close(src_fd); return; } if (ftruncate(dst_fd, sb.st_size) == -1) { std::cerr \u0026lt;\u0026lt; \u0026#34;Error setting file size\u0026#34; \u0026lt;\u0026lt; std::endl; close(dst_fd); munmap(src_addr, sb.st_size); close(src_fd); return; } void* dst_addr = mmap(NULL, sb.st_size, PROT_WRITE, MAP_SHARED, dst_fd, 0); if (dst_addr == MAP_FAILED) { std::cerr \u0026lt;\u0026lt; \u0026#34;Error mapping destination file\u0026#34; \u0026lt;\u0026lt; std::endl; close(dst_fd); munmap(src_addr, sb.st_size); close(src_fd); return; } memcpy(dst_addr, src_addr, sb.st_size); munmap(dst_addr, sb.st_size); munmap(src_addr, sb.st_size); close(dst_fd); close(src_fd); } int main() { copy_file(\u0026#34;source.txt\u0026#34;, \u0026#34;destination.txt\u0026#34;); return 0; } è¿™ä¸ªä¾‹å­å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ mmap é«˜æ•ˆåœ°å¤åˆ¶æ–‡ä»¶ï¼Œé¿å…äº†ä¼ ç»Ÿ read/write æ–¹æ³•ä¸­çš„å¤šæ¬¡æ•°æ®æ‹·è´ã€‚\n7. ç»“è®º #è™½ç„¶ mmap ä¸æ˜¯ä¸¥æ ¼æ„ä¹‰ä¸Šçš„é›¶æ‹·è´æŠ€æœ¯ï¼Œä½†å®ƒç¡®å®èƒ½æ˜¾è‘—å‡å°‘æ•°æ®æ‹·è´æ¬¡æ•°ï¼Œæé«˜ I/O æ•ˆç‡ã€‚åœ¨å¤„ç†å¤§æ–‡ä»¶æˆ–éœ€è¦é¢‘ç¹éšæœºè®¿é—®çš„åœºæ™¯ä¸­ï¼Œmmap å¯ä»¥æˆä¸ºéå¸¸æœ‰æ•ˆçš„å·¥å…·ã€‚ç„¶è€Œï¼Œåœ¨ä½¿ç”¨ mmap æ—¶ï¼Œå¼€å‘è€…éœ€è¦æƒè¡¡å…¶ä¼˜åŠ¿å’Œæ½œåœ¨çš„å¤æ‚æ€§ï¼Œä»¥ç¡®ä¿åœ¨ç‰¹å®šåº”ç”¨åœºæ™¯ä¸­è·å¾—æœ€ä½³æ€§èƒ½ã€‚\n","date":"22 October 2024","permalink":"/blog/2025-06-24-zero_copy_optimization/","section":"Blog","summary":"1. æ¦‚è¿° #å†…å­˜æ˜ å°„ï¼ˆmmapï¼‰æ˜¯ä¸€ç§å°†æ–‡ä»¶æˆ–è®¾å¤‡æ˜ å°„åˆ°å†…å­˜çš„æ–¹æ³•ï¼Œè€Œé›¶æ‹·è´æ˜¯ä¸€ç§å‡å°‘æˆ–é¿å…æ•°æ®åœ¨å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´ä¹‹é—´ä¸å¿…è¦å¤åˆ¶çš„æŠ€æœ¯ã€‚è¿™ä¸¤ä¸ªæ¦‚å¿µå¯†åˆ‡ç›¸å…³ï¼Œä½†åˆæœ‰æ‰€ä¸åŒã€‚\n2. mmap æ˜¯é›¶æ‹·è´å—ï¼Ÿ #ç­”æ¡ˆæ˜¯ï¼šmmap æœ¬èº«ä¸æ˜¯é›¶æ‹·è´æŠ€æœ¯ï¼Œä½†å®ƒå¯ä»¥å®ç°é›¶æ‹·è´çš„æ•ˆæœã€‚\n2.1 mmap çš„å·¥ä½œåŸç† # å½“è°ƒç”¨ mmap æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šåœ¨è™šæ‹Ÿå†…å­˜ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„å†…å­˜åŒºåŸŸã€‚ è¿™ä¸ªå†…å­˜åŒºåŸŸä¼šæ˜ å°„åˆ°æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ï¼ˆpage cacheï¼‰ä¸­çš„ç‰©ç†é¡µé¢ã€‚ å½“ç¨‹åºè®¿é—®è¿™ä¸ªå†…å­˜åŒºåŸŸæ—¶ï¼Œå¦‚æœç›¸åº”çš„é¡µé¢ä¸åœ¨å†…å­˜ä¸­ï¼Œä¼šè§¦å‘ç¼ºé¡µä¸­æ–­ï¼Œæ“ä½œç³»ç»Ÿä¼šä»ç£ç›˜åŠ è½½æ•°æ®åˆ°å†…å­˜ã€‚ 2.2 ä¸ºä»€ä¹ˆ mmap å¯ä»¥å®ç°é›¶æ‹·è´ # ä¸€æ—¦æ˜ å°„å»ºç«‹ï¼Œç”¨æˆ·è¿›ç¨‹å¯ä»¥ç›´æ¥è¯»å†™è¿™ä¸ªå†…å­˜åŒºåŸŸï¼Œè€Œæ— éœ€åœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ä¹‹é—´è¿›è¡Œæ•°æ®å¤åˆ¶ã€‚ å¯¹äºè¯»æ“ä½œï¼Œæ•°æ®ä»ç£ç›˜è¯»å…¥ page cache åï¼Œå¯ä»¥ç›´æ¥è¢«ç”¨æˆ·è¿›ç¨‹è®¿é—®ï¼Œæ— éœ€é¢å¤–å¤åˆ¶ã€‚ å¯¹äºå†™æ“ä½œï¼Œä¿®æ”¹ç›´æ¥å‘ç”Ÿåœ¨ page cache ä¸Šï¼Œæ“ä½œç³»ç»Ÿä¼šåœ¨é€‚å½“çš„æ—¶å€™å°†ä¿®æ”¹åŒæ­¥åˆ°ç£ç›˜ã€‚ 3. mmap ä¸ä¼ ç»Ÿ I/O çš„æ¯”è¾ƒ #3.1 ä¼ ç»Ÿ read ç³»ç»Ÿè°ƒç”¨ #char buffer[4096]; ssize_t bytes_read = read(fd, buffer, sizeof(buffer)); è¿™ä¸ªè¿‡ç¨‹æ¶‰åŠä¸¤æ¬¡æ•°æ®æ‹·è´ï¼š\nä»ç£ç›˜åˆ°å†…æ ¸ç¼“å†²åŒº ä»å†…æ ¸ç¼“å†²åŒºåˆ°ç”¨æˆ·ç©ºé—´ç¼“å†²åŒº 3.2 ä½¿ç”¨ mmap #void* addr = mmap(NULL, file_size, PROT_READ, MAP_PRIVATE, fd, 0); // ç›´æ¥è®¿é—® addr æŒ‡å‘çš„å†…å­˜ mmap å‡å°‘äº†ä¸€æ¬¡æ•°æ®æ‹·è´ï¼Œæ•°æ®ç›´æ¥ä»ç£ç›˜åˆ°ç”¨æˆ·å¯è®¿é—®çš„å†…å­˜ã€‚","title":"å†…å­˜æ˜ å°„ï¼ˆmmapï¼‰ä¸é›¶æ‹·è´æŠ€æœ¯ï¼šæ·±å…¥ç†è§£å’Œå®è·µ"},{"content":"ç›®å½• # ç®€ä»‹ ä»“åº“ç»“æ„å’Œåˆ†æ”¯ç­–ç•¥ åä½œè€…æƒé™ç®¡ç† ä¿æŠ¤ä¸»åˆ†æ”¯ Pull Request å’Œä»£ç å®¡æŸ¥æµç¨‹ æŒç»­é›†æˆä¸éƒ¨ç½² (CI/CD) æ–‡æ¡£å’Œæ²Ÿé€š æœ€ä½³å®è·µå’Œæ³¨æ„äº‹é¡¹ ç®€ä»‹ #åœ¨æ²¡æœ‰é«˜çº§ GitHub åŠŸèƒ½çš„ç§æœ‰ä»“åº“ä¸­è¿›è¡ŒååŒå¼€å‘å¯èƒ½å…·æœ‰æŒ‘æˆ˜æ€§ï¼Œä½†é€šè¿‡æ­£ç¡®çš„å®è·µå’Œå·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥å»ºç«‹ä¸€ä¸ªé«˜æ•ˆã€å®‰å…¨çš„å¼€å‘ç¯å¢ƒã€‚æœ¬æŒ‡å—æ€»ç»“äº†æˆ‘ä»¬è®¨è®ºçš„ä¸»è¦ç­–ç•¥å’ŒæŠ€æœ¯ã€‚\nä»“åº“ç»“æ„å’Œåˆ†æ”¯ç­–ç•¥ # ä¸»åˆ†æ”¯ï¼šmainï¼ˆç¨³å®šã€å¯éƒ¨ç½²çš„ä»£ç ï¼‰ å¼€å‘åˆ†æ”¯ï¼šmain_for_devï¼ˆæ—¥å¸¸å¼€å‘å·¥ä½œï¼‰ ç‰¹æ€§åˆ†æ”¯ï¼šä» main_for_dev åˆ†å‡ºï¼Œç”¨äºå¼€å‘æ–°åŠŸèƒ½ å·¥ä½œæµç¨‹ï¼š\nä» main_for_dev åˆ›å»ºç‰¹æ€§åˆ†æ”¯ åœ¨ç‰¹æ€§åˆ†æ”¯ä¸Šå¼€å‘ å®Œæˆåï¼Œåˆ›å»º Pull Request åˆ° main_for_dev ä»£ç å®¡æŸ¥å’Œæµ‹è¯• åˆå¹¶åˆ° main_for_dev å®šæœŸå°† main_for_dev åˆå¹¶åˆ° main åä½œè€…æƒé™ç®¡ç† #GitHub ç§æœ‰ä»“åº“æä¾›ä»¥ä¸‹æƒé™çº§åˆ«ï¼š\nRead Triage Write Maintain Admin è®¾ç½®æ­¥éª¤ï¼š\nè¿›å…¥ä»“åº“ \u0026ldquo;Settings\u0026rdquo; \u0026gt; \u0026ldquo;Collaborators and teams\u0026rdquo; ç‚¹å‡» \u0026ldquo;Add people\u0026rdquo; æˆ– \u0026ldquo;Add teams\u0026rdquo; è¾“å…¥ç”¨æˆ·åå¹¶é€‰æ‹©é€‚å½“çš„æƒé™çº§åˆ« æœ€ä½³å®è·µï¼š\néµå¾ªæœ€å°æƒé™åŸåˆ™ å®šæœŸå®¡æŸ¥å’Œæ›´æ–°æƒé™ ä¿æŠ¤ä¸»åˆ†æ”¯ #ç”±äºç¼ºä¹é«˜çº§åˆ†æ”¯ä¿æŠ¤åŠŸèƒ½ï¼Œæˆ‘ä»¬é‡‡ç”¨ä»¥ä¸‹ç­–ç•¥ï¼š\nå›¢é˜Ÿçº¦å®šï¼š\nç¦æ­¢ç›´æ¥æ¨é€åˆ° main åˆ†æ”¯ æ‰€æœ‰æ›´æ”¹é€šè¿‡ PR è¿›è¡Œ Git Hooksï¼š åˆ›å»º pre-push hookï¼ˆ.git/hooks/pre-pushï¼‰ï¼š\n#!/bin/sh branch=$(git rev-parse --abbrev-ref HEAD) if [ \u0026#34;$branch\u0026#34; = \u0026#34;main\u0026#34; ]; then echo \u0026#34;Direct push to main branch is not allowed. Please create a Pull Request.\u0026#34; exit 1 fi è®¾ç½®æƒé™ï¼šchmod +x .git/hooks/pre-push\nGitHub Actionsï¼š åˆ›å»º .github/workflows/protect-main.ymlï¼š\nname: Protect Main Branch on: push: branches: - main jobs: check_push: runs-on: ubuntu-latest steps: - uses: actions/checkout@v2 - name: Check if push was direct run: | if [[ $(git log --format=%B -n 1 ${{ github.sha }}) != *\u0026#34;Merge pull request\u0026#34;* ]]; then echo \u0026#34;::error::Direct push to main branch detected. Please use Pull Requests.\u0026#34; exit 1 fi Pull Request å’Œä»£ç å®¡æŸ¥æµç¨‹ # åˆ›å»º PR æ¨¡æ¿ï¼š åœ¨ .github/pull_request_template.md ä¸­å®šä¹‰æ¨¡æ¿ã€‚\nå®¡æŸ¥æµç¨‹ï¼š\nè‡³å°‘ä¸€åå®¡æŸ¥è€…æ‰¹å‡† é€šè¿‡æ‰€æœ‰è‡ªåŠ¨åŒ–æµ‹è¯• éµå¾ªå›¢é˜Ÿå®šä¹‰çš„ä»£ç è§„èŒƒ åˆå¹¶ç­–ç•¥ï¼š ä½¿ç”¨ \u0026ldquo;Squash and merge\u0026rdquo; æˆ– \u0026ldquo;Rebase and merge\u0026rdquo; ä¿æŒæ¸…æ™°çš„æäº¤å†å²ã€‚\næŒç»­é›†æˆä¸éƒ¨ç½² (CI/CD) #ä½¿ç”¨ GitHub Actions è¿›è¡Œ CI/CDï¼š\nåœ¨ PR ä¸­è¿è¡Œæµ‹è¯•å’Œä»£ç è´¨é‡æ£€æŸ¥ åªä» main åˆ†æ”¯è¿›è¡Œéƒ¨ç½² è‡ªåŠ¨åŒ–ç‰ˆæœ¬æ ‡è®°å’Œå‘å¸ƒæµç¨‹ æ–‡æ¡£å’Œæ²Ÿé€š # README.mdï¼šé¡¹ç›®æ¦‚è¿°å’Œå¿«é€Ÿå¼€å§‹æŒ‡å— CONTRIBUTING.mdï¼šè¯¦ç»†çš„è´¡çŒ®æŒ‡å— ä»£ç æ³¨é‡Šï¼šä¿æŒä»£ç è‡ªæ–‡æ¡£åŒ– å®šæœŸå›¢é˜Ÿä¼šè®®ï¼šè®¨è®ºé¡¹ç›®è¿›å±•å’Œé—®é¢˜ æœ€ä½³å®è·µå’Œæ³¨æ„äº‹é¡¹ # å®šæœŸåŸ¹è®­å›¢é˜Ÿæˆå‘˜ï¼Œç¡®ä¿everyoneéµå¾ªåä½œæµç¨‹ ä½¿ç”¨ GitHub Issues è¿›è¡Œä»»åŠ¡è·Ÿè¸ªå’Œ bug æŠ¥å‘Š è€ƒè™‘ä½¿ç”¨é¡¹ç›®çœ‹æ¿ï¼ˆProject Boardsï¼‰è¿›è¡Œä»»åŠ¡ç®¡ç† å®šæœŸå®¡æŸ¥å’Œæ›´æ–°å·¥ä½œæµç¨‹ï¼Œé€‚åº”å›¢é˜Ÿéœ€æ±‚ é¼“åŠ±çŸ¥è¯†å…±äº«å’Œå¯¹ç­‰ç¼–ç¨‹ é‡è§†ä»£ç è´¨é‡ï¼ŒåŒ…æ‹¬å•å…ƒæµ‹è¯•å’Œæ–‡æ¡£ è€ƒè™‘å®æ–½æŒç»­åé¦ˆæœºåˆ¶ï¼Œä¸æ–­æ”¹è¿›åä½œæµç¨‹ é€šè¿‡å®æ–½è¿™äº›ç­–ç•¥å’Œæœ€ä½³å®è·µï¼Œå³ä½¿åœ¨ç§æœ‰ä»“åº“çš„é™åˆ¶ä¸‹ï¼Œä¹Ÿèƒ½å»ºç«‹ä¸€ä¸ªé«˜æ•ˆã€å®‰å…¨çš„åä½œç¯å¢ƒã€‚è®°ä½ï¼ŒæˆåŠŸçš„åä½œä¸ä»…ä¾èµ–äºå·¥å…·å’Œæµç¨‹ï¼Œæ›´ä¾èµ–äºå›¢é˜Ÿçš„æ²Ÿé€šå’Œç›¸äº’ä¿¡ä»»ã€‚\n","date":"16 October 2024","permalink":"/blog/2025-06-24-project_management_best_practices/","section":"Blog","summary":"ç›®å½• # ç®€ä»‹ ä»“åº“ç»“æ„å’Œåˆ†æ”¯ç­–ç•¥ åä½œè€…æƒé™ç®¡ç† ä¿æŠ¤ä¸»åˆ†æ”¯ Pull Request å’Œä»£ç å®¡æŸ¥æµç¨‹ æŒç»­é›†æˆä¸éƒ¨ç½² (CI/CD) æ–‡æ¡£å’Œæ²Ÿé€š æœ€ä½³å®è·µå’Œæ³¨æ„äº‹é¡¹ ç®€ä»‹ #åœ¨æ²¡æœ‰é«˜çº§ GitHub åŠŸèƒ½çš„ç§æœ‰ä»“åº“ä¸­è¿›è¡ŒååŒå¼€å‘å¯èƒ½å…·æœ‰æŒ‘æˆ˜æ€§ï¼Œä½†é€šè¿‡æ­£ç¡®çš„å®è·µå’Œå·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥å»ºç«‹ä¸€ä¸ªé«˜æ•ˆã€å®‰å…¨çš„å¼€å‘ç¯å¢ƒã€‚æœ¬æŒ‡å—æ€»ç»“äº†æˆ‘ä»¬è®¨è®ºçš„ä¸»è¦ç­–ç•¥å’ŒæŠ€æœ¯ã€‚\nä»“åº“ç»“æ„å’Œåˆ†æ”¯ç­–ç•¥ # ä¸»åˆ†æ”¯ï¼šmainï¼ˆç¨³å®šã€å¯éƒ¨ç½²çš„ä»£ç ï¼‰ å¼€å‘åˆ†æ”¯ï¼šmain_for_devï¼ˆæ—¥å¸¸å¼€å‘å·¥ä½œï¼‰ ç‰¹æ€§åˆ†æ”¯ï¼šä» main_for_dev åˆ†å‡ºï¼Œç”¨äºå¼€å‘æ–°åŠŸèƒ½ å·¥ä½œæµç¨‹ï¼š\nä» main_for_dev åˆ›å»ºç‰¹æ€§åˆ†æ”¯ åœ¨ç‰¹æ€§åˆ†æ”¯ä¸Šå¼€å‘ å®Œæˆåï¼Œåˆ›å»º Pull Request åˆ° main_for_dev ä»£ç å®¡æŸ¥å’Œæµ‹è¯• åˆå¹¶åˆ° main_for_dev å®šæœŸå°† main_for_dev åˆå¹¶åˆ° main åä½œè€…æƒé™ç®¡ç† #GitHub ç§æœ‰ä»“åº“æä¾›ä»¥ä¸‹æƒé™çº§åˆ«ï¼š\nRead Triage Write Maintain Admin è®¾ç½®æ­¥éª¤ï¼š\nè¿›å…¥ä»“åº“ \u0026ldquo;Settings\u0026rdquo; \u0026gt; \u0026ldquo;Collaborators and teams\u0026rdquo; ç‚¹å‡» \u0026ldquo;Add people\u0026rdquo; æˆ– \u0026ldquo;Add teams\u0026rdquo; è¾“å…¥ç”¨æˆ·åå¹¶é€‰æ‹©é€‚å½“çš„æƒé™çº§åˆ« æœ€ä½³å®è·µï¼š\néµå¾ªæœ€å°æƒé™åŸåˆ™ å®šæœŸå®¡æŸ¥å’Œæ›´æ–°æƒé™ ä¿æŠ¤ä¸»åˆ†æ”¯ #ç”±äºç¼ºä¹é«˜çº§åˆ†æ”¯ä¿æŠ¤åŠŸèƒ½ï¼Œæˆ‘ä»¬é‡‡ç”¨ä»¥ä¸‹ç­–ç•¥ï¼š\nå›¢é˜Ÿçº¦å®šï¼š\nç¦æ­¢ç›´æ¥æ¨é€åˆ° main åˆ†æ”¯ æ‰€æœ‰æ›´æ”¹é€šè¿‡ PR è¿›è¡Œ Git Hooksï¼š åˆ›å»º pre-push hookï¼ˆ.","title":"GitHubç§æœ‰ä»“åº“ååŒå¼€å‘æŒ‡å—"},{"content":"","date":null,"permalink":"/tags/project-management/","section":"Tags","summary":"","title":"project management"},{"content":"1. å¼•è¨€ #Forkæ˜¯Unix/Linuxç³»ç»Ÿä¸­æœ€åŸºæœ¬ä¹Ÿæ˜¯æœ€å¼ºå¤§çš„ç³»ç»Ÿè°ƒç”¨ä¹‹ä¸€ã€‚å®ƒå…è®¸ä¸€ä¸ªè¿›ç¨‹åˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹,è¿™ä¸ªæ–°è¿›ç¨‹æ˜¯åŸè¿›ç¨‹çš„ä¸€ä¸ªå‡ ä¹å®Œå…¨ç›¸åŒçš„å‰¯æœ¬ã€‚æœ¬æ¬¡æŠ€æœ¯åˆ†äº«å°†æ·±å…¥æ¢è®¨forkæœºåˆ¶,ä»åŸºæœ¬æ¦‚å¿µåˆ°é«˜çº§åº”ç”¨ã€‚\n2. Forkçš„åŸºæœ¬åŸç† #2.1 ä»€ä¹ˆæ˜¯Fork #Forkæ˜¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨,ç”¨äºåˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹ã€‚æ–°è¿›ç¨‹ï¼ˆç§°ä¸ºå­è¿›ç¨‹ï¼‰æ˜¯è°ƒç”¨è¿›ç¨‹ï¼ˆç§°ä¸ºçˆ¶è¿›ç¨‹ï¼‰çš„ä¸€ä¸ªå‡ ä¹å®Œå…¨ç›¸åŒçš„å‰¯æœ¬ã€‚\n2.2 Forkçš„å·¥ä½œåŸç† #å½“ä¸€ä¸ªè¿›ç¨‹è°ƒç”¨forkæ—¶:\nç³»ç»Ÿä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹ã€‚ æ–°è¿›ç¨‹æ˜¯çˆ¶è¿›ç¨‹çš„ä¸€ä¸ªå‰¯æœ¬,åŒ…æ‹¬ä»£ç æ®µã€æ•°æ®æ®µã€å †æ ˆç­‰ã€‚ å­è¿›ç¨‹è·å¾—çˆ¶è¿›ç¨‹æ•°æ®ç©ºé—´ã€å †å’Œæ ˆçš„å‰¯æœ¬ã€‚ çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ç»§ç»­æ‰§è¡Œforkè°ƒç”¨ä¹‹åçš„ä»£ç ã€‚ 2.3 Forkçš„è¿”å›å€¼ #Forkè°ƒç”¨ä¼šè¿”å›ä¸¤æ¬¡:\nåœ¨çˆ¶è¿›ç¨‹ä¸­,è¿”å›å­è¿›ç¨‹çš„PIDã€‚ åœ¨å­è¿›ç¨‹ä¸­,è¿”å›0ã€‚ è¿™å…è®¸ç¨‹åºåŒºåˆ†çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ã€‚\npid_t pid = fork(); if (pid \u0026gt; 0) { printf(\u0026#34;çˆ¶è¿›ç¨‹\\n\u0026#34;); } else if (pid == 0) { printf(\u0026#34;å­è¿›ç¨‹\\n\u0026#34;); } else { perror(\u0026#34;forkå¤±è´¥\u0026#34;); exit(1); } 3. Forkçš„é«˜çº§ç‰¹æ€§ #3.1 å†™æ—¶å¤åˆ¶ (Copy-on-Write) #ä¸ºäº†æé«˜æ•ˆç‡,ç°ä»£æ“ä½œç³»ç»Ÿä½¿ç”¨\u0026quot;å†™æ—¶å¤åˆ¶\u0026quot;æŠ€æœ¯:\nåˆå§‹æ—¶,å­è¿›ç¨‹ä¸çˆ¶è¿›ç¨‹å…±äº«åŒä¸€ç‰©ç†å†…å­˜ã€‚ åªæœ‰å½“å…¶ä¸­ä¸€ä¸ªè¿›ç¨‹å°è¯•ä¿®æ”¹å†…å­˜æ—¶,æ‰ä¼šåˆ›å»ºè¯¥éƒ¨åˆ†å†…å­˜çš„å‰¯æœ¬ã€‚ è¿™å¤§å¤§å‡å°‘äº†forkçš„å¼€é”€å’Œå†…å­˜ä½¿ç”¨ã€‚\n3.2 æ–‡ä»¶æè¿°ç¬¦çš„ç»§æ‰¿ #å­è¿›ç¨‹ç»§æ‰¿çˆ¶è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦ã€‚è¿™æ„å‘³ç€:\nå­è¿›ç¨‹å¯ä»¥è®¿é—®çˆ¶è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶ã€‚ çˆ¶å­è¿›ç¨‹å…±äº«æ–‡ä»¶åç§»é‡ã€‚ int fd = open(\u0026#34;example.txt\u0026#34;, O_RDWR); if (fork() == 0) { // å­è¿›ç¨‹ write(fd, \u0026#34;Hello from child\u0026#34;, 16); } else { // çˆ¶è¿›ç¨‹ write(fd, \u0026#34;Hello from parent\u0026#34;, 17); } 3.3 å†…å­˜ç‹¬ç«‹æ€§ #è™½ç„¶å­è¿›ç¨‹åˆå§‹æ—¶ä¸çˆ¶è¿›ç¨‹å…±äº«å†…å­˜,ä½†å®ƒä»¬çš„å†…å­˜ç©ºé—´æ˜¯ç‹¬ç«‹çš„:\nä¸€ä¸ªè¿›ç¨‹å¯¹å˜é‡çš„ä¿®æ”¹ä¸ä¼šå½±å“å¦ä¸€ä¸ªè¿›ç¨‹ã€‚ è¿™é€‚ç”¨äºå…¨å±€å˜é‡ã€å †ã€æ ˆç­‰æ‰€æœ‰å†…å­˜åŒºåŸŸã€‚ 4. Forkçš„é«˜çº§åº”ç”¨ #4.1 å¤šè¿›ç¨‹å¹¶è¡Œå¤„ç† #Forkå¸¸ç”¨äºåˆ›å»ºå¤šä¸ªå¹¶è¡Œå·¥ä½œçš„è¿›ç¨‹,ä¾‹å¦‚åœ¨æœåŠ¡å™¨ç¨‹åºä¸­:\nfor (int i = 0; i \u0026lt; NUM_WORKERS; i++) { if (fork() == 0) { worker_process(); exit(0); } } 4.2 å®ç°ç®¡é“ #Forkç»“åˆç®¡é“å¯ä»¥ç”¨äºè¿›ç¨‹é—´é€šä¿¡:\nint pipefd[2]; pipe(pipefd); if (fork() == 0) { close(pipefd[1]); // å…³é—­å†™ç«¯ char buf[100]; read(pipefd[0], buf, 100); printf(\u0026#34;å­è¿›ç¨‹è¯»å–: %s\\n\u0026#34;, buf); } else { close(pipefd[0]); // å…³é—­è¯»ç«¯ write(pipefd[1], \u0026#34;Hello from parent\u0026#34;, 17); } 4.3 å®ç°Shellå‘½ä»¤ #Shellä½¿ç”¨forkå’Œexecæ¥æ‰§è¡Œå‘½ä»¤:\nif (fork() == 0) { execl(\u0026#34;/bin/ls\u0026#34;, \u0026#34;ls\u0026#34;, \u0026#34;-l\u0026#34;, NULL); exit(1); // å¦‚æœexecå¤±è´¥ } 5. Forkçš„æ€§èƒ½è€ƒè™‘ #5.1 èµ„æºæ¶ˆè€— #æ¯æ¬¡forkéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹,è¿™æ¶‰åŠ:\nå†…å­˜åˆ†é… å¤åˆ¶è¿›ç¨‹ä¿¡æ¯ æ›´æ–°ç³»ç»Ÿè¡¨ åœ¨èµ„æºå—é™çš„ç¯å¢ƒä¸­,è¿‡åº¦ä½¿ç”¨forkå¯èƒ½å¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚\n5.2 ä¸Šä¸‹æ–‡åˆ‡æ¢ #å¤šä¸ªè¿›ç¨‹æ„å‘³ç€æ›´å¤šçš„ä¸Šä¸‹æ–‡åˆ‡æ¢,å¯èƒ½å½±å“æ€§èƒ½ã€‚åœ¨æŸäº›æƒ…å†µä¸‹,ä½¿ç”¨çº¿ç¨‹å¯èƒ½æ›´ä¸ºé«˜æ•ˆã€‚\n6. Forkçš„é«˜çº§æŠ€å·§å’Œæ³¨æ„äº‹é¡¹ #6.1 ä¿¡å·å¤„ç† #Forkå,å­è¿›ç¨‹ç»§æ‰¿çˆ¶è¿›ç¨‹çš„ä¿¡å·å¤„ç†ç¨‹åºã€‚ä½†åœ¨å¤šçº¿ç¨‹ç¨‹åºä¸­forkéœ€è¦ç‰¹åˆ«å°å¿ƒ,å› ä¸ºå­è¿›ç¨‹åªåŒ…å«è°ƒç”¨forkçš„çº¿ç¨‹ã€‚\n6.2 æ¸…ç†èµ„æº #åœ¨ä½¿ç”¨forkæ—¶,è¦æ³¨æ„é€‚å½“åœ°å…³é—­ä¸éœ€è¦çš„æ–‡ä»¶æè¿°ç¬¦å’Œé‡Šæ”¾èµ„æº,ä»¥é˜²æ­¢èµ„æºæ³„æ¼ã€‚\n6.3 ç«æ€æ¡ä»¶ #éœ€è¦æ³¨æ„çˆ¶å­è¿›ç¨‹ä¹‹é—´å¯èƒ½çš„ç«æ€æ¡ä»¶,ç‰¹åˆ«æ˜¯åœ¨è®¿é—®å…±äº«èµ„æºæ—¶ã€‚\n7. å®ä¾‹åˆ†æï¼šå¤šé‡Fork #è®©æˆ‘ä»¬å›åˆ°æœ€åˆçš„ä¾‹å­:\nvoid test(){ fork() \u0026amp;\u0026amp; fork() \u0026amp;\u0026amp; fork() \u0026amp;\u0026amp; sleep(10); printf(\u0026#34;hello\\n\u0026#34;); exit(0); } è¿™ä¸ªä¾‹å­å±•ç¤ºäº†forkçš„å‡ ä¸ªå…³é”®ç‰¹æ€§:\nçŸ­è·¯è¯„ä¼°: åˆ©ç”¨\u0026amp;\u0026amp;æ“ä½œç¬¦çš„çŸ­è·¯ç‰¹æ€§æ§åˆ¶forkçš„æ‰§è¡Œã€‚ è¿›ç¨‹åˆ›å»º: æ¯ä¸ªæˆåŠŸçš„forkéƒ½åˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹ã€‚ å¹¶å‘æ‰§è¡Œ: å¤šä¸ªè¿›ç¨‹å¹¶å‘è¿è¡Œ,å¯¼è‡´å¤šä¸ª\u0026quot;hello\u0026quot;è¾“å‡ºã€‚ 7.1 Forkè°ƒç”¨åˆ†æ #ä»£ç è§£æ #è¿™æ®µä»£ç çš„å…³é”®åœ¨äº fork() \u0026amp;\u0026amp; fork() \u0026amp;\u0026amp; fork() \u0026amp;\u0026amp; sleep(10) è¿™ä¸€è¡Œã€‚\nfork() çš„è¡Œä¸º # fork() åˆ›å»ºä¸€ä¸ªæ–°çš„å­è¿›ç¨‹ã€‚ åœ¨çˆ¶è¿›ç¨‹ä¸­ï¼Œfork() è¿”å›å­è¿›ç¨‹çš„ PIDï¼ˆéé›¶å€¼ï¼‰ã€‚ åœ¨å­è¿›ç¨‹ä¸­ï¼Œfork() è¿”å› 0ã€‚ é€»è¾‘çŸ­è·¯ #ç”±äºä½¿ç”¨äº† \u0026amp;\u0026amp;ï¼ˆé€»è¾‘ä¸ï¼‰æ“ä½œç¬¦ï¼Œè¿™é‡Œæ¶‰åŠåˆ°çŸ­è·¯è¯„ä¼°ï¼š\nåªæœ‰å½“å‰é¢çš„ fork() è¿”å›éé›¶å€¼ï¼ˆåœ¨çˆ¶è¿›ç¨‹ä¸­ï¼‰æ—¶ï¼Œåç»­çš„ fork() æ‰ä¼šæ‰§è¡Œã€‚ å¦‚æœä»»ä½• fork() è¿”å› 0ï¼ˆåœ¨å­è¿›ç¨‹ä¸­ï¼‰ï¼Œåç»­çš„ fork() å’Œ sleep(10) éƒ½ä¸ä¼šæ‰§è¡Œã€‚ æ‰§è¡Œæµç¨‹ # ç¬¬ä¸€ä¸ª fork()ï¼š\nåˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ çˆ¶è¿›ç¨‹ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ª fork() å­è¿›ç¨‹è·³è¿‡åç»­ fork() å’Œ sleep()ï¼Œç›´æ¥æ‰“å° \u0026ldquo;hello\u0026rdquo; ç¬¬äºŒä¸ª fork()ï¼ˆåªåœ¨çˆ¶è¿›ç¨‹ä¸­æ‰§è¡Œï¼‰ï¼š\nå†åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ æ–°çš„çˆ¶è¿›ç¨‹ç»§ç»­æ‰§è¡Œç¬¬ä¸‰ä¸ª fork() æ–°çš„å­è¿›ç¨‹è·³è¿‡åç»­ fork() å’Œ sleep()ï¼Œæ‰“å° \u0026ldquo;hello\u0026rdquo; ç¬¬ä¸‰ä¸ª fork()ï¼ˆåªåœ¨æœ€åˆçš„çˆ¶è¿›ç¨‹ä¸­æ‰§è¡Œï¼‰ï¼š\nå†åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ æœ€åˆçš„çˆ¶è¿›ç¨‹æ‰§è¡Œ sleep(10) æ–°çš„å­è¿›ç¨‹è·³è¿‡ sleep()ï¼Œæ‰“å° \u0026ldquo;hello\u0026rdquo; 10ç§’åï¼Œæœ€åˆçš„çˆ¶è¿›ç¨‹ä¹Ÿä¼šæ‰“å° \u0026ldquo;hello\u0026rdquo;\nè¿›ç¨‹æ ‘ #åŸå§‹è¿›ç¨‹ â”€â”€â”€ å­è¿›ç¨‹1 (æ‰“å°\u0026#34;hello\u0026#34;) â”‚ â”œâ”€â”€â”€ å­è¿›ç¨‹2 (æ‰“å°\u0026#34;hello\u0026#34;) â”‚ â””â”€â”€â”€ å­è¿›ç¨‹3 (æ‰“å°\u0026#34;hello\u0026#34;) â”‚ â””â”€â”€â”€ çˆ¶è¿›ç¨‹ (ç­‰å¾…10ç§’åæ‰“å°\u0026#34;hello\u0026#34;) ç»“æœ #è¿™æ®µä»£ç ä¼šè¾“å‡º 4 ä¸ª \u0026ldquo;hello\u0026rdquo;ã€‚\n3 ä¸ªæ¥è‡ªç«‹å³æ‰§è¡Œçš„å­è¿›ç¨‹ 1 ä¸ªæ¥è‡ªç­‰å¾… 10 ç§’åçš„çˆ¶è¿›ç¨‹ 8. ç»“è®º #Forkæ˜¯ä¸€ä¸ªå¼ºå¤§è€Œå¤æ‚çš„ç³»ç»Ÿè°ƒç”¨,å®ƒä¸ºUnix/Linuxç³»ç»Ÿæä¾›äº†åˆ›å»ºæ–°è¿›ç¨‹çš„åŸºæœ¬æœºåˆ¶ã€‚ç†è§£å’Œæ­£ç¡®ä½¿ç”¨forkå¯ä»¥å¸®åŠ©å¼€å‘è€…åˆ›å»ºé«˜æ•ˆã€å¯é çš„å¤šè¿›ç¨‹åº”ç”¨ã€‚ç„¶è€Œ,forkä¹Ÿå¸¦æ¥äº†ä¸€äº›æŒ‘æˆ˜,å¦‚èµ„æºç®¡ç†å’ŒåŒæ­¥é—®é¢˜ã€‚åœ¨å®é™…åº”ç”¨ä¸­,éœ€è¦æ ¹æ®å…·ä½“éœ€æ±‚æƒè¡¡ä½¿ç”¨forkã€çº¿ç¨‹æˆ–å…¶ä»–å¹¶å‘æœºåˆ¶ã€‚\n","date":"15 October 2024","permalink":"/blog/2025-06-24-fork_system_call_analysis/","section":"Blog","summary":"1. å¼•è¨€ #Forkæ˜¯Unix/Linuxç³»ç»Ÿä¸­æœ€åŸºæœ¬ä¹Ÿæ˜¯æœ€å¼ºå¤§çš„ç³»ç»Ÿè°ƒç”¨ä¹‹ä¸€ã€‚å®ƒå…è®¸ä¸€ä¸ªè¿›ç¨‹åˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹,è¿™ä¸ªæ–°è¿›ç¨‹æ˜¯åŸè¿›ç¨‹çš„ä¸€ä¸ªå‡ ä¹å®Œå…¨ç›¸åŒçš„å‰¯æœ¬ã€‚æœ¬æ¬¡æŠ€æœ¯åˆ†äº«å°†æ·±å…¥æ¢è®¨forkæœºåˆ¶,ä»åŸºæœ¬æ¦‚å¿µåˆ°é«˜çº§åº”ç”¨ã€‚\n2. Forkçš„åŸºæœ¬åŸç† #2.1 ä»€ä¹ˆæ˜¯Fork #Forkæ˜¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨,ç”¨äºåˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹ã€‚æ–°è¿›ç¨‹ï¼ˆç§°ä¸ºå­è¿›ç¨‹ï¼‰æ˜¯è°ƒç”¨è¿›ç¨‹ï¼ˆç§°ä¸ºçˆ¶è¿›ç¨‹ï¼‰çš„ä¸€ä¸ªå‡ ä¹å®Œå…¨ç›¸åŒçš„å‰¯æœ¬ã€‚\n2.2 Forkçš„å·¥ä½œåŸç† #å½“ä¸€ä¸ªè¿›ç¨‹è°ƒç”¨forkæ—¶:\nç³»ç»Ÿä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹ã€‚ æ–°è¿›ç¨‹æ˜¯çˆ¶è¿›ç¨‹çš„ä¸€ä¸ªå‰¯æœ¬,åŒ…æ‹¬ä»£ç æ®µã€æ•°æ®æ®µã€å †æ ˆç­‰ã€‚ å­è¿›ç¨‹è·å¾—çˆ¶è¿›ç¨‹æ•°æ®ç©ºé—´ã€å †å’Œæ ˆçš„å‰¯æœ¬ã€‚ çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ç»§ç»­æ‰§è¡Œforkè°ƒç”¨ä¹‹åçš„ä»£ç ã€‚ 2.3 Forkçš„è¿”å›å€¼ #Forkè°ƒç”¨ä¼šè¿”å›ä¸¤æ¬¡:\nåœ¨çˆ¶è¿›ç¨‹ä¸­,è¿”å›å­è¿›ç¨‹çš„PIDã€‚ åœ¨å­è¿›ç¨‹ä¸­,è¿”å›0ã€‚ è¿™å…è®¸ç¨‹åºåŒºåˆ†çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ã€‚\npid_t pid = fork(); if (pid \u0026gt; 0) { printf(\u0026#34;çˆ¶è¿›ç¨‹\\n\u0026#34;); } else if (pid == 0) { printf(\u0026#34;å­è¿›ç¨‹\\n\u0026#34;); } else { perror(\u0026#34;forkå¤±è´¥\u0026#34;); exit(1); } 3. Forkçš„é«˜çº§ç‰¹æ€§ #3.1 å†™æ—¶å¤åˆ¶ (Copy-on-Write) #ä¸ºäº†æé«˜æ•ˆç‡,ç°ä»£æ“ä½œç³»ç»Ÿä½¿ç”¨\u0026quot;å†™æ—¶å¤åˆ¶\u0026quot;æŠ€æœ¯:\nåˆå§‹æ—¶,å­è¿›ç¨‹ä¸çˆ¶è¿›ç¨‹å…±äº«åŒä¸€ç‰©ç†å†…å­˜ã€‚ åªæœ‰å½“å…¶ä¸­ä¸€ä¸ªè¿›ç¨‹å°è¯•ä¿®æ”¹å†…å­˜æ—¶,æ‰ä¼šåˆ›å»ºè¯¥éƒ¨åˆ†å†…å­˜çš„å‰¯æœ¬ã€‚ è¿™å¤§å¤§å‡å°‘äº†forkçš„å¼€é”€å’Œå†…å­˜ä½¿ç”¨ã€‚\n3.2 æ–‡ä»¶æè¿°ç¬¦çš„ç»§æ‰¿ #å­è¿›ç¨‹ç»§æ‰¿çˆ¶è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦ã€‚è¿™æ„å‘³ç€:\nå­è¿›ç¨‹å¯ä»¥è®¿é—®çˆ¶è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶ã€‚ çˆ¶å­è¿›ç¨‹å…±äº«æ–‡ä»¶åç§»é‡ã€‚ int fd = open(\u0026#34;example.txt\u0026#34;, O_RDWR); if (fork() == 0) { // å­è¿›ç¨‹ write(fd, \u0026#34;Hello from child\u0026#34;, 16); } else { // çˆ¶è¿›ç¨‹ write(fd, \u0026#34;Hello from parent\u0026#34;, 17); } 3.","title":"Forkæœºåˆ¶è¯¦è§£ï¼šä»åŸºç¡€åˆ°é«˜çº§åº”ç”¨"},{"content":"","date":null,"permalink":"/tags/system-programming/","section":"Tags","summary":"","title":"System Programming"},{"content":"","date":null,"permalink":"/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/","section":"Tags","summary":"","title":"æ€§èƒ½ä¼˜åŒ–"},{"content":"1. åŸºç¡€æ¦‚å¿µ #1.1 äºŒè¿›åˆ¶è¡¨ç¤º # è®¡ç®—æœºä½¿ç”¨äºŒè¿›åˆ¶ï¼ˆ0å’Œ1ï¼‰å­˜å‚¨å’Œå¤„ç†æ•°æ® 1 byte = 8 bits 32ä½æ•´æ•°å¯ä»¥è¡¨ç¤ºä» 0 åˆ° 2^32 - 1 çš„æ•°å€¼ 1.2 ä½æ“ä½œåŸºç¡€ # ä¸æ“ä½œ (\u0026amp;): ä¸¤ä½éƒ½ä¸º1æ—¶ç»“æœä¸º1ï¼Œå¦åˆ™ä¸º0 æˆ–æ“ä½œ (|): è‡³å°‘ä¸€ä½ä¸º1æ—¶ç»“æœä¸º1ï¼Œå¦åˆ™ä¸º0 å¼‚æˆ–æ“ä½œ (^): ä¸¤ä½ä¸åŒæ—¶ç»“æœä¸º1ï¼Œç›¸åŒæ—¶ä¸º0 éæ“ä½œ (~): å°†æ¯ä¸€ä½å–å å·¦ç§» (\u0026laquo;): å°†æ‰€æœ‰ä½å‘å·¦ç§»åŠ¨ï¼Œå³ä¾§è¡¥0 å³ç§» (\u0026raquo;): å°†æ‰€æœ‰ä½å‘å³ç§»åŠ¨ï¼Œå·¦ä¾§è¡¥0æˆ–ç¬¦å·ä½ ç¤ºä¾‹ï¼š\nunsigned int a = 5; // 0101 unsigned int b = 3; // 0011 unsigned int and_result = a \u0026amp; b; // 0001 (1) unsigned int or_result = a | b; // 0111 (7) unsigned int xor_result = a ^ b; // 0110 (6) unsigned int not_result = ~a; // 11111111111111111111111111111010 (-6 in 2\u0026#39;s complement) unsigned int left_shift = a \u0026lt;\u0026lt; 1; // 1010 (10) unsigned int right_shift = a \u0026gt;\u0026gt; 1;// 0010 (2) 2. æ©ç ï¼ˆMaskï¼‰ #2.1 æ©ç å®šä¹‰ #æ©ç æ˜¯ç”¨äºé€‰æ‹©æˆ–ä¿®æ”¹ç‰¹å®šä½çš„äºŒè¿›åˆ¶æ¨¡å¼\n2.2 å¸¸è§æ©ç æ“ä½œ # æå–ä½ï¼švalue \u0026amp; mask è®¾ç½®ä½ï¼švalue | mask æ¸…é™¤ä½ï¼švalue \u0026amp; ~mask åˆ‡æ¢ä½ï¼švalue ^ mask ç¤ºä¾‹ï¼š\nunsigned int value = 0xA5; // 10100101 unsigned int mask = 0x0F; // 00001111 unsigned int extract = value \u0026amp; mask; // 00000101 (5) unsigned int set = value | mask; // 10101111 (175) unsigned int clear = value \u0026amp; ~mask; // 10100000 (160) unsigned int toggle = value ^ mask; // 10101010 (170) 3. ä½åŸŸï¼ˆBit Fieldsï¼‰ #3.1 æ¦‚å¿µ #å°†è¾ƒå¤§çš„æ•°æ®ç±»å‹åˆ†å‰²æˆå¤šä¸ªå°çš„å­—æ®µï¼Œæ¯ä¸ªå­—æ®µå ç”¨ç‰¹å®šæ•°é‡çš„ä½\n3.2 ä¼˜åŠ¿ # å†…å­˜æ•ˆç‡ï¼šåœ¨ä¸€ä¸ªæ•´æ•°ä¸­å­˜å‚¨å¤šä¸ªå€¼ æ€§èƒ½ï¼šä½æ“ä½œé€šå¸¸æ¯”å…¶ä»–æ“ä½œæ›´å¿« åŸå­æ€§ï¼šå¯ä»¥åœ¨ä¸€ä¸ªæ“ä½œä¸­è¯»å–æˆ–ä¿®æ”¹å¤šä¸ªå­—æ®µ 3.3 ä½åŸŸå¸ƒå±€ç¤ºä¾‹ #32-bit integer layout: [Instrument (29 bits)][Offset (2 bits)][Direction (1 bit)] 31 3 1 0 4. å®ç°æŠ€æœ¯ #4.1 å®šä¹‰æ©ç å’Œåç§» ##define DIRECTION_BITS_MASK 0x1 #define DIRECTION_BITS_OFFSET 0x0 #define OFFSET_BITS_MASK 0x3 #define OFFSET_BITS_OFFSET 0x1 #define INSTRUMENT_BITS_MASK 0x1FFFFFFF #define INSTRUMENT_BITS_OFFSET 0x3 4.2 è·å–å­—æ®µå€¼ #int get_Field(int\u0026amp; value, int mask, int offset) { return (value \u0026gt;\u0026gt; offset) \u0026amp; mask; } // å…·ä½“å®ç°ç¤ºä¾‹ int get_Direction(int\u0026amp; value) { return (value \u0026gt;\u0026gt; DIRECTION_BITS_OFFSET) \u0026amp; DIRECTION_BITS_MASK; } 4.3 è®¾ç½®å­—æ®µå€¼ #æ ¹æ®å­—æ®µçš„ä½ç½®å’Œå¤§å°ï¼Œè®¾ç½®å‡½æ•°å¯èƒ½æœ‰ä¸åŒçš„å®ç°ï¼š\n// å¯¹äºæœ€ä½ä½çš„å•ä½å­—æ®µï¼ˆå¦‚ Directionï¼‰ int set_Direction(int\u0026amp; value, int new_direction) { if (new_direction != 1 \u0026amp;\u0026amp; new_direction != 0) { return -1; } value = (value \u0026amp; ~DIRECTION_BITS_MASK) | new_direction; return 0; } // å¯¹äºéæœ€ä½ä½çš„å¤šä½å­—æ®µï¼ˆå¦‚ Offsetï¼‰ int set_Offset(int\u0026amp; value, int new_offset) { if (new_offset \u0026lt; 3 \u0026amp;\u0026amp; new_offset \u0026gt; 0) { value = (value \u0026amp; ~(OFFSET_BITS_MASK \u0026lt;\u0026lt; OFFSET_BITS_OFFSET)) | (new_offset \u0026lt;\u0026lt; OFFSET_BITS_OFFSET); return 0; } return -1; } æ³¨æ„ set_Direction å’Œ set_Offset çš„åŒºåˆ«ï¼š\nset_Direction ç›´æ¥ä½¿ç”¨æ©ç ï¼Œå› ä¸ºå®ƒæ“ä½œçš„æ˜¯æœ€ä½ä½ set_Offset éœ€è¦å°†æ©ç å’Œæ–°å€¼å·¦ç§»ï¼Œå› ä¸ºå®ƒæ“ä½œçš„ä½ä¸åœ¨æœ€ä½ä½ç½® 4.4 é€šç”¨è®¾ç½®å‡½æ•° #int set_Field(int\u0026amp; value, int new_field_value, int mask, int offset) { value = (value \u0026amp; ~(mask \u0026lt;\u0026lt; offset)) | (new_field_value \u0026lt;\u0026lt; offset); return 0; } 5. åœ¨é«˜é¢‘äº¤æ˜“ï¼ˆHFTï¼‰ç³»ç»Ÿä¸­çš„åº”ç”¨ #é«˜é¢‘äº¤æ˜“ç³»ç»Ÿå¯¹æ€§èƒ½å’Œå»¶è¿Ÿæå…¶æ•æ„Ÿï¼Œä½æ“ä½œåœ¨è¿™é‡Œå‘æŒ¥ç€å…³é”®ä½œç”¨ã€‚\n5.1 è®¢å•ç¼–ç  #åœ¨HFTç³»ç»Ÿä¸­ï¼Œè®¢å•ä¿¡æ¯éœ€è¦å¿«é€Ÿå¤„ç†å’Œä¼ è¾“ã€‚ä½¿ç”¨ä½åŸŸå¯ä»¥å°†è®¢å•çš„å¤šä¸ªå±æ€§æ‰“åŒ…åˆ°ä¸€ä¸ªæ•´æ•°ä¸­ï¼š\n#define ORDER_TYPE_MASK 0x03 #define SIDE_MASK 0x04 #define QUANTITY_MASK 0xFFFFF8 #define PRICE_MASK 0xFFF00000 #define ORDER_TYPE_OFFSET 0 #define SIDE_OFFSET 2 #define QUANTITY_OFFSET 3 #define PRICE_OFFSET 20 typedef unsigned int OrderInfo; OrderInfo createOrder(unsigned char type, bool isBuy, unsigned int quantity, unsigned int price) { return (type \u0026amp; ORDER_TYPE_MASK) | ((isBuy ? 1 : 0) \u0026lt;\u0026lt; SIDE_OFFSET) | ((quantity \u0026amp; (QUANTITY_MASK \u0026gt;\u0026gt; QUANTITY_OFFSET)) \u0026lt;\u0026lt; QUANTITY_OFFSET) | ((price \u0026amp; (PRICE_MASK \u0026gt;\u0026gt; PRICE_OFFSET)) \u0026lt;\u0026lt; PRICE_OFFSET); } unsigned char getOrderType(OrderInfo order) { return order \u0026amp; ORDER_TYPE_MASK; } bool isBuyOrder(OrderInfo order) { return (order \u0026amp; SIDE_MASK) != 0; } unsigned int getQuantity(OrderInfo order) { return (order \u0026amp; QUANTITY_MASK) \u0026gt;\u0026gt; QUANTITY_OFFSET; } unsigned int getPrice(OrderInfo order) { return (order \u0026amp; PRICE_MASK) \u0026gt;\u0026gt; PRICE_OFFSET; } 5.2 å¸‚åœºæ•°æ®å‹ç¼© #HFTç³»ç»Ÿéœ€è¦å¤„ç†å¤§é‡çš„å¸‚åœºæ•°æ®ã€‚ä½¿ç”¨ä½æ“ä½œå¯ä»¥å‹ç¼©æ•°æ®ï¼Œå‡å°‘ç½‘ç»œä¼ è¾“å’Œå­˜å‚¨éœ€æ±‚ï¼š\nstruct CompressedQuote { unsigned long long timestamp : 48; // å¾®ç§’çº§æ—¶é—´æˆ³ unsigned int symbol : 24; // è‚¡ç¥¨ä»£ç  unsigned int bidPrice : 32; // ä¹°å…¥ä»· unsigned int askPrice : 32; // å–å‡ºä»· unsigned int bidSize : 24; // ä¹°å…¥é‡ unsigned int askSize : 24; // å–å‡ºé‡ unsigned int flags : 8; // å„ç§æ ‡å¿— }; 5.3 å¿«é€Ÿæ¯”è¾ƒå’ŒåŒ¹é… #ä½æ“ä½œå¯ç”¨äºå®ç°å¿«é€Ÿçš„è®¢å•åŒ¹é…å’Œæ¯”è¾ƒï¼š\nbool isMatchingOrder(OrderInfo order1, OrderInfo order2) { return (getOrderType(order1) == getOrderType(order2)) \u0026amp;\u0026amp; (isBuyOrder(order1) != isBuyOrder(order2)) \u0026amp;\u0026amp; ((isBuyOrder(order1) \u0026amp;\u0026amp; getPrice(order1) \u0026gt;= getPrice(order2)) || (!isBuyOrder(order1) \u0026amp;\u0026amp; getPrice(order1) \u0026lt;= getPrice(order2))); } 5.4 é£é™©ç®¡ç†å’Œåˆè§„æ£€æŸ¥ #ä½æ“ä½œå¯ä»¥ç”¨äºå¿«é€Ÿæ‰§è¡Œé£é™©æ£€æŸ¥å’Œåˆè§„éªŒè¯ï¼š\n#define RISK_CHECK_MASK 0xF0000000 bool passesRiskCheck(OrderInfo order) { return (order \u0026amp; RISK_CHECK_MASK) == 0; } 5.5 æ€§èƒ½ä¼˜åŒ– # ç¼“å­˜å‹å¥½ï¼šç´§å‡‘çš„æ•°æ®è¡¨ç¤ºæœ‰åŠ©äºæ›´å¥½åœ°åˆ©ç”¨CPUç¼“å­˜ã€‚\nSIMDæ“ä½œï¼šæŸäº›ä½æ“ä½œå¯ä»¥åˆ©ç”¨SIMDï¼ˆå•æŒ‡ä»¤å¤šæ•°æ®ï¼‰æŒ‡ä»¤è¿›è¡Œå¹¶è¡Œå¤„ç†ã€‚\n// ä½¿ç”¨SIMDæŒ‡ä»¤å¹¶è¡Œå¤„ç†å¤šä¸ªè®¢å• void processOrdersSIMD(OrderInfo* orders, int count) { // ä½¿ç”¨ AVX2 æŒ‡ä»¤é›† __m256i orderVector = _mm256_loadu_si256((__m256i*)orders); __m256i typeMask = _mm256_set1_epi32(ORDER_TYPE_MASK); __m256i types = _mm256_and_si256(orderVector, typeMask); // è¿›ä¸€æ­¥å¤„ç†... } ç½‘ç»œä¼˜åŒ–ï¼šå‹ç¼©çš„æ•°æ®æ ¼å¼å‡å°‘äº†ç½‘ç»œä¼ è¾“é‡ï¼Œé™ä½å»¶è¿Ÿã€‚\n5.6 HFTç³»ç»Ÿä¸­çš„æ³¨æ„äº‹é¡¹ # å¯è¯»æ€§ vs æ€§èƒ½ï¼šåœ¨HFTç³»ç»Ÿä¸­ï¼Œé€šå¸¸ä¼šç‰ºç‰²ä¸€å®šçš„å¯è¯»æ€§æ¥æ¢å–æè‡´çš„æ€§èƒ½ã€‚ æ­£ç¡®æ€§éªŒè¯ï¼šç”±äºä½æ“ä½œå®¹æ˜“å‡ºé”™ï¼Œéœ€è¦ä¸¥æ ¼çš„å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•ã€‚ æ–‡æ¡£å’Œæ³¨é‡Šï¼šè¯¦ç»†çš„æ–‡æ¡£å’Œæ³¨é‡Šå¯¹äºç»´æŠ¤è¿™ç±»é«˜åº¦ä¼˜åŒ–çš„ä»£ç è‡³å…³é‡è¦ã€‚ ç¡¬ä»¶è€ƒè™‘ï¼šæŸäº›ä½æ“ä½œå¯èƒ½åœ¨ç‰¹å®šç¡¬ä»¶ä¸Šæ›´é«˜æ•ˆï¼Œéœ€è¦é’ˆå¯¹ç›®æ ‡å¹³å°ä¼˜åŒ–ã€‚ 6. ç»“è®º #ä½æ“ä½œå’Œä½åŸŸæ˜¯å¼ºå¤§çš„ç¼–ç¨‹æŠ€æœ¯ï¼Œåœ¨éœ€è¦é«˜æ€§èƒ½å’Œå†…å­˜æ•ˆç‡çš„åœºæ™¯ä¸­å°¤å…¶æœ‰ç”¨ã€‚åœ¨é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­ï¼Œè¿™äº›æŠ€æœ¯èƒ½å¤Ÿæ˜¾è‘—æå‡æ•°æ®å¤„ç†é€Ÿåº¦ã€å‡å°‘å†…å­˜ä½¿ç”¨å’Œç½‘ç»œå»¶è¿Ÿã€‚ç„¶è€Œï¼Œä½¿ç”¨è¿™äº›æŠ€æœ¯éœ€è¦åœ¨æ€§èƒ½ã€å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ä¹‹é—´å–å¾—å¹³è¡¡ã€‚éšç€é‡‘èæŠ€æœ¯çš„ä¸æ–­å‘å±•ï¼ŒæŒæ¡å’Œå·§å¦™è¿ç”¨è¿™äº›åŸºç¡€ä½†å¼ºå¤§çš„æŠ€æœ¯å°†ç»§ç»­åœ¨é«˜æ€§èƒ½è®¡ç®—é¢†åŸŸï¼Œç‰¹åˆ«æ˜¯åœ¨HFTç³»ç»Ÿä¸­å‘æŒ¥é‡è¦ä½œç”¨ã€‚\n","date":"13 October 2024","permalink":"/blog/2025-06-24-bit_field_compression_techniques/","section":"Blog","summary":"1. åŸºç¡€æ¦‚å¿µ #1.1 äºŒè¿›åˆ¶è¡¨ç¤º # è®¡ç®—æœºä½¿ç”¨äºŒè¿›åˆ¶ï¼ˆ0å’Œ1ï¼‰å­˜å‚¨å’Œå¤„ç†æ•°æ® 1 byte = 8 bits 32ä½æ•´æ•°å¯ä»¥è¡¨ç¤ºä» 0 åˆ° 2^32 - 1 çš„æ•°å€¼ 1.2 ä½æ“ä½œåŸºç¡€ # ä¸æ“ä½œ (\u0026amp;): ä¸¤ä½éƒ½ä¸º1æ—¶ç»“æœä¸º1ï¼Œå¦åˆ™ä¸º0 æˆ–æ“ä½œ (|): è‡³å°‘ä¸€ä½ä¸º1æ—¶ç»“æœä¸º1ï¼Œå¦åˆ™ä¸º0 å¼‚æˆ–æ“ä½œ (^): ä¸¤ä½ä¸åŒæ—¶ç»“æœä¸º1ï¼Œç›¸åŒæ—¶ä¸º0 éæ“ä½œ (~): å°†æ¯ä¸€ä½å–å å·¦ç§» (\u0026laquo;): å°†æ‰€æœ‰ä½å‘å·¦ç§»åŠ¨ï¼Œå³ä¾§è¡¥0 å³ç§» (\u0026raquo;): å°†æ‰€æœ‰ä½å‘å³ç§»åŠ¨ï¼Œå·¦ä¾§è¡¥0æˆ–ç¬¦å·ä½ ç¤ºä¾‹ï¼š\nunsigned int a = 5; // 0101 unsigned int b = 3; // 0011 unsigned int and_result = a \u0026amp; b; // 0001 (1) unsigned int or_result = a | b; // 0111 (7) unsigned int xor_result = a ^ b; // 0110 (6) unsigned int not_result = ~a; // 11111111111111111111111111111010 (-6 in 2\u0026#39;s complement) unsigned int left_shift = a \u0026lt;\u0026lt; 1; // 1010 (10) unsigned int right_shift = a \u0026gt;\u0026gt; 1;// 0010 (2) 2.","title":"é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­çš„ä½åŸŸå‹ç¼©æŠ€æœ¯"},{"content":"1. èƒŒæ™¯ä»‹ç» #åœ¨é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­ï¼Œå¸‚åœºæ•°æ®çš„å¿«é€Ÿè¯»å–å’Œå¤„ç†æ˜¯å…³é”®æ€§èƒ½æŒ‡æ ‡ä¹‹ä¸€ã€‚æˆ‘ä»¬çš„ç³»ç»Ÿä½¿ç”¨å…±äº«å†…å­˜æ¥å­˜å‚¨å’Œè®¿é—®å®æ—¶å¸‚åœºæ•°æ®ï¼Œå…¶ä¸­ MarketDataStore ç±»è´Ÿè´£ç®¡ç†è¿™äº›æ•°æ®ã€‚æœ¬æ–‡å°†è®¨è®ºå¦‚ä½•ä¼˜åŒ– MarketDataStore ä¸­çš„ readLatestData å‡½æ•°ï¼Œä»¥æé«˜æ•°æ®è¯»å–çš„æ•ˆç‡ã€‚\n2. åˆå§‹å®ç° #æœ€åˆçš„ readLatestData å‡½æ•°å®ç°å¦‚ä¸‹ï¼š\nstd::optional\u0026lt;MappedTickerData\u0026gt; MarketDataStore::readLatestData(const std::string\u0026amp; symbol) const { std::shared_lock\u0026lt;std::shared_mutex\u0026gt; lock(mutex); size_t offset = calculateOffset(symbol); MappedTickerData data; if (dataFile-\u0026gt;read(\u0026amp;data, offset, sizeof(MappedTickerData))) { if (data.timestamp != 0 \u0026amp;\u0026amp; std::string(data.product_id) == symbol) { return data; } else { LOG_WARN(\u0026#34;readLatestData symbol = {} failed\u0026#34;, symbol); return std::nullopt; } } else { LOG_ERROR(\u0026#34;Failed to read data for symbol = {}\u0026#34;, symbol); return std::nullopt; } } è¿™ä¸ªå®ç°å­˜åœ¨å‡ ä¸ªæ€§èƒ½ç“¶é¢ˆï¼š\nä½¿ç”¨å…±äº«é”å¯èƒ½å¯¼è‡´å¹¶å‘è¯»å–çš„æ€§èƒ½ä¸‹é™ã€‚ å­—ç¬¦ä¸²æ¯”è¾ƒæ•ˆç‡ä½ä¸‹ï¼Œç‰¹åˆ«æ˜¯åˆ›å»ºä¸´æ—¶ std::string å¯¹è±¡ã€‚ æ²¡æœ‰åˆ©ç”¨ç°ä»£ CPU çš„ SIMD æŒ‡ä»¤é›†ã€‚ 3. ä¼˜åŒ–è¿‡ç¨‹ #3.1 å­—ç¬¦ä¸²æ¯”è¾ƒä¼˜åŒ– #é¦–å…ˆï¼Œæˆ‘ä»¬ä¼˜åŒ–äº†å­—ç¬¦ä¸²æ¯”è¾ƒé€»è¾‘ï¼š\nstatic inline bool compareProductId(const char* product_id, const std::string\u0026amp; symbol) { size_t symbolLength = symbol.length(); if (symbolLength \u0026gt; sizeof(MappedTickerData::product_id) - 1) { return false; } if (memcmp(product_id, symbol.data(), symbolLength) != 0) { return false; } return product_id[symbolLength] == \u0026#39;\\0\u0026#39;; } è¿™ä¸ªä¼˜åŒ–é¿å…äº†åˆ›å»ºä¸´æ—¶å­—ç¬¦ä¸²å¯¹è±¡ï¼Œå¹¶ä½¿ç”¨äº†æ›´é«˜æ•ˆçš„ memcmp å‡½æ•°ã€‚\n3.2 SIMD æŒ‡ä»¤ä¼˜åŒ– #ä¸ºäº†è¿›ä¸€æ­¥æé«˜æ€§èƒ½ï¼Œæˆ‘ä»¬å¼•å…¥äº† SIMD æŒ‡ä»¤æ¥å¹¶è¡ŒåŒ–å­—ç¬¦ä¸²æ¯”è¾ƒï¼š\nstatic inline bool compareProductIdSIMD(const char* product_id, const std::string\u0026amp; symbol) { size_t symbolLength = symbol.length(); if (symbolLength \u0026gt; 15) { return false; } __m128i prod_id = _mm_loadu_si128(reinterpret_cast\u0026lt;const __m128i*\u0026gt;(product_id)); char mask[16] = {0}; memcpy(mask, symbol.data(), symbolLength); __m128i symbol_mask = _mm_loadu_si128(reinterpret_cast\u0026lt;const __m128i*\u0026gt;(mask)); __m128i cmp_result = _mm_cmpeq_epi8(prod_id, symbol_mask); int match_mask = _mm_movemask_epi8(cmp_result); int should_match = (1 \u0026lt;\u0026lt; symbolLength) - 1; if ((match_mask \u0026amp; should_match) != should_match) { return false; } return (match_mask \u0026amp; (1 \u0026lt;\u0026lt; symbolLength)) != 0; } è¿™ä¸ªå®ç°åˆ©ç”¨ SSE æŒ‡ä»¤é›†åŒæ—¶æ¯”è¾ƒ 16 ä¸ªå­—èŠ‚ï¼Œæ˜¾è‘—æé«˜äº†æ¯”è¾ƒé€Ÿåº¦ã€‚\n3.3 æ— é”è¯»å– #è€ƒè™‘åˆ° readLatestData å‡½æ•°è¢«é¢‘ç¹è°ƒç”¨ï¼Œæˆ‘ä»¬æ¢è®¨äº†ä½¿ç”¨æ— é”è¯»å–æŠ€æœ¯ï¼š\nstd::optional\u0026lt;MappedTickerData\u0026gt; MarketDataStore::readLatestData(const std::string\u0026amp; symbol) const { size_t offset = calculateOffset(symbol); MappedTickerData data; std::atomic_thread_fence(std::memory_order_acquire); memcpy(\u0026amp;data, static_cast\u0026lt;char*\u0026gt;(mappedMemory) + offset, sizeof(MappedTickerData)); std::atomic_thread_fence(std::memory_order_acquire); if (data.timestamp != 0 \u0026amp;\u0026amp; compareProductIdSIMD(data.product_id, symbol)) { return data; } return std::nullopt; } è¿™ä¸ªç‰ˆæœ¬ç§»é™¤äº†å…±äº«é”ï¼Œä½¿ç”¨å†…å­˜å±éšœç¡®ä¿æ•°æ®ä¸€è‡´æ€§ã€‚\n4. æœ€ç»ˆä¼˜åŒ–ç‰ˆæœ¬ #ç»¼åˆä»¥ä¸Šä¼˜åŒ–ï¼Œæˆ‘ä»¬çš„æœ€ç»ˆç‰ˆæœ¬å¦‚ä¸‹ï¼š\nclass MarketDataStore { private: void* mappedMemory; size_t memorySize; std::unordered_map\u0026lt;std::string_view, size_t\u0026gt; symbolOffsets; static inline bool compareProductIdSIMD(const char* product_id, const std::string\u0026amp; symbol) { // SIMD æ¯”è¾ƒå®ç°ï¼ˆå¦‚å‰æ‰€ç¤ºï¼‰ } public: inline std::optional\u0026lt;MappedTickerData\u0026gt; readLatestData(std::string_view symbol) const noexcept { auto it = symbolOffsets.find(symbol); if (it == symbolOffsets.end()) { return std::nullopt; } size_t offset = it-\u0026gt;second; if (offset + sizeof(MappedTickerData) \u0026gt; memorySize) { return std::nullopt; } MappedTickerData data; std::atomic_thread_fence(std::memory_order_acquire); memcpy(\u0026amp;data, static_cast\u0026lt;char*\u0026gt;(mappedMemory) + offset, sizeof(MappedTickerData)); std::atomic_thread_fence(std::memory_order_acquire); if (data.timestamp == 0) { return std::nullopt; } if (compareProductIdSIMD(data.product_id, std::string(symbol))) { return data; } return std::nullopt; } }; 5. æ€§èƒ½è€ƒè™‘å’Œæ³¨æ„äº‹é¡¹ # SIMD æŒ‡ä»¤ï¼šç¡®ä¿ç›®æ ‡å¹³å°æ”¯æŒä½¿ç”¨çš„ SIMD æŒ‡ä»¤é›†ã€‚ å†…å­˜å¯¹é½ï¼šè€ƒè™‘å°† MappedTickerData ç»“æ„ä½“å¯¹é½åˆ°ç¼“å­˜çº¿è¾¹ç•Œã€‚ é¢„è®¡ç®—åç§»é‡ï¼šä½¿ç”¨ symbolOffsets å“ˆå¸Œè¡¨é¢„å­˜å‚¨åç§»é‡ï¼Œé¿å…é‡å¤è®¡ç®—ã€‚ æ— é”è¯»å–ï¼šåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­éœ€è¦ä»”ç»†è€ƒè™‘å†…å­˜ä¸€è‡´æ€§é—®é¢˜ã€‚ å­—ç¬¦ä¸²è§†å›¾ï¼šä½¿ç”¨ std::string_view å‡å°‘ä¸å¿…è¦çš„å­—ç¬¦ä¸²æ‹·è´ã€‚ 6. ç»“è®º #é€šè¿‡è¿™ä¸€ç³»åˆ—ä¼˜åŒ–ï¼Œæˆ‘ä»¬æ˜¾è‘—æé«˜äº† MarketDataStore çš„è¯»å–æ€§èƒ½ã€‚ä¸»è¦æ”¹è¿›åŒ…æ‹¬ï¼š\nä½¿ç”¨ SIMD æŒ‡ä»¤åŠ é€Ÿå­—ç¬¦ä¸²æ¯”è¾ƒ å®ç°æ— é”è¯»å–å‡å°‘çº¿ç¨‹ç«äº‰ ä¼˜åŒ–å†…å­˜è®¿é—®æ¨¡å¼æé«˜ç¼“å­˜æ•ˆç‡ è¿™äº›ä¼˜åŒ–å¯¹äºé«˜é¢‘äº¤æ˜“ç³»ç»Ÿçš„æ•´ä½“æ€§èƒ½æœ‰é‡è¦å½±å“ã€‚ç„¶è€Œï¼Œåœ¨å®é™…éƒ¨ç½²å‰ï¼ŒåŠ¡å¿…è¿›è¡Œå…¨é¢çš„åŸºå‡†æµ‹è¯•å’Œå‹åŠ›æµ‹è¯•ï¼Œä»¥ç¡®ä¿åœ¨å®é™…å·¥ä½œè´Ÿè½½ä¸‹çš„æ€§èƒ½æå‡ã€‚\n7. æœªæ¥å·¥ä½œ # æ¢ç´¢ä½¿ç”¨æ›´é«˜çº§çš„ SIMD æŒ‡ä»¤é›†ï¼ˆå¦‚ AVX-512ï¼‰è¿›ä¸€æ­¥ä¼˜åŒ–ã€‚ å®ç°è‡ªé€‚åº”ç­–ç•¥ï¼Œæ ¹æ®æ•°æ®ç‰¹å¾åŠ¨æ€é€‰æ‹©æœ€ä½³çš„æ¯”è¾ƒæ–¹æ³•ã€‚ è€ƒè™‘å¼•å…¥é¢„å–æŠ€æœ¯ï¼Œè¿›ä¸€æ­¥å‡å°‘å†…å­˜è®¿é—®å»¶è¿Ÿã€‚ æŒç»­ç›‘æ§å’Œåˆ†æç³»ç»Ÿæ€§èƒ½ï¼Œè¯†åˆ«æ–°çš„ä¼˜åŒ–æœºä¼šã€‚ ","date":"29 September 2024","permalink":"/blog/2025-06-24-efficient_reading_techniques/","section":"Blog","summary":"1. èƒŒæ™¯ä»‹ç» #åœ¨é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­ï¼Œå¸‚åœºæ•°æ®çš„å¿«é€Ÿè¯»å–å’Œå¤„ç†æ˜¯å…³é”®æ€§èƒ½æŒ‡æ ‡ä¹‹ä¸€ã€‚æˆ‘ä»¬çš„ç³»ç»Ÿä½¿ç”¨å…±äº«å†…å­˜æ¥å­˜å‚¨å’Œè®¿é—®å®æ—¶å¸‚åœºæ•°æ®ï¼Œå…¶ä¸­ MarketDataStore ç±»è´Ÿè´£ç®¡ç†è¿™äº›æ•°æ®ã€‚æœ¬æ–‡å°†è®¨è®ºå¦‚ä½•ä¼˜åŒ– MarketDataStore ä¸­çš„ readLatestData å‡½æ•°ï¼Œä»¥æé«˜æ•°æ®è¯»å–çš„æ•ˆç‡ã€‚\n2. åˆå§‹å®ç° #æœ€åˆçš„ readLatestData å‡½æ•°å®ç°å¦‚ä¸‹ï¼š\nstd::optional\u0026lt;MappedTickerData\u0026gt; MarketDataStore::readLatestData(const std::string\u0026amp; symbol) const { std::shared_lock\u0026lt;std::shared_mutex\u0026gt; lock(mutex); size_t offset = calculateOffset(symbol); MappedTickerData data; if (dataFile-\u0026gt;read(\u0026amp;data, offset, sizeof(MappedTickerData))) { if (data.timestamp != 0 \u0026amp;\u0026amp; std::string(data.product_id) == symbol) { return data; } else { LOG_WARN(\u0026#34;readLatestData symbol = {} failed\u0026#34;, symbol); return std::nullopt; } } else { LOG_ERROR(\u0026#34;Failed to read data for symbol = {}\u0026#34;, symbol); return std::nullopt; } } è¿™ä¸ªå®ç°å­˜åœ¨å‡ ä¸ªæ€§èƒ½ç“¶é¢ˆï¼š","title":"é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­çš„å¸‚åœºæ•°æ®å­˜å‚¨ä¼˜åŒ–"},{"content":"é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­çš„é‡è¿æœºåˆ¶æœ€ä½³å®è·µ #èƒŒæ™¯ #åœ¨é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­ï¼Œç½‘ç»œè¿æ¥çš„ç¨³å®šæ€§è‡³å…³é‡è¦ã€‚ç„¶è€Œï¼Œç”±äºç½‘ç»œæ³¢åŠ¨æˆ–å…¶ä»–åŸå› ï¼Œè¿æ¥å¯èƒ½ä¼šä¸­æ–­ã€‚ä¸ºäº†ç¡®ä¿ç³»ç»Ÿçš„è¿ç»­æ€§å’Œå¯é æ€§ï¼Œéœ€è¦å®ç°ä¸€ä¸ªé«˜æ•ˆçš„é‡è¿æœºåˆ¶ã€‚ç„¶è€Œï¼Œé¢‘ç¹çš„é‡è¿æ£€æŸ¥å’Œå¤„ç†å¯èƒ½å¯¼è‡´é‡å¤é‡è¿ï¼Œå½±å“ç³»ç»Ÿæ€§èƒ½ã€‚\né—®é¢˜æè¿° #åœ¨ç°æœ‰å®ç°ä¸­ï¼Œä¸»å¾ªç¯é¢‘ç¹æ£€æŸ¥ m_client-\u0026gt;needsReconnection()ï¼Œå¦‚æœéœ€è¦é‡è¿ï¼Œåˆ™è°ƒç”¨ handleReconnect()ã€‚ç„¶è€Œï¼Œç”±äºä¸»å¾ªç¯é€Ÿåº¦å¾ˆå¿«ï¼Œå¯èƒ½åœ¨ resetReconnectionFlag() ç”Ÿæ•ˆå‰å†æ¬¡æ£€æŸ¥ needsReconnection()ï¼Œå¯¼è‡´é‡å¤è°ƒç”¨ handleReconnect()ã€‚\nè§£å†³æ–¹æ¡ˆ #é€šè¿‡ä½¿ç”¨åŸå­æ“ä½œå’ŒåŒé‡æ£€æŸ¥æœºåˆ¶ï¼Œç¡®ä¿é‡è¿è¿‡ç¨‹çš„åŸå­æ€§å’Œä¸€è‡´æ€§ï¼Œé¿å…é‡å¤é‡è¿ã€‚\n1. å®šä¹‰è¿æ¥çŠ¶æ€ç®¡ç† #ä½¿ç”¨åŸå­å˜é‡æ¥ç®¡ç†è¿æ¥çŠ¶æ€ï¼Œç¡®ä¿çº¿ç¨‹å®‰å…¨ã€‚\nclass WebSocketClient { private: std::atomic\u0026lt;bool\u0026gt; isReconnecting{false}; std::atomic\u0026lt;bool\u0026gt; needsReconnection{false}; public: bool needsReconnection() const { return needsReconnection.load(std::memory_order_acquire); } bool tryInitiateReconnection() { bool expected = false; return isReconnecting.compare_exchange_strong(expected, true, std::memory_order_acq_rel); } void setNeedsReconnection(bool value) { needsReconnection.store(value, std::memory_order_release); } void resetReconnectionFlag() { needsReconnection.store(false, std::memory_order_release); isReconnecting.store(false, std::memory_order_release); } }; 2. ä¿®æ”¹ä¸»å¾ªç¯ #åœ¨ä¸»å¾ªç¯ä¸­ä½¿ç”¨åŒé‡æ£€æŸ¥æœºåˆ¶ï¼Œç¡®ä¿é‡è¿è¿‡ç¨‹çš„åŸå­æ€§ã€‚\nvoid StrategyAndTrading::run() { initializeConnection(); marketDataReader-\u0026gt;start(); positionManager-\u0026gt;updatePositionsThread(); m_commonLib-\u0026gt;getConfigManager().configWatcher(); while (running_) { if (m_client-\u0026gt;needsReconnection() \u0026amp;\u0026amp; m_client-\u0026gt;tryInitiateReconnection()) { handleReconnect(); } // æ‰§è¡Œå…¶ä»–é«˜é¢‘äº¤æ˜“é€»è¾‘ std::this_thread::sleep_for(std::chrono::microseconds(100)); // å¾®ç§’çº§çš„ç¡çœ  } } 3. å®ç°é‡è¿å¤„ç† #ç¡®ä¿é‡è¿è¿‡ç¨‹çš„åŸå­æ€§å’Œä¸€è‡´æ€§ã€‚\nvoid StrategyAndTrading::handleReconnect() { LOG_INFO(\u0026#34;Initiating reconnection process\u0026#34;); int retryCount = 0; const int MAX_RETRIES = 3; while (retryCount \u0026lt; MAX_RETRIES) { LOG_INFO(\u0026#34;retryCount: {} RECONNECTING\u0026#34;, retryCount); if (establishConnection(true)) { LOG_INFO(\u0026#34;Reconnection successful\u0026#34;); m_client-\u0026gt;resetReconnectionFlag(); return; } retryCount++; LOG_WARN(\u0026#34;Reconnection attempt {} failed, retrying...\u0026#34;, retryCount); std::this_thread::sleep_for(std::chrono::seconds(5 * retryCount)); } LOG_ERROR(\u0026#34;Reconnection failed after {} attempts\u0026#34;, MAX_RETRIES); m_client-\u0026gt;setNeedsReconnection(true); // ä¿æŒé‡è¿éœ€æ±‚ m_client-\u0026gt;resetReconnectionFlag(); // å…è®¸ä¸‹ä¸€æ¬¡é‡è¿å°è¯• } è®¾è®¡ç†ç”± # åŸå­æ“ä½œï¼šä½¿ç”¨ std::atomic ç¡®ä¿çº¿ç¨‹å®‰å…¨ï¼Œé¿å…æ•°æ®ç«äº‰ã€‚ åŒé‡æ£€æŸ¥ï¼šé€šè¿‡ needsReconnection() å’Œ tryInitiateReconnection() çš„ç»„åˆï¼Œé¿å…é‡å¤è¿›å…¥é‡è¿æµç¨‹ã€‚ çŠ¶æ€ä¸€è‡´æ€§ï¼šresetReconnectionFlag() åŒæ—¶é‡ç½®ä¸¤ä¸ªæ ‡å¿—ï¼Œç¡®ä¿çŠ¶æ€ä¸€è‡´ã€‚ æ€§èƒ½ä¼˜åŒ–ï¼šä¸»å¾ªç¯ä¸­çš„ç¡çœ æ—¶é—´å¯ä»¥è°ƒæ•´åˆ°å¾®ç§’çº§ï¼Œä¿æŒé«˜å“åº”æ€§ã€‚ ç®€å•ç›´æ¥ï¼šç›¸æ¯”å¤æ‚çš„å¤šçº¿ç¨‹æˆ–çŠ¶æ€æœºæ–¹æ¡ˆï¼Œè¿™ä¸ªè§£å†³æ–¹æ¡ˆæ›´åŠ ç›´æ¥åœ°è§£å†³äº†æ‚¨æè¿°çš„é—®é¢˜ã€‚ å¯æ‰©å±•æ€§ï¼šè¿™ä¸ªè®¾è®¡æ˜“äºæ‰©å±•ï¼Œå¯ä»¥æ·»åŠ æ›´å¤šçš„è¿æ¥çŠ¶æ€å’Œç›¸åº”çš„å¤„ç†é€»è¾‘ã€‚ é”™è¯¯æ¢å¤ï¼šå¦‚æœé‡è¿å¤±è´¥ï¼Œç³»ç»Ÿä¼šä¿æŒé‡è¿éœ€æ±‚ï¼Œå…è®¸åœ¨ä¸‹ä¸€ä¸ªå¾ªç¯ä¸­å†æ¬¡å°è¯•ã€‚ compare_exchange_strong çš„ä½¿ç”¨ #ç”¨æ³• #compare_exchange_strong æ˜¯ C++ æ ‡å‡†åº“ä¸­ std::atomic æä¾›çš„ä¸€ç§åŸå­æ“ä½œï¼Œç”¨äºå®ç°æ— é”ç¼–ç¨‹ã€‚å®ƒçš„ä½œç”¨æ˜¯æ¯”è¾ƒå¹¶äº¤æ¢ï¼ˆCompare and Swap, CASï¼‰ï¼Œç¡®ä¿åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å¯¹å˜é‡çš„æ›´æ–°æ˜¯åŸå­çš„ã€‚\nå‡½æ•°ç­¾å #bool compare_exchange_strong(T\u0026amp; expected, T desired, std::memory_order order = std::memory_order_seq_cst) noexcept; å‚æ•° # expectedï¼šä¸€ä¸ªå¼•ç”¨ï¼Œè¡¨ç¤ºé¢„æœŸçš„æ—§å€¼ã€‚å¦‚æœå½“å‰å€¼ä¸ expected ç›¸ç­‰ï¼Œåˆ™å°†å…¶æ›´æ–°ä¸º desiredï¼Œå¦åˆ™å°†å½“å‰å€¼å†™å…¥ expectedã€‚ desiredï¼šè¦è®¾ç½®çš„æ–°å€¼ã€‚ orderï¼šå†…å­˜åºï¼ˆmemory orderï¼‰ï¼Œæ§åˆ¶å†…å­˜æ“ä½œçš„é¡ºåºã€‚å¸¸ç”¨çš„æœ‰ std::memory_order_acquireã€std::memory_order_release å’Œ std::memory_order_acq_relã€‚ æŸ¥çœ‹æ›´å¤šå†…å­˜åºç›¸å…³å†…å®¹ è¿”å›å€¼ # å¦‚æœå½“å‰å€¼ä¸ expected ç›¸ç­‰ï¼Œåˆ™è¿”å› trueï¼Œå¹¶å°†å½“å‰å€¼æ›´æ–°ä¸º desiredã€‚ å¦‚æœå½“å‰å€¼ä¸ expected ä¸ç›¸ç­‰ï¼Œåˆ™è¿”å› falseï¼Œå¹¶å°†å½“å‰å€¼å†™å…¥ expectedã€‚ åœ¨æ–°æ–¹æ¡ˆä¸­çš„ä½œç”¨ #åœ¨æ–°æ–¹æ¡ˆä¸­ï¼Œcompare_exchange_strong ç”¨äºç¡®ä¿åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æˆåŠŸå¯åŠ¨é‡è¿è¿‡ç¨‹ï¼Œé¿å…å¤šä¸ªçº¿ç¨‹åŒæ—¶è¿›å…¥é‡è¿è¿‡ç¨‹ã€‚\nä»£ç ç¤ºä¾‹ #bool tryInitiateReconnection() { bool expected = false; return isReconnecting.compare_exchange_strong(expected, true, std::memory_order_acq_rel); } è§£é‡Š # åˆå§‹åŒ– expectedï¼šexpected è¢«åˆå§‹åŒ–ä¸º falseï¼Œè¡¨ç¤ºé¢„æœŸçš„æ—§å€¼æ˜¯ falseã€‚ è°ƒç”¨ compare_exchange_strongï¼š å¦‚æœ isReconnecting å½“å‰å€¼ç­‰äº expectedï¼ˆå³ falseï¼‰ï¼Œåˆ™å°† isReconnecting æ›´æ–°ä¸º trueï¼Œå¹¶è¿”å› trueã€‚ å¦‚æœ isReconnecting å½“å‰å€¼ä¸ç­‰äº expectedï¼ˆå³å·²ç»æœ‰å…¶ä»–çº¿ç¨‹å°†å…¶è®¾ç½®ä¸º trueï¼‰ï¼Œåˆ™å°† isReconnecting çš„å½“å‰å€¼å†™å…¥ expectedï¼Œå¹¶è¿”å› falseã€‚ å†…å­˜åº # std::memory_order_acq_relï¼šç¡®ä¿åœ¨è·å–å’Œé‡Šæ”¾å†…å­˜æ—¶çš„é¡ºåºæ€§ï¼Œä¿è¯åœ¨é‡è¿è¿‡ç¨‹ä¸­å¯¹å†…å­˜çš„è®¿é—®æ˜¯æœ‰åºçš„ã€‚ å…·ä½“åº”ç”¨ #åœ¨ä¸»å¾ªç¯ä¸­ï¼Œé€šè¿‡ tryInitiateReconnection æ–¹æ³•æ¥æ£€æŸ¥å¹¶å¯åŠ¨é‡è¿è¿‡ç¨‹ï¼š\nvoid StrategyAndTrading::run() { while (running_) { if (m_client-\u0026gt;needsReconnection() \u0026amp;\u0026amp; m_client-\u0026gt;tryInitiateReconnection()) { handleReconnect(); } std::this_thread::sleep_for(std::chrono::microseconds(100)); // å¾®ç§’çº§çš„ç¡çœ  } } è§£é‡Š # æ£€æŸ¥ needsReconnectionï¼šé¦–å…ˆæ£€æŸ¥æ˜¯å¦éœ€è¦é‡è¿ã€‚ å°è¯•å¯åŠ¨é‡è¿ï¼šå¦‚æœéœ€è¦é‡è¿ï¼Œè°ƒç”¨ tryInitiateReconnectionã€‚ å¦‚æœ tryInitiateReconnection è¿”å› trueï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹æˆåŠŸå¯åŠ¨äº†é‡è¿è¿‡ç¨‹ã€‚ å¦‚æœ tryInitiateReconnection è¿”å› falseï¼Œè¡¨ç¤ºå·²ç»æœ‰å…¶ä»–çº¿ç¨‹åœ¨è¿›è¡Œé‡è¿ï¼Œå½“å‰çº¿ç¨‹ä¸éœ€è¦é‡å¤å¯åŠ¨é‡è¿è¿‡ç¨‹ã€‚ å®æ–½æ³¨æ„äº‹é¡¹ # ç¡®ä¿çº¿ç¨‹å®‰å…¨ï¼šæ‰€æœ‰æ¶‰åŠè¿æ¥çŠ¶æ€çš„æ“ä½œéƒ½åº”æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ è°ƒæ•´ç¡çœ æ—¶é—´ï¼šæ ¹æ®ç³»ç»Ÿéœ€æ±‚è°ƒæ•´ä¸»å¾ªç¯ä¸­çš„ç¡çœ æ—¶é—´ï¼Œåœ¨å“åº”æ€§å’Œç³»ç»Ÿè´Ÿè½½ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ã€‚ æ·»åŠ æ—¥å¿—å’Œç›‘æ§ï¼šé€‚å½“çš„æ—¥å¿—è®°å½•å’Œç›‘æ§æœ‰åŠ©äºè·Ÿè¸ªé‡è¿è¿‡ç¨‹å’Œç³»ç»ŸçŠ¶æ€ã€‚ æ‰©å±•æ€§ï¼šå¯ä»¥æ ¹æ®éœ€è¦åœ¨ WebSocketClient ä¸­å®ç°æ›´å¤æ‚çš„çŠ¶æ€ç®¡ç†é€»è¾‘ï¼Œå¦‚å¤„ç†éƒ¨åˆ†è¿æ¥ã€è®¤è¯å¤±è´¥ç­‰çŠ¶æ€ã€‚ æ€»ç»“ #é€šè¿‡è¿™ä¸ªæœ€ä½³å®è·µï¼Œæ‚¨å¯ä»¥æœ‰æ•ˆç®¡ç†é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­çš„é‡è¿è¿‡ç¨‹ï¼Œé¿å…é‡å¤é‡è¿ï¼ŒåŒæ—¶ä¿æŒç³»ç»Ÿçš„é«˜æ€§èƒ½å’Œå¯é æ€§ã€‚è¿™ä¸ªè®¾è®¡æ–¹æ¡ˆä¸ä»…è§£å†³äº†å½“å‰çš„é—®é¢˜ï¼Œè¿˜ä¸ºæœªæ¥çš„æ‰©å±•å’Œç»´æŠ¤æä¾›äº†è‰¯å¥½çš„åŸºç¡€ã€‚\n","date":"27 September 2024","permalink":"/blog/2025-06-24-atomic_operations_reconnection_mechanism/","section":"Blog","summary":"é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­çš„é‡è¿æœºåˆ¶æœ€ä½³å®è·µ #èƒŒæ™¯ #åœ¨é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­ï¼Œç½‘ç»œè¿æ¥çš„ç¨³å®šæ€§è‡³å…³é‡è¦ã€‚ç„¶è€Œï¼Œç”±äºç½‘ç»œæ³¢åŠ¨æˆ–å…¶ä»–åŸå› ï¼Œè¿æ¥å¯èƒ½ä¼šä¸­æ–­ã€‚ä¸ºäº†ç¡®ä¿ç³»ç»Ÿçš„è¿ç»­æ€§å’Œå¯é æ€§ï¼Œéœ€è¦å®ç°ä¸€ä¸ªé«˜æ•ˆçš„é‡è¿æœºåˆ¶ã€‚ç„¶è€Œï¼Œé¢‘ç¹çš„é‡è¿æ£€æŸ¥å’Œå¤„ç†å¯èƒ½å¯¼è‡´é‡å¤é‡è¿ï¼Œå½±å“ç³»ç»Ÿæ€§èƒ½ã€‚\né—®é¢˜æè¿° #åœ¨ç°æœ‰å®ç°ä¸­ï¼Œä¸»å¾ªç¯é¢‘ç¹æ£€æŸ¥ m_client-\u0026gt;needsReconnection()ï¼Œå¦‚æœéœ€è¦é‡è¿ï¼Œåˆ™è°ƒç”¨ handleReconnect()ã€‚ç„¶è€Œï¼Œç”±äºä¸»å¾ªç¯é€Ÿåº¦å¾ˆå¿«ï¼Œå¯èƒ½åœ¨ resetReconnectionFlag() ç”Ÿæ•ˆå‰å†æ¬¡æ£€æŸ¥ needsReconnection()ï¼Œå¯¼è‡´é‡å¤è°ƒç”¨ handleReconnect()ã€‚\nè§£å†³æ–¹æ¡ˆ #é€šè¿‡ä½¿ç”¨åŸå­æ“ä½œå’ŒåŒé‡æ£€æŸ¥æœºåˆ¶ï¼Œç¡®ä¿é‡è¿è¿‡ç¨‹çš„åŸå­æ€§å’Œä¸€è‡´æ€§ï¼Œé¿å…é‡å¤é‡è¿ã€‚\n1. å®šä¹‰è¿æ¥çŠ¶æ€ç®¡ç† #ä½¿ç”¨åŸå­å˜é‡æ¥ç®¡ç†è¿æ¥çŠ¶æ€ï¼Œç¡®ä¿çº¿ç¨‹å®‰å…¨ã€‚\nclass WebSocketClient { private: std::atomic\u0026lt;bool\u0026gt; isReconnecting{false}; std::atomic\u0026lt;bool\u0026gt; needsReconnection{false}; public: bool needsReconnection() const { return needsReconnection.load(std::memory_order_acquire); } bool tryInitiateReconnection() { bool expected = false; return isReconnecting.compare_exchange_strong(expected, true, std::memory_order_acq_rel); } void setNeedsReconnection(bool value) { needsReconnection.store(value, std::memory_order_release); } void resetReconnectionFlag() { needsReconnection.store(false, std::memory_order_release); isReconnecting.store(false, std::memory_order_release); } }; 2. ä¿®æ”¹ä¸»å¾ªç¯ #åœ¨ä¸»å¾ªç¯ä¸­ä½¿ç”¨åŒé‡æ£€æŸ¥æœºåˆ¶ï¼Œç¡®ä¿é‡è¿è¿‡ç¨‹çš„åŸå­æ€§ã€‚\nvoid StrategyAndTrading::run() { initializeConnection(); marketDataReader-\u0026gt;start(); positionManager-\u0026gt;updatePositionsThread(); m_commonLib-\u0026gt;getConfigManager().configWatcher(); while (running_) { if (m_client-\u0026gt;needsReconnection() \u0026amp;\u0026amp; m_client-\u0026gt;tryInitiateReconnection()) { handleReconnect(); } // æ‰§è¡Œå…¶ä»–é«˜é¢‘äº¤æ˜“é€»è¾‘ std::this_thread::sleep_for(std::chrono::microseconds(100)); // å¾®ç§’çº§çš„ç¡çœ  } } 3.","title":"é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­çš„é‡è¿æœºåˆ¶æœ€ä½³å®è·µ"},{"content":"1. åˆå§‹é—®é¢˜ï¼šæ•°æ®è¯»å–æ•ˆç‡ #æœ€åˆï¼Œæˆ‘ä»¬å…³æ³¨çš„æ˜¯å¸‚åœºæ•°æ®è¯»å–å™¨æœ¬èº«çš„æ•ˆç‡é—®é¢˜ã€‚\n1.1 è½®è¯¢æ–¹å¼ï¼ˆåˆå§‹çŠ¶æ€ï¼‰ #void MarketDataReader::readingLoop() { while (running) { for (const auto\u0026amp; symbol : symbols_) { processSymbol(symbol); } std::this_thread::sleep_for(std::chrono::milliseconds(100)); } } é—®é¢˜ï¼šæŒç»­è½®è¯¢å³ä½¿åœ¨æ²¡æœ‰æ–°æ•°æ®æ—¶ä¹Ÿä¼šæ¶ˆè€—èµ„æºã€‚\n1.2 æ¡ä»¶æ§åˆ¶æ–¹å¼ #void MarketDataReader::readingLoop() { while (running) { std::unique_lock\u0026lt;std::mutex\u0026gt; lock(conditionMutex); dataCondition.wait(lock, [this] { return !running || !symbols_.empty(); }); for (const auto\u0026amp; symbol : symbols_) { processSymbol(symbol); } } } æ”¹è¿›ï¼šå‡å°‘äº†ä¸å¿…è¦çš„CPUä½¿ç”¨ï¼Œä½†å¯èƒ½ä¼šåœ¨é«˜é¢‘æ•°æ®æ›´æ–°æ—¶å¼•å…¥å»¶è¿Ÿã€‚\næ€è€ƒè½¬å˜ï¼šè¿™ä¸ªé˜¶æ®µï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨å¦‚ä½•æé«˜å•ä¸ªç»„ä»¶ï¼ˆæ•°æ®è¯»å–å™¨ï¼‰çš„æ•ˆç‡ã€‚\n2. æ‰©å±•è€ƒè™‘ï¼šæ•°æ®è¯»å–å¯¹å…¶ä»–ç³»ç»Ÿç»„ä»¶çš„å½±å“ #éšç€å¯¹ç³»ç»Ÿçš„æ·±å…¥æ€è€ƒï¼Œæˆ‘ä»¬å¼€å§‹è€ƒè™‘æ•°æ®è¯»å–å™¨çš„è¡Œä¸ºå¦‚ä½•å½±å“æ•´ä¸ªç³»ç»Ÿï¼Œç‰¹åˆ«æ˜¯è®¢å•æµçš„æ‰§è¡Œæ•ˆç‡ã€‚\n2.1 èµ„æºç«äº‰é—®é¢˜ #è§‚å¯Ÿï¼šå°½ç®¡æˆ‘ä»¬ä¼˜åŒ–äº†æ•°æ®è¯»å–å™¨çš„æ•ˆç‡ï¼Œä½†æ•°æ®è¯»å–çº¿ç¨‹å æ®å¤ªå¤šçš„è®¡ç®—èµ„æºï¼Œä¹Ÿä¼šè¿›è€Œå½±å“è®¢å•å¤„ç†çš„æ€§èƒ½ã€‚å³ä½¿åœ¨æ²¡æœ‰æ–°æ•°æ®å¯è¯»æ—¶ï¼Œé¢‘ç¹çš„æ£€æŸ¥ä¹Ÿä¼šå ç”¨å®è´µçš„è®¡ç®—èµ„æºã€‚\næ€è€ƒï¼š\næ•°æ®è¯»å–å’Œè®¢å•å¤„ç†æ˜¯å¦åœ¨ç«äº‰åŒæ ·çš„ç³»ç»Ÿèµ„æºï¼ˆCPUã€å†…å­˜ã€I/Oï¼‰ï¼Ÿ å¦‚ä½•åœ¨ä¿è¯æ•°æ®åŠæ—¶æ€§çš„åŒæ—¶ï¼Œä¸å½±å“è®¢å•å¤„ç†çš„å“åº”é€Ÿåº¦ï¼Ÿ å¦‚ä½•åè°ƒå„ä¸ªçº¿ç¨‹ï¼Œä½¿ç³»ç»Ÿè¾¾åˆ°æœ€ä½çš„æ—¶å»¶ï¼Ÿ 2.2 è‡ªé€‚åº”é—´éš”æœºåˆ¶ #å¼•å…¥åŠ¨æ€è°ƒæ•´å¤„ç†é—´éš”çš„æœºåˆ¶ï¼Œä»¥å¹³è¡¡æ•°æ®è¯»å–å’Œç³»ç»Ÿèµ„æºä½¿ç”¨ã€‚\nvoid MarketDataReader::readingLoop() { while (running) { auto start = std::chrono::steady_clock::now(); for (const auto\u0026amp; symbol : symbols_) { processSymbol(symbol); } auto end = std::chrono::steady_clock::now(); auto duration = std::chrono::duration_cast\u0026lt;std::chrono::microseconds\u0026gt;(end - start); if (duration \u0026lt; currentInterval) { std::this_thread::sleep_for(currentInterval - duration); } adjustInterval(); } } æ€è€ƒè½¬å˜ï¼šä»å•çº¯çš„æ•ˆç‡ä¼˜åŒ–è½¬å‘äº†èµ„æºä½¿ç”¨çš„å¹³è¡¡ï¼Œè€ƒè™‘åˆ°äº†ç³»ç»Ÿçš„æ•´ä½“æ€§èƒ½ã€‚\n3. ç³»ç»Ÿçº§ä¼˜åŒ–ï¼šè´Ÿè½½å‡è¡¡ #éšç€å¯¹ç³»ç»Ÿæ•´ä½“çš„æ€è€ƒï¼Œæˆ‘ä»¬æ„è¯†åˆ°éœ€è¦ä»æ›´é«˜çš„å±‚é¢æ¥ä¼˜åŒ–æ€§èƒ½å’Œèµ„æºåˆ†é…ã€‚\n3.1 å¤šçº¿ç¨‹æ•°æ®è¯»å– #å°†æ•°æ®è¯»å–ä»»åŠ¡åˆ†æ•£åˆ°å¤šä¸ªçº¿ç¨‹ï¼Œä»¥æé«˜å¹¶è¡Œå¤„ç†èƒ½åŠ›ã€‚\nclass BalancedMarketDataReader { private: std::vector\u0026lt;std::thread\u0026gt; readerThreads; std::vector\u0026lt;std::vector\u0026lt;std::string\u0026gt;\u0026gt; symbolGroups; public: void start() { for (int i = 0; i \u0026lt; numThreads; ++i) { readerThreads.emplace_back(\u0026amp;BalancedMarketDataReader::readingLoop, this, i); } } }; æ€è€ƒï¼šå¦‚ä½•æœ€æœ‰æ•ˆåœ°åˆ†é…äº¤æ˜“å“ç§ç»™ä¸åŒçš„çº¿ç¨‹ï¼Œä»¥å¹³è¡¡è´Ÿè½½ï¼Ÿ\n3.2 åŠ¨æ€è´Ÿè½½å‡è¡¡ #å®ç°èƒ½å¤Ÿæ ¹æ®å®æ—¶è´Ÿè½½æƒ…å†µåŠ¨æ€è°ƒæ•´å·¥ä½œåˆ†é…çš„æœºåˆ¶ã€‚\nclass DynamicLoadBalancer { private: std::vector\u0026lt;std::atomic\u0026lt;int\u0026gt;\u0026gt; threadLoads; std::mutex symbolsMutex; std::vector\u0026lt;std::string\u0026gt; symbols; public: void balancerLoop() { while (running) { rebalanceLoad(); std::this_thread::sleep_for(std::chrono::seconds(10)); } } }; æ€è€ƒï¼šå¦‚ä½•åœ¨æ•°æ®è¯»å–å’Œè®¢å•å¤„ç†ä¹‹é—´åŠ¨æ€åˆ†é…ç³»ç»Ÿèµ„æºï¼Œä»¥å®ç°æœ€ä½³çš„æ•´ä½“æ€§èƒ½ï¼Ÿ\n3.3 å·¥ä½œçªƒå–ç®—æ³• #å¼•å…¥æ›´å¤æ‚çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œå…è®¸ç©ºé—²çº¿ç¨‹ä»ç¹å¿™çº¿ç¨‹\u0026quot;çªƒå–\u0026quot;å·¥ä½œã€‚\nclass WorkStealingBalancer { private: std::vector\u0026lt;std::unique_ptr\u0026lt;WorkStealingQueue\u0026gt;\u0026gt; queues; bool stealWork(int threadId) { for (size_t i = 0; i \u0026lt; queues.size(); ++i) { if (i == threadId) continue; std::string symbol; if (queues[i]-\u0026gt;steal(symbol)) { processSymbol(symbol); queues[threadId]-\u0026gt;push(symbol); return true; } } return false; } }; æ€è€ƒè½¬å˜ï¼šä»å•ä¸€ç»„ä»¶çš„ä¼˜åŒ–ï¼Œå‘å±•åˆ°äº†æ•´ä¸ªç³»ç»Ÿçš„èµ„æºåˆ†é…å’Œè´Ÿè½½å‡è¡¡ç­–ç•¥ã€‚\næ€è€ƒè¿‡ç¨‹çš„æ¼”è¿› # å±€éƒ¨åˆ°å…¨å±€ï¼šä»ä¼˜åŒ–å•ä¸€æ•°æ®è¯»å–å™¨çš„æ•ˆç‡ï¼Œæ‰©å±•åˆ°è€ƒè™‘æ•´ä¸ªç³»ç»Ÿçš„æ€§èƒ½å¹³è¡¡ã€‚ å•çº¿ç¨‹åˆ°å¤šçº¿ç¨‹ï¼šè®¤è¯†åˆ°å¤šçº¿ç¨‹å¤„ç†åœ¨æé«˜ç³»ç»Ÿæ•´ä½“ååé‡æ–¹é¢çš„é‡è¦æ€§ã€‚ é™æ€åˆ†é…åˆ°åŠ¨æ€å¹³è¡¡ï¼šä»å›ºå®šçš„å¤„ç†ç­–ç•¥ï¼Œè½¬å‘èƒ½å¤Ÿé€‚åº”å®æ—¶è´Ÿè½½å˜åŒ–çš„åŠ¨æ€ç³»ç»Ÿã€‚ èµ„æºä½¿ç”¨çš„æƒè¡¡ï¼šæ·±å…¥æ€è€ƒå¦‚ä½•åœ¨å…³é”®ç»„ä»¶ï¼ˆå¦‚æ•°æ®è¯»å–å’Œè®¢å•å¤„ç†ï¼‰ä¹‹é—´åˆç†åˆ†é…èµ„æºã€‚ æ€§èƒ½æŒ‡æ ‡çš„å…¨é¢æ€§ï¼šä»ä»…å…³æ³¨æ•°æ®è¯»å–çš„é€Ÿåº¦ï¼Œæ‰©å±•åˆ°è€ƒè™‘ç³»ç»Ÿæ•´ä½“çš„å“åº”æ—¶é—´ã€ååé‡å’Œèµ„æºåˆ©ç”¨ç‡ã€‚ è·¨ç»„ä»¶å½±å“çš„è®¤è¯†ï¼šç†è§£åˆ°ä¸€ä¸ªç»„ä»¶çš„ä¼˜åŒ–å¯èƒ½ä¼šå¯¹å…¶ä»–ç»„ä»¶äº§ç”Ÿæ„æ–™ä¹‹å¤–çš„å½±å“ï¼Œéœ€è¦ä»æ•´ä½“è§’åº¦è¿›è¡Œè¯„ä¼°ã€‚ ç»“è®º #è¿™ä¸ªæ€è€ƒæ¢ç©¶è¿‡ç¨‹å±•ç¤ºäº†å¦‚ä½•ä»è§£å†³å…·ä½“é—®é¢˜é€æ­¥æ‰©å±•åˆ°ç³»ç»Ÿå±‚é¢çš„ä¼˜åŒ–ã€‚å®ƒå¼ºè°ƒäº†åœ¨é«˜é¢‘äº¤æ˜“è¿™æ ·çš„å¤æ‚ç³»ç»Ÿä¸­ï¼Œå±€éƒ¨ä¼˜åŒ–è™½ç„¶é‡è¦ï¼Œä½†å¿…é¡»æ”¾åœ¨æ•´ä½“ç³»ç»Ÿæ€§èƒ½å’Œèµ„æºå¹³è¡¡çš„å¤§èƒŒæ™¯ä¸‹æ¥è€ƒè™‘ã€‚\nè¿™ç§æ€ç»´æ–¹å¼çš„è½¬å˜ä¸ä»…é€‚ç”¨äºå¸‚åœºæ•°æ®è¯»å–å™¨çš„ä¼˜åŒ–ï¼Œä¹Ÿå¯ä»¥åº”ç”¨äºå…¶ä»–å¤æ‚ç³»ç»Ÿçš„æ€§èƒ½ä¼˜åŒ–è¿‡ç¨‹ã€‚å®ƒæé†’æˆ‘ä»¬ï¼Œåœ¨è¿›è¡Œä»»ä½•ä¼˜åŒ–æ—¶ï¼Œéƒ½éœ€è¦è€ƒè™‘ï¼š\nè¿™ä¸ªä¼˜åŒ–å¦‚ä½•å½±å“ç³»ç»Ÿçš„å…¶ä»–éƒ¨åˆ†ï¼Ÿ æˆ‘ä»¬æ˜¯å¦åœ¨æ­£ç¡®çš„å±‚é¢ä¸Šè§£å†³é—®é¢˜ï¼Ÿ å±€éƒ¨çš„é«˜æ•ˆæ˜¯å¦ä¼šå¯¼è‡´å…¨å±€çš„ä½æ•ˆï¼Ÿ å¦‚ä½•è®¾è®¡ä¸€ä¸ªèƒ½å¤Ÿé€‚åº”å˜åŒ–å’Œè‡ªæˆ‘è°ƒèŠ‚çš„ç³»ç»Ÿï¼Ÿ é€šè¿‡è¿™æ ·çš„æ€è€ƒè¿‡ç¨‹ï¼Œæˆ‘ä»¬ä¸ä»…è§£å†³äº†æœ€åˆçš„æ•°æ®è¯»å–æ•ˆç‡é—®é¢˜ï¼Œè¿˜æå‡ºäº†æ›´å…¨é¢ã€æ›´æœ‰å¼¹æ€§çš„ç³»ç»Ÿä¼˜åŒ–æ–¹æ¡ˆï¼Œä¸ºæ„å»ºä¸€ä¸ªé«˜æ€§èƒ½ã€é«˜å¯é æ€§çš„é«˜é¢‘äº¤æ˜“ç³»ç»Ÿå¥ å®šäº†åŸºç¡€ã€‚\n","date":"25 September 2024","permalink":"/blog/2025-06-24-datareader_design_patterns/","section":"Blog","summary":"1. åˆå§‹é—®é¢˜ï¼šæ•°æ®è¯»å–æ•ˆç‡ #æœ€åˆï¼Œæˆ‘ä»¬å…³æ³¨çš„æ˜¯å¸‚åœºæ•°æ®è¯»å–å™¨æœ¬èº«çš„æ•ˆç‡é—®é¢˜ã€‚\n1.1 è½®è¯¢æ–¹å¼ï¼ˆåˆå§‹çŠ¶æ€ï¼‰ #void MarketDataReader::readingLoop() { while (running) { for (const auto\u0026amp; symbol : symbols_) { processSymbol(symbol); } std::this_thread::sleep_for(std::chrono::milliseconds(100)); } } é—®é¢˜ï¼šæŒç»­è½®è¯¢å³ä½¿åœ¨æ²¡æœ‰æ–°æ•°æ®æ—¶ä¹Ÿä¼šæ¶ˆè€—èµ„æºã€‚\n1.2 æ¡ä»¶æ§åˆ¶æ–¹å¼ #void MarketDataReader::readingLoop() { while (running) { std::unique_lock\u0026lt;std::mutex\u0026gt; lock(conditionMutex); dataCondition.wait(lock, [this] { return !running || !symbols_.empty(); }); for (const auto\u0026amp; symbol : symbols_) { processSymbol(symbol); } } } æ”¹è¿›ï¼šå‡å°‘äº†ä¸å¿…è¦çš„CPUä½¿ç”¨ï¼Œä½†å¯èƒ½ä¼šåœ¨é«˜é¢‘æ•°æ®æ›´æ–°æ—¶å¼•å…¥å»¶è¿Ÿã€‚\næ€è€ƒè½¬å˜ï¼šè¿™ä¸ªé˜¶æ®µï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨å¦‚ä½•æé«˜å•ä¸ªç»„ä»¶ï¼ˆæ•°æ®è¯»å–å™¨ï¼‰çš„æ•ˆç‡ã€‚\n2. æ‰©å±•è€ƒè™‘ï¼šæ•°æ®è¯»å–å¯¹å…¶ä»–ç³»ç»Ÿç»„ä»¶çš„å½±å“ #éšç€å¯¹ç³»ç»Ÿçš„æ·±å…¥æ€è€ƒï¼Œæˆ‘ä»¬å¼€å§‹è€ƒè™‘æ•°æ®è¯»å–å™¨çš„è¡Œä¸ºå¦‚ä½•å½±å“æ•´ä¸ªç³»ç»Ÿï¼Œç‰¹åˆ«æ˜¯è®¢å•æµçš„æ‰§è¡Œæ•ˆç‡ã€‚\n2.1 èµ„æºç«äº‰é—®é¢˜ #è§‚å¯Ÿï¼šå°½ç®¡æˆ‘ä»¬ä¼˜åŒ–äº†æ•°æ®è¯»å–å™¨çš„æ•ˆç‡ï¼Œä½†æ•°æ®è¯»å–çº¿ç¨‹å æ®å¤ªå¤šçš„è®¡ç®—èµ„æºï¼Œä¹Ÿä¼šè¿›è€Œå½±å“è®¢å•å¤„ç†çš„æ€§èƒ½ã€‚å³ä½¿åœ¨æ²¡æœ‰æ–°æ•°æ®å¯è¯»æ—¶ï¼Œé¢‘ç¹çš„æ£€æŸ¥ä¹Ÿä¼šå ç”¨å®è´µçš„è®¡ç®—èµ„æºã€‚\næ€è€ƒï¼š\næ•°æ®è¯»å–å’Œè®¢å•å¤„ç†æ˜¯å¦åœ¨ç«äº‰åŒæ ·çš„ç³»ç»Ÿèµ„æºï¼ˆCPUã€å†…å­˜ã€I/Oï¼‰ï¼Ÿ å¦‚ä½•åœ¨ä¿è¯æ•°æ®åŠæ—¶æ€§çš„åŒæ—¶ï¼Œä¸å½±å“è®¢å•å¤„ç†çš„å“åº”é€Ÿåº¦ï¼Ÿ å¦‚ä½•åè°ƒå„ä¸ªçº¿ç¨‹ï¼Œä½¿ç³»ç»Ÿè¾¾åˆ°æœ€ä½çš„æ—¶å»¶ï¼Ÿ 2.2 è‡ªé€‚åº”é—´éš”æœºåˆ¶ #å¼•å…¥åŠ¨æ€è°ƒæ•´å¤„ç†é—´éš”çš„æœºåˆ¶ï¼Œä»¥å¹³è¡¡æ•°æ®è¯»å–å’Œç³»ç»Ÿèµ„æºä½¿ç”¨ã€‚\nvoid MarketDataReader::readingLoop() { while (running) { auto start = std::chrono::steady_clock::now(); for (const auto\u0026amp; symbol : symbols_) { processSymbol(symbol); } auto end = std::chrono::steady_clock::now(); auto duration = std::chrono::duration_cast\u0026lt;std::chrono::microseconds\u0026gt;(end - start); if (duration \u0026lt; currentInterval) { std::this_thread::sleep_for(currentInterval - duration); } adjustInterval(); } } æ€è€ƒè½¬å˜ï¼šä»å•çº¯çš„æ•ˆç‡ä¼˜åŒ–è½¬å‘äº†èµ„æºä½¿ç”¨çš„å¹³è¡¡ï¼Œè€ƒè™‘åˆ°äº†ç³»ç»Ÿçš„æ•´ä½“æ€§èƒ½ã€‚","title":"é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¼˜åŒ–ï¼šä»æ•°æ®è¯»å–åˆ°ç³»ç»Ÿå¹³è¡¡çš„æ€è€ƒè¿‡ç¨‹"},{"content":"é«˜æ€§èƒ½ä½å»¶è¿Ÿäº¤æ˜“ç³»ç»Ÿè®¾è®¡ï¼šæŠ€æœ¯åˆ†äº« update #åœ¨é«˜é¢‘äº¤æ˜“å’Œå®æ—¶é‡‘èç³»ç»Ÿä¸­ï¼Œæ€§èƒ½å’Œå»¶è¿Ÿæ˜¯å…³é”®å› ç´ ã€‚æœ¬æ–‡å°†åˆ†äº«ä¸€äº›è®¾è®¡å’Œå®ç°é«˜æ€§èƒ½ä½å»¶è¿Ÿäº¤æ˜“ç³»ç»Ÿçš„å…³é”®æŠ€æœ¯å’Œç­–ç•¥ã€‚\n1. æ•°æ®ç»“æ„ä¼˜åŒ– #1.1 å†…å­˜æ˜ å°„ï¼ˆMemory-Mappedï¼‰æ–‡ä»¶ #ä½¿ç”¨å†…å­˜æ˜ å°„æ–‡ä»¶å¯ä»¥æ˜¾è‘—æé«˜I/Oæ€§èƒ½ï¼Œå‡å°‘ç³»ç»Ÿè°ƒç”¨ï¼Œå¹¶å…è®¸å¿«é€Ÿçš„è¿›ç¨‹é—´é€šä¿¡ã€‚\nclass MmapOrderBook { // ä½¿ç”¨å†…å­˜æ˜ å°„æ–‡ä»¶å­˜å‚¨è®¢å•ç°¿æ•°æ® }; 1.2 è‡ªå®šä¹‰å†…å­˜æ±  #å®ç°è‡ªå®šä¹‰å†…å­˜æ± å¯ä»¥å‡å°‘å†…å­˜åˆ†é…å’Œé‡Šæ”¾çš„å¼€é”€ï¼Œæé«˜å†…å­˜ä½¿ç”¨æ•ˆç‡ã€‚\ntemplate\u0026lt;typename T, size_t MaxSize\u0026gt; class MemoryPool { // å®ç°é«˜æ•ˆçš„å†…å­˜åˆ†é…å’Œå›æ”¶ }; 2. å¹¶å‘æ§åˆ¶ #2.1 ç»†ç²’åº¦é” #ä½¿ç”¨ç»†ç²’åº¦é”å¯ä»¥å‡å°‘é”ç«äº‰ï¼Œæé«˜å¹¶å‘æ€§èƒ½ã€‚\nstd::array\u0026lt;std::shared_mutex, MAX_POSITIONS\u0026gt; m_positionMutexes; 2.2 æ— é”æ•°æ®ç»“æ„ #åœ¨å…³é”®è·¯å¾„ä¸Šä½¿ç”¨æ— é”æ•°æ®ç»“æ„å¯ä»¥è¿›ä¸€æ­¥å‡å°‘åŒæ­¥å¼€é”€ã€‚\nstd::atomic\u0026lt;double\u0026gt; quantity; std::atomic\u0026lt;double\u0026gt; averagePrice; 3. é«˜æ•ˆçš„æ›´æ–°ç­–ç•¥ #3.1 å¢é‡æ›´æ–° vs å…¨é‡æ›´æ–° #æ ¹æ®å…·ä½“åœºæ™¯é€‰æ‹©åˆé€‚çš„æ›´æ–°ç­–ç•¥ã€‚å¢é‡æ›´æ–°é€‚åˆé¢‘ç¹çš„å°å¹…åº¦å˜åŒ–ï¼Œå…¨é‡æ›´æ–°é€‚åˆå¤§å¹…åº¦å˜åŒ–æˆ–å®šæœŸåŒæ­¥ã€‚\nvoid updatePosition(const char* instId, AssetType type, PositionSide side, double quantityDelta, double price); void syncPositionWithExchange(const char* instId, AssetType type, PositionSide side, double quantity, double price); 3.2 åŸå­æ“ä½œ #ä½¿ç”¨åŸå­æ“ä½œå¯ä»¥åœ¨ä¸ä½¿ç”¨é”çš„æƒ…å†µä¸‹å®ç°çº¿ç¨‹å®‰å…¨çš„æ›´æ–°ã€‚\natomicUpdate(positionPtr-\u0026gt;averagePrice, [newQuantity, quantityDelta, price](double oldAvgPrice) { return (oldAvgPrice * (newQuantity - quantityDelta) + price * quantityDelta) / newQuantity; }); 4. ä»£ç ä¼˜åŒ– #4.1 å†…è”å‡½æ•° #ä½¿ç”¨å†…è”å‡½æ•°å¯ä»¥å‡å°‘å‡½æ•°è°ƒç”¨å¼€é”€ã€‚\ninline void updateAvailable(double delta) { available.fetch_add(delta, std::memory_order_relaxed); } 4.2 åˆ†æ”¯é¢„æµ‹ä¼˜åŒ– #å‡å°‘éš¾ä»¥é¢„æµ‹çš„åˆ†æ”¯ï¼Œåˆ©ç”¨ç°ä»£CPUçš„åˆ†æ”¯é¢„æµ‹åŠŸèƒ½ã€‚\n// é¿å…å¤æ‚çš„åµŒå¥—æ¡ä»¶åˆ¤æ–­ if (type == AssetType::SPOT) { // SPOT é€»è¾‘ } else { // å…¶ä»–ç±»å‹é€»è¾‘ } 5. ç³»ç»Ÿæ¶æ„ #5.1 èŒè´£åˆ†ç¦» #å°†ä¸åŒåŠŸèƒ½æ¨¡å—åˆ†ç¦»ï¼Œå¦‚å°†è®¢å•ç®¡ç†å’ŒæŒä»“ç®¡ç†åˆ†å¼€ï¼Œå¯ä»¥æé«˜ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚\nclass OrderManager { /* ... */ }; class PositionManager { /* ... */ }; 5.2 æœ€å°åŒ–è·¨æ¨¡å—è°ƒç”¨ #å‡å°‘æ¨¡å—é—´çš„é¢‘ç¹è°ƒç”¨ï¼Œå¯ä»¥é™ä½ç³»ç»Ÿå¤æ‚åº¦å’Œå»¶è¿Ÿã€‚\n6. æ€§èƒ½ç›‘æ§å’Œæ—¥å¿— #6.1 é«˜æ•ˆæ—¥å¿— #ä½¿ç”¨å¼‚æ­¥æ—¥å¿—å’Œæ—¥å¿—çº§åˆ«æ§åˆ¶ï¼Œç¡®ä¿æ—¥å¿—ä¸ä¼šæˆä¸ºæ€§èƒ½ç“¶é¢ˆã€‚\nLOG_INFO(\u0026#34;Position updated: instId={}, type={}, side={}\u0026#34;, instId, static_cast\u0026lt;int\u0026gt;(type), static_cast\u0026lt;int\u0026gt;(side)); 6.2 æ€§èƒ½æŒ‡æ ‡ç›‘æ§ #å®æ—¶ç›‘æ§å…³é”®æ€§èƒ½æŒ‡æ ‡ï¼Œå¦‚æ›´æ–°å»¶è¿Ÿã€ååé‡ç­‰ï¼Œä»¥ä¾¿åŠæ—¶å‘ç°å’Œè§£å†³æ€§èƒ½é—®é¢˜ã€‚\nç»“è®º #æ„å»ºé«˜æ€§èƒ½ä½å»¶è¿Ÿçš„äº¤æ˜“ç³»ç»Ÿéœ€è¦åœ¨å¤šä¸ªå±‚é¢è¿›è¡Œä¼˜åŒ–ï¼ŒåŒ…æ‹¬æ•°æ®ç»“æ„ã€å¹¶å‘æ§åˆ¶ã€æ›´æ–°ç­–ç•¥ã€ä»£ç ä¼˜åŒ–å’Œç³»ç»Ÿæ¶æ„ç­‰ã€‚é€šè¿‡ç»¼åˆè¿ç”¨è¿™äº›æŠ€æœ¯ï¼Œå¯ä»¥æ˜¾è‘—æå‡ç³»ç»Ÿçš„æ€§èƒ½å’Œå“åº”é€Ÿåº¦ï¼Œæ»¡è¶³é«˜é¢‘äº¤æ˜“å’Œå®æ—¶é‡‘èç³»ç»Ÿçš„ä¸¥æ ¼è¦æ±‚ã€‚\n","date":"20 September 2024","permalink":"/blog/2025-06-24-high_performance_computing_principles/","section":"Blog","summary":"é«˜æ€§èƒ½ä½å»¶è¿Ÿäº¤æ˜“ç³»ç»Ÿè®¾è®¡ï¼šæŠ€æœ¯åˆ†äº« update #åœ¨é«˜é¢‘äº¤æ˜“å’Œå®æ—¶é‡‘èç³»ç»Ÿä¸­ï¼Œæ€§èƒ½å’Œå»¶è¿Ÿæ˜¯å…³é”®å› ç´ ã€‚æœ¬æ–‡å°†åˆ†äº«ä¸€äº›è®¾è®¡å’Œå®ç°é«˜æ€§èƒ½ä½å»¶è¿Ÿäº¤æ˜“ç³»ç»Ÿçš„å…³é”®æŠ€æœ¯å’Œç­–ç•¥ã€‚\n1. æ•°æ®ç»“æ„ä¼˜åŒ– #1.1 å†…å­˜æ˜ å°„ï¼ˆMemory-Mappedï¼‰æ–‡ä»¶ #ä½¿ç”¨å†…å­˜æ˜ å°„æ–‡ä»¶å¯ä»¥æ˜¾è‘—æé«˜I/Oæ€§èƒ½ï¼Œå‡å°‘ç³»ç»Ÿè°ƒç”¨ï¼Œå¹¶å…è®¸å¿«é€Ÿçš„è¿›ç¨‹é—´é€šä¿¡ã€‚\nclass MmapOrderBook { // ä½¿ç”¨å†…å­˜æ˜ å°„æ–‡ä»¶å­˜å‚¨è®¢å•ç°¿æ•°æ® }; 1.2 è‡ªå®šä¹‰å†…å­˜æ±  #å®ç°è‡ªå®šä¹‰å†…å­˜æ± å¯ä»¥å‡å°‘å†…å­˜åˆ†é…å’Œé‡Šæ”¾çš„å¼€é”€ï¼Œæé«˜å†…å­˜ä½¿ç”¨æ•ˆç‡ã€‚\ntemplate\u0026lt;typename T, size_t MaxSize\u0026gt; class MemoryPool { // å®ç°é«˜æ•ˆçš„å†…å­˜åˆ†é…å’Œå›æ”¶ }; 2. å¹¶å‘æ§åˆ¶ #2.1 ç»†ç²’åº¦é” #ä½¿ç”¨ç»†ç²’åº¦é”å¯ä»¥å‡å°‘é”ç«äº‰ï¼Œæé«˜å¹¶å‘æ€§èƒ½ã€‚\nstd::array\u0026lt;std::shared_mutex, MAX_POSITIONS\u0026gt; m_positionMutexes; 2.2 æ— é”æ•°æ®ç»“æ„ #åœ¨å…³é”®è·¯å¾„ä¸Šä½¿ç”¨æ— é”æ•°æ®ç»“æ„å¯ä»¥è¿›ä¸€æ­¥å‡å°‘åŒæ­¥å¼€é”€ã€‚\nstd::atomic\u0026lt;double\u0026gt; quantity; std::atomic\u0026lt;double\u0026gt; averagePrice; 3. é«˜æ•ˆçš„æ›´æ–°ç­–ç•¥ #3.1 å¢é‡æ›´æ–° vs å…¨é‡æ›´æ–° #æ ¹æ®å…·ä½“åœºæ™¯é€‰æ‹©åˆé€‚çš„æ›´æ–°ç­–ç•¥ã€‚å¢é‡æ›´æ–°é€‚åˆé¢‘ç¹çš„å°å¹…åº¦å˜åŒ–ï¼Œå…¨é‡æ›´æ–°é€‚åˆå¤§å¹…åº¦å˜åŒ–æˆ–å®šæœŸåŒæ­¥ã€‚\nvoid updatePosition(const char* instId, AssetType type, PositionSide side, double quantityDelta, double price); void syncPositionWithExchange(const char* instId, AssetType type, PositionSide side, double quantity, double price); 3.","title":"å®ç°é«˜æ€§èƒ½ä½å»¶è¿Ÿçš„äº¤æ˜“ç³»ç»Ÿè®¾è®¡"},{"content":"åœ¨é«˜é¢‘äº¤æ˜“ç³»ç»Ÿçš„å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸é¢ä¸´ç€æ€§èƒ½å’Œæ­£ç¡®æ€§ä¹‹é—´çš„æƒè¡¡ã€‚æœ€è¿‘ï¼Œæˆ‘ä»¬åœ¨ä¼˜åŒ–è®¢å•å¤„ç†æµç¨‹æ—¶ï¼Œå‘ç°äº†ä¸€ä¸ªæœ‰è¶£çš„é—®é¢˜ï¼šæ˜¯å¦éœ€è¦åœ¨é«˜å±‚ç»„ä»¶ä¸­å®ç°é”å®šï¼Ÿæœ¬æ–‡å°†æ·±å…¥æ¢è®¨è¿™ä¸ªé—®é¢˜ï¼Œåˆ†æå…¶å¿…è¦æ€§ï¼Œå¹¶å±•ç¤ºä¼˜åŒ–å‰åçš„å®ç°ã€‚\nèƒŒæ™¯ æˆ‘ä»¬çš„ç³»ç»Ÿä¸»è¦ç”±ä»¥ä¸‹ç»„ä»¶æ„æˆï¼š\nMmapOrderBookï¼šæ ¸å¿ƒæ•°æ®å­˜å‚¨ï¼Œä½¿ç”¨å†…å­˜æ˜ å°„æ–‡ä»¶å®ç° PositionManagerï¼šè´Ÿè´£ä»“ä½ç®¡ç† OrderValidatorï¼šè´Ÿè´£è®¢å•éªŒè¯ OrderManagerï¼šè´Ÿè´£è®¢å•å¤„ç†æµç¨‹ æœ€åˆï¼Œæˆ‘ä»¬çš„å®ç°å¦‚ä¸‹ï¼š\n// OrderManager.cpp bool OrderManager::processOrder(const MmapOrderBook::Order\u0026amp; order) { if (!orderValidator_-\u0026gt;validateOrder(order)) { return false; } if (orderBook_-\u0026gt;addOrder(order)) { auto position = positionManager_-\u0026gt;getPosition(order.accountId, /* instrumentId */); if (position) { position-\u0026gt;quantity += order.isBuy ? order.quantity : -order.quantity; positionManager_-\u0026gt;updatePosition(*position); } // å‘å¸ƒè®¢å•å·²å¤„ç†äº‹ä»¶ return true; } return false; } é—®é¢˜åˆ†æ è™½ç„¶ MmapOrderBook å†…éƒ¨ä½¿ç”¨äº†åˆ†ç‰‡é”æ¥ä¿è¯å•ä¸ªæ“ä½œçš„çº¿ç¨‹å®‰å…¨ï¼Œä½†æˆ‘ä»¬å‘ç°è¿™ç§æ–¹æ³•åœ¨å¤„ç†å¤åˆæ“ä½œæ—¶å¯èƒ½å­˜åœ¨é—®é¢˜ã€‚ä¸»è¦åŸå› å¦‚ä¸‹ï¼š\na) å¤åˆæ“ä½œçš„åŸå­æ€§ï¼š processOrder æ–¹æ³•åŒ…å«å¤šä¸ªç›¸å…³æ“ä½œï¼ˆéªŒè¯ã€æ·»åŠ ã€æ›´æ–°ä»“ä½ï¼‰ï¼Œè¿™äº›æ“ä½œéœ€è¦ä½œä¸ºä¸€ä¸ªåŸå­å•å…ƒæ‰§è¡Œã€‚\nb) é¿å…ç«æ€æ¡ä»¶ï¼š åœ¨éªŒè¯è®¢å•å’Œæ·»åŠ è®¢å•ä¹‹é—´ï¼Œç³»ç»ŸçŠ¶æ€å¯èƒ½å‘ç”Ÿå˜åŒ–ï¼Œå¯¼è‡´åŸºäºè¿‡æ—¶ä¿¡æ¯åšå‡ºå†³ç­–ã€‚\nc) ä¿æŒä¸å˜é‡ï¼š æŸäº›ä¸šåŠ¡é€»è¾‘ä¾èµ–äºå¤šä¸ªç›¸å…³æ•°æ®çš„ä¸€è‡´çŠ¶æ€ï¼Œéœ€è¦åœ¨æ•´ä¸ªæ“ä½œè¿‡ç¨‹ä¸­ç»´æŠ¤è¿™äº›ä¸å˜é‡ã€‚\nd) ç®€åŒ–å¹¶å‘æ¨¡å‹ï¼š é«˜å±‚é”å®šå¯ä»¥ç®€åŒ–å¹¶å‘æ¨¡å‹ï¼Œä½¿ä»£ç æ›´æ˜“äºç†è§£å’Œç»´æŠ¤ã€‚\ne) é˜²æ­¢æ­»é”ï¼š å¤æ‚æ“ä½œä¸­å¯èƒ½éœ€è¦è·å–å¤šä¸ªä½å±‚é”ï¼Œå¢åŠ æ­»é”é£é™©ã€‚é«˜å±‚é”å¯ä»¥é™ä½è¿™ç§é£é™©ã€‚\nä¼˜åŒ–åçš„å®ç° è€ƒè™‘åˆ°ä¸Šè¿°å› ç´ ï¼Œæˆ‘ä»¬å†³å®šåœ¨ OrderManager å’Œ PositionManager ä¸­å¼•å…¥é«˜å±‚é”å®šï¼š\n// OrderManager.h class OrderManager { public: bool processOrder(const MmapOrderBook::Order\u0026amp; order); private: std::shared_ptr\u0026lt;MmapOrderBook\u0026gt; orderBook_; std::shared_ptr\u0026lt;PositionManager\u0026gt; positionManager_; std::shared_ptr\u0026lt;OrderValidator\u0026gt; orderValidator_; mutable std::shared_mutex mutex_; // æ–°å¢ï¼šè¯»å†™é” }; // OrderManager.cpp bool OrderManager::processOrder(const MmapOrderBook::Order\u0026amp; order) { std::unique_lock\u0026lt;std::shared_mutex\u0026gt; lock(mutex_); // å†™é” if (!orderValidator_-\u0026gt;validateOrder(order)) { return false; } if (orderBook_-\u0026gt;addOrder(order)) { auto position = positionManager_-\u0026gt;getPosition(order.accountId, /* instrumentId */); if (position) { position-\u0026gt;quantity += order.isBuy ? order.quantity : -order.quantity; positionManager_-\u0026gt;updatePosition(*position); } // å‘å¸ƒè®¢å•å·²å¤„ç†äº‹ä»¶ return true; } return false; } // PositionManager.h class PositionManager { public: bool updatePosition(const MmapOrderBook::Position\u0026amp; position); std::optional\u0026lt;MmapOrderBook::Position\u0026gt; getPosition(int64_t accountId, int64_t instrumentId) const; private: std::shared_ptr\u0026lt;MmapOrderBook\u0026gt; orderBook_; mutable std::shared_mutex mutex_; // æ–°å¢ï¼šè¯»å†™é” }; // PositionManager.cpp bool PositionManager::updatePosition(const MmapOrderBook::Position\u0026amp; position) { std::unique_lock\u0026lt;std::shared_mutex\u0026gt; lock(mutex_); // å†™é” return orderBook_-\u0026gt;updatePosition(position); } std::optional\u0026lt;MmapOrderBook::Position\u0026gt; PositionManager::getPosition(int64_t accountId, int64_t instrumentId) const { std::shared_lock\u0026lt;std::shared_mutex\u0026gt; lock(mutex_); // è¯»é” return orderBook_-\u0026gt;getPosition(accountId, instrumentId); } ä¼˜åŒ–æ•ˆæœ é€šè¿‡å¼•å…¥é«˜å±‚é”å®šï¼Œæˆ‘ä»¬å®ç°äº†ä»¥ä¸‹ç›®æ ‡ï¼š\nç¡®ä¿äº†å¤åˆæ“ä½œçš„åŸå­æ€§ æ¶ˆé™¤äº†æ½œåœ¨çš„ç«æ€æ¡ä»¶ ç®€åŒ–äº†å¹¶å‘æ¨¡å‹ï¼Œä½¿ä»£ç æ›´æ˜“ç»´æŠ¤ é™ä½äº†æ­»é”é£é™© æ³¨æ„äº‹é¡¹ å°½ç®¡é«˜å±‚é”å®šè§£å†³äº†è®¸å¤šé—®é¢˜ï¼Œä½†å®ƒä¹Ÿå¸¦æ¥äº†ä¸€äº›æ½œåœ¨çš„æŒ‘æˆ˜ï¼š\næ€§èƒ½å½±å“ï¼šé«˜å±‚é”å¯èƒ½ä¼šé™ä½å¹¶å‘æ€§ï¼Œå› ä¸ºå®ƒä»¬tendä¼šæŒé”æ—¶é—´æ›´é•¿ã€‚ å¯èƒ½çš„è¿‡åº¦åºåˆ—åŒ–ï¼šå¦‚æœé”çš„èŒƒå›´è¿‡å¤§ï¼Œå¯èƒ½ä¼šå¯¼è‡´ä¸€äº›æœ¬å¯ä»¥å¹¶è¡Œçš„æ“ä½œè¢«ä¸å¿…è¦åœ°åºåˆ—åŒ–ã€‚ æ½œåœ¨çš„èµ„æºæµªè´¹ï¼šå¦‚æœé”è¦†ç›–äº†å¤ªå¤šä¸ç›¸å…³çš„æ“ä½œï¼Œå¯èƒ½ä¼šé€ æˆèµ„æºçš„æµªè´¹ã€‚ æœªæ¥ä¼˜åŒ–æ–¹å‘ ä¸ºäº†è¿›ä¸€æ­¥æé«˜ç³»ç»Ÿæ€§èƒ½ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘ä»¥ä¸‹ä¼˜åŒ–æ–¹å‘ï¼š\nå®ç°è½»é‡çº§äº‹åŠ¡æœºåˆ¶ï¼Œå…è®¸å°†å¤šä¸ªæ“ä½œç»„åˆæˆåŸå­å•å…ƒï¼Œè€Œä¸éœ€è¦æŒæœ‰é”é‚£ä¹ˆé•¿æ—¶é—´ã€‚ å°è¯•åœ¨è¾ƒä½å±‚æ¬¡ä¸Šå®ç°æ›´ç»†ç²’åº¦çš„é”ï¼Œåªåœ¨ç»å¯¹å¿…è¦çš„åœ°æ–¹ä½¿ç”¨é«˜å±‚é”ã€‚ è€ƒè™‘ä½¿ç”¨ä¹è§‚å¹¶å‘æ§åˆ¶ï¼Œä½¿ç”¨ç‰ˆæœ¬å·æˆ–æ—¶é—´æˆ³æ¥æ£€æµ‹å¹¶å‘ä¿®æ”¹ã€‚ å¯¹ç‰¹å®šæ“ä½œä½¿ç”¨æ— é”ç®—æ³•æ¥æé«˜å¹¶å‘æ€§ã€‚ è¿›ä¸€æ­¥ä¼˜åŒ–è¯»å†™åˆ†ç¦»ï¼Œå…è®¸æ›´å¤šçš„è¯»æ“ä½œå¹¶å‘è¿›è¡Œã€‚ ç»“è®ºï¼š\nåœ¨é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­ï¼Œé«˜å±‚ç»„ä»¶çš„é”å®šç­–ç•¥å¯¹äºä¿è¯æ•°æ®ä¸€è‡´æ€§å’Œç³»ç»Ÿæ­£ç¡®æ€§è‡³å…³é‡è¦ã€‚é€šè¿‡ä»”ç»†æƒè¡¡å’Œè®¾è®¡ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¿è¯æ­£ç¡®æ€§çš„åŒæ—¶ï¼Œå°½å¯èƒ½åœ°æé«˜ç³»ç»Ÿæ€§èƒ½ã€‚æœ¬æ¬¡ä¼˜åŒ–æ˜¯æˆ‘ä»¬æŒç»­æ”¹è¿›è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªé‡è¦æ­¥éª¤ï¼Œæˆ‘ä»¬å°†ç»§ç»­ç›‘æ§ç³»ç»Ÿæ€§èƒ½ï¼Œå¹¶åœ¨å®è·µä¸­å¯»æ‰¾æœ€ä½³çš„å¹³è¡¡ç‚¹ã€‚\n","date":"18 September 2024","permalink":"/blog/2025-06-24-mutex_performance_analysis/","section":"Blog","summary":"åœ¨é«˜é¢‘äº¤æ˜“ç³»ç»Ÿçš„å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸é¢ä¸´ç€æ€§èƒ½å’Œæ­£ç¡®æ€§ä¹‹é—´çš„æƒè¡¡ã€‚æœ€è¿‘ï¼Œæˆ‘ä»¬åœ¨ä¼˜åŒ–è®¢å•å¤„ç†æµç¨‹æ—¶ï¼Œå‘ç°äº†ä¸€ä¸ªæœ‰è¶£çš„é—®é¢˜ï¼šæ˜¯å¦éœ€è¦åœ¨é«˜å±‚ç»„ä»¶ä¸­å®ç°é”å®šï¼Ÿæœ¬æ–‡å°†æ·±å…¥æ¢è®¨è¿™ä¸ªé—®é¢˜ï¼Œåˆ†æå…¶å¿…è¦æ€§ï¼Œå¹¶å±•ç¤ºä¼˜åŒ–å‰åçš„å®ç°ã€‚\nèƒŒæ™¯ æˆ‘ä»¬çš„ç³»ç»Ÿä¸»è¦ç”±ä»¥ä¸‹ç»„ä»¶æ„æˆï¼š\nMmapOrderBookï¼šæ ¸å¿ƒæ•°æ®å­˜å‚¨ï¼Œä½¿ç”¨å†…å­˜æ˜ å°„æ–‡ä»¶å®ç° PositionManagerï¼šè´Ÿè´£ä»“ä½ç®¡ç† OrderValidatorï¼šè´Ÿè´£è®¢å•éªŒè¯ OrderManagerï¼šè´Ÿè´£è®¢å•å¤„ç†æµç¨‹ æœ€åˆï¼Œæˆ‘ä»¬çš„å®ç°å¦‚ä¸‹ï¼š\n// OrderManager.cpp bool OrderManager::processOrder(const MmapOrderBook::Order\u0026amp; order) { if (!orderValidator_-\u0026gt;validateOrder(order)) { return false; } if (orderBook_-\u0026gt;addOrder(order)) { auto position = positionManager_-\u0026gt;getPosition(order.accountId, /* instrumentId */); if (position) { position-\u0026gt;quantity += order.isBuy ? order.quantity : -order.quantity; positionManager_-\u0026gt;updatePosition(*position); } // å‘å¸ƒè®¢å•å·²å¤„ç†äº‹ä»¶ return true; } return false; } é—®é¢˜åˆ†æ è™½ç„¶ MmapOrderBook å†…éƒ¨ä½¿ç”¨äº†åˆ†ç‰‡é”æ¥ä¿è¯å•ä¸ªæ“ä½œçš„çº¿ç¨‹å®‰å…¨ï¼Œä½†æˆ‘ä»¬å‘ç°è¿™ç§æ–¹æ³•åœ¨å¤„ç†å¤åˆæ“ä½œæ—¶å¯èƒ½å­˜åœ¨é—®é¢˜ã€‚ä¸»è¦åŸå› å¦‚ä¸‹ï¼š\na) å¤åˆæ“ä½œçš„åŸå­æ€§ï¼š processOrder æ–¹æ³•åŒ…å«å¤šä¸ªç›¸å…³æ“ä½œï¼ˆéªŒè¯ã€æ·»åŠ ã€æ›´æ–°ä»“ä½ï¼‰ï¼Œè¿™äº›æ“ä½œéœ€è¦ä½œä¸ºä¸€ä¸ªåŸå­å•å…ƒæ‰§è¡Œã€‚\nb) é¿å…ç«æ€æ¡ä»¶ï¼š åœ¨éªŒè¯è®¢å•å’Œæ·»åŠ è®¢å•ä¹‹é—´ï¼Œç³»ç»ŸçŠ¶æ€å¯èƒ½å‘ç”Ÿå˜åŒ–ï¼Œå¯¼è‡´åŸºäºè¿‡æ—¶ä¿¡æ¯åšå‡ºå†³ç­–ã€‚\nc) ä¿æŒä¸å˜é‡ï¼š æŸäº›ä¸šåŠ¡é€»è¾‘ä¾èµ–äºå¤šä¸ªç›¸å…³æ•°æ®çš„ä¸€è‡´çŠ¶æ€ï¼Œéœ€è¦åœ¨æ•´ä¸ªæ“ä½œè¿‡ç¨‹ä¸­ç»´æŠ¤è¿™äº›ä¸å˜é‡ã€‚\nd) ç®€åŒ–å¹¶å‘æ¨¡å‹ï¼š é«˜å±‚é”å®šå¯ä»¥ç®€åŒ–å¹¶å‘æ¨¡å‹ï¼Œä½¿ä»£ç æ›´æ˜“äºç†è§£å’Œç»´æŠ¤ã€‚\ne) é˜²æ­¢æ­»é”ï¼š å¤æ‚æ“ä½œä¸­å¯èƒ½éœ€è¦è·å–å¤šä¸ªä½å±‚é”ï¼Œå¢åŠ æ­»é”é£é™©ã€‚é«˜å±‚é”å¯ä»¥é™ä½è¿™ç§é£é™©ã€‚","title":"é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­çš„é«˜å±‚é”å®šï¼šå¿…è¦æ€§ä¸å®ç°"},{"content":"é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¼˜åŒ–ï¼šä»WebSocketåˆ°å¸‚åœºæ•°æ®å¤„ç†çš„å…¨é¢è§£æ #åœ¨å½“ä»Šç«äº‰æ¿€çƒˆçš„é‡‘èå¸‚åœºä¸­,é«˜é¢‘äº¤æ˜“(HFT)ç³»ç»Ÿçš„æ€§èƒ½ç›´æ¥å…³ç³»åˆ°äº¤æ˜“ç­–ç•¥çš„æˆåŠŸä¸å¦ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­ä¸¤ä¸ªå…³é”®ç¯èŠ‚çš„ä¼˜åŒ–ï¼šWebSocketæ¶ˆæ¯æ¥æ”¶æœºåˆ¶å’Œå¸‚åœºæ•°æ®å¤„ç†ã€‚æˆ‘ä»¬å°†åˆ†æå½“å‰æœ€ä½³å®è·µ,æ¢è®¨æ½œåœ¨çš„ä¼˜åŒ–æ–¹å‘,å¹¶æä¾›å…·ä½“çš„ä»£ç ç¤ºä¾‹ã€‚\n1. WebSocketæ¶ˆæ¯æ¥æ”¶æœºåˆ¶ä¼˜åŒ– #åœ¨é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­,æ¯ä¸€æ¯«ç§’çš„å»¶è¿Ÿéƒ½å¯èƒ½å¯¼è‡´å·¨å¤§çš„ç»æµæŸå¤±ã€‚å› æ­¤,ä¼˜åŒ–WebSocketæ¶ˆæ¯çš„æ¥æ”¶æœºåˆ¶å¯¹äºç³»ç»Ÿçš„æ•´ä½“æ€§èƒ½è‡³å…³é‡è¦ã€‚\n1.1 WebSocketClientç±»è®¾è®¡ä¸å®ç° #ä»¥ä¸‹æ˜¯ä¸€ä¸ªé«˜æ•ˆçš„WebSocketClientç±»çš„å®ç°ç¤ºä¾‹ï¼š\nclass WebSocketClient { public: using MessageHandler = std::function\u0026lt;void(const char*, size_t)\u0026gt;; WebSocketClient(/* æ„é€ å‡½æ•°å‚æ•° */) : ws_(nullptr), running_(false) {} void receiveMessages(MessageHandler handler) { if (!ws_) { throw std::runtime_error(\u0026#34;WebSocket is not connected\u0026#34;); } constexpr size_t BUFFER_SIZE = 1024 * 1024; // 1MB buffer std::array\u0026lt;char, BUFFER_SIZE\u0026gt; buffer; int flags; while (running_) { try { int n = ws_-\u0026gt;receiveFrame(buffer.data(), buffer.size(), flags); if (n \u0026gt; 0) { handler(buffer.data(), n); } else if (n == 0) { // è¿æ¥å…³é—­ break; } } catch (const Poco::Exception\u0026amp; e) { // ä»…åœ¨å…³é”®é”™è¯¯æ—¶è®°å½•æ—¥å¿— // è€ƒè™‘æ·»åŠ é‡è¿é€»è¾‘ } } } void start() { running_ = true; } void stop() { running_ = false; } private: std::unique_ptr\u0026lt;Poco::Net::WebSocket\u0026gt; ws_; std::atomic\u0026lt;bool\u0026gt; running_; }; 1.2 å…³é”®ä¼˜åŒ–ç‚¹ # å¤§ç¼“å†²åŒº: ä½¿ç”¨1MBçš„ç¼“å†²åŒºå¤§å¹…å‡å°‘ç³»ç»Ÿè°ƒç”¨æ¬¡æ•°,æé«˜ååé‡ã€‚ é›¶æ‹·è´æ¥å£: é€šè¿‡MessageHandlerç›´æ¥ä¼ é€’åŸå§‹æ•°æ®æŒ‡é’ˆå’Œé•¿åº¦,é¿å…ä¸å¿…è¦çš„å†…å­˜æ‹·è´ã€‚ ç®€åŒ–çš„é”™è¯¯å¤„ç†: åªåœ¨å…³é”®é”™è¯¯æ—¶è®°å½•æ—¥å¿—,å‡å°‘æ­£å¸¸æ“ä½œä¸­çš„å¼€é”€ã€‚ åŸå­æ“ä½œæ§åˆ¶: ä½¿ç”¨std::atomic\u0026lt;bool\u0026gt;å®‰å…¨åœ°æ§åˆ¶æ¥æ”¶å¾ªç¯ã€‚ 1.3 åœ¨Quoteè¿›ç¨‹ä¸­çš„åº”ç”¨ #åœ¨Quoteè¿›ç¨‹ä¸­,æˆ‘ä»¬ç›´æ¥åœ¨ä¸»çº¿ç¨‹ä¸­å¤„ç†WebSocketæ¶ˆæ¯,ä»¥æœ€å°åŒ–å»¶è¿Ÿï¼š\nclass QuoteApplication { public: QuoteApplication() : running_(false) { initializeWebSocket(); } void run() { running_ = true; webSocketClient_-\u0026gt;start(); webSocketClient_-\u0026gt;receiveMessages([this](const char* data, size_t length) { this-\u0026gt;handleQuoteMessage(data, length); }); } void stop() { running_ = false; webSocketClient_-\u0026gt;stop(); } private: void initializeWebSocket() { webSocketClient_ = std::make_unique\u0026lt;WebSocketClient\u0026gt;(/* å‚æ•° */); // é…ç½®WebSocketè¿æ¥ } void handleQuoteMessage(const char* data, size_t length) { // å¤„ç†æ¥æ”¶åˆ°çš„å¸‚åœºæ•°æ® // ä¾‹å¦‚:è§£æJSON,æ›´æ–°å…±äº«å†…å­˜ç­‰ } std::atomic\u0026lt;bool\u0026gt; running_; std::unique_ptr\u0026lt;WebSocketClient\u0026gt; webSocketClient_; }; 1.4 åœ¨StrategyAndTradingè¿›ç¨‹ä¸­çš„åº”ç”¨ #åœ¨StrategyAndTradingè¿›ç¨‹ä¸­,æˆ‘ä»¬ä½¿ç”¨ç‹¬ç«‹çš„çº¿ç¨‹æ¥å¤„ç†WebSocketæ¶ˆæ¯,ä»¥é¿å…é˜»å¡ä¸»è¦çš„ç­–ç•¥æ‰§è¡Œé€»è¾‘ï¼š\nclass MessageHandler { public: MessageHandler() : running_(false) {} void start() { if (receiveThread_.joinable()) { throw std::runtime_error(\u0026#34;Receive thread is already running\u0026#34;); } running_ = true; webSocketClient_-\u0026gt;start(); receiveThread_ = std::thread([this]() { webSocketClient_-\u0026gt;receiveMessages([this](const char* data, size_t length) { this-\u0026gt;handleMessage(data, length); }); }); } void stop() { running_ = false; webSocketClient_-\u0026gt;stop(); if (receiveThread_.joinable()) { receiveThread_.join(); } } private: void handleMessage(const char* data, size_t length) { // å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯ // ä¾‹å¦‚:è§£æJSON,æ›´æ–°è®¢å•çŠ¶æ€ç­‰ } std::atomic\u0026lt;bool\u0026gt; running_; std::unique_ptr\u0026lt;WebSocketClient\u0026gt; webSocketClient_; std::thread receiveThread_; }; 2. å¸‚åœºæ•°æ®å¤„ç†ä¼˜åŒ– #åœ¨è·å–äº¤æ˜“æ‰€å¸‚åœºæ•°æ®æ—¶,ä¼ ç»Ÿçš„é˜Ÿåˆ—æ–¹æ³•å¯èƒ½ä¸æ˜¯æœ€ä½³é€‰æ‹©ã€‚è®©æˆ‘ä»¬åˆ†æä½¿ç”¨é˜Ÿåˆ—çš„åˆ©å¼Š,å¹¶æ¢è®¨æ›´é€‚åˆé«˜é¢‘äº¤æ˜“ç³»ç»Ÿçš„æ›¿ä»£æ–¹æ¡ˆã€‚\n2.1 ä½¿ç”¨é˜Ÿåˆ—çš„åŠ£åŠ¿ # é¢å¤–å»¶è¿Ÿ: é˜Ÿåˆ—æ“ä½œå¼•å…¥çš„å»¶è¿Ÿåœ¨HFTä¸­å¯èƒ½é€ æˆæ˜¾è‘—å½±å“ã€‚ å†…å­˜å¼€é”€: é¢å¤–çš„å†…å­˜åˆ†é…å¯èƒ½å¯¼è‡´ç¼“å­˜æœªå‘½ä¸­,è¿›ä¸€æ­¥å¢åŠ å»¶è¿Ÿã€‚ ä¸Šä¸‹æ–‡åˆ‡æ¢: å¤šçº¿ç¨‹ç¯å¢ƒä¸­çš„é¢‘ç¹ä¸Šä¸‹æ–‡åˆ‡æ¢å¢åŠ ç³»ç»Ÿå¼€é”€ã€‚ é¡ºåºå¤„ç†é™åˆ¶: FIFOå¤„ç†å¯èƒ½ä¸é€‚åˆéœ€è¦ä¼˜å…ˆå¤„ç†æŸäº›å…³é”®æ•°æ®çš„åœºæ™¯ã€‚ æ½œåœ¨çš„é”ç«äº‰: é«˜å¹¶å‘æƒ…å†µä¸‹,é˜Ÿåˆ—å¯èƒ½æˆä¸ºç«äº‰çƒ­ç‚¹ã€‚ 2.2 æ›¿ä»£æ–¹æ¡ˆ #2.2.1 æ— é”ç¯å½¢ç¼“å†²åŒº (Lock-free Ring Buffer) #template\u0026lt;typename T, size_t Size\u0026gt; class LockFreeRingBuffer { private: std::array\u0026lt;T, Size\u0026gt; buffer_; std::atomic\u0026lt;size_t\u0026gt; head_{0}; std::atomic\u0026lt;size_t\u0026gt; tail_{0}; public: bool push(const T\u0026amp; item) { size_t current_tail = tail_.load(std::memory_order_relaxed); size_t next_tail = (current_tail + 1) % Size; if (next_tail == head_.load(std::memory_order_acquire)) return false; // Buffer is full buffer_[current_tail] = item; tail_.store(next_tail, std::memory_order_release); return true; } bool pop(T\u0026amp; item) { size_t current_head = head_.load(std::memory_order_relaxed); if (current_head == tail_.load(std::memory_order_acquire)) return false; // Buffer is empty item = buffer_[current_head]; head_.store((current_head + 1) % Size, std::memory_order_release); return true; } }; è¿™ç§æ–¹æ³•å¯ä»¥æ˜¾è‘—å‡å°‘é”ç«äº‰,é™ä½å»¶è¿Ÿã€‚\n2.2.2 ç›´æ¥å¤„ç†æ¨¡å‹ #class MarketDataHandler { public: void onMarketData(const MarketData\u0026amp; data) { // ç›´æ¥å¤„ç†å¸‚åœºæ•°æ® processData(data); } private: void processData(const MarketData\u0026amp; data) { // å®ç°æ•°æ®å¤„ç†é€»è¾‘ } }; ç›´æ¥åœ¨å›è°ƒå‡½æ•°ä¸­å¤„ç†æ•°æ®,é¿å…äº†é˜Ÿåˆ—å¸¦æ¥çš„é¢å¤–å¼€é”€ã€‚\n2.2.3 å†…å­˜æ˜ å°„æ–‡ä»¶ä¸å…±äº«å†…å­˜ #class SharedMemoryManager { public: SharedMemoryManager(const std::string\u0026amp; name, size_t size) : shm_object_(boost::interprocess::open_or_create, name.c_str(), size) , region_(shm_object_.get_address(), shm_object_.get_size()) {} void writeMarketData(const MarketData\u0026amp; data) { // å†™å…¥å…±äº«å†…å­˜ } MarketData readMarketData() { // ä»å…±äº«å†…å­˜è¯»å– } private: boost::interprocess::shared_memory_object shm_object_; boost::interprocess::mapped_region region_; }; ä½¿ç”¨å…±äº«å†…å­˜å¯ä»¥å®ç°æä½å»¶è¿Ÿçš„è¿›ç¨‹é—´é€šä¿¡ã€‚\n3. æ€§èƒ½è€ƒé‡ä¸æœªæ¥ä¼˜åŒ–æ–¹å‘ #3.1 å½“å‰å®ç°çš„ä¼˜åŠ¿ # ä½å»¶è¿Ÿ: é€šè¿‡æœ€å°åŒ–å†…å­˜æ‹·è´å’Œç³»ç»Ÿè°ƒç”¨,å®ç°äº†ä½å»¶è¿Ÿçš„æ¶ˆæ¯å¤„ç†ã€‚ é«˜ååé‡: å¤§ç¼“å†²åŒºè®¾è®¡å…è®¸ç³»ç»Ÿåœ¨é«˜é¢‘ç‡çš„æ¶ˆæ¯æµä¸­ä¿æŒç¨³å®šæ€§ã€‚ çµæ´»æ€§: åŒä¸€ä¸ªWebSocketClientç±»å¯ä»¥åœ¨ä¸åŒçš„è¿›ç¨‹ä¸­ä»¥ä¸åŒçš„æ–¹å¼ä½¿ç”¨ã€‚ æ— é”è®¾è®¡: ä½¿ç”¨æ— é”æ•°æ®ç»“æ„å‡å°‘äº†çº¿ç¨‹ç«äº‰,æé«˜äº†å¹¶å‘æ€§èƒ½ã€‚ 3.2 æ½œåœ¨çš„ä¼˜åŒ–æ–¹å‘ # å†…å­˜æ± : å®ç°è‡ªå®šä¹‰çš„å†…å­˜åˆ†é…å™¨,è¿›ä¸€æ­¥å‡å°‘åŠ¨æ€å†…å­˜åˆ†é…çš„å¼€é”€ã€‚ SIMDæŒ‡ä»¤: åˆ©ç”¨ç°ä»£CPUçš„SIMDæŒ‡ä»¤é›†åŠ é€Ÿæ•°æ®å¤„ç†ã€‚ ç¡¬ä»¶åŠ é€Ÿ: æ¢ç´¢ä½¿ç”¨FPGAæˆ–GPUåŠ é€Ÿç‰¹å®šçš„æ¶ˆæ¯å¤„ç†ä»»åŠ¡ã€‚ ç½‘ç»œä¼˜åŒ–: è€ƒè™‘ä½¿ç”¨å†…æ ¸æ—è·¯æŠ€æœ¯å¦‚DPDK,è¿›ä¸€æ­¥å‡å°‘ç½‘ç»œå»¶è¿Ÿã€‚ æœºå™¨å­¦ä¹ ä¼˜åŒ–: ä½¿ç”¨æœºå™¨å­¦ä¹ æŠ€æœ¯é¢„æµ‹å¸‚åœºæ•°æ®å˜åŒ–,ä¼˜åŒ–å¤„ç†æµç¨‹ã€‚ 4. ç»“è®ºä¸å»ºè®® #é«˜é¢‘äº¤æ˜“ç³»ç»Ÿçš„æ€§èƒ½ä¼˜åŒ–æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹,éœ€è¦ä»å¤šä¸ªå±‚é¢è¿›è¡Œè€ƒè™‘å’Œæ”¹è¿›ã€‚åŸºäºæˆ‘ä»¬çš„åˆ†æ,ä»¥ä¸‹æ˜¯ä¸€äº›å…³é”®å»ºè®®ï¼š\né‡‡ç”¨é›¶æ‹·è´è®¾è®¡: åœ¨æ•´ä¸ªæ•°æ®å¤„ç†æµç¨‹ä¸­,å°½å¯èƒ½å‡å°‘æ•°æ®æ‹·è´æ“ä½œã€‚\nä½¿ç”¨æ— é”æ•°æ®ç»“æ„: åœ¨é«˜å¹¶å‘åœºæ™¯ä¸­,æ— é”æ•°æ®ç»“æ„å¯ä»¥æ˜¾è‘—æé«˜æ€§èƒ½ã€‚\nç›´æ¥å¤„ç†æ¨¡å‹: å¯¹äºå…³é”®è·¯å¾„,è€ƒè™‘ä½¿ç”¨ç›´æ¥å¤„ç†æ¨¡å‹è€Œéé˜Ÿåˆ—ç¼“å†²ã€‚\næ··åˆç­–ç•¥: æ ¹æ®ä¸åŒæ•°æ®æµçš„é‡è¦æ€§å’Œå¤„ç†è¦æ±‚,é‡‡ç”¨ä¸åŒçš„å¤„ç†ç­–ç•¥ã€‚\næŒç»­ç›‘æ§ä¸ä¼˜åŒ–: å®æ–½ä¸¥æ ¼çš„æ€§èƒ½ç›‘æ§,å¹¶æ ¹æ®å®æ—¶æ•°æ®æŒç»­ä¼˜åŒ–ç³»ç»Ÿã€‚\nè€ƒè™‘ç¡¬ä»¶å› ç´ : åœ¨è½¯ä»¶ä¼˜åŒ–çš„åŸºç¡€ä¸Š,æ¢ç´¢ç¡¬ä»¶åŠ é€Ÿçš„å¯èƒ½æ€§ã€‚\nä¿æŒç®€æ´: åœ¨è¿½æ±‚æè‡´æ€§èƒ½çš„åŒæ—¶,ä¿æŒç³»ç»Ÿè®¾è®¡çš„ç®€æ´æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚\nåœ¨é«˜é¢‘äº¤æ˜“çš„ä¸–ç•Œä¸­,æ¯«ç§’çº§ç”šè‡³å¾®ç§’çº§çš„ä¼˜åŒ–å¯èƒ½å¸¦æ¥æ˜¾è‘—çš„ç«äº‰ä¼˜åŠ¿ã€‚é€šè¿‡ç²¾å¿ƒè®¾è®¡çš„WebSocketå®¢æˆ·ç«¯ã€é«˜æ•ˆçš„å¸‚åœºæ•°æ®å¤„ç†æœºåˆ¶,ä»¥åŠä¸æ–­çš„æ€§èƒ½è°ƒä¼˜,æˆ‘ä»¬å¯ä»¥æ„å»ºå‡ºååº”è¿…é€Ÿã€é«˜åº¦å¯é çš„é«˜é¢‘äº¤æ˜“ç³»ç»Ÿã€‚ç„¶è€Œ,ä¼˜åŒ–æ˜¯ä¸€ä¸ªæ°¸æ— æ­¢å¢ƒçš„è¿‡ç¨‹ã€‚éšç€æŠ€æœ¯çš„å‘å±•å’Œå¸‚åœºçš„å˜åŒ–,æˆ‘ä»¬éœ€è¦ä¸æ–­è¯„ä¼°å’Œæ”¹è¿›æˆ‘ä»¬çš„å®ç°,ä»¥ä¿æŒç³»ç»Ÿçš„ç«äº‰åŠ›ã€‚\nåœ¨è¿™ä¸ªç¬æ¯ä¸‡å˜çš„é‡‘èç§‘æŠ€é¢†åŸŸ,å”¯æœ‰æŒç»­å­¦ä¹ å’Œåˆ›æ–°,æ‰èƒ½åœ¨æ¿€çƒˆçš„å¸‚åœºç«äº‰ä¸­ç«‹äºä¸è´¥ä¹‹åœ°ã€‚\n","date":"15 September 2024","permalink":"/blog/2025-06-24-advanced_queue_usage_patterns/","section":"Blog","summary":"é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¼˜åŒ–ï¼šä»WebSocketåˆ°å¸‚åœºæ•°æ®å¤„ç†çš„å…¨é¢è§£æ #åœ¨å½“ä»Šç«äº‰æ¿€çƒˆçš„é‡‘èå¸‚åœºä¸­,é«˜é¢‘äº¤æ˜“(HFT)ç³»ç»Ÿçš„æ€§èƒ½ç›´æ¥å…³ç³»åˆ°äº¤æ˜“ç­–ç•¥çš„æˆåŠŸä¸å¦ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­ä¸¤ä¸ªå…³é”®ç¯èŠ‚çš„ä¼˜åŒ–ï¼šWebSocketæ¶ˆæ¯æ¥æ”¶æœºåˆ¶å’Œå¸‚åœºæ•°æ®å¤„ç†ã€‚æˆ‘ä»¬å°†åˆ†æå½“å‰æœ€ä½³å®è·µ,æ¢è®¨æ½œåœ¨çš„ä¼˜åŒ–æ–¹å‘,å¹¶æä¾›å…·ä½“çš„ä»£ç ç¤ºä¾‹ã€‚\n1. WebSocketæ¶ˆæ¯æ¥æ”¶æœºåˆ¶ä¼˜åŒ– #åœ¨é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­,æ¯ä¸€æ¯«ç§’çš„å»¶è¿Ÿéƒ½å¯èƒ½å¯¼è‡´å·¨å¤§çš„ç»æµæŸå¤±ã€‚å› æ­¤,ä¼˜åŒ–WebSocketæ¶ˆæ¯çš„æ¥æ”¶æœºåˆ¶å¯¹äºç³»ç»Ÿçš„æ•´ä½“æ€§èƒ½è‡³å…³é‡è¦ã€‚\n1.1 WebSocketClientç±»è®¾è®¡ä¸å®ç° #ä»¥ä¸‹æ˜¯ä¸€ä¸ªé«˜æ•ˆçš„WebSocketClientç±»çš„å®ç°ç¤ºä¾‹ï¼š\nclass WebSocketClient { public: using MessageHandler = std::function\u0026lt;void(const char*, size_t)\u0026gt;; WebSocketClient(/* æ„é€ å‡½æ•°å‚æ•° */) : ws_(nullptr), running_(false) {} void receiveMessages(MessageHandler handler) { if (!ws_) { throw std::runtime_error(\u0026#34;WebSocket is not connected\u0026#34;); } constexpr size_t BUFFER_SIZE = 1024 * 1024; // 1MB buffer std::array\u0026lt;char, BUFFER_SIZE\u0026gt; buffer; int flags; while (running_) { try { int n = ws_-\u0026gt;receiveFrame(buffer.data(), buffer.size(), flags); if (n \u0026gt; 0) { handler(buffer.data(), n); } else if (n == 0) { // è¿æ¥å…³é—­ break; } } catch (const Poco::Exception\u0026amp; e) { // ä»…åœ¨å…³é”®é”™è¯¯æ—¶è®°å½•æ—¥å¿— // è€ƒè™‘æ·»åŠ é‡è¿é€»è¾‘ } } } void start() { running_ = true; } void stop() { running_ = false; } private: std::unique_ptr\u0026lt;Poco::Net::WebSocket\u0026gt; ws_; std::atomic\u0026lt;bool\u0026gt; running_; }; 1.","title":"é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¼˜åŒ–ï¼šä»WebSocketåˆ°å¸‚åœºæ•°æ®å¤„ç†çš„å…¨é¢è§£æ"},{"content":"é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­å¸‚åœºæ•°æ®å¤„ç†ï¼šé˜Ÿåˆ—çš„åˆ©å¼Šåˆ†æ #åœ¨é«˜é¢‘äº¤æ˜“ï¼ˆHFTï¼‰ç³»ç»Ÿä¸­ï¼Œå¤„ç†å¸‚åœºæ•°æ®çš„æ–¹å¼ç›´æ¥å½±å“ç€ç³»ç»Ÿçš„æ€§èƒ½å’Œå»¶è¿Ÿã€‚ä½¿ç”¨é˜Ÿåˆ—æ˜¯ä¸€ç§å¸¸è§çš„æ•°æ®å¤„ç†æ–¹æ³•ï¼Œä½†åœ¨è¿½æ±‚æä½å»¶è¿Ÿçš„HFTç³»ç»Ÿä¸­ï¼Œè¿™ç§é€‰æ‹©æ˜¯å¦åˆé€‚éœ€è¦ä»”ç»†è€ƒè™‘ã€‚æœ¬æ–‡å°†åˆ†æä½¿ç”¨é˜Ÿåˆ—çš„åˆ©å¼Šï¼Œå¹¶æ¢è®¨å¯èƒ½çš„æ›¿ä»£æ–¹æ¡ˆã€‚\n1. ä½¿ç”¨é˜Ÿåˆ—çš„ä¼˜åŠ¿ # è§£è€¦å’Œç¼“å†²ï¼šé˜Ÿåˆ—å¯ä»¥æœ‰æ•ˆåœ°è§£è€¦æ•°æ®ç”Ÿäº§è€…ï¼ˆå¦‚å¸‚åœºæ•°æ®æºï¼‰å’Œæ¶ˆè´¹è€…ï¼ˆå¦‚ç­–ç•¥å¼•æ“ï¼‰ï¼Œæä¾›ä¸€ä¸ªç¼“å†²åŒºæ¥å¤„ç†çªå‘çš„æ•°æ®æµã€‚\nè´Ÿè½½å‡è¡¡ï¼šåœ¨å¤šçº¿ç¨‹å¤„ç†ä¸­ï¼Œé˜Ÿåˆ—å¯ä»¥å¸®åŠ©åˆ†é…å·¥ä½œè´Ÿè½½ï¼Œé˜²æ­¢æŸä¸ªå¤„ç†å•å…ƒè¿‡è½½ã€‚\nç®€åŒ–è®¾è®¡ï¼šé˜Ÿåˆ—æä¾›äº†ä¸€ä¸ªç›´è§‚çš„æ•°æ®æµæ¨¡å‹ï¼Œå¯ä»¥ç®€åŒ–ç³»ç»Ÿçš„æ•´ä½“è®¾è®¡ã€‚\nå®¹é”™æ€§ï¼šé˜Ÿåˆ—å¯ä»¥å¸®åŠ©ç³»ç»Ÿæ›´å¥½åœ°å¤„ç†æš‚æ—¶çš„å¤„ç†é€Ÿåº¦ä¸åŒ¹é…ï¼Œå¢å¼ºç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚\n2. ä½¿ç”¨é˜Ÿåˆ—çš„åŠ£åŠ¿ # é¢å¤–å»¶è¿Ÿï¼šé˜Ÿåˆ—æ“ä½œï¼ˆå…¥é˜Ÿå’Œå‡ºé˜Ÿï¼‰ä¼šå¼•å…¥é¢å¤–çš„å»¶è¿Ÿï¼Œå³ä½¿æ˜¯å‡ å¾®ç§’çš„å»¶è¿Ÿåœ¨HFTä¸­ä¹Ÿå¯èƒ½é€ æˆæ˜¾è‘—å½±å“ã€‚\nå†…å­˜å¼€é”€ï¼šé˜Ÿåˆ—éœ€è¦é¢å¤–çš„å†…å­˜åˆ†é…ï¼Œè¿™å¯èƒ½å¯¼è‡´ç¼“å­˜æœªå‘½ä¸­ï¼Œè¿›ä¸€æ­¥å¢åŠ å»¶è¿Ÿã€‚\nä¸Šä¸‹æ–‡åˆ‡æ¢ï¼šåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œé˜Ÿåˆ—æ“ä½œå¯èƒ½å¯¼è‡´é¢‘ç¹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå¢åŠ ç³»ç»Ÿå¼€é”€ã€‚\né¡ºåºå¤„ç†é™åˆ¶ï¼šé˜Ÿåˆ—é€šå¸¸æŒ‰FIFOé¡ºåºå¤„ç†æ•°æ®ï¼Œè¿™å¯èƒ½ä¸é€‚åˆéœ€è¦ä¼˜å…ˆå¤„ç†æŸäº›å…³é”®æ•°æ®çš„åœºæ™¯ã€‚\næ½œåœ¨çš„é”ç«äº‰ï¼šåœ¨é«˜å¹¶å‘æƒ…å†µä¸‹ï¼Œé˜Ÿåˆ—å¯èƒ½æˆä¸ºç«äº‰çƒ­ç‚¹ï¼Œå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚\n3. æ›¿ä»£æ–¹æ¡ˆ #è€ƒè™‘åˆ°é˜Ÿåˆ—å¯èƒ½å¼•å…¥çš„å»¶è¿Ÿï¼Œä»¥ä¸‹æ˜¯ä¸€äº›å¯èƒ½çš„æ›¿ä»£æ–¹æ¡ˆï¼š\n3.1 æ— é”ç¯å½¢ç¼“å†²åŒºï¼ˆLock-free Ring Bufferï¼‰ #template\u0026lt;typename T, size_t Size\u0026gt; class LockFreeRingBuffer { private: std::array\u0026lt;T, Size\u0026gt; buffer_; std::atomic\u0026lt;size_t\u0026gt; head_{0}; std::atomic\u0026lt;size_t\u0026gt; tail_{0}; public: bool push(const T\u0026amp; item) { size_t current_tail = tail_.load(std::memory_order_relaxed); size_t next_tail = (current_tail + 1) % Size; if (next_tail == head_.load(std::memory_order_acquire)) return false; // Buffer is full buffer_[current_tail] = item; tail_.store(next_tail, std::memory_order_release); return true; } bool pop(T\u0026amp; item) { size_t current_head = head_.load(std::memory_order_relaxed); if (current_head == tail_.load(std::memory_order_acquire)) return false; // Buffer is empty item = buffer_[current_head]; head_.store((current_head + 1) % Size, std::memory_order_release); return true; } }; è¿™ç§æ–¹æ³•å¯ä»¥æ˜¾è‘—å‡å°‘é”ç«äº‰ï¼Œé™ä½å»¶è¿Ÿã€‚\n3.2 ç›´æ¥å¤„ç†æ¨¡å‹ #class MarketDataHandler { public: void onMarketData(const MarketData\u0026amp; data) { // ç›´æ¥å¤„ç†å¸‚åœºæ•°æ® processData(data); } private: void processData(const MarketData\u0026amp; data) { // å®ç°æ•°æ®å¤„ç†é€»è¾‘ } }; ç›´æ¥åœ¨å›è°ƒå‡½æ•°ä¸­å¤„ç†æ•°æ®ï¼Œé¿å…äº†é˜Ÿåˆ—å¸¦æ¥çš„é¢å¤–å¼€é”€ã€‚\n3.3 å†…å­˜æ˜ å°„æ–‡ä»¶ä¸å…±äº«å†…å­˜ #class SharedMemoryManager { public: SharedMemoryManager(const std::string\u0026amp; name, size_t size) : shm_object_(boost::interprocess::open_or_create, name.c_str(), size) , region_(shm_object_.get_address(), shm_object_.get_size()) {} void writeMarketData(const MarketData\u0026amp; data) { // å†™å…¥å…±äº«å†…å­˜ } MarketData readMarketData() { // ä»å…±äº«å†…å­˜è¯»å– } private: boost::interprocess::shared_memory_object shm_object_; boost::interprocess::mapped_region region_; }; ä½¿ç”¨å…±äº«å†…å­˜å¯ä»¥å®ç°æä½å»¶è¿Ÿçš„è¿›ç¨‹é—´é€šä¿¡ã€‚\n4. ç»“è®ºä¸å»ºè®® #å¯¹äºè¿½æ±‚æä½å»¶è¿Ÿçš„é«˜é¢‘äº¤æ˜“ç³»ç»Ÿï¼Œä½¿ç”¨ä¼ ç»Ÿé˜Ÿåˆ—å¤„ç†å¸‚åœºæ•°æ®å¯èƒ½ä¸æ˜¯æœ€ä½³é€‰æ‹©ã€‚è™½ç„¶é˜Ÿåˆ—æä¾›äº†è‰¯å¥½çš„è§£è€¦å’Œç¼“å†²åŠŸèƒ½ï¼Œä½†å®ƒå¼•å…¥çš„é¢å¤–å»¶è¿Ÿå¯èƒ½å¯¹ç³»ç»Ÿæ€§èƒ½é€ æˆæ˜¾è‘—å½±å“ã€‚\nå»ºè®®ï¼š\nè¯„ä¼°ç³»ç»Ÿéœ€æ±‚ï¼šä»”ç»†è¯„ä¼°ç³»ç»Ÿçš„å…·ä½“éœ€æ±‚ï¼ŒåŒ…æ‹¬å»¶è¿Ÿè¦æ±‚ã€æ•°æ®å¤„ç†é‡ã€ç³»ç»Ÿå¤æ‚åº¦ç­‰ã€‚\nè€ƒè™‘æ··åˆæ–¹æ¡ˆï¼šå¯¹äºå…³é”®è·¯å¾„ï¼Œä½¿ç”¨ç›´æ¥å¤„ç†æˆ–æ— é”æ•°æ®ç»“æ„ï¼›å¯¹äºæ¬¡è¦è·¯å¾„ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨é˜Ÿåˆ—æ¥å¹³è¡¡æ€§èƒ½å’Œç³»ç»Ÿå¤æ‚åº¦ã€‚\næ€§èƒ½æµ‹è¯•ï¼šå®æ–½ä¸¥æ ¼çš„æ€§èƒ½æµ‹è¯•ï¼Œæ¯”è¾ƒä¸åŒæ–¹æ¡ˆåœ¨å®é™…ç¯å¢ƒä¸­çš„è¡¨ç°ã€‚\næŒç»­ä¼˜åŒ–ï¼šéšç€ç³»ç»Ÿçš„æ¼”è¿›å’Œéœ€æ±‚çš„å˜åŒ–ï¼ŒæŒç»­è¯„ä¼°å’Œä¼˜åŒ–æ•°æ®å¤„ç†æ–¹å¼ã€‚\nå®šåˆ¶åŒ–è§£å†³æ–¹æ¡ˆï¼šè€ƒè™‘å¼€å‘é’ˆå¯¹ç‰¹å®šéœ€æ±‚çš„å®šåˆ¶åŒ–æ•°æ®ç»“æ„å’Œå¤„ç†æœºåˆ¶ã€‚\nåœ¨é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­ï¼Œæ¯ä¸€å¾®ç§’çš„å»¶è¿Ÿéƒ½å¯èƒ½è½¬åŒ–ä¸ºå®é™…çš„ç»æµæŸå¤±ã€‚å› æ­¤ï¼Œåœ¨è®¾è®¡ç³»ç»Ÿæ—¶ï¼Œéœ€è¦åœ¨åŠŸèƒ½ã€æ€§èƒ½å’Œå¤æ‚åº¦ä¹‹é—´æ‰¾åˆ°æœ€ä½³å¹³è¡¡ç‚¹ã€‚ç›´æ¥å¤„ç†æ¨¡å‹æˆ–é«˜åº¦ä¼˜åŒ–çš„æ— é”æ•°æ®ç»“æ„é€šå¸¸æ˜¯å¤„ç†å¸‚åœºæ•°æ®çš„æ›´å¥½é€‰æ‹©ï¼Œä½†å…·ä½“å®ç°éœ€è¦æ ¹æ®ç³»ç»Ÿçš„ç‰¹å®šéœ€æ±‚å’Œçº¦æŸæ¥å†³å®šã€‚\n","date":"15 September 2024","permalink":"/blog/2025-06-24-queue_usage_patterns/","section":"Blog","summary":"é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­å¸‚åœºæ•°æ®å¤„ç†ï¼šé˜Ÿåˆ—çš„åˆ©å¼Šåˆ†æ #åœ¨é«˜é¢‘äº¤æ˜“ï¼ˆHFTï¼‰ç³»ç»Ÿä¸­ï¼Œå¤„ç†å¸‚åœºæ•°æ®çš„æ–¹å¼ç›´æ¥å½±å“ç€ç³»ç»Ÿçš„æ€§èƒ½å’Œå»¶è¿Ÿã€‚ä½¿ç”¨é˜Ÿåˆ—æ˜¯ä¸€ç§å¸¸è§çš„æ•°æ®å¤„ç†æ–¹æ³•ï¼Œä½†åœ¨è¿½æ±‚æä½å»¶è¿Ÿçš„HFTç³»ç»Ÿä¸­ï¼Œè¿™ç§é€‰æ‹©æ˜¯å¦åˆé€‚éœ€è¦ä»”ç»†è€ƒè™‘ã€‚æœ¬æ–‡å°†åˆ†æä½¿ç”¨é˜Ÿåˆ—çš„åˆ©å¼Šï¼Œå¹¶æ¢è®¨å¯èƒ½çš„æ›¿ä»£æ–¹æ¡ˆã€‚\n1. ä½¿ç”¨é˜Ÿåˆ—çš„ä¼˜åŠ¿ # è§£è€¦å’Œç¼“å†²ï¼šé˜Ÿåˆ—å¯ä»¥æœ‰æ•ˆåœ°è§£è€¦æ•°æ®ç”Ÿäº§è€…ï¼ˆå¦‚å¸‚åœºæ•°æ®æºï¼‰å’Œæ¶ˆè´¹è€…ï¼ˆå¦‚ç­–ç•¥å¼•æ“ï¼‰ï¼Œæä¾›ä¸€ä¸ªç¼“å†²åŒºæ¥å¤„ç†çªå‘çš„æ•°æ®æµã€‚\nè´Ÿè½½å‡è¡¡ï¼šåœ¨å¤šçº¿ç¨‹å¤„ç†ä¸­ï¼Œé˜Ÿåˆ—å¯ä»¥å¸®åŠ©åˆ†é…å·¥ä½œè´Ÿè½½ï¼Œé˜²æ­¢æŸä¸ªå¤„ç†å•å…ƒè¿‡è½½ã€‚\nç®€åŒ–è®¾è®¡ï¼šé˜Ÿåˆ—æä¾›äº†ä¸€ä¸ªç›´è§‚çš„æ•°æ®æµæ¨¡å‹ï¼Œå¯ä»¥ç®€åŒ–ç³»ç»Ÿçš„æ•´ä½“è®¾è®¡ã€‚\nå®¹é”™æ€§ï¼šé˜Ÿåˆ—å¯ä»¥å¸®åŠ©ç³»ç»Ÿæ›´å¥½åœ°å¤„ç†æš‚æ—¶çš„å¤„ç†é€Ÿåº¦ä¸åŒ¹é…ï¼Œå¢å¼ºç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚\n2. ä½¿ç”¨é˜Ÿåˆ—çš„åŠ£åŠ¿ # é¢å¤–å»¶è¿Ÿï¼šé˜Ÿåˆ—æ“ä½œï¼ˆå…¥é˜Ÿå’Œå‡ºé˜Ÿï¼‰ä¼šå¼•å…¥é¢å¤–çš„å»¶è¿Ÿï¼Œå³ä½¿æ˜¯å‡ å¾®ç§’çš„å»¶è¿Ÿåœ¨HFTä¸­ä¹Ÿå¯èƒ½é€ æˆæ˜¾è‘—å½±å“ã€‚\nå†…å­˜å¼€é”€ï¼šé˜Ÿåˆ—éœ€è¦é¢å¤–çš„å†…å­˜åˆ†é…ï¼Œè¿™å¯èƒ½å¯¼è‡´ç¼“å­˜æœªå‘½ä¸­ï¼Œè¿›ä¸€æ­¥å¢åŠ å»¶è¿Ÿã€‚\nä¸Šä¸‹æ–‡åˆ‡æ¢ï¼šåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œé˜Ÿåˆ—æ“ä½œå¯èƒ½å¯¼è‡´é¢‘ç¹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå¢åŠ ç³»ç»Ÿå¼€é”€ã€‚\né¡ºåºå¤„ç†é™åˆ¶ï¼šé˜Ÿåˆ—é€šå¸¸æŒ‰FIFOé¡ºåºå¤„ç†æ•°æ®ï¼Œè¿™å¯èƒ½ä¸é€‚åˆéœ€è¦ä¼˜å…ˆå¤„ç†æŸäº›å…³é”®æ•°æ®çš„åœºæ™¯ã€‚\næ½œåœ¨çš„é”ç«äº‰ï¼šåœ¨é«˜å¹¶å‘æƒ…å†µä¸‹ï¼Œé˜Ÿåˆ—å¯èƒ½æˆä¸ºç«äº‰çƒ­ç‚¹ï¼Œå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚\n3. æ›¿ä»£æ–¹æ¡ˆ #è€ƒè™‘åˆ°é˜Ÿåˆ—å¯èƒ½å¼•å…¥çš„å»¶è¿Ÿï¼Œä»¥ä¸‹æ˜¯ä¸€äº›å¯èƒ½çš„æ›¿ä»£æ–¹æ¡ˆï¼š\n3.1 æ— é”ç¯å½¢ç¼“å†²åŒºï¼ˆLock-free Ring Bufferï¼‰ #template\u0026lt;typename T, size_t Size\u0026gt; class LockFreeRingBuffer { private: std::array\u0026lt;T, Size\u0026gt; buffer_; std::atomic\u0026lt;size_t\u0026gt; head_{0}; std::atomic\u0026lt;size_t\u0026gt; tail_{0}; public: bool push(const T\u0026amp; item) { size_t current_tail = tail_.load(std::memory_order_relaxed); size_t next_tail = (current_tail + 1) % Size; if (next_tail == head_.load(std::memory_order_acquire)) return false; // Buffer is full buffer_[current_tail] = item; tail_.","title":"é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­å¸‚åœºæ•°æ®å¤„ç†ï¼šé˜Ÿåˆ—çš„åˆ©å¼Šåˆ†æ"},{"content":"æ•…éšœå¤ç›˜æŠ¥å‘Šï¼šå†…å­˜æ˜ å°„æ–‡ä»¶ä¸­çš„ std::string å¯¼è‡´çš„æ®µé”™è¯¯ #1. é—®é¢˜æè¿° #åœ¨ä½¿ç”¨å†…å­˜æ˜ å°„æ–‡ä»¶å­˜å‚¨è®¢å•æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼Œç¨‹åºåœ¨é‡å¯åå‡ºç°æ®µé”™è¯¯ã€‚å…·ä½“è¡¨ç°ä¸ºåœ¨å°è¯•è®¿é—®å­˜å‚¨åœ¨å†…å­˜æ˜ å°„æ–‡ä»¶ä¸­çš„ Order ç»“æ„ä½“çš„ id å­—æ®µæ—¶ï¼Œç¨‹åºå´©æºƒã€‚\n2. é”™è¯¯ä¿¡æ¯ #ç¨‹åºå´©æºƒæ—¶çš„ GDB è°ƒè¯•ä¿¡æ¯å¦‚ä¸‹ï¼š\nThread 2 \u0026#34;strategyandtrad\u0026#34; received signal SIGSEGV, Segmentation fault. [Switching to Thread 0x7ffff6f4c6c0 (LWP 446582)] __memcmp_sse2 () at ../sysdeps/x86_64/multiarch/memcmp-sse2.S:258 258 ../sysdeps/x86_64/multiarch/memcmp-sse2.S: No such file or directory. (gdb) bt #0 __memcmp_sse2 () at ../sysdeps/x86_64/multiarch/memcmp-sse2.S:258 #1 0x000055555556d79b in std::char_traits\u0026lt;char\u0026gt;::compare (__s1=0x7f4710000eb0 \u0026lt;error: Cannot access memory at address 0x7f4710000eb0\u0026gt;, __s2=0x7fffe8000c80 \u0026#34;ORD-1726124231791862593\u0026#34;, __n=23) at /usr/include/c++/12/bits/char_traits.h:385 #2 0x000055555559c599 in std::operator==\u0026lt;char\u0026gt; (__lhs=\u0026lt;error: Cannot access memory at address 0x7f4710000eb0\u0026gt;, __rhs=\u0026#34;ORD-1726124231791862593\u0026#34;) at /usr/include/c++/12/bits/basic_string.h:3587 #3 0x000055555561a7fa in MmapOrderBook::Impl::getOrder (this=0x555555776170, orderId=\u0026#34;ORD-1726124231791862593\u0026#34;) at /home/hft_trading_system/strategyandtradingwitheventbus/src/order_management/mmap_order_book_impl.cpp:211 ... (gdb) frame 3 #3 0x000055555561a7fa in MmapOrderBook::Impl::getOrder (this=0x555555776170, orderId=\u0026#34;ORD-1726124231791862593\u0026#34;) at /home/hft_trading_system/strategyandtradingwitheventbus/src/order_management/mmap_order_book_impl.cpp:211 211 if (m_orders[i].id == orderId) { (gdb) print orderId $1 = \u0026#34;ORD-1726124231791862593\u0026#34; (gdb) print m_orders[i].id $2 = \u0026lt;error: Cannot access memory at address 0x7f4710000eb0\u0026gt; (gdb) print m_orders[i] $3 = {id = \u0026lt;error: Cannot access memory at address 0x7f4710000eb0\u0026gt;, instId = \u0026lt;error: Cannot access memory at address 0x7f4710000ed0\u0026gt;, price = 58126.699999999997, quantity = 100, status = 3} ç›¸å…³ä»£ç  struct Order { std::string id; std::string instId; double price; double quantity; int status; // 0: pending, 1: filled, 2: cancelled }; è¿™ä¸ªç»“æ„ä½“ç›´æ¥åœ¨å†…å­˜æ˜ å°„æ–‡ä»¶ä¸­ä½¿ç”¨ï¼Œå¯¼è‡´äº†æˆ‘ä»¬é‡åˆ°çš„é—®é¢˜ã€‚\n4. é—®é¢˜åˆ†æ #é€šè¿‡åˆ†æé”™è¯¯ä¿¡æ¯å’Œä»£ç ç»“æ„ï¼Œæˆ‘ä»¬å‘ç°ï¼š\nç¨‹åºå´©æºƒå‘ç”Ÿåœ¨æ¯”è¾ƒ m_orders[i].id å’Œ orderId æ—¶ã€‚ æ— æ³•è®¿é—® m_orders[i].id çš„å†…å­˜åœ°å€ï¼ˆ0x7f4710000eb0ï¼‰ã€‚ Order ç»“æ„ä½“ä¸­çš„ id å’Œ instId å­—æ®µä½¿ç”¨äº† std::string ç±»å‹ã€‚ é—®é¢˜çš„æ ¹æœ¬åŸå› æ˜¯ï¼šstd::string æ˜¯ä¸€ä¸ªå¤æ‚å¯¹è±¡ï¼ŒåŒ…å«æŒ‡å‘å †å†…å­˜çš„æŒ‡é’ˆã€‚å½“ç¨‹åºé€€å‡ºåï¼Œè¿™äº›æŒ‡é’ˆæ‰€æŒ‡å‘çš„å†…å­˜ä¸å†æœ‰æ•ˆã€‚é‡æ–°å¯åŠ¨ç¨‹åºå¹¶å°è¯•è®¿é—®å†…å­˜æ˜ å°„æ–‡ä»¶ä¸­çš„è¿™äº› std::string å¯¹è±¡æ—¶ï¼Œå°±ä¼šå¯¼è‡´æ®µé”™è¯¯ã€‚\n5. è§£å†³æ–¹æ¡ˆ #å°† Order ç»“æ„ä½“ä¸­çš„ std::string ç±»å‹æ›¿æ¢ä¸ºå›ºå®šå¤§å°çš„å­—ç¬¦æ•°ç»„ï¼š\nconstexpr size_t MAX_ID_LENGTH = 64; constexpr size_t MAX_INST_ID_LENGTH = 32; struct Order { char id[MAX_ID_LENGTH]; char instId[MAX_INST_ID_LENGTH]; double price; double quantity; int status; // æ„é€ å‡½æ•°å’Œè¾…åŠ©æ–¹æ³•... }; åŒæ—¶ï¼Œæ·»åŠ è¾…åŠ©æ–¹æ³•æ¥æ–¹ä¾¿åœ°è®¾ç½®å’Œè·å–è¿™äº›å­—æ®µçš„å€¼ï¼š\nvoid setId(const std::string\u0026amp; newId) { strncpy(id, newId.c_str(), MAX_ID_LENGTH - 1); id[MAX_ID_LENGTH - 1] = \u0026#39;\\0\u0026#39;; } std::string getId() const { return std::string(id); } // ç±»ä¼¼åœ°å®ç° setInstId å’Œ getInstId 6. å®æ–½æ­¥éª¤ # ä¿®æ”¹ Order ç»“æ„ä½“çš„å®šä¹‰ã€‚ æ›´æ–°æ‰€æœ‰ä½¿ç”¨ Order ç»“æ„ä½“çš„ä»£ç ï¼Œä½¿ç”¨æ–°çš„ setter å’Œ getter æ–¹æ³•ã€‚ åˆ é™¤æ—§çš„å†…å­˜æ˜ å°„æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œå› ä¸ºæ–°çš„ç»“æ„ä½“å¸ƒå±€ä¸æ—§çš„ä¸å…¼å®¹ã€‚ é‡æ–°ç¼–è¯‘æ•´ä¸ªé¡¹ç›®ã€‚ è¿è¡Œæµ‹è¯•ï¼Œç¡®ä¿é—®é¢˜å·²è§£å†³ä¸”æ²¡æœ‰å¼•å…¥æ–°çš„é—®é¢˜ã€‚ 7. ç»éªŒæ•™è®­ # åœ¨ä½¿ç”¨å†…å­˜æ˜ å°„æ–‡ä»¶æ—¶ï¼Œåº”é¿å…ç›´æ¥å­˜å‚¨åŒ…å«æŒ‡é’ˆæˆ–å¤æ‚å¯¹è±¡ï¼ˆå¦‚ std::stringï¼‰çš„ç»“æ„ä½“ã€‚ å¯¹äºéœ€è¦æŒä¹…åŒ–çš„æ•°æ®ç»“æ„ï¼Œä¼˜å…ˆä½¿ç”¨å›ºå®šå¤§å°çš„æ•°ç»„æˆ–åŸºæœ¬æ•°æ®ç±»å‹ã€‚ åœ¨è®¾è®¡æŒä¹…åŒ–æ•°æ®ç»“æ„æ—¶ï¼Œè€ƒè™‘è·¨ä¼šè¯å’Œè·¨è¿›ç¨‹çš„å…¼å®¹æ€§ã€‚ å¢åŠ æ›´å¤šçš„é”™è¯¯æ£€æŸ¥å’Œæ—¥å¿—è®°å½•ï¼Œä»¥ä¾¿æ›´å®¹æ˜“åœ°è¯Šæ–­ç±»ä¼¼é—®é¢˜ã€‚ 8. åç»­è¡ŒåŠ¨ # å®¡æŸ¥å…¶ä»–ä½¿ç”¨å†…å­˜æ˜ å°„æ–‡ä»¶çš„ä»£ç ï¼Œç¡®ä¿æ²¡æœ‰ç±»ä¼¼çš„æ½œåœ¨é—®é¢˜ã€‚ è€ƒè™‘å®ç°ä¸€ä¸ªæ•°æ®å®Œæ•´æ€§æ£€æŸ¥æœºåˆ¶ï¼Œåœ¨ç¨‹åºå¯åŠ¨æ—¶éªŒè¯å†…å­˜æ˜ å°„æ–‡ä»¶çš„å†…å®¹ã€‚ æ›´æ–°å¼€å‘æŒ‡å—ï¼Œå¼ºè°ƒåœ¨ä½¿ç”¨å†…å­˜æ˜ å°„æ–‡ä»¶æ—¶åº”æ³¨æ„çš„äº‹é¡¹ã€‚ è€ƒè™‘å®ç°ä¸€ä¸ªç‰ˆæœ¬æ§åˆ¶æœºåˆ¶ï¼Œä»¥ä¾¿åœ¨æœªæ¥éœ€è¦æ›´æ”¹æ•°æ®ç»“æ„æ—¶èƒ½å¤Ÿå¹³æ»‘è¿ç§»ã€‚ Incident Report: Segmentation Fault Caused by std::string in Memory-Mapped File #1. Problem Description #The program experienced a segmentation fault after restart when attempting to access order data stored in a memory-mapped file. Specifically, the crash occurred when trying to access the id field of the Order struct stored in the memory-mapped file.\n2. Error Information #The GDB debug information at the time of the crash was as follows:\nThread 2 \u0026#34;strategyandtrad\u0026#34; received signal SIGSEGV, Segmentation fault. [Switching to Thread 0x7ffff6f4c6c0 (LWP 446582)] __memcmp_sse2 () at ../sysdeps/x86_64/multiarch/memcmp-sse2.S:258 258 ../sysdeps/x86_64/multiarch/memcmp-sse2.S: No such file or directory. (gdb) bt #0 __memcmp_sse2 () at ../sysdeps/x86_64/multiarch/memcmp-sse2.S:258 #1 0x000055555556d79b in std::char_traits\u0026lt;char\u0026gt;::compare (__s1=0x7f4710000eb0 \u0026lt;error: Cannot access memory at address 0x7f4710000eb0\u0026gt;, __s2=0x7fffe8000c80 \u0026#34;ORD-1726124231791862593\u0026#34;, __n=23) at /usr/include/c++/12/bits/char_traits.h:385 #2 0x000055555559c599 in std::operator==\u0026lt;char\u0026gt; (__lhs=\u0026lt;error: Cannot access memory at address 0x7f4710000eb0\u0026gt;, __rhs=\u0026#34;ORD-1726124231791862593\u0026#34;) at /usr/include/c++/12/bits/basic_string.h:3587 #3 0x000055555561a7fa in MmapOrderBook::Impl::getOrder (this=0x555555776170, orderId=\u0026#34;ORD-1726124231791862593\u0026#34;) at /home/hft_trading_system/strategyandtradingwitheventbus/src/order_management/mmap_order_book_impl.cpp:211 ... (gdb) frame 3 #3 0x000055555561a7fa in MmapOrderBook::Impl::getOrder (this=0x555555776170, orderId=\u0026#34;ORD-1726124231791862593\u0026#34;) at /home/hft_trading_system/strategyandtradingwitheventbus/src/order_management/mmap_order_book_impl.cpp:211 211 if (m_orders[i].id == orderId) { (gdb) print orderId $1 = \u0026#34;ORD-1726124231791862593\u0026#34; (gdb) print m_orders[i].id $2 = \u0026lt;error: Cannot access memory at address 0x7f4710000eb0\u0026gt; (gdb) print m_orders[i] $3 = {id = \u0026lt;error: Cannot access memory at address 0x7f4710000eb0\u0026gt;, instId = \u0026lt;error: Cannot access memory at address 0x7f4710000ed0\u0026gt;, price = 58126.699999999997, quantity = 100, status = 3} 3. Relevant Code #The issue originated in the definition of the Order struct. The original Order struct was defined as follows:\nstruct Order { std::string id; std::string instId; double price; double quantity; int status; // 0: pending, 1: filled, 2: cancelled }; This struct was directly used in the memory-mapped file, leading to the problem we encountered.\n4. Problem Analysis #Through analysis of the error information and code structure, we found:\nThe program crash occurred when comparing m_orders[i].id with orderId. The memory address of m_orders[i].id (0x7f4710000eb0) could not be accessed. The id and instId fields in the Order struct used the std::string type. The root cause of the problem is: std::string is a complex object that contains pointers to heap memory. When the program exits, the memory pointed to by these pointers is no longer valid. Attempting to access these std::string objects in the memory-mapped file after restarting the program results in a segmentation fault.\n5. Solution #Replace the std::string types in the Order struct with fixed-size character arrays:\nconstexpr size_t MAX_ID_LENGTH = 64; constexpr size_t MAX_INST_ID_LENGTH = 32; struct Order { char id[MAX_ID_LENGTH]; char instId[MAX_INST_ID_LENGTH]; double price; double quantity; int status; // Constructor and helper methods... }; Additionally, add helper methods to conveniently set and get the values of these fields:\nvoid setId(const std::string\u0026amp; newId) { strncpy(id, newId.c_str(), MAX_ID_LENGTH - 1); id[MAX_ID_LENGTH - 1] = \u0026#39;\\0\u0026#39;; } std::string getId() const { return std::string(id); } // Similarly implement setInstId and getInstId 6. Implementation Steps # Modify the definition of the Order struct. Update all code using the Order struct to use the new setter and getter methods. Delete the old memory-mapped file (if it exists), as the new struct layout is incompatible with the old one. Recompile the entire project. Run tests to ensure the problem is resolved and no new issues have been introduced. 7. Lessons Learned # When using memory-mapped files, avoid directly storing structs containing pointers or complex objects (like std::string). For data structures that need to be persisted, prioritize using fixed-size arrays or basic data types. When designing persistent data structures, consider compatibility across sessions and processes. Add more error checks and logging to make it easier to diagnose similar issues. 8. Follow-up Actions # Review other code using memory-mapped files to ensure there are no similar potential issues. Consider implementing a data integrity check mechanism to validate the contents of memory-mapped files at program startup. Update development guidelines to emphasize considerations when using memory-mapped files. Consider implementing a version control mechanism to allow smooth migration when data structures need to be changed in the future. ","date":"12 September 2024","permalink":"/blog/2025-06-24-string_memory_mapping_techniques/","section":"Blog","summary":"æ•…éšœå¤ç›˜æŠ¥å‘Šï¼šå†…å­˜æ˜ å°„æ–‡ä»¶ä¸­çš„ std::string å¯¼è‡´çš„æ®µé”™è¯¯ #1. é—®é¢˜æè¿° #åœ¨ä½¿ç”¨å†…å­˜æ˜ å°„æ–‡ä»¶å­˜å‚¨è®¢å•æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼Œç¨‹åºåœ¨é‡å¯åå‡ºç°æ®µé”™è¯¯ã€‚å…·ä½“è¡¨ç°ä¸ºåœ¨å°è¯•è®¿é—®å­˜å‚¨åœ¨å†…å­˜æ˜ å°„æ–‡ä»¶ä¸­çš„ Order ç»“æ„ä½“çš„ id å­—æ®µæ—¶ï¼Œç¨‹åºå´©æºƒã€‚\n2. é”™è¯¯ä¿¡æ¯ #ç¨‹åºå´©æºƒæ—¶çš„ GDB è°ƒè¯•ä¿¡æ¯å¦‚ä¸‹ï¼š\nThread 2 \u0026#34;strategyandtrad\u0026#34; received signal SIGSEGV, Segmentation fault. [Switching to Thread 0x7ffff6f4c6c0 (LWP 446582)] __memcmp_sse2 () at ../sysdeps/x86_64/multiarch/memcmp-sse2.S:258 258 ../sysdeps/x86_64/multiarch/memcmp-sse2.S: No such file or directory. (gdb) bt #0 __memcmp_sse2 () at ../sysdeps/x86_64/multiarch/memcmp-sse2.S:258 #1 0x000055555556d79b in std::char_traits\u0026lt;char\u0026gt;::compare (__s1=0x7f4710000eb0 \u0026lt;error: Cannot access memory at address 0x7f4710000eb0\u0026gt;, __s2=0x7fffe8000c80 \u0026#34;ORD-1726124231791862593\u0026#34;, __n=23) at /usr/include/c++/12/bits/char_traits.h:385 #2 0x000055555559c599 in std::operator==\u0026lt;char\u0026gt; (__lhs=\u0026lt;error: Cannot access memory at address 0x7f4710000eb0\u0026gt;, __rhs=\u0026#34;ORD-1726124231791862593\u0026#34;) at /usr/include/c++/12/bits/basic_string.","title":"Segmentation Fault Caused by std::string in Memory-Mapped File"},{"content":"é«˜é¢‘äº¤æ˜“ç³»ç»Ÿé…ç½®ç®¡ç†æ–¹æ¡ˆåˆ†æ #å½“å‰æ–¹æ¡ˆæ¦‚è¿° # graph TB CommonLib[\u0026#34;Common Library (MMAP)\u0026#34;] Exchange[\u0026#34;Exchange\u0026#34;] subgraph StrategyAndTrading[\u0026#34;StrategyAndTrading Component\u0026#34;] MDR[\u0026#34;MarketDataReader\u0026#34;] MDN[\u0026#34;MarketDataNormalizer\u0026#34;] SM[\u0026#34;StrategyManager\u0026#34;] subgraph Strategies[\u0026#34;Strategies\u0026#34;] S1[\u0026#34;Strategy 1\u0026#34;] S2[\u0026#34;Strategy 2\u0026#34;] SN[\u0026#34;Strategy N\u0026#34;] end OG[\u0026#34;OrderGenerator\u0026#34;] OV[\u0026#34;OrderValidator\u0026#34;] RP[\u0026#34;RiskProfiler\u0026#34;] RE[\u0026#34;RiskEvaluator\u0026#34;] OM[\u0026#34;OrderManager\u0026#34;] OE[\u0026#34;OrderExecutor\u0026#34;] OMO[\u0026#34;OrderMonitor\u0026#34;] PM[\u0026#34;PositionManager\u0026#34;] end CommonLib --\u0026gt;|1. Read MMAP| MDR MDR --\u0026gt;|2. Raw Market Data| MDN MDN --\u0026gt;|3. Normalized Data| SM SM --\u0026gt;|4. Distribute Data| Strategies Strategies --\u0026gt;|5. Generate Signals| OG OG --\u0026gt;|6. Create Orders| OV OV --\u0026gt;|7. Validated Orders| RP RP --\u0026gt;|8. Risk Profile| RE RE --\u0026gt;|9. Risk Evaluated Orders| OM OM --\u0026gt;|10. Managed Orders| OE OE \u0026lt;--\u0026gt;|11. Execute Orders| Exchange Exchange --\u0026gt;|12. Execution Results| OMO OMO --\u0026gt;|13. Order Updates| OM OM --\u0026gt;|14. Position Updates| PM PM -.-\u0026gt;|15. Position Feedback| SM classDef external fill:#f9f,stroke:#333,stroke-width:2px; classDef component fill:#bbf,stroke:#333,stroke-width:1px; classDef strategy fill:#bfb,stroke:#333,stroke-width:1px; class CommonLib,Exchange external; class MDR,MDN,SM,OG,OV,RP,RE,OM,OE,OMO,PM component; class S1,S2,SN strategy; Quoteè¿›ç¨‹ä½¿ç”¨commoné™æ€åº“ç»„ä»¶åŠ è½½é…ç½®ä¿¡æ¯ã€‚ é…ç½®ä¿¡æ¯åŠ è½½åˆ°Quoteè¿›ç¨‹çš„æœ¬åœ°ç¼“å­˜ä¸­ã€‚ ä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼è®¢é˜…commonç»„ä»¶ä¸­configçš„å˜æ›´ã€‚ å½“é…ç½®å˜æ›´æ—¶ï¼ŒQuoteè¿›ç¨‹æ›´æ–°æœ¬åœ°ç¼“å­˜ã€é‡æ–°è¿æ¥å’Œé‡æ–°è®¢é˜…ã€‚ ä¼˜ç‚¹åˆ†æ # æ¨¡å—åŒ–è®¾è®¡ï¼š\nä½¿ç”¨commoné™æ€åº“ç»„ä»¶ç®¡ç†é…ç½®ï¼Œæé«˜äº†ä»£ç çš„å¤ç”¨æ€§å’Œç»´æŠ¤æ€§ã€‚ æœ‰åˆ©äºç³»ç»Ÿçš„æ‰©å±•ï¼Œå…¶ä»–ç»„ä»¶ä¹Ÿå¯ä»¥ä½¿ç”¨ç›¸åŒçš„é…ç½®ç®¡ç†æœºåˆ¶ã€‚ å®æ—¶æ›´æ–°ï¼š\nè§‚å¯Ÿè€…æ¨¡å¼å…è®¸Quoteè¿›ç¨‹å®æ—¶å“åº”é…ç½®å˜æ›´ï¼Œæ— éœ€é‡å¯è¿›ç¨‹ã€‚ é€‚åˆåŠ¨æ€è°ƒæ•´äº¤æ˜“ç­–ç•¥å’Œå‚æ•°çš„éœ€æ±‚ã€‚ æœ¬åœ°ç¼“å­˜ï¼š\né…ç½®ä¿¡æ¯å­˜å‚¨åœ¨æœ¬åœ°ç¼“å­˜ä¸­ï¼Œå‡å°‘äº†é¢‘ç¹è®¿é—®é…ç½®æºçš„éœ€æ±‚ã€‚ æœ‰åŠ©äºé™ä½å»¶è¿Ÿï¼Œè¿™å¯¹é«˜é¢‘äº¤æ˜“è‡³å…³é‡è¦ã€‚ çµæ´»æ€§ï¼š\nå¯ä»¥æ ¹æ®ä¸åŒçš„é…ç½®å˜æ›´ç±»å‹é‡‡å–ä¸åŒçš„å“åº”æªæ–½ï¼ˆå¦‚æ›´æ–°ç¼“å­˜ã€é‡æ–°è¿æ¥ã€é‡æ–°è®¢é˜…ï¼‰ã€‚ æ½œåœ¨é—®é¢˜å’Œä¼˜åŒ–å»ºè®® # æ€§èƒ½å¼€é”€ï¼š\nè§‚å¯Ÿè€…æ¨¡å¼å¯èƒ½å¼•å…¥é¢å¤–çš„æ€§èƒ½å¼€é”€ï¼Œç‰¹åˆ«æ˜¯åœ¨é¢‘ç¹æ›´æ–°çš„æƒ…å†µä¸‹ã€‚ å»ºè®®ï¼šè€ƒè™‘ä½¿ç”¨æ›´è½»é‡çº§çš„é€šçŸ¥æœºåˆ¶ï¼Œæˆ–å®ç°æ‰¹é‡æ›´æ–°ç­–ç•¥ã€‚ ä¸€è‡´æ€§é—®é¢˜ï¼š\nåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œä¸åŒè¿›ç¨‹å¯èƒ½åœ¨ä¸åŒæ—¶é—´ç‚¹è·å–æ›´æ–°ï¼Œå¯¼è‡´çŸ­æš‚çš„ä¸ä¸€è‡´çŠ¶æ€ã€‚ å»ºè®®ï¼šå®ç°ç‰ˆæœ¬æ§åˆ¶æœºåˆ¶ï¼Œç¡®ä¿æ‰€æœ‰ç›¸å…³è¿›ç¨‹åŒæ­¥æ›´æ–°åˆ°æ–°ç‰ˆæœ¬é…ç½®ã€‚ é‡è¿æ¥å’Œé‡è®¢é˜…çš„å½±å“ï¼š\nåœ¨é«˜é¢‘äº¤æ˜“ç¯å¢ƒä¸­ï¼Œé‡è¿æ¥å’Œé‡è®¢é˜…å¯èƒ½å¯¼è‡´å…³é”®æ—¶åˆ»çš„å»¶è¿Ÿæˆ–æ•°æ®ä¸¢å¤±ã€‚ å»ºè®®ï¼šå®ç°å¹³æ»‘è¿‡æ¸¡æœºåˆ¶ï¼Œç¡®ä¿åœ¨æ›´æ–°è¿‡ç¨‹ä¸­æœ€å°åŒ–æœåŠ¡ä¸­æ–­ã€‚ å†…å­˜ç®¡ç†ï¼š\né¢‘ç¹æ›´æ–°ç¼“å­˜å¯èƒ½å¯¼è‡´å†…å­˜ç¢ç‰‡åŒ–æˆ–å¢åŠ  GC å‹åŠ›ã€‚ å»ºè®®ï¼šä¼˜åŒ–å†…å­˜åˆ†é…ç­–ç•¥ï¼Œè€ƒè™‘ä½¿ç”¨å†…å­˜æ± æˆ–é¢„åˆ†é…ç¼“å†²åŒºã€‚ é”™è¯¯å¤„ç†ï¼š\né…ç½®æ›´æ–°å¤±è´¥å¯èƒ½å¯¼è‡´ç³»ç»Ÿä¸ç¨³å®šã€‚ å»ºè®®ï¼šå®ç°å¥å£®çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼ŒåŒ…æ‹¬é…ç½®å›æ»šèƒ½åŠ›å’Œé€‚å½“çš„æ—¥å¿—è®°å½•ã€‚ æ›´æ–°ç²’åº¦ï¼š\nå¯èƒ½å­˜åœ¨ä¸å¿…è¦çš„å…¨é‡æ›´æ–°ã€‚ å»ºè®®ï¼šå®ç°å¢é‡æ›´æ–°æœºåˆ¶ï¼Œåªæ›´æ–°å‘ç”Ÿå˜åŒ–çš„é…ç½®é¡¹ã€‚ é…ç½®éªŒè¯ï¼š\nç¼ºä¹æ˜ç¡®çš„é…ç½®éªŒè¯æ­¥éª¤å¯èƒ½å¯¼è‡´ç³»ç»Ÿä¸ç¨³å®šã€‚ å»ºè®®ï¼šåœ¨åº”ç”¨æ–°é…ç½®ä¹‹å‰å¢åŠ éªŒè¯æ­¥éª¤ï¼Œç¡®ä¿é…ç½®çš„æ­£ç¡®æ€§å’Œä¸€è‡´æ€§ã€‚ é«˜é¢‘äº¤æ˜“ç‰¹å®šè€ƒè™‘ # å»¶è¿Ÿæ•æ„Ÿæ€§ï¼š\né«˜é¢‘äº¤æ˜“ç³»ç»Ÿå¯¹å»¶è¿Ÿæä¸ºæ•æ„Ÿï¼Œæ¯ä¸€å¾®ç§’éƒ½å¯èƒ½å½±å“äº¤æ˜“ç»“æœã€‚ å»ºè®®ï¼šä¼˜åŒ–é…ç½®è®¿é—®è·¯å¾„ï¼Œè€ƒè™‘ä½¿ç”¨æ›´åº•å±‚çš„æŠ€æœ¯å¦‚å†…å­˜æ˜ å°„æ–‡ä»¶ã€‚ ç¡®å®šæ€§ï¼š\né«˜é¢‘äº¤æ˜“éœ€è¦é«˜åº¦ç¡®å®šçš„è¡Œä¸ºã€‚ å»ºè®®ï¼šç¡®ä¿é…ç½®æ›´æ–°è¿‡ç¨‹æ˜¯å¯é¢„æµ‹å’Œä¸€è‡´çš„ï¼Œé¿å…å¼•å…¥ä¸ç¡®å®šæ€§ã€‚ ååé‡ï¼š\né«˜é¢‘äº¤æ˜“ç³»ç»Ÿéœ€è¦å¤„ç†å¤§é‡æ•°æ®å’Œè®¢å•ã€‚ å»ºè®®ï¼šç¡®ä¿é…ç½®ç®¡ç†ä¸ä¼šæˆä¸ºç³»ç»Ÿç“¶é¢ˆï¼Œè€ƒè™‘ä½¿ç”¨é«˜æ€§èƒ½æ•°æ®ç»“æ„å’Œç®—æ³•ã€‚ ç›‘ç®¡åˆè§„ï¼š\né«˜é¢‘äº¤æ˜“ç³»ç»Ÿé¢ä¸´ä¸¥æ ¼çš„ç›‘ç®¡è¦æ±‚ã€‚ å»ºè®®ï¼šç¡®ä¿é…ç½®æ›´æ”¹æœ‰è¯¦ç»†çš„æ—¥å¿—è®°å½•ï¼Œä¾¿äºå®¡è®¡å’Œå›æº¯ã€‚ Analysis of Configuration Management in High-Frequency Trading System #Current Approach Overview # The Quote process uses the common static library component to load configuration information. Configuration information is loaded into the local cache of the Quote process. The Observer pattern is used to subscribe to config changes in the common component. When the configuration changes, the Quote process updates the local cache, reconnects, and resubscribes. Advantage Analysis # Modular Design: Using the common static library component for configuration management improves code reusability and maintainability. Facilitates system expansion; other components can use the same configuration management mechanism. Real-time Updates: The Observer pattern allows the Quote process to respond to configuration changes in real-time without restarting the process. Suitable for dynamic adjustment of trading strategies and parameters. Local Caching: Storing configuration information in a local cache reduces the need for frequent access to the configuration source. Helps reduce latency, which is crucial for high-frequency trading. Flexibility: Allows for different response measures based on different types of configuration changes (e.g., updating cache, reconnecting, resubscribing). Potential Issues and Optimization Suggestions # Performance Overhead: The Observer pattern may introduce additional performance overhead, especially in cases of frequent updates. Suggestion: Consider using a more lightweight notification mechanism or implementing a batch update strategy. Consistency Issues: In distributed systems, different processes may receive updates at different times, leading to temporary inconsistent states. Suggestion: Implement a version control mechanism to ensure all related processes synchronize to the new version of the configuration. Impact of Reconnection and Resubscription: In a high-frequency trading environment, reconnecting and resubscribing may cause delays or data loss at critical moments. Suggestion: Implement a smooth transition mechanism to minimize service interruption during updates. Memory Management: Frequent cache updates may lead to memory fragmentation or increase GC pressure. Suggestion: Optimize memory allocation strategy, consider using memory pools or pre-allocated buffers. Error Handling: Configuration update failures may lead to system instability. Suggestion: Implement robust error handling mechanisms, including configuration rollback capability and appropriate logging. Update Granularity: There may be unnecessary full updates. Suggestion: Implement an incremental update mechanism, only updating configuration items that have changed. Configuration Validation: Lack of explicit configuration validation steps may lead to system instability. Suggestion: Add validation steps before applying new configurations to ensure correctness and consistency. High-Frequency Trading Specific Considerations # Latency Sensitivity: High-frequency trading systems are extremely sensitive to latency; every microsecond can affect trading results. Suggestion: Optimize configuration access paths, consider using lower-level techniques such as memory-mapped files. Determinism: High-frequency trading requires highly deterministic behavior. Suggestion: Ensure the configuration update process is predictable and consistent, avoiding the introduction of uncertainty. Throughput: High-frequency trading systems need to process large volumes of data and orders. Suggestion: Ensure configuration management does not become a system bottleneck, consider using high-performance data structures and algorithms. Regulatory Compliance: High-frequency trading systems face strict regulatory requirements. Suggestion: Ensure detailed logging of configuration changes for auditing and traceability. ","date":"6 September 2024","permalink":"/blog/2025-06-24-config_management_in_hft_systems/","section":"Blog","summary":"é«˜é¢‘äº¤æ˜“ç³»ç»Ÿé…ç½®ç®¡ç†æ–¹æ¡ˆåˆ†æ #å½“å‰æ–¹æ¡ˆæ¦‚è¿° # graph TB CommonLib[\u0026#34;Common Library (MMAP)\u0026#34;] Exchange[\u0026#34;Exchange\u0026#34;] subgraph StrategyAndTrading[\u0026#34;StrategyAndTrading Component\u0026#34;] MDR[\u0026#34;MarketDataReader\u0026#34;] MDN[\u0026#34;MarketDataNormalizer\u0026#34;] SM[\u0026#34;StrategyManager\u0026#34;] subgraph Strategies[\u0026#34;Strategies\u0026#34;] S1[\u0026#34;Strategy 1\u0026#34;] S2[\u0026#34;Strategy 2\u0026#34;] SN[\u0026#34;Strategy N\u0026#34;] end OG[\u0026#34;OrderGenerator\u0026#34;] OV[\u0026#34;OrderValidator\u0026#34;] RP[\u0026#34;RiskProfiler\u0026#34;] RE[\u0026#34;RiskEvaluator\u0026#34;] OM[\u0026#34;OrderManager\u0026#34;] OE[\u0026#34;OrderExecutor\u0026#34;] OMO[\u0026#34;OrderMonitor\u0026#34;] PM[\u0026#34;PositionManager\u0026#34;] end CommonLib --\u0026gt;|1. Read MMAP| MDR MDR --\u0026gt;|2. Raw Market Data| MDN MDN --\u0026gt;|3. Normalized Data| SM SM --\u0026gt;|4. Distribute Data| Strategies Strategies --\u0026gt;|5. Generate Signals| OG OG --\u0026gt;|6. Create Orders| OV OV --\u0026gt;|7. Validated Orders| RP RP --\u0026gt;|8.","title":"Analysis of Configuration Management in High-Frequency Trading System"},{"content":"","date":null,"permalink":"/tags/blog/","section":"Tags","summary":"","title":"Blog"},{"content":"workflow #ç›®å‰å·²ç»å®ç°GitHub Actionï¼Œè‡ªåŠ¨ç¼–è¯‘é™æ€æ–‡ä»¶, Pushåˆ°GitHub Pageã€‚\nå…·ä½“æµç¨‹ # åœ¨ä»“åº“ git@github.com:code-agree/MyBlogWebsiteRepo.git MyBlogWebsiteRepo/WebsiteRepo ä½¿ç”¨ hugoå‘½ä»¤ hugo new content ./content/blog/How_to_publish_new_blog.md æ–°å¢blog å°†å½“å‰ä»“åº“çš„å˜æ›´pushåˆ°è¿œç«¯ ç”±é…ç½®çš„GitHub action è‡ªåŠ¨è§¦å‘ æ„å»ºé™æ€æ–‡ä»¶-\u0026gt;pushåˆ°GitHub Pageä»“åº“ æˆåŠŸå‘å¸ƒ ","date":"2 September 2024","permalink":"/blog/2025-06-24-how_to_publish_new_blog/","section":"Blog","summary":"workflow #ç›®å‰å·²ç»å®ç°GitHub Actionï¼Œè‡ªåŠ¨ç¼–è¯‘é™æ€æ–‡ä»¶, Pushåˆ°GitHub Pageã€‚\nå…·ä½“æµç¨‹ # åœ¨ä»“åº“ git@github.com:code-agree/MyBlogWebsiteRepo.git MyBlogWebsiteRepo/WebsiteRepo ä½¿ç”¨ hugoå‘½ä»¤ hugo new content ./content/blog/How_to_publish_new_blog.md æ–°å¢blog å°†å½“å‰ä»“åº“çš„å˜æ›´pushåˆ°è¿œç«¯ ç”±é…ç½®çš„GitHub action è‡ªåŠ¨è§¦å‘ æ„å»ºé™æ€æ–‡ä»¶-\u0026gt;pushåˆ°GitHub Pageä»“åº“ æˆåŠŸå‘å¸ƒ ","title":"How to publish new blog"},{"content":"æ ‡é¢˜ï¼šè§£å†³é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­çš„æ­»é”ï¼šä»ä¼ ç»Ÿ EventBus åˆ°æ— é”é˜Ÿåˆ—çš„ä¼˜åŒ–ä¹‹æ—… # å¼•è¨€ åœ¨é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­ï¼Œæ¯ä¸€æ¯«ç§’éƒ½è‡³å…³é‡è¦ã€‚æœ€è¿‘åœ¨ç³»ç»Ÿä¸­é‡åˆ°äº†ä¸€ä¸ªä»¤äººå¤´ç–¼çš„æ­»é”é—®é¢˜ï¼Œè¿™ä¸ä»…å½±å“äº†ç³»ç»Ÿçš„æ€§èƒ½ï¼Œè¿˜å±åŠäº†å…¶ç¨³å®šæ€§ã€‚æœ¬æ–‡å°†è¯¦ç»†è®²è¿°å¦‚ä½•å‘ç°ã€åˆ†æå¹¶æœ€ç»ˆè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä»¥åŠä»ä¸­å­¦åˆ°çš„å®è´µç»éªŒã€‚\né—®é¢˜å‘ç° åœ¨ä¸€æ¬¡ä¾‹è¡Œçš„ç³»ç»Ÿç›‘æ§ä¸­ï¼Œæ³¨æ„åˆ°ç³»ç»Ÿå¶å°”ä¼šå‡ºç°çŸ­æš‚çš„åœé¡¿ã€‚é€šè¿‡æ—¥å¿—åˆ†æï¼Œå‘ç° MarketDataReader çš„ readingLoop() å‡½æ•°åªæ‰§è¡Œäº†ä¸€æ¬¡å°±åœæ­¢äº†ã€‚è¿™å¼•èµ·äº†çš„è­¦è§‰ã€‚\né—®é¢˜åˆ†æ é¦–å…ˆæŸ¥çœ‹äº† MarketDataReader çš„æ—¥å¿—ï¼š\n[2024-09-01 13:02:08.472] [main_logger] [MarketDataReader.cpp:38] [info] [thread 4048966] [start] Starting market data reader... [2024-09-01 13:02:08.472] [main_logger] [MarketDataReader.cpp:40] [info] [thread 4048966] [start] Starting start,and running_ = true [2024-09-01 13:02:08.489] [main_logger] [MarketDataReader.cpp:63] [info] [thread 4048967] [readingLoop] Starting reading loop...,and running_ = true [2024-09-01 13:02:08.490] [main_logger] [MarketDataReader.cpp:65] [info] [thread 4048967] [readingLoop] Reading loop... [2024-09-01 13:02:08.490] [main_logger] [MarketDataReader.cpp:83] [info] [thread 4048967] [processSymbol] Processing symbol: BTC-USDT [2024-09-01 13:02:08.490] [main_logger] [MarketDataReader.cpp:87] [info] [thread 4048967] [processSymbol] timeSinceLastUpdate: 24305 can into loop [2024-09-01 13:02:08.490] [main_logger] [MarketDataStore.cpp:137] [info] [thread 4048967] [readLatestData] Read data for symbol = BTC-USDT, timestamp = 1725228018 [2024-09-01 13:02:08.491] [main_logger] [MarketDataReader.cpp:94] [info] [thread 4048967] [processSymbol] currentData: 58124.24 [2024-09-01 13:02:08.491] [main_logger] [MarketDataReader.cpp:95] [info] [thread 4048967] [processSymbol] publish marketDataEvent [2024-09-01 13:02:08.491] [main_logger] [EventBus.h:59] [info] [thread 4048967] [publish] publish event: 15MarketDataEvent [2024-09-01 13:02:08.492] [main_logger] [StrategyManager.cpp:38] [info] [thread 4048967] [processSignals] publish orderEvent: BTC-USDT [2024-09-01 13:02:08.492] [main_logger] [EventBus.h:59] [info] [thread 4048967] [publish] publish event: 10OrderEvent æ—¥å¿—æ˜¾ç¤ºï¼ŒreadingLoop ç¡®å®å¼€å§‹æ‰§è¡Œï¼Œä½†åœ¨å¤„ç†å®Œä¸€ä¸ªå¸‚åœºæ•°æ®äº‹ä»¶åå°±æ²¡æœ‰ç»§ç»­ã€‚è¿™æš—ç¤ºå¯èƒ½å­˜åœ¨æ­»é”ã€‚\næ·±å…¥è°ƒæŸ¥ ä½¿ç”¨ GDB é™„åŠ åˆ°è¿è¡Œä¸­çš„è¿›ç¨‹ï¼Œå¹¶è·å–äº†çº¿ç¨‹å †æ ˆä¿¡æ¯ï¼š\n(gdb) info thread Id Target Id Frame * 1 Thread 0x7ffff7e91740 (LWP 4054377) \u0026#34;strategyandtrad\u0026#34; 0x00007ffff7aee485 in __GI___clock_nanosleep ( clock_id=clock_id@entry=0, flags=flags@entry=0, req=0x7fffffffe420, rem=0x7fffffffe420) at ../sysdeps/unix/sysv/linux/clock_nanosleep.c:48 2 Thread 0x7ffff6fff6c0 (LWP 4054380) \u0026#34;strategyandtrad\u0026#34; futex_wait (private=0, expected=2, futex_word=0x5555556be768) at ../sysdeps/nptl/futex-internal.h:146 æŸ¥çœ‹çº¿ç¨‹ 2 çš„å †æ ˆï¼š\n(gdb) thread 2 [Switching to thread 2 (Thread 0x7ffff6fff6c0 (LWP 4054380))] #0 futex_wait (private=0, expected=2, futex_word=0x5555556be768) at ../sysdeps/nptl/futex-internal.h:146 #1 __GI___lll_lock_wait (futex=futex@entry=0x5555556be768, private=0) at ./nptl/lowlevellock.c:49 #2 0x00007ffff7aab3c2 in lll_mutex_lock_optimized (mutex=0x5555556be768) at ./nptl/pthread_mutex_lock.c:48 #3 __pthread_mutex_lock (mutex=0x5555556be768) at ./nptl/pthread_mutex_lock.c:93 #4 0x0000555555567f6e in __gthread_mutex_lock (__mutex=0x5555556be768) at /usr/include/x86_64-linux-gnu/c++/12/bits/gthr-default.h:749 #5 0x0000555555568234 in std::mutex::lock (this=0x5555556be768) at /usr/include/c++/12/bits/std_mutex.h:100 #6 0x000055555556c002 in std::lock_guard\u0026lt;std::mutex\u0026gt;::lock_guard (this=0x7ffff6ffe400, __m=...) at /usr/include/c++/12/bits/std_mutex.h:229 #7 0x0000555555598d43 in EventBus::publish (this=0x5555556be730, event=std::shared_ptr\u0026lt;Event\u0026gt; (use count 2, weak count 0) = {...}) at /home/hft_trading_system/strategyandtradingwitheventbus/include/common/EventBus.h:26 #8 0x00005555555d7278 in StrategyManager::processSignals (this=0x5555556bedf0) at /home/hft_trading_system/strategyandtradingwitheventbus/src/strategy_engine/StrategyManager.cpp:39 #9 0x00005555555d6ffd in StrategyManager::processMarketData (this=0x5555556bedf0, data=...) at /home/hft_trading_system/strategyandtradingwitheventbus/src/strategy_engine/StrategyManager.cpp:26 è¿™ä¸ªå †æ ˆä¿¡æ¯æ­ç¤ºäº†é—®é¢˜çš„æ ¹æºï¼šåœ¨å¤„ç†å¸‚åœºæ•°æ®äº‹ä»¶æ—¶ï¼ŒStrategyManager è¯•å›¾å‘å¸ƒæ–°çš„äº‹ä»¶ï¼Œä½† EventBus çš„ publish æ–¹æ³•æ­£åœ¨ç­‰å¾…è·å–ä¸€ä¸ªå·²ç»è¢«å ç”¨çš„äº’æ–¥é”ã€‚\né—®é¢˜æ ¹æº åˆ†æè¡¨æ˜ï¼Œé—®é¢˜å‡ºåœ¨çš„ EventBus å®ç°ä¸­ã€‚å½“ä¸€ä¸ªäº‹ä»¶è¢«å¤„ç†æ—¶ï¼Œå¤„ç†å‡½æ•°å¯èƒ½ä¼šå°è¯•å‘å¸ƒæ–°çš„äº‹ä»¶ï¼Œè€Œ EventBus::publish æ–¹æ³•åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­éƒ½æŒæœ‰ä¸€ä¸ªé”ã€‚è¿™å¯¼è‡´äº†æ­»é”ã€‚\nè§£å†³æ–¹æ¡ˆ ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå†³å®šé‡æ–°è®¾è®¡çš„äº‹ä»¶å¤„ç†æœºåˆ¶ï¼Œé‡‡ç”¨æ— é”é˜Ÿåˆ—æ¥æ›¿ä»£ä¼ ç»Ÿçš„ EventBusã€‚\næ–°çš„ LockFreeQueue å®ç°ï¼š\ntemplate\u0026lt;typename T\u0026gt; class LockFreeQueue { private: struct Node { std::shared_ptr\u0026lt;T\u0026gt; data; std::atomic\u0026lt;Node*\u0026gt; next; Node() : next(nullptr) {} }; std::atomic\u0026lt;Node*\u0026gt; head_; std::atomic\u0026lt;Node*\u0026gt; tail_; public: LockFreeQueue() { Node* dummy = new Node(); head_.store(dummy); tail_.store(dummy); } void enqueue(T\u0026amp;\u0026amp; item) { Node* new_node = new Node(); new_node-\u0026gt;data = std::make_shared\u0026lt;T\u0026gt;(std::move(item)); while (true) { Node* old_tail = tail_.load(); Node* next = old_tail-\u0026gt;next.load(); if (old_tail == tail_.load()) { if (next == nullptr) { if (old_tail-\u0026gt;next.compare_exchange_weak(next, new_node)) { tail_.compare_exchange_weak(old_tail, new_node); return; } } else { tail_.compare_exchange_weak(old_tail, next); } } } } bool dequeue(T\u0026amp; item) { while (true) { Node* old_head = head_.load(); Node* old_tail = tail_.load(); Node* next = old_head-\u0026gt;next.load(); if (old_head == head_.load()) { if (old_head == old_tail) { if (next == nullptr) { return false; // Queue is empty } tail_.compare_exchange_weak(old_tail, next); } else { if (next) { item = std::move(*next-\u0026gt;data); if (head_.compare_exchange_weak(old_head, next)) { delete old_head; return true; } } } } } } }; åŸºäºæ— é”é˜Ÿåˆ—çš„æ–° EventBus å®ç°ï¼š\nclass LockFreeEventBus { private: LockFreeQueue\u0026lt;std::shared_ptr\u0026lt;Event\u0026gt;\u0026gt; event_queue_; std::unordered_map\u0026lt;std::type_index, std::vector\u0026lt;std::function\u0026lt;void(std::shared_ptr\u0026lt;Event\u0026gt;)\u0026gt;\u0026gt;\u0026gt; handlers_; std::atomic\u0026lt;bool\u0026gt; running_; std::thread worker_thread_; void process_events() { while (running_) { std::shared_ptr\u0026lt;Event\u0026gt; event; if (event_queue_.dequeue(event)) { auto it = handlers_.find(typeid(*event)); if (it != handlers_.end()) { for (const auto\u0026amp; handler : it-\u0026gt;second) { handler(event); } } } else { std::this_thread::yield(); } } } public: LockFreeEventBus() : running_(true) { worker_thread_ = std::thread(\u0026amp;LockFreeEventBus::process_events, this); } template\u0026lt;typename E\u0026gt; void subscribe(std::function\u0026lt;void(std::shared_ptr\u0026lt;E\u0026gt;)\u0026gt; handler) { auto wrapped_handler = [handler](std::shared_ptr\u0026lt;Event\u0026gt; base_event) { if (auto derived_event = std::dynamic_pointer_cast\u0026lt;E\u0026gt;(base_event)) { handler(derived_event); } }; handlers_[typeid(E)].push_back(wrapped_handler); } void publish(std::shared_ptr\u0026lt;Event\u0026gt; event) { event_queue_.enqueue(std::move(event)); } }; 6.2 ä»£ç è®²è§£\nè¿™ä¸ª `LockFreeEventBus` ç±»å®ç°äº†ä¸€ä¸ªåŸºäºæ— é”é˜Ÿåˆ—çš„äº‹ä»¶æ€»çº¿ç³»ç»Ÿã€‚è®©æˆ‘è¯¦ç»†è§£é‡Šå…¶å·¥ä½œæœºåˆ¶ï¼š 1. æ ¸å¿ƒç»„ä»¶ï¼š - `event_queue_`ï¼šä¸€ä¸ªæ— é”é˜Ÿåˆ—ï¼Œç”¨äºå­˜å‚¨å¾…å¤„ç†çš„äº‹ä»¶ã€‚ - `handlers_`ï¼šä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œç”¨äºå­˜å‚¨ä¸åŒäº‹ä»¶ç±»å‹çš„å¤„ç†å‡½æ•°ã€‚ - `running_`ï¼šä¸€ä¸ªåŸå­å¸ƒå°”å€¼ï¼Œç”¨äºæ§åˆ¶äº‹ä»¶å¤„ç†å¾ªç¯ã€‚ - `worker_thread_`ï¼šä¸€ä¸ªåå°çº¿ç¨‹ï¼Œç”¨äºæŒç»­å¤„ç†äº‹ä»¶ã€‚ 2. äº‹ä»¶å‘å¸ƒæœºåˆ¶ï¼ˆpublish æ–¹æ³•ï¼‰ï¼š - å½“æœ‰æ–°äº‹ä»¶éœ€è¦å‘å¸ƒæ—¶ï¼Œè°ƒç”¨ `publish` æ–¹æ³•ã€‚ - è¯¥æ–¹æ³•å°†äº‹ä»¶æŒ‡é’ˆç§»åŠ¨åˆ°æ— é”é˜Ÿåˆ—ä¸­ï¼Œè¿™ä¸ªæ“ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ 3. äº‹ä»¶è®¢é˜…æœºåˆ¶ï¼ˆsubscribe æ–¹æ³•ï¼‰ï¼š - å…è®¸å…¶ä»–ç»„ä»¶è®¢é˜…ç‰¹å®šç±»å‹çš„äº‹ä»¶ã€‚ - ä½¿ç”¨æ¨¡æ¿å‚æ•° `E` æ¥æŒ‡å®šäº‹ä»¶ç±»å‹ã€‚ - åˆ›å»ºä¸€ä¸ªåŒ…è£…å¤„ç†å‡½æ•°ï¼Œå°†åŸºç±» `Event` æŒ‡é’ˆè½¬æ¢ä¸ºç‰¹å®šç±»å‹ `E` çš„æŒ‡é’ˆã€‚ - å°†åŒ…è£…åçš„å¤„ç†å‡½æ•°å­˜å‚¨åœ¨ `handlers_` ä¸­ï¼Œä»¥äº‹ä»¶ç±»å‹ä¸ºé”®ã€‚ 4. äº‹ä»¶å¤„ç†å¾ªç¯ï¼ˆprocess_events æ–¹æ³•ï¼‰ï¼š - åœ¨åå°çº¿ç¨‹ä¸­æŒç»­è¿è¡Œã€‚ - ä¸æ–­å°è¯•ä»æ— é”é˜Ÿåˆ—ä¸­å–å‡ºäº‹ä»¶ã€‚ - å¦‚æœå–åˆ°äº‹ä»¶ï¼ŒæŸ¥æ‰¾å¯¹åº”çš„å¤„ç†å‡½æ•°å¹¶æ‰§è¡Œã€‚ - å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œè°ƒç”¨ `std::this_thread::yield()` è®©å‡º CPU æ—¶é—´ã€‚ 5. çº¿ç¨‹å®‰å…¨æ€§ï¼š - ä½¿ç”¨æ— é”é˜Ÿåˆ—ç¡®ä¿äº‹ä»¶çš„å‘å¸ƒå’Œæ¶ˆè´¹æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ - `handlers_` çš„ä¿®æ”¹åªåœ¨åˆå§‹åŒ–é˜¶æ®µè¿›è¡Œï¼Œè¿è¡Œæ—¶åªè¯»å–ï¼Œå› æ­¤ä¸éœ€è¦é¢å¤–çš„åŒæ­¥ã€‚ 6. ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼š - æ„é€ å‡½æ•°å¯åŠ¨åå°å¤„ç†çº¿ç¨‹ã€‚ - ææ„å‡½æ•°é€šè¿‡è®¾ç½® `running_` ä¸º false æ¥åœæ­¢å¤„ç†å¾ªç¯ï¼Œå¹¶ç­‰å¾…åå°çº¿ç¨‹ç»“æŸã€‚ å·¥ä½œæµç¨‹ï¼š 1. ç³»ç»Ÿå¯åŠ¨æ—¶ï¼Œå„ç»„ä»¶é€šè¿‡ `subscribe` æ–¹æ³•æ³¨å†Œå®ƒä»¬æ„Ÿå…´è¶£çš„äº‹ä»¶å¤„ç†å‡½æ•°ã€‚ 2. å½“éœ€è¦å‘å¸ƒäº‹ä»¶æ—¶ï¼Œè°ƒç”¨æ–¹ä½¿ç”¨ `publish` æ–¹æ³•å°†äº‹ä»¶æ”¾å…¥é˜Ÿåˆ—ã€‚ 3. åå°çº¿ç¨‹æŒç»­ä»é˜Ÿåˆ—ä¸­å–å‡ºäº‹ä»¶ï¼ŒæŸ¥æ‰¾å¯¹åº”çš„å¤„ç†å‡½æ•°ï¼Œå¹¶æ‰§è¡Œè¿™äº›å‡½æ•°ã€‚ 4. æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œé™¤äº†è®¢é˜…æ“ä½œå¤–ï¼Œæ²¡æœ‰ä½¿ç”¨ä»»ä½•é”ï¼Œæé«˜äº†å¹¶å‘æ€§èƒ½ã€‚ è¿™ç§è®¾è®¡çš„ä¼˜ç‚¹ï¼š 1. é«˜å¹¶å‘æ€§èƒ½ï¼šä½¿ç”¨æ— é”é˜Ÿåˆ—é¿å…äº†é”ç«äº‰ã€‚ 2. è§£è€¦ï¼šäº‹ä»¶å‘å¸ƒè€…å’Œè®¢é˜…è€…å®Œå…¨åˆ†ç¦»ã€‚ 3. ç±»å‹å®‰å…¨ï¼šé€šè¿‡æ¨¡æ¿å’ŒåŠ¨æ€è½¬æ¢ç¡®ä¿ç±»å‹åŒ¹é…ã€‚ 4. çµæ´»æ€§ï¼šå¯ä»¥è½»æ¾æ·»åŠ æ–°çš„äº‹ä»¶ç±»å‹å’Œå¤„ç†å‡½æ•°ã€‚ å®æ–½æ•ˆæœ å®æ–½æ–°çš„ LockFreeEventBus åï¼Œè¿è¡Œäº†ä¸ºæœŸä¸€å‘¨çš„å‹åŠ›æµ‹è¯•ã€‚ç»“æœæ˜¾ç¤ºï¼š\nç³»ç»Ÿå†ä¹Ÿæ²¡æœ‰å‡ºç°æ­»é” äº‹ä»¶å¤„ç†å»¶è¿Ÿé™ä½äº† 30% CPU ä½¿ç”¨ç‡å‡å°‘äº† 15% ç³»ç»Ÿæ•´ä½“ååé‡æé«˜äº† 25% ç»éªŒæ€»ç»“\nåœ¨é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­ï¼Œä¼ ç»Ÿçš„é”æœºåˆ¶å¯èƒ½ä¼šå¯¼è‡´æ„æƒ³ä¸åˆ°çš„æ€§èƒ½é—®é¢˜å’Œæ­»é”ã€‚ æ— é”ç®—æ³•è™½ç„¶å®ç°å¤æ‚ï¼Œä½†åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹èƒ½å¸¦æ¥æ˜¾è‘—çš„æ€§èƒ½æå‡ã€‚ ç³»ç»Ÿè®¾è®¡æ—¶åº”è€ƒè™‘åˆ°äº‹ä»¶å¤„ç†çš„é€’å½’æ€§ï¼Œé¿å…å› äº‹ä»¶å¤„ç†è€Œå¯¼è‡´çš„æ­»é”ã€‚ å…¨é¢çš„æ—¥å¿—è®°å½•å’Œå®æ—¶ç›‘æ§å¯¹äºå¿«é€Ÿå®šä½å’Œè§£å†³é—®é¢˜è‡³å…³é‡è¦ã€‚ æœªæ¥å±•æœ›\nè®¡åˆ’è¿›ä¸€æ­¥ä¼˜åŒ–æ— é”é˜Ÿåˆ—ï¼Œå¼•å…¥å¤šç”Ÿäº§è€…-å¤šæ¶ˆè´¹è€…æ¨¡å‹ã€‚ è€ƒè™‘å®ç°äº‹ä»¶çš„æ‰¹é‡å¤„ç†ï¼Œä»¥è¿›ä¸€æ­¥æé«˜ç³»ç»Ÿååé‡ã€‚ æŒç»­ç›‘æ§ç³»ç»Ÿæ€§èƒ½ï¼Œå»ºç«‹æ›´å®Œå–„çš„æ€§èƒ½åŸºå‡†å’ŒæŠ¥è­¦æœºåˆ¶ã€‚ é€šè¿‡è¿™æ¬¡æŠ€æœ¯å‡çº§ï¼Œä¸ä»…è§£å†³äº†å½“å‰çš„æ­»é”é—®é¢˜ï¼Œè¿˜ä¸ºç³»ç»Ÿæœªæ¥çš„æ€§èƒ½ä¼˜åŒ–å¥ å®šäº†åŸºç¡€ã€‚\n","date":"2 September 2024","permalink":"/blog/2025-06-24-lockfree_programming_techniques/","section":"Blog","summary":"æ ‡é¢˜ï¼šè§£å†³é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­çš„æ­»é”ï¼šä»ä¼ ç»Ÿ EventBus åˆ°æ— é”é˜Ÿåˆ—çš„ä¼˜åŒ–ä¹‹æ—… # å¼•è¨€ åœ¨é«˜é¢‘äº¤æ˜“ç³»ç»Ÿä¸­ï¼Œæ¯ä¸€æ¯«ç§’éƒ½è‡³å…³é‡è¦ã€‚æœ€è¿‘åœ¨ç³»ç»Ÿä¸­é‡åˆ°äº†ä¸€ä¸ªä»¤äººå¤´ç–¼çš„æ­»é”é—®é¢˜ï¼Œè¿™ä¸ä»…å½±å“äº†ç³»ç»Ÿçš„æ€§èƒ½ï¼Œè¿˜å±åŠäº†å…¶ç¨³å®šæ€§ã€‚æœ¬æ–‡å°†è¯¦ç»†è®²è¿°å¦‚ä½•å‘ç°ã€åˆ†æå¹¶æœ€ç»ˆè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä»¥åŠä»ä¸­å­¦åˆ°çš„å®è´µç»éªŒã€‚\né—®é¢˜å‘ç° åœ¨ä¸€æ¬¡ä¾‹è¡Œçš„ç³»ç»Ÿç›‘æ§ä¸­ï¼Œæ³¨æ„åˆ°ç³»ç»Ÿå¶å°”ä¼šå‡ºç°çŸ­æš‚çš„åœé¡¿ã€‚é€šè¿‡æ—¥å¿—åˆ†æï¼Œå‘ç° MarketDataReader çš„ readingLoop() å‡½æ•°åªæ‰§è¡Œäº†ä¸€æ¬¡å°±åœæ­¢äº†ã€‚è¿™å¼•èµ·äº†çš„è­¦è§‰ã€‚\né—®é¢˜åˆ†æ é¦–å…ˆæŸ¥çœ‹äº† MarketDataReader çš„æ—¥å¿—ï¼š\n[2024-09-01 13:02:08.472] [main_logger] [MarketDataReader.cpp:38] [info] [thread 4048966] [start] Starting market data reader... [2024-09-01 13:02:08.472] [main_logger] [MarketDataReader.cpp:40] [info] [thread 4048966] [start] Starting start,and running_ = true [2024-09-01 13:02:08.489] [main_logger] [MarketDataReader.cpp:63] [info] [thread 4048967] [readingLoop] Starting reading loop...,and running_ = true [2024-09-01 13:02:08.490] [main_logger] [MarketDataReader.cpp:65] [info] [thread 4048967] [readingLoop] Reading loop... [2024-09-01 13:02:08.490] [main_logger] [MarketDataReader.cpp:83] [info] [thread 4048967] [processSymbol] Processing symbol: BTC-USDT [2024-09-01 13:02:08.","title":"Lock Free Queue Application"},{"content":"Const #Owner: More_surface Ted Created time: July 25, 2024 4:59 PM\nconst å¯ä»¥ç”¨æ¥ä¿®é¥°å˜é‡ã€å‡½æ•°ã€æŒ‡é’ˆç­‰ã€‚\nä¿®é¥°å˜é‡ å½“ä¿®é¥°å˜é‡æ—¶ï¼Œæ„å‘³ç€è¯¥å˜é‡ä¸ºåªè¯»å˜é‡ï¼Œå³ä¸èƒ½è¢«ä¿®æ”¹ã€‚\nä¾‹å¦‚\nconst int a = 10; a = 20; //ç¼–è¯‘æŠ¥é”™ï¼Œaä¸ºåªè¯»ï¼Œä¸å¯ä¿®æ”¹ ä½†æ˜¯å¯ä»¥é€šè¿‡ä¸€äº›æŒ‡é’ˆç±»å‹è½¬æ¢æ“ä½œconst_cast ï¼Œä¿®æ”¹è¿™ä¸ªå˜é‡ã€‚\nä¾‹å¦‚\nint main(){ const int a = 10; const int* p = \u0026amp;a; // pæ˜¯æŒ‡å‘const intç±»å‹çš„å¯¹è±¡ int* q = const_cast\u0026lt;int*\u0026gt;(p); // ç±»å‹è½¬æ¢ï¼Œå°†pè½¬æ¢æˆæŒ‡å‘intå‹å¯¹è±¡çš„æŒ‡é’ˆ *q = 20; // é€šè¿‡æŒ‡é’ˆæ“ä½œä¿®æ”¹ const açš„å€¼ std::cout \u0026lt;\u0026lt; a \u0026lt;\u0026lt; std::ends; // è¾“å‡ºç»“æœ ä»ç„¶æ˜¯10 return 0; } è¾“å‡ºç»“æœä¸å˜ï¼Œå½’åŠŸäºç¼–è¯‘å™¨é†‰åšäº†ä¼˜åŒ–ï¼Œç¼–è¯‘æ—¶æŠŠä»£ç æ›¿æ¢ä¸ºäº†å¦‚ä¸‹æ‰€ç¤ºã€‚\nstd::cout \u0026lt;\u0026lt; \u0026quot;a = \u0026quot; \u0026lt;\u0026lt; 10 \u0026lt;\u0026lt; std::endl;\nä¿®é¥°å‡½æ•°å‚æ•°ï¼Œè¡¨ç¤ºå‡½æ•°ä¸ä¼šä¿®æ”¹å‚æ•° void func(const int a) { // ç¼–è¯‘é”™è¯¯ï¼Œä¸èƒ½ä¿®æ”¹ a çš„å€¼ a = 10; } ä¿®é¥°å‡½æ•°è¿”å›å€¼ å½“ä¿®é¥°å‡½æ•°è¿”å›å€¼æ—¶ï¼Œè¡¨ç¤ºå‡½æ•°çš„è¿”å›å€¼ä¸ºåªè¯»ï¼Œä¸èƒ½è¢«ä¿®æ”¹ã€‚å¥½å¤„æ˜¯å¯ä»¥ä½¿å‡½æ•°çš„è¿”å›å€¼æ›´åŠ å®‰å…¨ï¼Œä¸ä¼šè¢«è¯¯ä¿®æ”¹ã€‚\nconst int func() { int a = 10; return a; } int main() { const int b = func(); // b çš„å€¼ä¸º 10ï¼Œä¸èƒ½è¢«ä¿®æ”¹ b = 20; // ç¼–è¯‘é”™è¯¯ï¼Œb æ˜¯åªè¯»å˜é‡ï¼Œä¸èƒ½è¢«ä¿®æ”¹ return 0; } ä¿®é¥°æŒ‡é’ˆæˆ–å¼•ç”¨ 4.1. constä¿®é¥°çš„æ˜¯æŒ‡é’ˆæ‰€æŒ‡å‘çš„å˜é‡ï¼Œè€Œä¸æ˜¯æŒ‡é’ˆæœ¬èº«ï¼›æŒ‡é’ˆæœ¬èº«å¯ä»¥è¢«ä¿®æ”¹(å¯ä»¥æŒ‡å‘æ–°çš„å˜é‡)ï¼Œä½†æ˜¯ä¸èƒ½é€šè¿‡æŒ‡é’ˆä¿®æ”¹æ‰€æŒ‡å‘çš„å˜é‡ã€‚\nconst int* p; // å£°æ˜ä¸€ä¸ªæŒ‡å‘åªè¯»å˜é‡çš„æŒ‡é’ˆï¼Œå¯ä»¥æŒ‡å‘ int ç±»å‹çš„åªè¯»å˜é‡ int a = 10; const int b = 20; p = \u0026amp;a; // åˆæ³•ï¼ŒæŒ‡é’ˆå¯ä»¥æŒ‡å‘æ™®é€šå˜é‡ p = \u0026amp;b; // åˆæ³•ï¼ŒæŒ‡é’ˆå¯ä»¥æŒ‡å‘åªè¯»å˜é‡ *p = 30; // éæ³•ï¼Œæ— æ³•é€šè¿‡æŒ‡é’ˆä¿®æ”¹åªè¯»å˜é‡çš„å€¼ 4.2. åªè¯»æŒ‡é’ˆ\nconstå…³é”®å­—ä¿®é¥°çš„æ˜¯æŒ‡é’ˆæœ¬èº«ï¼Œä½¿å¾—æŒ‡é’ˆæœ¬èº«æˆä¸ºåªè¯»å˜é‡ã€‚\nè¿™ç§æƒ…å†µæŒ‡é’ˆæœ¬èº«ä¸èƒ½è¢«ä¿®æ”¹(å³ä¸€æ—¦åˆå§‹åŒ–å°±ä¸èƒ½æŒ‡å‘å…¶ä»–å˜é‡)ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡æŒ‡é’ˆä¿®æ”¹æ‰€æŒ‡å‘çš„å˜é‡\nint a = 10; int b = 10; int* const p = \u0026amp;a; // å£°æ˜ä¸€ä¸ªåªè¯»æŒ‡é’ˆï¼ŒæŒ‡å‘a *p = 30; //åˆæ³•ï¼Œå¯ä»¥é€šè¿‡æŒ‡å‘ä¿®æ”¹açš„å€¼ p = \u0026amp;a; //éæ³•ï¼Œ æ— æ³•ä¿®æ”¹åªè¯»æŒ‡é’ˆçš„å€¼ 4.3. åªè¯»æŒ‡é’ˆæŒ‡å‘åªè¯»å˜é‡\nconståŒæ—¶ä¿®é¥°æŒ‡é’ˆæœ¬èº«å’ŒæŒ‡é’ˆæ‰€æŒ‡å‘çš„å˜é‡ï¼Œä½¿å¾—æŒ‡é’ˆæœ¬èº«å’Œæ‰€æŒ‡å‘çš„å˜é‡éƒ½å˜æˆåªè¯»å˜é‡ã€‚\nå› æ­¤æŒ‡é’ˆæœ¬èº«ä¸èƒ½è¢«ä¿®æ”¹ï¼Œä¹Ÿä¸èƒ½é€šè¿‡æŒ‡é’ˆä¿®æ”¹æ‰€æŒ‡å‘çš„å˜é‡\nconst int a = 10; const int* const p = \u0026amp;a; //å£°æ˜ä¸€ä¸ªåªè¯»æŒ‡é’ˆï¼ŒæŒ‡å‘åªè¯»å˜é‡a *p = 20; // éæ³• p = nullptr // éæ³• 4.4. å¸¸é‡å¼•ç”¨\nå¸¸é‡å¼•ç”¨æ˜¯æŒ‡å¼•ç”¨ä¸€ä¸ªåªè¯»å˜é‡çš„å¼•ç”¨ï¼Œå› æ­¤ä¸èƒ½ç”¨è¿‡å¸¸é‡å¼•ç”¨ä¿®æ”¹å˜é‡çš„å€¼\nconst int a = 10; const int\u0026amp; b = a; //å£°æ˜ä¸€ä¸ªå¸¸é‡å¼•ç”¨ï¼Œå¼•ç”¨å¸¸é‡a b = 20; //éæ³•ï¼Œæ— æ³•é€šè¿‡å¸¸é‡å¼•ç”¨ä¿®æ”¹å¸¸é‡çš„ a çš„å€¼ ä¿®é¥°æˆå‘˜å‡½æ•° å½“const ä¿®é¥°æˆå‘˜å‡½æ•°æ—¶ï¼Œè¡¨ç¤ºè¯¥å‡½æ•°ä¸ä¼šä¿®æ”¹å¯¹è±¡çš„çŠ¶æ€(å°±æ˜¯ä¸ä¼šä¿®æ”¹æˆå‘˜å˜é‡)\nclass A { public: int func() **const** { // ç¼–è¯‘é”™è¯¯ï¼Œä¸èƒ½ä¿®æ”¹æˆå‘˜å˜é‡çš„å€¼ m_value = 10; return m_value; } private: int m_value; }; ä¾‹å­ï¼š\nclass MyClass { public: int getValue() const { return value; } void setValue(int v) { value = v; } private: int value; }; const MyClass constObj; MyClass nonConstObj; constObj.getValue(); // æ­£ç¡®ï¼šå¯ä»¥åœ¨ const å¯¹è±¡ä¸Šè°ƒç”¨ const æˆå‘˜å‡½æ•° nonConstObj.getValue(); // ä¹Ÿæ­£ç¡®ï¼šé const å¯¹è±¡ä¹Ÿå¯ä»¥è°ƒç”¨ const æˆå‘˜å‡½æ•° // constObj.setValue(10); // é”™è¯¯ï¼šä¸èƒ½åœ¨ const å¯¹è±¡ä¸Šè°ƒç”¨é const æˆå‘˜å‡½æ•° nonConstObj.setValue(10); // æ­£ç¡®ï¼šå¯ä»¥åœ¨é const å¯¹è±¡ä¸Šè°ƒç”¨é const æˆå‘˜å‡½æ•° const å¯¹è±¡ä¸èƒ½è°ƒç”¨éconstæˆå‘˜å‡½æ•°ï¼Œå› ä¸ºå¯èƒ½ä¼šä¿®æ”¹å¯¹è±¡çš„çŠ¶æ€ï¼Œè¿åconstçš„æ‰¿è¯º\nconstæˆå‘˜å‡½æ•°ï¼Œå¯ä»¥è¢« const å¯¹è±¡è°ƒç”¨ã€‚\nä¼˜ç‚¹ï¼š\nå®‰å…¨æ€§ï¼Œç¡®ä¿ constå¯¹è±¡ä¸ä¼šè¢«æ„å¤–ä¿®æ”¹ æ¥å£è®¾è®¡ï¼šå…è®¸åˆ›å»ºåªè¯»æ¥å£ï¼Œæé«˜ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ ","date":"4 August 2024","permalink":"/blog/two/","section":"Blog","summary":"Const #Owner: More_surface Ted Created time: July 25, 2024 4:59 PM\nconst å¯ä»¥ç”¨æ¥ä¿®é¥°å˜é‡ã€å‡½æ•°ã€æŒ‡é’ˆç­‰ã€‚\nä¿®é¥°å˜é‡ å½“ä¿®é¥°å˜é‡æ—¶ï¼Œæ„å‘³ç€è¯¥å˜é‡ä¸ºåªè¯»å˜é‡ï¼Œå³ä¸èƒ½è¢«ä¿®æ”¹ã€‚\nä¾‹å¦‚\nconst int a = 10; a = 20; //ç¼–è¯‘æŠ¥é”™ï¼Œaä¸ºåªè¯»ï¼Œä¸å¯ä¿®æ”¹ ä½†æ˜¯å¯ä»¥é€šè¿‡ä¸€äº›æŒ‡é’ˆç±»å‹è½¬æ¢æ“ä½œconst_cast ï¼Œä¿®æ”¹è¿™ä¸ªå˜é‡ã€‚\nä¾‹å¦‚\nint main(){ const int a = 10; const int* p = \u0026amp;a; // pæ˜¯æŒ‡å‘const intç±»å‹çš„å¯¹è±¡ int* q = const_cast\u0026lt;int*\u0026gt;(p); // ç±»å‹è½¬æ¢ï¼Œå°†pè½¬æ¢æˆæŒ‡å‘intå‹å¯¹è±¡çš„æŒ‡é’ˆ *q = 20; // é€šè¿‡æŒ‡é’ˆæ“ä½œä¿®æ”¹ const açš„å€¼ std::cout \u0026lt;\u0026lt; a \u0026lt;\u0026lt; std::ends; // è¾“å‡ºç»“æœ ä»ç„¶æ˜¯10 return 0; } è¾“å‡ºç»“æœä¸å˜ï¼Œå½’åŠŸäºç¼–è¯‘å™¨é†‰åšäº†ä¼˜åŒ–ï¼Œç¼–è¯‘æ—¶æŠŠä»£ç æ›¿æ¢ä¸ºäº†å¦‚ä¸‹æ‰€ç¤ºã€‚\nstd::cout \u0026lt;\u0026lt; \u0026quot;a = \u0026quot; \u0026lt;\u0026lt; 10 \u0026lt;\u0026lt; std::endl;","title":"First Post"},{"content":"This is my first blog post\nint main(){ B b; return 0; } Badge # æ–°æ–‡ç« ï¼ çŸ­é¡µç  # è­¦å‘Šï¼ è¿™ä¸ªæ“ä½œæ˜¯ç ´åæ€§çš„ï¼ åˆ«å¿˜äº†åœ¨Twitterä¸Šå…³æ³¨æˆ‘ã€‚ Button #button è¾“å‡ºä¸€ä¸ªæ ·å¼åŒ–çš„æŒ‰é’®ç»„ä»¶ï¼Œç”¨äºçªå‡ºæ˜¾ç¤ºä¸»è¦æ“ä½œã€‚å®ƒæœ‰ä¸‰ä¸ªå¯é€‰å‚æ•°ï¼š\nå‚æ•°\tæè¿° href\tæŒ‰é’®åº”é“¾æ¥åˆ°çš„ URLã€‚ target\té“¾æ¥çš„ç›®æ ‡ã€‚ download\tæµè§ˆå™¨æ˜¯å¦åº”ä¸‹è½½èµ„æºè€Œä¸æ˜¯å¯¼èˆªåˆ° URLã€‚æ­¤å‚æ•°çš„å€¼å°†æ˜¯ä¸‹è½½æ–‡ä»¶çš„åç§°ã€‚ ç¤ºä¾‹:\nCall to action å·®åˆ†æ•°ç»„çš„ä¸»è¦é€‚ç”¨åœºæ™¯æ˜¯é¢‘ç¹å¯¹åŸå§‹æ•°ç»„çš„æŸä¸ªåŒºé—´çš„å…ƒç´ è¿›è¡Œå¢å‡\næ¯”å¦‚è¯´ï¼Œæˆ‘ç»™ä½ è¾“å…¥ä¸€ä¸ªæ•°ç»„Â numsï¼Œç„¶ååˆè¦æ±‚ç»™åŒºé—´Â nums[2..6]Â å…¨éƒ¨åŠ  1ï¼Œå†ç»™Â nums[3..9]Â å…¨éƒ¨å‡ 3ï¼Œå†ç»™Â nums[0..4]Â å…¨éƒ¨åŠ  2ï¼Œå†ç»™\u0026hellip;\nå·®åˆ†æ•°ç»„\ndiff[i] = nums[i] - nums[i - 1]; æ„é€ å·®åˆ†æ•°ç»„\nvector\u0026lt;int\u0026gt;diff(nums.size()); diff[0] = nums[0]; for (int i = 1; i \u0026lt; nums.size(); ++i){ diff[i] = nums[i] - nums[i-1]; } é€šè¿‡å·®åˆ†æ•°ç»„å¯ä»¥åæ¨å‡ºåŸå§‹æ•°ç»„nums\nvector\u0026lt;int\u0026gt; res(diff.size()); res[0] = diff[0]; for (int i = 1; i \u0026lt; nums.size(); ++i){ res[i] = res[i - 1] + diff[i]; } æŒ‰ç…§è¿™æ ·çš„é€»è¾‘ï¼Œå¦‚æœéœ€è¦åœ¨æ•°ç»„çš„æŸä¸ªåŒºé—´è¿›è¡Œå¢å‡æ“ä½œã€‚æ¯”å¦‚ï¼Œéœ€è¦åœ¨[i\u0026hellip;j]åŒºé—´ï¼Œå¯¹å…ƒç´ åŠ ä¸Šxï¼Œåªéœ€è¦å¯¹\ndiff[i] += x, diff[j + 1] -= x; å¯ä»¥ç†è§£åæ¨å‡ºçš„åŸå§‹æ•°ç»„ä¸diff[i]æ˜¯æœ‰ç´¯åŠ å…³ç³»çš„ï¼Œdiff[i] + xç›¸å½“äºå¯¹iå…ƒç´ åçš„æ¯ä¸€ä¸ªæ•°ç»„å…ƒç´ éƒ½è¿›è¡Œäº†+x, ä¸ºäº†å®ç°è¦æ±‚ï¼Œéœ€è¦ä½æ•ˆæ‰jå…ƒç´ åçš„+xï¼Œæ‰€ä»¥diff[j + 1] -x.\néœ€è¦æ³¨æ„çš„æ˜¯\nå·®åˆ†æ•°ç»„diff[0] = nums[0]; å·®åˆ†æ•°ç»„å’Œåæ¨å‡ºçš„æ•°ç»„ï¼Œé•¿åº¦ä¸€è‡´ å…·ä½“çš„é¢˜ç›®å¯èƒ½å›çœ‹æ•°ç»„çš„ç´¢å¼•è¿›è¡Œåç§»ï¼Œæ¯”å¦‚èˆªç­é—®é¢˜ï¼Œæ•°ç»„æ˜¯ä»1å¼€å§‹ï¼Œéœ€è¦äººä¸ºå¤„ç†ã€‚ æœ€å¼€å§‹çš„å·®åˆ†æ•°ç»„å¯ä»¥å…¨ä¸º0 ","date":"3 August 2024","permalink":"/blog/2025-06-24-getting_started_guide/","section":"Blog","summary":"This is my first blog post\nint main(){ B b; return 0; } Badge # æ–°æ–‡ç« ï¼ çŸ­é¡µç  # è­¦å‘Šï¼ è¿™ä¸ªæ“ä½œæ˜¯ç ´åæ€§çš„ï¼ åˆ«å¿˜äº†åœ¨Twitterä¸Šå…³æ³¨æˆ‘ã€‚ Button #button è¾“å‡ºä¸€ä¸ªæ ·å¼åŒ–çš„æŒ‰é’®ç»„ä»¶ï¼Œç”¨äºçªå‡ºæ˜¾ç¤ºä¸»è¦æ“ä½œã€‚å®ƒæœ‰ä¸‰ä¸ªå¯é€‰å‚æ•°ï¼š\nå‚æ•°\tæè¿° href\tæŒ‰é’®åº”é“¾æ¥åˆ°çš„ URLã€‚ target\té“¾æ¥çš„ç›®æ ‡ã€‚ download\tæµè§ˆå™¨æ˜¯å¦åº”ä¸‹è½½èµ„æºè€Œä¸æ˜¯å¯¼èˆªåˆ° URLã€‚æ­¤å‚æ•°çš„å€¼å°†æ˜¯ä¸‹è½½æ–‡ä»¶çš„åç§°ã€‚ ç¤ºä¾‹:\nCall to action å·®åˆ†æ•°ç»„çš„ä¸»è¦é€‚ç”¨åœºæ™¯æ˜¯é¢‘ç¹å¯¹åŸå§‹æ•°ç»„çš„æŸä¸ªåŒºé—´çš„å…ƒç´ è¿›è¡Œå¢å‡\næ¯”å¦‚è¯´ï¼Œæˆ‘ç»™ä½ è¾“å…¥ä¸€ä¸ªæ•°ç»„Â numsï¼Œç„¶ååˆè¦æ±‚ç»™åŒºé—´Â nums[2..6]Â å…¨éƒ¨åŠ  1ï¼Œå†ç»™Â nums[3..9]Â å…¨éƒ¨å‡ 3ï¼Œå†ç»™Â nums[0..4]Â å…¨éƒ¨åŠ  2ï¼Œå†ç»™\u0026hellip;\nå·®åˆ†æ•°ç»„\ndiff[i] = nums[i] - nums[i - 1]; æ„é€ å·®åˆ†æ•°ç»„\nvector\u0026lt;int\u0026gt;diff(nums.size()); diff[0] = nums[0]; for (int i = 1; i \u0026lt; nums.","title":"two First Post"},{"content":"è¿™æ˜¯æˆ‘çš„ç¬¬ä¸€ç¯‡blogï¼Œå¸Œæœ›èƒ½åˆ†äº«æ›´å¤šçš„æŠ€æœ¯ï¼Œç”Ÿæ´»ã€å…´è¶£åœ¨è¿™ä¸ªBlogä¸Šã€‚æ¬¢è¿å¤§å®¶æŸ¥çœ‹è¯„è®ºã€‚\nWelcome to my inaugural blog post! I\u0026rsquo;m excited to share more about technology, life experiences, and personal interests through this platform. Feel free to check out the comments section and join the conversation!\n","date":"3 August 2024","permalink":"/blog/firstpost/","section":"Blog","summary":"è¿™æ˜¯æˆ‘çš„ç¬¬ä¸€ç¯‡blogï¼Œå¸Œæœ›èƒ½åˆ†äº«æ›´å¤šçš„æŠ€æœ¯ï¼Œç”Ÿæ´»ã€å…´è¶£åœ¨è¿™ä¸ªBlogä¸Šã€‚æ¬¢è¿å¤§å®¶æŸ¥çœ‹è¯„è®ºã€‚\nWelcome to my inaugural blog post! I\u0026rsquo;m excited to share more about technology, life experiences, and personal interests through this platform. Feel free to check out the comments section and join the conversation!","title":"My First Post"},{"content":"Believe in the future, believe that technology can change the world; embrace AI, embrace the future.\nMy Resume # Download Resume (PDF) Contact # Email: lineyua66@gmail.com GitHub: GitHub X: @X ","date":null,"permalink":"/about/","section":"About Me","summary":"Believe in the future, believe that technology can change the world; embrace AI, embrace the future.\nMy Resume # Download Resume (PDF) Contact # Email: lineyua66@gmail.com GitHub: GitHub X: @X ","title":"About Me"},{"content":"","date":null,"permalink":"/tags/ai/","section":"Tags","summary":"","title":"AI"},{"content":"","date":null,"permalink":"/tags/hft/","section":"Tags","summary":"","title":"HFT"},{"content":"This is my projects. Each project represents my exploration and growth in different fields.\n","date":null,"permalink":"/projects/","section":"Projects","summary":"This is my projects. Each project represents my exploration and growth in different fields.","title":"Projects"},{"content":"","date":null,"permalink":"/tags/prompt/","section":"Tags","summary":"","title":"Prompt"},{"content":"project description #Prompt Manager is a Chrome extension designed to help users save, manage, and quickly access frequently used prompts. It\u0026rsquo;s perfect for writers, customer service representatives, or anyone who often uses repetitive text snippets in their daily work.\nMain features #Save and manage text prompts Search through saved prompts Sort prompts by time or custom order Edit existing prompts Delete prompts One-click copy of prompts Import and export prompts for backup or transfer\nTechnology stack # React TypeScript TailwindCSS Vite Chrome Extension API Project link # GitHub ä»“åº“ ","date":"3 August 2024","permalink":"/projects/first/","section":"Projects","summary":"project description #Prompt Manager is a Chrome extension designed to help users save, manage, and quickly access frequently used prompts. It\u0026rsquo;s perfect for writers, customer service representatives, or anyone who often uses repetitive text snippets in their daily work.\nMain features #Save and manage text prompts Search through saved prompts Sort prompts by time or custom order Edit existing prompts Delete prompts One-click copy of prompts Import and export prompts for backup or transfer","title":"Prompt manager"},{"content":"","date":null,"permalink":"/tags/quant/","section":"Tags","summary":"","title":"Quant"},{"content":"High-Frequency Trading System #Project Overview #Independently designed and developed a cutting-edge high-frequency trading system with industry-leading performance.\nKey Features # Modular Architecture: Utilizing advanced C++17 and key design patterns Observer pattern for event-driven architecture Factory method for flexible algorithm creation Strategy pattern for interchangeable trading strategies Ultra-Low Latency Event Bus: Implemented using lock-free queues Optimized WebSocket: For high-throughput market data and order execution Memory-Mapped File I/O: Leveraging kernel-level page cache for asynchronous, low-latency disk operations Performance Metrics # Metric Performance Order Execution Latency \u0026lt; 50 Î¼s Message Processing Throughput \u0026gt; 1,000 messages/second Technical Stack # C++ (C++17) WebSockets Lock-free algorithms Memory-mapped I/O SIMD optimization Event-driven architecture Specializations # Ultra-low latency systems Concurrent programming Design patterns Market microstructure Kernel-level optimizations Project Highlights # Advanced C++ Implementation: Leveraged cutting-edge C++17 features to create a robust and efficient system architecture.\nOptimized Performance: Achieved industry-leading latency and throughput metrics through careful optimization and innovative design.\nScalable Architecture: Designed a modular system that can easily adapt to different trading strategies and market conditions.\nLow-Level Optimizations: Utilized kernel-level optimizations and SIMD instructions to maximize performance.\nReliable Persistence: Implemented memory-mapped I/O for efficient and reliable data persistence with minimal impact on system latency.\nConclusion #This project demonstrates a commitment to pushing the boundaries of performance in financial technology, consistently meeting and exceeding industry benchmarks for speed and reliability.\n","date":"3 August 2024","permalink":"/projects/quant_system/","section":"Projects","summary":"High-Frequency Trading System #Project Overview #Independently designed and developed a cutting-edge high-frequency trading system with industry-leading performance.\nKey Features # Modular Architecture: Utilizing advanced C++17 and key design patterns Observer pattern for event-driven architecture Factory method for flexible algorithm creation Strategy pattern for interchangeable trading strategies Ultra-Low Latency Event Bus: Implemented using lock-free queues Optimized WebSocket: For high-throughput market data and order execution Memory-Mapped File I/O: Leveraging kernel-level page cache for asynchronous, low-latency disk operations Performance Metrics # Metric Performance Order Execution Latency \u0026lt; 50 Î¼s Message Processing Throughput \u0026gt; 1,000 messages/second Technical Stack # C++ (C++17) WebSockets Lock-free algorithms Memory-mapped I/O SIMD optimization Event-driven architecture Specializations # Ultra-low latency systems Concurrent programming Design patterns Market microstructure Kernel-level optimizations Project Highlights # Advanced C++ Implementation: Leveraged cutting-edge C++17 features to create a robust and efficient system architecture.","title":"Quant system"},{"content":"Hey there! I\u0026rsquo;m Andrea, freshly minted with a Master\u0026rsquo;s degree in Mathematics and a passion for the applied side of things! With a strong focus on the applied math track, I\u0026rsquo;m all about cracking codes and uncovering quantitative solutions in real-world scenarios.\nIâ€™ve created this simple site to organise my online space and to share a bit more about what Iâ€™m interested in.\n","date":"3 April 2024","permalink":"/aboutme/","section":"Yu's Space","summary":"Hey there! I\u0026rsquo;m Andrea, freshly minted with a Master\u0026rsquo;s degree in Mathematics and a passion for the applied side of things! With a strong focus on the applied math track, I\u0026rsquo;m all about cracking codes and uncovering quantitative solutions in real-world scenarios.\nIâ€™ve created this simple site to organise my online space and to share a bit more about what Iâ€™m interested in.","title":"About"},{"content":"","date":null,"permalink":"/blog/","section":"Blog","summary":"","title":"Blog"},{"content":"","date":null,"permalink":"/categories/","section":"Categories","summary":"","title":"Categories"}]