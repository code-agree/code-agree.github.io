<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Http on Yu's Space</title><link>https://example.org/tags/http/</link><description>Recent content in Http on Yu's Space</description><generator>Hugo</generator><language>en</language><lastBuildDate>Fri, 07 Mar 2025 19:24:12 +0800</lastBuildDate><atom:link href="https://example.org/tags/http/index.xml" rel="self" type="application/rss+xml"/><item><title>TLS会话恢复（Session Resumption）</title><link>https://example.org/blog/session_resumption/</link><pubDate>Fri, 07 Mar 2025 19:24:12 +0800</pubDate><guid>https://example.org/blog/session_resumption/</guid><description>&lt;hr>
&lt;h2 id="1-会话恢复简介" class="relative group">1. 会话恢复简介 &lt;span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100">&lt;a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#1-%e4%bc%9a%e8%af%9d%e6%81%a2%e5%a4%8d%e7%ae%80%e4%bb%8b" aria-label="Anchor">#&lt;/a>&lt;/span>&lt;/h2>&lt;h3 id="什么是会话恢复" class="relative group">什么是会话恢复？ &lt;span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100">&lt;a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e4%bb%80%e4%b9%88%e6%98%af%e4%bc%9a%e8%af%9d%e6%81%a2%e5%a4%8d" aria-label="Anchor">#&lt;/a>&lt;/span>&lt;/h3>&lt;p>TLS会话恢复是TLS协议的一项优化特性，允许客户端和服务器基于之前建立的安全会话快速恢复通信，跳过完整的握手过程。在TLS 1.3中，会话恢复主要通过**PSK（Pre-Shared Key，预共享密钥）**机制实现，而在TLS 1.2及更早版本中，也可以通过Session ID或Session Ticket实现。&lt;/p>
&lt;h3 id="为什么需要会话恢复" class="relative group">为什么需要会话恢复？ &lt;span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100">&lt;a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81%e4%bc%9a%e8%af%9d%e6%81%a2%e5%a4%8d" aria-label="Anchor">#&lt;/a>&lt;/span>&lt;/h3>&lt;ul>
&lt;li>&lt;strong>性能优化&lt;/strong>：
&lt;ul>
&lt;li>完整握手（TLS 1.3）：1-RTT&lt;/li>
&lt;li>会话恢复：1-RTT（或0-RTT）&lt;/li>
&lt;li>显著减少连接建立时间&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>资源节省&lt;/strong>：
&lt;ul>
&lt;li>降低CPU开销（避免重复密钥交换）&lt;/li>
&lt;li>减少网络带宽占用&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h2 id="2-tls-13中的会话恢复机制" class="relative group">2. TLS 1.3中的会话恢复机制 &lt;span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100">&lt;a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#2-tls-13%e4%b8%ad%e7%9a%84%e4%bc%9a%e8%af%9d%e6%81%a2%e5%a4%8d%e6%9c%ba%e5%88%b6" aria-label="Anchor">#&lt;/a>&lt;/span>&lt;/h2>&lt;h3 id="工作流程对比" class="relative group">工作流程对比 &lt;span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100">&lt;a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e5%b7%a5%e4%bd%9c%e6%b5%81%e7%a8%8b%e5%af%b9%e6%af%94" aria-label="Anchor">#&lt;/a>&lt;/span>&lt;/h3>&lt;h4 id="完整握手tls-13" class="relative group">完整握手（TLS 1.3） &lt;span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100">&lt;a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e5%ae%8c%e6%95%b4%e6%8f%a1%e6%89%8btls-13" aria-label="Anchor">#&lt;/a>&lt;/span>&lt;/h4>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">&lt;span class="line">&lt;span class="cl">Client Server
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> | ClientHello |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> |--------------------&amp;gt;|
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> | ServerHello |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> | EncryptedExt |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> | Certificate |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> | CertVerify |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> | Finished |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> |&amp;lt;--------------------|
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> | Finished |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> |--------------------&amp;gt;|
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> | NewSessionTicket |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> |&amp;lt;--------------------|
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>RTT：1次往返&lt;/li>
&lt;li>服务器在握手后发送&lt;code>NewSessionTicket&lt;/code>，包含PSK和有效期信息。&lt;/li>
&lt;/ul>
&lt;h4 id="会话恢复1-rtt" class="relative group">会话恢复（1-RTT） &lt;span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100">&lt;a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e4%bc%9a%e8%af%9d%e6%81%a2%e5%a4%8d1-rtt" aria-label="Anchor">#&lt;/a>&lt;/span>&lt;/h4>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">&lt;span class="line">&lt;span class="cl">Client Server
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> | ClientHello |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> | (with PSK) |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> |--------------------&amp;gt;|
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> | ServerHello |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> | Finished |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> |&amp;lt;--------------------|
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> | Finished |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> |--------------------&amp;gt;|
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>RTT：1次往返&lt;/li>
&lt;li>客户端使用之前保存的PSK直接恢复会话。&lt;/li>
&lt;/ul>
&lt;h4 id="0-rtt可选" class="relative group">0-RTT（可选） &lt;span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100">&lt;a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#0-rtt%e5%8f%af%e9%80%89" aria-label="Anchor">#&lt;/a>&lt;/span>&lt;/h4>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">&lt;span class="line">&lt;span class="cl">Client Server
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> | ClientHello |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> | (with PSK + Early Data) |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> |--------------------&amp;gt;|
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> | ServerHello |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> | Finished |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> |&amp;lt;--------------------|
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> | Finished |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> |--------------------&amp;gt;|
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>RTT：0次往返（早期数据随首次请求发送）&lt;/li>
&lt;li>注意：0-RTT有重放攻击风险，仅适用于幂等请求。&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h2 id="3-实现示例基于picotls" class="relative group">3. 实现示例（基于picotls） &lt;span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100">&lt;a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#3-%e5%ae%9e%e7%8e%b0%e7%a4%ba%e4%be%8b%e5%9f%ba%e4%ba%8epicotls" aria-label="Anchor">#&lt;/a>&lt;/span>&lt;/h2>&lt;h3 id="数据结构" class="relative group">数据结构 &lt;span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100">&lt;a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84" aria-label="Anchor">#&lt;/a>&lt;/span>&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="k">typedef&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">ptls_iovec_t&lt;/span> &lt;span class="n">session_ticket&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// 会话ticket（包含PSK）
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kt">ptls_save_ticket_t&lt;/span> &lt;span class="n">ticket_cb&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// ticket保存回调
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">is_resumption&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// 是否恢复会话
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kt">time_t&lt;/span> &lt;span class="n">ticket_received_time&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// ticket接收时间
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="kt">tls_context_t&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="保存会话ticket" class="relative group">保存会话Ticket &lt;span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100">&lt;a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e4%bf%9d%e5%ad%98%e4%bc%9a%e8%af%9dticket" aria-label="Anchor">#&lt;/a>&lt;/span>&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="k">static&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="nf">save_ticket_cb&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">ptls_save_ticket_t&lt;/span>&lt;span class="o">*&lt;/span> &lt;span class="n">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">ptls_t&lt;/span>&lt;span class="o">*&lt;/span> &lt;span class="n">tls&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">ptls_iovec_t&lt;/span> &lt;span class="n">ticket&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">tls_context_t&lt;/span>&lt;span class="o">*&lt;/span> &lt;span class="n">ctx&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nf">container_of&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">tls_context_t&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ticket_cb&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// 释放旧ticket
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">ctx&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">session_ticket&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">base&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">free&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ctx&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">session_ticket&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">base&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// 保存新ticket
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">ctx&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">session_ticket&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">base&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nf">malloc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ticket&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">len&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">ctx&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">session_ticket&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">base&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// 内存分配失败
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nf">memcpy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ctx&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">session_ticket&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">base&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ticket&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">base&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ticket&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">len&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ctx&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">session_ticket&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">len&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ticket&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">len&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ctx&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">ticket_received_time&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nf">time&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">NULL&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="尝试会话恢复" class="relative group">尝试会话恢复 &lt;span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100">&lt;a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e5%b0%9d%e8%af%95%e4%bc%9a%e8%af%9d%e6%81%a2%e5%a4%8d" aria-label="Anchor">#&lt;/a>&lt;/span>&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">ptls_handshake_properties_t&lt;/span> &lt;span class="n">props&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">conn&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">tls_ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">session_ticket&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">base&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// 检查ticket是否过期（假设有效期24小时）
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">time&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">conn&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">tls_ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">ticket_received_time&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">24&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">3600&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">props&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">session_ticket&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">conn&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">tls_ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">session_ticket&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">props&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">max_early_data_size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">16384&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// 支持0-RTT
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">conn&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">session_info&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">resumption_attempted&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">ptls_handshake&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">conn&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">tls&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">props&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="验证恢复结果" class="relative group">验证恢复结果 &lt;span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100">&lt;a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e9%aa%8c%e8%af%81%e6%81%a2%e5%a4%8d%e7%bb%93%e6%9e%9c" aria-label="Anchor">#&lt;/a>&lt;/span>&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">conn&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">session_info&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">resumption_attempted&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">conn&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">session_info&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">resumption_succeeded&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nf">ptls_is_psk_handshake&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">conn&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">tls&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">conn&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">session_info&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">resumption_succeeded&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// 恢复失败，清理ticket
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nf">free&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">conn&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">tls_ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">session_ticket&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">base&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">conn&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">tls_ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">session_ticket&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">base&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">conn&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">tls_ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">session_ticket&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">len&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;hr>
&lt;h2 id="4-在连接池中的应用" class="relative group">4. 在连接池中的应用 &lt;span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100">&lt;a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#4-%e5%9c%a8%e8%bf%9e%e6%8e%a5%e6%b1%a0%e4%b8%ad%e7%9a%84%e5%ba%94%e7%94%a8" aria-label="Anchor">#&lt;/a>&lt;/span>&lt;/h2>&lt;h3 id="场景" class="relative group">场景 &lt;span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100">&lt;a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e5%9c%ba%e6%99%af" aria-label="Anchor">#&lt;/a>&lt;/span>&lt;/h3>&lt;ul>
&lt;li>&lt;strong>复用连接&lt;/strong>：检查ticket有效性，优先尝试恢复，失败则完整握手。&lt;/li>
&lt;li>&lt;strong>新建连接&lt;/strong>：使用已有ticket尝试恢复，保存新ticket。&lt;/li>
&lt;li>&lt;strong>连接维护&lt;/strong>：跟踪ticket有效期，清理过期ticket，统计恢复率。&lt;/li>
&lt;/ul>
&lt;h3 id="示例逻辑" class="relative group">示例逻辑 &lt;span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100">&lt;a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e7%a4%ba%e4%be%8b%e9%80%bb%e8%be%91" aria-label="Anchor">#&lt;/a>&lt;/span>&lt;/h3>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">pool&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">ticket&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">base&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nf">time&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">pool&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">ticket_time&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">pool&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">ticket_lifetime&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// 尝试恢复
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">props&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">session_ticket&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">pool&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">ticket&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">ptls_handshake&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">conn&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">tls&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">props&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nf">ptls_is_psk_handshake&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">conn&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">tls&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pool&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">stats&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">resumption_success&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pool&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">stats&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">resumption_fail&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nf">ptls_handshake&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">conn&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">tls&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// 回退完整握手
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// 完整握手并保存新ticket
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nf">ptls_handshake&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">conn&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">tls&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;hr>
&lt;h2 id="5-注意事项" class="relative group">5. 注意事项 &lt;span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100">&lt;a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#5-%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9" aria-label="Anchor">#&lt;/a>&lt;/span>&lt;/h2>&lt;h3 id="安全性" class="relative group">安全性 &lt;span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100">&lt;a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e5%ae%89%e5%85%a8%e6%80%a7" aria-label="Anchor">#&lt;/a>&lt;/span>&lt;/h3>&lt;ul>
&lt;li>&lt;strong>有效期限制&lt;/strong>：ticket通常有效数小时，由服务器指定。&lt;/li>
&lt;li>&lt;strong>存储安全&lt;/strong>：避免明文保存ticket，建议加密存储。&lt;/li>
&lt;li>&lt;strong>0-RTT风险&lt;/strong>：防范重放攻击，仅用于安全场景。&lt;/li>
&lt;/ul>
&lt;h3 id="性能优化" class="relative group">性能优化 &lt;span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100">&lt;a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96" aria-label="Anchor">#&lt;/a>&lt;/span>&lt;/h3>&lt;ul>
&lt;li>&lt;strong>ticket管理&lt;/strong>：避免过度保存，定期清理无效ticket。&lt;/li>
&lt;li>&lt;strong>服务器负载&lt;/strong>：减少频繁发送&lt;code>NewSessionTicket&lt;/code>。&lt;/li>
&lt;li>&lt;strong>监控指标&lt;/strong>：记录恢复成功率，优化策略。&lt;/li>
&lt;/ul>
&lt;h3 id="错误处理" class="relative group">错误处理 &lt;span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100">&lt;a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#%e9%94%99%e8%af%af%e5%a4%84%e7%90%86" aria-label="Anchor">#&lt;/a>&lt;/span>&lt;/h3>&lt;ul>
&lt;li>&lt;strong>优雅降级&lt;/strong>：恢复失败时切换完整握手。&lt;/li>
&lt;li>&lt;strong>日志记录&lt;/strong>：保存失败原因（如ticket过期或拒绝）。&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h2 id="6-总结" class="relative group">6. 总结 &lt;span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100">&lt;a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#6-%e6%80%bb%e7%bb%93" aria-label="Anchor">#&lt;/a>&lt;/span>&lt;/h2>&lt;p>TLS会话恢复通过PSK机制显著提升连接效率，尤其在高并发场景（如连接池）中效果明显。正确实现需要平衡安全性与性能，关注ticket管理、错误处理和监控。通过1-RTT或0-RTT，客户端和服务器可在毫秒内恢复安全通信，是现代网络优化的关键技术。&lt;/p></description></item></channel></rss>